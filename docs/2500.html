<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Nine Rules for Running Rust on Embedded Systems</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Nine Rules for Running Rust on Embedded Systems</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/nine-rules-for-running-rust-on-embedded-systems-b0c247ee877e?source=collection_archive---------0-----------------------#2024-10-13">https://towardsdatascience.com/nine-rules-for-running-rust-on-embedded-systems-b0c247ee877e?source=collection_archive---------0-----------------------#2024-10-13</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="ac5e" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx">Practical Lessons from Porting <code class="cx hd he hf hg b">range-set-blaze</code> to <code class="cx hd he hf hg b">no_std</code></h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hh hi hj hk hl ab"><div><div class="ab hm"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@carlmkadie?source=post_page---byline--b0c247ee877e--------------------------------" rel="noopener follow"><div class="l hn ho by hp hq"><div class="l ed"><img alt="Carl M. Kadie" class="l ep by dd de cx" src="../Images/9dbe27c76e9567136e5a7dc587f1fb15.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/1*RGViuuvF-_GQ-LXuVDQN7w.jpeg"/><div class="hr by l dd de em n hs eo"/></div></div></a></div></div><div class="ht ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--b0c247ee877e--------------------------------" rel="noopener follow"><div class="l hu hv by hp hw"><div class="l ed"><img alt="Towards Data Science" class="l ep by br hx cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hr by l br hx em n hs eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hy ab q"><div class="ab q hz"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b ia ib bk"><a class="af ag ah ai aj ak al am an ao ap aq ar ic" data-testid="authorName" href="https://medium.com/@carlmkadie?source=post_page---byline--b0c247ee877e--------------------------------" rel="noopener follow">Carl M. Kadie</a></p></div></div></div><span class="id ie" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b ia ib dx"><button class="if ig ah ai aj ak al am an ao ap aq ar ih ii ij" disabled="">Follow</button></p></div></div></span></div></div><div class="l ik"><span class="bf b bg z dx"><div class="ab cn il im in"><div class="io ip ab"><div class="bf b bg z dx ab iq"><span class="ir l ik">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar ic ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--b0c247ee877e--------------------------------" rel="noopener follow"><p class="bf b bg z is it iu iv iw ix iy iz bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="id ie" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">16 min read</span><div class="ja jb l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Oct 13, 2024</span></div></span></div></span></div></div></div><div class="ab cp jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr"><div class="h k w ea eb q"><div class="kh l"><div class="ab q ki kj"><div class="pw-multi-vote-icon ed ir kk kl km"><div class=""><div class="kn ko kp kq kr ks kt am ku kv kw km"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kx ky kz la lb lc ld"><p class="bf b dy z dx"><span class="ko">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kn lg lh ab q ee li lj" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="lf"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg><p class="bf b dy z dx"><span class="pw-responses-count le lf">1</span></p></button></div></div></div><div class="ab q js jt ju jv jw jx jy jz ka kb kc kd ke kf kg"><div class="lk k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al ll an ao ap ih lm ln lo" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep lp cn"><div class="l ae"><div class="ab cb"><div class="lq lr ls lt lu lv ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al ll an ao ap ih lw lx lj ly lz ma mb mc s md me mf mg mh mi mj u mk ml mm"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al ll an ao ap ih lw lx lj ly lz ma mb mc s md me mf mg mh mi mj u mk ml mm"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al ll an ao ap ih lw lx lj ly lz ma mb mc s md me mf mg mh mi mj u mk ml mm"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><figure class="mq mr ms mt mu mv mn mo paragraph-image"><div role="button" tabindex="0" class="mw mx ed my bh mz"><div class="mn mo mp"><img src="../Images/c3cbaa1585fa74c08e577624b2a2e707.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kM8YxO_1IAEGESldi28mGA.png"/></div></div><figcaption class="nb nc nd mn mo ne nf bf b bg z dx">Rust Running on Embedded — Source: <a class="af ng" href="https://openai.com/dall-e-2/" rel="noopener ugc nofollow" target="_blank">https://openai.com/dall-e-2/</a>. All other figures from the author.</figcaption></figure><p id="b4d9" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Do you want your Rust code to run everywhere — from large servers to web pages, robots, and even watches? In this final article of a three-part series [<a class="af ng" href="https://medium.com/towards-data-science/nine-rules-for-running-rust-on-wasm-wasi-550cd14c252a" rel="noopener">1</a>, <a class="af ng" href="https://medium.com/towards-data-science/nine-rules-for-running-rust-in-the-browser-8228353649d1" rel="noopener">2</a>, <a class="af ng" href="https://medium.com/towards-data-science/nine-rules-for-running-rust-on-embedded-systems-b0c247ee877e" rel="noopener">3</a>], we’ll see how to use Rust to run on embedded devices using <code class="cx hd he hf hg b">no_std</code>.</p><p id="e2a5" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Porting your Rust project to a <code class="cx hd he hf hg b">no_std</code> environment allows you to target microcontrollers and deeply embedded systems, creating highly efficient software for constrained environments. For example, I used the upcoming version of <code class="cx hd he hf hg b">range-set-blaze</code> to create an LED animation sequencer and compositor that runs on a Raspberry Pi Pico:</p><figure class="mq mr ms mt mu mv"><div class="od is l ed"><div class="oe of l"/></div><figcaption class="nb nc nd mn mo ne nf bf b bg z dx">1 minute video showing LED animation on the Pico</figcaption></figure><p id="77f3" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Running Rust without the standard library presents unique challenges. Without operating system support, features like file I/O, networking, and sometimes even dynamic memory allocation are unavailable. In this article, we’ll look at practical strategies to overcome these limitations.</p><p id="f56a" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Porting Rust to <code class="cx hd he hf hg b">no_std</code> requires careful steps and choices, and missing any step can lead to failure. We’ll simplify the process by following these nine rules, which we will examine in detail:</p><ol class=""><li id="f461" class="nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc og oh oi bk">Confirm that your project works with WASM WASI and WASM in the Browser.</li><li id="46c8" class="nh ni fq nj b go oj nl nm gr ok no np nq ol ns nt nu om nw nx ny on oa ob oc og oh oi bk">Use target <code class="cx hd he hf hg b">thumbv7m-none-eabi</code> and <code class="cx hd he hf hg b">cargo tree</code> to identify and fix dependencies incompatible with <code class="cx hd he hf hg b">no_std</code>.</li><li id="d03d" class="nh ni fq nj b go oj nl nm gr ok no np nq ol ns nt nu om nw nx ny on oa ob oc og oh oi bk">Mark main (non-test) code <code class="cx hd he hf hg b">no_std</code> and <code class="cx hd he hf hg b">alloc</code>. Replace <code class="cx hd he hf hg b">std::</code> with <code class="cx hd he hf hg b">core:: </code>and <code class="cx hd he hf hg b">alloc::</code>.</li><li id="12db" class="nh ni fq nj b go oj nl nm gr ok no np nq ol ns nt nu om nw nx ny on oa ob oc og oh oi bk">Use Cargo features to let your main code use <code class="cx hd he hf hg b">std</code> optionally for file-related (etc.) functions.</li><li id="1745" class="nh ni fq nj b go oj nl nm gr ok no np nq ol ns nt nu om nw nx ny on oa ob oc og oh oi bk">Understand why test code always uses the standard library.</li><li id="c13f" class="nh ni fq nj b go oj nl nm gr ok no np nq ol ns nt nu om nw nx ny on oa ob oc og oh oi bk">Create a simple embedded test project. Run it with QEMU.</li><li id="5a82" class="nh ni fq nj b go oj nl nm gr ok no np nq ol ns nt nu om nw nx ny on oa ob oc og oh oi bk">In <code class="cx hd he hf hg b">Cargo.toml</code>, add keywords and categories for WASM and <code class="cx hd he hf hg b">no_std</code>.</li><li id="06e0" class="nh ni fq nj b go oj nl nm gr ok no np nq ol ns nt nu om nw nx ny on oa ob oc og oh oi bk">[Optional] Use preallocated data types to avoid <code class="cx hd he hf hg b">alloc</code>.</li><li id="f20e" class="nh ni fq nj b go oj nl nm gr ok no np nq ol ns nt nu om nw nx ny on oa ob oc og oh oi bk">Add <code class="cx hd he hf hg b">thumbv7m-none-eabi</code> and QEMU to your CI (continuous integration) tests.</li></ol><blockquote class="oo op oq"><p id="398e" class="nh ni or nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Aside: These articles are based on a three-hour workshop that I presented at <a class="af ng" href="https://rustconf.com/programs/#755" rel="noopener ugc nofollow" target="_blank">RustConf24</a> in Montreal. Thanks to the participants of that workshop. A special thanks, also, to the volunteers from the Seattle Rust Meetup who helped test this material. These articles replace <a class="af ng" href="https://medium.com/towards-data-science/nine-rules-for-running-rust-on-the-web-and-on-embedded-94462ef249a2" rel="noopener">an article I wrote last year</a> with updated information.</p></blockquote><p id="08cd" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">As with the <a class="af ng" href="https://medium.com/towards-data-science/nine-rules-for-running-rust-on-wasm-wasi-550cd14c252a" rel="noopener">first</a> and <a class="af ng" href="https://medium.com/towards-data-science/nine-rules-for-running-rust-in-the-browser-8228353649d1" rel="noopener">second</a> articles in this series, before we look at the rules one by one, let’s define our terms.</p><ul class=""><li id="5e5f" class="nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc os oh oi bk"><strong class="nj fr">Native:</strong> Your home OS (Linux, Windows, macOS)</li><li id="cd16" class="nh ni fq nj b go oj nl nm gr ok no np nq ol ns nt nu om nw nx ny on oa ob oc os oh oi bk"><strong class="nj fr">Standard library (std)</strong>: Provides Rust’s core functionality — <code class="cx hd he hf hg b">Vec</code>, <code class="cx hd he hf hg b">String</code>, file input/output, networking, time.</li><li id="ede7" class="nh ni fq nj b go oj nl nm gr ok no np nq ol ns nt nu om nw nx ny on oa ob oc os oh oi bk"><strong class="nj fr">WASM</strong>: WebAssembly (WASM) is a binary instruction format that runs in most browsers (and beyond).</li><li id="292d" class="nh ni fq nj b go oj nl nm gr ok no np nq ol ns nt nu om nw nx ny on oa ob oc os oh oi bk"><strong class="nj fr">WASI</strong>: WebAssembly System Interface (WASI) allows outside-the-browser WASM to access file I/O, networking (not yet), and time handling.</li><li id="8bb6" class="nh ni fq nj b go oj nl nm gr ok no np nq ol ns nt nu om nw nx ny on oa ob oc os oh oi bk"><strong class="nj fr">no_std</strong>: Instructs a Rust program not to use the full standard library, making it suitable for small, embedded devices or highly resource-constrained environments.</li><li id="d593" class="nh ni fq nj b go oj nl nm gr ok no np nq ol ns nt nu om nw nx ny on oa ob oc os oh oi bk"><strong class="nj fr">alloc</strong>: Provides heap memory allocation capabilities (<code class="cx hd he hf hg b">Vec</code>, <code class="cx hd he hf hg b">String</code>, etc.) in <code class="cx hd he hf hg b">no_std</code> environments, essential for dynamically managing memory.</li></ul></div></div></div><div class="ab cb ot ou ov ow" role="separator"><span class="ox by bm oy oz pa"/><span class="ox by bm oy oz pa"/><span class="ox by bm oy oz"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="1dfd" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Based on my experience with <code class="cx hd he hf hg b"><a class="af ng" href="https://github.com/CarlKCarlK/range-set-blaze" rel="noopener ugc nofollow" target="_blank">range-set-blaze</a></code>, a data structure project, here are the decisions I recommend, described one at a time. To avoid wishy-washiness, I’ll express them as rules.</p><h1 id="1d89" class="pb pc fq bf pd pe pf gq pg ph pi gt pj pk pl pm pn po pp pq pr ps pt pu pv pw bk">Rule 1: Confirm that your project works with WASM WASI and WASM in the Browser.</h1><p id="b385" class="pw-post-body-paragraph nh ni fq nj b go px nl nm gr py no np nq pz ns nt nu qa nw nx ny qb oa ob oc fj bk">Before porting your Rust code to an embedded environment, ensure it runs successfully in <a class="af ng" href="https://medium.com/towards-data-science/nine-rules-for-running-rust-on-wasm-wasi-550cd14c252a" rel="noopener">WASM WASI</a> and <a class="af ng" href="https://medium.com/towards-data-science/nine-rules-for-running-rust-in-the-browser-8228353649d1" rel="noopener">WASM in the Browser</a>. These environments expose issues related to moving away from the standard library and impose constraints like those of embedded systems. By addressing these challenges early, you’ll be closer to running your project on embedded devices.</p><blockquote class="oo op oq"><p id="e24e" class="nh ni or nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Aside: If you don’t need your project to also run on native and/or WASM, you can skip this step. You may, however, find some steps from the previous articles useful — for example, running in a 32-bit environment and understanding conditional compilation.</p></blockquote><figure class="mq mr ms mt mu mv mn mo paragraph-image"><div class="mn mo qc"><img src="../Images/c13b6ccb5fcff21890cb7aa324a1c097.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*tY9dG3h58NSfRgIj.png"/></div><figcaption class="nb nc nd mn mo ne nf bf b bg z dx">Environments in which we wish to run our code as a Venn diagram of progressively tighter constraints.</figcaption></figure><p id="8f1a" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Run the following commands to confirm that your code works in both WASM WASI and WASM in the Browser:</p><pre class="mq mr ms mt mu qd hg qe bp qf bb bk"><span id="526d" class="qg pc fq hg b bg qh qi l qj qk">cargo test --target wasm32-wasip1<br/>cargo test --target wasm32-unknown-unknown<br/></span></pre><p id="ac61" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">If the tests fail or don’t run, revisit the steps from the earlier articles in this series: <a class="af ng" href="https://medium.com/towards-data-science/nine-rules-for-running-rust-on-wasm-wasi-550cd14c252a" rel="noopener">WASM WASI</a> and <a class="af ng" href="https://medium.com/towards-data-science/nine-rules-for-running-rust-in-the-browser-8228353649d1" rel="noopener">WASM in the Browser</a>.</p><p id="179a" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">The WASM WASI article also provides crucial background on understanding Rust targets (Rule 2), conditional compilation (Rule 4), and Cargo features (Rule 6).</p><p id="2648" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Once you’ve fulfilled these prerequisites, the next step is to see how (and if) we can get our dependencies working on embedded systems.</p><h1 id="c637" class="pb pc fq bf pd pe pf gq pg ph pi gt pj pk pl pm pn po pp pq pr ps pt pu pv pw bk">Rule 2: Use target <code class="cx hd he hf hg b">thumbv7m-none-eabi</code> and <code class="cx hd he hf hg b">cargo tree</code> to identify and fix dependencies incompatible with <code class="cx hd he hf hg b">no_std</code>.</h1><p id="01aa" class="pw-post-body-paragraph nh ni fq nj b go px nl nm gr py no np nq pz ns nt nu qa nw nx ny qb oa ob oc fj bk">To check if your dependencies are compatible with an embedded environment, compile your project for an embedded target. I recommend using the <code class="cx hd he hf hg b">thumbv7m-none-eabi</code> target:</p><ul class=""><li id="0d2b" class="nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc os oh oi bk"><code class="cx hd he hf hg b">thumbv7m </code>— Represents the ARM Cortex-M3 microcontroller, a popular family of embedded processors.</li><li id="283f" class="nh ni fq nj b go oj nl nm gr ok no np nq ol ns nt nu om nw nx ny on oa ob oc os oh oi bk"><code class="cx hd he hf hg b">none </code>— Indicates that there is no operating system (OS) available. In Rust, this typically means we can’t rely on the standard library (<code class="cx hd he hf hg b">std</code>), so we use <code class="cx hd he hf hg b">no_std</code>. Recall that the standard library provides core functionality like <code class="cx hd he hf hg b">Vec</code>, <code class="cx hd he hf hg b">String</code>, file input/output, networking, and time.</li><li id="1213" class="nh ni fq nj b go oj nl nm gr ok no np nq ol ns nt nu om nw nx ny on oa ob oc os oh oi bk"><code class="cx hd he hf hg b">eabi</code> — Embedded Application Binary Interface, a standard defining calling conventions, data types, and binary layout for embedded executables.</li></ul><p id="ed1f" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Since most embedded processors share the <code class="cx hd he hf hg b">no_std</code> constraint, ensuring compatibility with this target helps ensure compatibility with other embedded targets.</p><p id="0473" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Install the target and check your project:</p><pre class="mq mr ms mt mu qd hg qe bp qf bb bk"><span id="387c" class="qg pc fq hg b bg qh qi l qj qk">rustup target add thumbv7m-none-eabi<br/>cargo check --target thumbv7m-none-eabi</span></pre><p id="04a9" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">When I did this on <code class="cx hd he hf hg b">range-set-blaze</code>, I encountered errors complaining about dependencies, such as:</p><figure class="mq mr ms mt mu mv mn mo paragraph-image"><div role="button" tabindex="0" class="mw mx ed my bh mz"><div class="mn mo ql"><img src="../Images/78e11b0199b7ae21db407aaaf719595f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p1_BrBhFiJhie-cQIZfDeA.png"/></div></div></figure><p id="e0d4" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">This shows that my project depends on <code class="cx hd he hf hg b">num-traits</code>, which depends on <code class="cx hd he hf hg b">either</code>, ultimately depending on <code class="cx hd he hf hg b">std</code>.</p><p id="b2b9" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">The error messages can be confusing. To better understand the situation, run this <code class="cx hd he hf hg b">cargo tree</code> command:</p><pre class="mq mr ms mt mu qd hg qe bp qf bb bk"><span id="aa1e" class="qg pc fq hg b bg qh qi l qj qk">cargo tree --edges no-dev --format "{p} {f}"</span></pre><p id="2f36" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">It displays a recursive list of your project’s dependencies and their active Cargo features. For example:</p><pre class="mq mr ms mt mu qd hg qe bp qf bb bk"><span id="20cb" class="qg pc fq hg b bg qh qi l qj qk">range-set-blaze v0.1.6 (C:\deldir\branches\rustconf24.nostd) <br/>├── gen_ops v0.3.0<br/>├── itertools v0.13.0 default,use_alloc,use_std<br/>│   └── either v1.12.0 use_std<br/>├── num-integer v0.1.46 default,std<br/>│   └── num-traits v0.2.19 default,i128,std<br/>│       [build-dependencies]<br/>│       └── autocfg v1.3.0<br/>└── num-traits v0.2.19 default,i128,std (*)</span></pre><p id="4a8a" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">We see multiple occurrences of Cargo features named <code class="cx hd he hf hg b">use_std</code> and <code class="cx hd he hf hg b">std</code>, strongly suggesting that:</p><ul class=""><li id="b7b1" class="nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc os oh oi bk">These Cargo features require the standard library.</li><li id="8d3c" class="nh ni fq nj b go oj nl nm gr ok no np nq ol ns nt nu om nw nx ny on oa ob oc os oh oi bk">We can turn these Cargo features off.</li></ul><p id="01b8" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Using the techniques explained in the <a class="af ng" href="https://medium.com/towards-data-science/nine-rules-for-running-rust-on-wasm-wasi-550cd14c252a" rel="noopener">first article</a>, Rule 6, we disable the <code class="cx hd he hf hg b">use_std</code> and <code class="cx hd he hf hg b">std</code> Cargo features. Recall that Cargo features are additive and have defaults. To turn off the default features, we use <code class="cx hd he hf hg b">default-features = false</code>. We then enable the Cargo features we want to keep by specifying, for example, <code class="cx hd he hf hg b">features = ["use_alloc"]</code>. The <code class="cx hd he hf hg b">Cargo.toml</code> now reads:</p><pre class="mq mr ms mt mu qd hg qe bp qf bb bk"><span id="76c2" class="qg pc fq hg b bg qh qi l qj qk">[dependencies]<br/>gen_ops = "0.3.0"<br/>itertools = { version = "0.13.0", features=["use_alloc"], default-features = false }<br/>num-integer = { version = "0.1.46", default-features = false }<br/>num-traits = { version = "0.2.19", features=["i128"], default-features = false }<br/></span></pre><p id="3c72" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Turning off Cargo features will not always be enough to make your dependencies <code class="cx hd he hf hg b">no_std</code>-compatible.</p><p id="d2d9" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">For example, the popular <code class="cx hd he hf hg b">thiserror</code> crate introduces <code class="cx hd he hf hg b">std</code> into your code and offers no Cargo feature to disable it. However, the community has created <code class="cx hd he hf hg b">no_std</code> alternatives. You can find these alternatives by searching, for example, <a class="af ng" href="https://crates.io/search?q=thiserror+no_std" rel="noopener ugc nofollow" target="_blank">https://crates.io/search?q=thiserror+no_std</a>.</p><p id="29e3" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">In the case of <code class="cx hd he hf hg b">range-set-blaze</code>, a problem remained related to crate <code class="cx hd he hf hg b"><a class="af ng" href="https://crates.io/crates/gen_ops" rel="noopener ugc nofollow" target="_blank">gen_ops</a></code> — a wonderful crate for conveniently defining operators such as <code class="cx hd he hf hg b">+</code> and <code class="cx hd he hf hg b">&amp;</code>. The crate used <code class="cx hd he hf hg b">std</code> but didn’t need to. I identified the required one-line change (using the methods we'll cover in Rule 3) and submitted a pull request. The maintainer accepted it, and they released an updated version: <code class="cx hd he hf hg b">0.4.0</code>.</p><p id="506b" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Sometimes, our project can’t disable <code class="cx hd he hf hg b">std</code> because we need capabilities like file access when running on a full operating system. On embedded systems, however, we're willing—and indeed must—give up such capabilities. In Rule 4, we'll see how to make <code class="cx hd he hf hg b">std</code> usage optional by introducing our own Cargo features.</p><p id="942e" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Using these methods fixed all the dependency errors in <code class="cx hd he hf hg b">range-set-blaze</code>. However, resolving <strong class="nj fr">those</strong> errors revealed 281 errors in the main code. Progress!</p><h1 id="c13a" class="pb pc fq bf pd pe pf gq pg ph pi gt pj pk pl pm pn po pp pq pr ps pt pu pv pw bk">Rule 3: Mark main (non-test) code <code class="cx hd he hf hg b">no_std</code> and <code class="cx hd he hf hg b">alloc</code>. Replace <code class="cx hd he hf hg b">std::</code> with <code class="cx hd he hf hg b">core:: </code>and <code class="cx hd he hf hg b">alloc::</code>.</h1><p id="f17c" class="pw-post-body-paragraph nh ni fq nj b go px nl nm gr py no np nq pz ns nt nu qa nw nx ny qb oa ob oc fj bk">At the top of your project’s <code class="cx hd he hf hg b">lib.rs</code> (or <code class="cx hd he hf hg b">main.rs</code>) add:</p><pre class="mq mr ms mt mu qd hg qe bp qf bb bk"><span id="3e5a" class="qg pc fq hg b bg qh qi l qj qk">#![no_std]<br/>extern crate alloc;</span></pre><p id="1513" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">This means we won’t use the standard library, but we will still allocate memory. For <code class="cx hd he hf hg b">range-set-blaze</code>, this change reduced the error count from 281 to 52.</p><p id="d209" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Many of the remaining errors are due to using items in <code class="cx hd he hf hg b">std</code> that are available in <code class="cx hd he hf hg b">core</code> or <code class="cx hd he hf hg b">alloc</code>. Since much of <code class="cx hd he hf hg b">std</code> is just a re-export of <code class="cx hd he hf hg b">core</code> and <code class="cx hd he hf hg b">alloc</code>, we can resolve many errors by switching <code class="cx hd he hf hg b">std</code> references to <code class="cx hd he hf hg b">core</code> or <code class="cx hd he hf hg b">alloc</code>. This allows us to keep the essential functionality without relying on the standard library.</p><p id="dd41" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">For example, we get an error for each of these lines:</p><pre class="mq mr ms mt mu qd hg qe bp qf bb bk"><span id="ec56" class="qg pc fq hg b bg qh qi l qj qk">use std::cmp::max;<br/>use std::cmp::Ordering;<br/>use std::collections::BTreeMap;</span></pre><p id="8f73" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Changing <code class="cx hd he hf hg b">std::</code> to either <code class="cx hd he hf hg b">core::</code> or (if memory related) <code class="cx hd he hf hg b">alloc::</code> fixes the errors:</p><pre class="mq mr ms mt mu qd hg qe bp qf bb bk"><span id="0f61" class="qg pc fq hg b bg qh qi l qj qk">use core::cmp::max;<br/>use core::cmp::Ordering;<br/>use alloc::collections::BTreeMap;</span></pre><p id="8565" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Some capabilities, such as file access, are <code class="cx hd he hf hg b">std</code>-only—that is, they are defined outside of <code class="cx hd he hf hg b">core</code> and <code class="cx hd he hf hg b">alloc</code>. Fortunately, for <code class="cx hd he hf hg b">range-set-blaze</code>, switching to <code class="cx hd he hf hg b">core</code> and <code class="cx hd he hf hg b">alloc</code> resolved all 52 errors in the main code. However, this fix revealed 89 errors in its test code. Again, progress!</p><blockquote class="oo op oq"><p id="b42d" class="nh ni or nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Aside: You can also find places where <code class="cx hd he hf hg b">std</code> could be <code class="cx hd he hf hg b">alloc</code> or <code class="cx hd he hf hg b">core</code> <a class="af ng" href="https://users.rust-lang.org/t/how-to-libraries-and-no-std/119455/3" rel="noopener ugc nofollow" target="_blank">via Clippy rules</a>.</p></blockquote><p id="2b10" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">We’ll address errors in the test code in Rule 5, but first, let’s figure out what to do if we need capabilities like file access when running on a full operating system.</p><h1 id="c4d9" class="pb pc fq bf pd pe pf gq pg ph pi gt pj pk pl pm pn po pp pq pr ps pt pu pv pw bk">Rule 4: Use Cargo features to let your main code use <code class="cx hd he hf hg b">std</code> optionally for file-related (etc.) functions.</h1><p id="f9d1" class="pw-post-body-paragraph nh ni fq nj b go px nl nm gr py no np nq pz ns nt nu qa nw nx ny qb oa ob oc fj bk">If we need two versions of our code — one for running on a full operating system and one for embedded systems — we can use Cargo features (see Rule 6 in the <a class="af ng" href="https://medium.com/towards-data-science/nine-rules-for-running-rust-on-wasm-wasi-550cd14c252a" rel="noopener">first article</a>). For example, let’s define a feature called <code class="cx hd he hf hg b">foo</code>, which will be the default. We'll include the function <code class="cx hd he hf hg b">demo_read_ranges_from_file</code> only when <code class="cx hd he hf hg b">foo</code> is enabled.</p><p id="071b" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">In <code class="cx hd he hf hg b">Cargo.toml</code> (preliminary):</p><pre class="mq mr ms mt mu qd hg qe bp qf bb bk"><span id="9d84" class="qg pc fq hg b bg qh qi l qj qk">[features]<br/>default = ["foo"]<br/>foo = []</span></pre><p id="e98d" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">In <code class="cx hd he hf hg b">lib.rs</code> (preliminary):</p><pre class="mq mr ms mt mu qd hg qe bp qf bb bk"><span id="2a1e" class="qg pc fq hg b bg qh qi l qj qk">#![no_std]<br/>extern crate alloc;<br/><br/>// ...<br/><br/>#[cfg(feature = "foo")]<br/>pub fn demo_read_ranges_from_file&lt;P, T&gt;(path: P) -&gt; std::io::Result&lt;RangeSetBlaze&lt;T&gt;&gt;<br/>where<br/>    P: AsRef&lt;std::path::Path&gt;,<br/>    T: FromStr + Integer,<br/>{<br/>    todo!("This function is not yet implemented.");<br/>}</span></pre><p id="8876" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">This says to define function <code class="cx hd he hf hg b">demo_read_ranges_from_file</code> only when Cargo feature <code class="cx hd he hf hg b">foo</code> is enabled. We can now check various versions of our code:</p><pre class="mq mr ms mt mu qd hg qe bp qf bb bk"><span id="118b" class="qg pc fq hg b bg qh qi l qj qk">cargo check # enables "foo", the default Cargo features<br/>cargo check --features foo # also enables "foo"<br/>cargo check --no-default-features # enables nothing</span></pre><p id="5903" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Now let’s give our Cargo feature a more meaningful name by renaming <code class="cx hd he hf hg b">foo</code> to <code class="cx hd he hf hg b">std</code>. Our <code class="cx hd he hf hg b">Cargo.toml</code> (intermediate) now looks like:</p><pre class="mq mr ms mt mu qd hg qe bp qf bb bk"><span id="4624" class="qg pc fq hg b bg qh qi l qj qk">[features]<br/>default = ["std"]<br/>std = []</span></pre><p id="06b6" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">In our <code class="cx hd he hf hg b">lib.rs</code>, we add these lines near the top to bring in the <code class="cx hd he hf hg b">std</code> library when the <code class="cx hd he hf hg b">std</code> Cargo feature is enabled:</p><pre class="mq mr ms mt mu qd hg qe bp qf bb bk"><span id="b1c1" class="qg pc fq hg b bg qh qi l qj qk">#[cfg(feature = "std")]<br/>extern crate std;</span></pre><p id="aacd" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">So, <code class="cx hd he hf hg b">lib.rs</code> (final) looks like this:</p><pre class="mq mr ms mt mu qd hg qe bp qf bb bk"><span id="3c4d" class="qg pc fq hg b bg qh qi l qj qk">#![no_std]<br/>extern crate alloc;<br/><br/>#[cfg(feature = "std")]<br/>extern crate std;<br/><br/>// ...<br/><br/>#[cfg(feature = "std")]<br/>pub fn demo_read_ranges_from_file&lt;P, T&gt;(path: P) -&gt; std::io::Result&lt;RangeSetBlaze&lt;T&gt;&gt;<br/>where<br/>    P: AsRef&lt;std::path::Path&gt;,<br/>    T: FromStr + Integer,<br/>{<br/>    todo!("This function is not yet implemented.");<br/>}</span></pre><p id="c9b0" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">We’d like to make one more change to our <code class="cx hd he hf hg b">Cargo.toml</code>. We want our new Cargo feature to control dependencies and their features. Here is the resulting <code class="cx hd he hf hg b">Cargo.toml</code> (final):</p><pre class="mq mr ms mt mu qd hg qe bp qf bb bk"><span id="46eb" class="qg pc fq hg b bg qh qi l qj qk">[features]<br/>default = ["std"]<br/>std = ["itertools/use_std", "num-traits/std", "num-integer/std"]<br/><br/>[dependencies]<br/>itertools = { version = "0.13.0", features = ["use_alloc"], default-features = false }<br/>num-integer = { version = "0.1.46", default-features = false }<br/>num-traits = { version = "0.2.19", features = ["i128"], default-features = false }<br/>gen_ops = "0.4.0"</span></pre><blockquote class="oo op oq"><p id="fb53" class="nh ni or nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Aside: If you’re confused by the <code class="cx hd he hf hg b">Cargo.toml</code> format for specifying dependencies and features, see my recent article: <a class="af ng" href="https://medium.com/towards-data-science/nine-rust-cargo-toml-wats-and-wat-nots-1e5e02e41648" rel="noopener"><em class="fq">Nine Rust Cargo.toml Wats and Wat Nots: Master Cargo.toml formatting rules and avoid frustration</em></a><em class="fq"> in</em> Towards Data Science.</p></blockquote><p id="cf1b" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">To check that your project compiles both with the standard library (<code class="cx hd he hf hg b">std</code>) and without, use the following commands:</p><pre class="mq mr ms mt mu qd hg qe bp qf bb bk"><span id="9939" class="qg pc fq hg b bg qh qi l qj qk">cargo check # std<br/>cargo check --no-default-features # no_std</span></pre><p id="b4e9" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">With <code class="cx hd he hf hg b">cargo check</code> working, you’d think that <code class="cx hd he hf hg b">cargo test</code> would be straight forward. Unfortunately, it’s not. We’ll look at that next.</p><h1 id="c165" class="pb pc fq bf pd pe pf gq pg ph pi gt pj pk pl pm pn po pp pq pr ps pt pu pv pw bk">Rule 5: Understand why test code always uses the standard library.</h1><p id="9583" class="pw-post-body-paragraph nh ni fq nj b go px nl nm gr py no np nq pz ns nt nu qa nw nx ny qb oa ob oc fj bk">When we compile our project with <code class="cx hd he hf hg b">--no-default-features</code>, it operates in a <code class="cx hd he hf hg b">no_std</code> environment. However, Rust's testing framework always includes the standard library, even in a <code class="cx hd he hf hg b">no_std</code> project. This is because <code class="cx hd he hf hg b">cargo test</code> requires <code class="cx hd he hf hg b">std</code>; for example, the <code class="cx hd he hf hg b">#[test]</code> attribute and the test harness itself are defined in the standard library.</p><p id="ab53" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">As a result, running:</p><pre class="mq mr ms mt mu qd hg qe bp qf bb bk"><span id="4407" class="qg pc fq hg b bg qh qi l qj qk"># DOES NOT TEST `no_std`<br/>cargo test --no-default-features</span></pre><p id="a7ae" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">does not actually test the <code class="cx hd he hf hg b">no_std</code> version of your code. Functions from <code class="cx hd he hf hg b">std</code> that are unavailable in a true <code class="cx hd he hf hg b">no_std</code> environment will still be accessible during testing. For instance, the following test will compile and run successfully with <code class="cx hd he hf hg b">--no-default-features</code>, even though it uses <code class="cx hd he hf hg b">std::fs</code>:</p><pre class="mq mr ms mt mu qd hg qe bp qf bb bk"><span id="051b" class="qg pc fq hg b bg qh qi l qj qk">#[test]<br/>fn test_read_file_metadata() {<br/>    let metadata = std::fs::metadata("./").unwrap();<br/>    assert!(metadata.is_dir());<br/>}</span></pre><p id="22e5" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Additionally, when testing in <code class="cx hd he hf hg b">std</code> mode, you may need to add explicit imports for features from the standard library. This is because, even though <code class="cx hd he hf hg b">std</code> is available during testing, your project is still compiled as <code class="cx hd he hf hg b">#![no_std]</code>, meaning the standard prelude is not automatically in scope. For example, you’ll often need the following imports in your test code:</p><pre class="mq mr ms mt mu qd hg qe bp qf bb bk"><span id="e972" class="qg pc fq hg b bg qh qi l qj qk">#![cfg(test)]<br/>use std::prelude::v1::*;<br/>use std::{format, print, println, vec};</span></pre><p id="3950" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">These imports bring in the necessary utilities from the standard library so that they are available during testing.</p><p id="3b78" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">To genuinely test your code without the standard library, you’ll need to use alternative methods that do not rely on <code class="cx hd he hf hg b">cargo test</code>. We'll explore how to run <code class="cx hd he hf hg b">no_std</code> tests in the next rule.</p><h1 id="6e5c" class="pb pc fq bf pd pe pf gq pg ph pi gt pj pk pl pm pn po pp pq pr ps pt pu pv pw bk">Rule 6: Create a simple embedded test project. Run it with QEMU.</h1><p id="4f04" class="pw-post-body-paragraph nh ni fq nj b go px nl nm gr py no np nq pz ns nt nu qa nw nx ny qb oa ob oc fj bk">You can’t run your regular tests in an embedded environment. However, you <strong class="nj fr">can</strong> — and should — run at least one embedded test. My philosophy is that even a single test is infinitely better than none. Since “if it compiles, it works” is generally true for <code class="cx hd he hf hg b">no_std</code> projects, one (or a few) well-chosen test can be quite effective.</p><blockquote class="oo op oq"><p id="d6a2" class="nh ni or nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Aside: There is hope for embedded running tests in a more normal fashion [<a class="af ng" href="https://users.rust-lang.org/t/how-to-implement-unit-tests-for-a-project-with-embedded-rust/99768" rel="noopener ugc nofollow" target="_blank">1</a>][<a class="af ng" href="https://www.reddit.com/r/rust/comments/1g3i5uh/comment/lrxith4/" rel="noopener ugc nofollow" target="_blank">2</a>]. As far as I know, nothing works easily with normal, native tests. If this changes, please let me know and I’ll update this section.</p></blockquote><p id="b188" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">To run this test, we use QEMU (Quick Emulator, pronounced “cue-em-you”), which allows us to emulate <code class="cx hd he hf hg b">thumbv7m-none-eabi</code> code on our main operating system (Linux, Windows, or macOS).</p><h2 id="061b" class="qm pc fq bf pd qn qo qp pg qq qr qs pj nq qt qu qv nu qw qx qy ny qz ra rb rc bk">Install QEMU.</h2><p id="bc1c" class="pw-post-body-paragraph nh ni fq nj b go px nl nm gr py no np nq pz ns nt nu qa nw nx ny qb oa ob oc fj bk">See the QEMU <a class="af ng" href="https://www.qemu.org/download/" rel="noopener ugc nofollow" target="_blank">download page</a> for full information:</p><p id="2c55" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk"><strong class="nj fr">Linux/WSL</strong></p><ul class=""><li id="fdfa" class="nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc os oh oi bk">Ubuntu: <code class="cx hd he hf hg b">sudo apt-get install qemu-system</code></li><li id="5096" class="nh ni fq nj b go oj nl nm gr ok no np nq ol ns nt nu om nw nx ny on oa ob oc os oh oi bk">Arch: <code class="cx hd he hf hg b">sudo pacman -S qemu-system-arm</code></li><li id="137c" class="nh ni fq nj b go oj nl nm gr ok no np nq ol ns nt nu om nw nx ny on oa ob oc os oh oi bk">Fedora: <code class="cx hd he hf hg b">sudo dnf install qemu-system-arm</code></li></ul><p id="9473" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk"><strong class="nj fr">Windows</strong></p><ul class=""><li id="3a61" class="nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc os oh oi bk">Method 1: <a class="af ng" href="https://qemu.weilnetz.de/w64" rel="noopener ugc nofollow" target="_blank">https://qemu.weilnetz.de/w64</a>. Run the installer (tell Windows that it is OK). Add <code class="cx hd he hf hg b">"C:\Program Files\qemu\"</code> to your path.</li><li id="1667" class="nh ni fq nj b go oj nl nm gr ok no np nq ol ns nt nu om nw nx ny on oa ob oc os oh oi bk">Method 2: Install MSYS2 from <a class="af ng" href="https://www.msys2.org/" rel="noopener ugc nofollow" target="_blank">https://www.msys2.org/</a>. Open MSYS2 UCRT64 terminal. <code class="cx hd he hf hg b">pacman -S mingw-w64-x86_64-qemu</code>. Add <code class="cx hd he hf hg b">C:\msys64\mingw64\bin\</code> to your path.</li></ul><p id="7467" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk"><strong class="nj fr">Mac</strong></p><ul class=""><li id="21f3" class="nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc os oh oi bk"><code class="cx hd he hf hg b">brew install qemu</code> or <code class="cx hd he hf hg b">sudo port install qemu</code></li></ul><p id="c506" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Test installation with:</p><pre class="mq mr ms mt mu qd hg qe bp qf bb bk"><span id="33fe" class="qg pc fq hg b bg qh qi l qj qk">qemu-system-arm --version</span></pre><h2 id="f167" class="qm pc fq bf pd qn qo qp pg qq qr qs pj nq qt qu qv nu qw qx qy ny qz ra rb rc bk">Create an embedded subproject.</h2><p id="5c97" class="pw-post-body-paragraph nh ni fq nj b go px nl nm gr py no np nq pz ns nt nu qa nw nx ny qb oa ob oc fj bk">Create a subproject for the embedded tests:</p><pre class="mq mr ms mt mu qd hg qe bp qf bb bk"><span id="71ca" class="qg pc fq hg b bg qh qi l qj qk">cargo new tests/embedded</span></pre><p id="134a" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">This command generates a new subproject, including the configuration file at <code class="cx hd he hf hg b">tests/embedded/Cargo.toml</code>.</p><blockquote class="oo op oq"><p id="c0e9" class="nh ni or nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Aside<strong class="nj fr">:</strong> This command also modifies your top-level <code class="cx hd he hf hg b">Cargo.toml</code> to add the subproject to your workspace. In Rust, a workspace is a collection of related packages defined in the <code class="cx hd he hf hg b">[workspace]</code> section of the top-level <code class="cx hd he hf hg b">Cargo.toml</code>. All packages in the workspace share a single <code class="cx hd he hf hg b">Cargo.lock</code> file, ensuring consistent dependency versions across the entire workspace.</p></blockquote><p id="5b1f" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Edit <code class="cx hd he hf hg b">tests/embedded/Cargo.toml</code> to look like this, but replace <code class="cx hd he hf hg b">"range-set-blaze"</code> with the name of your top-level project:</p><pre class="mq mr ms mt mu qd hg qe bp qf bb bk"><span id="c4b3" class="qg pc fq hg b bg qh qi l qj qk">[package]<br/>name = "embedded"<br/>version = "0.1.0"<br/>edition = "2021"<br/><br/>[dependencies]<br/>alloc-cortex-m = "0.4.4"<br/>cortex-m = "0.7.7"<br/>cortex-m-rt = "0.7.3"<br/>cortex-m-semihosting = "0.5.0"<br/>panic-halt = "0.2.0"<br/># Change to refer to your top-level project<br/>range-set-blaze = { path = "../..", default-features = false }</span></pre><h2 id="adf3" class="qm pc fq bf pd qn qo qp pg qq qr qs pj nq qt qu qv nu qw qx qy ny qz ra rb rc bk">Update the test code.</h2><p id="cc21" class="pw-post-body-paragraph nh ni fq nj b go px nl nm gr py no np nq pz ns nt nu qa nw nx ny qb oa ob oc fj bk">Replace the contents of <code class="cx hd he hf hg b">tests/embedded/src/main.rs</code> with:</p><pre class="mq mr ms mt mu qd hg qe bp qf bb bk"><span id="56e4" class="qg pc fq hg b bg qh qi l qj qk">// Based on https://github.com/rust-embedded/cortex-m-quickstart/blob/master/examples/allocator.rs<br/>// and https://github.com/rust-lang/rust/issues/51540<br/>#![feature(alloc_error_handler)]<br/>#![no_main]<br/>#![no_std]<br/>extern crate alloc;<br/>use alloc::string::ToString;<br/>use alloc_cortex_m::CortexMHeap;<br/>use core::{alloc::Layout, iter::FromIterator};<br/>use cortex_m::asm;<br/>use cortex_m_rt::entry;<br/>use cortex_m_semihosting::{debug, hprintln};<br/>use panic_halt as _;<br/>#[global_allocator]<br/>static ALLOCATOR: CortexMHeap = CortexMHeap::empty();<br/>const HEAP_SIZE: usize = 1024; // in bytes<br/>#[alloc_error_handler]<br/>fn alloc_error(_layout: Layout) -&gt; ! {<br/>    asm::bkpt();<br/>    loop {}<br/>}<br/><br/>#[entry]<br/>fn main() -&gt; ! {<br/>    unsafe { ALLOCATOR.init(cortex_m_rt::heap_start() as usize, HEAP_SIZE) }<br/><br/>    // Test(s) goes here. Run only under emulation<br/>    use range_set_blaze::RangeSetBlaze;<br/>    let range_set_blaze = RangeSetBlaze::from_iter([100, 103, 101, 102, -3, -4]);<br/>    hprintln!("{:?}", range_set_blaze.to_string());<br/>    if range_set_blaze.to_string() != "-4..=-3, 100..=103" {<br/>        debug::exit(debug::EXIT_FAILURE);<br/>    }<br/><br/>    debug::exit(debug::EXIT_SUCCESS);<br/>    loop {}<br/>}</span></pre><p id="3086" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Most of this <code class="cx hd he hf hg b">main.rs</code> code is embedded system boilerplate. The actual test code is:</p><pre class="mq mr ms mt mu qd hg qe bp qf bb bk"><span id="fb4e" class="qg pc fq hg b bg qh qi l qj qk">use range_set_blaze::RangeSetBlaze;<br/>let range_set_blaze = RangeSetBlaze::from_iter([100, 103, 101, 102, -3, -4]);<br/>hprintln!("{:?}", range_set_blaze.to_string());<br/>if range_set_blaze.to_string() != "-4..=-3, 100..=103" {<br/>    debug::exit(debug::EXIT_FAILURE);<br/>}</span></pre><p id="d330" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">If the test fails, it returns <code class="cx hd he hf hg b">EXIT_FAILURE</code>; otherwise, it returns <code class="cx hd he hf hg b">EXIT_SUCCESS</code>. We use the <code class="cx hd he hf hg b">hprintln!</code> macro to print messages to the console during emulation. Since this is an embedded system, the code ends in an infinite loop to run continuously.</p><h2 id="65c9" class="qm pc fq bf pd qn qo qp pg qq qr qs pj nq qt qu qv nu qw qx qy ny qz ra rb rc bk">Add supporting files.</h2><p id="7e93" class="pw-post-body-paragraph nh ni fq nj b go px nl nm gr py no np nq pz ns nt nu qa nw nx ny qb oa ob oc fj bk">Before you can run the test, you must add two files to the subproject: <code class="cx hd he hf hg b">build.rs</code> and <code class="cx hd he hf hg b">memory.x</code> from the Cortex-M <a class="af ng" href="https://github.com/rust-embedded/cortex-m-quickstart/tree/master" rel="noopener ugc nofollow" target="_blank">quickstart repository</a>:</p><p id="9887" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk"><strong class="nj fr">Linux/WSL/macOS</strong></p><pre class="mq mr ms mt mu qd hg qe bp qf bb bk"><span id="402b" class="qg pc fq hg b bg qh qi l qj qk">cd tests/embedded<br/>wget https://raw.githubusercontent.com/rust-embedded/cortex-m-quickstart/master/build.rs<br/>wget https://raw.githubusercontent.com/rust-embedded/cortex-m-quickstart/master/memory.</span></pre><p id="58de" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk"><strong class="nj fr">Windows (Powershell)</strong></p><pre class="mq mr ms mt mu qd hg qe bp qf bb bk"><span id="9f19" class="qg pc fq hg b bg qh qi l qj qk">cd tests/embedded<br/>Invoke-WebRequest -Uri 'https://raw.githubusercontent.com/rust-embedded/cortex-m-quickstart/master/build.rs' -OutFile 'build.rs'<br/>Invoke-WebRequest -Uri 'https://raw.githubusercontent.com/rust-embedded/cortex-m-quickstart/master/memory.x' -OutFile 'memory.x'</span></pre><p id="ae1c" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Also, create a <code class="cx hd he hf hg b">tests/embedded/.cargo/config.toml</code> with the following content:</p><pre class="mq mr ms mt mu qd hg qe bp qf bb bk"><span id="a251" class="qg pc fq hg b bg qh qi l qj qk">[target.thumbv7m-none-eabi]<br/>runner = "qemu-system-arm -cpu cortex-m3 -machine lm3s6965evb -nographic -semihosting-config enable=on,target=native -kernel"<br/><br/>[build]<br/>target = "thumbv7m-none-eabi"</span></pre><p id="47f1" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">This configuration instructs Cargo to use QEMU to run the embedded code and sets <code class="cx hd he hf hg b">thumbv7m-none-eabi</code> as the default target for the subproject.</p><h2 id="7ad2" class="qm pc fq bf pd qn qo qp pg qq qr qs pj nq qt qu qv nu qw qx qy ny qz ra rb rc bk">Run the test.</h2><p id="633f" class="pw-post-body-paragraph nh ni fq nj b go px nl nm gr py no np nq pz ns nt nu qa nw nx ny qb oa ob oc fj bk">Run the test with <code class="cx hd he hf hg b">cargo run</code> (not <code class="cx hd he hf hg b">cargo test</code>):</p><pre class="mq mr ms mt mu qd hg qe bp qf bb bk"><span id="79f5" class="qg pc fq hg b bg qh qi l qj qk"># Setup<br/># Make this subproject 'nightly' to support #![feature(alloc_error_handler)]<br/>rustup override set nightly<br/>rustup target add thumbv7m-none-eabi<br/><br/># If needed, cd tests/embedded<br/>cargo run</span></pre><p id="8b2f" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">You should see log messages, and the process should exit without error. In my case, I see: <code class="cx hd he hf hg b">"-4..=-3, 100..=103"</code>.</p><p id="b14b" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">These steps may seem like a significant amount of work just to run one (or a few) tests. However, it’s primarily a one-time effort involving mostly copy and paste. Additionally, it enables running tests in a CI environment (see Rule 9). The alternative — claiming that the code works in a <code class="cx hd he hf hg b">no_std</code> environment without ever actually running it in <code class="cx hd he hf hg b">no_std</code>—risks overlooking critical issues.</p><p id="af35" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">The next rule is much simpler.</p><h1 id="a8f6" class="pb pc fq bf pd pe pf gq pg ph pi gt pj pk pl pm pn po pp pq pr ps pt pu pv pw bk">Rule 7: In <code class="cx hd he hf hg b">Cargo.toml</code>, add keywords and categories for WASM and <code class="cx hd he hf hg b">no_std</code>.</h1><p id="c583" class="pw-post-body-paragraph nh ni fq nj b go px nl nm gr py no np nq pz ns nt nu qa nw nx ny qb oa ob oc fj bk">Once your package compiles and passes the additional embedded test, you may want to publish it to <a class="af ng" href="https://crates.io/" rel="noopener ugc nofollow" target="_blank">crates.io</a>, Rust’s package registry. To let others know that it is compatible with WASM and <code class="cx hd he hf hg b">no_std</code>, add the following keywords and categories to your <code class="cx hd he hf hg b">Cargo.toml</code> file:</p><pre class="mq mr ms mt mu qd hg qe bp qf bb bk"><span id="96a2" class="qg pc fq hg b bg qh qi l qj qk">[package]<br/># ... <br/>categories = ["no-std", "wasm", "embedded"] # + others specific to your package<br/>keywords = ["no_std", "wasm"] # + others specific to your package</span></pre><p id="f942" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Note that for categories, we use a hyphen in <code class="cx hd he hf hg b">no-std</code>. For keywords, <code class="cx hd he hf hg b">no_std</code> (with an underscore) is more popular than <code class="cx hd he hf hg b">no-std</code>. Your package can have a maximum of five keywords and five categories.</p><p id="15ce" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Here is a list of <a class="af ng" href="https://crates.io/categories/" rel="noopener ugc nofollow" target="_blank">categories</a> and <a class="af ng" href="https://crates.io/keywords" rel="noopener ugc nofollow" target="_blank">keywords</a> of possible interest, along with the number of crates using each term:</p><ul class=""><li id="f9e7" class="nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc os oh oi bk"><a class="af ng" href="https://crates.io/categories/no-std?sort=downloads" rel="noopener ugc nofollow" target="_blank">Category no-std</a> (6884)</li><li id="23e5" class="nh ni fq nj b go oj nl nm gr ok no np nq ol ns nt nu om nw nx ny on oa ob oc os oh oi bk"><a class="af ng" href="https://crates.io/categories/embedded?sort=downloads" rel="noopener ugc nofollow" target="_blank">Category embedded</a> (3455)</li><li id="d2e6" class="nh ni fq nj b go oj nl nm gr ok no np nq ol ns nt nu om nw nx ny on oa ob oc os oh oi bk"><a class="af ng" href="https://crates.io/categories/wasm?sort=downloads" rel="noopener ugc nofollow" target="_blank">Category wasm</a> (2026)</li><li id="a486" class="nh ni fq nj b go oj nl nm gr ok no np nq ol ns nt nu om nw nx ny on oa ob oc os oh oi bk"><a class="af ng" href="https://crates.io/categories/no-std::no-alloc?sort=downloads" rel="noopener ugc nofollow" target="_blank">Category no-std::no-alloc</a> (581)</li><li id="fa48" class="nh ni fq nj b go oj nl nm gr ok no np nq ol ns nt nu om nw nx ny on oa ob oc os oh oi bk"><a class="af ng" href="https://crates.io/keywords/wasm?sort=downloads" rel="noopener ugc nofollow" target="_blank">Keyword wasm</a> (1686)</li><li id="c161" class="nh ni fq nj b go oj nl nm gr ok no np nq ol ns nt nu om nw nx ny on oa ob oc os oh oi bk"><a class="af ng" href="https://crates.io/keywords/no_std?sort=downloads" rel="noopener ugc nofollow" target="_blank">Keyword no_std</a> (1351)</li><li id="cd39" class="nh ni fq nj b go oj nl nm gr ok no np nq ol ns nt nu om nw nx ny on oa ob oc os oh oi bk"><a class="af ng" href="https://crates.io/keywords/no-std?sort=downloads" rel="noopener ugc nofollow" target="_blank">Keyword no-std</a> (1157)</li><li id="d4d3" class="nh ni fq nj b go oj nl nm gr ok no np nq ol ns nt nu om nw nx ny on oa ob oc os oh oi bk"><a class="af ng" href="https://crates.io/keywords/embedded?sort=downloads" rel="noopener ugc nofollow" target="_blank">Keyword embedded</a> (925)</li><li id="e6c9" class="nh ni fq nj b go oj nl nm gr ok no np nq ol ns nt nu om nw nx ny on oa ob oc os oh oi bk"><a class="af ng" href="https://crates.io/keywords/webassembly?sort=downloads" rel="noopener ugc nofollow" target="_blank">Keyword webassembly</a> (804)</li></ul><p id="55ea" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Good categories and keywords will help people find your package, but the system is informal. There’s no mechanism to check whether your categories and keywords are accurate, nor are you required to provide them.</p><p id="c1ec" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Next, we’ll explore one of the most restricted environments you’re likely to encounter.</p><h1 id="8a6e" class="pb pc fq bf pd pe pf gq pg ph pi gt pj pk pl pm pn po pp pq pr ps pt pu pv pw bk">Rule 8: [Optional] Use preallocated data types to avoid <code class="cx hd he hf hg b">alloc</code>.</h1><p id="446a" class="pw-post-body-paragraph nh ni fq nj b go px nl nm gr py no np nq pz ns nt nu qa nw nx ny qb oa ob oc fj bk">My project, <code class="cx hd he hf hg b">range-set-blaze</code>, implements a dynamic data structure that requires memory allocation from the heap (via <code class="cx hd he hf hg b">alloc</code>). But what if your project doesn't need dynamic memory allocation? In that case, it can run in even more restricted embedded environments—specifically those where all memory is preallocated when the program is loaded.</p><p id="eecc" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">The reasons to avoid <code class="cx hd he hf hg b">alloc</code> if you can:</p><ul class=""><li id="9f4f" class="nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc os oh oi bk">Completely deterministic memory usage</li><li id="071f" class="nh ni fq nj b go oj nl nm gr ok no np nq ol ns nt nu om nw nx ny on oa ob oc os oh oi bk">Reduced risk of runtime failures (often caused by memory fragmentation)</li><li id="d31c" class="nh ni fq nj b go oj nl nm gr ok no np nq ol ns nt nu om nw nx ny on oa ob oc os oh oi bk">Lower power consumption</li></ul><p id="78e7" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">There are crates available that can sometimes help you replace dynamic data structures like <code class="cx hd he hf hg b">Vec</code>, <code class="cx hd he hf hg b">String</code>, and <code class="cx hd he hf hg b">HashMap</code>. These alternatives generally require you to specify a maximum size. The table below shows some popular crates for this purpose:</p><figure class="mq mr ms mt mu mv mn mo paragraph-image"><div class="mn mo rd"><img src="../Images/4f7714b6900349e2d92b8951535736c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:678/format:webp/1*7x5O4wXw_TY-2HAH5Ui97w.png"/></div></figure><p id="5b73" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">I recommend the <code class="cx hd he hf hg b">heapless</code> crate because it provides a collection of data structures that work well together.</p><p id="4373" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Here is an example of code — using <code class="cx hd he hf hg b">heapless </code>— related to an LED display. This code creates a mapping from a byte to a list of integers. We limit the number of items in the map and the length of the integer list to <code class="cx hd he hf hg b">DIGIT_COUNT</code> (in this case, 4).</p><pre class="mq mr ms mt mu qd hg qe bp qf bb bk"><span id="0600" class="qg pc fq hg b bg qh qi l qj qk">use heapless::{LinearMap, Vec};<br/>// …<br/>let mut map: LinearMap&lt;u8, Vec&lt;usize, DIGIT_COUNT&gt;, DIGIT_COUNT&gt; = LinearMap::new();<br/>// …<br/>let mut vec = Vec::default();<br/>vec.push(index).unwrap();<br/>map.insert(*byte, vec).unwrap(); // actually copies</span></pre><p id="9476" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Full details about creating a <code class="cx hd he hf hg b">no_alloc</code> project are beyond my experience. However, the first step is to remove this line (added in Rule 3) from your <code class="cx hd he hf hg b">lib.rs</code> or <code class="cx hd he hf hg b">main.rs</code>:</p><pre class="mq mr ms mt mu qd hg qe bp qf bb bk"><span id="6aa3" class="qg pc fq hg b bg qh qi l qj qk">extern crate alloc; // remove this</span></pre><h1 id="578e" class="pb pc fq bf pd pe pf gq pg ph pi gt pj pk pl pm pn po pp pq pr ps pt pu pv pw bk">Rule 9: Add <code class="cx hd he hf hg b">thumbv7m-none-eabi</code> and QEMU to your CI (continuous integration) tests.</h1><p id="425c" class="pw-post-body-paragraph nh ni fq nj b go px nl nm gr py no np nq pz ns nt nu qa nw nx ny qb oa ob oc fj bk">Your project is now compiling to <code class="cx hd he hf hg b">no_std</code> and passing at least one embedded-specific test. Are you done? Not quite. As I said in the previous two articles:</p><blockquote class="oo op oq"><p id="44e0" class="nh ni or nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">If it’s not in CI, it doesn’t exist.</p></blockquote><p id="372d" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Recall that continuous integration (CI) is a system that can automatically run tests every time you update your code. I use GitHub Actions as my CI platform. Here’s the configuration I added to <code class="cx hd he hf hg b">.github/workflows/ci.yml</code> to test my project on embedded platforms:</p><pre class="mq mr ms mt mu qd hg qe bp qf bb bk"><span id="144a" class="qg pc fq hg b bg qh qi l qj qk">test_thumbv7m_none_eabi:<br/>    name: Setup and Check Embedded<br/>    runs-on: ubuntu-latest<br/>    steps:<br/>      - name: Checkout<br/>        uses: actions/checkout@v4<br/>      - name: Set up Rust<br/>        uses: dtolnay/rust-toolchain@master<br/>        with:<br/>          toolchain: stable<br/>          target: thumbv7m-none-eabi<br/>      - name: Install check stable and nightly<br/>        run: |<br/>          cargo check --target thumbv7m-none-eabi --no-default-features<br/>          rustup override set nightly<br/>          rustup target add thumbv7m-none-eabi<br/>          cargo check --target thumbv7m-none-eabi --no-default-features<br/>          sudo apt-get update &amp;&amp; sudo apt-get install qemu qemu-system-arm<br/>      - name: Test Embedded (in nightly)<br/>        timeout-minutes: 1<br/>        run: |<br/>          cd tests/embedded<br/>          cargo run</span></pre><p id="5393" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">By testing embedded and <code class="cx hd he hf hg b">no_std</code> with CI, I can be sure that my code will continue to support embedded platforms in the future.</p></div></div></div><div class="ab cb ot ou ov ow" role="separator"><span class="ox by bm oy oz pa"/><span class="ox by bm oy oz pa"/><span class="ox by bm oy oz"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="2283" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">So, there you have it — nine rules for porting your Rust code to embedded. To see a snapshot of the whole <code class="cx hd he hf hg b">range-set-blaze</code> project after applying all nine rules, see <a class="af ng" href="https://github.com/CarlKCarlK/range-set-blaze/tree/rustconf24.nostd" rel="noopener ugc nofollow" target="_blank">this branch on Github</a>.</p><p id="683f" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Here is what surprised me about porting to embedded:</p><p id="0768" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk"><strong class="nj fr">The Bad:</strong></p><ul class=""><li id="610d" class="nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc os oh oi bk">We cannot run our existing tests on embedded systems. Instead, we must create a new subproject and write (a few) new tests.</li><li id="9a8b" class="nh ni fq nj b go oj nl nm gr ok no np nq ol ns nt nu om nw nx ny on oa ob oc os oh oi bk">Many popular libraries rely on <code class="cx hd he hf hg b">std</code>, so finding or adapting dependencies that work with <code class="cx hd he hf hg b">no_std</code> can be challenging.</li></ul><p id="9204" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk"><strong class="nj fr">The Good:</strong></p><ul class=""><li id="b18d" class="nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc os oh oi bk">The Rust saying that “if it compiles, it works” holds true for embedded development. This gives us confidence in our code’s correctness without requiring extensive new tests.</li><li id="623d" class="nh ni fq nj b go oj nl nm gr ok no np nq ol ns nt nu om nw nx ny on oa ob oc os oh oi bk">Although <code class="cx hd he hf hg b">no_std</code> removes our immediate access to the standard library, many items continue to be available via <code class="cx hd he hf hg b">core</code> and <code class="cx hd he hf hg b">alloc</code>.</li><li id="9563" class="nh ni fq nj b go oj nl nm gr ok no np nq ol ns nt nu om nw nx ny on oa ob oc os oh oi bk">Thanks to emulation, you can develop for embedded systems without hardware.</li></ul><p id="ffca" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Thank you for joining me on this journey from WASI to WebAssembly in the browser and, finally, to embedded development. Rust has continued to impress me with its ability to run efficiently and safely across environments. As you explore these different domains, I hope you find Rust’s flexibility and power as compelling as I do. Whether you’re working on cloud servers, browsers, or microcontrollers, the tools we’ve discussed will help you tackle the challenges ahead with confidence.</p></div></div></div><div class="ab cb ot ou ov ow" role="separator"><span class="ox by bm oy oz pa"/><span class="ox by bm oy oz pa"/><span class="ox by bm oy oz"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><blockquote class="oo op oq"><p id="7a5d" class="nh ni or nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Interested in future articles? Please <a class="af ng" href="https://medium.com/@carlmkadie" rel="noopener">follow me on Medium</a>. I write about Rust and Python, scientific programming, machine learning, and statistics. I tend to write about one article per month.</p></blockquote></div></div></div></div>    
</body>
</html>