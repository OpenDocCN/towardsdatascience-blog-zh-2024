<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>A Guide to Python’s Weak References Using the weakref Module</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>A Guide to Python’s Weak References Using the weakref Module</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/a-guide-to-pythons-weak-references-using-weakref-module-d3381b01db99?source=collection_archive---------6-----------------------#2024-06-25">https://towardsdatascience.com/a-guide-to-pythons-weak-references-using-weakref-module-d3381b01db99?source=collection_archive---------6-----------------------#2024-06-25</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="630e" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx">Learn all about weak references in Python: reference counting, garbage collection, and practical uses of the <code class="cx hd he hf hg b">weakref</code> module</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hh hi hj hk hl ab"><div><div class="ab hm"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@martin.heinz?source=post_page---byline--d3381b01db99--------------------------------" rel="noopener follow"><div class="l hn ho by hp hq"><div class="l ed"><img alt="Martin Heinz" class="l ep by dd de cx" src="../Images/a8d1540fd32998ee9bda4af0f0232f7d.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/2*p3sIQ1Ga2bfAbZYzoCcACw.jpeg"/><div class="hr by l dd de em n hs eo"/></div></div></a></div></div><div class="ht ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--d3381b01db99--------------------------------" rel="noopener follow"><div class="l hu hv by hp hw"><div class="l ed"><img alt="Towards Data Science" class="l ep by br hx cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hr by l br hx em n hs eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hy ab q"><div class="ab q hz"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b ia ib bk"><a class="af ag ah ai aj ak al am an ao ap aq ar ic" data-testid="authorName" href="https://medium.com/@martin.heinz?source=post_page---byline--d3381b01db99--------------------------------" rel="noopener follow">Martin Heinz</a></p></div></div></div><span class="id ie" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b ia ib dx"><button class="if ig ah ai aj ak al am an ao ap aq ar ih ii ij" disabled="">Follow</button></p></div></div></span></div></div><div class="l ik"><span class="bf b bg z dx"><div class="ab cn il im in"><div class="io ip ab"><div class="bf b bg z dx ab iq"><span class="ir l ik">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar ic ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--d3381b01db99--------------------------------" rel="noopener follow"><p class="bf b bg z is it iu iv iw ix iy iz bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="id ie" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">6 min read</span><div class="ja jb l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Jun 25, 2024</span></div></span></div></span></div></div></div><div class="ab cp jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr"><div class="h k w ea eb q"><div class="kh l"><div class="ab q ki kj"><div class="pw-multi-vote-icon ed ir kk kl km"><div class=""><div class="kn ko kp kq kr ks kt am ku kv kw km"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kx ky kz la lb lc ld"><p class="bf b dy z dx"><span class="ko">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kn lg lh ab q ee li lj" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="lf"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg><p class="bf b dy z dx"><span class="pw-responses-count le lf">2</span></p></button></div></div></div><div class="ab q js jt ju jv jw jx jy jz ka kb kc kd ke kf kg"><div class="lk k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al ll an ao ap ih lm ln lo" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep lp cn"><div class="l ae"><div class="ab cb"><div class="lq lr ls lt lu lv ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al ll an ao ap ih lw lx lj ly lz ma mb mc s md me mf mg mh mi mj u mk ml mm"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al ll an ao ap ih lw lx lj ly lz ma mb mc s md me mf mg mh mi mj u mk ml mm"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al ll an ao ap ih lw lx lj ly lz ma mb mc s md me mf mg mh mi mj u mk ml mm"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><figure class="mq mr ms mt mu mv mn mo paragraph-image"><div role="button" tabindex="0" class="mw mx ed my bh mz"><div class="mn mo mp"><img src="../Images/85fbf17d8afe2376e51b58139e0a9847.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aNOKrIuEREpnRWn_kEAj9g.jpeg"/></div></div><figcaption class="nb nc nd mn mo ne nf bf b bg z dx">Photo by <a class="af ng" href="https://unsplash.com/@dancristianpaduret?utm_content=creditCopyText&amp;utm_medium=referral&amp;utm_source=unsplash" rel="noopener ugc nofollow" target="_blank">Dan Cristian Pădureț</a> on <a class="af ng" href="https://unsplash.com/photos/blue-and-white-abstract-painting-SMSLyc9FHl0?utm_content=creditCopyText&amp;utm_medium=referral&amp;utm_source=unsplash" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="ac75" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Chances are that you never touched and maybe haven’t even heard about Python’s <code class="cx hd he hf hg b">weakref</code> module. While it might not be commonly used in your code, it's fundamental to the inner workings of many libraries, frameworks and even Python itself. So, in this article we will explore what it is, how it is helpful, and how you could incorporate it into your code as well.</p><h1 id="b55e" class="od oe fq bf of og oh gq oi oj ok gt ol om on oo op oq or os ot ou ov ow ox oy bk">The Basics</h1><p id="4fda" class="pw-post-body-paragraph nh ni fq nj b go oz nl nm gr pa no np nq pb ns nt nu pc nw nx ny pd oa ob oc fj bk">To understand <code class="cx hd he hf hg b">weakref</code> module and <em class="pe">weak references</em>, we first need a little intro to garbage collection in Python.</p><p id="b5b5" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Python uses <em class="pe">reference counting</em> as a mechanism for garbage collection — in simple terms — Python keeps a reference count for each object we create and the reference count is incremented whenever the object is referenced in code; and it’s decremented when an object is de-referenced (e.g. variable set to <code class="cx hd he hf hg b">None</code>). If the reference count ever drop to zero, the memory for the object is deallocated (garbage-collected).</p><p id="0226" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Let’s look at some code to understand it a little more:</p><pre class="mq mr ms mt mu pf hg pg bp ph bb bk"><span id="70b7" class="pi oe fq hg b bg pj pk l pl pm">import sys<br/><br/>class SomeObject:<br/>    def __del__(self):<br/>        print(f"(Deleting {self=})")<br/><br/>obj = SomeObject()<br/><br/>print(sys.getrefcount(obj))  # 2<br/><br/>obj2 = obj<br/>print(sys.getrefcount(obj))  # 3<br/><br/>obj = None<br/>obj2 = None<br/><br/># (Deleting self=&lt;__main__.SomeObject object at 0x7d303fee7e80&gt;)</span></pre><p id="b12e" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Here we define a class that only implements a <code class="cx hd he hf hg b">__del__</code> method, which is called when object is garbage-collected (GC'ed) - we do this so that we can see when the garbage collection happens.</p><p id="c3c0" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">After creating an instance of this class, we use <code class="cx hd he hf hg b">sys.getrefcount</code> to get current number of references to this object. We would expect to get <code class="cx hd he hf hg b">1</code> here, but the count returned by <code class="cx hd he hf hg b">getrefcount</code> is generally one higher than you might expect, that's because when we call <code class="cx hd he hf hg b">getrefcount</code>, the reference is copied by value into the function's argument, temporarily bumping up the object's reference count.</p><p id="1dbc" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Next, if we declare <code class="cx hd he hf hg b">obj2 = obj</code> and call <code class="cx hd he hf hg b">getrefcount</code> again, we get <code class="cx hd he hf hg b">3</code> because it's now referenced by both <code class="cx hd he hf hg b">obj</code> and <code class="cx hd he hf hg b">obj2</code>. Conversely, if we assign <code class="cx hd he hf hg b">None</code> to these variables, the reference count will decrease to zero, and eventually we will get the message from <code class="cx hd he hf hg b">__del__</code> method telling us that the object got garbage-collected.</p><p id="9805" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Well, and how do weak references fit into this? If only remaining references to an object are <em class="pe">weak references</em>, then Python interpreter is free to garbage-collect this object. In other words — a weak reference to an object is not enough to keep the object alive:</p><pre class="mq mr ms mt mu pf hg pg bp ph bb bk"><span id="1d87" class="pi oe fq hg b bg pj pk l pl pm">import weakref<br/><br/>obj = SomeObject()<br/><br/>reference = weakref.ref(obj)<br/><br/>print(reference)  # &lt;weakref at 0x734b0a514590; to 'SomeObject' at 0x734b0a4e7700&gt;<br/>print(reference())  # &lt;__main__.SomeObject object at 0x707038c0b700&gt;<br/>print(obj.__weakref__)  # &lt;weakref at 0x734b0a514590; to 'SomeObject' at 0x734b0a4e7700&gt;<br/><br/>print(sys.getrefcount(obj))  # 2<br/><br/>obj = None<br/><br/># (Deleting self=&lt;__main__.SomeObject object at 0x70744d42b700&gt;)<br/><br/>print(reference)  # &lt;weakref at 0x7988e2d70590; dead&gt;<br/>print(reference())  # None</span></pre><p id="6cbd" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Here we again declare a variable <code class="cx hd he hf hg b">obj</code> of our class, but this time instead of creating second strong reference to this object, we create weak reference in <code class="cx hd he hf hg b">reference</code> variable.</p><p id="8d90" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">If we then check the reference count, we can see that it did not increase, and if we set the <code class="cx hd he hf hg b">obj</code> variable to <code class="cx hd he hf hg b">None</code>, we can see that it immediately gets garbage-collected even though the weak reference still exist.</p><p id="9458" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Finally, if try to access the weak reference to the already garbage-collected object, we get a <em class="pe">“dead”</em> reference and <code class="cx hd he hf hg b">None</code> respectively.</p><p id="bcc5" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Also notice that when we used the weak reference to access the object, we had to call it as a function ( <code class="cx hd he hf hg b">reference()</code>) to retrieve to object. Therefore, it is often more convenient to use a <em class="pe">proxy</em> instead, especially if you need to access object attributes:</p><pre class="mq mr ms mt mu pf hg pg bp ph bb bk"><span id="66a3" class="pi oe fq hg b bg pj pk l pl pm">obj = SomeObject()<br/><br/>reference = weakref.proxy(obj)<br/><br/>print(reference)  # &lt;__main__.SomeObject object at 0x78a420e6b700&gt;<br/><br/>obj.attr = 1<br/>print(reference.attr)  # 1</span></pre><h1 id="0afb" class="od oe fq bf of og oh gq oi oj ok gt ol om on oo op oq or os ot ou ov ow ox oy bk">When To Use It</h1><p id="3e10" class="pw-post-body-paragraph nh ni fq nj b go oz nl nm gr pa no np nq pb ns nt nu pc nw nx ny pd oa ob oc fj bk">Now that we know how weak references work, let’s look at some examples of how they could be useful.</p><p id="f902" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">A common use-case for weak references is tree-like data structures:</p><pre class="mq mr ms mt mu pf hg pg bp ph bb bk"><span id="7d16" class="pi oe fq hg b bg pj pk l pl pm">class Node:<br/>    def __init__(self, value):<br/>        self.value = value<br/>        self._parent = None<br/>        self.children = []<br/><br/>    def __repr__(self):<br/>        return "Node({!r:})".format(self.value)<br/><br/>    @property<br/>    def parent(self):<br/>        return self._parent if self._parent is None else self._parent()<br/><br/>    @parent.setter<br/>    def parent(self, node):<br/>        self._parent = weakref.ref(node)<br/><br/>    def add_child(self, child):<br/>        self.children.append(child)<br/>        child.parent = self<br/><br/>root = Node("parent")<br/>n = Node("child")<br/>root.add_child(n)<br/>print(n.parent)  # Node('parent')<br/><br/>del root<br/>print(n.parent)  # None</span></pre><p id="4360" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Here we implement a tree using a <code class="cx hd he hf hg b">Node</code> class where child nodes have weak reference to their parent. In this relation, the child <code class="cx hd he hf hg b">Node</code> can live without parent <code class="cx hd he hf hg b">Node</code>, which allows parent to be silently removed/garbage-collected.</p><p id="f39c" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Alternatively, we can flip this around:</p><pre class="mq mr ms mt mu pf hg pg bp ph bb bk"><span id="82b1" class="pi oe fq hg b bg pj pk l pl pm">class Node:<br/>    def __init__(self, value):<br/>        self.value = value<br/>        self._children = weakref.WeakValueDictionary()<br/><br/>    @property<br/>    def children(self):<br/>        return list(self._children.items())<br/><br/>    def add_child(self, key, child):<br/>        self._children[key] = child<br/><br/>root = Node("parent")<br/>n1 = Node("child one")<br/>n2 = Node("child two")<br/>root.add_child("n1", n1)<br/>root.add_child("n2", n2)<br/>print(root.children)  # [('n1', Node('child one')), ('n2', Node('child two'))]<br/><br/>del n1<br/>print(root.children)  # [('n2', Node('child two'))]</span></pre><p id="e8ed" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Here instead, the parent keeps a dictionary of weak references to its children. This uses <code class="cx hd he hf hg b">WeakValueDictionary</code> — whenever an element (weak reference) referenced from the dictionary gets dereferenced elsewhere in the program, it automatically gets removed from the dictionary too, so we don't have manage lifecycle of dictionary items.</p><p id="4e1e" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Another use of <code class="cx hd he hf hg b">weakref</code> is in <a class="af ng" href="https://en.wikipedia.org/wiki/Observer_pattern" rel="noopener ugc nofollow" target="_blank"><em class="pe">Observer</em> design pattern</a>:</p><pre class="mq mr ms mt mu pf hg pg bp ph bb bk"><span id="be61" class="pi oe fq hg b bg pj pk l pl pm">class Observable:<br/>    def __init__(self):<br/>        self._observers = weakref.WeakSet()<br/><br/>    def register_observer(self, obs):<br/>        self._observers.add(obs)<br/><br/>    def notify_observers(self, *args, **kwargs):<br/>        for obs in self._observers:<br/>            obs.notify(self, *args, **kwargs)<br/><br/><br/>class Observer:<br/>    def __init__(self, observable):<br/>        observable.register_observer(self)<br/><br/>    def notify(self, observable, *args, **kwargs):<br/>        print("Got", args, kwargs, "From", observable)<br/><br/><br/>subject = Observable()<br/>observer = Observer(subject)<br/>subject.notify_observers("test", kw="python")<br/># Got ('test',) {'kw': 'python'} From &lt;__main__.Observable object at 0x757957b892d0&gt;</span></pre><p id="b880" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">The <code class="cx hd he hf hg b">Observable</code> class keeps weak references to its observers, because it doesn't care if they get removed. As with previous examples, this avoids having to manage the lifecycle of dependant objects. As you probably noticed, in this example we used <code class="cx hd he hf hg b">WeakSet</code> which is another class from <code class="cx hd he hf hg b">weakref</code> module, it behaves just like the <code class="cx hd he hf hg b">WeakValueDictionary</code> but is implemented using <code class="cx hd he hf hg b">Set</code>.</p><p id="da68" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">Final example for this section is borrowed from <code class="cx hd he hf hg b"><a class="af ng" href="https://docs.python.org/3/library/weakref.html#comparing-finalizers-with-del-methods" rel="noopener ugc nofollow" target="_blank">weakref</a></code><a class="af ng" href="https://docs.python.org/3/library/weakref.html#comparing-finalizers-with-del-methods" rel="noopener ugc nofollow" target="_blank"> docs</a>:</p><pre class="mq mr ms mt mu pf hg pg bp ph bb bk"><span id="fb39" class="pi oe fq hg b bg pj pk l pl pm">import tempfile, shutil<br/>from pathlib import Path<br/><br/>class TempDir:<br/>    def __init__(self):<br/>        self.name = tempfile.mkdtemp()<br/>        self._finalizer = weakref.finalize(self, shutil.rmtree, self.name)<br/><br/>    def __repr__(self):<br/>        return "TempDir({!r:})".format(self.name)<br/><br/>    def remove(self):<br/>        self._finalizer()<br/><br/>    @property<br/>    def removed(self):<br/>        return not self._finalizer.alive<br/><br/>tmp = TempDir()<br/>print(tmp)  # TempDir('/tmp/tmp8o0aecl3')<br/>print(tmp.removed)  # False<br/>print(Path(tmp.name).is_dir()) # True</span></pre><p id="c9c0" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">This showcases one more feature of <code class="cx hd he hf hg b">weakref</code> module, which is <code class="cx hd he hf hg b">weakref.finalize</code>. As the name suggest it allows executing a finalizer function/callback when the dependant object is garbage-collected. In this case we implement a <code class="cx hd he hf hg b">TempDir</code> class which can be used to create a temporary directory - in ideal case we would always remember to clean up the <code class="cx hd he hf hg b">TempDir</code> when we don't need it anymore, but if we forget, we have the finalizer that will automatically run <code class="cx hd he hf hg b">rmtree</code> on the directory when the <code class="cx hd he hf hg b">TempDir</code> object is GC'ed, which includes when program exits completely.</p><h1 id="6777" class="od oe fq bf of og oh gq oi oj ok gt ol om on oo op oq or os ot ou ov ow ox oy bk">Real-World Examples</h1><p id="5ece" class="pw-post-body-paragraph nh ni fq nj b go oz nl nm gr pa no np nq pb ns nt nu pc nw nx ny pd oa ob oc fj bk">The previous section has shown couple practical usages for <code class="cx hd he hf hg b">weakref</code>, but let's also take a look at real-world examples—one of them being creating a cached instance:</p><pre class="mq mr ms mt mu pf hg pg bp ph bb bk"><span id="5559" class="pi oe fq hg b bg pj pk l pl pm">import logging<br/>a = logging.getLogger("first")<br/>b = logging.getLogger("second")<br/>print(a is b)  # False<br/><br/>c = logging.getLogger("first")<br/>print(a is c)  # True</span></pre><p id="8cb0" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">The above is basic usage of Python’s builtin <code class="cx hd he hf hg b">logging</code> module - we can see that it allows to only associate a single logger instance with a given name - meaning that when we retrieve same logger multiple times, it always returns the same cached logger instance.</p><p id="4290" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">If we wanted to implement this, it could look something like this:</p><pre class="mq mr ms mt mu pf hg pg bp ph bb bk"><span id="df7f" class="pi oe fq hg b bg pj pk l pl pm">class Logger:<br/>    def __init__(self, name):<br/>        self.name = name<br/><br/>_logger_cache = weakref.WeakValueDictionary()<br/><br/>def get_logger(name):<br/>    if name not in _logger_cache:<br/>        l = Logger(name)<br/>        _logger_cache[name] = l<br/>    else:<br/>        l = _logger_cache[name]<br/>    return l<br/><br/>a = get_logger("first")<br/>b = get_logger("second")<br/>print(a is b)  # False<br/><br/>c = get_logger("first")<br/>print(a is c)  # True</span></pre><p id="07f4" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">And finally, Python itself uses weak references, e.g. in implementation of <code class="cx hd he hf hg b">OrderedDict</code>:</p><pre class="mq mr ms mt mu pf hg pg bp ph bb bk"><span id="67fe" class="pi oe fq hg b bg pj pk l pl pm">from _weakref import proxy as _proxy<br/><br/>class OrderedDict(dict):<br/><br/>    def __new__(cls, /, *args, **kwds):<br/>        self = dict.__new__(cls)<br/>        self.__hardroot = _Link()<br/>        self.__root = root = _proxy(self.__hardroot)<br/>        root.prev = root.next = root<br/>        self.__map = {}<br/>        return self</span></pre><p id="9354" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">The above is snippet from <a class="af ng" href="https://github.com/python/cpython/blob/0c0348adbfca991f78b3aaa6790e5c26606a1c0f/Lib/collections/__init__.py#L103" rel="noopener ugc nofollow" target="_blank">CPython’s </a><code class="cx hd he hf hg b"><a class="af ng" href="https://github.com/python/cpython/blob/0c0348adbfca991f78b3aaa6790e5c26606a1c0f/Lib/collections/__init__.py#L103" rel="noopener ugc nofollow" target="_blank">collections</a></code><a class="af ng" href="https://github.com/python/cpython/blob/0c0348adbfca991f78b3aaa6790e5c26606a1c0f/Lib/collections/__init__.py#L103" rel="noopener ugc nofollow" target="_blank"> module</a>. Here, the <code class="cx hd he hf hg b">weakref.proxy</code> is used to prevent circular references (see the doc-strings for more details).</p><h1 id="ce4b" class="od oe fq bf of og oh gq oi oj ok gt ol om on oo op oq or os ot ou ov ow ox oy bk">Conclusion</h1><p id="7ff9" class="pw-post-body-paragraph nh ni fq nj b go oz nl nm gr pa no np nq pb ns nt nu pc nw nx ny pd oa ob oc fj bk"><code class="cx hd he hf hg b">weakref</code> is fairly obscure, but at times very useful tool that you should keep in your toolbox. It can be very helpful when implementing caches or data structures that have reference loops in them, such as doubly linked lists.</p><p id="fd16" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">With that said, one should be aware of <code class="cx hd he hf hg b">weakref</code> support — everything said here and in the docs is CPython specific and different Python implementations will have different <code class="cx hd he hf hg b">weakref</code> behavior. Also, many of the builtin types don't support weak references, such as <code class="cx hd he hf hg b">list</code>, <code class="cx hd he hf hg b">tuple</code> or <code class="cx hd he hf hg b">int</code>.</p><p id="6637" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk"><em class="pe">This article was originally posted at </em><a class="af ng" href="https://martinheinz.dev/blog/112" rel="noopener ugc nofollow" target="_blank"><em class="pe">martinheinz.dev</em></a></p></div></div></div><div class="ab cb pn po pp pq" role="separator"><span class="pr by bm ps pt pu"/><span class="pr by bm ps pt pu"/><span class="pr by bm ps pt"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="a9b6" class="pw-post-body-paragraph nh ni fq nj b go nk nl nm gr nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc fj bk">You may also like…</p><div class="pv pw px py pz qa"><a rel="noopener follow" target="_blank" href="/everything-you-can-do-with-pythons-textwrap-module-0d82c377a4c8?source=post_page-----d3381b01db99--------------------------------"><div class="qb ab ik"><div class="qc ab co cb qd qe"><h2 class="bf fr ia z is qf iu iv qg ix iz fp bk">Everything You Can Do with Python’s textwrap Module</h2><div class="qh l"><h3 class="bf b ia z is qf iu iv qg ix iz dx">Learn about all the things you can do with Python’s textwrap module, including formatting, text wrapping, trimming and…</h3></div><div class="qi l"><p class="bf b dy z is qf iu iv qg ix iz dx">towardsdatascience.com</p></div></div><div class="qj l"><div class="qk l ql qm qn qj qo lv qa"/></div></div></a></div></div></div></div></div>    
</body>
</html>