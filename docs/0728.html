<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Setting Up Automated Model Training Workflows with AWS S3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Setting Up Automated Model Training Workflows with AWS S3</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/setting-up-automated-model-training-workflows-with-aws-s3-cd0587b42f34?source=collection_archive---------6-----------------------#2024-03-18">https://towardsdatascience.com/setting-up-automated-model-training-workflows-with-aws-s3-cd0587b42f34?source=collection_archive---------6-----------------------#2024-03-18</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="364a" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx">The Open-Source Approach for Workflow Automation</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hd he hf hg hh ab"><div><div class="ab hi"><div><div class="bm" aria-hidden="false"><a href="https://khuyentran1476.medium.com/?source=post_page---byline--cd0587b42f34--------------------------------" rel="noopener follow"><div class="l hj hk by hl hm"><div class="l ed"><img alt="Khuyen Tran" class="l ep by dd de cx" src="../Images/98aa66025ad29b618e875c75f1c400a5.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/2*tiQVZEZxHMPcnVmEmN7UtA.jpeg"/><div class="hn by l dd de em n ho eo"/></div></div></a></div></div><div class="hp ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--cd0587b42f34--------------------------------" rel="noopener follow"><div class="l hq hr by hl hs"><div class="l ed"><img alt="Towards Data Science" class="l ep by br ht cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hn by l br ht em n ho eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hu ab q"><div class="ab q hv"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hw hx bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hy" data-testid="authorName" href="https://khuyentran1476.medium.com/?source=post_page---byline--cd0587b42f34--------------------------------" rel="noopener follow">Khuyen Tran</a></p></div></div></div><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hw hx dx"><button class="ib ic ah ai aj ak al am an ao ap aq ar id ie if" disabled="">Follow</button></p></div></div></span></div></div><div class="l ig"><span class="bf b bg z dx"><div class="ab cn ih ii ij"><div class="ik il ab"><div class="bf b bg z dx ab im"><span class="in l ig">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hy ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--cd0587b42f34--------------------------------" rel="noopener follow"><p class="bf b bg z io ip iq ir is it iu iv bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">7 min read</span><div class="iw ix l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Mar 18, 2024</span></div></span></div></span></div></div></div><div class="ab cp iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn"><div class="h k w ea eb q"><div class="kd l"><div class="ab q ke kf"><div class="pw-multi-vote-icon ed in kg kh ki"><div class=""><div class="kj kk kl km kn ko kp am kq kr ks ki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kt ku kv kw kx ky kz"><p class="bf b dy z dx"><span class="kk">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kj lc ld ab q ee le lf" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="lb"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg><p class="bf b dy z dx"><span class="pw-responses-count la lb">2</span></p></button></div></div></div><div class="ab q jo jp jq jr js jt ju jv jw jx jy jz ka kb kc"><div class="lg k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lh an ao ap id li lj lk" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep ll cn"><div class="l ae"><div class="ab cb"><div class="lm ln lo lp lq lr ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><h1 id="d199" class="mj mk fq bf ml mm mn gq mo mp mq gt mr ms mt mu mv mw mx my mz na nb nc nd ne bk">Motivation</h1><p id="1e28" class="pw-post-body-paragraph nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fj bk">Consider you’re an e-commerce platform aiming to enhance recommendation personalization. Your data resides in S3.</p><p id="4b2d" class="pw-post-body-paragraph nf ng fq nh b go ob nj nk gr oc nm nn no od nq nr ns oe nu nv nw of ny nz oa fj bk">To refine recommendations, you plan to retrain recommendation models using fresh customer interaction data whenever a new file is added to S3. But how exactly do you approach this task?</p><figure class="oj ok ol om on oo og oh paragraph-image"><div role="button" tabindex="0" class="op oq ed or bh os"><div class="og oh oi"><img src="../Images/19c91eea848de1654a1def0fce56e5a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PP893a75a_4cKHoh4HCS-A.gif"/></div></div><figcaption class="ou ov ow og oh ox oy bf b bg z dx">Unless otherwise noted, all images are by the author</figcaption></figure><h1 id="5203" class="mj mk fq bf ml mm mn gq mo mp mq gt mr ms mt mu mv mw mx my mz na nb nc nd ne bk">Solutions</h1><p id="3864" class="pw-post-body-paragraph nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fj bk">Two common solutions to this problem are:</p><ol class=""><li id="9dbd" class="nf ng fq nh b go ob nj nk gr oc nm nn no od nq nr ns oe nu nv nw of ny nz oa oz pa pb bk"><strong class="nh fr">AWS Lambda:</strong> A serverless compute service by AWS, allowing code execution in response to events without managing servers.</li><li id="6552" class="nf ng fq nh b go pc nj nk gr pd nm nn no pe nq nr ns pf nu nv nw pg ny nz oa oz pa pb bk"><strong class="nh fr">Open-source orchestrators:</strong> Tools automating, scheduling, and monitoring workflows and tasks, usually self-hosted.</li></ol><p id="db99" class="pw-post-body-paragraph nf ng fq nh b go ob nj nk gr oc nm nn no od nq nr ns oe nu nv nw of ny nz oa fj bk">Using an open-source orchestrator offers advantages over AWS Lambda:</p><ul class=""><li id="1e6f" class="nf ng fq nh b go ob nj nk gr oc nm nn no od nq nr ns oe nu nv nw of ny nz oa ph pa pb bk"><strong class="nh fr">Cost-Effectiveness:</strong> Running long tasks on AWS Lambda can be costly. Open-source orchestrators let you use your infrastructure, potentially saving costs.</li><li id="7dcb" class="nf ng fq nh b go pc nj nk gr pd nm nn no pe nq nr ns pf nu nv nw pg ny nz oa ph pa pb bk"><strong class="nh fr">Faster Iteration:</strong> Developing and testing workflows locally speeds up the process, making it easier to debug and refine.</li><li id="5853" class="nf ng fq nh b go pc nj nk gr pd nm nn no pe nq nr ns pf nu nv nw pg ny nz oa ph pa pb bk"><strong class="nh fr">Environment Control:</strong> Full control over the execution environment allows you to customize your development tools and IDEs to match your preferences.</li></ul><figure class="oj ok ol om on oo og oh paragraph-image"><div role="button" tabindex="0" class="op oq ed or bh os"><div class="og oh pi"><img src="../Images/aa329b6f70ec6933a5f407cb563a3fd2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NoBAzj1rU2qXjc7QHbno2Q.png"/></div></div></figure><p id="8356" class="pw-post-body-paragraph nf ng fq nh b go ob nj nk gr oc nm nn no od nq nr ns oe nu nv nw of ny nz oa fj bk">While you could solve this problem in Apache Airflow, it would require complex infrastructure and deployment setup. Thus, we’ll use <a class="af pj" href="https://bit.ly/49OMyH9" rel="noopener ugc nofollow" target="_blank">Kestra</a>, which offers an intuitive UI and can be launched in a single Docker command.</p><p id="6181" class="pw-post-body-paragraph nf ng fq nh b go ob nj nk gr oc nm nn no od nq nr ns oe nu nv nw of ny nz oa fj bk">Feel free to play and fork the source code of this article here:</p><div class="pk pl pm pn po pp"><a href="https://github.com/khuyentran1401/mlops-kestra-workflow?source=post_page-----cd0587b42f34--------------------------------" rel="noopener  ugc nofollow" target="_blank"><div class="pq ab ig"><div class="pr ab co cb ps pt"><h2 class="bf fr hw z io pu iq ir pv it iv fp bk">GitHub - khuyentran1401/mlops-kestra-workflow</h2><div class="pw l"><h3 class="bf b hw z io pu iq ir pv it iv dx">Contribute to khuyentran1401/mlops-kestra-workflow development by creating an account on GitHub.</h3></div><div class="px l"><p class="bf b dy z io pu iq ir pv it iv dx">github.com</p></div></div><div class="py l"><div class="pz l qa qb qc py qd lr pp"/></div></div></a></div><h1 id="581e" class="mj mk fq bf ml mm mn gq mo mp mq gt mr ms mt mu mv mw mx my mz na nb nc nd ne bk">Workflow Summary</h1><p id="82bf" class="pw-post-body-paragraph nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fj bk">This workflow consists of two main components: Python scripts and orchestration.</p><h2 id="e800" class="qe mk fq bf ml qf qg qh mo qi qj qk mr no ql qm qn ns qo qp qq nw qr qs qt qu bk"><strong class="al">Orchestration</strong></h2><ul class=""><li id="58fe" class="nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa ph pa pb bk">Python scripts and flows are stored in Git, with changes synced to Kestra on a schedule.</li></ul><figure class="oj ok ol om on oo og oh paragraph-image"><div role="button" tabindex="0" class="op oq ed or bh os"><div class="og oh oi"><img src="../Images/ff05c4168232f7a136a385271928fd4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UnNEwgSlDoE5F4LgH1twZg.gif"/></div></div></figure><ul class=""><li id="0643" class="nf ng fq nh b go ob nj nk gr oc nm nn no od nq nr ns oe nu nv nw of ny nz oa ph pa pb bk">When a new file appears in the “new” prefix of the S3 bucket, Kestra triggers an execution of a series of Python scripts.</li></ul><figure class="oj ok ol om on oo og oh paragraph-image"><div role="button" tabindex="0" class="op oq ed or bh os"><div class="og oh oi"><img src="../Images/19c91eea848de1654a1def0fce56e5a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PP893a75a_4cKHoh4HCS-A.gif"/></div></div></figure><h2 id="7eda" class="qe mk fq bf ml qf qg qh mo qi qj qk mr no ql qm qn ns qo qp qq nw qr qs qt qu bk">Python Scripts</h2><ul class=""><li id="cae3" class="nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa ph pa pb bk"><a class="af pj" href="https://github.com/khuyentran1401/mlops-kestra-workflow/blob/main/src/download_files_from_s3.py" rel="noopener ugc nofollow" target="_blank"><em class="qv">download_files_from_s3.py</em></a>: Download all files from the “old” prefix in the bucket.</li><li id="98a8" class="nf ng fq nh b go pc nj nk gr pd nm nn no pe nq nr ns pf nu nv nw pg ny nz oa ph pa pb bk"><a class="af pj" href="https://github.com/khuyentran1401/mlops-kestra-workflow/blob/main/src/merge_data.py" rel="noopener ugc nofollow" target="_blank"><em class="qv">merge_data.py</em></a>: Merge the downloaded files.</li><li id="adec" class="nf ng fq nh b go pc nj nk gr pd nm nn no pe nq nr ns pf nu nv nw pg ny nz oa ph pa pb bk"><a class="af pj" href="https://github.com/khuyentran1401/mlops-kestra-workflow/blob/main/src/process.py" rel="noopener ugc nofollow" target="_blank"><em class="qv">process.py</em></a>: Process the merged data.</li><li id="8728" class="nf ng fq nh b go pc nj nk gr pd nm nn no pe nq nr ns pf nu nv nw pg ny nz oa ph pa pb bk"><a class="af pj" href="https://github.com/khuyentran1401/mlops-kestra-workflow/blob/main/src/train.py" rel="noopener ugc nofollow" target="_blank"><em class="qv">train.py</em></a><em class="qv">:</em> Train the model using the processed data.</li></ul><figure class="oj ok ol om on oo og oh paragraph-image"><div class="og oh qw"><img src="../Images/f230c2f02a707f09663735925e93bbdd.png" data-original-src="https://miro.medium.com/v2/resize:fit:874/format:webp/1*9-k4_Y7QG_m8Qs_piH5Guw.gif"/></div></figure><p id="ef7e" class="pw-post-body-paragraph nf ng fq nh b go ob nj nk gr oc nm nn no od nq nr ns oe nu nv nw of ny nz oa fj bk">As we will execute the code downloaded from Git within Kestra, make sure to commit these Python scripts to the repository.</p><pre class="oj ok ol om on qx qy qz bp ra bb bk"><span id="c80b" class="rb mk fq qy b bg rc rd l re rf">git add .<br/>git commit -m 'add python scripts'<br/>git push origin main</span></pre><h1 id="399a" class="mj mk fq bf ml mm mn gq mo mp mq gt mr ms mt mu mv mw mx my mz na nb nc nd ne bk">Orchestration</h1><h2 id="791c" class="qe mk fq bf ml qf qg qh mo qi qj qk mr no ql qm qn ns qo qp qq nw qr qs qt qu bk">Start Kestra</h2><p id="cae1" class="pw-post-body-paragraph nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fj bk">Download the Docker Compose file by executing the following command:</p><pre class="oj ok ol om on qx qy qz bp ra bb bk"><span id="cf9d" class="rb mk fq qy b bg rc rd l re rf">curl -o docker-compose.yml \<br/>https://raw.githubusercontent.com/kestra-io/kestra/develop/docker-compose.yml</span></pre><p id="f4ff" class="pw-post-body-paragraph nf ng fq nh b go ob nj nk gr oc nm nn no od nq nr ns oe nu nv nw of ny nz oa fj bk">Ensure that Docker is running. Then, start the Kestra server with the following command:</p><pre class="oj ok ol om on qx qy qz bp ra bb bk"><span id="1fff" class="rb mk fq qy b bg rc rd l re rf">docker-compose up -d</span></pre><p id="68bd" class="pw-post-body-paragraph nf ng fq nh b go ob nj nk gr oc nm nn no od nq nr ns oe nu nv nw of ny nz oa fj bk">Access the UI by opening the URL <a class="af pj" href="http://localhost:8080/" rel="noopener ugc nofollow" target="_blank">http://localhost:8080</a> in your browser.</p></div></div><div class="oo"><div class="ab cb"><div class="lm rg ln rh lo ri cf rj cg rk ci bh"><figure class="oj ok ol om on oo rm rn paragraph-image"><div role="button" tabindex="0" class="op oq ed or bh os"><div class="og oh rl"><img src="../Images/5b33ef5eb4c0a7f3801fb1ba4f5fa7e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*mP8eFwK4sV3UcKwoKoG5xg.png"/></div></div></figure></div></div></div><div class="ab cb"><div class="ci bh ev ew ex ey"><h2 id="bab9" class="qe mk fq bf ml qf qg qh mo qi qj qk mr no ql qm qn ns qo qp qq nw qr qs qt qu bk">Sync from Git</h2><p id="3d64" class="pw-post-body-paragraph nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fj bk">Since the Python scripts are in GitHub, we will use <a class="af pj" href="https://kestra.io/plugins/plugin-git/tasks/io.kestra.plugin.git.sync" rel="noopener ugc nofollow" target="_blank">Git Sync</a> to update the code from GitHub to Kestra every minute. To set this up, create a file named “sync_from_git.yml” under the “_flows” directory.</p><pre class="oj ok ol om on qx qy qz bp ra bb bk"><span id="9a93" class="rb mk fq qy b bg rc rd l re rf">.<br/>├── _flows/<br/>│   └── sync_from_git.yml<br/>└── src/<br/>    ├── download_files_from_s3.py<br/>    ├── helpers.py<br/>    ├── merge_data.py<br/>    ├── process.py<br/>    └── train.py</span></pre><p id="9fa9" class="pw-post-body-paragraph nf ng fq nh b go ob nj nk gr oc nm nn no od nq nr ns oe nu nv nw of ny nz oa fj bk">If you are using VSCode, you can use the <a class="af pj" href="https://marketplace.visualstudio.com/items?itemName=kestra-io.kestra" rel="noopener ugc nofollow" target="_blank">Kestra plugin</a> to enable flow autocompletion and validation in <code class="cx ro rp rq qy b">.yaml</code> files.</p><figure class="oj ok ol om on oo og oh paragraph-image"><div role="button" tabindex="0" class="op oq ed or bh os"><div class="og oh rr"><img src="../Images/5d963b494550c1f0572c20a04a2f7675.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lNIQ1a2VpDtCwmN3Czojyg.png"/></div></div></figure></div></div><div class="oo"><div class="ab cb"><div class="lm rg ln rh lo ri cf rj cg rk ci bh"><figure class="oj ok ol om on oo rm rn paragraph-image"><div role="button" tabindex="0" class="op oq ed or bh os"><div class="og oh rs"><img src="../Images/0d1942b43ca808d76b4744901d3bb420.png" data-original-src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*cbhHUpkTZtKGW1yXUpT4Tw.png"/></div></div></figure></div></div></div><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="066f" class="pw-post-body-paragraph nf ng fq nh b go ob nj nk gr oc nm nn no od nq nr ns oe nu nv nw of ny nz oa fj bk">Below is the implementation of the flow to synchronize code from Git:</p><pre class="oj ok ol om on qx qy qz bp ra bb bk"><span id="ad1e" class="rb mk fq qy b bg rc rd l re rf">id: sync_from_git<br/>namespace: dev<br/><br/>tasks:<br/>  - id: git<br/>    type: io.kestra.plugin.git.Sync<br/>    url: https://github.com/khuyentran1401/mlops-kestra-workflow<br/>    branch: main<br/>    username: "{{secret('GITHUB_USERNAME')}}"<br/>    password: "{{secret('GITHUB_PASSWORD')}}"<br/>    dryRun: false  # if true, you'll see what files will be added, modified<br/>    # or deleted based on the Git version without overwriting the files yet<br/><br/>triggers:<br/>  - id: schedule<br/>    type: io.kestra.core.models.triggers.types.Schedule<br/>    cron: "*/1 * * * *" # every minute</span></pre><p id="a49a" class="pw-post-body-paragraph nf ng fq nh b go ob nj nk gr oc nm nn no od nq nr ns oe nu nv nw of ny nz oa fj bk">A username and password are necessary only if the GitHub repository is private. To pass these secrets to Kestra, place them in the “.env” file:</p><pre class="oj ok ol om on qx qy qz bp ra bb bk"><span id="022f" class="rb mk fq qy b bg rc rd l re rf"># .env<br/>GITHUB_USERNAME=mygithubusername<br/>GITHUB_PASSWORD=mygithubtoken<br/>AWS_ACCESS_KEY_ID=myawsaccesskey<br/>AWS_SECRET_ACCESS_KEY=myawssecretaccesskey<br/># ! This line should be empty</span></pre><p id="7853" class="pw-post-body-paragraph nf ng fq nh b go ob nj nk gr oc nm nn no od nq nr ns oe nu nv nw of ny nz oa fj bk">Next, encode these secrets using the following bash script:</p><pre class="oj ok ol om on qx qy qz bp ra bb bk"><span id="d7d1" class="rb mk fq qy b bg rc rd l re rf">while IFS='=' read -r key value; do<br/>    echo "SECRET_$key=$(echo -n "$value" | base64)";<br/>done &lt; .env &gt; .env_encoded</span></pre><p id="fc9f" class="pw-post-body-paragraph nf ng fq nh b go ob nj nk gr oc nm nn no od nq nr ns oe nu nv nw of ny nz oa fj bk">Executing this script generates a “.env_encoded” file containing encoded secrets:</p><pre class="oj ok ol om on qx qy qz bp ra bb bk"><span id="c9a6" class="rb mk fq qy b bg rc rd l re rf"># .env_encoded<br/>SECRET_GITHUB_USERNAME=bXlnaXRodWJ1c2VybmFtZQ==<br/>SECRET_GITHUB_PASSWORD=bXlnaXRodWJ0b2tlbg==<br/>SECRET_AWS_ACCESS_KEY_ID=bXlhd3NhY2Nlc3NrZXk=<br/>SECRET_AWS_SECRET_ACCESS_KEY=bXlhd3NzZWNyZXRhY2Nlc3NrZXk=</span></pre><p id="9eda" class="pw-post-body-paragraph nf ng fq nh b go ob nj nk gr oc nm nn no od nq nr ns oe nu nv nw of ny nz oa fj bk">Include the encoded environment file in your Docker Compose file for Kestra to access the environment variables:</p><pre class="oj ok ol om on qx qy qz bp ra bb bk"><span id="f419" class="rb mk fq qy b bg rc rd l re rf"># docker-compose.yml<br/>  kestra:<br/>    image: kestra/kestra:latest-full<br/>    env_file:<br/>      - .env_encoded</span></pre><p id="acde" class="pw-post-body-paragraph nf ng fq nh b go ob nj nk gr oc nm nn no od nq nr ns oe nu nv nw of ny nz oa fj bk">Ensure to exclude the environment files in the “.gitignore” file:</p><pre class="oj ok ol om on qx qy qz bp ra bb bk"><span id="221b" class="rb mk fq qy b bg rc rd l re rf"># .gitignore<br/>.env<br/>.env_encoded</span></pre><p id="ec95" class="pw-post-body-paragraph nf ng fq nh b go ob nj nk gr oc nm nn no od nq nr ns oe nu nv nw of ny nz oa fj bk">Lastly, commit both the new flow and the Docker Compose file to Git:</p><pre class="oj ok ol om on qx qy qz bp ra bb bk"><span id="12b4" class="rb mk fq qy b bg rc rd l re rf">git add _flows/sync_from_git.yml docker-compose.yml<br/>git commit -m 'add Git Sync'<br/>git push origin main</span></pre><p id="e816" class="pw-post-body-paragraph nf ng fq nh b go ob nj nk gr oc nm nn no od nq nr ns oe nu nv nw of ny nz oa fj bk">Now, with the <code class="cx ro rp rq qy b">sync_from_git</code> flow set to run every minute, you can conveniently access and trigger the execution of Python scripts directly from the Kestra UI.</p></div></div><div class="oo"><div class="ab cb"><div class="lm rg ln rh lo ri cf rj cg rk ci bh"><figure class="oj ok ol om on oo rm rn paragraph-image"><div role="button" tabindex="0" class="op oq ed or bh os"><div class="og oh rt"><img src="../Images/720f5af3075edd1455253930ff0f021c.png" data-original-src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*iu5B9FNRCclFb7tPerivdg.png"/></div></div></figure><figure class="lb oo rm rn paragraph-image"><div role="button" tabindex="0" class="op oq ed or bh os"><div class="og oh ru"><img src="../Images/84846040a61cc99923ac42d464e5516c.png" data-original-src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*4NZiDph9MuuTmgh8cCHGlg.png"/></div></div></figure></div></div></div><div class="ab cb"><div class="ci bh ev ew ex ey"><h2 id="1fe9" class="qe mk fq bf ml qf qg qh mo qi qj qk mr no ql qm qn ns qo qp qq nw qr qs qt qu bk">Orchestration</h2><p id="628a" class="pw-post-body-paragraph nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fj bk">We’ll create a flow triggered when a new file is added to the “new” prefix within the “winequality-red” bucket.</p><p id="1d23" class="pw-post-body-paragraph nf ng fq nh b go ob nj nk gr oc nm nn no od nq nr ns oe nu nv nw of ny nz oa fj bk">Upon detecting a new file, Kestra will download it to internal storage and execute the Python files. Finally, it moves the file from the “new” prefix to the “old” prefix in the bucket to avoid duplicate detection during subsequent polls.</p><figure class="oj ok ol om on oo og oh paragraph-image"><div role="button" tabindex="0" class="op oq ed or bh os"><div class="og oh rv"><img src="../Images/7108977a1b3c4ca3def8ec2ac3f9c195.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SfYVmw5cdBiZTzdL3XygpA.gif"/></div></div></figure><pre class="oj ok ol om on qx qy qz bp ra bb bk"><span id="5dfb" class="rb mk fq qy b bg rc rd l re rf">id: run_ml_pipeline<br/>namespace: dev<br/>tasks:<br/>  - id: run_python_commands<br/>    type: io.kestra.plugin.scripts.python.Commands<br/>    namespaceFiles:<br/>      enabled: true<br/>    env:<br/>      AWS_ACCESS_KEY_ID: "{{secret('AWS_ACCESS_KEY_ID')}}"<br/>      AWS_SECRET_ACCESS_KEY: "{{secret('AWS_SECRET_ACCESS_KEY')}}"<br/>    docker:<br/>      image: ghcr.io/kestra-io/pydata:latest<br/>    beforeCommands:<br/>      - pip install -r requirements.txt<br/>    commands:<br/>      - python src/download_files_from_s3.py<br/>      - python src/merge_data.py<br/>      - python src/process.py<br/>      - python src/train.py<br/>    outputFiles:<br/>      - "*.pkl"<br/>triggers:<br/>  - id: watch<br/>    type: io.kestra.plugin.aws.s3.Trigger<br/>    interval: PT1S<br/>    accessKeyId: "{{secret('AWS_ACCESS_KEY_ID')}}"<br/>    secretKeyId: "{{secret('AWS_SECRET_ACCESS_KEY')}}"<br/>    region: us-east-2<br/>    bucket: winequality-red<br/>    prefix: new<br/>    action: MOVE<br/>    moveTo:<br/>      bucket: winequality-red<br/>      key: old</span></pre><p id="ff78" class="pw-post-body-paragraph nf ng fq nh b go ob nj nk gr oc nm nn no od nq nr ns oe nu nv nw of ny nz oa fj bk">The <code class="cx ro rp rq qy b">run_python_commands</code> task uses:</p><ul class=""><li id="c1b8" class="nf ng fq nh b go ob nj nk gr oc nm nn no od nq nr ns oe nu nv nw of ny nz oa ph pa pb bk"><code class="cx ro rp rq qy b">namespaceFiles</code> to access all files in your local project, synchronized with your Git repository.</li><li id="e2cb" class="nf ng fq nh b go pc nj nk gr pd nm nn no pe nq nr ns pf nu nv nw pg ny nz oa ph pa pb bk"><code class="cx ro rp rq qy b">env</code> to retrieve environment variables.</li><li id="312b" class="nf ng fq nh b go pc nj nk gr pd nm nn no pe nq nr ns pf nu nv nw pg ny nz oa ph pa pb bk"><code class="cx ro rp rq qy b">docker</code> to execute the script within the docker container <code class="cx ro rp rq qy b">ghcr.io/kestra-io/pydata:latest</code>.</li><li id="5114" class="nf ng fq nh b go pc nj nk gr pd nm nn no pe nq nr ns pf nu nv nw pg ny nz oa ph pa pb bk"><code class="cx ro rp rq qy b">beforeCommands</code> to install requirements from the “requirements.txt” file prior to executing commands.</li><li id="a484" class="nf ng fq nh b go pc nj nk gr pd nm nn no pe nq nr ns pf nu nv nw pg ny nz oa ph pa pb bk"><code class="cx ro rp rq qy b">commands</code> to sequentially run a list of commands.</li><li id="304b" class="nf ng fq nh b go pc nj nk gr pd nm nn no pe nq nr ns pf nu nv nw pg ny nz oa ph pa pb bk"><code class="cx ro rp rq qy b">outputFiles</code> to send all pickle files from local file system to Kestra’s internal storage.</li></ul><p id="0b07" class="pw-post-body-paragraph nf ng fq nh b go ob nj nk gr oc nm nn no od nq nr ns oe nu nv nw of ny nz oa fj bk">Finally, add the <code class="cx ro rp rq qy b">upload</code> task to upload the model’s pickle file to S3.</p><figure class="oj ok ol om on oo og oh paragraph-image"><div class="og oh rw"><img src="../Images/0bf0fad92d75de999eb59d2fefd93602.png" data-original-src="https://miro.medium.com/v2/resize:fit:1034/format:webp/1*8sXGU0hHhUV_qMGfupCu2g.gif"/></div></figure><pre class="oj ok ol om on qx qy qz bp ra bb bk"><span id="73b3" class="rb mk fq qy b bg rc rd l re rf">id: run_ml_pipeline<br/>namespace: dev<br/>tasks:<br/>  - id: run_python_commands<br/>    type: io.kestra.plugin.scripts.python.Commands<br/>    namespaceFiles:<br/>      enabled: true<br/>    env:<br/>      AWS_ACCESS_KEY_ID: "{{secret('AWS_ACCESS_KEY_ID')}}"<br/>      AWS_SECRET_ACCESS_KEY: "{{secret('AWS_SECRET_ACCESS_KEY')}}"<br/>    docker:<br/>      image: ghcr.io/kestra-io/pydata:latest<br/>    beforeCommands:<br/>      - pip install -r requirements.txt<br/>    commands:<br/>      - python src/download_files_from_s3.py<br/>      - python src/merge_data.py<br/>      - python src/process.py<br/>      - python src/train.py model_path=model/model.pkl<br/>    outputFiles:            <br/>      - "*.pkl"    <br/>  # ------------------------- ADD THIS ------------------------- #<br/>  - id: upload              <br/>    type: io.kestra.plugin.aws.s3.Upload<br/>    accessKeyId: "{{secret('AWS_ACCESS_KEY_ID')}}"<br/>    secretKeyId: "{{secret('AWS_SECRET_ACCESS_KEY')}}"<br/>    region: us-east-2<br/>    from: '{{outputs.run_python_commands.outputFiles["model/model.pkl"]}}'<br/>    bucket: winequality-red<br/>    key: model.pkl<br/>  # ------------------------------------------------------------ #<br/>triggers:<br/>  ...</span></pre><p id="3f90" class="pw-post-body-paragraph nf ng fq nh b go ob nj nk gr oc nm nn no od nq nr ns oe nu nv nw of ny nz oa fj bk">That’s it! Name this flow “run_ml_pipeline.yml” and commit it to Git.</p><pre class="oj ok ol om on qx qy qz bp ra bb bk"><span id="1b6d" class="rb mk fq qy b bg rc rd l re rf">git add run_ml_pipeline.yml<br/>git commit -m 'add run_ml_pipeline'<br/>git push origin main</span></pre><h2 id="f34a" class="qe mk fq bf ml qf qg qh mo qi qj qk mr no ql qm qn ns qo qp qq nw qr qs qt qu bk">Trigger the Flow</h2><p id="61fc" class="pw-post-body-paragraph nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fj bk">To initiate the flow, simply add a new file to the “new” prefix within the “winequality-red” bucket on S3.</p></div></div><div class="oo"><div class="ab cb"><div class="lm rg ln rh lo ri cf rj cg rk ci bh"><figure class="oj ok ol om on oo rm rn paragraph-image"><div role="button" tabindex="0" class="op oq ed or bh os"><div class="og oh rx"><img src="../Images/1c3cf593aa7d5ea84478abcf8c5e57a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*qEnrQM9cTw1nIFTANQXf5g.png"/></div></div></figure></div></div></div><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="fe4d" class="pw-post-body-paragraph nf ng fq nh b go ob nj nk gr oc nm nn no od nq nr ns oe nu nv nw of ny nz oa fj bk">This action will trigger the <code class="cx ro rp rq qy b">run_ml_pipeline</code> flow, initiating the download of data from the “old” prefix, merging all files, processing the data, and training the model.</p></div></div><div class="oo"><div class="ab cb"><div class="lm rg ln rh lo ri cf rj cg rk ci bh"><figure class="oj ok ol om on oo rm rn paragraph-image"><div role="button" tabindex="0" class="op oq ed or bh os"><div class="og oh ry"><img src="../Images/6e9a0b6ab67bc14bc15e7eca149714ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*k2BkVBSoSBo9_bRAcdqJWQ.png"/></div></div></figure><figure class="lb oo rm rn paragraph-image"><div role="button" tabindex="0" class="op oq ed or bh os"><div class="og oh rz"><img src="../Images/d3cfe0e9fa37c79f185715567c6f35f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*Vs86AI_Ct69ZI-yFZthj_Q.png"/></div></div></figure></div></div></div><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="2fef" class="pw-post-body-paragraph nf ng fq nh b go ob nj nk gr oc nm nn no od nq nr ns oe nu nv nw of ny nz oa fj bk">Once the workflow completes execution, the “model.pkl” file is uploaded to S3.</p><figure class="oj ok ol om on oo og oh paragraph-image"><div role="button" tabindex="0" class="op oq ed or bh os"><div class="og oh sa"><img src="../Images/5c20d3d5356ee53bdf05e9993a5e8938.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TSGu-dh_x3FISLJoAcCjcg.png"/></div></div></figure><h1 id="7fab" class="mj mk fq bf ml mm mn gq mo mp mq gt mr ms mt mu mv mw mx my mz na nb nc nd ne bk">Conclusion</h1><p id="a548" class="pw-post-body-paragraph nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fj bk">This article shows how to use Kestra to automate the execution of Python scripts for data science tasks whenever a new file is added to S3. If you are looking for ways to automate your machine learning pipeline, give this solution a try.</p><figure class="oj ok ol om on oo og oh paragraph-image"><div class="og oh sb"><img src="../Images/374d772107eebbec9b782240512405e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1272/format:webp/1*yoKhToxMBGapegtI8wSpVQ.gif"/></div></figure></div></div></div><div class="ab cb sc sd se sf" role="separator"><span class="sg by bm sh si sj"/><span class="sg by bm sh si sj"/><span class="sg by bm sh si"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="27a3" class="pw-post-body-paragraph nf ng fq nh b go ob nj nk gr oc nm nn no od nq nr ns oe nu nv nw of ny nz oa fj bk">I love writing about data science concepts and playing with different data science tools. You can stay up-to-date with my latest posts by:</p><ul class=""><li id="2911" class="nf ng fq nh b go ob nj nk gr oc nm nn no od nq nr ns oe nu nv nw of ny nz oa ph pa pb bk">Subscribing to my newsletter on <a class="af pj" href="https://mathdatasimplified.com/" rel="noopener ugc nofollow" target="_blank">Data Science Simplified</a>.</li><li id="b819" class="nf ng fq nh b go pc nj nk gr pd nm nn no pe nq nr ns pf nu nv nw pg ny nz oa ph pa pb bk">Connect with me on <a class="af pj" href="https://www.linkedin.com/in/khuyen-tran-1401/" rel="noopener ugc nofollow" target="_blank">LinkedIn</a> and <a class="af pj" href="https://twitter.com/KhuyenTran16" rel="noopener ugc nofollow" target="_blank">Twitter</a>.</li></ul></div></div></div></div>    
</body>
</html>