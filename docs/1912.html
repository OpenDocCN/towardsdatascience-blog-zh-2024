<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Visualising Strava Race Analysis</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Visualising Strava Race Analysis</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/visualising-strava-race-analysis-bdabe0b67c02?source=collection_archive---------6-----------------------#2024-08-06">https://towardsdatascience.com/visualising-strava-race-analysis-bdabe0b67c02?source=collection_archive---------6-----------------------#2024-08-06</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="1031" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx"><em class="hd">Two New Graphs That Compare Runners on the Same Event</em></h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="he hf hg hh hi ab"><div><div class="ab hj"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@juanhernanz?source=post_page---byline--bdabe0b67c02--------------------------------" rel="noopener follow"><div class="l hk hl by hm hn"><div class="l ed"><img alt="Juan Hernanz" class="l ep by dd de cx" src="../Images/005f79506da011de2d13c8360bd9fd62.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/da:true/resize:fill:88:88/0*bLHDkjWrfr6nd12A"/><div class="ho by l dd de em n hp eo"/></div></div></a></div></div><div class="hq ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--bdabe0b67c02--------------------------------" rel="noopener follow"><div class="l hr hs by hm ht"><div class="l ed"><img alt="Towards Data Science" class="l ep by br hu cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="ho by l br hu em n hp eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hv ab q"><div class="ab q hw"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hx hy bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hz" data-testid="authorName" href="https://medium.com/@juanhernanz?source=post_page---byline--bdabe0b67c02--------------------------------" rel="noopener follow">Juan Hernanz</a></p></div></div></div><span class="ia ib" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hx hy dx"><button class="ic id ah ai aj ak al am an ao ap aq ar ie if ig" disabled="">Follow</button></p></div></div></span></div></div><div class="l ih"><span class="bf b bg z dx"><div class="ab cn ii ij ik"><div class="il im ab"><div class="bf b bg z dx ab in"><span class="io l ih">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hz ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--bdabe0b67c02--------------------------------" rel="noopener follow"><p class="bf b bg z ip iq ir is it iu iv iw bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="ia ib" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">15 min read</span><div class="ix iy l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Aug 6, 2024</span></div></span></div></span></div></div></div><div class="ab cp iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo"><div class="h k w ea eb q"><div class="ke l"><div class="ab q kf kg"><div class="pw-multi-vote-icon ed io kh ki kj"><div class=""><div class="kk kl km kn ko kp kq am kr ks kt kj"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l ku kv kw kx ky kz la"><p class="bf b dy z dx"><span class="kl">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kk ld le ab q ee lf lg" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="lc"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg><p class="bf b dy z dx"><span class="pw-responses-count lb lc">4</span></p></button></div></div></div><div class="ab q jp jq jr js jt ju jv jw jx jy jz ka kb kc kd"><div class="lh k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al li an ao ap ie lj lk ll" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep lm cn"><div class="l ae"><div class="ab cb"><div class="ln lo lp lq lr ls ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al li an ao ap ie lt lu lg lv lw lx ly lz s ma mb mc md me mf mg u mh mi mj"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al li an ao ap ie lt lu lg lv lw lx ly lz s ma mb mc md me mf mg u mh mi mj"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al li an ao ap ie lt lu lg lv lw lx ly lz s ma mb mc md me mf mg u mh mi mj"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><figure class="mn mo mp mq mr ms mk ml paragraph-image"><div role="button" tabindex="0" class="mt mu ed mv bh mw"><div class="mk ml mm"><img src="../Images/0d0bbb903e8e9787b96827f334f29276.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xwpmZEoTc3ysMQVdK7SFFw.jpeg"/></div></div><figcaption class="my mz na mk ml nb nc bf b bg z dx">Graph showing the comparative performance of runners. Image by Author.</figcaption></figure><p id="efae" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk"><em class="nz">Have you ever wondered how two runners stack up against each other in the same race?</em></p><p id="95f9" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">In this article I present two new graphs that I have designed, as I felt they were missing from Strava. These graphs have been created in a way that they can tell the story of a race at a glance as they compare different athletes running the same event. One can easily see changes in positions, as well as the time difference across the laps and competitors.</p><p id="884c" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">My explanation will start with <strong class="nf fr">how I spotted the opportunity.</strong> Next, I’ll showcase the <strong class="nf fr">graph designs</strong> and <strong class="nf fr">explain the algorithms</strong> and data processing techniques that power them.</p><h1 id="c3f8" class="oa ob fq bf oc od oe gq of og oh gt oi oj ok ol om on oo op oq or os ot ou ov bk">Strava doesn’t tell the full story</h1><p id="84b9" class="pw-post-body-paragraph nd ne fq nf b go ow nh ni gr ox nk nl nm oy no np nq oz ns nt nu pa nw nx ny fj bk">Strava is a social fitness app were people can record and share their sport activities with a community of 100+ million users [1]. Widely used among cyclists and runners, it’s a great tool that not only records your activities, but also provides personalised analysis about your performance based on your fitness data.</p><p id="d1bf" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">As a runner, I find this app incredibly beneficial for two main reasons:</p><ol class=""><li id="c079" class="nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny pb pc pd bk">It provides data analysis that help me understand my running performance better.</li><li id="c6a4" class="nd ne fq nf b go pe nh ni gr pf nk nl nm pg no np nq ph ns nt nu pi nw nx ny pb pc pd bk">It pushes me to stay motivated as I can see what my friends and the community are sharing.</li></ol><p id="5ee2" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Every time I complete a running event with my friends, we all log our fitness data from our watches into Strava to see analysis such as:</p><ul class=""><li id="ddee" class="nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny pj pc pd bk"><strong class="nf fr">Total</strong> <strong class="nf fr">time, distance</strong> and <strong class="nf fr">average pace</strong>.</li><li id="d353" class="nd ne fq nf b go pe nh ni gr pf nk nl nm pg no np nq ph ns nt nu pi nw nx ny pj pc pd bk"><strong class="nf fr">Time</strong> for every <strong class="nf fr">split</strong> or lap in the race.</li><li id="8546" class="nd ne fq nf b go pe nh ni gr pf nk nl nm pg no np nq ph ns nt nu pi nw nx ny pj pc pd bk"><strong class="nf fr">Heart Rate </strong>metrics<strong class="nf fr"> </strong>evolution.</li><li id="eafd" class="nd ne fq nf b go pe nh ni gr pf nk nl nm pg no np nq ph ns nt nu pi nw nx ny pj pc pd bk"><strong class="nf fr">Relative Effort</strong> compared to previous activities.</li></ul><p id="1df0" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">The best part is when we talk about the race from everyone’s perspectives. Strava is able to recognise that you ran the same event with your friends (if you follow each other) and even other people, however it does not provide comparative data. So if you want to have the full story of the race with your friends, you need to dive into everyone’s activity and try to compare them.</p><p id="8cd5" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">That’s why, after my last 10K with 3 friends this year, I decided to get the data from Strava and design two visuals to see a comparative analysis of our race performance.</p><h1 id="5eeb" class="oa ob fq bf oc od oe gq of og oh gt oi oj ok ol om on oo op oq or os ot ou ov bk">Presenting the visuals</h1><p id="3cc9" class="pw-post-body-paragraph nd ne fq nf b go ow nh ni gr ox nk nl nm oy no np nq oz ns nt nu pa nw nx ny fj bk">The idea behind this project is simple: use GPX data from Strava (location, timestamp) recorded by my friends and me during a race and combine them to generate visuals comparing our races.</p><p id="e177" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">The challenge was not only validating that my idea was doable, but also designing Strava-inspired graphs to proof how they could seamlessly integrate as new features in the current application. Let’s see the results.</p><h2 id="f7e9" class="pk ob fq bf oc pl pm pn of po pp pq oi nm pr ps pt nq pu pv pw nu px py pz qa bk">Race GAP Analysis</h2><p id="ddf6" class="pw-post-body-paragraph nd ne fq nf b go ow nh ni gr ox nk nl nm oy no np nq oz ns nt nu pa nw nx ny fj bk"><strong class="nf fr">Metrics: </strong>the evolution of the gap (in seconds) between a runner that is the reference (grey line on 0) and their competitors. Lines above mean the runner is ahead on the race.</p><p id="ce5a" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk"><strong class="nf fr">Insights: </strong>this line chart is perfect to see the changes in positions and distances for a group of runners.</p><figure class="mn mo mp mq mr ms mk ml paragraph-image"><div role="button" tabindex="0" class="mt mu ed mv bh mw"><div class="mk ml qb"><img src="../Images/460ad46fa47e712a322f36ce8d3f8954.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*06iYVRKZYsz_Y0i2fX0s0A.gif"/></div></div><figcaption class="my mz na mk ml nb nc bf b bg z dx">Race GAP Analysis animation of the same race for 3 different runners. Image by Author.</figcaption></figure><p id="f0b8" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">If you look at the right end of the lines, you can see the final results of the race for the 3 runners of our examples:</p><ol class=""><li id="c846" class="nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny pb pc pd bk">The first runner (me) is represented by the reference in grey.</li><li id="f4f1" class="nd ne fq nf b go pe nh ni gr pf nk nl nm pg no np nq ph ns nt nu pi nw nx ny pb pc pd bk">Pedro (in purple) was the second runner reaching the finish line only 12 seconds after.</li><li id="636b" class="nd ne fq nf b go pe nh ni gr pf nk nl nm pg no np nq ph ns nt nu pi nw nx ny pb pc pd bk">Jimena (in blue) finished the 10K 60 seconds after.</li></ol></div></div><div class="ms"><div class="ab cb"><div class="ln qc lo qd lp qe cf qf cg qg ci bh"><div class="mn mo mp mq mr ab kf"><figure class="lc ms qh qi qj qk ql paragraph-image"><div role="button" tabindex="0" class="mt mu ed mv bh mw"><img src="../Images/95fd5e59eead930dac07697c172c7541.png" data-original-src="https://miro.medium.com/v2/resize:fit:1176/format:webp/1*qO1gx6rsj-6l8VFKnD5_ag.jpeg"/></div></figure><figure class="lc ms qm qi qj qk ql paragraph-image"><div role="button" tabindex="0" class="mt mu ed mv bh mw"><img src="../Images/5168b2d354043221d54bdfd073f5c809.png" data-original-src="https://miro.medium.com/v2/resize:fit:826/format:webp/1*1DWLvD0b36BIn-gGlCKynw.png"/></div><figcaption class="my mz na mk ml nb nc bf b bg z dx qn ed qo qp">Proposal for <strong class="bf oc"><em class="hd">Race Gap Analysis</em></strong> chart integration into Strava activities. Image by Author.</figcaption></figure></div></div></div></div><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="dc8f" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">But, thanks to this chart, it’s possible to see how theses gaps where changing throughout the race. And these insights are really interesting to understand the race positions and distances:</p><ol class=""><li id="357c" class="nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny pb pc pd bk">The 3 of us started the race together. Jimena, in blue, started to fall behind around 5 seconds in the first km while me (grey) and Pedro ( purple) where together.</li><li id="2225" class="nd ne fq nf b go pe nh ni gr pf nk nl nm pg no np nq ph ns nt nu pi nw nx ny pb pc pd bk">I remember Pedro telling me it was too fast of a start, so he slightly reduced the pace until he found Jimena at km 2. Their lines show they ran together until the 5th km, while I was increasing the gap with them.</li><li id="4e63" class="nd ne fq nf b go pe nh ni gr pf nk nl nm pg no np nq ph ns nt nu pi nw nx ny pb pc pd bk">Km 6 is key, my gap with Pedro at that point was 20 seconds (the max I reached) and almost 30 seconds to Jimena, who reduced the pace compared to mine until the end of the race. However, Pedro started going faster and reduced our gap pushing faster in the 4 last kms.</li></ol><p id="0216" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Of course, the lines will change depending on who is the reference. This way, every runner will see the story of the same race but personalised to their point of view and how the compare to the rest. <strong class="nf fr">It’s the same story with different main characters.</strong></p></div></div><div class="ms"><div class="ab cb"><div class="ln qc lo qd lp qe cf qf cg qg ci bh"><div class="mn mo mp mq mr ab kf"><figure class="lc ms qq qi qj qk ql paragraph-image"><div role="button" tabindex="0" class="mt mu ed mv bh mw"><img src="../Images/f04c215a2f18db2af0436b54d04f2035.png" data-original-src="https://miro.medium.com/v2/resize:fit:670/format:webp/1*ACtT7ZlAUjJfrVks_k2GWw.png"/></div></figure><figure class="lc ms qr qi qj qk ql paragraph-image"><div role="button" tabindex="0" class="mt mu ed mv bh mw"><img src="../Images/516bf750c42bd8f946f426e7202337ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:666/format:webp/1*y-yXKomAnUYvsyacLCpcOA.png"/></div></figure><figure class="lc ms qs qi qj qk ql paragraph-image"><div role="button" tabindex="0" class="mt mu ed mv bh mw"><img src="../Images/efc9800546d599221bb7316ec3d16453.png" data-original-src="https://miro.medium.com/v2/resize:fit:666/format:webp/1*Rh1WXHkr4faUpDPnpTM_PQ.png"/></div><figcaption class="my mz na mk ml nb nc bf b bg z dx qt ed qu qp">Race Gap Analysis with different references. Reference is Juan (left). Reference is Pedro (middle). Reference is Jimena (right). Image by Author.</figcaption></figure></div></div></div></div><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="d24c" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">If I were Strava, I would include this chart in the activities marked as RACE by the user. The analysis could be done with all the followers of that user that registered the same activity. An example of integration is shown above.</p><h2 id="b192" class="pk ob fq bf oc pl pm pn of po pp pq oi nm pr ps pt nq pu pv pw nu px py pz qa bk">Head-to-Head Lap Analysis</h2><p id="2de4" class="pw-post-body-paragraph nd ne fq nf b go ow nh ni gr ox nk nl nm oy no np nq oz ns nt nu pa nw nx ny fj bk"><strong class="nf fr">Metrics: </strong>the line represent the evolution of the gap (in seconds) between two runners. The bars represent, for every lap, if a runner was faster (blue) or slower (red) compared to other.</p><p id="658a" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk"><strong class="nf fr">Insights: </strong>this combined chart is ideal for analysing the head-to-head performance across every lap of a race.</p></div></div><div class="ms"><div class="ab cb"><div class="ln qc lo qd lp qe cf qf cg qg ci bh"><div class="mn mo mp mq mr ab kf"><figure class="lc ms qv qi qj qk ql paragraph-image"><div role="button" tabindex="0" class="mt mu ed mv bh mw"><img src="../Images/eda6b248da26e98664a20785606d3f45.png" data-original-src="https://miro.medium.com/v2/resize:fit:1250/format:webp/1*UK63oUVktAcm74dJZyKAaw.png"/></div></figure><figure class="lc ms qw qi qj qk ql paragraph-image"><div role="button" tabindex="0" class="mt mu ed mv bh mw"><img src="../Images/f486aca17ca420420cdc800f9524ee3c.png" data-original-src="https://miro.medium.com/v2/resize:fit:752/format:webp/1*UpPf9m61i5TET214jaz4WQ.png"/></div><figcaption class="my mz na mk ml nb nc bf b bg z dx qx ed qy qp">Proposal for<strong class="bf oc"> Head-to-Head Lap Analysis</strong> of Pedro vs. Juan integration into Strava. Image by Author.</figcaption></figure></div></div></div></div><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="019f" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">This graph has been specifically designed to compare two runners performance across the splits (laps) of the race.</p><p id="91b3" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">The example represent the time loss of Pedro compared to Juan.</p><ul class=""><li id="e23b" class="nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny pj pc pd bk"><strong class="nf fr">The orange line </strong>represent the loss in time as explained for the other graph: both started together, but Pedro started to lose time after the first km until the sixth. Then, he began to be faster to reduce that gap.</li><li id="c2b2" class="nd ne fq nf b go pe nh ni gr pf nk nl nm pg no np nq ph ns nt nu pi nw nx ny pj pc pd bk"><strong class="nf fr">The bars </strong>bring new insights to our comparison representing the time loss (in red) or the gain (in blue) for every lap. At a glance, Pedro can see that the bigger loss in time was on the third km (8 seconds). And he only lost time on half of the splits. The pace of both was the same for kilometres 1 and 4, and Pedro was faster between on the kms 7, 8 and 9.</li></ul><p id="140b" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Thanks to this graph we can see that I was faster than Pedro on the first 6 kms, gaining and advantage that Pedro could not reduce, despite being faster on the last part of the race. And this confirms the feeling that we have after the competitions: “Pedro has stronger finishes in races.”</p><h1 id="3804" class="oa ob fq bf oc od oe gq of og oh gt oi oj ok ol om on oo op oq or os ot ou ov bk">Data Processing and Algorithms</h1><p id="d121" class="pw-post-body-paragraph nd ne fq nf b go ow nh ni gr ox nk nl nm oy no np nq oz ns nt nu pa nw nx ny fj bk">If you want to know how the graphs were created, keep reading this section about the implementation.</p><p id="572e" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">I don’t want to go too much into the coding bits behind this. As every software problem, you might achieve your goal through different solutions. That’s why I am more interested in explaining the problems that I faced and the logic behind my solutions.</p><h2 id="6e9d" class="pk ob fq bf oc pl pm pn of po pp pq oi nm pr ps pt nq pu pv pw nu px py pz qa bk">Loading Data</h2><p id="274a" class="pw-post-body-paragraph nd ne fq nf b go ow nh ni gr ox nk nl nm oy no np nq oz ns nt nu pa nw nx ny fj bk">No data, no solution. In this case no Strava API is needed . If you log in your Strava account and go to an activity you can download the GPX file of the activity by clicking on <em class="nz">Export GPX </em>as shown on the screenshot. GPX files contain datapoints in XML format as seen below.</p></div></div><div class="ms"><div class="ab cb"><div class="ln qc lo qd lp qe cf qf cg qg ci bh"><div class="mn mo mp mq mr ab kf"><figure class="lc ms qz qi qj qk ql paragraph-image"><div role="button" tabindex="0" class="mt mu ed mv bh mw"><img src="../Images/44846a62ae44815980e3f68bd2437b7b.png" data-original-src="https://miro.medium.com/v2/resize:fit:858/format:webp/1*oSYuNxw3nBEtzO7o3SUkTg.jpeg"/></div></figure><figure class="lc ms ra qi qj qk ql paragraph-image"><div role="button" tabindex="0" class="mt mu ed mv bh mw"><img src="../Images/d26c929437711195dc64b29237a91036.png" data-original-src="https://miro.medium.com/v2/resize:fit:1144/format:webp/1*vlzh0rdORrHozX-rE8r_rg.png"/></div><figcaption class="my mz na mk ml nb nc bf b bg z dx rb ed rc qp">How to download GPX file from Strava (left). Example of GPX file (right). Image by Author.</figcaption></figure></div></div></div></div><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="a62c" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">To get my friends data for the same activities I just told them to follow the same steps and send the .gpx files to me.</p><h2 id="18e8" class="pk ob fq bf oc pl pm pn of po pp pq oi nm pr ps pt nq pu pv pw nu px py pz qa bk">Preparing Data</h2><p id="46b2" class="pw-post-body-paragraph nd ne fq nf b go ow nh ni gr ox nk nl nm oy no np nq oz ns nt nu pa nw nx ny fj bk">For this use case I was only interested in a few attributes:</p><ul class=""><li id="9cc8" class="nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny pj pc pd bk">Location: <em class="nz">latitude, longitude </em>and<em class="nz"> elevation</em></li><li id="00d5" class="nd ne fq nf b go pe nh ni gr pf nk nl nm pg no np nq ph ns nt nu pi nw nx ny pj pc pd bk">Timestamp: <em class="nz">time</em>.</li></ul><p id="3185" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">First problem for me was to convert the .gpx files into pandas dataframes so I can play and process the data using python. I used <strong class="nf fr"><em class="nz">gpxpy</em></strong><em class="nz"> </em>library. Code below</p><pre class="mn mo mp mq mr rd re rf bp rg bb bk"><span id="a111" class="rh ob fq re b bg ri rj l rk rl">import pandas as pd<br/>import gpxpy<br/><br/># read file<br/>with open('juan.gpx', 'r') as gpx_file:<br/>    juan_gpx = gpxpy.parse(gpx_file)<br/><br/># Convert Juan´s gpx to dataframe<br/>juan_route_info = []<br/><br/>for track in juan_gpx.tracks:<br/>    for segment in track.segments:<br/>        for point in segment.points:<br/>            juan_route_info.append({<br/>                'latitude': point.latitude,<br/>                'longitude': point.longitude,<br/>                'elevation': point.elevation,<br/>                'date_time': point.time<br/>            })<br/><br/>juan_df =  pd.DataFrame(juan_route_info)<br/>juan_df</span></pre><p id="d870" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">After that, I had 667 datapoints stored on a dataframe. Every row represents <strong class="nf fr">where</strong> and <strong class="nf fr">when </strong>I was during the activity.</p><p id="287e" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">I learnt that not every row is captured with the same frequency (1 second between 0 and 1, then 3 seconds, then 4 seconds, then 1 second…)</p><figure class="mn mo mp mq mr ms mk ml paragraph-image"><div role="button" tabindex="0" class="mt mu ed mv bh mw"><div class="mk ml rm"><img src="../Images/e68884938e5f0f12dd8a742d6fc5a4cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dKpEA-as5c4SRwwosCTQOQ.jpeg"/></div></div><figcaption class="my mz na mk ml nb nc bf b bg z dx">Example of .gpx data stored on a pandas dataframe. Image by Author.</figcaption></figure><h2 id="54e8" class="pk ob fq bf oc pl pm pn of po pp pq oi nm pr ps pt nq pu pv pw nu px py pz qa bk">Getting some metrics</h2><p id="c34c" class="pw-post-body-paragraph nd ne fq nf b go ow nh ni gr ox nk nl nm oy no np nq oz ns nt nu pa nw nx ny fj bk">Every row in the data represents a different moment and place, so my first idea was to calculate the difference in time, elevation, and distance between two consecutive rows: <strong class="nf fr"><em class="nz">seconds_diff</em></strong><em class="nz">, </em><strong class="nf fr"><em class="nz">elevation_diff</em></strong><em class="nz"> </em>and <strong class="nf fr"><em class="nz">distance_diff</em></strong><em class="nz">.</em></p><p id="1f67" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Time and elevation were straightforward using <em class="nz">.diff() </em>method over each column of the pandas dataframe.</p><pre class="mn mo mp mq mr rd re rf bp rg bb bk"><span id="1289" class="rh ob fq re b bg ri rj l rk rl"># First Calculate elevation diff<br/>juan_df['elevation_diff'] = juan_df['elevation'].diff()<br/><br/># Calculate the difference in seconds between datapoints<br/>juan_df['seconds_diff'] = juan_df['date_time'].diff()</span></pre><p id="b59c" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Unfortunately, as the Earth is not flat, we need to use a distance metric called <strong class="nf fr">haversine distance </strong>[2]<strong class="nf fr">: </strong>the shortest distance between two points on the surface of a sphere, given their latitude and longitude coordinates. I used the library <em class="nz">haversine.</em><strong class="nf fr"><em class="nz"> </em></strong>See the code below</p><pre class="mn mo mp mq mr rd re rf bp rg bb bk"><span id="0d40" class="rh ob fq re b bg ri rj l rk rl">import haversine as hs<br/><br/># Function to calculate haversine distances<br/>def haversine_distance(lat1, lon1, lat2, lon2) -&gt; float:<br/>    distance = hs.haversine(<br/>        point1=(lat1, lon1),<br/>        point2=(lat2, lon2),<br/>        unit=hs.Unit.METERS<br/>    )<br/><br/>    # Returns the distance between the first point and the second point<br/>    return np.round(distance, 2)<br/><br/>#calculate the distances between all data points<br/>distances = [np.nan]<br/><br/>for i in range(len(track_df)):<br/>    if i == 0:<br/>        continue<br/>    else:<br/>        distances.append(haversine_distance(<br/>            lat1=juan_df.iloc[i - 1]['latitude'],<br/>            lon1=juan_df.iloc[i - 1]['longitude'],<br/>            lat2=juan_df.iloc[i]['latitude'],<br/>            lon2=juan_df.iloc[i]['longitude']<br/>        ))<br/>        <br/>juan_df['distance_diff'] = distances</span></pre><p id="92d0" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">The cumulative distance was also added as a new column <strong class="nf fr"><em class="nz">distance_cum </em></strong>using the method <em class="nz">cumsum() </em>as seen below</p><pre class="mn mo mp mq mr rd re rf bp rg bb bk"><span id="8f6c" class="rh ob fq re b bg ri rj l rk rl"># Calculate the cumulative sum of the distance<br/>juan_df['distance_cum'] = juan_df['distance_diff'].cumsum()</span></pre><p id="ede2" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">At this point the dataframe with my track data includes 4 new columns with useful metrics:</p><figure class="mn mo mp mq mr ms mk ml paragraph-image"><div role="button" tabindex="0" class="mt mu ed mv bh mw"><div class="mk ml rn"><img src="../Images/f44598fea204f0be62a99fd6fd7a8e1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FacF3YYI-Fs1eb5vWkj7Pw.jpeg"/></div></div><figcaption class="my mz na mk ml nb nc bf b bg z dx">Dataframe with new metrics for every row. Image by Author.</figcaption></figure><p id="1793" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">I applied the same logic to other runners’ tracks: <em class="nz">jimena_df </em>and <em class="nz">pedro_df</em>.</p></div></div><div class="ms"><div class="ab cb"><div class="ln qc lo qd lp qe cf qf cg qg ci bh"><div class="mn mo mp mq mr ab kf"><figure class="lc ms ro qi qj qk ql paragraph-image"><div role="button" tabindex="0" class="mt mu ed mv bh mw"><img src="../Images/50e2a0e6bd554af943b9e056fbe429d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1012/format:webp/1*95IgSBk7wTcI2rX5-HaBiw.png"/></div></figure><figure class="lc ms rp qi qj qk ql paragraph-image"><div role="button" tabindex="0" class="mt mu ed mv bh mw"><img src="../Images/955862c10068818bdde7587af22c0166.png" data-original-src="https://miro.medium.com/v2/resize:fit:990/format:webp/1*g_E3NAmkmCEpR0TtO2s9Ag.png"/></div><figcaption class="my mz na mk ml nb nc bf b bg z dx rq ed rr qp">Dataframes for other runners: Pedro (left) and Jimena (right). Image by Author.</figcaption></figure></div></div></div></div><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="e4cd" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">We are ready now to play with the data to create the visualisations.</p><h2 id="004f" class="pk ob fq bf oc pl pm pn of po pp pq oi nm pr ps pt nq pu pv pw nu px py pz qa bk"><strong class="al">Challenges:</strong></h2><p id="12bc" class="pw-post-body-paragraph nd ne fq nf b go ow nh ni gr ox nk nl nm oy no np nq oz ns nt nu pa nw nx ny fj bk">To obtain the data needed for the visuals my first intuition was: look at the cumulative distance column for every runner, identify when a lap distance was completed (1000, 2000, 3000, etc.) by each of them and do the differences of timestamps.</p><p id="4fa2" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">That algorithm looks simple, and might work, but it had some limitations that I needed to address:</p><ol class=""><li id="45c0" class="nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny pb pc pd bk">Exact lap distances are often completed in between two data points registered. To be more accurate I had to do <strong class="nf fr">interpolation</strong> of both <strong class="nf fr">position</strong> and <strong class="nf fr">time</strong>.</li><li id="293c" class="nd ne fq nf b go pe nh ni gr pf nk nl nm pg no np nq ph ns nt nu pi nw nx ny pb pc pd bk">Due to <strong class="nf fr">difference in the precision</strong> <strong class="nf fr">of devices</strong>, there might be misalignments across runners. The most typical is when a runner’s lap notification beeps before another one even if they have been together the whole track. To minimise this I decided to <strong class="nf fr">use the reference runner to set the position marks for every lap in the track</strong>. The time difference will be calculated when other runners cross those marks (even though their cumulative distance is ahead or behind the lap). This is more close to the reality of the race: if someone crosses a point before, they are ahead (regardless the cumulative distance of their device)</li><li id="eee6" class="nd ne fq nf b go pe nh ni gr pf nk nl nm pg no np nq ph ns nt nu pi nw nx ny pb pc pd bk">With the previous point comes another problem: the latitude and longitude of a reference mark might never be exactly registered on the other runners’ data. I used <strong class="nf fr">Nearest Neighbours </strong>to find the closest datapoint in terms of position.</li><li id="54c0" class="nd ne fq nf b go pe nh ni gr pf nk nl nm pg no np nq ph ns nt nu pi nw nx ny pb pc pd bk">Finally, Nearest Neighbours might bring wrong datapoints if the track crosses the same positions at different moments in time. So the population where the Nearest Neighbours will look for the best match needs to be <strong class="nf fr">reduced to a smaller group of candidates</strong>. I defined a <strong class="nf fr">window size of 20 datapoints </strong>around the target distance (<em class="nz">distance_cum)</em>.</li></ol><h2 id="8d99" class="pk ob fq bf oc pl pm pn of po pp pq oi nm pr ps pt nq pu pv pw nu px py pz qa bk"><strong class="al">Algorithm</strong></h2><p id="5e9a" class="pw-post-body-paragraph nd ne fq nf b go ow nh ni gr ox nk nl nm oy no np nq oz ns nt nu pa nw nx ny fj bk">With all the previous limitations in mind, the algorithm should be as follows:</p><blockquote class="rs rt ru"><p id="bc82" class="nd ne nz nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">1. Choose the reference and a lap distance (default= 1km)</p><p id="3ff7" class="nd ne nz nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">2. Using the reference data, identify the position and the moment every lap was completed: the reference marks.</p><p id="ed35" class="nd ne nz nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">3. Go to other runner’s data and identify the moments they crossed those position marks. Then calculate the difference in time of both runners crossing the marks. Finally the delta of this time difference to represent the evolution of the gap.</p></blockquote><h2 id="5a3b" class="pk ob fq bf oc pl pm pn of po pp pq oi nm pr ps pt nq pu pv pw nu px py pz qa bk"><strong class="al">Code Example</strong></h2><blockquote class="rs rt ru"><p id="35a8" class="nd ne nz nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">1. Choose the reference and a lap distance (default= 1km)</p></blockquote><ul class=""><li id="3ba1" class="nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny pj pc pd bk">Juan will be the reference (<em class="nz">juan_df) </em>on the examples.</li><li id="6260" class="nd ne fq nf b go pe nh ni gr pf nk nl nm pg no np nq ph ns nt nu pi nw nx ny pj pc pd bk">The other runners will be Pedro (<em class="nz">pedro_df </em>) and Jimena (<em class="nz">jimena_df</em>).</li><li id="e1ec" class="nd ne fq nf b go pe nh ni gr pf nk nl nm pg no np nq ph ns nt nu pi nw nx ny pj pc pd bk">Lap distance will be 1000 metres</li></ul><blockquote class="rs rt ru"><p id="2526" class="nd ne nz nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">2. Create <strong class="nf fr">interpolate_laps()</strong>: function that finds or interpolates the exact point for each completed lap and return it in a new dataframe<em class="fq">. </em>The inferpolation is done with the function: <strong class="nf fr">interpolate_value() </strong>that<strong class="nf fr"> </strong>was also created.</p></blockquote><pre class="mn mo mp mq mr rd re rf bp rg bb bk"><span id="3baa" class="rh ob fq re b bg ri rj l rk rl">## Function: <strong class="re fr">interpolate_value</strong>()<br/><br/><strong class="re fr">Input</strong>: <br/>    - <em class="nz">start</em>: The starting value.<br/>    - <em class="nz">end</em>: The ending value.<br/>    - <em class="nz">fraction</em>: A value between 0 and 1 that represents the position between <br/>      the start and end values where the interpolation should occur.<br/><strong class="re fr">Return</strong>:<br/>    - The interpolated value that lies between the <em class="nz">start</em> and <em class="nz">end</em> values <br/>      at the specified <em class="nz">fraction</em>.</span></pre><pre class="rv rd re rf bp rg bb bk"><span id="8809" class="rh ob fq re b bg ri rj l rk rl">def interpolate_value(start, end, fraction):<br/>    return start + (end - start) * fraction</span></pre><pre class="rv rd re rf bp rg bb bk"><span id="b823" class="rh ob fq re b bg ri rj l rk rl">## Function: <strong class="re fr">interpolate_laps()</strong><br/><br/><strong class="re fr">Input</strong>: <br/>    - track_df: dataframe with track data.<br/>    - lap_distance: metres per lap (default 1000)<br/><strong class="re fr">Return</strong>:<br/>    - track_laps: dataframe with lap metrics. As many rows as laps identified.</span></pre><pre class="rv rd re rf bp rg bb bk"><span id="0959" class="rh ob fq re b bg ri rj l rk rl">def interpolate_laps(track_df , lap_distance = 1000):<br/>  #### 1. Initialise track_laps with the first row of track_df <br/>  track_laps = track_df.loc[0][['latitude','longitude','elevation','date_time','distance_cum']].copy()<br/>  <br/>  # Set distance_cum = 0<br/>  track_laps[['distance_cum']] = 0<br/><br/>  # Transpose dataframe<br/>  track_laps = pd.DataFrame(track_laps)<br/>  track_laps = track_laps.transpose()<br/><br/>  #### 2. Calculate number_of_laps = Total Distance / lap_distance<br/>  number_of_laps = track_df['distance_cum'].max()//lap_distance<br/><br/>  #### 3. For each lap i from 1 to number_of_laps:<br/>  for i in range(1,int(number_of_laps+1),1):<br/><br/>    # a. Calculate target_distance = i * lap_distance<br/>    target_distance = i*lap_distance<br/><br/>    # b. Find first_crossing_index where track_df['distance_cum'] &gt; target_distance<br/>    first_crossing_index = (track_df['distance_cum'] &gt; target_distance).idxmax()<br/>    <br/>    # c. If match is exactly the lap distance, copy that row<br/>    if (track_df.loc[first_crossing_index]['distance_cum'] == target_distance):<br/>      new_row = track_df.loc[first_crossing_index][['latitude','longitude','elevation','date_time','distance_cum']]<br/>       <br/>    # Else: Create new_row with interpolated values, copy that row.<br/>    else: <br/><br/>      fraction = (target_distance - track_df.loc[first_crossing_index-1, 'distance_cum']) / (track_df.loc[first_crossing_index, 'distance_cum'] - track_df.loc[first_crossing_index-1, 'distance_cum'])<br/><br/>      # Create the new row<br/>      new_row = pd.Series({<br/>          'latitude': interpolate_value(track_df.loc[first_crossing_index-1, 'latitude'], track_df.loc[first_crossing_index, 'latitude'], fraction),<br/>          'longitude': interpolate_value(track_df.loc[first_crossing_index-1, 'longitude'], track_df.loc[first_crossing_index, 'longitude'], fraction),<br/>          'elevation': interpolate_value(track_df.loc[first_crossing_index-1, 'elevation'], track_df.loc[first_crossing_index, 'elevation'], fraction),<br/>          'date_time': track_df.loc[first_crossing_index-1, 'date_time'] + (track_df.loc[first_crossing_index, 'date_time'] - track_df.loc[first_crossing_index-1, 'date_time']) * fraction,<br/>          'distance_cum': target_distance<br/>      }, name=f'lap_{i}')<br/><br/>    # d. Add the new row to the dataframe that stores the laps<br/>    new_row_df = pd.DataFrame(new_row)<br/>    new_row_df = new_row_df.transpose()<br/><br/>    track_laps = pd.concat([track_laps,new_row_df])<br/><br/>  #### 4. Convert date_time to datetime format and remove timezone<br/>  track_laps['date_time'] = pd.to_datetime(track_laps['date_time'], format='%Y-%m-%d %H:%M:%S.%f%z')<br/>  track_laps['date_time'] = track_laps['date_time'].dt.tz_localize(None)<br/><br/>  #### 5. Calculate seconds_diff between consecutive rows in track_laps<br/>  track_laps['seconds_diff'] = track_laps['date_time'].diff()<br/><br/>  return track_laps</span></pre><p id="945a" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Applying the interpolate function to the reference dataframe will generate the following dataframe:</p><pre class="mn mo mp mq mr rd re rf bp rg bb bk"><span id="18f4" class="rh ob fq re b bg ri rj l rk rl">juan_laps = interpolate_laps(juan_df , lap_distance=1000)</span></pre><figure class="mn mo mp mq mr ms mk ml paragraph-image"><div role="button" tabindex="0" class="mt mu ed mv bh mw"><div class="mk ml rw"><img src="../Images/6489422f28f6ea842bcb5bfeb6256a1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ASG2SwVGX9eeZ8dCdRj_kw.png"/></div></div><figcaption class="my mz na mk ml nb nc bf b bg z dx">Dataframe with the lap metrics as a result of interpolation. Image by Author.</figcaption></figure><p id="37c2" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Note as it was a 10k race, 10 laps of 1000m has been identified (see column <em class="nz">distance_cum</em>). The column <em class="nz">seconds_diff</em> has the time per lap. The rest of the columns (<em class="nz">latitude</em>,<em class="nz"> longitude</em>,<em class="nz"> elevation </em>and <em class="nz">date_time</em>)<em class="nz"> </em>mark the position and time for each lap of the reference as the result of interpolation.</p><blockquote class="rs rt ru"><p id="0771" class="nd ne nz nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">3. To calculate the time gaps between the reference and the other runners I created the function <strong class="nf fr">gap_to_reference()</strong></p></blockquote><pre class="mn mo mp mq mr rd re rf bp rg bb bk"><span id="ab0f" class="rh ob fq re b bg ri rj l rk rl">## Helper Functions:<br/>- <strong class="re fr">get_seconds</strong>(): Convert timedelta to total seconds<br/>- <strong class="re fr">format_timedelta</strong>(): Format timedelta as a string (e.g., "+01:23" or "-00:45")</span></pre><pre class="rv rd re rf bp rg bb bk"><span id="025e" class="rh ob fq re b bg ri rj l rk rl"># Convert timedelta to total seconds<br/>def get_seconds(td):<br/>    # Convert to total seconds<br/>    total_seconds = td.total_seconds()    <br/><br/>    return total_seconds<br/><br/># Format timedelta as a string (e.g., "+01:23" or "-00:45")<br/>def format_timedelta(td):<br/>    # Convert to total seconds<br/>    total_seconds = td.total_seconds()<br/>    <br/>    # Determine sign<br/>    sign = '+' if total_seconds &gt;= 0 else '-'<br/>    <br/>    # Take absolute value for calculation<br/>    total_seconds = abs(total_seconds)<br/>    <br/>    # Calculate minutes and remaining seconds<br/>    minutes = int(total_seconds // 60)<br/>    seconds = int(total_seconds % 60)<br/>    <br/>    # Format the string<br/>    return f"{sign}{minutes:02d}:{seconds:02d}"</span></pre><pre class="rv rd re rf bp rg bb bk"><span id="bc4b" class="rh ob fq re b bg ri rj l rk rl">## Function: <strong class="re fr">gap_to_reference</strong>()<br/><br/><strong class="re fr">Input</strong>: <br/>    - laps_dict: dictionary containing the df_laps for all the runnners' names<br/>    - df_dict: dictionary containing the track_df for all the runnners' names<br/>    - reference_name: name of the reference<br/><strong class="re fr">Return</strong>:<br/>    - matches: processed data with time differences.</span></pre><pre class="rv rd re rf bp rg bb bk"><span id="bc12" class="rh ob fq re b bg ri rj l rk rl"><br/>def gap_to_reference(laps_dict, df_dict, reference_name):<br/>  #### 1. Get the reference's lap data from laps_dict<br/>  matches = laps_dict[reference_name][['latitude','longitude','date_time','distance_cum']]<br/><br/>  #### 2. For each racer (name) and their data (df) in df_dict:<br/>  for name, df in df_dict.items():<br/><br/>    # If racer is the reference: <br/>    if name == reference_name:<br/><br/>      # Set time difference to zero for all laps<br/>      for lap, row  in matches.iterrows():<br/>        matches.loc[lap,f'seconds_to_reference_{reference_name}'] = 0<br/><br/>    # If racer is not the reference:<br/>    if name != reference_name:<br/><br/>      # a. For each lap find the nearest point in racer's data based on lat, lon.<br/>      for lap, row  in matches.iterrows():<br/>      <br/>        # Step 1: set the position and lap distance from the reference<br/>        target_coordinates = matches.loc[lap][['latitude', 'longitude']].values<br/>        target_distance = matches.loc[lap]['distance_cum']<br/>        <br/>        <br/>        # Step 2: find the datapoint that will be in the centre of the window<br/>        first_crossing_index = (df_dict[name]['distance_cum'] &gt; target_distance).idxmax()<br/>        <br/>        # Step 3: select the 20 candidate datapoints to look for the match<br/>        window_size = 20<br/>        window_sample = df_dict[name].loc[first_crossing_index-(window_size//2):first_crossing_index+(window_size//2)]<br/>        candidates = window_sample[['latitude', 'longitude']].values<br/><br/>        # Step 4: get the nearest match using the coordinates<br/>        nn = NearestNeighbors(n_neighbors=1, metric='euclidean')<br/>        nn.fit(candidates)<br/>        distance, indice = nn.kneighbors([target_coordinates])<br/><br/>        nearest_timestamp = window_sample.iloc[indice.flatten()]['date_time'].values<br/>        nearest_distance_cum = window_sample.iloc[indice.flatten()]['distance_cum'].values<br/>        euclidean_distance = distance<br/><br/>        matches.loc[lap,f'nearest_timestamp_{name}'] = nearest_timestamp[0]<br/>        matches.loc[lap,f'nearest_distance_cum_{name}'] = nearest_distance_cum[0]<br/>        matches.loc[lap,f'euclidean_distance_{name}'] = euclidean_distance<br/>        <br/>        <br/>      # b. Calculate time difference between racer and reference at this point<br/>      matches[f'time_to_ref_{name}'] = matches[f'nearest_timestamp_{name}'] - matches['date_time']<br/><br/>      # c. Store time difference and other relevant data<br/>      matches[f'time_to_ref_diff_{name}'] = matches[f'time_to_ref_{name}'].diff()<br/>      matches[f'time_to_ref_diff_{name}'] = matches[f'time_to_ref_diff_{name}'].fillna(pd.Timedelta(seconds=0))<br/>  <br/>      # d. Format data using helper functions<br/>      matches[f'lap_difference_seconds_{name}'] = matches[f'time_to_ref_diff_{name}'].apply(get_seconds)<br/>      matches[f'lap_difference_formatted_{name}'] = matches[f'time_to_ref_diff_{name}'].apply(format_timedelta)<br/>          <br/>      matches[f'seconds_to_reference_{name}'] = matches[f'time_to_ref_{name}'].apply(get_seconds)<br/>      matches[f'time_to_reference_formatted_{name}'] = matches[f'time_to_ref_{name}'].apply(format_timedelta)<br/><br/>#### 3. Return processed data with time differences<br/>  return matches</span></pre><p id="47a3" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Below the code to implement the logic and store results on the dataframe <strong class="nf fr">matches_gap_to_reference:</strong></p><pre class="mn mo mp mq mr rd re rf bp rg bb bk"><span id="df0f" class="rh ob fq re b bg ri rj l rk rl"># Lap distance<br/>lap_distance = 1000<br/><br/># Store the DataFrames in a dictionary<br/>df_dict = {<br/>    'jimena': jimena_df,<br/>    'juan': juan_df,<br/>    'pedro': pedro_df,<br/>}<br/><br/># Store the Lap DataFrames in a dictionary<br/>laps_dict = {<br/>    'jimena': interpolate_laps(jimena_df , lap_distance),<br/>    'juan': interpolate_laps(juan_df , lap_distance),<br/>    'pedro': interpolate_laps(pedro_df , lap_distance)<br/>}<br/><br/># Calculate gaps to reference<br/>reference_name = 'juan'<br/>matches_gap_to_reference  = gap_to_reference(laps_dict, df_dict, reference_name)<br/></span></pre><p id="1893" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">The columns of the resulting dataframe contain the important information that will be displayed on the graphs:</p></div></div><div class="ms"><div class="ab cb"><div class="ln qc lo qd lp qe cf qf cg qg ci bh"><figure class="mn mo mp mq mr ms qj qk paragraph-image"><div role="button" tabindex="0" class="mt mu ed mv bh mw"><div class="mk ml rx"><img src="../Images/f2ece348885eb7e4fc99db1bd014b0c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*woes9Vvh7TRQfsnZkoreAw.jpeg"/></div></div><figcaption class="my mz na mk ml nb nc bf b bg z dx">Some columns from the dataframe returned by the function gap_to_reference(). Image by Author.</figcaption></figure></div></div></div><div class="ab cb"><div class="ci bh ev ew ex ey"><h2 id="7c57" class="pk ob fq bf oc pl pm pn of po pp pq oi nm pr ps pt nq pu pv pw nu px py pz qa bk">Race GAP Analysis Graph</h2><p id="39f7" class="pw-post-body-paragraph nd ne fq nf b go ow nh ni gr ox nk nl nm oy no np nq oz ns nt nu pa nw nx ny fj bk"><strong class="nf fr">Requirements:</strong></p><ul class=""><li id="651e" class="nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny pj pc pd bk">The visualisation needs to be tailored for a runner who will be the <strong class="nf fr">reference. </strong>Every runner will be represented by a line graph.</li><li id="3758" class="nd ne fq nf b go pe nh ni gr pf nk nl nm pg no np nq ph ns nt nu pi nw nx ny pj pc pd bk"><strong class="nf fr">X-axis represent distance.</strong></li><li id="0192" class="nd ne fq nf b go pe nh ni gr pf nk nl nm pg no np nq ph ns nt nu pi nw nx ny pj pc pd bk"><strong class="nf fr">Y-axis the gap to reference</strong> in seconds</li><li id="c62a" class="nd ne fq nf b go pe nh ni gr pf nk nl nm pg no np nq ph ns nt nu pi nw nx ny pj pc pd bk">The reference will set the baseline. A constant grey line in y-axis = 0</li><li id="cb55" class="nd ne fq nf b go pe nh ni gr pf nk nl nm pg no np nq ph ns nt nu pi nw nx ny pj pc pd bk">The lines for the other runners will be above the reference if they were ahead on the track and below if they were behind.</li></ul><figure class="mn mo mp mq mr ms mk ml paragraph-image"><div role="button" tabindex="0" class="mt mu ed mv bh mw"><div class="mk ml ry"><img src="../Images/fab024dd6ddd7f803ea74b8be5714aaf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l2xT8r0TPw_Iq9c7OidzTA.png"/></div></div><figcaption class="my mz na mk ml nb nc bf b bg z dx"><em class="hd">Race Gap Analysis</em> chart for 10 laps (1000m). Image by Author.</figcaption></figure><p id="5d7e" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">To represent the graph I used <em class="nz">plotly </em>library and used the data from <strong class="nf fr">matches_gap_to_reference:</strong></p><p id="934a" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk"><strong class="nf fr">X-axis</strong>: is the cumulative distance per lap. Column <strong class="nf fr">distance_cum</strong></p><p id="956e" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk"><strong class="nf fr">Y-axis:</strong> represents the gap to reference in seconds:</p><ul class=""><li id="dae5" class="nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny pj pc pd bk">Grey line: reference’s gap to reference is always 0.</li><li id="b47f" class="nd ne fq nf b go pe nh ni gr pf nk nl nm pg no np nq ph ns nt nu pi nw nx ny pj pc pd bk">Purple line: Pedro’s gap to reference <strong class="nf fr">(-) seconds_to_reference_pedro</strong>.</li><li id="420f" class="nd ne fq nf b go pe nh ni gr pf nk nl nm pg no np nq ph ns nt nu pi nw nx ny pj pc pd bk">Blue line: Jimena’s gap to reference <strong class="nf fr">(-) seconds_to_reference_jimena</strong>.</li></ul><h2 id="0754" class="pk ob fq bf oc pl pm pn of po pp pq oi nm pr ps pt nq pu pv pw nu px py pz qa bk">Head to Head Lap Analysis Graph</h2><p id="4e71" class="pw-post-body-paragraph nd ne fq nf b go ow nh ni gr ox nk nl nm oy no np nq oz ns nt nu pa nw nx ny fj bk"><strong class="nf fr">Requirements:</strong></p><ul class=""><li id="3d1a" class="nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny pj pc pd bk">The visualisation needs to compare data for only 2 runners. A reference and a competitor.</li><li id="e21a" class="nd ne fq nf b go pe nh ni gr pf nk nl nm pg no np nq ph ns nt nu pi nw nx ny pj pc pd bk"><strong class="nf fr">X-axis represents distance</strong></li><li id="6cdc" class="nd ne fq nf b go pe nh ni gr pf nk nl nm pg no np nq ph ns nt nu pi nw nx ny pj pc pd bk"><strong class="nf fr">Y-axis represents seconds</strong></li><li id="6457" class="nd ne fq nf b go pe nh ni gr pf nk nl nm pg no np nq ph ns nt nu pi nw nx ny pj pc pd bk">Two metrics will be plotted to compare the runners’ performance: a line graph will show the total gap for every point of the race. The bars will represent if that gap was increased (positive) or decreased (negative) on every lap.</li></ul><figure class="mn mo mp mq mr ms mk ml paragraph-image"><div role="button" tabindex="0" class="mt mu ed mv bh mw"><div class="mk ml ry"><img src="../Images/3d35fdd833da8132fe85c33fa15f9b23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UK63oUVktAcm74dJZyKAaw.png"/></div></div><figcaption class="my mz na mk ml nb nc bf b bg z dx"><em class="hd">Head-to-Head Lap Analysis</em> chart for 10 laps (1000m). Image by Author.</figcaption></figure><p id="8e27" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Again, the data represented on the example is coming from <strong class="nf fr">matches_gap_to_reference:</strong></p><p id="f2d4" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk"><strong class="nf fr">X-axis</strong>: is the cumulative distance per lap. Column <strong class="nf fr">distance_cum</strong></p><p id="8c6a" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk"><strong class="nf fr">Y-axis:</strong></p><ul class=""><li id="678f" class="nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny pj pc pd bk">Orange line: Pedro’s gap to Juan <strong class="nf fr">(+) seconds_to_reference_pedro</strong></li><li id="b108" class="nd ne fq nf b go pe nh ni gr pf nk nl nm pg no np nq ph ns nt nu pi nw nx ny pj pc pd bk">Bars: the delta of that gap per lap <strong class="nf fr">lap_difference_formatted_pedro. </strong>If Pedro losses time, the delta is positive and represented in red. Otherwise the bar is blue.</li></ul><p id="81d3" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">I refined the style of both visuals to align more closely with Strava’s design aesthetics.</p><h1 id="011f" class="oa ob fq bf oc od oe gq of og oh gt oi oj ok ol om on oo op oq or os ot ou ov bk">Kudos for this article?</h1><p id="bfd7" class="pw-post-body-paragraph nd ne fq nf b go ow nh ni gr ox nk nl nm oy no np nq oz ns nt nu pa nw nx ny fj bk">I started this idea after my last race. I really liked the results of the visuals so I though they might be useful for the Strava community. That’s why I decided to share them with the community writing this article.</p></div></div></div><div class="ab cb rz sa sb sc" role="separator"><span class="sd by bm se sf sg"/><span class="sd by bm se sf sg"/><span class="sd by bm se sf"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><h1 id="aa1d" class="oa ob fq bf oc od sh gq of og si gt oi oj sj ol om on sk op oq or sl ot ou ov bk">References</h1><p id="2a8a" class="pw-post-body-paragraph nd ne fq nf b go ow nh ni gr ox nk nl nm oy no np nq oz ns nt nu pa nw nx ny fj bk">[1] S. Paul, <a class="af sm" href="https://techcrunch.com/2024/07/20/stravas-next-chapter-new-ceo-talks-ai-inclusivity-and-why-dark-mode-took-so-long/?guccounter=1&amp;guce_referrer=aHR0cHM6Ly93d3cubGlua2VkaW4uY29tLw&amp;guce_referrer_sig=AQAAALrriMjjcs0gk_LkHSHhEYNqeEB_G3h2ZqbXA0KyemE5fIqpbYVbEaq70qgL5eTHmyTNsAHLol_fEefFsj3PLGzxpyB7xfU_wcUPkvT4Iso2kOe8h_Gf5pLpXrIP4hstEUxnbZ1LUWjAq2pAC3LUf-ucvEfU4eNTXCRxVMwipGZm" rel="noopener ugc nofollow" target="_blank">Strava’s next chapter: New CEO talks AI, inclusivity, and why ‘dark mode’ took so long.</a> (2024)</p><p id="e835" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">[2] D. Grabiele, <a class="af sm" href="https://www.baeldung.com/cs/haversine-formula" rel="noopener ugc nofollow" target="_blank">“Haversine Formula”, Baeldung on Computer Science.</a> (2024)</p></div></div></div></div>    
</body>
</html>