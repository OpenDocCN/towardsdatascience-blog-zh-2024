<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>How to Parallelize Copy Activities in Azure Data Factory</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>How to Parallelize Copy Activities in Azure Data Factory</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-parallelize-copy-activities-in-azure-data-factory-5d21df7b8562?source=collection_archive---------10-----------------------#2024-10-10">https://towardsdatascience.com/how-to-parallelize-copy-activities-in-azure-data-factory-5d21df7b8562?source=collection_archive---------10-----------------------#2024-10-10</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="015f" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx">Optimizing data transfer for enterprise data lakes</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hd he hf hg hh ab"><div><div class="ab hi"><div><div class="bm" aria-hidden="false"><a href="https://rebremer.medium.com/?source=post_page---byline--5d21df7b8562--------------------------------" rel="noopener follow"><div class="l hj hk by hl hm"><div class="l ed"><img alt="René Bremer" class="l ep by dd de cx" src="../Images/e422c4b84e225d2a949251ebc24dbd2c.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/1*oh9d_1pNyGG5Ac_Cg-v9Tg.jpeg"/><div class="hn by l dd de em n ho eo"/></div></div></a></div></div><div class="hp ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--5d21df7b8562--------------------------------" rel="noopener follow"><div class="l hq hr by hl hs"><div class="l ed"><img alt="Towards Data Science" class="l ep by br ht cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hn by l br ht em n ho eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hu ab q"><div class="ab q hv"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hw hx bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hy" data-testid="authorName" href="https://rebremer.medium.com/?source=post_page---byline--5d21df7b8562--------------------------------" rel="noopener follow">René Bremer</a></p></div></div></div><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hw hx dx"><button class="ib ic ah ai aj ak al am an ao ap aq ar id ie if" disabled="">Follow</button></p></div></div></span></div></div><div class="l ig"><span class="bf b bg z dx"><div class="ab cn ih ii ij"><div class="ik il ab"><div class="bf b bg z dx ab im"><span class="in l ig">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hy ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--5d21df7b8562--------------------------------" rel="noopener follow"><p class="bf b bg z io ip iq ir is it iu iv bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">7 min read</span><div class="iw ix l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Oct 10, 2024</span></div></span></div></span></div></div></div><div class="ab cp iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn"><div class="h k w ea eb q"><div class="kd l"><div class="ab q ke kf"><div class="pw-multi-vote-icon ed in kg kh ki"><div class=""><div class="kj kk kl km kn ko kp am kq kr ks ki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kt ku kv kw kx ky kz"><p class="bf b dy z dx"><span class="kk">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kj la lb ab q ee lc ld" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="le"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg></button></div></div></div><div class="ab q jo jp jq jr js jt ju jv jw jx jy jz ka kb kc"><div class="lf k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lg an ao ap id lh li lj" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep lk cn"><div class="l ae"><div class="ab cb"><div class="ll lm ln lo lp lq ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lg an ao ap id lr ls ld lt lu lv lw lx s ly lz ma mb mc md me u mf mg mh"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lg an ao ap id lr ls ld lt lu lv lw lx s ly lz ma mb mc md me u mf mg mh"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lg an ao ap id lr ls ld lt lu lv lw lx s ly lz ma mb mc md me u mf mg mh"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj mk"><img src="../Images/4de18df463f08ff5d5c76c52f55ae36d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k3Ty0C-BL7RtLI2WitdZxA.png"/></div></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">Skewed data distribution - image by <a class="af nb" href="https://unsplash.com/@vackground" rel="noopener ugc nofollow" target="_blank">Vackground.com on Unsplash</a></figcaption></figure><h1 id="1fe8" class="nc nd fq bf ne nf ng gq nh ni nj gt nk nl nm nn no np nq nr ns nt nu nv nw nx bk">1. Introduction</h1><p id="3b52" class="pw-post-body-paragraph ny nz fq oa b go ob oc od gr oe of og oh oi oj ok ol om on oo op oq or os ot fj bk">Azure Data Factory (ADF) is a popular tool for moving data at scale, particularly in Enterprise Data Lakes. It is commonly used to ingest and transform data, often starting by copying data from on-premises to Azure Storage. From there, data is moved through different zones following a medallion architecture. ADF is also essential for creating and restoring backups in case of disasters like data corruption, malware, or account deletion.</p><p id="3899" class="pw-post-body-paragraph ny nz fq oa b go ou oc od gr ov of og oh ow oj ok ol ox on oo op oy or os ot fj bk">This implies that ADF is used to move large amounts of data, TBs and sometimes even PBs. It is thus important to optimize copy performance and so to limit throughput time. A common way to improve ADF performance is to parallelize copy activities. However, the parallelization shall happen where most of the data is and this can be challenging when the data lake is skewed.</p><p id="9403" class="pw-post-body-paragraph ny nz fq oa b go ou oc od gr ov of og oh ow oj ok ol ox on oo op oy or os ot fj bk">In this blog post, different ADF parallelization strategies are discussed for data lakes and a project is deployed. The ADF solution project can be found in this link: <code class="cx oz pa pb pc b"><a class="af nb" href="https://github.com/rebremer/data-factory-copy-skewed-data-lake" rel="noopener ugc nofollow" target="_blank">https://github.com/rebremer/data-factory-copy-skewed-data-lake</a></code>.</p><h1 id="536b" class="nc nd fq bf ne nf ng gq nh ni nj gt nk nl nm nn no np nq nr ns nt nu nv nw nx bk">2. Data lake data distribution</h1><p id="2b76" class="pw-post-body-paragraph ny nz fq oa b go ob oc od gr oe of og oh oi oj ok ol om on oo op oq or os ot fj bk">Data Lakes come in all sizes and manners. It is important to understand the data distribution within a data lake to improve copy performance. Consider the following situation:</p><ul class=""><li id="b7b7" class="ny nz fq oa b go ou oc od gr ov of og oh ow oj ok ol ox on oo op oy or os ot pd pe pf bk">An Azure Storage account has N containers.</li><li id="87ce" class="ny nz fq oa b go pg oc od gr ph of og oh pi oj ok ol pj on oo op pk or os ot pd pe pf bk">Each container contains M folders and m levels of sub folders.</li><li id="0f45" class="ny nz fq oa b go pg oc od gr ph of og oh pi oj ok ol pj on oo op pk or os ot pd pe pf bk">Data is evenly distributed in folders N/M/..</li></ul><p id="0af7" class="pw-post-body-paragraph ny nz fq oa b go ou oc od gr ov of og oh ow oj ok ol ox on oo op oy or os ot fj bk">See also image below:</p><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj pl"><img src="../Images/c936540c36846cda676a41e772e8bf64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9SZWOVife0qmSv-tpOBVXw.png"/></div></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">2.1 Data lake with uniformly distributed data — image by author</figcaption></figure><p id="ace5" class="pw-post-body-paragraph ny nz fq oa b go ou oc od gr ov of og oh ow oj ok ol ox on oo op oy or os ot fj bk">In this situation, copy activities can be parallelized on each container N. For larger data volumes, performance can be further enhanced by parallelizing on folders M within container N. Subsequently, per copy activity it can be configured how much <a class="af nb" href="https://learn.microsoft.com/en-us/azure/data-factory/copy-activity-performance-features#data-integration-units" rel="noopener ugc nofollow" target="_blank">Data Integration Units (DIU)</a> and <a class="af nb" href="https://learn.microsoft.com/en-us/azure/data-factory/copy-activity-performance-features#parallel-copy" rel="noopener ugc nofollow" target="_blank">copy parallelization</a> <em class="pm">within </em>a copy activity is used.</p><p id="f29b" class="pw-post-body-paragraph ny nz fq oa b go ou oc od gr ov of og oh ow oj ok ol ox on oo op oy or os ot fj bk">Now consider the following extreme situation that the last folder Nk and Mk has 99% of data, see image below:</p><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj pn"><img src="../Images/9ab71d065115517c8f4f210c011abeab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DmdENlk6ePve639twQxETA.png"/></div></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">2.2 Data lake with skewed distributed data — image by author</figcaption></figure><p id="8a2b" class="pw-post-body-paragraph ny nz fq oa b go ou oc od gr ov of og oh ow oj ok ol ox on oo op oy or os ot fj bk">This implies that parallelization shall be done on the sub folders in Nk/Mk where the data is. More advanced logic is then needed to pinpoint the exact data locations. An Azure Function, integrated within ADF, can be used to achieve this. In the next chapter a project is deployed and are the parallelization options discussed in more detail.</p><h1 id="1cb9" class="nc nd fq bf ne nf ng gq nh ni nj gt nk nl nm nn no np nq nr ns nt nu nv nw nx bk">3. Parallelization strategy in ADF project</h1><p id="11b1" class="pw-post-body-paragraph ny nz fq oa b go ob oc od gr oe of og oh oi oj ok ol om on oo op oq or os ot fj bk">In this part, the project is deployed and a copy test is run and discussed. The entire project can be found in project: <code class="cx oz pa pb pc b"><a class="af nb" href="https://github.com/rebremer/data-factory-copy-skewed-data-lake" rel="noopener ugc nofollow" target="_blank">https://github.com/rebremer/data-factory-copy-skewed-data-lake</a></code>.</p><h2 id="c61b" class="po nd fq bf ne pp pq pr nh ps pt pu nk oh pv pw px ol py pz qa op qb qc qd qe bk"><strong class="al">3.1 Deploy project</strong></h2><p id="a368" class="pw-post-body-paragraph ny nz fq oa b go ob oc od gr oe of og oh oi oj ok ol om on oo op oq or os ot fj bk">Run the script <code class="cx oz pa pb pc b"><a class="af nb" href="https://github.com/rebremer/data-factory-copy-skewed-data-lake/blob/main/deploy_adf.ps1" rel="noopener ugc nofollow" target="_blank">deploy_adf.ps1</a></code>. In case ADF is successfully deployed, there are two pipelines deployed:</p><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj qf"><img src="../Images/33e2f24a37024fac1c86bfb1020eb5c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8JXEDGyObRJWI3kkoixB_w.png"/></div></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">3.1.1 Data Factory project with root and child pipeline — image by author</figcaption></figure><p id="48a2" class="pw-post-body-paragraph ny nz fq oa b go ou oc od gr ov of og oh ow oj ok ol ox on oo op oy or os ot fj bk">Subsequently, run the script <code class="cx oz pa pb pc b"><a class="af nb" href="https://github.com/rebremer/data-factory-copy-skewed-data-lake/blob/main/deploy_azurefunction.ps1" rel="noopener ugc nofollow" target="_blank">deploy_azurefunction.ps1</a>. </code>In case the Azure Function is successfully deployed, the following code is deployed.</p><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj qg"><img src="../Images/b5c986bba658ee55871cf44775f6d265.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*af1LdNuDuqwclEW08WRIIw.png"/></div></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">3.1.2 Azure Function to find “pockets of data” such that ADF can better parallelize</figcaption></figure><p id="06b9" class="pw-post-body-paragraph ny nz fq oa b go ou oc od gr ov of og oh ow oj ok ol ox on oo op oy or os ot fj bk">To finally run the project, make sure that the system assigned managed identity of the Azure Function and Data Factory can access the storage account where the data is copied from and to.</p><h2 id="65ee" class="po nd fq bf ne pp pq pr nh ps pt pu nk oh pv pw px ol py pz qa op qb qc qd qe bk">3.2 Parallelization used in project</h2><p id="c669" class="pw-post-body-paragraph ny nz fq oa b go ob oc od gr oe of og oh oi oj ok ol om on oo op oq or os ot fj bk">After the project is deployed, it can be noticed that the following tooling is deployed to improve the performance using parallelization.</p><ul class=""><li id="c72c" class="ny nz fq oa b go ou oc od gr ov of og oh ow oj ok ol ox on oo op oy or os ot pd pe pf bk"><strong class="oa fr">Root pipeline:</strong> Root pipeline that lists containers N on storage account and triggers child pipeline for each container.</li><li id="4365" class="ny nz fq oa b go pg oc od gr ph of og oh pi oj ok ol pj on oo op pk or os ot pd pe pf bk"><strong class="oa fr">Child pipeline: </strong>Child pipeline that lists folders M in a container and triggers recursive copy activity for each folder.</li><li id="254d" class="ny nz fq oa b go pg oc od gr ph of og oh pi oj ok ol pj on oo op pk or os ot pd pe pf bk"><strong class="oa fr">Switch:</strong> Child pipeline uses a switch to decide how list folders shall be determined. For case “default” (even), Get Metadata is used, for case “uneven” an Azure Function is used.</li><li id="e989" class="ny nz fq oa b go pg oc od gr ph of og oh pi oj ok ol pj on oo op pk or os ot pd pe pf bk"><strong class="oa fr">Get Metadata:</strong> List all root folders M in a given container N.</li><li id="3851" class="ny nz fq oa b go pg oc od gr ph of og oh pi oj ok ol pj on oo op pk or os ot pd pe pf bk"><strong class="oa fr">Azure Function</strong>: List all folders and sub folders that contain no more than X GB of data and shall be copied as a whole.</li><li id="8e83" class="ny nz fq oa b go pg oc od gr ph of og oh pi oj ok ol pj on oo op pk or os ot pd pe pf bk"><strong class="oa fr">Copy activity</strong>: Recursively copy for all data from a given folder.</li><li id="db14" class="ny nz fq oa b go pg oc od gr ph of og oh pi oj ok ol pj on oo op pk or os ot pd pe pf bk"><strong class="oa fr">DIU</strong>: Number of Data Integration Units per copy activity.</li><li id="f40d" class="ny nz fq oa b go pg oc od gr ph of og oh pi oj ok ol pj on oo op pk or os ot pd pe pf bk"><strong class="oa fr">Copy parallelization: </strong><em class="pm">Within </em>a copy activity, number of parallel copy threads that can be started. Each thread can copy a file, maximum of 50 threads.</li></ul><p id="eee2" class="pw-post-body-paragraph ny nz fq oa b go ou oc od gr ov of og oh ow oj ok ol ox on oo op oy or os ot fj bk">In the uniformly distributed data lake, data is evenly distributed over N containers and M folders. In this situation, copy activities can just be parallelized on each folder M. This can be done using a Get Meta Data to list folders M, For Each to iterate over folders and copy activity per folder. See also image below.</p><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj qh"><img src="../Images/066f8e743fc246708fa65ffd7ccac3ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8CDC_IxbY1E13yBlg2q7oA.png"/></div></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">3.2.1 Child pipeline structure focusing on uniformly distributed data</figcaption></figure><p id="0a36" class="pw-post-body-paragraph ny nz fq oa b go ou oc od gr ov of og oh ow oj ok ol ox on oo op oy or os ot fj bk">Using this strategy, this would imply that each copy activity is going to copy an equal amount of data. A total of N*M copy activities will be run.</p><p id="94cd" class="pw-post-body-paragraph ny nz fq oa b go ou oc od gr ov of og oh ow oj ok ol ox on oo op oy or os ot fj bk">In the skewed distributed data lake, data is not evenly distributed over N containers and M folders. In this situation, copy activities shall be dynamically determined. This can be done using an Azure Function to list the data heavy folders, then a For Each to iterate over folders and copy activity per folder. See also image below.</p><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj qh"><img src="../Images/b7d66e1c87a3a493ed1c279bf3a525e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-42p6ZhCjZGszbJcWjnm2g.png"/></div></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">3.2.2 Child pipeline structure focusing on skewed distributed data</figcaption></figure><p id="7ff0" class="pw-post-body-paragraph ny nz fq oa b go ou oc od gr ov of og oh ow oj ok ol ox on oo op oy or os ot fj bk">Using this strategy, copy activities are dynamically scaled in data lake where data can be found and parallelization is thus needed most. Although this solution is more complex than the previous solution since it requires an Azure Function, it allows for copying skewed distributed data.</p><h2 id="2cd2" class="po nd fq bf ne pp pq pr nh ps pt pu nk oh pv pw px ol py pz qa op qb qc qd qe bk">3.3: Parallelization performance test</h2><p id="c141" class="pw-post-body-paragraph ny nz fq oa b go ob oc od gr oe of og oh oi oj ok ol om on oo op oq or os ot fj bk">To compare the performance of different parallelization options, a simple test is set up as follows:</p><ul class=""><li id="ad72" class="ny nz fq oa b go ou oc od gr ov of og oh ow oj ok ol ox on oo op oy or os ot pd pe pf bk">Two storage accounts and 1 ADF instance using an Azure IR in region westeurope. Data is copied from source to target storage account.</li><li id="b1c6" class="ny nz fq oa b go pg oc od gr ph of og oh pi oj ok ol pj on oo op pk or os ot pd pe pf bk">Source storage account contains three containers with 0.72 TB of data each spread over multiple folders and sub folders.</li><li id="0ed9" class="ny nz fq oa b go pg oc od gr ph of og oh pi oj ok ol pj on oo op pk or os ot pd pe pf bk">Data is evenly distributed over containers, no skewed data.</li></ul><p id="791e" class="pw-post-body-paragraph ny nz fq oa b go ou oc od gr ov of og oh ow oj ok ol ox on oo op oy or os ot fj bk">Test A: Copy 1 container with 1 copy activity using 32 DIU and 16 threads in copy activity (both set to auto) =&gt; 0.72 TB of data is copied, 12m27s copy time, average throughput is 0.99 GB/s</p><p id="bb69" class="pw-post-body-paragraph ny nz fq oa b go ou oc od gr ov of og oh ow oj ok ol ox on oo op oy or os ot fj bk">Test B: Copy 1 container with 1 copy activity using 128 DIU and 32 threads in copy activity =&gt; 0.72 TB of data is copied, 06m19s copy time, average throughput is 1.95 GB/s.</p><p id="e380" class="pw-post-body-paragraph ny nz fq oa b go ou oc od gr ov of og oh ow oj ok ol ox on oo op oy or os ot fj bk">Test C: Copy 1 container with 1 copy activity using 200 DIU and 50 threads (max) =&gt; test aborted due to throttling, no performance gain compared to test B.</p><p id="821e" class="pw-post-body-paragraph ny nz fq oa b go ou oc od gr ov of og oh ow oj ok ol ox on oo op oy or os ot fj bk">Test D: Copy 2 containers with 2 copy activities in parallel using 128 DIU and 32 threads for each copy activity =&gt; 1.44 TB of data is copied, 07m00s copy time, average throughput is 3.53 GB/s.</p><p id="a475" class="pw-post-body-paragraph ny nz fq oa b go ou oc od gr ov of og oh ow oj ok ol ox on oo op oy or os ot fj bk">Test E: Copy 3 containers with 3 copy activities in parallel using 128 DIU and 32 threads for each copy activity =&gt; 2.17 TB of data is copied, 08m07s copy time, average throughput is 4.56 GB/s. See also screenshot below.</p><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj qi"><img src="../Images/40bcd1131e29b613192084883172f6ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SaC9xKoNjyXybAf1ouAtDg.png"/></div></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">3.3 Test E: Copy throughput of 3 parallel copy activities of 128 DIU and 32 threads, data size is 3*0.72TB</figcaption></figure><p id="cb26" class="pw-post-body-paragraph ny nz fq oa b go ou oc od gr ov of og oh ow oj ok ol ox on oo op oy or os ot fj bk">In this, it shall be noticed that ADF does not immediately start copying since there is a startup time. For an Azure IR this is ~10 seconds. This startup time is fixed and its impact on throughput can be neglected for large copies. Also, maximum ingress of a storage account is <a class="af nb" href="https://learn.microsoft.com/en-us/azure/storage/common/scalability-targets-standard-account#scale-targets-for-standard-storage-accounts" rel="noopener ugc nofollow" target="_blank">60 Gbps</a> (=7.5 GB/s). There cannot be scaled above this number, unless additional capacity is requested on the storage account.</p><p id="ae53" class="pw-post-body-paragraph ny nz fq oa b go ou oc od gr ov of og oh ow oj ok ol ox on oo op oy or os ot fj bk">The following takeaways can be drawn from the test:</p><ul class=""><li id="7aaa" class="ny nz fq oa b go ou oc od gr ov of og oh ow oj ok ol ox on oo op oy or os ot pd pe pf bk">Significant performance can already be gained by increasing DIU and parallel settings <em class="pm">within </em>copy activity.</li><li id="7c82" class="ny nz fq oa b go pg oc od gr ph of og oh pi oj ok ol pj on oo op pk or os ot pd pe pf bk">By running copy pipelines in parallel, performance can be further increased.</li><li id="ed41" class="ny nz fq oa b go pg oc od gr ph of og oh pi oj ok ol pj on oo op pk or os ot pd pe pf bk">In this test, data was uniformly distributed across two containers. If the data had been skewed, with all data from container 1 located in a sub folder of container 2, both copy activities would need to target container 2. This ensures similar performance to Test D.</li><li id="0340" class="ny nz fq oa b go pg oc od gr ph of og oh pi oj ok ol pj on oo op pk or os ot pd pe pf bk">If the data location is unknown beforehand or deeply nested, an Azure Function would be needed to identify the data pockets to make sure the copy activities run in the right place.</li></ul><h1 id="21f8" class="nc nd fq bf ne nf ng gq nh ni nj gt nk nl nm nn no np nq nr ns nt nu nv nw nx bk">4. Conclusion</h1><p id="46fc" class="pw-post-body-paragraph ny nz fq oa b go ob oc od gr oe of og oh oi oj ok ol om on oo op oq or os ot fj bk">Azure Data Factory (ADF) is a popular tool to move data at scale. It is widely used for ingesting, transforming, backing up, and restoring data in Enterprise Data Lakes. Given its role in moving large volumes of data, optimizing copy performance is crucial to minimize throughput time.</p><p id="86fa" class="pw-post-body-paragraph ny nz fq oa b go ou oc od gr ov of og oh ow oj ok ol ox on oo op oy or os ot fj bk">In this blog post, we discussed the following parallelization strategies to enhance the performance of data copying to and from Azure Storage.</p><ul class=""><li id="9fbb" class="ny nz fq oa b go ou oc od gr ov of og oh ow oj ok ol ox on oo op oy or os ot pd pe pf bk"><em class="pm">Within </em>a copy activity, utilize standard Data Integration Units (DIU) and parallelization threads within a copy activity.</li><li id="e82b" class="ny nz fq oa b go pg oc od gr ph of og oh pi oj ok ol pj on oo op pk or os ot pd pe pf bk">Run copy activities in parallel. If data is known to be evenly distributed, standard functionality in ADF can be used to parallelize copy activities across each container (N) and root folder (M).</li><li id="26ed" class="ny nz fq oa b go pg oc od gr ph of og oh pi oj ok ol pj on oo op pk or os ot pd pe pf bk">Run copy activities where the data is. In case this is not known on beforehand or deeply nested, an Azure Function can be leveraged to locate the data. However, incorporating an Azure Function within an ADF pipeline adds complexity and should be avoided when not needed.</li></ul><p id="db21" class="pw-post-body-paragraph ny nz fq oa b go ou oc od gr ov of og oh ow oj ok ol ox on oo op oy or os ot fj bk">Unfortunately, there is no silver bullet solution and it always requires analyses and testing to find the best strategy to improve copy performance for Enterprise Data Lakes. This article aimed to give guidance in choosing the best strategy.</p></div></div></div></div>    
</body>
</html>