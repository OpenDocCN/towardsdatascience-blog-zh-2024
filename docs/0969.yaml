- en: Towards Reliable Synthetic Control
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 原文：[https://towardsdatascience.com/towards-reliable-synthetic-control-156106a1a7cb?source=collection_archive---------10-----------------------#2024-04-16](https://towardsdatascience.com/towards-reliable-synthetic-control-156106a1a7cb?source=collection_archive---------10-----------------------#2024-04-16)
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: Making the estimated treatment effect close to the truth
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: '[](https://medium.com/@hangyu_5199?source=post_page---byline--156106a1a7cb--------------------------------)[![Hang
    Yu](../Images/feb12ff14af31f9875ea2ad121d5a41e.png)](https://medium.com/@hangyu_5199?source=post_page---byline--156106a1a7cb--------------------------------)[](https://towardsdatascience.com/?source=post_page---byline--156106a1a7cb--------------------------------)[![Towards
    Data Science](../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png)](https://towardsdatascience.com/?source=post_page---byline--156106a1a7cb--------------------------------)
    [Hang Yu](https://medium.com/@hangyu_5199?source=post_page---byline--156106a1a7cb--------------------------------)'
  prefs: []
  type: TYPE_NORMAL
- en: ·Published in [Towards Data Science](https://towardsdatascience.com/?source=post_page---byline--156106a1a7cb--------------------------------)
    ·7 min read·Apr 16, 2024
  prefs: []
  type: TYPE_NORMAL
- en: --
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/eb95de0aa20bbae59206eab33ec61516.png)'
  prefs: []
  type: TYPE_IMG
- en: Photo by [Jørgen Håland](https://unsplash.com/@jhaland?utm_source=medium&utm_medium=referral)
    on [Unsplash](https://unsplash.com/?utm_source=medium&utm_medium=referral)
  prefs: []
  type: TYPE_NORMAL
- en: Introduction
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: In recent years, the Synthetic Control (SC) approach has gained increasing adoption
    in industry for measuring the the Average Treatment Effect (ATE) of interventions
    when Randomized Control Trials (RCTs) are not available. One such example is measuring
    the financial impact of outdoor advertisements on billboards whereby we cannot
    conduct random treatment assignment in practice.
  prefs: []
  type: TYPE_NORMAL
- en: The basic idea of SC is to estimate ATE by comparing the treatment group against
    the predicted counterfactual. However, applying SC in practice is usually challenged
    by the limited knowledge of its validity due to the absence of the true counterfactual
    in the real world. To mitigate the concern, in this article, I would like to discuss
    the actionable best practices that help to maximise the reliability of the SC
    estimation.
  prefs: []
  type: TYPE_NORMAL
- en: The insights and conclusions are obtained through experiments based on diverse
    synthetic data. The code for data generation, causal inference modeling, and analysis
    is available in the Jupyter notebook hosted on [Github](https://github.com/simon19891101/ML_experiments/blob/main/sc_reliability.ipynb).
  prefs: []
  type: TYPE_NORMAL
- en: Synthetic Control in a Nutshell
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: The key to measure the ATE of such events is to identify the counterfactual
    of the treatment group, which is the treatment group in the absence of the treatment,
    and quantify the post-treatment difference between the two. It is simple for RCTs
    as the randomised control statistically approximates the counterfactual. However,
    it’s challenging otherwise due to the unequal pre-experiment statistics between
    the treatment and control.
  prefs: []
  type: TYPE_NORMAL
- en: 'As a causal inference technique, SC represents the counterfactual by a synthetic
    control group created based on some untreated control units. This synthetic control
    group statistically equals the treatment group pre treatment and is expected to
    approximate the untreated behaviour of the treatment group post treatment. Mathematically
    presented below, it is created using the function *f* whose parameters are obtained
    by minimising the pre-treatment difference between the treated group and the control
    synthesised by *f* [1]:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/ccb82095d449247db6f520792528b8ee.png)'
  prefs: []
  type: TYPE_IMG
- en: In the experiment, there are J groups whereby group 1 is the treatment group
    and others are controls. Each group has its observed outcome at time t denoted
    by Yjt. f is the model and Y1t^N refers to the counterfactual. Image by author.
  prefs: []
  type: TYPE_NORMAL
- en: In practice, the popular options for the function *f* include but are not limited
    totheweighted sum [1], Bayesian Structural Time Series (BSTS) [2], etc.
  prefs: []
  type: TYPE_NORMAL
- en: Actions towards Reliable Synthetic Control
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Despite the solid theoretical foundation, applying SC in practice usually faces
    the challenge that we don’t know how accurate the estimated ATE is because there
    exists no post-treatment counterfactual in reality to validate the synthesised
    one. However, there are some actions we can take to optimise the modeling process
    and maximise the reliability. Next, I will describe these actions and demonstrate
    how they influence the estimated ATE via a range of experiments based on the synthetic
    time-series data with diverse temporal characteristics.
  prefs: []
  type: TYPE_NORMAL
- en: '**Experiment Setup**'
  prefs: []
  type: TYPE_NORMAL
- en: All the experiments presented in this article are based on synthetic time-series
    data. These data are generated using the *timeseries-generator* package that produces
    time series capturing the real-world factors including GDP, holidays, weekends,
    and so on.
  prefs: []
  type: TYPE_NORMAL
- en: '[](https://github.com/Nike-Inc/timeseries-generator/tree/master?source=post_page-----156106a1a7cb--------------------------------)
    [## GitHub — Nike-Inc/timeseries-generator: A library to generate synthetic time
    series data by…'
  prefs: []
  type: TYPE_NORMAL
- en: A library to generate synthetic time series data by easy-to-use factors and
    generator — Nike-Inc/timeseries-generator
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: github.com](https://github.com/Nike-Inc/timeseries-generator/tree/master?source=post_page-----156106a1a7cb--------------------------------)
  prefs: []
  type: TYPE_NORMAL
- en: The data generation aims to simulate the campaign performance of the stores
    in New Zealand from 01/01/2019 to 31/12/2019\. To make the potential conclusions
    statistically significant, 500 time series are generated to represent the stores.
    Each time series has the statistically randomised linear trend, white noise, store
    factor, holiday factor, weekday factor, and seasonality. A random sample of 10
    stores are presented below.
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/39da389cc3047302d4c018b1f29e5acc.png)'
  prefs: []
  type: TYPE_IMG
- en: Randomly sampled synthetic time series for 10 stores in New Zealand. Image by
    author.
  prefs: []
  type: TYPE_NORMAL
- en: Store1 is selected to be the treatment group whereas others play the role of
    control groups. Next, the outcome of store1 is uplifted by 20% from 2019-09-01
    onwards to simulate the treated behaviour whereas its original outcome serves
    as the real counterfactual. This 20% uplift establishes the actual ATE to validate
    the actions later on.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: The figure below visualises the simulated treatment effect and the true counterfactual
    of the treatment group.
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/6f77c0f19357bf38fa330e96c1b3eba9.png)'
  prefs: []
  type: TYPE_IMG
- en: The simulated ATE of +20% and the true counterfactual of store1\. Image by author.
  prefs: []
  type: TYPE_NORMAL
- en: Given the synthetic data, the BSTS in Causalimpact is adopted to estimate the
    synthesised ATE. Then, the estimation is compared against the actual ATE using
    Mean Absolute Percentage Error (MAPE) to evaluate the corresponding action.
  prefs: []
  type: TYPE_NORMAL
- en: '[](https://github.com/jamalsenouci/causalimpact/tree/master?source=post_page-----156106a1a7cb--------------------------------)
    [## GitHub — jamalsenouci/causalimpact: Python port of CausalImpact R library'
  prefs: []
  type: TYPE_NORMAL
- en: Python port of CausalImpact R library. Contribute to jamalsenouci/causalimpact
    development by creating an account on…
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: github.com](https://github.com/jamalsenouci/causalimpact/tree/master?source=post_page-----156106a1a7cb--------------------------------)
  prefs: []
  type: TYPE_NORMAL
- en: Next, let’s go through the actions along with the related experiments to see
    how to produce reliable ATE estimation.
  prefs: []
  type: TYPE_NORMAL
- en: '**Treatment-control Correlation**'
  prefs: []
  type: TYPE_NORMAL
- en: The first action to achieve reliable ATE estimation is selecting the control
    groups that exhibit high pre-treatment correlations with the treatment group.
    The rationale is that a highly correlated control is likely to consistently resemble
    the untreated treatment group over time.
  prefs: []
  type: TYPE_NORMAL
- en: To validate this hypothesis, let’s evaluate the ATE estimation produced using
    every single control with its full data since 01/01/2019 to understand the impact
    of correlation. Firstly, the correlation coefficients between the treatment group
    (store1) and the control groups (store2 to 499) are calculated [3].
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: As shown in the figure below, the distribution of the correlations range from
    -0.1 to 0.9, which provides a comprehensive understanding about the impact across
    various scenarios.
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/57a4d48a0f278fc2e34884da82890db2.png)'
  prefs: []
  type: TYPE_IMG
- en: Distribution of the pre-treatment correlation. Image by author.
  prefs: []
  type: TYPE_NORMAL
- en: Then, every individual control is used to predict the counterfactual, estimate
    the ATE, and report the MAPE. In the figure below, the averaged MAPE of ATE with
    its 95% confidence interval is plotted against the corresponding pre-treatment
    correlation. Here, the correlation coefficients are rounded to one decimal place
    to facilitate aggregation and improve the statistical significance in the analysis.
    Looking at the results, it is obvious that the estimation shows a higher reliability
    when the control gets more correlated with the treatment group.
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/8bb621fd0777b123764e2a4376e462a7.png)'
  prefs: []
  type: TYPE_IMG
- en: The MAPE of ATE for different correlation levels. Image by author.
  prefs: []
  type: TYPE_NORMAL
- en: 'Now let’s see some examples that demonstrate the impact of pre-treatment correlation:
    store88 with a correlation of 0.88 delivers a MAPE of 0.12 that is superior to
    0.62 given by store3 with a correlation of 0.43\. Besides the promising accuracy,
    the probabilistic intervals are correspondingly narrow, which implies high prediction
    certainty.'
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/d424496ce2675f0f2d080ddb982e67d5.png)'
  prefs: []
  type: TYPE_IMG
- en: Example to demonstrate the impact of correlation. Image by author.
  prefs: []
  type: TYPE_NORMAL
- en: '**Model Fitting Window**'
  prefs: []
  type: TYPE_NORMAL
- en: Next, the fitting window, which is the length of the pre-treatment interval
    used for fitting the model, needs to be properly configured. This is because too
    much context could result in a loss of recency while insufficient context might
    lead to overfitting.
  prefs: []
  type: TYPE_NORMAL
- en: To understand how fitting window impacts the accuracy of ATE estimation, a wide
    range of values from 1 month to 8 months before the treatment date are experimented.
    For each fitting window, every single unit of the 499 control groups is evaluated
    individually and then aggregated to calculate the averaged MAPE with the 95% confidence
    interval. As depicted in the figure below, there exists a sweet spot nearby 2
    and 3 months that optimise the reliability. Identifying the optimal point is outside
    the scope of this discussion but it’s worth noting that the training window needs
    to be carefully selected.
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/5c883c0d27917417c399a6f213d8c4b5.png)'
  prefs: []
  type: TYPE_IMG
- en: The MAPE of ATE for different training windows. Image by author.
  prefs: []
  type: TYPE_NORMAL
- en: 'The figure shows two examples: the MAPE of control group 199 is reduced from
    0.89 to 0.68 when its fitting window is increased from 1 month to 3 months because
    the short window contains insufficient knowledge to produce the counterfactual.'
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/d560703f856911244947cdd60cec747b.png)'
  prefs: []
  type: TYPE_IMG
- en: Example to demonstrate the impact of training window. Image by author.
  prefs: []
  type: TYPE_NORMAL
- en: '**Number of Control Units**'
  prefs: []
  type: TYPE_NORMAL
- en: Lastly, the number of the selected control groups matters.
  prefs: []
  type: TYPE_NORMAL
- en: This hypothesis is validated by investigating the estimation accuracy for different
    numbers of controls ranging from 1 to 10\. In detail, for each control count,
    the averaged MAPE is calculated based on the estimations produced by 50 random
    control sets with each containing the corresponding number of control groups.
    This operation avoids unnecessarily enumerating every possible combination of
    controls while statistically controls for correlation. In addition, the fitting
    window is set to 3 months for every estimation.
  prefs: []
  type: TYPE_NORMAL
- en: Looking at the results below, increasing the number of controls is overall leading
    towards a more reliable ATE estimation.
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/fe4b7d2cd20f809b7c4eadbc5493bc8e.png)'
  prefs: []
  type: TYPE_IMG
- en: The MAPE of ATE for different number of controls. Image by author.
  prefs: []
  type: TYPE_NORMAL
- en: The examples below demonstrate the effect. The first estimation is generated
    using store311 whereas the second one further adds store301 and store312.
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/dfcdc45b31e211a635dd8aa206a3fe2d.png)'
  prefs: []
  type: TYPE_IMG
- en: Example to demonstrate the impact of number of controls. Image by author.
  prefs: []
  type: TYPE_NORMAL
- en: Conclusions
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: In this article, I discussed the possible actions that make the SC estimation
    more reliable. Based on the experiments with diverse synthetic data, the pre-treatment
    correlation, fitting window, and number of control units are identified as compelling
    directions to optimise the estimation. Finding the optimal value for each action
    is out of the scope of this discussion. However, if you feel interested, parameter
    search using an isolated blank period for validation [4] is one possible solution.
  prefs: []
  type: TYPE_NORMAL
- en: '*All the images are produced by the author unless otherwise noted. The discussions
    are inspired by the great work “Synthetic controls in action” [1].*'
  prefs: []
  type: TYPE_NORMAL
- en: References
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: '[1] Abadie, Alberto, and Jaume Vives-i-Bastida. “Synthetic controls in action.”
    *arXiv preprint arXiv:2203.06279* (2022).'
  prefs: []
  type: TYPE_NORMAL
- en: '[2]Brodersen, Kay H., et al. “Inferring causal impact using Bayesian structural
    time-series models.” (2015): 247–274.'
  prefs: []
  type: TYPE_NORMAL
- en: '[3]https://medium.com/@dreamferus/how-to-synchronize-time-series-using-cross-correlation-in-python-4c1fd5668c7a'
  prefs: []
  type: TYPE_NORMAL
- en: '[4]Abadie, Alberto, and Jinglong Zhao. “Synthetic controls for experimental
    design.” *arXiv preprint arXiv:2108.02196* (2021).'
  prefs: []
  type: TYPE_NORMAL
