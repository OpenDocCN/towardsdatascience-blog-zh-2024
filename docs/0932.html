<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Write-Audit-Publish for Data Lakes in Pure Python (no JVM)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Write-Audit-Publish for Data Lakes in Pure Python (no JVM)</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/write-audit-publish-for-data-lakes-in-pure-python-no-jvm-25fbd971b17d?source=collection_archive---------4-----------------------#2024-04-12">https://towardsdatascience.com/write-audit-publish-for-data-lakes-in-pure-python-no-jvm-25fbd971b17d?source=collection_archive---------4-----------------------#2024-04-12</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="ad85" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx">An open source implementation of WAP using Apache Iceberg, Lambdas, and Project Nessie all running entirely Python</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hd he hf hg hh ab"><div><div class="ab hi"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@ciro.greco?source=post_page---byline--25fbd971b17d--------------------------------" rel="noopener follow"><div class="l hj hk by hl hm"><div class="l ed"><img alt="Ciro Greco" class="l ep by dd de cx" src="../Images/4a20e5d435998e8d8ff7aeac1f8ff60d.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/1*oPsYVADVsqrHa-AkfpQj1Q.jpeg"/><div class="hn by l dd de em n ho eo"/></div></div></a></div></div><div class="hp ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--25fbd971b17d--------------------------------" rel="noopener follow"><div class="l hq hr by hl hs"><div class="l ed"><img alt="Towards Data Science" class="l ep by br ht cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hn by l br ht em n ho eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hu ab q"><div class="ab q hv"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hw hx bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hy" data-testid="authorName" href="https://medium.com/@ciro.greco?source=post_page---byline--25fbd971b17d--------------------------------" rel="noopener follow">Ciro Greco</a></p></div></div></div><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hw hx dx"><button class="ib ic ah ai aj ak al am an ao ap aq ar id ie if" disabled="">Follow</button></p></div></div></span></div></div><div class="l ig"><span class="bf b bg z dx"><div class="ab cn ih ii ij"><div class="ik il ab"><div class="bf b bg z dx ab im"><span class="in l ig">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hy ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--25fbd971b17d--------------------------------" rel="noopener follow"><p class="bf b bg z io ip iq ir is it iu iv bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">9 min read</span><div class="iw ix l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Apr 12, 2024</span></div></span></div></span></div></div></div><div class="ab cp iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn"><div class="h k w ea eb q"><div class="kd l"><div class="ab q ke kf"><div class="pw-multi-vote-icon ed in kg kh ki"><div class=""><div class="kj kk kl km kn ko kp am kq kr ks ki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kt ku kv kw kx ky kz"><p class="bf b dy z dx"><span class="kk">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kj lc ld ab q ee le lf" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="lb"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg><p class="bf b dy z dx"><span class="pw-responses-count la lb">2</span></p></button></div></div></div><div class="ab q jo jp jq jr js jt ju jv jw jx jy jz ka kb kc"><div class="lg k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lh an ao ap id li lj lk" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep ll cn"><div class="l ae"><div class="ab cb"><div class="lm ln lo lp lq lr ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk ml"><img src="../Images/3f6c7fd882cb9f69244db1e5fe0bc7b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*9mLKIQDohi2hyrSS"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Look Ma: no JVM! Photo by <a class="af nc" href="https://unsplash.com/@zacong?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Zac Ong</a> on <a class="af nc" href="https://unsplash.com/?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="a24f" class="nd ne fq bf nf ng nh gq ni nj nk gt nl nm nn no np nq nr ns nt nu nv nw nx ny bk">Introduction</h1><p id="4605" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">In this blog post we provide a no-nonsense, reference implementation for Write-Audit-Publish (WAP) patterns on a data lake, using <a class="af nc" href="https://iceberg.apache.org/" rel="noopener ugc nofollow" target="_blank">Apache Iceberg</a> as an open table format, and <a class="af nc" href="https://projectnessie.org/" rel="noopener ugc nofollow" target="_blank">Project Nessie</a> as a data catalog supporting git-like semantics.</p><p id="0e32" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">We chose <a class="af nc" href="https://projectnessie.org/" rel="noopener ugc nofollow" target="_blank">Nessie</a> because its branching capabilities provide a good abstraction to implement a WAP design. Most importantly, we chose to build on <a class="af nc" href="https://py.iceberg.apache.org/" rel="noopener ugc nofollow" target="_blank">PyIceberg</a> to eliminate the need for the JVM in terms of developer experience. In fact, to run the entire project, including the integrated applications we will only need Python and AWS.</p><p id="3b40" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">While <a class="af nc" href="https://projectnessie.org/" rel="noopener ugc nofollow" target="_blank">Nessie</a> is technically built in Java, the data catalog is run as a container by <a class="af nc" href="https://aws.amazon.com/lightsail/" rel="noopener ugc nofollow" target="_blank">AWS Lightsail</a> in this project, we are going to interact with it only through its endpoint. Consequently, we can express the entire WAP logic, including the queries downstream, in Python only!</p><p id="5b14" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Because <a class="af nc" href="https://py.iceberg.apache.org/" rel="noopener ugc nofollow" target="_blank">PyIceberg</a> is fairly new, a bunch of things are actually not supported out of the box. In particular, writing is still in early days, and branching Iceberg tables is still not supported. So what you’ll find here is the result of some original work we did ourselves to make branching Iceberg tables in <a class="af nc" href="https://projectnessie.org/" rel="noopener ugc nofollow" target="_blank">Nessie</a> possible directly from Python.</p><p id="ec2c" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">So all this happened, more or less.</p><h1 id="2f36" class="nd ne fq bf nf ng nh gq ni nj nk gt nl nm nn no np nq nr ns nt nu nv nw nx ny bk">What on earth is WAP?</h1><p id="cae5" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">Back in 2017, Michelle Winters from Netflix <a class="af nc" href="https://www.youtube.com/watch?v=fXHdeBnpXrg" rel="noopener ugc nofollow" target="_blank">talked</a> about a design pattern called Write-Audit-Publish (WAP) in data. Essentially, WAP is a functional design aimed at making data quality checks easy to implement <strong class="ob fr">before</strong> the data become available to downstream consumers.</p><p id="b9ff" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">For instance, an atypical use case is data quality at ingestion. The flow will look like creating a staging environment and run quality tests on freshly ingested data, before making that data available to any downstream application.</p><p id="57d0" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">As the name betrays, there are essentially three phases:</p><ol class=""><li id="3566" class="nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou pa pb pc bk"><strong class="ob fr"><em class="pd">Write.</em> </strong>Put the data in a location that is not accessible to consumers downstream (e.g. a staging environment or a branch).</li><li id="7b6e" class="nz oa fq ob b go pe od oe gr pf og oh oi pg ok ol om ph oo op oq pi os ot ou pa pb pc bk"><strong class="ob fr"><em class="pd">Audit.</em></strong> Transform and test the data to make sure it meets the specifications (e.g. check whether the schema abruptly changed, or whether there are unexpected values, such as NULLs).</li><li id="be9d" class="nz oa fq ob b go pe od oe gr pf og oh oi pg ok ol om ph oo op oq pi os ot ou pa pb pc bk"><strong class="ob fr"><em class="pd">Publish.</em></strong> Put the data in the place where consumers can read it from (e.g. the production data lake).</li></ol><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk pj"><img src="../Images/fed5dd1e2f2e05ee22ab00dc9438b184.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sTUVIIhl-b-kWAl4JRwndg.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Image from the authors</figcaption></figure><p id="4c30" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">This is only one example of the possible applications of WAP patterns. It is easy to see how it can be applied at different stages of the data life-cycle, from ETL and data ingestion, to complex data pipelines supporting analytics and ML applications.</p><p id="89eb" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Despite being so useful, <a class="af nc" href="https://lakefs.io/blog/data-engineering-patterns-write-audit-publish/" rel="noopener ugc nofollow" target="_blank">WAP is still not very widespread</a>, and only recently companies have started thinking about it more systematically. The rise of open table formats and projects like <a class="af nc" href="https://projectnessie.org/" rel="noopener ugc nofollow" target="_blank">Nessie</a> and <a class="af nc" href="https://lakefs.io/" rel="noopener ugc nofollow" target="_blank">LakeFS</a> is accelerating the process, but it still a bit <em class="pd">avant garde</em>.</p><p id="de68" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">In any case, it is a very good way of thinking about data and it is extremely useful in taming some of the most widespread problems keeping engineers up at night. So let’s see how we can implement it.</p><h1 id="50d1" class="nd ne fq bf nf ng nh gq ni nj nk gt nl nm nn no np nq nr ns nt nu nv nw nx ny bk">WAP on a data lake in Python</h1><p id="4847" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">We are not going to have a theoretical discussion about WAP nor will we provide an exhaustive survey of the different ways to implement it (<a class="af nc" href="https://www.linkedin.com/in/alexmerced/" rel="noopener ugc nofollow" target="_blank">Alex Merced</a> from <a class="af nc" href="https://www.dremio.com/" rel="noopener ugc nofollow" target="_blank">Dremio</a> and <a class="af nc" href="https://www.linkedin.com/in/einat-orr-359ba6/" rel="noopener ugc nofollow" target="_blank">Einat Orr</a> from <a class="af nc" href="https://lakefs.io/" rel="noopener ugc nofollow" target="_blank">LakeFs</a> are already doing a phenomenal job at that). Instead, we will provide a reference implementation for WAP on a data lake.</p><blockquote class="pk"><p id="73f6" class="pl pm fq bf pn po pp pq pr ps pt ou dx">👉 <strong class="al">So buckle up, clone the </strong><a class="af nc" href="https://github.com/BauplanLabs/no-jvm-wap-with-iceberg" rel="noopener ugc nofollow" target="_blank">Repo</a><strong class="al">, and give it a spin!</strong></p><p id="69ae" class="pl pm fq bf pn po pp pq pr ps pt ou dx">📌 F<strong class="al">or more details, please refer to the </strong><a class="af nc" href="https://github.com/BauplanLabs/no-jvm-wap-with-iceberg/blob/main/README.md" rel="noopener ugc nofollow" target="_blank"><strong class="al">README</strong></a><strong class="al"> of the project.</strong></p></blockquote><h1 id="a6df" class="nd ne fq bf nf ng nh gq ni nj nk gt nl nm pu no np nq pv ns nt nu pw nw nx ny bk">Architecture and workflow</h1><p id="90e5" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">The idea here is to simulate an ingestion workflow and implement a WAP pattern by branching the data lake and running a data quality test before deciding whether to put the data into the final table into the data lake.</p><p id="1130" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">We use Nessie branching capabilities to get our sandboxed environment where data cannot be read by downstream consumers and AWS Lambda to run the WAP logic.</p><p id="3c47" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Essentially, each time a new parquet file is uploaded, a Lambda will go up, create a branch in the data catalog and append the data into an Iceberg table. Then, a simple a simple data quality test is performed with PyIceberg to check whether a certain column in the table contains some NULL values.</p><p id="1708" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk"><strong class="ob fr">If the answer is yes,</strong> the data quality test fails. The new branch will not be merged into the main branch of the data catalog, making the data impossible to be read in the main branch of data lake. Instead, an alert message is going to be sent to <a class="af nc" href="https://slack.com/" rel="noopener ugc nofollow" target="_blank">Slack</a>.</p><p id="24d9" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk"><strong class="ob fr">If the answer is no,</strong> and the data does not contain any NULLs, the data quality test is passed. The new branch will thus be merged into the <em class="pd">main </em>branch of the data catalog and the data will be appended in the Iceberg table in the data lake for other processes to read.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk pj"><img src="../Images/0cec8ad1994f7ffe5eea60bbdbf027ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AQVJOYpYUzlCdw-mfGVj0w.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Our WAP workflow: image from the authors</figcaption></figure><p id="7310" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">All data is completely synthetic and is generated automatically by simply running the project. Of course, we provide the possibility of choosing whether to generate data that complies with the data quality specifications or to generate data that include some NULL values.</p><p id="1fc2" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">To implement the whole end-to-end flow, we are going to use the following components:</p><ul class=""><li id="0379" class="nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou px pb pc bk">Storage: <a class="af nc" href="https://aws.amazon.com/s3/" rel="noopener ugc nofollow" target="_blank">AWS S3</a></li><li id="c3ca" class="nz oa fq ob b go pe od oe gr pf og oh oi pg ok ol om ph oo op oq pi os ot ou px pb pc bk">Open table format: <a class="af nc" href="https://iceberg.apache.org/" rel="noopener ugc nofollow" target="_blank">Apache Iceberg</a></li><li id="2692" class="nz oa fq ob b go pe od oe gr pf og oh oi pg ok ol om ph oo op oq pi os ot ou px pb pc bk">Data catalog: <a class="af nc" href="https://projectnessie.org/" rel="noopener ugc nofollow" target="_blank">Project Nessie</a></li><li id="ca0b" class="nz oa fq ob b go pe od oe gr pf og oh oi pg ok ol om ph oo op oq pi os ot ou px pb pc bk">Code implementation: <a class="af nc" href="https://py.iceberg.apache.org/" rel="noopener ugc nofollow" target="_blank">PyIceberg</a>, <a class="af nc" href="https://projectnessie.org/develop/python/" rel="noopener ugc nofollow" target="_blank">PyNessie</a></li><li id="862d" class="nz oa fq ob b go pe od oe gr pf og oh oi pg ok ol om ph oo op oq pi os ot ou px pb pc bk">Serverless runtime: <a class="af nc" href="https://aws.amazon.com/lambda/" rel="noopener ugc nofollow" target="_blank">Lambda</a></li><li id="46cf" class="nz oa fq ob b go pe od oe gr pf og oh oi pg ok ol om ph oo op oq pi os ot ou px pb pc bk">Virtual private server: <a class="af nc" href="https://aws.amazon.com/lightsail/" rel="noopener ugc nofollow" target="_blank">Lightsail</a></li><li id="8011" class="nz oa fq ob b go pe od oe gr pf og oh oi pg ok ol om ph oo op oq pi os ot ou px pb pc bk">Alerting system: <a class="af nc" href="https://slack.com/" rel="noopener ugc nofollow" target="_blank">Slack</a></li></ul><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk pj"><img src="../Images/50bd27c1f3c729677ca7ab2ea24ac596.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RV57UMjVy6m-fUH0NOKbkg.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Project architecture: image from the authors</figcaption></figure><p id="dc68" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">This project is pretty self-contained and comes with scripts to set up the entire infrastructure, so it requires only introductory-level familiarity with AWS and Python.</p><p id="9770" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">It’s also not intended to be a production-ready solution, but rather a reference implementation, a starting point for more complex scenarios: the code is verbose and heavily commented, making it easy to modify and extend the basic concepts to better suit anyone’s use cases.</p><h1 id="7ee8" class="nd ne fq bf nf ng nh gq ni nj nk gt nl nm nn no np nq nr ns nt nu nv nw nx ny bk">Visualize</h1><p id="6abe" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">To visualize the results of the data quality test, we provide a very simple <a class="af nc" href="https://streamlit.io/" rel="noopener ugc nofollow" target="_blank">Streamlit</a> app that can be used to see what happens when some new data is uploaded to first location on S3 — the one that is not available to downstream consumers.</p><p id="e808" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">We can use the app to check how many rows are in the table across the different branches, and for the branches other than <em class="pd">main</em>, it is easy to see in what column the data quality test failed and in how many rows.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk py"><img src="../Images/62d00f29924ccf899b8755c6a8e842ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u8oPGjaCWrf0dWnNtrOwNw.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Data quality app — this is what you see when you examine a certain upload branch (i.e. <em class="pz">emereal-keen-shame</em>) where a table of 3000 row was appended and did not pass the data quality check because one value in <em class="pz">my_col_1 is a NULL</em>. Image from the authors.</figcaption></figure><h1 id="2adc" class="nd ne fq bf nf ng nh gq ni nj nk gt nl nm nn no np nq nr ns nt nu nv nw nx ny bk">From the lake to the Lakehouse</h1><p id="5085" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">Once we have a WAP flow based on Iceberg, we can leverage it to implement a composable design for our downstream consumers. In our repo we provide instructions for a <a class="af nc" href="https://www.snowflake.com/en/" rel="noopener ugc nofollow" target="_blank">Snowflake</a> integration as a way to explore this architectural possibility.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk qa"><img src="../Images/b2208722df95aa1b1fbbeefe9c18dcc3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lXoUB8hR9qbM67fufpuMPg.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">The first step towards the Lakehouse: image from the authors</figcaption></figure><p id="1447" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">This is one of the main tenet of the <a class="af nc" href="https://www.databricks.com/sites/default/files/2020/12/cidr_lakehouse.pdf" rel="noopener ugc nofollow" target="_blank"><strong class="ob fr">Lakehouse</strong></a> architecture, conceived to be more flexible than modern data warehouses and more usable than traditional data lakes.</p><p id="344e" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">On the one hand, the Lakehouse hinges on leveraging object store to eliminate data redundancy and at the same time lower storage cost. On the other, it is supposed to provide more flexibility in choosing different compute engines for different purposes.</p><p id="8d57" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">All this sounds very interesting in theory, but it also sounds very complicated to engineer at scale. Even a simple integration between Snowflake and an S3 bucket as an external volume is frankly pretty tedious.</p><blockquote class="qb qc qd"><p id="7c4a" class="nz oa pd ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk"><strong class="ob fr"><em class="fq">And in fact, we cannot stress this enough, moving to a full Lakehouse architecture is a lot of work. Like a lot!</em></strong></p></blockquote><p id="4ca8" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Having said that, even a journey of a thousand miles begins with a single step, so why don’t we start by reaching out the lowest hanging fruits with simple but very tangible practical consequences?</p><p id="75de" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">The example in the repo showcases one of these simple use case: WAP and data quality tests. The WAP pattern here is a chance to move the computation required for data quality tests (and possibly for some ingestion ETL) <strong class="ob fr">outside the data warehouse,</strong> while still maintaining the possibility of taking advantage of Snowflake for more high value analyitcs workloads on certified artifacts. We hope that this post can help developers to build their own proof of concepts and use the</p><h1 id="6827" class="nd ne fq bf nf ng nh gq ni nj nk gt nl nm nn no np nq nr ns nt nu nv nw nx ny bk">Conclusions</h1><p id="7274" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">The reference implementation here proposed has several advantages:</p><h2 id="9411" class="qe ne fq bf nf qf qg qh ni qi qj qk nl oi ql qm qn om qo qp qq oq qr qs qt qu bk">Tables are better than files</h2><p id="41d0" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">Data lakes are historically hard to develop against, since the data abstractions are very different from those typically adopted in good old databases. Big Data frameworks like <a class="af nc" href="https://spark.apache.org/" rel="noopener ugc nofollow" target="_blank">Spark</a> first provided the capabilities to process large amounts of raw data stored as files in different formats (e.g. parquet, csv, etc), but people often do not think in terms of files: they think it terms of tables.</p><p id="8331" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">We use an open table format for this reason. Iceberg turns the main data lake abstraction into tables rather than files which makes things considerably more intuitive. We can now use SQL query engines natively to explore the data and we can count on Iceberg to take care of providing correct schema evolution.</p><h2 id="9bc8" class="qe ne fq bf nf qf qg qh ni qi qj qk nl oi ql qm qn om qo qp qq oq qr qs qt qu bk">Interoperability is good for ya</h2><p id="a757" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">Iceberg also allows for greater interoperability from an architectural point of view. One of the main benefits of using open table formats is that data can be kept in object store while high-performance SQL engines (Spark, <a class="af nc" href="https://trino.io/" rel="noopener ugc nofollow" target="_blank">Trino</a>, <a class="af nc" href="https://www.dremio.com/" rel="noopener ugc nofollow" target="_blank">Dremio</a>) and Warehouses (<a class="af nc" href="https://www.snowflake.com/en/" rel="noopener ugc nofollow" target="_blank">Snowflake</a>, <a class="af nc" href="https://aws.amazon.com/redshift/" rel="noopener ugc nofollow" target="_blank">Redshift</a>) can be used to query it. The fact that Iceberg is supported by the majority of computational engines out there has profound consequences for the way we can architect our data platform.</p><p id="dddc" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">As described above, our suggested integration with Snowflake is meant to show that one can deliberately move the computation needed for the ingestion ETL and the data quality tests outside of the Warehouse, and keep the the latter for large scale analytics jobs and last mile querying that require high performance. At scale, this idea can translate into significantly lower costs.</p><h2 id="56f7" class="qe ne fq bf nf qf qg qh ni qi qj qk nl oi ql qm qn om qo qp qq oq qr qs qt qu bk">Branches are useful abstractions</h2><p id="c0ef" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">WAP pattern requires a way to write data in a location where consumers cannot accidentally read it. Branching semantics naturally provides a way to implement this, which is why we use Nessie to leverage branching semantics at the data catalog level. Nessie builds on Iceberg and on its time travel and table branching functionalities. A lot of the work done in our repo is to make Nessie work directly with Python. The result is that one can interact with the Nessie catalog and write Iceberg tables in different branches of the data catalog without a JVM based process to write.</p><h2 id="245a" class="qe ne fq bf nf qf qg qh ni qi qj qk nl oi ql qm qn om qo qp qq oq qr qs qt qu bk">Simpler developer experience</h2><p id="9f62" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">Finally, making the end-to-end experience completely Python-based simplifies remarkably the set up fo the system and the interaction with it. Any other system we are aware of would require a JVM or an additional hosted service to write back into Iceberg tables into different branches, while in this implementation the entire WAP logic can run inside one single lambda function.</p><p id="960d" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">There is nothing inherently wrong with the JVM. It is a fundamental component of many Big Data frameworks, providing a common API to work with platform-specific resources, while ensuring security and correctness. However, the JVM takes a toll from a developer experience perspective. Anybody who worked with Spark knows that JVM-based systems tend to be finicky and fail with mysterious errors. For many people who work in data and consider Python as their <em class="pd">lingua franca</em> the advantage of the JVM is paid in the coin of usability.</p><p id="694e" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">We hope more people are excited about composable designs like we are, we hope open standards like Iceberg and Arrow will become the norm, but most of all we hope this is useful.</p><p id="381d" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">So it goes.</p></div></div></div></div>    
</body>
</html>