<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>An Overview of Contextual Bandits</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>An Overview of Contextual Bandits</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/an-overview-of-contextual-bandits-53ac3aa45034?source=collection_archive---------1-----------------------#2024-02-02">https://towardsdatascience.com/an-overview-of-contextual-bandits-53ac3aa45034?source=collection_archive---------1-----------------------#2024-02-02</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="1d71" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx">A dynamic approach to treatment personalization</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hd he hf hg hh ab"><div><div class="ab hi"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@uguryi?source=post_page---byline--53ac3aa45034--------------------------------" rel="noopener follow"><div class="l hj hk by hl hm"><div class="l ed"><img alt="Ugur Yildirim" class="l ep by dd de cx" src="../Images/33db36531a170c9621504f466d61334b.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/1*1wXJBnRyddpzCyYSh-rrbw.jpeg"/><div class="hn by l dd de em n ho eo"/></div></div></a></div></div><div class="hp ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--53ac3aa45034--------------------------------" rel="noopener follow"><div class="l hq hr by hl hs"><div class="l ed"><img alt="Towards Data Science" class="l ep by br ht cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hn by l br ht em n ho eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hu ab q"><div class="ab q hv"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hw hx bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hy" data-testid="authorName" href="https://medium.com/@uguryi?source=post_page---byline--53ac3aa45034--------------------------------" rel="noopener follow">Ugur Yildirim</a></p></div></div></div><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hw hx dx"><button class="ib ic ah ai aj ak al am an ao ap aq ar id ie if" disabled="">Follow</button></p></div></div></span></div></div><div class="l ig"><span class="bf b bg z dx"><div class="ab cn ih ii ij"><div class="ik il ab"><div class="bf b bg z dx ab im"><span class="in l ig">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hy ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--53ac3aa45034--------------------------------" rel="noopener follow"><p class="bf b bg z io ip iq ir is it iu iv bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">19 min read</span><div class="iw ix l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Feb 2, 2024</span></div></span></div></span></div></div></div><div class="ab cp iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn"><div class="h k w ea eb q"><div class="kd l"><div class="ab q ke kf"><div class="pw-multi-vote-icon ed in kg kh ki"><div class=""><div class="kj kk kl km kn ko kp am kq kr ks ki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kt ku kv kw kx ky kz"><p class="bf b dy z dx"><span class="kk">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kj lc ld ab q ee le lf" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="lb"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg><p class="bf b dy z dx"><span class="pw-responses-count la lb">1</span></p></button></div></div></div><div class="ab q jo jp jq jr js jt ju jv jw jx jy jz ka kb kc"><div class="lg k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lh an ao ap id li lj lk" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep ll cn"><div class="l ae"><div class="ab cb"><div class="lm ln lo lp lq lr ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><h1 id="184a" class="mj mk fq bf ml mm mn gq mo mp mq gt mr ms mt mu mv mw mx my mz na nb nc nd ne bk">Outline</h1><ol class=""><li id="3624" class="nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob oc od bk"><a class="af oe" href="#bc08" rel="noopener ugc nofollow">Introduction</a></li><li id="1c62" class="nf ng fq nh b go of nj nk gr og nm nn no oh nq nr ns oi nu nv nw oj ny nz oa ob oc od bk"><a class="af oe" href="#0f83" rel="noopener ugc nofollow">When To Use Contextual Bandits</a><br/>2.1. <a class="af oe" href="#9c98" rel="noopener ugc nofollow">Contextual Bandit vs Multi-Armed Bandit vs A/B Testing</a><br/>2.2. <a class="af oe" href="#0b64" rel="noopener ugc nofollow">Contextual Bandit vs Multiple MABs</a><br/>2.3. <a class="af oe" href="#fc98" rel="noopener ugc nofollow">Contextual Bandit vs Multi-Step Reinforcement Learning</a><br/>2.4. <a class="af oe" href="#e404" rel="noopener ugc nofollow">Contextual Bandit vs Uplift Modeling</a></li><li id="2ec7" class="nf ng fq nh b go of nj nk gr og nm nn no oh nq nr ns oi nu nv nw oj ny nz oa ob oc od bk"><a class="af oe" href="#6c33" rel="noopener ugc nofollow">Exploration and Exploitation in Contextual Bandits</a><br/>3.1. <a class="af oe" href="#635e" rel="noopener ugc nofollow"><em class="ok">ε</em>-greedy</a><br/>3.2. <a class="af oe" href="#7841" rel="noopener ugc nofollow">Upper Confidence Bound (UCB)</a><br/>3.3. <a class="af oe" href="#31b8" rel="noopener ugc nofollow">Thompson Sampling</a></li><li id="55a4" class="nf ng fq nh b go of nj nk gr og nm nn no oh nq nr ns oi nu nv nw oj ny nz oa ob oc od bk"><a class="af oe" href="#49b9" rel="noopener ugc nofollow">Contextual Bandit Algorithm Steps</a></li><li id="b7e3" class="nf ng fq nh b go of nj nk gr og nm nn no oh nq nr ns oi nu nv nw oj ny nz oa ob oc od bk"><a class="af oe" href="#e7aa" rel="noopener ugc nofollow">Offline Policy Evaluation in Contextual Bandits</a><br/>5.1. <a class="af oe" href="#3f89" rel="noopener ugc nofollow">OPE Using Causal Inference Methods</a><br/>5.2. <a class="af oe" href="#c117" rel="noopener ugc nofollow">OPE Using Sampling Methods</a></li><li id="d34a" class="nf ng fq nh b go of nj nk gr og nm nn no oh nq nr ns oi nu nv nw oj ny nz oa ob oc od bk"><a class="af oe" href="#6403" rel="noopener ugc nofollow">Contextual Bandit in Action</a></li><li id="0d48" class="nf ng fq nh b go of nj nk gr og nm nn no oh nq nr ns oi nu nv nw oj ny nz oa ob oc od bk"><a class="af oe" href="#92a6" rel="noopener ugc nofollow">Conclusion</a></li><li id="19d4" class="nf ng fq nh b go of nj nk gr og nm nn no oh nq nr ns oi nu nv nw oj ny nz oa ob oc od bk"><a class="af oe" href="#7629" rel="noopener ugc nofollow">Acknowledgements</a></li><li id="c884" class="nf ng fq nh b go of nj nk gr og nm nn no oh nq nr ns oi nu nv nw oj ny nz oa ob oc od bk"><a class="af oe" href="#5b07" rel="noopener ugc nofollow">References</a></li></ol><h1 id="bc08" class="mj mk fq bf ml mm mn gq mo mp mq gt mr ms mt mu mv mw mx my mz na nb nc nd ne bk">1. Introduction</h1><p id="e068" class="pw-post-body-paragraph nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fj bk">Imagine a scenario where you just started an A/B test that will be running for the next two weeks. However, after just a day or two, it is becoming increasingly clear that version A is working better for certain types of users, whereas version B is working better for another set of users. You think to yourself: Perhaps I should re-route the traffic such that users are getting more of the version that is benefiting them more, and less of the other version. Is there a principled way to achieve this?</p><p id="0aaa" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">Contextual bandits are a class of one-step reinforcement learning algorithms specifically designed for such treatment personalization problems where we would like to dynamically adjust traffic based on which treatment is working for whom. Despite being incredibly powerful in what they can achieve, they are one of the lesser known methods in Data Science, and I hope that this post will give you a comprehensive introduction to this amazing topic. Without further ado, let’s dive right in!</p><h1 id="0f83" class="mj mk fq bf ml mm mn gq mo mp mq gt mr ms mt mu mv mw mx my mz na nb nc nd ne bk">2. When To Use Contextual Bandits</h1><p id="7d99" class="pw-post-body-paragraph nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fj bk">If you are just getting started with contextual bandits, it can be confusing to understand how contextual bandits are related to other more widely known methods such as A/B testing, and why you might want to use contextual bandits instead of those other methods. Therefore, we start our journey by discussing the similarities and differences between contextual bandits and related methods.</p><h2 id="9c98" class="oq mk fq bf ml or os ot mo ou ov ow mr no ox oy oz ns pa pb pc nw pd pe pf pg bk">2.1. Contextual Bandit vs Multi-Armed Bandit vs A/B Testing</h2><p id="c412" class="pw-post-body-paragraph nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fj bk">Let us start with the most basic A/B testing setting that allocates traffic into treatment and control in a <em class="ok">static</em> fashion. For example, a data scientist might decide to run an A/B test for two weeks with 50% of traffic going to treatment and 50% going to control. What this means is that regardless of whether we are on the first day of the test or the last, we will be assigning users to control or treatment with 50% probability.</p><p id="dd48" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">On the other hand, if the data scientist were to use a multi-armed bandit (MAB) instead of an A/B test in this case, then traffic will be allocated to treatment and control in a <em class="ok">dynamic</em> fashion. In other words, traffic allocations in a MAB will change as days go by. For example, if the algorithm decides that treatment is doing better than control on the first day, the traffic allocation can change from 50% treatment and 50% control to 60% treatment vs 40% control on the second day, and so on.</p><p id="4c7b" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">Despite allocating traffic dynamically, MAB ignores an important fact, which is that not all users are the same. This means that a treatment that is working for one type of user might not work for another. For example, it might be the case that while treatment is working better for core users, control is actually better for casual users. In this case, even if treatment is better overall, we can actually get more value from our application if we assign more core users to treatment and more casual users to control.</p><p id="2ed9" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">This is exactly where contextual bandits (CB) come in. While MAB simply looks at whether treatment or control is doing better <em class="ok">overall</em>, CB focuses on whether treatment or control is doing better for a user with a given set of <em class="ok">characteristics</em>. The “context” in contextual bandits precisely refers to these user characteristics and is what differentiates it from MAB. For example, CB might decide to increase treatment allocation to 60% for core users but decrease treatment allocation to 40% for casual users after observing first day’s data. In other words, CB will dynamically update traffic allocation taking user characteristics (core vs casual in this example) into account.</p><p id="7b0f" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">The following table summarizes the key differences between A/B testing, MAB, and CB, and the figure that follows visualizes these ideas.</p><p id="efcd" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk"><strong class="nh fr">Table 1: Differences Between A/B Testing, MAB, and CB</strong></p><figure class="pk pl pm pn po pp ph pi paragraph-image"><div role="button" tabindex="0" class="pq pr ed ps bh pt"><div class="ph pi pj"><img src="../Images/b064c54b71fa354aa2c4b4fcaa761b23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*17pjQ21DvJEC38ucfxnV4g.png"/></div></div></figure><p id="8f32" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk"><strong class="nh fr">Figure 1: Traffic Allocations in A/B Testing, MAB, and CB</strong></p><figure class="pk pl pm pn po pp ph pi paragraph-image"><div role="button" tabindex="0" class="pq pr ed ps bh pt"><div class="ph pi pv"><img src="../Images/dd8e19b91a7218c593729019b8ff710d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YOsWxbHyU-J7C0s9KOyUDw.png"/></div></div></figure><h2 id="0b64" class="oq mk fq bf ml or os ot mo ou ov ow mr no ox oy oz ns pa pb pc nw pd pe pf pg bk">2.2. Contextual Bandit vs Multiple MABs</h2><p id="9803" class="pw-post-body-paragraph nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fj bk">At this point, you might be tempted to think that CB is nothing more than a set of multiple MABs running together. In fact, when the context we are interested in is a small one (e.g., we are only interested in whether a user is a core user or a casual user), we can simply run one MAB for core users and another MAB for casual users. However, as the context gets large (core vs casual, age, country, time since last active, etc.) it becomes impractical to run a separate MAB for each unique context value.</p><p id="133a" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">The real value of CB emerges in this case through the use of <em class="ok">models</em> to describe the relationship of the experimental conditions in different contexts to our outcome of interest (e.g., conversion). As opposed to enumerating through each context value and treating them independently, the use of models allows us to share information from different contexts and makes it possible to handle large context spaces. This idea of a model will be discussed at several different points in this post, so keep on reading to learn more.</p><h2 id="fc98" class="oq mk fq bf ml or os ot mo ou ov ow mr no ox oy oz ns pa pb pc nw pd pe pf pg bk">2.3. Contextual Bandit vs Multi-Step Reinforcement Learning</h2><p id="dd96" class="pw-post-body-paragraph nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fj bk">The introduction referred to CB as a class of one-step reinforcement learning (RL) algorithms. So, what exactly is the difference between one-step and multi-step RL? And what makes CB one-step? The fundamental difference between CB and multi-step RL is that in CB we assume the actions the algorithm takes (e.g., serve treatment or control to a specific user) don’t affect the future states of the overall system. In other words, the state (or “context” as is more appropriately called in CB) affects what action we take, but that action we took does <em class="ok">not</em> in turn impact or change the state. The following figure summarizes this distinction.</p><p id="165d" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk"><strong class="nh fr">Figure 2: Contextual Bandit vs Multi-Step RL</strong></p><figure class="pk pl pm pn po pp ph pi paragraph-image"><div role="button" tabindex="0" class="pq pr ed ps bh pt"><div class="ph pi pw"><img src="../Images/99dd1e47664a6110fcef41adf27f1326.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Khv8lx63AQ1jXcGufn0m9g.png"/></div></div><figcaption class="px py pz ph pi qa qb bf b bg z dx">Image by author, inspired by <a class="af oe" rel="noopener" target="_blank" href="/contextual-bandits-and-reinforcement-learning-6bdfeaece72a">source</a></figcaption></figure><p id="018f" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">A few examples should make this distinction clearer. Let’s say that we are building a system to decide what ads to show to users based on their age. We would expect that users from different age groups may find different ads more relevant to them, which means that a user’s age should affect what ads we should show them. However, the ad we showed them doesn’t in turn affect their age, so the one-step assumption of CB seems to hold. However, if we move one step further and find out that serving expensive ads deplete our inventory (and limit which ads we can serve in the future) or that the ad we show today affect whether the user will visit our site again, then the one-step assumption is indirectly inviolated, so we may want to consider developing a full-blown RL system instead.</p><p id="c6ff" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">A note of caution though: While multi-step reinforcement learning is more flexible compared to contextual bandits, it’s also more complicated to implement. So, if the problem at hand can be accurately framed as a one-step problem (even though it looks like a multi-step problem at first glance), contextual bandits could be the more practical approach.</p><h2 id="e404" class="oq mk fq bf ml or os ot mo ou ov ow mr no ox oy oz ns pa pb pc nw pd pe pf pg bk">2.4. Contextual Bandit vs Uplift Modeling</h2><p id="a343" class="pw-post-body-paragraph nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fj bk">Before moving on to discussing different CB algorithms, I would also like to briefly touch upon the connection between CB and uplift modeling. An uplift model is usually built on top of A/B test data to discover the relationship between the treatment effect (uplift) and user characteristics. The results from such a model can then be used to personalize treatments in the future. For example, if the uplift model discovers that certain users are more likely to benefit from a treatment, then only those types of users might be given the treatment in the future.</p><p id="5899" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">Given this description of uplift modeling, it should be clear that both CB and uplift modeling are solutions to the personalization problem. The key difference between them is that CB approaches this problem in a more dynamic way in the sense that personalization happens <em class="ok">on-the-fly</em> instead of waiting for results from an A/B test. At a conceptual level, CB can very loosely be thought of as A/B testing and uplift modeling happening concurrently instead of sequentially. Given the focus of this post, I won’t be discussing uplift modeling further, but there are several great resources to learn more about it such as <a class="af oe" href="https://www.uber.com/blog/research/uplift-modeling-for-multiple-treatments-with-cost-optimization/" rel="noopener ugc nofollow" target="_blank">[1]</a>.</p><h1 id="6c33" class="mj mk fq bf ml mm mn gq mo mp mq gt mr ms mt mu mv mw mx my mz na nb nc nd ne bk">3. Exploration and Exploitation in Contextual Bandits</h1><p id="221e" class="pw-post-body-paragraph nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fj bk">Above we discussed how CB dynamically allocates traffic depending on whether treatment or control is doing better for a given group of users at a given point in time. This raises an important question: How aggressive do we want to be when we are making these traffic allocation changes? For example, if after just one day of data we decide that treatment is working better for users from the US, should we completely stop serving control to US users?</p><p id="c9ff" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">I’m sure most of you would agree that this would be a bad idea, and you would be correct. The main problem with changing traffic allocations this aggressively is that making inferences based on insufficient amounts of data can lead to erroneous conclusions. For example, it might be that the first day of data we gathered is actually not representative of dormant users and that in reality control is better for them. If we stop serving control to US users after the first day, we will never be able to learn this correct relationship.</p><p id="eb0f" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">A better approach to dynamically updating traffic allocations is striking the right balance between exploitation (serve the best experimental condition based on the data so far) and exploration (continue to serve other experimental conditions as well). Continuing with the previous example, if data from the first day indicate that treatment is better for US users, we can serve treatment to these users with an increased probability the next day while still allocating a reduced but non-zero fraction to control.</p><p id="6d24" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">There are numerous exploration strategies used in CB (and MAB) as well as several variations of them that try to strike this right balance between exploration and exploitation. Three popular strategies include ε-greedy, upper confidence bound, and Thompson sampling.</p><h2 id="635e" class="oq mk fq bf ml or os ot mo ou ov ow mr no ox oy oz ns pa pb pc nw pd pe pf pg bk">3.1. ε-greedy</h2><p id="44e8" class="pw-post-body-paragraph nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fj bk">In this strategy, we first decide which experimental condition is doing better for a given group of users at a given point in time. The simplest way to do this is by comparing the average target values (<em class="ok">y</em>) for each experimental condition for these users. More formally, we can decide the “winning” condition for a group of users by finding the condition <em class="ok">d</em> that has the higher value for</p><figure class="pk pl pm pn po pp ph pi paragraph-image"><div class="ph pi qc"><img src="../Images/aacbee75310f29271244345d8dbe6001.png" data-original-src="https://miro.medium.com/v2/resize:fit:308/format:webp/1*jVNV-_6JIEl6cA0r5DuRBA.png"/></div></figure><p id="53d2" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">where <em class="ok">n_dx</em> is the number of samples we have so far from users in condition <em class="ok">d</em> with context <em class="ok">x</em>, and <em class="ok">y_idx</em> is the target value for a given sample <em class="ok">i</em> in condition <em class="ok">d</em> with context <em class="ok">x</em>.</p><p id="d3d3" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">After deciding which experimental condition is currently “best” for these users, we serve them that condition with <em class="ok">1-ε</em> probability (where <em class="ok">ε</em> is usually a small number such as 0.05) and serve a random experimental condition with probability <em class="ok">ε</em>. In reality, we might want to dynamically update our <em class="ok">ε</em> such that it is large at the beginning of the experiment (when more exploration is needed) and gradually gets smaller as we collect more and more data.</p><p id="110d" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">Additionally, context <em class="ok">X</em> might be high-dimensional (country, gender, platform, tenure, etc.) so we might want to use a model to get these <em class="ok">y</em> estimates to deal with the curse of dimensionality. Formally, the condition to serve can be decided by finding the condition <em class="ok">d</em> that has the higher value for</p><figure class="pk pl pm pn po pp ph pi paragraph-image"><div class="ph pi qd"><img src="../Images/c4eed6bc6b2d15fe9be0299c6dc27931.png" data-original-src="https://miro.medium.com/v2/resize:fit:134/format:webp/1*ouw1NRbqPgeewNWkseTo4w.png"/></div></figure><p id="bb93" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">where <em class="ok">x^T</em> is an <em class="ok">m</em>-dimensional row-vector of context values and <em class="ok">θ_d</em> is an <em class="ok">m</em>-dimensional column-vector of learnable parameters associated with condition <em class="ok">d</em>.</p><h2 id="7841" class="oq mk fq bf ml or os ot mo ou ov ow mr no ox oy oz ns pa pb pc nw pd pe pf pg bk">3.2. Upper Confidence Bound (UCB)</h2><p id="dfcc" class="pw-post-body-paragraph nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fj bk">This strategy decides the next condition to serve by looking at not only which condition has a higher <em class="ok">y</em> estimate but also our precision of (or confidence in) that estimate. In a simple MAB setting, precision can be thought to be a function of how many times a given condition has already been served so far. In particular, a condition that (i) has a high average <em class="ok">y</em> (so it makes sense to exploit) or (ii) has not yet been served many times (so it needs more exploration) is more likely to be served next.</p><p id="13b0" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">We can generalize this idea to the CB setting by keeping track of how many times different conditions are served in different contexts. Assuming a simple setting with a low-dimensional context <em class="ok">X</em> such that CB can be thought of as just multiple MABs running together, we can select the next condition to serve based on which condition <em class="ok">d</em> has the higher value for</p><figure class="pk pl pm pn po pp ph pi paragraph-image"><div class="ph pi qe"><img src="../Images/c81f49f38f4edeb81ae4e4b633191981.png" data-original-src="https://miro.medium.com/v2/resize:fit:642/format:webp/1*Q3BiCkTJgeKzNcF979MrxQ.png"/></div></figure><p id="f07f" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">where <em class="ok">c</em> is some constant (to be selected based on how much emphasis we want to put on the precision of our estimate when exploring) and <em class="ok">n_x</em> is the number of times context <em class="ok">x</em> is seen so far.</p><p id="dd10" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">However, in most cases, the context <em class="ok">X</em> will be high-dimensional, which means that just like in the <em class="ok">ε</em>-greedy case, we would need to make use of a model. In this setting, a condition <em class="ok">d</em> can be served next if it has the higher value for</p><figure class="pk pl pm pn po pp ph pi paragraph-image"><div class="ph pi qf"><img src="../Images/56ecf5df3614fd3b09d19fbaafa735bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:508/format:webp/1*-RxXRELpsA8eCk5wXL8Xwg.png"/></div></figure><p id="442e" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">where <em class="ok">SE(.)</em> is the standard error of our estimate (or more generally a metric that quantifies our current level of confidence in that estimate).</p><p id="3342" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">Note that there are several versions of UCB, so you will likely come across different formulas. A popular UCB method is LinUCB that formalizes the problem in a linear model framework (e.g., <a class="af oe" rel="noopener" target="_blank" href="/recommender-systems-using-linucb-a-contextual-multi-armed-bandit-approach-35a6f0eb6c4">[2]</a>).</p><h2 id="31b8" class="oq mk fq bf ml or os ot mo ou ov ow mr no ox oy oz ns pa pb pc nw pd pe pf pg bk">3.3. Thompson Sampling</h2><p id="414d" class="pw-post-body-paragraph nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fj bk">The third and final exploration strategy to be discussed is Thompson sampling, which is a Bayesian approach to solving the exploration-exploitation dilemma. Here, we have a model <em class="ok">f(D, X; Θ)</em> that returns predicted <em class="ok">y</em> values given experimental condition <em class="ok">D</em>, context <em class="ok">X</em>, and some set of learnable parameters <em class="ok">Θ</em>. This function gives us access to posterior distributions of expected <em class="ok">y</em> values for any condition-context pair, thus allowing us to choose the next condition to serve according to the probability that it yields the highest expected <em class="ok">y</em> given context. Thompson sampling naturally balances exploration and exploitation as we are sampling from the posterior and updating our model based on the observations. To make these ideas more concrete, here are the steps involved in Thompson sampling:</p><figure class="pk pl pm pn po pp ph pi paragraph-image"><div role="button" tabindex="0" class="pq pr ed ps bh pt"><div class="ph pi qg"><img src="../Images/6d027cd3e61c98ab31a0a13d2e6fbd3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NJ_mwMdpl7HSmSR0aT-HCA.png"/></div></div></figure><p id="1bd3" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">In practice, instead of having a single function we can also use a different function for each experimental condition (e.g., evaluate both <em class="ok">f_c(X; Θ_c)</em> and <em class="ok">f_t(X; Θ_t)</em> and then select the condition with the higher value). Furthermore, the update step usually takes place not after each sample but rather after seeing a batch of samples. For more details on Thompson sampling, you can refer to <a class="af oe" href="https://arxiv.org/pdf/1707.02038.pdf" rel="noopener ugc nofollow" target="_blank">[3]</a> <a class="af oe" href="https://ieeexplore.ieee.org/stamp/stamp.jsp?tp=&amp;arnumber=7352306" rel="noopener ugc nofollow" target="_blank">[4]</a>.</p><h1 id="49b9" class="mj mk fq bf ml mm mn gq mo mp mq gt mr ms mt mu mv mw mx my mz na nb nc nd ne bk">4. Contextual Bandit Algorithm Steps</h1><p id="5954" class="pw-post-body-paragraph nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fj bk">The previous section (especially the part on Thompson sampling) should already give you a pretty good sense of the steps involved in a CB algorithm. However, for the sake of completeness, here is a step-by-step description of a standard CB algorithm:</p><ol class=""><li id="a243" class="nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa ob oc od bk">A new data point arrives with context <em class="ok">X</em> (e.g., a core user with an iOS device in the US).</li><li id="2783" class="nf ng fq nh b go of nj nk gr og nm nn no oh nq nr ns oi nu nv nw oj ny nz oa ob oc od bk">Given this data point and the exploration strategy chosen (e.g., <em class="ok">ε</em>-greedy), the algorithm decides on a condition to serve this user (e.g., treatment or control).</li><li id="34d1" class="nf ng fq nh b go of nj nk gr og nm nn no oh nq nr ns oi nu nv nw oj ny nz oa ob oc od bk">After the condition is served, we observe the outcome <em class="ok">y</em> (e.g., whether the user made a purchase or not).</li><li id="4579" class="nf ng fq nh b go of nj nk gr og nm nn no oh nq nr ns oi nu nv nw oj ny nz oa ob oc od bk">Update (or fully retrain) the model used in Step 2 after seeing the new data. (As mentioned previously, we usually make an update not after every sample but after seeing a batch of samples to ensure that updates are less noisy.)</li><li id="a591" class="nf ng fq nh b go of nj nk gr og nm nn no oh nq nr ns oi nu nv nw oj ny nz oa ob oc od bk">Repeat.</li></ol><h1 id="e7aa" class="mj mk fq bf ml mm mn gq mo mp mq gt mr ms mt mu mv mw mx my mz na nb nc nd ne bk">5. Offline Policy Evaluation in Contextual Bandits</h1><p id="8a27" class="pw-post-body-paragraph nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fj bk">So far we have only discussed how to implement a CB algorithm as <em class="ok">new</em> data come in. An equally important topic to cover is how to evaluate a CB algorithm using <em class="ok">old</em> (or <em class="ok">logged</em>) data. This is called offline evaluation or offline policy evaluation (OPE).</p><h2 id="3f89" class="oq mk fq bf ml or os ot mo ou ov ow mr no ox oy oz ns pa pb pc nw pd pe pf pg bk">5.1. OPE Using Causal Inference Methods</h2><p id="e1ac" class="pw-post-body-paragraph nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fj bk">One way to do OPE is using well-known causal inference techniques such as Inverse Propensity Scoring (IPS) or the Doubly Robust (DR) method. Causal inference is appropriate here because we are essentially trying to estimate the counterfactual of what would have happened if a different policy served a different condition to a user. There is already a great Medium article on this topic <a class="af oe" href="https://edoconti.medium.com/offline-policy-evaluation-run-fewer-better-a-b-tests-60ce8f93fa15" rel="noopener">[5]</a>, so here I will only briefly summarize the main idea from that piece and adapt it to our discussion.</p><p id="5dfa" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">Taking IPS as an example, doing OPE usually requires us to know not only (i) the probability of assigning a given condition to a sample using our new CB algorithm but also (ii) the probability with which a given condition was assigned to a sample in the logged data. Take the following hypothetical logged data with <em class="ok">X_1-X_3</em> being context, <em class="ok">D</em> being the experimental condition, <em class="ok">P_O(D)</em> being the probability of assigning <em class="ok">D</em> to that user, and <em class="ok">y</em> being the outcome.</p><p id="fb9b" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk"><strong class="nh fr">Table 2: Example Logged Data From An A/B Test</strong></p><figure class="pk pl pm pn po pp ph pi paragraph-image"><div role="button" tabindex="0" class="pq pr ed ps bh pt"><div class="ph pi qh"><img src="../Images/fb236a7c9b9156c8c161d4dedfef5850.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GBv-1la4LQy0cLQnQA_HeQ.png"/></div></div></figure><p id="8e74" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">As you can see, in this example <em class="ok">P_O(D)</em> is always 0.6 for <em class="ok">D=1</em> and 0.4 for <em class="ok">D=0</em> regardless of the context, so the logged data can be assumed to come from an A/B test that assigns treatment with probability 0.6. Now, if we want to test how a CB algorithm would have performed had we assigned conditions using a CB algorithm rather than a simple A/B test, we can use the following formula to get the IPS estimate of the cumulative <em class="ok">y</em> for CB</p><figure class="pk pl pm pn po pp ph pi paragraph-image"><div class="ph pi qi"><img src="../Images/4a6d40fc68b5f0b3dda045a12c2a825a.png" data-original-src="https://miro.medium.com/v2/resize:fit:412/format:webp/1*2TTp_Bwl54oAEAtsTzDDWQ.png"/></div></figure><p id="1d7e" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">where <em class="ok">n</em> is the number of samples in the logged data (which is 5 here) and <em class="ok">P_N(D_i)</em> is the probability of serving the logged <em class="ok">D</em> for <em class="ok">user_i</em> had we used the new CB algorithm instead (this probability will depend on the specific algorithm being evaluated).</p><p id="a064" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">Once we have this estimate, we can compare that to the observed cumulative <em class="ok">y</em> from the old A/B test (which is 1+0+0+1+1=3 here) to decide if the CB would have yielded a higher cumulative <em class="ok">y</em>.</p><p id="d319" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">For more information on OPE using causal inference methods, please refer to the article linked at the beginning of the section. The article also links to a nice GitHub repo with lots of OPE implementations.</p><p id="5547" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">A side note here is that this section discussed causal inference methods only as a technique used in OPE. However, in reality, one can also apply them while the CB algorithm is being run so as to “debias” the training data that the algorithm collects along the way. The reason why we might want to apply methods such as IPS to our training data is that the CB policy that generates this data is a non-uniform random policy by definition, so estimating causal effects from it to decide what action to take would benefit from using causal inference methods. If you would like to learn more about debiasing, please refer to <a class="af oe" href="https://arxiv.org/pdf/1802.04064.pdf" rel="noopener ugc nofollow" target="_blank">[6]</a>.</p><h2 id="c117" class="oq mk fq bf ml or os ot mo ou ov ow mr no ox oy oz ns pa pb pc nw pd pe pf pg bk">5.2. OPE Using Sampling Methods</h2><p id="5971" class="pw-post-body-paragraph nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fj bk">Another way to do OPE is through the use of sampling methods. In particular, a very simple replay method <a class="af oe" href="https://arxiv.org/pdf/1003.5956.pdf" rel="noopener ugc nofollow" target="_blank">[7]</a> can be used to evaluate a CB algorithm (or any other algorithm for that matter) using logged data from a randomized policy such as an A/B test. In its simplest form (where we assume a uniform random logging policy), the method works as follows:</p><ol class=""><li id="c189" class="nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa ob oc od bk">Sample the next user with context <em class="ok">X</em> from the logged data.</li><li id="70ab" class="nf ng fq nh b go of nj nk gr og nm nn no oh nq nr ns oi nu nv nw oj ny nz oa ob oc od bk">Decide what condition to assign to that user using the new CB algorithm.</li><li id="984b" class="nf ng fq nh b go of nj nk gr og nm nn no oh nq nr ns oi nu nv nw oj ny nz oa ob oc od bk">If the selected condition matches the actual condition in the logged data, then add the observed <em class="ok">y</em> to the cumulative <em class="ok">y</em> counter. If it doesn’t match, ignore the sample.</li><li id="a716" class="nf ng fq nh b go of nj nk gr og nm nn no oh nq nr ns oi nu nv nw oj ny nz oa ob oc od bk">Repeat until all samples are considered.</li></ol><p id="b0f6" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">If the logging policy doesn’t assign treatments uniformly at random, then the method needs to be slightly modified. One modification that the authors themselves mention is to use rejection sampling (e.g., <a class="af oe" href="https://grail.cs.washington.edu/projects/nonstationaryeval/nonstationaryevalExtended.pdf" rel="noopener ugc nofollow" target="_blank">[8]</a>) whereby we would accept samples from the majority treatment less often compared to the minority treatment in Step 3. Alternatively, we could consider dividing the observed <em class="ok">y</em> by the propensity in Step 3 to similarly “down-weight” the more frequent treatment and “up-weight” the less frequent one.</p><p id="05a9" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">In the next section, I employ an even simpler method in my evaluation that uses up- and down-sampling with bootstrap to transform the original non-uniform data into a uniform one and then apply the method as it is.</p><h1 id="6403" class="mj mk fq bf ml mm mn gq mo mp mq gt mr ms mt mu mv mw mx my mz na nb nc nd ne bk">6. Contextual Bandit in Action</h1><p id="39dc" class="pw-post-body-paragraph nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fj bk">To demonstrate contextual bandits in action, I put together a <a class="af oe" href="https://github.com/uguryi/contextual_bandit/blob/main/ab_vs_mab_vs_cb.ipynb" rel="noopener ugc nofollow" target="_blank">notebook</a> that generates a simulated dataset and compares the cumulative <em class="ok">y</em> (or “reward”) estimates for new A/B, MAB, and CB policies evaluated on this dataset. Many parts of the code in this notebook are taken from the Contextual Bandits chapter of an amazing book on Reinforcement Learning <a class="af oe" href="https://github.com/PacktPublishing/Mastering-Reinforcement-Learning-with-Python/blob/master/Chapter03/Contextual%20Bandits.ipynb" rel="noopener ugc nofollow" target="_blank">[9]</a> (highly recommended if you would like to dig deeper into Reinforcement Learning using Python) and two great posts by James LeDoux <a class="af oe" href="https://jamesrledoux.com/algorithms/offline-bandit-evaluation/" rel="noopener ugc nofollow" target="_blank">[10]</a> <a class="af oe" href="https://jamesrledoux.com/algorithms/bandit-algorithms-epsilon-ucb-exp-python/" rel="noopener ugc nofollow" target="_blank">[11]</a> and adapted to the setting we are discussing here.</p><p id="62ab" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">The setup is very simple: The original data we have comes from an A/B test that assigned treatment to users with probability 0.75 (so <em class="ok">not</em> uniformly at random). Using this randomized logged data, we would like to evaluate and compare the following three policies based on their cumulative <em class="ok">y</em>:</p><ol class=""><li id="6708" class="nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa ob oc od bk">A new A/B policy that randomly assigns treatment to users with probability 0.4.</li><li id="dcda" class="nf ng fq nh b go of nj nk gr og nm nn no oh nq nr ns oi nu nv nw oj ny nz oa ob oc od bk">A MAB policy that decides what treatment to assign next using an <em class="ok">ε</em>-greedy policy that doesn’t take context <em class="ok">X</em> into account.</li><li id="6062" class="nf ng fq nh b go of nj nk gr og nm nn no oh nq nr ns oi nu nv nw oj ny nz oa ob oc od bk">A CB policy that decides what treatment to assign next using an <em class="ok">ε</em>-greedy policy that takes context <em class="ok">X</em> into account.</li></ol><p id="7f1b" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">I modified the original method described in the Li et al. paper such that instead of directly sampling from the simulated data (which is 75% treatment and only 25% control in my example), I first down-sample treatment cases and up-sample control cases (both with replacement) to get a new dataset that is exactly 50% treatment and 50% control.</p><p id="a7f1" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">The reason why I start with a dataset that is <em class="ok">not</em> 50% treatment and 50% control is to show that even if the original data doesn’t come from a policy that assigns treatment and control uniformly at random, we can still work with that data to do offline evaluation after doing up- and/or down-sampling to massage it into a 50/50% dataset. As mentioned in the previous section, the logic behind up- and down-sampling is similar to rejection sampling and the related idea of dividing the observed <em class="ok">y</em> by the propensity.</p><p id="86b7" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">The following figure compares the three policies described above (A/B vs MAB vs CB) in terms of their cumulative <em class="ok">y</em> values.</p><p id="1ab8" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk"><strong class="nh fr">Figure 3: Cumulative Reward Comparison</strong></p><figure class="pk pl pm pn po pp ph pi paragraph-image"><div class="ph pi qj"><img src="../Images/e6aaafba01f5022e78987f9e49c2f21b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*QyT-AUlkV88ZYLdOKLST_g.png"/></div></figure><p id="9040" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">As can be seen in this figure, cumulative <em class="ok">y</em> increases fastest for CB and slowest for A/B with MAB somewhere in between. While this result is based on a simulated dataset, the patterns observed here can still be generalized. The reason why A/B testing isn’t able to get a high cumulative <em class="ok">y</em> is because it isn’t changing the 60/40% allocation at all even after seeing sufficient evidence that treatment is better than control overall. On the other hand, while MAB is able to dynamically update this traffic allocation, it is still performing worse than CB because it isn’t personalizing the treatment vs control assignment based on the context <em class="ok">X</em> being observed. Finally, CB is both dynamically changing the traffic allocation and also personalizing the treatment, hence the superior performance.</p><h1 id="92a6" class="mj mk fq bf ml mm mn gq mo mp mq gt mr ms mt mu mv mw mx my mz na nb nc nd ne bk">7. Conclusion</h1><p id="28aa" class="pw-post-body-paragraph nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fj bk">Congratulations on making it to the end of this fairly long post! We covered a lot of ground related to contextual bandits in this post, and I hope that you leave this page with an appreciation of the usefulness of this fascinating method for online experimentation, especially when treatments need to be personalized.</p><p id="1410" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">If you are interested in learning more about contextual bandits (or want to go a step further into multi-step reinforcement learning), I highly recommend the book <em class="ok">Mastering Reinforcement Learning with Python</em> by E. Bilgin. The Contextual Bandit chapter of this book was what finally gave me the “aha!” moment in understanding this topic, and I kept on reading to learn more about RL in general. As far as offline policy evaluation is concerned, I highly recommend the posts by E. Conti and J. LeDoux, both of which provide great explanations of the techniques involved and provide code examples. Regarding debiasing in contextual bandits, the paper by A. Bietti, A. Agarwal, and J. Langford provides a great overview of the techniques involved. Finally, while this post exclusively focused on using regression models when building contextual bandits, there is an alternative approach called cost-sensitive classification, which you can start learning by checking out these lecture notes by A. Agarwal and S. Kakade <a class="af oe" href="https://courses.cs.washington.edu/courses/cse599m/19sp/notes/off_policy.pdf" rel="noopener ugc nofollow" target="_blank">[12]</a>.</p><p id="0604" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">Have fun building contextual bandits!</p><h1 id="7629" class="mj mk fq bf ml mm mn gq mo mp mq gt mr ms mt mu mv mw mx my mz na nb nc nd ne bk">8. Acknowledgements</h1><p id="1ba8" class="pw-post-body-paragraph nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fj bk">I would like to thank Colin Dickens for introducing me to contextual bandits as well as providing valuable feedback on this post, Xinyi Zhang for all her helpful feedback throughout the writing, Jiaqi Gu for a fruitful conversation on sampling methods, and Dennis Feehan for encouraging me to take the time to write this piece.</p><p id="cfe0" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">Unless otherwise noted, all images are by the author.</p><h1 id="5b07" class="mj mk fq bf ml mm mn gq mo mp mq gt mr ms mt mu mv mw mx my mz na nb nc nd ne bk">9. References</h1><p id="a359" class="pw-post-body-paragraph nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fj bk">[1] Z. Zhao and T. Harinen, <a class="af oe" href="https://www.uber.com/blog/research/uplift-modeling-for-multiple-treatments-with-cost-optimization/" rel="noopener ugc nofollow" target="_blank">Uplift Modeling for Multiple Treatments with Cost Optimization</a> (2019), DSAA</p><p id="c7f2" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">[2] Y. Narang, <a class="af oe" rel="noopener" target="_blank" href="/recommender-systems-using-linucb-a-contextual-multi-armed-bandit-approach-35a6f0eb6c4">Recommender systems using LinUCB: A contextual multi-armed bandit approach</a> (2020), Medium</p><p id="a752" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">[3] D. Russo, B. Van Roy, A. Kazerouni, I. Osband, and Z. Wen, <a class="af oe" href="https://arxiv.org/pdf/1707.02038.pdf" rel="noopener ugc nofollow" target="_blank">A Tutorial on Thompson Sampling</a> (2018), Foundations and Trends in Machine Learning</p><p id="2e35" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">[4] B. Shahriari, K. Swersky, Z. Wang, R. Adams, and N. de Freitas, <a class="af oe" href="https://ieeexplore.ieee.org/stamp/stamp.jsp?tp=&amp;arnumber=7352306" rel="noopener ugc nofollow" target="_blank">Taking the Human Out of the Loop: A Review of Bayesian Optimization</a> (2015), IEEE</p><p id="9698" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">[5] E. Conti, <a class="af oe" href="https://edoconti.medium.com/offline-policy-evaluation-run-fewer-better-a-b-tests-60ce8f93fa15" rel="noopener">Offline Policy Evaluation: Run fewer, better A/B tests</a> (2021), Medium</p><p id="dfaa" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">[6] A. Bietti, A. Agarwal, and J. Langford, <a class="af oe" href="https://arxiv.org/pdf/1802.04064.pdf" rel="noopener ugc nofollow" target="_blank">A Contextual Bandit Bake-off</a> (2021), ArXiv</p><p id="7a9e" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">[7] L. Li, W. Chu, J. Langford, and X. Wang, <a class="af oe" href="https://arxiv.org/pdf/1003.5956.pdf" rel="noopener ugc nofollow" target="_blank">Unbiased Offline Evaluation of Contextual-bandit-based News Article Recommendation Algorithms</a> (2011), WSDM</p><p id="9926" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">[8] T. Mandel, Y. Liu, E. Brunskill, and Z. Popovic, <a class="af oe" href="https://grail.cs.washington.edu/projects/nonstationaryeval/nonstationaryevalExtended.pdf" rel="noopener ugc nofollow" target="_blank">Offline Evaluation of Online Reinforcement Learning Algorithms</a> (2016), AAAI</p><p id="e43c" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">[9] E. Bilgin, <a class="af oe" href="https://github.com/PacktPublishing/Mastering-Reinforcement-Learning-with-Python/tree/master" rel="noopener ugc nofollow" target="_blank">Mastering Reinforcement Learning with Python</a> (2020), Packt Publishing</p><p id="11e5" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">[10] J. LeDoux, <a class="af oe" href="https://jamesrledoux.com/algorithms/offline-bandit-evaluation/" rel="noopener ugc nofollow" target="_blank">Offline Evaluation of Multi-Armed Bandit Algorithms in Python using Replay</a> (2020), LeDoux’s personal website</p><p id="3de5" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">[11] J. LeDoux, <a class="af oe" href="https://jamesrledoux.com/algorithms/bandit-algorithms-epsilon-ucb-exp-python/" rel="noopener ugc nofollow" target="_blank">Multi-Armed Bandits in Python: Epsilon Greedy, UCB1, Bayesian UCB, and EXP3</a> (2020), LeDoux’s personal website</p><p id="8286" class="pw-post-body-paragraph nf ng fq nh b go ol nj nk gr om nm nn no on nq nr ns oo nu nv nw op ny nz oa fj bk">[12] A. Agarwal and S. Kakade, <a class="af oe" href="https://courses.cs.washington.edu/courses/cse599m/19sp/notes/off_policy.pdf" rel="noopener ugc nofollow" target="_blank">Off-policy Evaluation and Learning</a> (2019), University of Washington Computer Science Department</p></div></div></div></div>    
</body>
</html>