<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>How to Calculate a Moving Average Over Multiple Periods in DAX</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>How to Calculate a Moving Average Over Multiple Periods in DAX</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-calculate-a-moving-average-over-multiple-periods-in-dax-2a6a8105850a?source=collection_archive---------13-----------------------#2024-10-01">https://towardsdatascience.com/how-to-calculate-a-moving-average-over-multiple-periods-in-dax-2a6a8105850a?source=collection_archive---------13-----------------------#2024-10-01</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="7cca" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx"><em class="hd">Calculating a moving Aggregation is easy in DAX. However, there are some pitfalls when calculating the moving average over time. As some of these pitfalls are a question of definition, we must be careful not to choose the wrong method. Let’s look at the details.</em></h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="he hf hg hh hi ab"><div><div class="ab hj"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@salvatorecagliari?source=post_page---byline--2a6a8105850a--------------------------------" rel="noopener follow"><div class="l hk hl by hm hn"><div class="l ed"><img alt="Salvatore Cagliari" class="l ep by dd de cx" src="../Images/a24b0cefab6e707cfee06cde9e857559.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/da:true/resize:fill:88:88/0*pOkUYGxmbbFyWocH"/><div class="ho by l dd de em n hp eo"/></div></div></a></div></div><div class="hq ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--2a6a8105850a--------------------------------" rel="noopener follow"><div class="l hr hs by hm ht"><div class="l ed"><img alt="Towards Data Science" class="l ep by br hu cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="ho by l br hu em n hp eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hv ab q"><div class="ab q hw"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hx hy bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hz" data-testid="authorName" href="https://medium.com/@salvatorecagliari?source=post_page---byline--2a6a8105850a--------------------------------" rel="noopener follow">Salvatore Cagliari</a></p></div></div></div><span class="ia ib" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hx hy dx"><button class="ic id ah ai aj ak al am an ao ap aq ar ie if ig" disabled="">Follow</button></p></div></div></span></div></div><div class="l ih"><span class="bf b bg z dx"><div class="ab cn ii ij ik"><div class="il im ab"><div class="bf b bg z dx ab in"><span class="io l ih">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hz ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--2a6a8105850a--------------------------------" rel="noopener follow"><p class="bf b bg z ip iq ir is it iu iv iw bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="ia ib" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">8 min read</span><div class="ix iy l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Oct 1, 2024</span></div></span></div></span></div></div></div><div class="ab cp iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo"><div class="h k w ea eb q"><div class="ke l"><div class="ab q kf kg"><div class="pw-multi-vote-icon ed io kh ki kj"><div class=""><div class="kk kl km kn ko kp kq am kr ks kt kj"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l ku kv kw kx ky kz la"><p class="bf b dy z dx"><span class="kl">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kk lb lc ab q ee ld le" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="lf"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg></button></div></div></div><div class="ab q jp jq jr js jt ju jv jw jx jy jz ka kb kc kd"><div class="lg k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lh an ao ap ie li lj lk" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep ll cn"><div class="l ae"><div class="ab cb"><div class="lm ln lo lp lq lr ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lh an ao ap ie ls lt le lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lh an ao ap ie ls lt le lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lh an ao ap ie ls lt le lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk ml"><img src="../Images/7302237dcc3ebd4223716fd99aa0982c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*yTX1B869rtJhmpul"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Photo by <a class="af nc" href="https://unsplash.com/@antoine1003?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Antoine Dautry</a> on <a class="af nc" href="https://unsplash.com/?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="d53b" class="nd ne fq bf nf ng nh gq ni nj nk gt nl nm nn no np nq nr ns nt nu nv nw nx ny bk">First, some math</h1><p id="ace5" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">Calculating the Average is easy: Divide the sum of a value by the number of instances.</p><p id="2c81" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">While the sum of a value is easy, the number of instances is not as straightforward as you might think.</p><p id="3a7b" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">For example, let’s look at the following table:</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk pa"><img src="../Images/e823e254f4774c82fcf9f9152255ce0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:312/format:webp/1*qcaEMn4WMILl6WtLFRfOcg.png"/></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Figure 1 — List of Numbers (Figure by the Author)</figcaption></figure><p id="6ece" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">The calculation of the Average of the Value column is easy:</p><p id="bdec" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">&lt;Sum of Value&gt; / &lt;No of Rows&gt; = 534.68 / 10 = 53.47</p><p id="75bb" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Now, let’s delete one value, and this changes the picture.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk pb"><img src="../Images/3f55fc4390557dacc0c69ebcf2253745.png" data-original-src="https://miro.medium.com/v2/resize:fit:308/format:webp/1*fxEgqJf1F49GuY3vfa_qoA.png"/></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Figure 2 — List of numbers with a gap (Figure by the Author)</figcaption></figure><p id="9520" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Suddenly, I have two ways of calculating the Average:</p><p id="7e8f" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">&lt;Sum of Value&gt; / &lt;No of Values&gt; = 547.23 / 9 = 60.8</p><p id="54f0" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Or</p><p id="563d" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">&lt;Sum of Value&gt; / &lt;No of Rows&gt; = 547.23 / 10 = 54.72</p><p id="3167" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">The second way of doing it is only a different definition.<br/>For example, suppose the first column is a Customer ID, and I want to calculate the Average Sales for all Customers or the number of active Customers, etc. In that case, the second way of calculating the Average might be the better approach.</p><p id="577d" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Now, let’s translate this into DAX.</p><h1 id="b058" class="nd ne fq bf nf ng nh gq ni nj nk gt nl nm nn no np nq nr ns nt nu nv nw nx ny bk">Moving Aggregation — The starting point</h1><p id="921f" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">First, let’s build the typical case of Moving Aggregation.</p><p id="c452" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">I want to get the Moving Sales over the last four months.</p><p id="600d" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">For now, I use the <a class="af nc" href="https://dax.guide/sum/" rel="noopener ugc nofollow" target="_blank">SUM()</a> of Sales as it’s much easier to validate the result over four months than by calculating the average.</p><pre class="mm mn mo mp mq pc pd pe bp pf bb bk"><span id="b839" class="pg ne fq pd b bg ph pi l pj pk">Sales Moving Sum =<br/>VAR MaxDate = MAX( 'Date'[Date] )<br/><br/>VAR MinDate =<br/>    CALCULATE(<br/>        MIN('Date'[Date])<br/>        , DATEADD( 'Date'[Date], - 3, MONTH )<br/>        )<br/><br/>VAR  DateRange =<br/> CALCULATETABLE(<br/>    DATESBETWEEN( 'Date'[Date]<br/>        ,MinDate<br/>        ,MaxDate<br/>    )<br/>)<br/><br/>VAR Result = CALCULATE([Sum Online Sales]<br/>                        ,DateRange<br/>                    )<br/><br/>RETURN<br/>    Result</span></pre><p id="61e5" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">First, I get the last Date for the Current Filter Context (e. g. the current month)</p><p id="ea36" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Second, I use <a class="af nc" href="https://dax.guide/dateadd/" rel="noopener ugc nofollow" target="_blank">DATEADD()</a> to move back three Months. I only move back for three months because I include the current month.</p><p id="cc47" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">If I want to exclude the current month, I must do it differently. In this case, I must get the first date and go back one day to get the last date of the previous month (Or use <a class="af nc" href="https://dax.guide/eomonth/" rel="noopener ugc nofollow" target="_blank">EOMONTH(MAX(‘Date’[Date), -1) )</a>. Then, use DATEADD() to go back four months).</p><p id="3bb0" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Third, I use <a class="af nc" href="https://dax.guide/datesbetween/" rel="noopener ugc nofollow" target="_blank">DATESBETWEEN()</a> to get a list of dates between the two Variables.</p><p id="44a2" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Lastly, I pass the list of dates on to <a class="af nc" href="https://dax.guide/calculate/" rel="noopener ugc nofollow" target="_blank">CALCULATE()</a> to return the final result.</p><p id="57de" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Here is the result:</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk pl"><img src="../Images/f74e57bca2c2fb4c51a08e5621c5e4a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*wN4fe_CrBy2BkLP0bvJYSw.png"/></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Figure 3 — Table with the moving sum over four months (Figure by the Author)</figcaption></figure><p id="d99d" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">I can simplify the Measure by removing the DATESBETWEEN() function and passing the two Variable directly to CALCULATE():</p><pre class="mm mn mo mp mq pc pd pe bp pf bb bk"><span id="8774" class="pg ne fq pd b bg ph pi l pj pk">VAR MaxDate = MAX( 'Date'[Date] )<br/><br/>VAR MinDate =<br/>    CALCULATE(<br/>        MIN('Date'[Date])<br/>        , DATEADD( 'Date'[Date], - 1, MONTH )<br/>        )<br/><br/>VAR Result = CALCULATE([Sum Online Sales]<br/>                        ,'Date'[Date] &gt;= MinDate<br/>                        &amp;&amp; 'Date'[Date] &lt;= MaxDate<br/>                    )<br/><br/>RETURN<br/>    Result</span></pre><p id="e262" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">The results are identical, but the performance is marginally better with DATESBETWEEN() (I have 17 million rows in the Fact table).</p><p id="91e6" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">As several factors can influence performance, I encourage you to try both variants with your data and use cases and check the differences.</p><p id="9913" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">You can read more about measuring performance in Power BI here:</p><div class="pm pn po pp pq pr"><a rel="noopener follow" target="_blank" href="/how-to-get-performance-data-from-power-bi-with-dax-studio-b7f11b9dd9f9?source=post_page-----2a6a8105850a--------------------------------"><div class="ps ab ih"><div class="pt ab co cb pu pv"><h2 class="bf fr hx z ip pw ir is px iu iw fp bk">How to get performance data from Power BI with DAX Studio</h2><div class="py l"><h3 class="bf b hx z ip pw ir is px iu iw dx">Sometimes we have a slow Report, and we need to figure out why. We will see how to collect performance data and the…</h3></div><div class="pz l"><p class="bf b dy z ip pw ir is px iu iw dx">towardsdatascience.com</p></div></div><div class="qa l"><div class="qb l qc qd qe qa qf lr pr"/></div></div></a></div><h1 id="37c5" class="nd ne fq bf nf ng nh gq ni nj nk gt nl nm nn no np nq nr ns nt nu nv nw nx ny bk">Let’s do Average</h1><p id="c896" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">Now, finally, I will start calculating the average.</p><p id="0bef" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">I use the same logic as in my Sum Online Sales Measure and use AVERAGEX() to calculate the average Sales Amount:</p><pre class="mm mn mo mp mq pc pd pe bp pf bb bk"><span id="e08d" class="pg ne fq pd b bg ph pi l pj pk">Average Online Sales = AVERAGEX('Online Sales'<br/>    ,('Online Sales'[UnitPrice] * 'Online Sales'[SalesQuantity]) - 'Online Sales'[DiscountAmount]<br/>)</span></pre><p id="6a19" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Next, I copy the Measure above to calculate the Sales Moving Average, and this is the Result:</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk qg"><img src="../Images/68a11c25a254d6ac8343512c4a3dcd29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1166/format:webp/1*CLQAmjqk0HaWPwDgKMKcEg.png"/></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Figure 4 — Results for the basic Average and Moving Average (Figure by the Author)</figcaption></figure><p id="b3a2" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">I could end here and write, “Mission accomplished.” But stop.</p><p id="4e0d" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">At the start, I mentioned different ways to calculate an average.</p><p id="da4f" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">So, I started writing Measures to test them out.<br/>I wrote the following Measures, which I used as a denominator, while I used the [Sum Online Sales] and the Nominator:</p><ul class=""><li id="6af0" class="nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou qh qi qj bk">Count Online Sales = COUNTROWS(‘Online Sales’)</li><li id="2d88" class="nz oa fq ob b go qk od oe gr ql og oh oi qm ok ol om qn oo op oq qo os ot ou qh qi qj bk">Customer Count = DISTINCTCOUNT(‘Online Sales’[CustomerKey])</li><li id="fc0d" class="nz oa fq ob b go qk od oe gr ql og oh oi qm ok ol om qn oo op oq qo os ot ou qh qi qj bk">Online Order Count = DISTINCTCOUNT(‘Online Sales’[SalesOrderNumber])</li></ul><p id="b861" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">The code for the Result Variable is the following (Using [Count Online Sales] as an example):</p><pre class="mm mn mo mp mq pc pd pe bp pf bb bk"><span id="6efd" class="pg ne fq pd b bg ph pi l pj pk">VAR Result = CALCULATE([Sum Online Sales] / [Count Online Sales]<br/>                        ,DateRange<br/>                    )</span></pre><p id="2572" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">I can think of more variants (e.g., average overall customers, even those without an order during that period). But I decided to stop here so as not to avoid confusion.</p><p id="02b2" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Unsurprisingly, each of them delivered a different result:</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk qp"><img src="../Images/813bde70d788d62be9a52ccab2bd4a81.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3kaP8CuaXMgWiv20EiHQew.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Figure 5 — Results with all variants for the Average (Figure by the Author)</figcaption></figure><p id="99c0" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">The difference between the results is very drastic.</p><p id="9eb7" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">You might encounter other ways to calculate the Average.</p><p id="fc9b" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Therefore, I urge you to define clearly how the average must be calculated. Otherwise, you might deliver unexpected or even incorrect results to your Audience.</p><h1 id="d28f" class="nd ne fq bf nf ng nh gq ni nj nk gt nl nm nn no np nq nr ns nt nu nv nw nx ny bk">Average over Monthly Sales</h1><p id="29d2" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">There is one more variance in calculating the Average: As an Average over Monthly Sales.</p><p id="a414" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Let’s look again at the result with the monthly Sales:</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk qq"><img src="../Images/32643cadbfedf8807b3a6c869a8ece00.png" data-original-src="https://miro.medium.com/v2/resize:fit:638/format:webp/1*D9NSeMI0ZY2f1knWz4stWA.png"/></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Figure 6 — Monthly Sales only (Figure by the Author)</figcaption></figure><p id="6351" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">I want to calculate the average monthly sales over four months.</p><p id="e8d6" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">For example, in September, I want to calculate the Average of the monthly sales in June, July, August, and September:</p><p id="0abe" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">(275’061’552.33 + 303’302’950.82 + 273’004’268.56 + 262’971’889.59) / 4 = ~278’585’165.3<br/> (~ because we might get a slightly different result because of rounding differences)</p><p id="1090" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">To fulfill this requirement, I must think about how to do it.</p><p id="497b" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">I need to calculate the Sales Amount for each month in advance. Then consider only the four months required for each row. At the end, calculate the Average for these four values.</p><p id="7b64" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">This would mean I must first generate a table with all monthly results and use only the value needed to calculate the Average, which is inefficient. Power BI would then calculate this for each row in the table to visualize the result.</p><p id="2d83" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">When I look at it from the perspective of the Filter Context per row, I can do it much better.</p><p id="5875" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Why not calculate the sum of sales only for those months relevant to each row in the visualization?</p><p id="0e68" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Based on this approach, I wrote the following Measure:</p><pre class="mm mn mo mp mq pc pd pe bp pf bb bk"><span id="160f" class="pg ne fq pd b bg ph pi l pj pk">Moving Average by Month = <br/>// 1. Get the first and last Date for the current Filter Context<br/>VAR MaxDate = MAX( 'Date'[Date] )<br/><br/>VAR MinDate =<br/>    CALCULATE(<br/>        MIN('Date'[Date])<br/>        , DATEADD( 'Date'[Date], - 3, MONTH )<br/>        )<br/><br/>// 2. Generate the Date range needed for the Moving average (Four months)<br/>VAR  DateRange =<br/> CALCULATETABLE(<br/>    DATESBETWEEN( 'Date'[Date]<br/>        ,MinDate<br/>        ,MaxDate<br/>    )<br/>)<br/><br/>// 3. Generate a table filtered by the Date Range generated at step 2<br/>// This table contains only four rows<br/>VAR SalesByMonth = <br/>    CALCULATETABLE(<br/>        SUMMARIZECOLUMNS(<br/>            'Date'[MonthKey]<br/>            , "#Sales", [Sum Online Sales]<br/>            <br/>        )<br/>        ,DateRange<br/>    )<br/><br/>RETURN<br/>    // 4. Calculate the Average over the four values in the table generated in Step 3<br/>    AVERAGEX(SalesByMonth, [#Sales])</span></pre><p id="0d59" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">This time, I added inline comments to explain what was happening there.</p><p id="c6c7" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">The result is the following:</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk qr"><img src="../Images/c43bd7dbe2d5df7b7757915109037d8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/format:webp/1*ZR3KunD8BrBmN4obyMFRbA.png"/></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Figure 7 — Results for the Average per Month (Figure by the Author)</figcaption></figure><p id="4341" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">I checked the results in Excel, and they are correct.</p><p id="0130" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">If you’re thinking about creating a pre-calculated table per month, think about it again.</p><p id="7b1d" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">You would be forced to add references to all Dimensions and increase the granularity of the data to the point that you need to write this Measure anyway to fulfill your audience’s need to filter the data by all Dimensions.</p><p id="d71d" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">This solution is very efficient, as it took less than 0.4 seconds to calculate the result.</p><p id="d4dd" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Even when expanding all Months, the results didn’t need more time to calculate.</p><p id="61ff" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">By the way, this approach is also suitable when calculating an average of averages.</p><h1 id="3cec" class="nd ne fq bf nf ng nh gq ni nj nk gt nl nm nn no np nq nr ns nt nu nv nw nx ny bk">Conclusion</h1><p id="4079" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">The Average is not equal to the Average. I think this is clear.</p><p id="a9db" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">But more than this, it’s essential to understand what should be calculated and how.</p><p id="8465" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Understanding why a number must be calculated can help you choose the correct calculation logic.</p><p id="74cb" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">When the logic is clear, the Approach to writing the DAX code should be defined. Remember to do it from the perspective of the Filter Context. Sometimes, this is counterintuitive, but it will help develop efficient code.</p><p id="09c3" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">I hope that you learned something new today.</p><p id="9042" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">See you next time.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk qs"><img src="../Images/c8f7f0a0de78dae8db3e34fce94e1731.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*sRHUWHr6PjbuSbQ6"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Photo by <a class="af nc" href="https://unsplash.com/@timmossholder?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Tim Mossholder</a> on <a class="af nc" href="https://unsplash.com/?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="b8bd" class="nd ne fq bf nf ng nh gq ni nj nk gt nl nm nn no np nq nr ns nt nu nv nw nx ny bk">References</h1><p id="bccf" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">Like in my previous articles, I use the Contoso sample dataset. You can download the ContosoRetailDW Dataset for free from Microsoft <a class="af nc" href="https://www.microsoft.com/en-us/download/details.aspx?id=18279" rel="noopener ugc nofollow" target="_blank">here</a>.</p><p id="d296" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">The Contoso Data can be freely used under the MIT License, as described <a class="af nc" href="https://github.com/microsoft/Power-BI-Embedded-Contoso-Sales-Demo" rel="noopener ugc nofollow" target="_blank">here</a>.</p><p id="185c" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">I changed the dataset to shift the data to contemporary dates.</p><div class="pm pn po pp pq pr"><a href="https://medium.com/@salvatorecagliari/subscribe?source=post_page-----2a6a8105850a--------------------------------" rel="noopener follow" target="_blank"><div class="ps ab ih"><div class="pt ab co cb pu pv"><h2 class="bf fr hx z ip pw ir is px iu iw fp bk">Get an email whenever Salvatore Cagliari publishes.</h2><div class="py l"><h3 class="bf b hx z ip pw ir is px iu iw dx">Get an email whenever Salvatore Cagliari publishes. By signing up, you will create a Medium account if you don't…</h3></div><div class="pz l"><p class="bf b dy z ip pw ir is px iu iw dx">medium.com</p></div></div><div class="qa l"><div class="qt l qc qd qe qa qf lr pr"/></div></div></a></div><p id="a61a" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">I make my articles accessible to everyone, even though Medium has a paywall. This allows me to earn a little for each reader, but I turn it off so you can read my pieces without cost.</p><p id="39fb" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">I write these pieces in the evenings and at the weekends, which is a lot of work.</p><p id="0a25" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">You can support my work through</p><p id="eff3" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk"><a class="af nc" href="https://buymeacoffee.com/salvatorecagliari" rel="noopener ugc nofollow" target="_blank">https://buymeacoffee.com/salvatorecagliari</a></p><p id="da79" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Or scan this QR Code:</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk qu"><img src="../Images/e7ac062070dcd7a00dcf995ad7e95434.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*btH95UXO7gboS30eZMk6ug.png"/></div></figure><p id="b166" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Any support is greatly appreciated and helps me find more time to create more content for you.</p><p id="04ba" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Thank you a lot.</p></div></div></div></div>    
</body>
</html>