<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Learning to Rank — Contextual Item Recommendations for User Pairs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Learning to Rank — Contextual Item Recommendations for User Pairs</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/learning-to-rank-contextual-item-recommendations-for-user-pairs-dc4f56e24d94?source=collection_archive---------6-----------------------#2024-03-26">https://towardsdatascience.com/learning-to-rank-contextual-item-recommendations-for-user-pairs-dc4f56e24d94?source=collection_archive---------6-----------------------#2024-03-26</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="f752" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx">Train a Machine Learning recommendation engine that learns the shared preferences of groups of people</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hd he hf hg hh ab"><div><div class="ab hi"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@franckjay?source=post_page---byline--dc4f56e24d94--------------------------------" rel="noopener follow"><div class="l hj hk by hl hm"><div class="l ed"><img alt="Jay Franck" class="l ep by dd de cx" src="../Images/8a8bd2265c46453036916ebda2adf119.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/1*REvmRzTkhrzmbrOoiFvo0Q.jpeg"/><div class="hn by l dd de em n ho eo"/></div></div></a></div></div><div class="hp ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--dc4f56e24d94--------------------------------" rel="noopener follow"><div class="l hq hr by hl hs"><div class="l ed"><img alt="Towards Data Science" class="l ep by br ht cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hn by l br ht em n ho eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hu ab q"><div class="ab q hv"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hw hx bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hy" data-testid="authorName" href="https://medium.com/@franckjay?source=post_page---byline--dc4f56e24d94--------------------------------" rel="noopener follow">Jay Franck</a></p></div></div></div><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hw hx dx"><button class="ib ic ah ai aj ak al am an ao ap aq ar id ie if" disabled="">Follow</button></p></div></div></span></div></div><div class="l ig"><span class="bf b bg z dx"><div class="ab cn ih ii ij"><div class="ik il ab"><div class="bf b bg z dx ab im"><span class="in l ig">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hy ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--dc4f56e24d94--------------------------------" rel="noopener follow"><p class="bf b bg z io ip iq ir is it iu iv bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">6 min read</span><div class="iw ix l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Mar 26, 2024</span></div></span></div></span></div></div></div><div class="ab cp iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn"><div class="h k w ea eb q"><div class="kd l"><div class="ab q ke kf"><div class="pw-multi-vote-icon ed in kg kh ki"><div class=""><div class="kj kk kl km kn ko kp am kq kr ks ki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kt ku kv kw kx ky kz"><p class="bf b dy z dx"><span class="kk">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kj la lb ab q ee lc ld" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="le"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg></button></div></div></div><div class="ab q jo jp jq jr js jt ju jv jw jx jy jz ka kb kc"><div class="lf k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lg an ao ap id lh li lj" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep lk cn"><div class="l ae"><div class="ab cb"><div class="ll lm ln lo lp lq ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lg an ao ap id lr ls ld lt lu lv lw lx s ly lz ma mb mc md me u mf mg mh"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lg an ao ap id lr ls ld lt lu lv lw lx s ly lz ma mb mc md me u mf mg mh"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lg an ao ap id lr ls ld lt lu lv lw lx s ly lz ma mb mc md me u mf mg mh"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div></div></div></div><div class="ab cb mi mj mk ml" role="separator"><span class="mm by bm mn mo mp"/><span class="mm by bm mn mo mp"/><span class="mm by bm mn mo"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><figure class="mt mu mv mw mx my mq mr paragraph-image"><div role="button" tabindex="0" class="mz na ed nb bh nc"><div class="mq mr ms"><img src="../Images/10746b4c52d60313deafae632ae91b48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*JNeA3R4Re3X3lVe7"/></div></div><figcaption class="ne nf ng mq mr nh ni bf b bg z dx">Photo by <a class="af nj" href="https://unsplash.com/@ciabattespugnose?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Lucrezia Carnelos</a> on <a class="af nj" href="https://unsplash.com/?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="5fbd" class="nk nl fq bf nm nn no gq np nq nr gt ns nt nu nv nw nx ny nz oa ob oc od oe of bk">This walkthrough is for…</h1><ol class=""><li id="0049" class="og oh fq oi b go oj ok ol gr om on oo op oq or os ot ou ov ow ox oy oz pa pb pc pd pe bk">Anyone interested in DIY recommendations</li><li id="b07b" class="og oh fq oi b go pf ok ol gr pg on oo op ph or os ot pi ov ow ox pj oz pa pb pc pd pe bk">Engineers interested in basic PyTorch ranking models</li><li id="5df8" class="og oh fq oi b go pf ok ol gr pg on oo op ph or os ot pi ov ow ox pj oz pa pb pc pd pe bk">Coffee nerds</li></ol><h1 id="83a1" class="nk nl fq bf nm nn no gq np nq nr gt ns nt nu nv nw nx ny nz oa ob oc od oe of bk">This walkthrough is not for…</h1><ol class=""><li id="e42c" class="og oh fq oi b go oj ok ol gr om on oo op oq or os ot ou ov ow ox oy oz pa pb pc pd pe bk">Someone who wants to copy-paste code into their production system</li><li id="d2a4" class="og oh fq oi b go pf ok ol gr pg on oo op ph or os ot pi ov ow ox pj oz pa pb pc pd pe bk">Folks that wanted a TensorFlow model</li></ol><h1 id="ede3" class="nk nl fq bf nm nn no gq np nq nr gt ns nt nu nv nw nx ny nz oa ob oc od oe of bk">Motivation</h1><p id="18fb" class="pw-post-body-paragraph og oh fq oi b go oj ok ol gr om on oo op oq or os ot ou ov ow ox oy oz pa pb fj bk">Imagine you are sitting on your couch, friends or family present. You have your preferred game console/streaming service/music app open, and each item is a glittering jewel of possibility, tailored for you. But those personalized results may be for the solo version of yourself, and do not reflect the version of yourself when surrounded by this particular mix of others.</p><p id="b20e" class="pw-post-body-paragraph og oh fq oi b go pk ok ol gr pl on oo op pm or os ot pn ov ow ox po oz pa pb fj bk">This project truly started with coffee. I am enamored with roasting my own green coffee sourced from Sweet Maria’s (no affiliation), as it has such a variety of delicious possibilities. <a class="af nj" href="https://www.sweetmarias.com/colombia-honey-aponte-hugo-agreda-7759.html" rel="noopener ugc nofollow" target="_blank">Colombian</a>? <a class="af nj" href="https://www.sweetmarias.com/java-dry-process-kuningan-robusta-7286.html" rel="noopener ugc nofollow" target="_blank">Java-beans</a>? <a class="af nj" href="https://www.sweetmarias.com/kenya-kiambu-ngaita-peaberry-7241.html" rel="noopener ugc nofollow" target="_blank">Kenyan Peaberry</a>? Each description is more tantalizing than the last. It is so hard to choose even for myself as an individual. What happens if you are buying green coffee for your family or guests?</p><p id="0027" class="pw-post-body-paragraph og oh fq oi b go pk ok ol gr pl on oo op pm or os ot pn ov ow ox po oz pa pb fj bk">I wanted to create a Learning to Rank (LTR) model that could potentially solve this coffee conundrum. For this project, I began by building a simple <a class="af nj" href="https://www.tensorflow.org/ranking" rel="noopener ugc nofollow" target="_blank">TensorFlow Ranking</a> project to predict user-pair rankings of different coffees. I had some experience with TFR, and so it seemed like a natural fit.</p><p id="b762" class="pw-post-body-paragraph og oh fq oi b go pk ok ol gr pl on oo op pm or os ot pn ov ow ox po oz pa pb fj bk">However, I realized I had never made a ranking model from scratch before! I set about constructing a very hacky PyTorch ranking model to see if I could throw one together and learn something in the process. This is obviously not intended for a production system, and I made a lot of shortcuts along the way, but it has been an amazing pedagogical experience.</p><h1 id="9234" class="nk nl fq bf nm nn no gq np nq nr gt ns nt nu nv nw nx ny nz oa ob oc od oe of bk">Data</h1><figure class="mt mu mv mw mx my mq mr paragraph-image"><div role="button" tabindex="0" class="mz na ed nb bh nc"><div class="mq mr pp"><img src="../Images/c39e6fe51959571e8377a161bee7b3cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*DF-RFrg0EmJuGlPn"/></div></div><figcaption class="ne nf ng mq mr nh ni bf b bg z dx">Photo by <a class="af nj" href="https://unsplash.com/@pritesh557?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Pritesh Sudra</a> on <a class="af nj" href="https://unsplash.com/?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="65e2" class="pw-post-body-paragraph og oh fq oi b go pk ok ol gr pl on oo op pm or os ot pn ov ow ox po oz pa pb fj bk">Our supreme goal is the following:</p><ul class=""><li id="61f8" class="og oh fq oi b go pk ok ol gr pl on oo op pm or os ot pn ov ow ox po oz pa pb pq pd pe bk">develop a ranking model that learns the pairwise preferences of users</li><li id="52eb" class="og oh fq oi b go pf ok ol gr pg on oo op ph or os ot pi ov ow ox pj oz pa pb pq pd pe bk">apply this to predict the listwise ranking of `k` items</li></ul><p id="42bd" class="pw-post-body-paragraph og oh fq oi b go pk ok ol gr pl on oo op pm or os ot pn ov ow ox po oz pa pb fj bk">What signal might lie in user and item feature combinations to produce a set of recommendations for that user pair?</p><p id="878f" class="pw-post-body-paragraph og oh fq oi b go pk ok ol gr pl on oo op pm or os ot pn ov ow ox po oz pa pb fj bk">To collect this data, I had to perform painful research of taste-testing amazing coffees with my wife. Each of us then rated them on a 10-point scale. The target value is simply the sum of our two scores (20 point maximum). The object of the model is to Learn to Rank coffees that we will both enjoy, and not just one member of any pair. The contextual data that we will be using is the following:</p><ul class=""><li id="93eb" class="og oh fq oi b go pk ok ol gr pl on oo op pm or os ot pn ov ow ox po oz pa pb pq pd pe bk">ages of both users in the pair</li><li id="fe3c" class="og oh fq oi b go pf ok ol gr pg on oo op ph or os ot pi ov ow ox pj oz pa pb pq pd pe bk">user ids that will be turned into embeddings</li></ul><p id="cc43" class="pw-post-body-paragraph og oh fq oi b go pk ok ol gr pl on oo op pm or os ot pn ov ow ox po oz pa pb fj bk">SweetMarias.com provides a lot of item data:</p><ul class=""><li id="1d6f" class="og oh fq oi b go pk ok ol gr pl on oo op pm or os ot pn ov ow ox po oz pa pb pq pd pe bk">the origin of the coffee</li><li id="3814" class="og oh fq oi b go pf ok ol gr pg on oo op ph or os ot pi ov ow ox pj oz pa pb pq pd pe bk">Processing and cultivation notes</li><li id="9ee4" class="og oh fq oi b go pf ok ol gr pg on oo op ph or os ot pi ov ow ox pj oz pa pb pq pd pe bk">tasting descriptions</li><li id="ff91" class="og oh fq oi b go pf ok ol gr pg on oo op ph or os ot pi ov ow ox pj oz pa pb pq pd pe bk">professional grading scores (100 point scale)</li></ul><p id="3b9b" class="pw-post-body-paragraph og oh fq oi b go pk ok ol gr pl on oo op pm or os ot pn ov ow ox po oz pa pb fj bk">So for each training example, we will have the user data as the contextual information and each item’s feature set will be concatenated.</p><p id="f4e5" class="pw-post-body-paragraph og oh fq oi b go pk ok ol gr pl on oo op pm or os ot pn ov ow ox po oz pa pb fj bk">TensorFlow Ranking models are typically trained on data in <a class="af nj" href="https://www.tensorflow.org/ranking/tutorials/ranking_dnn_distributed#elwc_data_formats_for_ranking" rel="noopener ugc nofollow" target="_blank">ELWC </a>format: ExampleListWithContext. You can think of it like a dictionary with 2 keys: CONTEXT and EXAMPLES (list). Inside each EXAMPLE is a dictionary of features per item you wish to rank.</p><p id="3adf" class="pw-post-body-paragraph og oh fq oi b go pk ok ol gr pl on oo op pm or os ot pn ov ow ox po oz pa pb fj bk">For example, let us assume that I was searching for a new coffee to try out, and some candidate pool was presented to me of k=10 coffee varietals. An ELWC would consist of the context/user information, as well as a list of 10 items, each with its own feature set.</p><p id="b5cb" class="pw-post-body-paragraph og oh fq oi b go pk ok ol gr pl on oo op pm or os ot pn ov ow ox po oz pa pb fj bk">As I was no longer using TensorFlow Ranking, I made my own hacky ranking/list building aspect of this project. I grabbed random samples of k items from which we have scores and added them to a list. I split the first coffees I tried into a training set, and later examples became a small validation set to evaluate the model.</p><h1 id="da04" class="nk nl fq bf nm nn no gq np nq nr gt ns nt nu nv nw nx ny nz oa ob oc od oe of bk">Feature Intuition</h1><p id="6f5d" class="pw-post-body-paragraph og oh fq oi b go oj ok ol gr om on oo op oq or os ot ou ov ow ox oy oz pa pb fj bk">In this toy example, we have a fairly rich dataset. Context-wise, we ostensibly know the users’ age and can learn their respective preference embeddings. Through subsequent layers inside the LTR, these contextual features can be compared and contrasted. Does one user in the pair like dark, fruity flavors, while the other enjoys invigorating citrus and fruity notes in their cup?</p><figure class="mt mu mv mw mx my mq mr paragraph-image"><div role="button" tabindex="0" class="mz na ed nb bh nc"><div class="mq mr pr"><img src="../Images/bd27ef43ea5e42371aedad3d073eac48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Rexor5VxSR37KuC5"/></div></div><figcaption class="ne nf ng mq mr nh ni bf b bg z dx">Photo by <a class="af nj" href="https://unsplash.com/@nate_dumlao?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Nathan Dumlao</a> on <a class="af nj" href="https://unsplash.com/?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="e8af" class="pw-post-body-paragraph og oh fq oi b go pk ok ol gr pl on oo op pm or os ot pn ov ow ox po oz pa pb fj bk">For the item features, we have a generous helping of rich, descriptive text of each coffee’s tasting notes, origin, etc. More on this later, but the general idea is that we can capture the meaning of these descriptions and match the descriptions with the context (user-pair) data. Finally, we have some numerical features like the product expert tasting score per item that (should) have some semblance to reality.</p><h1 id="3de7" class="nk nl fq bf nm nn no gq np nq nr gt ns nt nu nv nw nx ny nz oa ob oc od oe of bk">Preprocessing</h1><p id="c645" class="pw-post-body-paragraph og oh fq oi b go oj ok ol gr om on oo op oq or os ot ou ov ow ox oy oz pa pb fj bk">A stunning shift is underway in text embeddings from when I was starting out in the ML industry. Long gone are the GLOVE and Word2Vec models that I used to use to try to capture some semantic meaning from a word or phrase. If you head on over to <a class="af nj" href="https://huggingface.co/blog/mteb" rel="noopener ugc nofollow" target="_blank">https://huggingface.co/blog/mteb</a>, you can easily compare what the latest and greatest embedding models are for a variety of purposes.</p><p id="c39a" class="pw-post-body-paragraph og oh fq oi b go pk ok ol gr pl on oo op pm or os ot pn ov ow ox po oz pa pb fj bk">For the sake of simplicity and familiarity, we will be using <a class="af nj" href="https://huggingface.co/BAAI/bge-base-en-v1.5" rel="noopener ugc nofollow" target="_blank">https://huggingface.co/BAAI/bge-base-en-v1.5</a> embeddings to help us project our text features into something understandable by a LTR model. Specifically we will use this for the product descriptions and product names that Sweet Marias provides.</p><p id="ff0b" class="pw-post-body-paragraph og oh fq oi b go pk ok ol gr pl on oo op pm or os ot pn ov ow ox po oz pa pb fj bk">We will also need to convert all of our user- and item-id values into an embedding space. PyTorch handles this beautifully with the <a class="af nj" href="https://pytorch.org/docs/stable/generated/torch.nn.Embedding.html" rel="noopener ugc nofollow" target="_blank">Embedding </a>Layers.</p><p id="6b5b" class="pw-post-body-paragraph og oh fq oi b go pk ok ol gr pl on oo op pm or os ot pn ov ow ox po oz pa pb fj bk">Finally we do some scaling on our float features with a simple <a class="af nj" href="https://scikit-learn.org/stable/modules/generated/sklearn.preprocessing.RobustScaler.html" rel="noopener ugc nofollow" target="_blank">RobustScaler</a>. This can all happen inside our Torch Dataset class which then gets dumped into a DataLoader for training. The trick here is to separate out the different identifiers that will get past into the <code class="cx ps pt pu pv b">forward()</code> call for PyTorch. This <a class="af nj" rel="noopener" target="_blank" href="/deep-learning-using-pytorch-for-tabular-data-c68017d8b480">article </a>by Offir Inbar really saved me some time by doing just that!</p><figure class="mt mu mv mw mx my"><div class="pw io l ed"><div class="px py l"/></div></figure><h1 id="ee8d" class="nk nl fq bf nm nn no gq np nq nr gt ns nt nu nv nw nx ny nz oa ob oc od oe of bk">Model Building and Training</h1><p id="5d7c" class="pw-post-body-paragraph og oh fq oi b go oj ok ol gr om on oo op oq or os ot ou ov ow ox oy oz pa pb fj bk">The only interesting thing about the Torch training was ensuring that the 2 user embeddings (one for each rater) and the <code class="cx ps pt pu pv b">k</code> coffees in the list for training had the correct embeddings and dimensions to pass through our neural network. With a few tweaks, I was able to get something out:</p><figure class="mt mu mv mw mx my"><div class="pw io l ed"><div class="px py l"/></div></figure><p id="92ad" class="pw-post-body-paragraph og oh fq oi b go pk ok ol gr pl on oo op pm or os ot pn ov ow ox po oz pa pb fj bk">This forward pushes each training example into a single concatenated list with all of the features.</p><p id="f492" class="pw-post-body-paragraph og oh fq oi b go pk ok ol gr pl on oo op pm or os ot pn ov ow ox po oz pa pb fj bk">With so few data points (only 16 coffees were rated), it can be difficult to train a robust NN model. I often build a simple <code class="cx ps pt pu pv b">sklearn</code> model side by side so that I can compare the results. Are we really learning anything?</p><p id="a609" class="pw-post-body-paragraph og oh fq oi b go pk ok ol gr pl on oo op pm or os ot pn ov ow ox po oz pa pb fj bk">Using the same data preparation techniques, I built a LogisticRegression multi-class classifier model, and then dumped out the <code class="cx ps pt pu pv b">.predict_proba()</code> scores to be used as our rankings. What could our metrics say about the performance of these two models?</p><h1 id="2eca" class="nk nl fq bf nm nn no gq np nq nr gt ns nt nu nv nw nx ny nz oa ob oc od oe of bk">Results</h1><p id="ff83" class="pw-post-body-paragraph og oh fq oi b go oj ok ol gr om on oo op oq or os ot ou ov ow ox oy oz pa pb fj bk">For the metrics, I chose to track two:</p><ol class=""><li id="698e" class="og oh fq oi b go pk ok ol gr pl on oo op pm or os ot pn ov ow ox po oz pa pb pc pd pe bk">Top (`k=1`) accuracy</li><li id="2b95" class="og oh fq oi b go pf ok ol gr pg on oo op ph or os ot pi ov ow ox pj oz pa pb pc pd pe bk"><a class="af nj" href="https://en.wikipedia.org/wiki/Discounted_cumulative_gain#Normalized_DCG" rel="noopener ugc nofollow" target="_blank">NDCG</a></li></ol><p id="9aea" class="pw-post-body-paragraph og oh fq oi b go pk ok ol gr pl on oo op pm or os ot pn ov ow ox po oz pa pb fj bk">The goal, of course, is to get the ranking correct for these coffees. NDCG will fit the bill nicely here. However, I suspected that the LogReg model might struggle with the ranking aspect, so I thought I might throw a simple accuracy in there as well. Sometimes you only want one really good cup of coffee and don’t need a ranking!</p><p id="e4a9" class="pw-post-body-paragraph og oh fq oi b go pk ok ol gr pl on oo op pm or os ot pn ov ow ox po oz pa pb fj bk">Without any significant investment in parameter tuning on my part, I achieved very similar results between the two models. SKLearn had slightly worse NDCG on the (tiny) validation set (0.9581 vs 0.950), but similar accuracy. I believe with some hyper-parameter tuning on both the PyTorch model and the LogReg model, the results could be very similar with so little data. But at least they broadly agree!</p><h1 id="faf1" class="nk nl fq bf nm nn no gq np nq nr gt ns nt nu nv nw nx ny nz oa ob oc od oe of bk">Future Work</h1><p id="88c5" class="pw-post-body-paragraph og oh fq oi b go oj ok ol gr om on oo op oq or os ot ou ov ow ox oy oz pa pb fj bk">I have a new batch of 16 pounds of coffee to start ranking to add to the model, and I deliberately added some lesser-known varietals to the mix. I hope to clean up the repo a bit and make it less of a hack-job. Also I need to add a prediction function for unseen coffees so that I can figure out what to buy next order!</p><p id="758b" class="pw-post-body-paragraph og oh fq oi b go pk ok ol gr pl on oo op pm or os ot pn ov ow ox po oz pa pb fj bk">One thing to note is that if you are building a recommender for production, it is often a good idea to use a real library built for ranking. TensorFlow Ranking, XGBoost, LambdaRank, etc. are accepted in the industry and have lots of the pain points ironed out.</p><p id="55f0" class="pw-post-body-paragraph og oh fq oi b go pk ok ol gr pl on oo op pm or os ot pn ov ow ox po oz pa pb fj bk">Please check out the repo <a class="af nj" href="https://github.com/franckjay/UserPairRecommendationEngine" rel="noopener ugc nofollow" target="_blank">here</a> and let me know if you catch any bugs! I hope you are inspired to train your own User-Pair model for ranking.</p></div></div></div></div>    
</body>
</html>