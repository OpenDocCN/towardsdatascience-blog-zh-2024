<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Setting up a Pypi mirror in an AWS private environment with Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Setting up a Pypi mirror in an AWS private environment with Terraform</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/set-up-a-pypi-mirror-in-an-aws-private-environment-with-terraform-f0fcc1b67cc0?source=collection_archive---------7-----------------------#2024-03-06">https://towardsdatascience.com/set-up-a-pypi-mirror-in-an-aws-private-environment-with-terraform-f0fcc1b67cc0?source=collection_archive---------7-----------------------#2024-03-06</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="gr gs gt gu gv ab"><div><div class="ab gw"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@florentpajot?source=post_page---byline--f0fcc1b67cc0--------------------------------" rel="noopener follow"><div class="l gx gy by gz ha"><div class="l ed"><img alt="Florent Pajot" class="l ep by dd de cx" src="../Images/ff375f53bcfdec60e84a24068431361d.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/1*ch47xijOyfkWx_dreEOa-w.jpeg"/><div class="hb by l dd de em n hc eo"/></div></div></a></div></div><div class="hd ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--f0fcc1b67cc0--------------------------------" rel="noopener follow"><div class="l he hf by gz hg"><div class="l ed"><img alt="Towards Data Science" class="l ep by br hh cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hb by l br hh em n hc eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hi ab q"><div class="ab q hj"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hk hl bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hm" data-testid="authorName" href="https://medium.com/@florentpajot?source=post_page---byline--f0fcc1b67cc0--------------------------------" rel="noopener follow">Florent Pajot</a></p></div></div></div><span class="hn ho" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hk hl dx"><button class="hp hq ah ai aj ak al am an ao ap aq ar hr hs ht" disabled="">Follow</button></p></div></div></span></div></div><div class="l hu"><span class="bf b bg z dx"><div class="ab cn hv hw hx"><div class="hy hz ab"><div class="bf b bg z dx ab ia"><span class="ib l hu">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hm ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--f0fcc1b67cc0--------------------------------" rel="noopener follow"><p class="bf b bg z ic id ie if ig ih ii ij bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="hn ho" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">5 min read</span><div class="ik il l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Mar 6, 2024</span></div></span></div></span></div></div></div><div class="ab cp im in io ip iq ir is it iu iv iw ix iy iz ja jb"><div class="h k w ea eb q"><div class="jr l"><div class="ab q js jt"><div class="pw-multi-vote-icon ed ib ju jv jw"><div class=""><div class="jx jy jz ka kb kc kd am ke kf kg jw"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kh ki kj kk kl km kn"><p class="bf b dy z dx"><span class="jy">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao jx ko kp ab q ee kq kr" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="ks"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg></button></div></div></div><div class="ab q jc jd je jf jg jh ji jj jk jl jm jn jo jp jq"><div class="kt k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al ku an ao ap hr kv kw kx" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep ky cn"><div class="l ae"><div class="ab cb"><div class="kz la lb lc ld le ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al ku an ao ap hr lf lg kr lh li lj lk ll s lm ln lo lp lq lr ls u lt lu lv"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al ku an ao ap hr lf lg kr lh li lj lk ll s lm ln lo lp lq lr ls u lt lu lv"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al ku an ao ap hr lf lg kr lh li lj lk ll s lm ln lo lp lq lr ls u lt lu lv"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><p id="33e1" class="pw-post-body-paragraph lw lx fq ly b lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt fj bk">How do you install a Python package in your environment if you don’t have any internet access? I recently came across this issue when creating an AWS Sagemaker Studio environment for my team on AWS.</p><h2 id="33f7" class="mu mv fq bf mw mx my mz na nb nc nd ne mh nf ng nh ml ni nj nk mp nl nm nn no bk">Building an AWS private environment for Sagemaker</h2><p id="08b4" class="pw-post-body-paragraph lw lx fq ly b lz np mb mc md nq mf mg mh nr mj mk ml ns mn mo mp nt mr ms mt fj bk">For this particular project, I set up Sagemaker in VPC Only mode with the constraint of keeping the architecture private, which means creating a VPC and private subnets, but no access to the internet.</p><p id="8ace" class="pw-post-body-paragraph lw lx fq ly b lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt fj bk">So all network communications, including application communication with AWS APIs, must go through VPC Endpoint interfaces. This allows for keeping connection secured as data sent and received will never go through the internet using the AWS network backbone instead.</p><p id="ba27" class="pw-post-body-paragraph lw lx fq ly b lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt fj bk">It is particularly suited for limiting exposure to security risks, more particularly when you’re processing personal information, or must comply with some security standards.</p><figure class="nx ny nz oa ob oc nu nv paragraph-image"><div role="button" tabindex="0" class="od oe ed of bh og"><div class="nu nv nw"><img src="../Images/980cca82296b30632ecaa6058b1111f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*lBLSUWLFAkqc22VW"/></div></div><figcaption class="oi oj ok nu nv ol om bf b bg z dx">Photo by <a class="af on" href="https://unsplash.com/@nadir_syzygy?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Nadir sYzYgY</a> on <a class="af on" href="https://unsplash.com/?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h2 id="e526" class="mu mv fq bf mw mx my mz na nb nc nd ne mh nf ng nh ml ni nj nk mp nl nm nn no bk">Accessing the Pypi package repository from AWS Sagemaker</h2><p id="71df" class="pw-post-body-paragraph lw lx fq ly b lz np mb mc md nq mf mg mh nr mj mk ml ns mn mo mp nt mr ms mt fj bk">In my team, Data Scientists use Python as a primary language and sometimes need Python packages that are not provided in <a class="af on" href="https://docs.aws.amazon.com/sagemaker/latest/dg/docker-containers-prebuilt.html" rel="noopener ugc nofollow" target="_blank">Sagemaker’s pre-built Python images</a>, so I’ll focus on this use case. Fortunately, the solution is also working for other languages and repositories like npm.</p><p id="dee2" class="pw-post-body-paragraph lw lx fq ly b lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt fj bk">Your users will typically try to install whatever package they need via pip command. But, as no internet access is allowed, this command will fail because pip won’t be able to contact Pypi.org servers.</p><p id="0a82" class="pw-post-body-paragraph lw lx fq ly b lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt fj bk"><strong class="ly fr">Opening internet</strong></p><p id="f365" class="pw-post-body-paragraph lw lx fq ly b lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt fj bk">One option is to open access to the internet and allow outbound HTTP connections to Fastly CDN IPs used by Pypi.org servers. But, this is not viable in our case as we don’t want any internet connection in the architecture.</p><p id="864f" class="pw-post-body-paragraph lw lx fq ly b lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt fj bk"><strong class="ly fr">Using a dedicated Pypi server</strong></p><p id="8d37" class="pw-post-body-paragraph lw lx fq ly b lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt fj bk"><a class="af on" href="https://aws.amazon.com/fr/blogs/machine-learning/hosting-a-private-pypi-server-for-amazon-sagemaker-studio-notebooks-in-a-vpc/" rel="noopener ugc nofollow" target="_blank">AWS blog also provides an example of using a Python package named Bandersnatch</a>. This article describes how to set up a server, acting like a bastion host, which will mirror Pypi and will be accessible only to your private subnets.</p><p id="36b0" class="pw-post-body-paragraph lw lx fq ly b lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt fj bk">This is not a viable option as you’ve to know in advance which Python packages you need to provide, and you’ll somehow have to create public subnets and give the Pypi server mirror access to the internet.</p><p id="c365" class="pw-post-body-paragraph lw lx fq ly b lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt fj bk"><strong class="ly fr">Using AWS Cordeartifact</strong></p><p id="b910" class="pw-post-body-paragraph lw lx fq ly b lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt fj bk">This is ultimately the solution I came up with and which works in my case.</p><p id="e494" class="pw-post-body-paragraph lw lx fq ly b lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt fj bk"><a class="af on" href="https://aws.amazon.com/fr/codeartifact/" rel="noopener ugc nofollow" target="_blank">AWS Codeartifact</a> is the artifact management solution provided by AWS. It is compatible with other AWS services like AWS Service Catalog to control access to resources within an organization.</p><p id="e897" class="pw-post-body-paragraph lw lx fq ly b lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt fj bk">To use it, you’ll have to create a “domain” which serves as an umbrella to manage access and apply policies across your organization. Then, you’ll have to create a repository that will serve your artifacts to your different applications.</p><p id="513c" class="pw-post-body-paragraph lw lx fq ly b lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt fj bk">Also, one repository can have upstream repositories. So, if a Python package is not available in the target repository, the demand will be transmitted to the upstream repository to be fulfilled.</p><p id="b186" class="pw-post-body-paragraph lw lx fq ly b lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt fj bk">More precisely, this workflow takes into account package versions. Official documentation provides a detailed workflow:</p><blockquote class="oo op oq"><p id="2dd1" class="lw lx or ly b lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt fj bk">If <code class="cx os ot ou ov b">my_repo</code> contains the requested package version, it is returned to the client.</p><p id="ffff" class="lw lx or ly b lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt fj bk">If <code class="cx os ot ou ov b">my_repo</code> does not contain the requested package version, CodeArtifact looks for it in <code class="cx os ot ou ov b">my_repo</code>'s upstream repositories. If the package version is found, a reference to it is copied to <code class="cx os ot ou ov b">my_repo</code>, and the package version is returned to the client.</p><p id="1d09" class="lw lx or ly b lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt fj bk">If neither <code class="cx os ot ou ov b">my_repo</code> nor its upstream repositories contain the package version, an HTTP 404 <code class="cx os ot ou ov b">Not Found</code> response is returned to the client.</p></blockquote><p id="69a9" class="pw-post-body-paragraph lw lx fq ly b lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt fj bk">Cool right? It will even cache the package version for future requests.</p><p id="0db7" class="pw-post-body-paragraph lw lx fq ly b lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt fj bk">This is precisely the strategy we are going to use, as AWS Codeartifact allows us to define a repository that has an external connection like Pypi as an upstream repository.</p><h2 id="ca79" class="mu mv fq bf mw mx my mz na nb nc nd ne mh nf ng nh ml ni nj nk mp nl nm nn no bk">Creating AWS Codeartifact resources with Terraform</h2><p id="e2ad" class="pw-post-body-paragraph lw lx fq ly b lz np mb mc md nq mf mg mh nr mj mk ml ns mn mo mp nt mr ms mt fj bk">As AWS Codeartifact is an AWS service, you can easily create a VPC endpoint in your environment VPC to connect to it.</p><p id="9f01" class="pw-post-body-paragraph lw lx fq ly b lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt fj bk">Note: I’m using Terraform v1.6.4 and aws provider v5.38.0</p><pre class="nx ny nz oa ob ow ov ox bp oy bb bk"><span id="46eb" class="oz mv fq ov b bg pa pb l pc pd">locals {<br/>  region = "us-east-1"<br/>}<br/><br/>resource "aws_security_group" "vpce_sg" {<br/>  name        = "AllowTLS"<br/>  description = "Allow TLS inbound traffic and all outbound traffic"<br/>  vpc_id      = aws_vpc.your_vpc.id<br/><br/>  tags = {<br/>    Name = "allow_tls_for_vpce"<br/>  }<br/>}<br/><br/>resource "aws_vpc_security_group_ingress_rule" "allow_tls_ipv4" {<br/>  security_group_id = aws_security_group.allow_tls.id<br/>  cidr_ipv4         = aws_vpc.your_vpc.cidr_block<br/>  from_port         = 443<br/>  ip_protocol       = "tcp"<br/>  to_port           = 443<br/>}<br/><br/>data "aws_iam_policy_document" "codeartifact_vpce_base_policy" {<br/>  statement {<br/>    sid    = "EnableRoles"<br/>    effect = "Allow"<br/>    actions = [<br/>      "codeartifact:GetAuthorizationToken",<br/>      "codeartifact:GetRepositoryEndpoint",<br/>      "codeartifact:ReadFromRepository",<br/>      "sts:GetServiceBearerToken"<br/>    ]<br/>    resources = [<br/>      "*",<br/>    ]<br/>    principals {<br/>      type = "AWS"<br/>      identifiers = [<br/>        aws_iam_role.your_sagemaker_execution_role.arn<br/>      ]<br/>    }<br/>  }<br/>}<br/><br/>resource "aws_vpc_endpoint" "codeartifact_api_vpce" {<br/>  vpc_id            = aws_vpc.your_vpc.id<br/>  service_name      = "com.amazonaws.${local.region}.codeartifact.api"<br/>  vpc_endpoint_type = "Interface"<br/>  subnet_ids        = aws_subnets.your_private_subnets.ids<br/><br/>  security_group_ids = [<br/>    aws_security_group.vpce_sg.id,<br/>  ]<br/><br/>  private_dns_enabled = true<br/>  policy              = data.aws_iam_policy_document.codeartifact_vpce_base_policy.json<br/>  tags = { Name = "codeartifact-api-vpc-endpoint" }<br/>}</span></pre><p id="9af4" class="pw-post-body-paragraph lw lx fq ly b lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt fj bk">Then, you’ll have to create the different resources needed for Codeartifact to handle your requests for new Python packages by mirroring Pypi: a domain, a Pypi repository with an external connection, and a repository that defines Pypi as an upstream repository.</p><pre class="nx ny nz oa ob ow ov ox bp oy bb bk"><span id="b56a" class="oz mv fq ov b bg pa pb l pc pd">resource "aws_codeartifact_domain" "my_domain" {<br/>  domain = "my-domain"<br/><br/>  encryption_key = ""<br/><br/>  tags = { Name = "my-codeartifact-domain" }<br/>}<br/><br/><br/>resource "aws_codeartifact_repository" "public_pypi" {<br/>  repository = "pypi-store"<br/>  domain     = aws_codeartifact_domain.my_domain.domain<br/><br/>  external_connections {<br/>    external_connection_name = "public:pypi"<br/>  }<br/><br/>  tags = { Name = "pypi-store-repository" }<br/>}<br/><br/>resource "aws_codeartifact_repository" "my_repository" {<br/>  repository = "my_repository"<br/>  domain     = aws_codeartifact_domain.my_domain.domain<br/><br/>  upstream {<br/>    repository_name = aws_codeartifact_repository.public_pypi.repository<br/>  }<br/><br/>  tags = { Name = "my-codeartifact-repository" }<br/>}<br/><br/>data "aws_iam_policy_document" "my_repository_policy_document" {<br/>  statement {<br/>    effect = "Allow"<br/><br/>    principals {<br/>      type        = "AWS"<br/>      identifiers = [aws_iam_role.your_sagemaker_execution_role.arn]<br/>    }<br/><br/>    actions   = ["codeartifact:ReadFromRepository"]<br/>    resources = [aws_codeartifact_repository.my_repository.arn]<br/>  }<br/>}<br/><br/>resource "aws_codeartifact_repository_permissions_policy" "my_repository_policy" {<br/>  repository      = aws_codeartifact_repository.my_repository.repository<br/>  domain          = aws_codeartifact_domain.my_domain.domain<br/>  policy_document = data.aws_iam_policy_document.my_repository_policy_document.json<br/>}</span></pre><p id="43be" class="pw-post-body-paragraph lw lx fq ly b lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt fj bk">Here it is! You can now set up a Pypi mirror for your private environment easily.</p><p id="a8e7" class="pw-post-body-paragraph lw lx fq ly b lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt fj bk">To make things usable, you’ll also have to tell pip commands to direct requests to a specific index. Fortunately, AWS created an API to do the heavy lifting for you. Just add this to your code to make it work:</p><pre class="nx ny nz oa ob ow ov ox bp oy bb bk"><span id="3c0a" class="oz mv fq ov b bg pa pb l pc pd">aws codeartifact login --tool pip --repository $CODE_ARTIFACT_REPOSITOR_ARN --domain $CODE_ARTIFACT_DOMAIN_ID --domain-owner $ACCOUNT_ID --region $REGION</span></pre><p id="cb1f" class="pw-post-body-paragraph lw lx fq ly b lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt fj bk">Last but not least, add a VPC Endpoint for AWS Codeartifact in your VPC.</p><pre class="nx ny nz oa ob ow ov ox bp oy bb bk"><span id="8f5b" class="oz mv fq ov b bg pa pb l pc pd">data "aws_iam_policy_document" "codeartifact_vpce_base_policy" {<br/>  statement {<br/>    sid    = "EnableRoles"<br/>    effect = "Allow"<br/>    actions = [<br/>      "codeartifact:GetAuthorizationToken",<br/>      "codeartifact:GetRepositoryEndpoint",<br/>      "codeartifact:ReadFromRepository",<br/>      "sts:GetServiceBearerToken"<br/>    ]<br/>    resources = [<br/>      "*",<br/>    ]<br/>    principals {<br/>      type = "AWS"<br/>      identifiers = [<br/>        aws_iam_role.your_sagemaker_execution_role.arn<br/>      ]<br/>    }<br/>  }<br/>}<br/><br/>resource "aws_vpc_endpoint" "codeartifact_api_vpce" {<br/>  vpc_id            = aws_vpc.your_vpc.id<br/>  service_name      = "com.amazonaws.${local.region}.codeartifact.api"<br/>  vpc_endpoint_type = "Interface"<br/>  subnet_ids        = aws_subnets.your_private_subnets.ids<br/><br/>  security_group_ids = [<br/>    aws_security_group.vpce_sg.id,<br/>  ]<br/><br/>  private_dns_enabled = true<br/>  policy              = data.aws_iam_policy_document.codeartifact_vpce_base_policy.json<br/>  tags = { Name = "codeartifact-api-vpc-endpoint" }<br/>}</span></pre><p id="3a5d" class="pw-post-body-paragraph lw lx fq ly b lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt fj bk">If you would like to receive notifications for my upcoming posts regarding AWS and more, <a class="af on" href="https://medium.com/@florentpajot/subscribe" rel="noopener">please subscribe here</a>.</p><p id="5b59" class="pw-post-body-paragraph lw lx fq ly b lz ma mb mc md me mf mg mh mi mj mk ml mm mn mo mp mq mr ms mt fj bk"><em class="or">Did you know you can clap multiple times?</em></p></div></div></div></div>    
</body>
</html>