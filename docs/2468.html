<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>ITT vs LATE: Estimating Causal Effects with IV in Experiments with Imperfect Compliance</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>ITT vs LATE: Estimating Causal Effects with IV in Experiments with Imperfect Compliance</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/itt-vs-late-estimating-causal-effects-with-iv-in-experiments-with-imperfect-compliance-7ca1220fe425?source=collection_archive---------7-----------------------#2024-10-09">https://towardsdatascience.com/itt-vs-late-estimating-causal-effects-with-iv-in-experiments-with-imperfect-compliance-7ca1220fe425?source=collection_archive---------7-----------------------#2024-10-09</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="c242" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx">Intuition, step-by-step script, and assumptions needed for the use of IV</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hd he hf hg hh ab"><div><div class="ab hi"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@robson.tigre0?source=post_page---byline--7ca1220fe425--------------------------------" rel="noopener follow"><div class="l hj hk by hl hm"><div class="l ed"><img alt="Robson Tigre" class="l ep by dd de cx" src="../Images/220b66a5189f45f3a43ed2c94075f577.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/1*5GlAbU_PI9er3hpw7FFvpg.png"/><div class="hn by l dd de em n ho eo"/></div></div></a></div></div><div class="hp ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--7ca1220fe425--------------------------------" rel="noopener follow"><div class="l hq hr by hl hs"><div class="l ed"><img alt="Towards Data Science" class="l ep by br ht cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hn by l br ht em n ho eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hu ab q"><div class="ab q hv"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hw hx bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hy" data-testid="authorName" href="https://medium.com/@robson.tigre0?source=post_page---byline--7ca1220fe425--------------------------------" rel="noopener follow">Robson Tigre</a></p></div></div></div><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hw hx dx"><button class="ib ic ah ai aj ak al am an ao ap aq ar id ie if" disabled="">Follow</button></p></div></div></span></div></div><div class="l ig"><span class="bf b bg z dx"><div class="ab cn ih ii ij"><div class="ik il ab"><div class="bf b bg z dx ab im"><span class="in l ig">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hy ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--7ca1220fe425--------------------------------" rel="noopener follow"><p class="bf b bg z io ip iq ir is it iu iv bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">9 min read</span><div class="iw ix l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Oct 9, 2024</span></div></span></div></span></div></div></div><div class="ab cp iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn"><div class="h k w ea eb q"><div class="kd l"><div class="ab q ke kf"><div class="pw-multi-vote-icon ed in kg kh ki"><div class=""><div class="kj kk kl km kn ko kp am kq kr ks ki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kt ku kv kw kx ky kz"><p class="bf b dy z dx"><span class="kk">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kj lc ld ab q ee le lf" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="lb"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg><p class="bf b dy z dx"><span class="pw-responses-count la lb">2</span></p></button></div></div></div><div class="ab q jo jp jq jr js jt ju jv jw jx jy jz ka kb kc"><div class="lg k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lh an ao ap id li lj lk" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep ll cn"><div class="l ae"><div class="ab cb"><div class="lm ln lo lp lq lr ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk ml"><img src="../Images/f65f6f65b7387de907d11a279a24d176.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*c0xU2Ayj97ODJuG1oWpCrA.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Image by the author</figcaption></figure><p id="ced4" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">In many experiments, not all individuals assigned to receive a treatment actually take it or use it. For example, a company may send discount coupons to customers, intending for them to use these coupons to make a purchase now, which could subsequently increase their future purchases. However, not all customers will redeem the coupon.</p><p id="0603" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">This scenario represents "imperfect compliance" (<a class="af ny" href="https://medium.com/@robson.tigre0/part-1-simplifying-causal-inference-to-connect-stakeholders-and-data-scientists-e119856f0f61" rel="noopener">see here</a>), where treatment assignment does not always lead to treatment uptake. To estimate the impact of offering the coupon on future customer purchases, we must distinguish between two main approaches:</p><ul class=""><li id="5c72" class="nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx nz oa ob bk"><strong class="ne fr">Intention to treat effect (ITT)</strong>: Estimates the effect of being assigned to receive the coupon, regardless of whether it was used.</li><li id="e26c" class="nc nd fq ne b go oc ng nh gr od nj nk nl oe nn no np of nr ns nt og nv nw nx nz oa ob bk"><strong class="ne fr">Local average treatment effect (LATE)</strong>: Estimates the effect of treatment among those who complied with the assignment — those who used the coupon because they were assigned to receive it.</li></ul><p id="de5f" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">This tutorial introduces the intuition behind these methods, their assumptions, and how to implement them using R (<a class="af ny" href="https://github.com/RobsonTigre/iv_experimental_design/blob/main/IV%20imperfect%20compliance.R" rel="noopener ugc nofollow" target="_blank">see script here</a>). We will also discuss two-stage least squares (2SLS), the method used to estimate LATE.</p><h1 id="44fd" class="oh oi fq bf oj ok ol gq om on oo gt op oq or os ot ou ov ow ox oy oz pa pb pc bk">Intuition</h1><p id="5aae" class="pw-post-body-paragraph nc nd fq ne b go pd ng nh gr pe nj nk nl pf nn no np pg nr ns nt ph nv nw nx fj bk">In experiments with imperfect compliance, treatment assignment (e.g., receiving a coupon) does not perfectly correspond to consuming the treatment (e.g., using the coupon). So simply comparing the treatment group to the control group may lead to misleading conclusions, as the effect of the treatment among those who took it (the blue group in the figure below) gets diluted within the larger treatment group (the green group).</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk pi"><img src="../Images/ce475b292a5bd53825d042519a6647c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DTtn8saZhEEOWCPorBl46Q.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Images by the author</figcaption></figure><p id="02bb" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">To deal with this situation, we use two main approaches:</p><h2 id="e3b8" class="pj oi fq bf oj pk pl pm om pn po pp op nl pq pr ps np pt pu pv nt pw px py pz bk"><strong class="al">Intention-to-treat (ITT)</strong></h2><p id="c8fa" class="pw-post-body-paragraph nc nd fq ne b go pd ng nh gr pe nj nk nl pf nn no np pg nr ns nt ph nv nw nx fj bk">It measures the effect of <em class="qa">being assigned to a treatment, regardless of whether individuals actually follow through with it</em>. In our example, it compares the future average purchases of customers assigned to receive a coupon (treatment group) with those who were not (control group). This method is useful for understanding the effect of the assignment itself, but it may underestimate the treatment's impact, as it includes individuals who did not use the coupon.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk qb"><img src="../Images/fd97e83156ab232bb0bca56f2b867a11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZdgonARG4pq3fDVpeDXaAw.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Image by the author</figcaption></figure><h2 id="d58b" class="pj oi fq bf oj pk pl pm om pn po pp op nl pq pr ps np pt pu pv nt pw px py pz bk"><strong class="al">Local average treatment effect (LATE)</strong></h2><p id="eb49" class="pw-post-body-paragraph nc nd fq ne b go pd ng nh gr pe nj nk nl pf nn no np pg nr ns nt ph nv nw nx fj bk">Here we use the instrumental variables (IV) method to estimate the local average treatment effect, which is the causal effect of treatment among those who complied with the assignment ("compliers") — i.e., those who used the coupon because they were assigned to receive it. In summary:</p><ul class=""><li id="89b6" class="nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx nz oa ob bk">The random assignment to treatment (receiving a coupon) is used as an instrumental variable that strongly predicts actual treatment uptake (using the coupon).</li><li id="5492" class="nc nd fq ne b go oc ng nh gr od nj nk nl oe nn no np of nr ns nt og nv nw nx nz oa ob bk">The IV must meet specific assumptions (relevance, exogeneity, and exclusion restriction) that we will discuss in detail.</li><li id="f854" class="nc nd fq ne b go oc ng nh gr od nj nk nl oe nn no np of nr ns nt og nv nw nx nz oa ob bk">The IV isolates the part of variation in coupon use that's attributable to random assignment, eliminating the influence of unobserved factors that could bias the estimate (<a class="af ny" href="https://medium.com/@robson.tigre0/part-1-simplifying-causal-inference-to-connect-stakeholders-and-data-scientists-e119856f0f61" rel="noopener">see more on "selection bias" here</a>).</li><li id="6dc4" class="nc nd fq ne b go oc ng nh gr od nj nk nl oe nn no np of nr ns nt og nv nw nx nz oa ob bk">The LATE estimates the effect of treatment by adjusting the impact of treatment assignment (ITT) for the compliance rate (the probability of using the coupon given that the customer was assigned).</li><li id="1627" class="nc nd fq ne b go oc ng nh gr od nj nk nl oe nn no np of nr ns nt og nv nw nx nz oa ob bk">It is estimated via two-stage least squares (2SLS), in which each stage is illustrated in the figure below. An intuitive explanation of this method is discussed in <a class="af ny" href="https://medium.com/@robson.tigre0/part-2-simplifying-causal-inference-to-connect-stakeholders-and-data-scientists-e2e9336e1b26" rel="noopener">section 5 here</a>.</li></ul><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk qc"><img src="../Images/24d33846812b14398f49758a792cc872.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BwHqPtWcGcEhuzaJw_3rvA.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Image by the author</figcaption></figure><h1 id="6576" class="oh oi fq bf oj ok ol gq om on oo gt op oq or os ot ou ov ow ox oy oz pa pb pc bk"><strong class="al">Assumptions and limitations</strong></h1><p id="64a1" class="pw-post-body-paragraph nc nd fq ne b go pd ng nh gr pe nj nk nl pf nn no np pg nr ns nt ph nv nw nx fj bk">While the ITT estimate can be obtained directly by using OLS , IV methods require strong assumptions to provide valid causal estimates. Fortunately, those assumptions tend to be met in the experimental scenario:</p><h2 id="019c" class="pj oi fq bf oj pk pl pm om pn po pp op nl pq pr ps np pt pu pv nt pw px py pz bk"><strong class="al">Instrument relevance</strong></h2><p id="bfe3" class="pw-post-body-paragraph nc nd fq ne b go pd ng nh gr pe nj nk nl pf nn no np pg nr ns nt ph nv nw nx fj bk">The instrumental variable (in this case, assignment to the treatment group) must be correlated with the endogenous variable whose effect on future purchases we want to measure (coupon usage). In other words, random assignment to receive a coupon should significantly increase the likelihood that a customer uses it. This is tested via the magnitude and statistical significance of the treatment assignment coefficient in the first stage regression.</p><h2 id="892f" class="pj oi fq bf oj pk pl pm om pn po pp op nl pq pr ps np pt pu pv nt pw px py pz bk"><strong class="al">Instrument exogeneity and exclusion restriction</strong></h2><p id="6e22" class="pw-post-body-paragraph nc nd fq ne b go pd ng nh gr pe nj nk nl pf nn no np pg nr ns nt ph nv nw nx fj bk">The instrumental variable must be independent of any unobserved factors that influence the outcome (future purchases). It should impact the outcome only through its effect on the endogenous variable (coupon usage).</p><blockquote class="qd qe qf"><p id="3615" class="nc nd qa ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">In simpler terms, the instrument should influence the outcome only by affecting coupon usage, and not through any other pathway.</p></blockquote><p id="eee9" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">In our scenario, the random assignment of coupons ensures that it is not correlated with any unobserved customer characteristics that could affect future purchases. Randomization also implies that the impact of being assigned a coupon will primarily depend on whether the customer chooses to use it or not.</p><h2 id="c57e" class="pj oi fq bf oj pk pl pm om pn po pp op nl pq pr ps np pt pu pv nt pw px py pz bk"><strong class="al">Limitations and challenges</strong></h2><ol class=""><li id="9401" class="nc nd fq ne b go pd ng nh gr pe nj nk nl pf nn no np pg nr ns nt ph nv nw nx qg oa ob bk">The LATE provides the causal effect only for "compliers" — customers who used the coupon because they received it, and this effect is specific to this group (local validity only). It cannot be generalized to all customers or those who used the coupon for other reasons.</li><li id="8b56" class="nc nd fq ne b go oc ng nh gr od nj nk nl oe nn no np of nr ns nt og nv nw nx qg oa ob bk">When compliance rates are low (meaning only a small proportion of customers respond to the treatment), the estimated effect becomes less precise, and the findings are less reliable. Since the effect is based on a small number of compliers, it is also difficult to determine if the results are meaningful for the broader population.</li><li id="227e" class="nc nd fq ne b go oc ng nh gr od nj nk nl oe nn no np of nr ns nt og nv nw nx qg oa ob bk">The assumptions of exogeneity and exclusion restriction are not directly testable, meaning that we must rely on the experimental design or on theoretical arguments to support the validity of the IV implementation.</li></ol><h1 id="02e2" class="oh oi fq bf oj ok ol gq om on oo gt op oq or os ot ou ov ow ox oy oz pa pb pc bk"><strong class="al">Hands-on with instrumental variables using R</strong></h1><p id="202a" class="pw-post-body-paragraph nc nd fq ne b go pd ng nh gr pe nj nk nl pf nn no np pg nr ns nt ph nv nw nx fj bk">Now that we understand the intuition and assumptions, we will apply these techniques in an example to estimate both ITT and LATE in R. We will explore the following scenario, reproduced in this <a class="af ny" href="https://github.com/RobsonTigre/iv_experimental_design/blob/main/IV%20imperfect%20compliance.R" rel="noopener ugc nofollow" target="_blank">R script</a>:</p><blockquote class="qd qe qf"><p id="ec25" class="nc nd qa ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">An e-commerce company wants to assess whether the use of discount coupons increases future customer purchases. To circumvent selection bias, coupons were randomly sent to a group of customers, but not all recipients used them. Additionally, customers who did not receive a coupon had no access to it.</p></blockquote><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk qh"><img src="../Images/4fdb20e440433ce09aae7487017fca47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MpWlgn8HYgePWjnA-ovang.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Image by the author</figcaption></figure><p id="69d5" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">I simulated a dataset representing that situation:</p><ul class=""><li id="9372" class="nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx nz oa ob bk"><strong class="ne fr">treatment:</strong> Half of the customers were randomly <em class="qa">assigned to receive the coupon</em> (treatment = 1) while the other half did not receive (treatment = 0).</li><li id="cfd3" class="nc nd fq ne b go oc ng nh gr od nj nk nl oe nn no np of nr ns nt og nv nw nx nz oa ob bk"><strong class="ne fr">coupon_use:</strong> Among the individuals who received treatment, <em class="qa">those who used the coupon</em> to make a purchase are identified by coupon_use = 1.</li><li id="fd73" class="nc nd fq ne b go oc ng nh gr od nj nk nl oe nn no np of nr ns nt og nv nw nx nz oa ob bk"><strong class="ne fr">income and age:</strong> simulated covariates that follow a normal distribution.</li><li id="890f" class="nc nd fq ne b go oc ng nh gr od nj nk nl oe nn no np of nr ns nt og nv nw nx nz oa ob bk"><strong class="ne fr">prob_coupon_use:</strong> To make this more realistic, the probability of coupon usage varies among those who received the coupons. Individuals with higher income and lower age tend to have a higher likelihood of using the coupons.</li><li id="3f92" class="nc nd fq ne b go oc ng nh gr od nj nk nl oe nn no np of nr ns nt og nv nw nx nz oa ob bk"><strong class="ne fr">future_purchases:</strong> The outcome, future purchases in R$, is also influenced by income and age.</li><li id="fc10" class="nc nd fq ne b go oc ng nh gr od nj nk nl oe nn no np of nr ns nt og nv nw nx nz oa ob bk"><strong class="ne fr">past_purchases: </strong>Purchases in R$ from previous months, before the coupon assignment. This should not be correlated with receiving or using a coupon after we control for the covariates.</li><li id="a6ca" class="nc nd fq ne b go oc ng nh gr od nj nk nl oe nn no np of nr ns nt og nv nw nx nz oa ob bk">Finally, the simulated effect of coupon usage for customers who used the coupon is set to "<strong class="ne fr">true_effect &lt;- 50</strong>". This means that, on average, using the coupon increases future purchases by R$50 for those who redeemed it.</li></ul><h2 id="5bd5" class="pj oi fq bf oj pk pl pm om pn po pp op nl pq pr ps np pt pu pv nt pw px py pz bk"><strong class="al">Verifying Assumptions</strong></h2><p id="ad30" class="pw-post-body-paragraph nc nd fq ne b go pd ng nh gr pe nj nk nl pf nn no np pg nr ns nt ph nv nw nx fj bk"><strong class="ne fr">Instrument relevance: </strong>The first stage regression explains the relationship between belonging to the treatment group and the usage of the coupon. In this regression, the coefficient for "<strong class="ne fr">treatment"</strong> was 0.362, meaning that ~36% of the treatment group used the coupon. The p-value for this coefficient was &lt; 0.01, with a t-statistic of 81.2 (substantial), indicating that treatment assignment (receiving a coupon) significantly influences coupon use.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk qi"><img src="../Images/41299bf7cd97a8969c0e18431b3ff675.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KYEg5PcGFXz_2dt2RgxOew.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Image by the author</figcaption></figure><p id="c52e" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk"><strong class="ne fr">Instrument exogeneity and exclusion restriction: </strong>By construction, since assignment is random, the instrument is not correlated with unobserved factors that affect future purchases. But in any case, these assumptions are indirectly testable via the two sets of results below:</p><p id="bb0d" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">The first set includes regression results from the first (<a class="af ny" href="https://github.com/RobsonTigre/iv_experimental_design/blob/main/IV%20imperfect%20compliance.R" rel="noopener ugc nofollow" target="_blank">only in the script</a>) and second stages (below), with and without covariates. These should yield similar results to support the idea that our instrument (coupon assignment) affects the outcome (future purchases) only through the endogenous variable (coupon use). Without covariates, the estimated effect was 49.24 with a p-value &lt; 0.01, and with covariates, it was 49.31 with a p-value &lt; 0.01.</p></div></div><div class="mr"><div class="ab cb"><div class="lm qj ln qk lo ql cf qm cg qn ci bh"><figure class="mm mn mo mp mq mr qp qq paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk qo"><img src="../Images/1f4c032ce2b7d94991bbc4b7dd534f28.png" data-original-src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*5xtcgTGYo3T9RMTmt9mNfg.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Image by the author</figcaption></figure></div></div></div><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="37c7" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">The second set involved a placebo test to determine whether the instrument affects past purchases (which it logically shouldn't). This test suggests that the instrument does not have a direct effect on the outcome outside of its effect through the endogenous variable. The estimated effect, with or without covariates, was close to zero and not statistically significant.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk qr"><img src="../Images/fce708994aa1892f857bc059f1ca29cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0IjKPmV8sBxLoPOJyB60CQ.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Image by the author</figcaption></figure><h2 id="225d" class="pj oi fq bf oj pk pl pm om pn po pp op nl pq pr ps np pt pu pv nt pw px py pz bk"><strong class="al">LATE with two-stage least squares (2SLS)</strong></h2><p id="0236" class="pw-post-body-paragraph nc nd fq ne b go pd ng nh gr pe nj nk nl pf nn no np pg nr ns nt ph nv nw nx fj bk">Due to the nature of the indirect tests discussed above, we ended up anticipating the results of our main analysis, including the LATE (see the second figure of the subsection "Verifying Assumptions"). But now let's go into more detail about this estimation process, which involves two steps using the 2SLS method:</p><ol class=""><li id="a1ac" class="nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx qg oa ob bk"><strong class="ne fr">First stage:</strong> We regress coupon usage on treatment assignment. This generates predicted values of coupon usage, isolating the portion attributable to random assignment.</li><li id="33a9" class="nc nd fq ne b go oc ng nh gr od nj nk nl oe nn no np of nr ns nt og nv nw nx qg oa ob bk"><strong class="ne fr">Second stage:</strong> We take the predicted coupon usage from the first stage and regress it against future purchases. This step allows us to estimate the causal impact of coupon usage.</li></ol><pre class="mm mn mo mp mq qs qt qu bp qv bb bk"><span id="9e87" class="qw oi fq qt b bg qx qy l qz ra">first_stage &lt;- lm(coupon_use ~ treatment + income + age, data = data)<br/>second_stage &lt;- ivreg(future_purchases ~ coupon_use + income + age | treatment + income + age, data = data)</span></pre><p id="4ef7" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">By applying the 2SLS method, we derive an unbiased estimate of the causal effect of coupon usage specifically for those who comply with the treatment, effectively filtering out the influence of random assignment.</p><h2 id="148c" class="pj oi fq bf oj pk pl pm om pn po pp op nl pq pr ps np pt pu pv nt pw px py pz bk"><strong class="al">Estimating causal effects</strong></h2><p id="b285" class="pw-post-body-paragraph nc nd fq ne b go pd ng nh gr pe nj nk nl pf nn no np pg nr ns nt ph nv nw nx fj bk"><strong class="ne fr">ITT estimate</strong>: It measures the average effect that offering a coupon has on customers' future purchases. In our specific example, the coefficient for treatment was R$17.89 with a p-value &lt; 0.01, while controlling for age and income. This indicates a significant effect of offering the coupon, although due to non-compliance, ITT will generally be lower than the true causal effect.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk rb"><img src="../Images/faa3c195790e94ee555e4ebf73537914.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WPqWrM-22_lMtTJGYgCp4w.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Image by the author</figcaption></figure><p id="6b73" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk"><strong class="ne fr">LATE estimate using IV</strong>: It represents the causal effect of coupon usage on future purchases among compliers (those who used the coupon because they received it). In our example, the estimated LATE was close to $50 (see the second figure in subsection "Verifying assumptions"), indicating that customers who complied by using the coupon saw their future purchases increase by roughly $50 compared to what would have happened without the coupon.</p><p id="74c1" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">This result is larger than the ITT effect of R$17.89, as LATE focuses specifically on compliers, who are more likely to experience the true causal impact of using the coupon. Now you see how measuring LATE is important in experiments like this, helping us derive a more accurate understanding of the impact on individuals who actually use the treatment, and providing insights into the true efficacy of the intervention.</p><blockquote class="qd qe qf"><p id="3d91" class="nc nd qa ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Just out of curiosity, run the following part of the <a class="af ny" href="https://github.com/RobsonTigre/iv_experimental_design/blob/main/IV%20imperfect%20compliance.R" rel="noopener ugc nofollow" target="_blank">script</a> to learn that neither the difference in means between compliers and non-compliers, nor the difference between compliers and the control group, gives us the LATE simulated in the data — a point that many data professionals tend to overlook.</p></blockquote><pre class="mm mn mo mp mq qs qt qu bp qv bb bk"><span id="8f9a" class="qw oi fq qt b bg qx qy l qz ra">mean_compliers - mean_non_compliers # difference in means between compliers and non-compliers<br/>mean_compliers - mean_control # difference in means between compliers and control</span></pre><h1 id="f39f" class="oh oi fq bf oj ok ol gq om on oo gt op oq or os ot ou ov ow ox oy oz pa pb pc bk">Insights to take home</h1><p id="5c1b" class="pw-post-body-paragraph nc nd fq ne b go pd ng nh gr pe nj nk nl pf nn no np pg nr ns nt ph nv nw nx fj bk">Many data professionals focus only on the ITT estimate, often because it's easier to explain or because they aren't familiar with other estimands. However, the ITT effect can obscure the true impact on those who actually "consumed" the treatment. The LATE, on the other hand, provides a more accurate measure of the interventions effectiveness among compliers, offering insights that ITT alone cannot capture.</p><p id="8fab" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Although the instrumental variables (IV) approach may initially seem complex, random assignment in an experimental setup makes IV a powerful and reliable tool for isolating causal effects. Notice, however, that IV methods can also be applied beyond experimental contexts, provided the assumptions hold. For example, in a fuzzy regression discontinuity design (RDD), IV is a credible way to estimate local treatment effects, even though <a class="af ny" href="https://medium.com/@robson.tigre0/when-and-how-to-apply-causal-inference-with-rdd-be6b96733dcc" rel="noopener">sharp RDD</a> might appear more straightforward.</p><h1 id="a70a" class="oh oi fq bf oj ok ol gq om on oo gt op oq or os ot ou ov ow ox oy oz pa pb pc bk">Thank you for reading. Follow me for more in this series :)</h1><p id="b113" class="pw-post-body-paragraph nc nd fq ne b go pd ng nh gr pe nj nk nl pf nn no np pg nr ns nt ph nv nw nx fj bk">If you enjoyed this content and want to learn more about causal inference and econometrics, follow me <a class="af ny" href="https://medium.com/@robson.tigre0" rel="noopener">here</a> and on <a class="af ny" href="https://www.linkedin.com/in/robson-tigre/" rel="noopener ugc nofollow" target="_blank">Linkedin</a>, where I post about causal inference and career.</p><p id="66f4" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Would you like to support, me? Just share this with those who may be interested!</p><p id="ac5e" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk"><strong class="ne fr">Recommended references</strong></p><ul class=""><li id="5ea5" class="nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx nz oa ob bk">Facure M. (2022). Causal Inference for the Brave and True, <a class="af ny" href="https://matheusfacure.github.io/python-causality-handbook/08-Instrumental-Variables.html" rel="noopener ugc nofollow" target="_blank">chapter 8</a> and <a class="af ny" href="https://matheusfacure.github.io/python-causality-handbook/09-Non-Compliance-and-LATE.html" rel="noopener ugc nofollow" target="_blank">chapter 9</a>.</li><li id="a940" class="nc nd fq ne b go oc ng nh gr od nj nk nl oe nn no np of nr ns nt og nv nw nx nz oa ob bk">Huntington-Klein N. (2021). The Effect: An Introduction to Research Design and Causality, <a class="af ny" href="https://theeffectbook.net/ch-InstrumentalVariables.html" rel="noopener ugc nofollow" target="_blank">chapter 19</a>.</li></ul></div></div></div></div>    
</body>
</html>