<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Building an AI Assistant with DSPy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Building an AI Assistant with DSPy</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/building-an-ai-assistant-with-dspy-2e1e749a1a95?source=collection_archive---------0-----------------------#2024-03-07">https://towardsdatascience.com/building-an-ai-assistant-with-dspy-2e1e749a1a95?source=collection_archive---------0-----------------------#2024-03-07</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="afc3" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx">A way to program and tune prompt-agnostic LLM agent pipelines</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hd he hf hg hh ab"><div><div class="ab hi"><div><div class="bm" aria-hidden="false"><a href="https://lakshmanok.medium.com/?source=post_page---byline--2e1e749a1a95--------------------------------" rel="noopener follow"><div class="l hj hk by hl hm"><div class="l ed"><img alt="Lak Lakshmanan" class="l ep by dd de cx" src="../Images/9faaaf72d600f592cbaf3e9089cbb913.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/2*TveVoapl-TEk-jBTrbis8w.jpeg"/><div class="hn by l dd de em n ho eo"/></div></div></a></div></div><div class="hp ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--2e1e749a1a95--------------------------------" rel="noopener follow"><div class="l hq hr by hl hs"><div class="l ed"><img alt="Towards Data Science" class="l ep by br ht cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hn by l br ht em n ho eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hu ab q"><div class="ab q hv"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hw hx bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hy" data-testid="authorName" href="https://lakshmanok.medium.com/?source=post_page---byline--2e1e749a1a95--------------------------------" rel="noopener follow">Lak Lakshmanan</a></p></div></div></div><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hw hx dx"><button class="ib ic ah ai aj ak al am an ao ap aq ar id ie if" disabled="">Follow</button></p></div></div></span></div></div><div class="l ig"><span class="bf b bg z dx"><div class="ab cn ih ii ij"><div class="ik il ab"><div class="bf b bg z dx ab im"><span class="in l ig">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hy ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--2e1e749a1a95--------------------------------" rel="noopener follow"><p class="bf b bg z io ip iq ir is it iu iv bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">9 min read</span><div class="iw ix l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Mar 7, 2024</span></div></span></div></span></div></div></div><div class="ab cp iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn"><div class="h k w ea eb q"><div class="kd l"><div class="ab q ke kf"><div class="pw-multi-vote-icon ed in kg kh ki"><div class=""><div class="kj kk kl km kn ko kp am kq kr ks ki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kt ku kv kw kx ky kz"><p class="bf b dy z dx"><span class="kk">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kj lc ld ab q ee le lf" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="lb"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg><p class="bf b dy z dx"><span class="pw-responses-count la lb">6</span></p></button></div></div></div><div class="ab q jo jp jq jr js jt ju jv jw jx jy jz ka kb kc"><div class="lg k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lh an ao ap id li lj lk" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep ll cn"><div class="l ae"><div class="ab cb"><div class="lm ln lo lp lq lr ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><p id="fa66" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">I hate prompt engineering. For one thing, I do not want to prostrate before a LLM (“you are the world’s best copywriter … “), bribe it (“I will tip you $10 if you …”), or nag it (“Make sure to …”). For another, prompts are brittle — small changes to prompts can cause major changes to the output. This makes it hard to develop repeatable functionality using LLMs.</p><p id="45c6" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Unfortunately, developing LLM-based applications today involves tuning and tweaking prompts. Moving from writing code in a programming language that the computer follows precisely to writing ambiguous natural language instructions that are imperfectly followed does not seem like progress. That’s why I found working with LLMs a frustrating exercise — I prefer writing and debugging computer programs that I can actually reason about.</p><p id="5ee8" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">What if, though, you can program on top of LLMs using a high-level programming framework, and let the framework write and tune prompts for you? Would be great, wouldn’t it? This — the ability to build agent pipelines programmatically without dealing with prompts and to tune these pipelines in a data-driven and LLM-agnostic way — is the key premise behind <a class="af nf" href="https://github.com/stanfordnlp/dspy" rel="noopener ugc nofollow" target="_blank">DSPy</a>.</p><h2 id="dc15" class="ng nh fq bf ni nj nk nl nm nn no np nq ms nr ns nt mw nu nv nw na nx ny nz oa bk">An AI Assistant</h2><p id="e8bb" class="pw-post-body-paragraph mj mk fq ml b go ob mn mo gr oc mq mr ms od mu mv mw oe my mz na of nc nd ne fj bk">To illustrate how DSPy works, I’ll build an AI assistant.</p><p id="915f" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">What’s an AI assistant? It’s a computer program that provides assistance to a human doing a task. The ideal AI assistant works <em class="og">proactively </em>on behalf of the user (a chatbot can be a failsafe for functionality that is not easy to find in your product or a way end-users can reach out for customer support, but should not be the main/only AI assistance in your application). So, designing an AI assistant consists of thinking through a workflow and determining how you could want to streamline it using AI.</p><p id="17b1" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">A typical AI assistant streamlines a workflow by (1) retrieving information such as company policies relevant to the task, (2) extracting information from documents such as those sent in by customers, (3) filling out forms or checklists based on textual analysis of the policies and documents, (4) collecting parameters and making function calls on the human’s behalf, and (5) identifying potential errors and highlighting risks.</p><p id="781b" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">The use case I will use to illustrate an AI assistant involves the card game bridge. Even though I’m building an AI assistant for bridge bidding, you don’t need to understand bridge to understand the concepts here. The reason I chose bridge is that there is a lot of jargon, quite a bit of human judgement involved, and several external tools that an advisor can use. These are the key characteristics of the industry problems and backoffice processes that you might want to build AI assistants for. But because it’s a game, there is no confidential information involved.</p><h2 id="fcf4" class="ng nh fq bf ni nj nk nl nm nn no np nq ms nr ns nt mw nu nv nw na nx ny nz oa bk">Agent Framework</h2><p id="c293" class="pw-post-body-paragraph mj mk fq ml b go ob mn mo gr oc mq mr ms od mu mv mw oe my mz na of nc nd ne fj bk">The assistant, when asked a question like “What is Stayman?”, uses a number of backend services to carry out its task. These backend services are invoked via agents, which are themselves built using language models. As with microservices in software engineering, the use of agents and backend services allows for decoupling and specialization — the AI assistant does not need to know how things are done, only what it needs done and each agent can know how to do only its own thing.</p><figure class="ok ol om on oo op oh oi paragraph-image"><div role="button" tabindex="0" class="oq or ed os bh ot"><div class="oh oi oj"><img src="../Images/a96506f5a47510890f4aa8eae03392ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pAanjY-oYGQV-7nV9dKyIg.jpeg"/></div></div><figcaption class="ov ow ox oh oi oy oz bf b bg z dx">An agent framework. Image by author. Sketches in the image were generated using Gemini.</figcaption></figure><p id="8eda" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">In an agent framework, the agents can often be smaller language models (LMs) that need to be accurate, but don’t have world knowledge. The agents will be able to “reason” (through chain-of-thought), search (through Retrieval-Augmented-Generation), and do non-textual work (by extracting the parameters to pass into a backend function). Instead of having disparate capabilities or skills, the entire agent framework is fronted by an AI assistant that is an extremely fluent and coherent LLM. This LLM will know the intents it needs to handle and how to route those intents. It needs to have world knowledge as well. Often, there is a separate policy or guardrails LLM that acts as a filter. The AI assistant is invoked when the user makes a query (the chatbot use case) or when there is a triggering event (the proactive assistant use case).</p><h2 id="8554" class="ng nh fq bf ni nj nk nl nm nn no np nq ms nr ns nt mw nu nv nw na nx ny nz oa bk">Zero Shot prompting with DSPy</h2><p id="503f" class="pw-post-body-paragraph mj mk fq ml b go ob mn mo gr oc mq mr ms od mu mv mw oe my mz na of nc nd ne fj bk">To build the whole architecture above, I’ll use DSPy. The <a class="af nf" href="https://github.com/lakshmanok/lakblogs/tree/main/bridge_bidding_advisor" rel="noopener ugc nofollow" target="_blank">entire code is on GitHub</a>; start with <a class="af nf" href="https://github.com/lakshmanok/lakblogs/blob/main/bridge_bidding_advisor/bidding_advisor.py" rel="noopener ugc nofollow" target="_blank">bidding_advisor.py</a> in that directory and follow along.</p><p id="2e4d" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">In DSPy, the process of sending a prompt to an LLM and getting a response back looks like this:</p><pre class="ok ol om on oo pa pb pc bp pd bb bk"><span id="9ce0" class="pe nh fq pb b bg pf pg l ph pi">class ZeroShot(dspy.Module):<br/>    """<br/>    Provide answer to question<br/>    """<br/>    def __init__(self):<br/>        super().__init__()<br/>        self.prog = dspy.Predict("question -&gt; answer")<br/><br/>    def forward(self, question):<br/>        return self.prog(question="In the game of bridge, " + question)</span></pre><p id="2293" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">There are four things happening in the snippet above:</p><ol class=""><li id="534d" class="mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne pj pk pl bk">Write a subclass of dspy.Module</li><li id="315a" class="mj mk fq ml b go pm mn mo gr pn mq mr ms po mu mv mw pp my mz na pq nc nd ne pj pk pl bk">In the init method, set up a LM module. The simplest is dspy.Predict which is a single call.</li><li id="2c9c" class="mj mk fq ml b go pm mn mo gr pn mq mr ms po mu mv mw pp my mz na pq nc nd ne pj pk pl bk">The Predict constructor takes a signature. Here, I say that there is one input (question) and one output (answer).</li><li id="0219" class="mj mk fq ml b go pm mn mo gr pn mq mr ms po mu mv mw pp my mz na pq nc nd ne pj pk pl bk">Write a forward() method that takes the input(s) specified (here: question) and returns the what was promised in the signature (here: answer). It does this by calling the dspy.Predict object created in the init method.</li></ol><p id="cb61" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">I could have just passed the question along as-is, but just to show you that I can somewhat affect the prompt, I added a bit of context.</p><p id="9728" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Note that the code above is completely LLM-agnostic, and there is no groveling, bribery, etc. in the prompt.</p><p id="0ed9" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">To call the above module, you first initialize dspy with an LLM:</p><pre class="ok ol om on oo pa pb pc bp pd bb bk"><span id="7eb1" class="pe nh fq pb b bg pf pg l ph pi">gemini = dspy.Google("models/gemini-1.0-pro",<br/>                         api_key=api_key,<br/>                         temperature=temperature)<br/>dspy.settings.configure(lm=gemini, max_tokens=1024)</span></pre><p id="7034" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Then, you invoke your module:</p><pre class="ok ol om on oo pa pb pc bp pd bb bk"><span id="8a4d" class="pe nh fq pb b bg pf pg l ph pi">module = ZeroShot()<br/>response = module("What is Stayman?")<br/>print(response)</span></pre><p id="2758" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">When I did that, I got:</p><pre class="ok ol om on oo pa pb pc bp pd bb bk"><span id="9e4a" class="pe nh fq pb b bg pf pg l ph pi">Prediction(<br/>    answer='Question: In the game of bridge, What is Stayman?\nAnswer: A conventional bid of 2♣ by responder after a 1NT opening bid, asking opener to bid a four-card major suit if he has one, or to pass if he does not.'<br/>)</span></pre><p id="8b7c" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Want to use a different LLM? Change the settings configuration lines to:</p><pre class="ok ol om on oo pa pb pc bp pd bb bk"><span id="0c43" class="pe nh fq pb b bg pf pg l ph pi">gpt35 = dspy.OpenAI(model="gpt-3.5-turbo",<br/>                        api_key=api_key,<br/>                        temperature=temperature)<br/>dspy.settings.configure(lm=gpt35, max_tokens=1024)</span></pre><h2 id="1603" class="ng nh fq bf ni nj nk nl nm nn no np nq ms nr ns nt mw nu nv nw na nx ny nz oa bk">Text Extraction</h2><p id="274e" class="pw-post-body-paragraph mj mk fq ml b go ob mn mo gr oc mq mr ms od mu mv mw oe my mz na of nc nd ne fj bk">If all DSPy were doing was making it easier to call out to LLMs and abstract out the LLM, people wouldn’t be this excited about DSPy. Let’s continue to build out the AI assistant and tour some of the other advantages as we go along.</p><p id="d8f6" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Let’s say that we want to use an LLM to do some entity extraction. We can do this by instructing the LLM to identify the thing we want to extract (date, product SKU, etc.). Here, we’ll ask it to find bridge jargon:</p><pre class="ok ol om on oo pa pb pc bp pd bb bk"><span id="ba8b" class="pe nh fq pb b bg pf pg l ph pi">class Terms(dspy.Signature):<br/>    """<br/>    List of extracted entities<br/>    """<br/>    prompt = dspy.InputField()<br/>    terms = dspy.OutputField(format=list)<br/><br/><br/>class FindTerms(dspy.Module):<br/>    """<br/>    Extract bridge terms from a question<br/>    """<br/>    def __init__(self):<br/>        super().__init__()<br/>        self.entity_extractor = dspy.Predict(Terms)<br/><br/>    def forward(self, question):<br/>        max_num_terms = max(1, len(question.split())//4)<br/>        instruction = f"Identify up to {max_num_terms} terms in the following question that are jargon in the card game bridge."<br/>        prediction = self.entity_extractor(<br/>            prompt=f"{instruction}\n{question}"<br/>        )<br/>        return prediction.terms</span></pre><p id="3162" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">While we could have represented the signature of the module as “prompt -&gt; terms”, we can also represent the signature as a Python class.</p><p id="077a" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Calling this module on a statement:</p><pre class="ok ol om on oo pa pb pc bp pd bb bk"><span id="8e03" class="pe nh fq pb b bg pf pg l ph pi">module = FindTerms()<br/>response = module("Playing Stayman and Transfers, what do you bid with 5-4 in the majors?")<br/>print(response)</span></pre><p id="6c1a" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">We’ll get:</p><pre class="ok ol om on oo pa pb pc bp pd bb bk"><span id="9862" class="pe nh fq pb b bg pf pg l ph pi">['Stayman', 'Transfers']</span></pre><p id="c755" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Note how concise and readable this is.</p><h2 id="ad2a" class="ng nh fq bf ni nj nk nl nm nn no np nq ms nr ns nt mw nu nv nw na nx ny nz oa bk">RAG</h2><p id="8cb0" class="pw-post-body-paragraph mj mk fq ml b go ob mn mo gr oc mq mr ms od mu mv mw oe my mz na of nc nd ne fj bk">DSPy comes built-in with several retrievers. But these essentially just functions and you can wrap existing retrieval code into a dspy.Retriever. It supports several of the more popular ones, including ChromaDB:</p><pre class="ok ol om on oo pa pb pc bp pd bb bk"><span id="478e" class="pe nh fq pb b bg pf pg l ph pi">from chromadb.utils import embedding_functions<br/>default_ef = embedding_functions.DefaultEmbeddingFunction()<br/>bidding_rag = ChromadbRM(CHROMA_COLLECTION_NAME, CHROMADB_DIR, default_ef, k=3)</span></pre><p id="0f90" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Of course, I had to get a document on bridge bidding, chunk it, and load it into ChromaDB. That code is in the repo if you are interested, but I’ll omit it as it’s not relevant to this article.</p><h2 id="87f4" class="ng nh fq bf ni nj nk nl nm nn no np nq ms nr ns nt mw nu nv nw na nx ny nz oa bk">Orchestration</h2><p id="7675" class="pw-post-body-paragraph mj mk fq ml b go ob mn mo gr oc mq mr ms od mu mv mw oe my mz na of nc nd ne fj bk">So now you have all the agents implemented, each as its own dspy.Module. Now, to build the orchestrator LLM, the one that receives the command or trigger and invokes the agent modules in some fashion.</p><p id="135a" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Orchestration of the modules also happens in a dspy.Module:</p><pre class="ok ol om on oo pa pb pc bp pd bb bk"><span id="ceb9" class="pe nh fq pb b bg pf pg l ph pi">class AdvisorSignature(dspy.Signature):<br/>    definitions = dspy.InputField(format=str)  # function to call on input to make it a string<br/>    bidding_system = dspy.InputField(format=str) # function to call on input to make it a string<br/>    question = dspy.InputField()<br/>    answer = dspy.OutputField()<br/><br/>class BridgeBiddingAdvisor(dspy.Module):<br/>    """<br/>    Functions as the orchestrator. All questions are sent to this module.<br/>    """<br/>    def __init__(self):<br/>        super().__init__()<br/>        self.find_terms = FindTerms()<br/>        self.definitions = Definitions()<br/>        self.prog = dspy.ChainOfThought(AdvisorSignature, n=3)<br/><br/>    def forward(self, question):<br/>        terms = self.find_terms(question)<br/>        definitions = [self.definitions(term) for term in terms]<br/>        bidding_system = bidding_rag(question)<br/>        prediction = self.prog(definitions=definitions,<br/>                               bidding_system=bidding_system,<br/>                               question="In the game of bridge, " + question,<br/>                               max_tokens=-1024)<br/>        return prediction.answer</span></pre><p id="34dd" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Instead of using dspy.Predict for the final step, I’ve used a ChainOfThought (COT=3).</p><h2 id="4395" class="ng nh fq bf ni nj nk nl nm nn no np nq ms nr ns nt mw nu nv nw na nx ny nz oa bk">Optimizer</h2><p id="aa5d" class="pw-post-body-paragraph mj mk fq ml b go ob mn mo gr oc mq mr ms od mu mv mw oe my mz na of nc nd ne fj bk">Now that we have the entire chain all set up, we can of course, simply call the orchestrator module to test it out. But more important, we can have dspy automatically tune the prompts for us based on example data.</p><p id="0ace" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">To load in these examples and ask dspy to tune it (this is called a teleprompter, but the name will be changed to Optimizer, a much more descriptive name for what it does), I do:</p><pre class="ok ol om on oo pa pb pc bp pd bb bk"><span id="8de3" class="pe nh fq pb b bg pf pg l ph pi">traindata = json.load(open("trainingdata.json", "r"))['examples']<br/>trainset = [dspy.Example(question=e['question'], answer=e['answer']) for e in traindata]<br/>    <br/># train<br/>teleprompter = teleprompt.LabeledFewShot()<br/>optimized_advisor = teleprompter.compile(student=BridgeBiddingAdvisor(), trainset=trainset)<br/><br/># use optimized advisor just like the original orchestrator<br/>response = optimized_advisor("What is Stayman?")<br/>print(response)</span></pre><p id="2d2e" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">I used just 3 examples in the example above, but obviously, you’d use hundreds or thousands of examples to get a properly tuned set of prompts. Worth noting is that the tuning is done over the entire pipeline; you don’t have to mess around with the modules one by one.</p><p id="f87b" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Is the optimized pipeline better?</p><p id="60f4" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">While the original pipeline returned the following for this question (intermediate outputs are also shown, and Two spades is wrong):</p><pre class="ok ol om on oo pa pb pc bp pd bb bk"><span id="2337" class="pe nh fq pb b bg pf pg l ph pi">a: Playing Stayman and Transfers, what do you bid with 5-4 in the majors?<br/>b: ['Stayman', 'Transfers']<br/>c: ['Stayman convention | Stayman is a bidding convention in the card game contract bridge. It is used by a partnership to find a 4-4 or 5-3 trump fit in a major suit after making a one notrump (1NT) opening bid and it has been adapted for use after a 2NT opening, a 1NT overcall, and many other natural notrump bids.', "Jacoby transfer | The Jacoby transfer, or simply transfers, in the card game contract bridge, is a convention initiated by responder following partner's notrump opening bid that forces opener to rebid in the suit ranked just above that bid by responder. For example, a response in diamonds forces a rebid in hearts and a response in hearts forces a rebid in spades. Transfers are used to show a weak hand with a long major suit, and to ensure that opener declare the hand if the final contract is in the suit transferred to, preventing the opponents from seeing the cards of the stronger hand."]<br/>d: ['stayman ( possibly a weak ... 1602', '( scrambling for a two -  ... 1601', '( i ) two hearts is weak  ... 1596']<br/>Two spades.</span></pre><p id="63a0" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">The optimized pipeline returns the correct answer of “Smolen”:</p><pre class="ok ol om on oo pa pb pc bp pd bb bk"><span id="86ca" class="pe nh fq pb b bg pf pg l ph pi">a: Playing Stayman and Transfers, what do you bid with 5-4 in the majors?<br/>b: ['Stayman', 'Transfers']<br/>c: ['Stayman convention | Stayman is a bidding convention in the card game contract bridge. It is used by a partnership to find a 4-4 or 5-3 trump fit in a major suit after making a one notrump (1NT) opening bid and it has been adapted for use after a 2NT opening, a 1NT overcall, and many other natural notrump bids.', "Jacoby transfer | The Jacoby transfer, or simply transfers, in the card game contract bridge, is a convention initiated by responder following partner's notrump opening bid that forces opener to rebid in the suit ranked just above that bid by responder. For example, a response in diamonds forces a rebid in hearts and a response in hearts forces a rebid in spades. Transfers are used to show a weak hand with a long major suit, and to ensure that opener declare the hand if the final contract is in the suit transferred to, preventing the opponents from seeing the cards of the stronger hand."]<br/>d: ['stayman ( possibly a weak ... 1602', '( scrambling for a two -  ... 1601', '( i ) two hearts is weak  ... 1596']<br/>After a 1NT opening, Smolen allows responder to show 5-4 in the majors with game-forcing values.</span></pre><p id="c19b" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">The reason is the prompt that dspy has created. For the question “What is Stayman?”, for example, note that it has built a rationale out of the term definitions, and several matches in the RAG:</p><figure class="ok ol om on oo op oh oi paragraph-image"><div role="button" tabindex="0" class="oq or ed os bh ot"><div class="oh oi pr"><img src="../Images/2474b11fcd12ed06f0e50c8693631c41.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dMCVcFjLnb4lZGmDLKPIfw.png"/></div></div><figcaption class="ov ow ox oh oi oy oz bf b bg z dx">Prompt created by dspy.ChainOfThought based on the term definitions, RAG, etc.</figcaption></figure><p id="aa4e" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Again, I didn’t write any of the tuned prompt above. It was all written for me. You can also see where this is headed in the future— you might be able to fine-tune the entire pipeline to run on a smaller LLM.</p><p id="c766" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Enjoy!</p><h2 id="11c8" class="ng nh fq bf ni nj nk nl nm nn no np nq ms nr ns nt mw nu nv nw na nx ny nz oa bk">Next steps</h2><ol class=""><li id="e9a6" class="mj mk fq ml b go ob mn mo gr oc mq mr ms od mu mv mw oe my mz na of nc nd ne pj pk pl bk">Look at my <a class="af nf" href="https://github.com/lakshmanok/lakblogs/tree/main/bridge_bidding_advisor" rel="noopener ugc nofollow" target="_blank">code in GitHub</a>, starting with <a class="af nf" href="https://github.com/lakshmanok/lakblogs/blob/main/bridge_bidding_advisor/bidding_advisor.py" rel="noopener ugc nofollow" target="_blank">bidding_advisor.py</a>.</li><li id="01b6" class="mj mk fq ml b go pm mn mo gr pn mq mr ms po mu mv mw pp my mz na pq nc nd ne pj pk pl bk">Read more about DSPy here: <a class="af nf" href="https://dspy-docs.vercel.app/docs/intro" rel="noopener ugc nofollow" target="_blank">https://dspy-docs.vercel.app/docs/intro</a></li><li id="0150" class="mj mk fq ml b go pm mn mo gr pn mq mr ms po mu mv mw pp my mz na pq nc nd ne pj pk pl bk">Learn how to play bridge here: <a class="af nf" href="https://www.trickybridge.com/" rel="noopener ugc nofollow" target="_blank">https://www.trickybridge.com/</a> (sorry, couldn’t resist).</li></ol></div></div></div></div>    
</body>
</html>