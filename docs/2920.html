<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>PostgreSQL: Query Optimization for Mere Humans</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>PostgreSQL: Query Optimization for Mere Humans</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/query-optimization-for-mere-humans-in-postgresql-875ab864390a?source=collection_archive---------4-----------------------#2024-12-03">https://towardsdatascience.com/query-optimization-for-mere-humans-in-postgresql-875ab864390a?source=collection_archive---------4-----------------------#2024-12-03</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="8b43" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx">Understanding a PostgreSQL execution plan with practical examples</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hd he hf hg hh ab"><div><div class="ab hi"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@Eyaltra?source=post_page---byline--875ab864390a--------------------------------" rel="noopener follow"><div class="l hj hk by hl hm"><div class="l ed"><img alt="Eyal Trabelsi" class="l ep by dd de cx" src="../Images/60562caa76b824eac9e21f1c0a2933fc.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/1*yavjMVASfr5taFbVE2eo7Q.jpeg"/><div class="hn by l dd de em n ho eo"/></div></div></a></div></div><div class="hp ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--875ab864390a--------------------------------" rel="noopener follow"><div class="l hq hr by hl hs"><div class="l ed"><img alt="Towards Data Science" class="l ep by br ht cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hn by l br ht em n ho eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hu ab q"><div class="ab q hv"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hw hx bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hy" data-testid="authorName" href="https://medium.com/@Eyaltra?source=post_page---byline--875ab864390a--------------------------------" rel="noopener follow">Eyal Trabelsi</a></p></div></div></div><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hw hx dx"><button class="ib ic ah ai aj ak al am an ao ap aq ar id ie if" disabled="">Follow</button></p></div></div></span></div></div><div class="l ig"><span class="bf b bg z dx"><div class="ab cn ih ii ij"><div class="ik il ab"><div class="bf b bg z dx ab im"><span class="in l ig">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hy ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--875ab864390a--------------------------------" rel="noopener follow"><p class="bf b bg z io ip iq ir is it iu iv bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">8 min read</span><div class="iw ix l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Dec 3, 2024</span></div></span></div></span></div></div></div><div class="ab cp iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn"><div class="h k w ea eb q"><div class="kd l"><div class="ab q ke kf"><div class="pw-multi-vote-icon ed in kg kh ki"><div class=""><div class="kj kk kl km kn ko kp am kq kr ks ki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kt ku kv kw kx ky kz"><p class="bf b dy z dx"><span class="kk">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kj la lb ab q ee lc ld" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="le"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg></button></div></div></div><div class="ab q jo jp jq jr js jt ju jv jw jx jy jz ka kb kc"><div class="lf k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lg an ao ap id lh li lj" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep lk cn"><div class="l ae"><div class="ab cb"><div class="ll lm ln lo lp lq ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lg an ao ap id lr ls ld lt lu lv lw lx s ly lz ma mb mc md me u mf mg mh"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lg an ao ap id lr ls ld lt lu lv lw lx s ly lz ma mb mc md me u mf mg mh"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lg an ao ap id lr ls ld lt lu lv lw lx s ly lz ma mb mc md me u mf mg mh"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj mk"><img src="../Images/4f384f53a80ad0fe12427dcc5b83524a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*l-3On57NJoJ7maR3"/></div></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">Photo by <a class="af nb" href="https://unsplash.com/@grakozy?utm_content=creditCopyText&amp;utm_medium=referral&amp;utm_source=unsplash" rel="noopener ugc nofollow" target="_blank">Greg Rakozy</a> on <a class="af nb" href="https://unsplash.com/photos/silhouette-photography-of-person-oMpAz-DN-9I?utm_content=creditCopyText&amp;utm_medium=referral&amp;utm_source=unsplash" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="3f28" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Today, users have high expectations for the programs they use. Users expect programs to have amazing features, to be fast, and to consume a reasonable amount of resources.</p><p id="4b20" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">As developers, we should thrive to give our users the best experience possible. It’s pretty common that the database becomes the bottleneck, and optimizing queries and eliminating the bottlenecks is not an easy task. Unfortunately, as programs become more and more complex, and as the data become bigger, it becomes harder to write flawless SQL queries.</p><p id="52b6" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Today, I am going to focus on a technique to find those bottlenecks, using the <em class="ny">Explain</em> clause. My goal today is to show you that finding and eliminating those bottlenecks is not rocket science. Everyone can find their bottlenecks without breaking a sweat.</p><p id="1c3f" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">The code for this article can be found on <a class="af nb" href="https://github.com/eyaltrabelsi/my-notebooks/blob/master/Lectures/query_optimization_for_mere_humans/Query%20Optimization%20for%20Mere%20Humans.ipynb" rel="noopener ugc nofollow" target="_blank">GitHub</a>.</p><p id="7f0e" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Note: All images, unless otherwise noted, are by the author.</p></div></div></div><div class="ab cb nz oa ob oc" role="separator"><span class="od by bm oe of og"/><span class="od by bm oe of og"/><span class="od by bm oe of"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><h1 id="d006" class="oh oi fq bf oj ok ol gq om on oo gt op oq or os ot ou ov ow ox oy oz pa pb pc bk">Let’s explain Explain 📜</h1><p id="6e2f" class="pw-post-body-paragraph nc nd fq ne b go pd ng nh gr pe nj nk nl pf nn no np pg nr ns nt ph nv nw nx fj bk">Interactions with databases are done using declarative languages, where SQL is the most common one. The database decides how and what to do behind the scenes and the only glimpse it provides is the execution plan.</p><p id="150c" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">This limitation makes implementing proper debugging tools, and profilers almost impossible in practice. <strong class="ne fr">So we are kind of stuck with execution plans.</strong></p><h2 id="326f" class="pi oi fq bf oj pj pk pl om pm pn po op nl pp pq pr np ps pt pu nt pv pw px py bk">Buzzword alert 🐝!! my goal is to democratize execution plans.</h2><p id="d802" class="pw-post-body-paragraph nc nd fq ne b go pd ng nh gr pe nj nk nl pf nn no np pg nr ns nt ph nv nw nx fj bk">In PostgreSQL in order to get the execution plan one should use <em class="ny">Explain</em>/<em class="ny">Explain analyze </em>clauses:</p><ul class=""><li id="e981" class="nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx pz qa qb bk"><em class="ny">EXPLAIN</em> shows what the planner planned to do.</li><li id="c20e" class="nc nd fq ne b go qc ng nh gr qd nj nk nl qe nn no np qf nr ns nt qg nv nw nx pz qa qb bk"><em class="ny">EXPLAIN ANALYZE</em> what the planner plans to do, <strong class="ne fr">execute the query,</strong> and also show how it did it.</li></ul><p id="a2d8" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk"><strong class="ne fr">Pro Tip #1</strong>💃: go over an execution plan at least once in your career. It's similar across databases, and it is a rare skill in companies.</p><p id="d6c7" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk"><strong class="ne fr">Pro Tip #2 </strong>💃: prefer <em class="ny">EXPLAIN ANALYZE</em> as it holds more information for most cases.</p><p id="498c" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk"><strong class="ne fr">Warning #1</strong> ⚠️ don’t use <em class="ny">EXPLAIN ANALYZE </em>on destructive operations like <em class="ny">DELETE/UPDATE, EXPLAIN </em>will suffice and it doesn’t run the query.</p><p id="9beb" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk"><strong class="ne fr">Warning #2</strong> ⚠️ don’t use <em class="ny">EXPLAIN ANALYZE </em>when resources are scarce like production monitoring, and when a query never finishes<em class="ny">, EXPLAIN </em>will suffice and it doesn’t run the query.</p><p id="6040" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk"><em class="ny">Explain</em> is an awesome tool as it can imply reasons why a query was slow including:</p><ul class=""><li id="d36e" class="nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx pz qa qb bk">Missing/Overused indices/partitions.</li><li id="36b8" class="nc nd fq ne b go qc ng nh gr qd nj nk nl qe nn no np qf nr ns nt qg nv nw nx pz qa qb bk">Unoptimized database configurations.</li><li id="b407" class="nc nd fq ne b go qc ng nh gr qd nj nk nl qe nn no np qf nr ns nt qg nv nw nx pz qa qb bk">Redundant Operations.</li><li id="8af9" class="nc nd fq ne b go qc ng nh gr qd nj nk nl qe nn no np qf nr ns nt qg nv nw nx pz qa qb bk">Stale statistics.</li><li id="9543" class="nc nd fq ne b go qc ng nh gr qd nj nk nl qe nn no np qf nr ns nt qg nv nw nx pz qa qb bk">Too much I/O.</li></ul><p id="979f" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">For the more thorough people you can see the <em class="ny">Explain</em> clause syntax in the next figure:</p><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj qh"><img src="../Images/61acb4497b1c5ad8f1db4fcd7a3597b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O55DqK52i4rQy8kWvO7REg.png"/></div></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">PostgreSQL Explain Clause Syntax</figcaption></figure></div></div></div><div class="ab cb nz oa ob oc" role="separator"><span class="od by bm oe of og"/><span class="od by bm oe of og"/><span class="od by bm oe of"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><h1 id="c430" class="oh oi fq bf oj ok ol gq om on oo gt op oq or os ot ou ov ow ox oy oz pa pb pc bk">Understanding Explain Anatomy🫀</h1><p id="a453" class="pw-post-body-paragraph nc nd fq ne b go pd ng nh gr pe nj nk nl pf nn no np pg nr ns nt ph nv nw nx fj bk">We will use it as an example of a simple query: we want to count the number of users that don’t have Twitter handles.</p><pre class="ml mm mn mo mp qi qj qk bp ql bb bk"><span id="efea" class="qm oi fq qj b bg qn qo l qp qq">EXPLAIN ANALYZE<br/>SELECT COUNT(*) FROM users WHERE twitter != '';</span></pre><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div class="ab cn cb qr"><img src="../Images/9a8f28ed38a9fe982ff8f92ce75497f5.png" data-original-src="https://miro.medium.com/v2/format:webp/1*dfsAx-mjU3KhZSbsKR9yfg.png"/></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">We can see the execution plan returned from the EXPLAIN ANALYZE clause</figcaption></figure><p id="e2fc" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">It looks cryptic at first, and It’s even longer than our query, and that on a small example of real-world execution plans can be overwhelming if you don't focus 😭.</p><p id="caea" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk"><strong class="ne fr">But it does provide useful information. </strong>We can see that the query execution took 1.27 seconds, while the query planning took only 0.4 milli-seconds (negligible time).</p><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div class="ab cn cb qr"><img src="../Images/d5e57f45b5c3501eb7d865b1efe9c8d4.png" data-original-src="https://miro.medium.com/v2/format:webp/1*tcijQ_GFp8iq--nnxbtmAg.png"/></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">We can see the time the query planning and execution took</figcaption></figure><p id="d654" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">The execution plan is structured as an inverse tree. In the next figure, you can see the execution plan is divided into different nodes each one of which represents a different operation whether it's an <em class="ny">Aggregation</em> or a <em class="ny">Scan.</em></p><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div class="ab cn cb qr"><img src="../Images/6a7ccef3d946eef093a5bca9a3c0c39d.png" data-original-src="https://miro.medium.com/v2/format:webp/1*POmK5sHID4H5APlfbmaL-w.png"/></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">We can see the time the query planning and execution took</figcaption></figure><p id="7552" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">There are many kinds of nodes operations, from Scan related (<em class="ny">‘Seq Scan’, ‘Index Only Scan’, etc…</em>), Join related(<em class="ny"> ‘Hash Join’, ’Nested Loop’, etc…), </em>Aggregation related<em class="ny"> (‘GroupAggregate’, ’Aggregate’, etc…) </em>and others<em class="ny"> ( ‘Limit’, ‘Sort’, ‘materialize’, etc..). </em><strong class="ne fr">Fortunately you need to remember any of this.</strong></p><p id="a141" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk"><strong class="ne fr">Pro Tip #3 </strong>💃: Focus is key, look only on nodes that are problematic.</p><p id="9e47" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk"><strong class="ne fr">Pro Tip #4 </strong>💃: Cheat ! on the problematic nodes search what they mean in the <a class="af nb" href="https://www.pgmustard.com/docs/explain" rel="noopener ugc nofollow" target="_blank">explain glossary</a>.</p><p id="0b0d" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Now, let's drill down into how we know which node is the problematic one.</p><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div class="ab cn cb qr"><img src="../Images/5765a24e17bb9ae9361b2481951954f0.png" data-original-src="https://miro.medium.com/v2/format:webp/1*jXnnH_uAybaahQ1WzsXdRw.png"/></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">There is a lot of information we can see on each node</figcaption></figure><p id="0d67" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Let's drill down to what those metrics actually mean.</p><ul class=""><li id="2bb1" class="nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx pz qa qb bk"><strong class="ne fr">Actual Loops</strong>: the number of loops the same node executed is 1. To get the total time and rows, the actual time and rows need to be multiplied by loops values.</li><li id="b1a9" class="nc nd fq ne b go qc ng nh gr qd nj nk nl qe nn no np qf nr ns nt qg nv nw nx pz qa qb bk"><strong class="ne fr">Actual Rows</strong>: the actual number of produced rows of the <em class="ny">Aggregate</em> node is 1 (per-loop average and we have loops is 1).</li><li id="9b9e" class="nc nd fq ne b go qc ng nh gr qd nj nk nl qe nn no np qf nr ns nt qg nv nw nx pz qa qb bk"><strong class="ne fr">Plan Rows</strong>: the estimated number of produced rows of the <em class="ny">Aggregate</em> node is 1. The estimated number of rows can be off depending on statistics.</li><li id="be04" class="nc nd fq ne b go qc ng nh gr qd nj nk nl qe nn no np qf nr ns nt qg nv nw nx pz qa qb bk"><strong class="ne fr">Actual Startup Time</strong>: the time it took to return the first row in milliseconds of the <em class="ny">Aggregate</em> node is 1271.157 (aggregated and includes previous operations).</li><li id="ddd2" class="nc nd fq ne b go qc ng nh gr qd nj nk nl qe nn no np qf nr ns nt qg nv nw nx pz qa qb bk"><strong class="ne fr">Startup Cost</strong>: arbitrary units that represent the estimated time to return the first row of the <em class="ny">Aggregate</em> node is 845110(aggregated and includes previous operations).</li><li id="18b4" class="nc nd fq ne b go qc ng nh gr qd nj nk nl qe nn no np qf nr ns nt qg nv nw nx pz qa qb bk"><strong class="ne fr">Actual Total Time</strong>: the time it took to return all the rows in ms of the <em class="ny">Aggregate</em> node is 1271.158 (per-loop average and we have loops is 1 and aggregated and include previous operations).</li><li id="ec56" class="nc nd fq ne b go qc ng nh gr qd nj nk nl qe nn no np qf nr ns nt qg nv nw nx pz qa qb bk"><strong class="ne fr">Total Cost</strong>: arbitrary units that represent the estimated time to return all the rows of <em class="ny">Aggregate</em> node is 845110 (aggregated).</li><li id="6999" class="nc nd fq ne b go qc ng nh gr qd nj nk nl qe nn no np qf nr ns nt qg nv nw nx pz qa qb bk"><strong class="ne fr">Plan Width</strong>: the estimated average size of rows of the <em class="ny">Aggregate</em> node is 8 bytes.</li></ul><p id="c642" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk"><strong class="ne fr">Pro Tip #5 </strong>💃: be wary of loops, remember to multiply loops when you care about <em class="ny">Actual Rows </em>and<em class="ny"> Actual Total Time.</em></p><p id="273e" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">We will drill in the next section on a practical example.</p></div></div></div><div class="ab cb nz oa ob oc" role="separator"><span class="od by bm oe of og"/><span class="od by bm oe of og"/><span class="od by bm oe of"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><h1 id="37d9" class="oh oi fq bf oj ok ol gq om on oo gt op oq or os ot ou ov ow ox oy oz pa pb pc bk">Example: Performance Optimization🐆</h1><p id="9674" class="pw-post-body-paragraph nc nd fq ne b go pd ng nh gr pe nj nk nl pf nn no np pg nr ns nt ph nv nw nx fj bk">We will use the same query as before.</p><pre class="ml mm mn mo mp qi qj qk bp ql bb bk"><span id="0383" class="qm oi fq qj b bg qn qo l qp qq">EXPLAIN ANALYZE<br/>SELECT COUNT(*) FROM users WHERE twitter != '';</span></pre><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div class="ab cn cb qr"><img src="../Images/c9d940c226ab0b75dc4f477da4b96027.png" data-original-src="https://miro.medium.com/v2/format:webp/1*sWHKqRRwZ3zCr6M3vZFK7Q.png"/></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">We will focus on the Seq Scan node which has the longest actual time</figcaption></figure><p id="f6fb" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">We focus on the longest operation which is the <a class="af nb" href="https://www.pgmustard.com/docs/explain/sequential-scan" rel="noopener ugc nofollow" target="_blank">sequential scan</a> on the users' table. The scan filters out 2,487,813 rows and takes us 1.27 seconds out of 1.271.</p><p id="a09e" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk"><strong class="ne fr">But we are mere humans that don’t tell us anything. </strong>Let's google it (you can use ChatGPT as well) !!!.</p><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div class="ab cn cb qr"><img src="../Images/e202c10e9f78a7914c4ec6e1224da7c4.png" data-original-src="https://miro.medium.com/v2/format:webp/1*jMQGhTdhk76sSVyrHOZBhQ.png"/></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">Googling how to make seq scan faster in PostgreSQL</figcaption></figure><pre class="ml mm mn mo mp qi qj qk bp ql bb bk"><span id="9e1e" class="qm oi fq qj b bg qn qo l qp qq">CREATE INDEX twitter_test ON users (twitter)</span></pre><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div class="ab cn cb qr"><img src="../Images/2dbebcdb3d427e75d385fb1194604613.png" data-original-src="https://miro.medium.com/v2/format:webp/1*BwvC6JwEIGIVnJRf9j3c_Q.png"/></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">We are doing much better, but the Scan node is still the longest in terms of actual time</figcaption></figure><p id="adc6" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">We can see that now we perform an <a class="af nb" href="https://www.pgmustard.com/docs/explain/index-only-scan" rel="noopener ugc nofollow" target="_blank">index only scan</a> on the users' table. It takes us 0.29 seconds instead of 1.27 seconds, which is awesome but not enough for us.</p><p id="0949" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk"><strong class="ne fr">Pro Tip #6</strong>💃: optimize your queries one baby step at a time.</p><p id="7540" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">To understand how much data is passed to the scan. We could use the buffers parameter as you can see down below.</p><p id="7e0d" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk"><strong class="ne fr">Pro Tip #7</strong>💃: When comparing execution plans, look at several metrics.</p><pre class="ml mm mn mo mp qi qj qk bp ql bb bk"><span id="4abf" class="qm oi fq qj b bg qn qo l qp qq">EXPLAIN (ANALYZE, BUFFERS)<br/>SELECT COUNT(*) FROM users WHERE twitter != ''</span></pre><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div class="ab cn cb qr"><img src="../Images/93d19daed446727c8e7c2a33d3a8c6c9.png" data-original-src="https://miro.medium.com/v2/format:webp/1*ZYn0VC5d7Gc8oX0w3dPAMw.png"/></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">We can see quite a lot of information about how much data hit the cache or disk</figcaption></figure><p id="b151" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">We have 51,854 pages to read all from the cache (400 MB), so improving configurations probably won’t change things drastically.</p><p id="124e" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">But, we are not out of options. Since the scan filters out 2,487,813 rows, we can change the index into a partial index but it doesn’t come for free. It will cause writes to take longer, and it will take additional storage, which is quite impactful on systems that scale vertically.</p><p id="0ad9" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk"><strong class="ne fr">Pro Tip #8 </strong>💃: there is no free lunch.</p></div></div></div><div class="ab cb nz oa ob oc" role="separator"><span class="od by bm oe of og"/><span class="od by bm oe of og"/><span class="od by bm oe of"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><h1 id="83ee" class="oh oi fq bf oj ok ol gq om on oo gt op oq or os ot ou ov ow ox oy oz pa pb pc bk">Good optimization options🤞🏻</h1><p id="dd7d" class="pw-post-body-paragraph nc nd fq ne b go pd ng nh gr pe nj nk nl pf nn no np pg nr ns nt ph nv nw nx fj bk">I won’t delve into too many details as this blog is already quite long. These are the first things one might want to tackle when he has slow queries:</p><ul class=""><li id="7f60" class="nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx pz qa qb bk">Picking the right scan method.</li><li id="4e3c" class="nc nd fq ne b go qc ng nh gr qd nj nk nl qe nn no np qf nr ns nt qg nv nw nx pz qa qb bk">Picking the right join method.</li><li id="ffb8" class="nc nd fq ne b go qc ng nh gr qd nj nk nl qe nn no np qf nr ns nt qg nv nw nx pz qa qb bk">Picking the right join order.</li><li id="89c9" class="nc nd fq ne b go qc ng nh gr qd nj nk nl qe nn no np qf nr ns nt qg nv nw nx pz qa qb bk">Push Filters as soon as possible.</li><li id="a97d" class="nc nd fq ne b go qc ng nh gr qd nj nk nl qe nn no np qf nr ns nt qg nv nw nx pz qa qb bk">Reducing disk IO operations when needed.</li></ul><p id="9272" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">In order to manually check specific optimization one can enable/disable settings.</p><pre class="ml mm mn mo mp qi qj qk bp ql bb bk"><span id="5948" class="qm oi fq qj b bg qn qo l qp qq">SET enable_seqscan TO off;<br/>EXPLAIN (ANALYZE) SELECT * FROM foo WHERE c1 &gt; 500;<br/>SET enable_seqscan TO on;</span></pre><p id="2178" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk"><strong class="ne fr">Warning #3</strong> ⚠️: enable/disable settings only after you tried the most basic optimizations as most of the time, PostgreSQL knows what it is doing.</p></div></div></div><div class="ab cb nz oa ob oc" role="separator"><span class="od by bm oe of og"/><span class="od by bm oe of og"/><span class="od by bm oe of"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><h1 id="6e25" class="oh oi fq bf oj ok ol gq om on oo gt op oq or os ot ou ov ow ox oy oz pa pb pc bk">Aren’t there easier ways?!🙏</h1><p id="6842" class="pw-post-body-paragraph nc nd fq ne b go pd ng nh gr pe nj nk nl pf nn no np pg nr ns nt ph nv nw nx fj bk">Unfortunately, <em class="ny">Explain </em>is not perfect and there are reasons why it’s not in every developer toolbox:</p><p id="be55" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk"><strong class="ne fr">You don’t have a history of all the execution plans in production.</strong><br/>We can overcome the lack of history by using tools like <a class="af nb" href="https://www.postgresql.org/docs/current/auto-explain.html" rel="noopener ugc nofollow" target="_blank">auto_explain</a> and <a class="af nb" href="https://github.com/2ndQuadrant/pg_stat_plans" rel="noopener ugc nofollow" target="_blank">pg_stat_plans</a> to record the execution plans on certain conditions such that they won’t have a major effect on production. Another way is to record what queries run at what time and try to reproduce it, but it’s more complicated than it looks.</p><p id="c72b" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk"><strong class="ne fr">Tuning complex queries is not a trivial task with “bare execution plans”</strong>, as they tend to be long and challenging to read. Moreover, they often fail to provide insights into why a particular optimization is not being utilized or offer guidance on how to effectively rewrite the queries for better performance.</p><p id="4e75" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">However, this challenge can be addressed by adopting a highly opinionated structure and metadata using specialized tools. <strong class="ne fr">These help you/the LLM focus on what matter</strong> (whether its schema, whats the bottlenecks and so on). Some of the most prominent tools are:</p><ul class=""><li id="dfe3" class="nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx pz qa qb bk"><a class="af nb" href="https://www.eversql.com/" rel="noopener ugc nofollow" target="_blank">eversql</a> — a mature solution that aims to suggest changes to your <em class="ny">PostgreSQL </em>queries.</li><li id="8cbc" class="nc nd fq ne b go qc ng nh gr qd nj nk nl qe nn no np qf nr ns nt qg nv nw nx pz qa qb bk"><a class="af nb" href="https://www.metisdata.io/" rel="noopener ugc nofollow" target="_blank">metis</a> — aims to suggest changes as a guarding mechanism as part of your development and CI/CD processes for <em class="ny">PostgreSQL</em> databases.</li><li id="4a20" class="nc nd fq ne b go qc ng nh gr qd nj nk nl qe nn no np qf nr ns nt qg nv nw nx pz qa qb bk"><a class="af nb" href="https://github.com/eyaltrabelsi/query-flow" rel="noopener ugc nofollow" target="_blank">QueryFlow</a> — an open-source tool that allows identifying bugs and performance tuning multiple queries (as the hardest queries to debug behave nicely in isolation).</li></ul><p id="726c" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk"><strong class="ne fr">Pro Tip #9 </strong>💃: use tools to make your life easy.</p><p id="6f3f" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">I will give you a taste of how convenient it is to use tools like QueryFlow (For more details you can read the following).</p><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj qs"><img src="../Images/8b7368c085df0fdc6607ce2201a3a0b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iVwp45epASb6E79l1ugdzw.png"/></div></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">QueryFlow visualization of execution plan focusing on duration</figcaption></figure><p id="70bc" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">It should be extremely easy to see that the <em class="ny">Index Only Scan </em>width is much bigger than the aggregation and indicate this is where we should focus. On multiple complex queries, other tools tend to lack</p></div></div></div><div class="ab cb nz oa ob oc" role="separator"><span class="od by bm oe of og"/><span class="od by bm oe of og"/><span class="od by bm oe of"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><h1 id="bc75" class="oh oi fq bf oj ok ol gq om on oo gt op oq or os ot ou ov ow ox oy oz pa pb pc bk">Last words</h1><p id="1286" class="pw-post-body-paragraph nc nd fq ne b go pd ng nh gr pe nj nk nl pf nn no np pg nr ns nt ph nv nw nx fj bk">In this article, we reviewed some of the most common reasons that can cause otherwise perfectly good SQL to be too slow for any time-sensitive applications, and <strong class="ne fr">walk through a mythological way to identify those and avoid them</strong>.</p><p id="7f68" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Due to the extent of the topic, there are many optimizations I haven’t covered. For this reason, I have added additional resources in the end if you want to go the extra mile.</p><p id="127c" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">I am optimistic about the future. I believe these kinds of tools will be as easy as <a class="af nb" href="https://www.w3schools.com/python/python_file_open.asp" rel="noopener ugc nofollow" target="_blank"><em class="ny">opening files in python</em></a>, either by integrating into IDEs, and clients, or providing SAS solutions. This will enable us to become proactive instead of reactive.</p><p id="f725" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">I hope I was able to share my enthusiasm for this fascinating topic and that you find it useful, and as always I am open to any kind of constructive feedback.</p></div></div></div><div class="ab cb nz oa ob oc" role="separator"><span class="od by bm oe of og"/><span class="od by bm oe of og"/><span class="od by bm oe of"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><h1 id="2b2a" class="oh oi fq bf oj ok ol gq om on oo gt op oq or os ot ou ov ow ox oy oz pa pb pc bk">Additional Resources 📚</h1><ul class=""><li id="2303" class="nc nd fq ne b go pd ng nh gr pe nj nk nl pf nn no np pg nr ns nt ph nv nw nx pz qa qb bk"><a class="af nb" href="https://www.youtube.com/watch?v=Ls-uE1V31lE&amp;list=WL&amp;index=5&amp;ab_channel=PostgresConference" rel="noopener ugc nofollow" target="_blank">Deeper Understanding of PostgreSQL Execution Plan (video)</a></li><li id="b01f" class="nc nd fq ne b go qc ng nh gr qd nj nk nl qe nn no np qf nr ns nt qg nv nw nx pz qa qb bk"><a class="af nb" href="https://www.youtube.com/watch?v=mCwwFAl1pBU&amp;ab_channel=SouthernCaliforniaLinuxExpo" rel="noopener ugc nofollow" target="_blank">EXPLAIN Explained (video)</a></li><li id="fab5" class="nc nd fq ne b go qc ng nh gr qd nj nk nl qe nn no np qf nr ns nt qg nv nw nx pz qa qb bk"><a class="af nb" href="https://public.dalibo.com/exports/conferences/_archives/_2012/201211_explain/understanding_explain.pdf" rel="noopener ugc nofollow" target="_blank">Understanding Explain</a></li></ul></div></div></div></div>    
</body>
</html>