<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Models, MLFlow, and Microsoft Fabric</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Models, MLFlow, and Microsoft Fabric</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/models-mlflow-and-microsoft-fabric-8faacaa90814?source=collection_archive---------7-----------------------#2024-04-29">https://towardsdatascience.com/models-mlflow-and-microsoft-fabric-8faacaa90814?source=collection_archive---------7-----------------------#2024-04-29</a></blockquote><div><div class="em ff fg fh fi fj"/><div class="fk fl fm fn fo"><div class="ab cb"><div class="ci bh ew ex ey ez"><div/><div><h2 id="7347" class="pw-subtitle-paragraph go fq fr bf b gp gq gr gs gt gu gv gw gx gy gz ha hb hc hd cq dx">Fabric Madness part 5</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="he hf hg hh hi ab"><div><div class="ab hj"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@roger_noble?source=post_page---byline--8faacaa90814--------------------------------" rel="noopener follow"><div class="l hk hl by hm hn"><div class="l ed"><img alt="Roger Noble" class="l ep by dd de cx" src="../Images/869b5b0f237f24b119ca6c41c2e31162.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/1*DSDhBVvFKAUKXJfpbO5beg.jpeg"/><div class="ho by l dd de em n hp eo"/></div></div></a></div></div><div class="hq ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--8faacaa90814--------------------------------" rel="noopener follow"><div class="l hr hs by hm ht"><div class="l ed"><img alt="Towards Data Science" class="l ep by br hu cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="ho by l br hu em n hp eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hv ab q"><div class="ab q hw"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hx hy bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hz" data-testid="authorName" href="https://medium.com/@roger_noble?source=post_page---byline--8faacaa90814--------------------------------" rel="noopener follow">Roger Noble</a></p></div></div></div><span class="ia ib" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hx hy dx"><button class="ic id ah ai aj ak al am an ao ap aq ar ie if ig" disabled="">Follow</button></p></div></div></span></div></div><div class="l ih"><span class="bf b bg z dx"><div class="ab cn ii ij ik"><div class="il im ab"><div class="bf b bg z dx ab in"><span class="io l ih">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hz ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--8faacaa90814--------------------------------" rel="noopener follow"><p class="bf b bg z ip iq ir is it iu iv iw bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="ia ib" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">6 min read</span><div class="ix iy l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Apr 29, 2024</span></div></span></div></span></div></div></div><div class="ab cp iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo"><div class="h k w ea eb q"><div class="ke l"><div class="ab q kf kg"><div class="pw-multi-vote-icon ed io kh ki kj"><div class=""><div class="kk kl km kn ko kp kq am kr ks kt kj"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l ku kv kw kx ky kz la"><p class="bf b dy z dx"><span class="kl">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kk lb lc ab q ee ld le" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="lf"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg></button></div></div></div><div class="ab q jp jq jr js jt ju jv jw jx jy jz ka kb kc kd"><div class="lg k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lh an ao ap ie li lj lk" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep ll cn"><div class="l ae"><div class="ab cb"><div class="lm ln lo lp lq lr ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lh an ao ap ie ls lt le lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lh an ao ap ie ls lt le lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lh an ao ap ie ls lt le lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk ml"><img src="../Images/bd8a2c9a78a66c843fc0e9dcee09acce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8OZqHuALsx3fotAs87HlwA.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Image by author and ChatGPT. “Design an illustration, with imagery representing multiple machine learning models, focusing on basketball data” prompt. ChatGPT, 4, OpenAI, 25th April. 2024. <a class="af nc" href="https://chat.openai.com./" rel="noopener ugc nofollow" target="_blank">https://chat.openai.com.</a></figcaption></figure><p id="0d8e" class="pw-post-body-paragraph nd ne fr nf b gp ng nh ni gs nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fk bk"><em class="nz">A Huge thanks to </em><a class="af nc" href="https://medium.com/@mgrc99" rel="noopener"><em class="nz">Martim Chaves</em></a><em class="nz"> who co-authored this post and developed the example scripts.</em></p><p id="68b1" class="pw-post-body-paragraph nd ne fr nf b gp ng nh ni gs nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fk bk">So far in this series, we’ve looked at how to use Fabric for collecting data, feature engineering, and training models.</p><p id="0ad4" class="pw-post-body-paragraph nd ne fr nf b gp ng nh ni gs nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fk bk">But now that we have our shiny new models, what do we do with them? How do we keep track of them, and how do we use them to make predictions? This is where MLFlow’s Model Registry comes in, or what Fabric calls an <strong class="nf fs">ML Model</strong>.</p><p id="2237" class="pw-post-body-paragraph nd ne fr nf b gp ng nh ni gs nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fk bk">A model registry allows us to keep track of different versions of a model and their respective performances. This is especially useful in production scenarios, where we need to deploy a specific version of a model for inference.</p><p id="9f58" class="pw-post-body-paragraph nd ne fr nf b gp ng nh ni gs nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fk bk">A Model Registry can be seen as source control for ML Models. Fundamentally, each version represents a distinct set of model files. These files contain the model’s architecture, its trained weights, as well as any other files necessary to load the model and use it.</p><p id="b394" class="pw-post-body-paragraph nd ne fr nf b gp ng nh ni gs nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fk bk">In this post, we’ll discuss how to log models and how to use the model registry to keep track of different versions of a model. We’ll also discuss how to load a model from the registry and use it to make predictions.</p><h1 id="f585" class="oa ob fr bf oc od oe gr of og oh gu oi oj ok ol om on oo op oq or os ot ou ov bk">Registering a Model</h1><p id="8bbf" class="pw-post-body-paragraph nd ne fr nf b gp ow nh ni gs ox nk nl nm oy no np nq oz ns nt nu pa nw nx ny fk bk">There are two ways to register a model in Fabric: via code or via the UI. Let’s look at both.</p><h2 id="8bc7" class="pb ob fr bf oc pc pd pe of pf pg ph oi nm pi pj pk nq pl pm pn nu po pp pq pr bk">Registering a Model using code</h2><p id="751f" class="pw-post-body-paragraph nd ne fr nf b gp ow nh ni gs ox nk nl nm oy no np nq oz ns nt nu pa nw nx ny fk bk">In the <a class="af nc" href="https://medium.com/towards-data-science/experimenting-with-mlflow-and-microsoft-fabric-68f43043ff34" rel="noopener">previous post</a> we looked at creating experiments and logging runs with different configurations. Logging or registering a model can be done using code within a run. To do that, we just have to add a couple of lines of code.</p><pre class="mm mn mo mp mq ps pt pu bp pv bb bk"><span id="7bb6" class="pw ob fr pt b bg px py l pz qa"># Start the training job with `start_run()`<br/>with mlflow.start_run(run_name="logging_a_model") as run:<br/>  # Previous code...<br/>  # Train model<br/>  # Log metrics<br/><br/>  # Calculate predictions for training set<br/>  predictions = model.predict(X_train_scaled_df)<br/><br/>  # Create Signature<br/>  # Signature required for model loading later on<br/>  signature = infer_signature(np.array(X_train_scaled_df), predictions)<br/><br/>  # Model File Name<br/>  model_file_name = model_name + "_file"<br/><br/>  # Log model<br/>  mlflow.tensorflow.log_model(best_model, model_file_name, signature=signature)<br/><br/>  # Get model URI<br/>  model_uri = f"runs:/{run.info.run_id}/{model_file_name}"<br/><br/>  # Register Model<br/>  result = mlflow.register_model(model_uri, model_name)</span></pre><p id="fbb1" class="pw-post-body-paragraph nd ne fr nf b gp ng nh ni gs nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fk bk">In this code snippet, we first calculate the predictions for the training set. Then create a signature, which is essentially the input and output shape of the model. This is necessary to ensure that the model can be loaded later on.</p><p id="9c20" class="pw-post-body-paragraph nd ne fr nf b gp ng nh ni gs nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fk bk">MLFlow has functions to log models made with different commonly used packages, such as <a class="af nc" href="https://www.tensorflow.org/" rel="noopener ugc nofollow" target="_blank">TensorFlow</a>, <a class="af nc" href="https://pytorch.org/" rel="noopener ugc nofollow" target="_blank">PyTorch</a>, and <a class="af nc" href="https://scikit-learn.org/" rel="noopener ugc nofollow" target="_blank">scikit-learn</a>. When <code class="cx qb qc qd pt b">mlflow.tensorflow.log_model</code> is used, a folder is saved, as an artifact, attached to the run, containing the files needed to load and run the model. In these files, the architecture along with with trained weights of the model and any other configuration necessary for reconstruction are found. This makes it possible to load the model later, either to do inference, fine-tune it, or any other regular model operations without having to re-run the original code that created it.</p><p id="3b5d" class="pw-post-body-paragraph nd ne fr nf b gp ng nh ni gs nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fk bk">The model’s URI is used as a “path” to the model file, and is made up of the run ID and the name of the file used for the model. Once we have the model’s URI, we can register a ML Model, using the model’s URI.</p><p id="b836" class="pw-post-body-paragraph nd ne fr nf b gp ng nh ni gs nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fk bk">What’s neat about this is that if a model with the same name already exists, a new version is added. That way we can keep track of different versions of the same model, and see how they perform without having overly complex code to manage this.</p><p id="7853" class="pw-post-body-paragraph nd ne fr nf b gp ng nh ni gs nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fk bk">In our <a class="af nc" href="https://medium.com/towards-data-science/experimenting-with-mlflow-and-microsoft-fabric-68f43043ff34" rel="noopener">previous post</a>, we ran three experiments, one for each model architecture being tested with three different learning rates. For each model architecture, an ML Model was created, and for each learning rate, a version was saved. In total we now have 9 versions to choose from, each with a different architecture and learning rate.</p><h1 id="af9e" class="oa ob fr bf oc od oe gr of og oh gu oi oj ok ol om on oo op oq or os ot ou ov bk">Registering a Model using the UI</h1><p id="ed13" class="pw-post-body-paragraph nd ne fr nf b gp ow nh ni gs ox nk nl nm oy no np nq oz ns nt nu pa nw nx ny fk bk">An <strong class="nf fs">ML Model</strong> can also be registered via Fabric’s UI. Model versions can be imported from the experiments that have been created.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk qe"><img src="../Images/d47fd08d8ffde05970072caa90913ab2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1162/format:webp/0*tLaRGb9x61MbgUgJ.png"/></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Fig. 1 — Creating a ML Model using the UI. Image by author.</figcaption></figure><p id="b574" class="pw-post-body-paragraph nd ne fr nf b gp ng nh ni gs nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fk bk">After creating an ML Model, we can import a model from an existing experiment. To do that, in a run, we have to select <code class="cx qb qc qd pt b">Save</code> in the <code class="cx qb qc qd pt b">Save run as an ML Model</code> section.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk qf"><img src="../Images/21455e93691763f2cd58ffa22dd3fecd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*dbDjO1mFfdm8sx5j.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Fig. 2 — Creating a new version of the created ML Model from a run. Image by author.</figcaption></figure><h1 id="8d54" class="oa ob fr bf oc od oe gr of og oh gu oi oj ok ol om on oo op oq or os ot ou ov bk">Selecting Best Model</h1><p id="818b" class="pw-post-body-paragraph nd ne fr nf b gp ow nh ni gs ox nk nl nm oy no np nq oz ns nt nu pa nw nx ny fk bk">Now that we have registered all of the models, we can select the best one. This can be done either via the UI or code. This can be done by opening each experiment, selecting the <code class="cx qb qc qd pt b">list view</code>, and selecting all of the available runs. After finding the best run, we would have to check which model and version that would be.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk qg"><img src="../Images/2cb6393da3ecff62cba4ab6a74ce2394.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*DIvACpY4PMa4MKkE.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Fig. 3 — Inspecting Experiment. Image by author.</figcaption></figure><p id="1d9f" class="pw-post-body-paragraph nd ne fr nf b gp ng nh ni gs nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fk bk">Alternatively, it can also be done via code, by getting all of the versions of all of the ML Models performance, and selecting the version with the best score.</p><pre class="mm mn mo mp mq ps pt pu bp pv bb bk"><span id="4961" class="pw ob fr pt b bg px py l pz qa">from mlflow.tracking import MlflowClient<br/><br/>client = MlflowClient()<br/><br/>mlmodel_names = list(model_dict.keys())<br/>best_score = 2<br/>metric_name = "brier"<br/>best_model = {"model_name": "", "model_version": -1}<br/><br/>for mlmodel in mlmodel_names:<br/><br/> model_versions = client.search_model_versions(filter_string=f"name = '{mlmodel}'")<br/><br/> for version in model_versions:<br/><br/>  # Get metric history for Brier score and run ID<br/>  metric_history = client.get_metric_history(run_id=version.run_id,<br/>                                             key=metric_name)<br/><br/>  # If score better than best score, save model name and version<br/>  if metric_history:<br/>   last_value = metric_history[-1].value<br/>   if last_value &lt; best_score:<br/>    best_model["model_name"] = mlmodel<br/>    best_model["model_version"] = version.version<br/>    best_score = last_value<br/>  else:<br/>   continue</span></pre><p id="fba0" class="pw-post-body-paragraph nd ne fr nf b gp ng nh ni gs nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fk bk">In this code snippet, we get a list of all of the available ML Models. Then, we iterate over this list and get all of the available versions of each ML Model.</p><p id="29dc" class="pw-post-body-paragraph nd ne fr nf b gp ng nh ni gs nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fk bk">Getting a list of the versions of an ML Model can be done using the following line:</p><pre class="mm mn mo mp mq ps pt pu bp pv bb bk"><span id="980a" class="pw ob fr pt b bg px py l pz qa">model_versions = client.search_model_versions(filter_string=f"name = '{mlmodel}'")</span></pre><p id="244d" class="pw-post-body-paragraph nd ne fr nf b gp ng nh ni gs nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fk bk">Then, for each version, we simply have to get its metric history. That can be done with the following line:</p><pre class="mm mn mo mp mq ps pt pu bp pv bb bk"><span id="72da" class="pw ob fr pt b bg px py l pz qa">metric_history = client.get_metric_history(run_id=version.run_id,<br/>                                         key=metric_name)</span></pre><p id="bd80" class="pw-post-body-paragraph nd ne fr nf b gp ng nh ni gs nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fk bk">After that, we simply have to keep track of the best performing version. At the end of this, we had found the best performing model overall, regardless of architecture and hyperparameters.</p><h1 id="48fa" class="oa ob fr bf oc od oe gr of og oh gu oi oj ok ol om on oo op oq or os ot ou ov bk">Loading the Best Model</h1><p id="ea36" class="pw-post-body-paragraph nd ne fr nf b gp ow nh ni gs ox nk nl nm oy no np nq oz ns nt nu pa nw nx ny fk bk">After finding the best model, using it to get the final predictions can be done using the following code snippet:</p><pre class="mm mn mo mp mq ps pt pu bp pv bb bk"><span id="02bc" class="pw ob fr pt b bg px py l pz qa"># Load the best model<br/>loaded_best_model = mlflow.pyfunc.load_model(f"models:/{best_model['model_name']}/{best_model['model_version'].version}")<br/><br/># Evaluate the best model<br/>final_brier_score = evaluate_model(loaded_best_model, X_test_scaled_df, y_test)<br/>print(f"Best final Brier score: {final_brier_score}")</span></pre><p id="86f1" class="pw-post-body-paragraph nd ne fr nf b gp ng nh ni gs nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fk bk">Loading the model can be done using <code class="cx qb qc qd pt b">mlflow.pyfunc.load_model()</code>, and the only argument that is needed is the model's path. The path of the model is made up of its name and version, in a <code class="cx qb qc qd pt b">models:/[model name]/[version]</code> format. After that, we just have to make sure that the input is the same shape and the features are in the same order as when it was trained - and that's it!</p><p id="995a" class="pw-post-body-paragraph nd ne fr nf b gp ng nh ni gs nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fk bk">Using the test set, we calculated the final Brier Score, <strong class="nf fs">0.20</strong>.</p><h1 id="de9b" class="oa ob fr bf oc od oe gr of og oh gu oi oj ok ol om on oo op oq or os ot ou ov bk">Conclusion</h1><p id="c931" class="pw-post-body-paragraph nd ne fr nf b gp ow nh ni gs ox nk nl nm oy no np nq oz ns nt nu pa nw nx ny fk bk">In this post we discussed the ideas behind a model registry, and why it’s beneficial to use one. We showed how Fabric’s model registry can be used, through the ML Model tool, either via the UI or code. Finally, we looked at loading a model from the registry, to do inference.</p><p id="cf2f" class="pw-post-body-paragraph nd ne fr nf b gp ng nh ni gs nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fk bk">This concludes our Fabric series. We hope you enjoyed it and that you learned something new. If you have any questions or comments, feel free to reach out to us. We’d love to hear from you! 👋</p></div></div></div><div class="ab cb qh qi qj qk" role="separator"><span class="ql by bm qm qn qo"/><span class="ql by bm qm qn qo"/><span class="ql by bm qm qn"/></div><div class="fk fl fm fn fo"><div class="ab cb"><div class="ci bh ew ex ey ez"><p id="5beb" class="pw-post-body-paragraph nd ne fr nf b gp ng nh ni gs nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fk bk"><em class="nz">Originally published at </em><a class="af nc" href="https://nobledynamic.com/posts/fabric-madness-5/" rel="noopener ugc nofollow" target="_blank"><em class="nz">https://nobledynamic.com</em></a><em class="nz"> on April 29, 2024.</em></p></div></div></div></div>    
</body>
</html>