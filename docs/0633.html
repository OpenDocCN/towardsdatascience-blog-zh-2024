<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>How to cross validate your panel data in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>How to cross validate your panel data in Python</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-cross-validate-your-panel-data-in-python-9ad981ddd043?source=collection_archive---------5-----------------------#2024-03-08">https://towardsdatascience.com/how-to-cross-validate-your-panel-data-in-python-9ad981ddd043?source=collection_archive---------5-----------------------#2024-03-08</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="fo bh"><figure class="fp fo bh paragraph-image"><img src="../Images/9ba98d4b8300f30aeec7177892adf319.png" data-original-src="https://miro.medium.com/v2/resize:fit:4800/format:webp/1*hbXCMuSa3x42LiqrA06ujg.jpeg"/><figcaption class="fs ft fu fv fw fx fy bf b bg z dx">Salinas de Janubio, Lanzarote, Canary Islands, Spain. Credit: <a class="af fz" href="https://www.instagram.com/imag3s_4_u/" rel="noopener ugc nofollow" target="_blank">imag3s 4 u</a></figcaption></figure></div><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="175b" class="pw-subtitle-paragraph gz gb gc bf b ha hb hc hd he hf hg hh hi hj hk hl hm hn ho cq dx">An introduction to panel data cross validation using PanelSplit</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hp hq hr hs ht ab"><div><div class="ab hu"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@eric.frey?source=post_page---byline--9ad981ddd043--------------------------------" rel="noopener follow"><div class="l hv hw by hx hy"><div class="l ed"><img alt="Eric Frey" class="l ep by dd de cx" src="../Images/1907ab08a5b30729b4bf71d65e3bb7c4.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/1*ePRPfJqH4rUNdFYW53lo1g.png"/><div class="hz by l dd de em n ia eo"/></div></div></a></div></div><div class="ib ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--9ad981ddd043--------------------------------" rel="noopener follow"><div class="l ic id by hx ie"><div class="l ed"><img alt="Towards Data Science" class="l ep by br if cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hz by l br if em n ia eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="ig ab q"><div class="ab q ih"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b ii ij bk"><a class="af ag ah ai aj ak al am an ao ap aq ar ik" data-testid="authorName" href="https://medium.com/@eric.frey?source=post_page---byline--9ad981ddd043--------------------------------" rel="noopener follow">Eric Frey</a></p></div></div></div><span class="il im" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b ii ij dx"><button class="in io ah ai aj ak al am an ao ap aq ar ip iq ir" disabled="">Follow</button></p></div></div></span></div></div><div class="l is"><span class="bf b bg z dx"><div class="ab cn it iu iv"><div class="iw ix ab"><div class="bf b bg z dx ab iy"><span class="iz l is">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar ik ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--9ad981ddd043--------------------------------" rel="noopener follow"><p class="bf b bg z ja jb jc jd je jf jg jh bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="il im" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">6 min read</span><div class="ji jj l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Mar 8, 2024</span></div></span></div></span></div></div></div><div class="ab cp jk jl jm jn jo jp jq jr js jt ju jv jw jx jy jz"><div class="h k w ea eb q"><div class="kp l"><div class="ab q kq kr"><div class="pw-multi-vote-icon ed iz ks kt ku"><div class=""><div class="kv kw kx ky kz la lb am lc ld le ku"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l lf lg lh li lj lk ll"><p class="bf b dy z dx"><span class="kw">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kv lm ln ab q ee lo lp" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="fp"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg></button></div></div></div><div class="ab q ka kb kc kd ke kf kg kh ki kj kk kl km kn ko"><div class="lq k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lr an ao ap ip ls lt lu" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep lv cn"><div class="l ae"><div class="ab cb"><div class="lw lx ly lz ma fq ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lr an ao ap ip mb mc lp md me mf mg mh s mi mj mk ml mm mn mo u mp mq mr"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lr an ao ap ip mb mc lp md me mf mg mh s mi mj mk ml mm mn mo u mp mq mr"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lr an ao ap ip mb mc lp md me mf mg mh s mi mj mk ml mm mn mo u mp mq mr"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><p id="499b" class="pw-post-body-paragraph ms mt gc mu b ha mv mw mx hd my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn fj bk"><strong class="mu gd">Motivation: </strong>As someone who works with panel data, I often need to perform cross validation. This involves training up to a certain point in time, testing on a subset of observations, training up to a further point in time, testing on a different subset of observations, and iteratively continuing this process on a panel data set. Sound familiar? This can be really frustrating to implement manually. To make things easier, I’ve created a package called <a class="af fz" href="https://github.com/4Freye/panelsplit" rel="noopener ugc nofollow" target="_blank">PanelSplit</a> that can help when working with panel data.</p><p id="caec" class="pw-post-body-paragraph ms mt gc mu b ha mv mw mx hd my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn fj bk">This article shows how you can use PanelSplit when working with panel data; from feature engineering, to hyper-parameter tuning, to generating predictions, PanelSplit is here to help!</p><h2 id="7828" class="no np gc bf nq nr ns nt nu nv nw nx ny nb nz oa ob nf oc od oe nj of og oh oi bk"><strong class="al">What is panel data?</strong></h2><p id="353e" class="pw-post-body-paragraph ms mt gc mu b ha oj mw mx hd ok mz na nb ol nd ne nf om nh ni nj on nl nm nn fj bk">By <strong class="mu gd">panel data</strong>, I mean data where there are multiple entities over time. These entities could be countries, people, organizations, or any other unit of analysis. Multiple observations are recorded over time for these multiple entities.</p><h2 id="480c" class="no np gc bf nq nr ns nt nu nv nw nx ny nb nz oa ob nf oc od oe nj of og oh oi bk">What is cross validation?</h2><p id="5e40" class="pw-post-body-paragraph ms mt gc mu b ha oj mw mx hd ok mz na nb ol nd ne nf om nh ni nj on nl nm nn fj bk">Say we want to get estimates of how good our predictions are when we use a model. How can we do this? The standard approach is <strong class="mu gd">cross validation</strong>, which involves splitting the data up into successive folds, each with its unique training and testing set. The visualization below shows what this looks like for time series data.</p><figure class="op oq or os ot fo fv fw paragraph-image"><div role="button" tabindex="0" class="ou ov ed ow bh ox"><div class="fv fw oo"><img src="../Images/17f39de9360687fc291f49de080a28d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gPdYjkhxNZ56Wip8CSop3Q.png"/></div></div><figcaption class="fs ft fu fv fw fx fy bf b bg z dx">An example of time series cross validation.</figcaption></figure><p id="788e" class="pw-post-body-paragraph ms mt gc mu b ha mv mw mx hd my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn fj bk">While there is already a scikit-learn function to do time series cross validation called <a class="af fz" href="https://scikit-learn.org/stable/modules/generated/sklearn.model_selection.TimeSeriesSplit.html" rel="noopener ugc nofollow" target="_blank"><strong class="mu gd">TimeSeriesSplit</strong></a>, it doesn’t work with panel data. Rather than being a single time series for one entity, panel data has multiple entities and we need a tool that allows us to work with multiple entities.</p><p id="3264" class="pw-post-body-paragraph ms mt gc mu b ha mv mw mx hd my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn fj bk">This is where PanelSplit comes in. <strong class="mu gd">PanelSplit</strong> is a package that allows us to generalize TimeSeriesSplit to panel data. It also offers functionality for transforming, predicting, and much more, but in this introductory article I’ll cover the just basics.</p><h1 id="6cfb" class="oy np gc bf nq oz pa hc nu pb pc hf ny pd pe pf pg ph pi pj pk pl pm pn po pp bk">Performing cross validation with PanelSplit</h1><p id="66ab" class="pw-post-body-paragraph ms mt gc mu b ha oj mw mx hd ok mz na nb ol nd ne nf om nh ni nj on nl nm nn fj bk">Now that we’ve introduced what panel data is and what cross validation looks like in this setting, let’s see how to do cross validation using PanelSplit.</p><p id="34d5" class="pw-post-body-paragraph ms mt gc mu b ha mv mw mx hd my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn fj bk">First, let’s generate some example data to work with:</p><pre class="op oq or os ot pq pr ps bp pt bb bk"><span id="5565" class="pu np gc pr b bg pv pw l px py">import pandas as pd<br/>import numpy as np<br/><br/># generate example data<br/>num_countries = 3<br/>years = range(2000, 2005)<br/>num_years = len(years)<br/><br/>data = {<br/>    'country_id': [c for c in range(1, num_countries + 1) for _ in years],<br/>    'year': [year for _ in range(num_countries) for year in years],<br/>    'y': np.random.normal(0, 1, num_countries * num_years),<br/>    'x1': np.random.normal(0, 1, num_countries * num_years),<br/>    'x2': np.random.normal(0, 1, num_countries * num_years)<br/>}<br/><br/>panel_data = pd.DataFrame(data)<br/><br/># display the generated panel data<br/>display(panel_data)</span></pre><figure class="op oq or os ot fo fv fw paragraph-image"><div role="button" tabindex="0" class="ou ov ed ow bh ox"><div class="fv fw pz"><img src="../Images/ae47ac32ee235a6dc360a5ba0a5095db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tzJOk9ccrrSS68D1ta3FQg.png"/></div></div><figcaption class="fs ft fu fv fw fx fy bf b bg z dx">The generated panel data. There are 3 countries observed from 2001–2004.</figcaption></figure><p id="9af2" class="pw-post-body-paragraph ms mt gc mu b ha mv mw mx hd my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn fj bk">After generating our panel data set, we can now apply PanelSplit.</p><h2 id="275d" class="no np gc bf nq nr ns nt nu nv nw nx ny nb nz oa ob nf oc od oe nj of og oh oi bk">Initializing PanelSplit</h2><p id="3191" class="pw-post-body-paragraph ms mt gc mu b ha oj mw mx hd ok mz na nb ol nd ne nf om nh ni nj on nl nm nn fj bk">When we initialize PanelSplit, we define the cross validation approach that we are going to use.</p><ul class=""><li id="a933" class="ms mt gc mu b ha mv mw mx hd my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn qa qb qc bk">The <strong class="mu gd">periods</strong> argument takes the time series. In this case the series is the year column.</li><li id="0229" class="ms mt gc mu b ha qd mw mx hd qe mz na nb qf nd ne nf qg nh ni nj qh nl nm nn qa qb qc bk"><strong class="mu gd">n_splits</strong>, <strong class="mu gd">gap</strong>, and <strong class="mu gd">test_size</strong> are all arguments used by <a class="af fz" href="https://scikit-learn.org/stable/modules/generated/sklearn.model_selection.TimeSeriesSplit.html" rel="noopener ugc nofollow" target="_blank">TimeSeriesSplit</a> to split up the time series.</li><li id="6ea5" class="ms mt gc mu b ha qd mw mx hd qe mz na nb qf nd ne nf qg nh ni nj qh nl nm nn qa qb qc bk">By specifying <strong class="mu gd">plot=True</strong>, a visualization is produced describing the train and test sets within each split.</li></ul><pre class="op oq or os ot pq pr ps bp pt bb bk"><span id="2521" class="pu np gc pr b bg pv pw l px py">!pip install panelsplit<br/>from panelsplit import PanelSplit<br/><br/>panel_split = PanelSplit(periods = panel_data.year, n_splits = 3, gap = 0, test_size=1, plot=True)</span></pre><figure class="op oq or os ot fo fv fw paragraph-image"><div role="button" tabindex="0" class="ou ov ed ow bh ox"><div class="fv fw qi"><img src="../Images/46ac5e7af26beffef69e4b1ba42715cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HG-nt9eyt4klWHoE8xNKng.png"/></div></div><figcaption class="fs ft fu fv fw fx fy bf b bg z dx">The output of initializing PanelSplit when plot = True. Based on the arguments we provided, there are 3 splits, there is no gap between train and test sets, and the test size is one period for each split.</figcaption></figure><h2 id="ff35" class="no np gc bf nq nr ns nt nu nv nw nx ny nb nz oa ob nf oc od oe nj of og oh oi bk">Understanding how PanelSplit works</h2><p id="cfad" class="pw-post-body-paragraph ms mt gc mu b ha oj mw mx hd ok mz na nb ol nd ne nf om nh ni nj on nl nm nn fj bk">To get a better idea of what the splits look like, let’s use the <strong class="mu gd">split()</strong> function to return the different train and test sets for each split.</p><pre class="op oq or os ot pq pr ps bp pt bb bk"><span id="a0ce" class="pu np gc pr b bg pv pw l px py">splits = panel_split.split()</span></pre><p id="1ec5" class="pw-post-body-paragraph ms mt gc mu b ha mv mw mx hd my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn fj bk">The splits object contains the 3 splits of the cross validation procedure. Within each split, there is a list, which consists of the train indices (the first item) and test indices (the second item). The indices are True and False values, indicating whether or not a row is in a particular train/test set for a particular split. These indices can be used to filter for different subsets of the data, as shown in the figure below.</p><figure class="op oq or os ot fo fv fw paragraph-image"><div role="button" tabindex="0" class="ou ov ed ow bh ox"><div class="fv fw qj"><img src="../Images/dcb54e616816b5223fcf3737cbc5acbc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PuPZwc-D_FnzaGhaDrYMQg.png"/></div></div><figcaption class="fs ft fu fv fw fx fy bf b bg z dx">Demonstration of the different train and test sets within each split.</figcaption></figure><h2 id="a72d" class="no np gc bf nq nr ns nt nu nv nw nx ny nb nz oa ob nf oc od oe nj of og oh oi bk">Hyper-parameter tuning</h2><p id="0928" class="pw-post-body-paragraph ms mt gc mu b ha oj mw mx hd ok mz na nb ol nd ne nf om nh ni nj on nl nm nn fj bk">Now that we’ve created an instance of PanelSplit, let’s do some <strong class="mu gd">hyper-parameter tuning</strong>!</p><p id="981c" class="pw-post-body-paragraph ms mt gc mu b ha mv mw mx hd my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn fj bk">Here we do a basic hyper-parameter search with a Ridge model, specifying the cv argument for <strong class="mu gd">GridSearchCV</strong> to be panel_split. During GridSearchCV’s fit procedure it calls panel_split’s split() function, returing the indices for each train and test for each split. It uses these indices to filter the data that are provided as the X and y arguments in the fit() function.</p><pre class="op oq or os ot pq pr ps bp pt bb bk"><span id="8e48" class="pu np gc pr b bg pv pw l px py">from sklearn.linear_model import Ridge<br/>from sklearn.model_selection import GridSearchCV<br/><br/>param_grid = {'alpha':[.1, .5]} # define the hyper-parameter grid space<br/><br/># define the gridsearch and call fit, specifying panel_split for the cv argument<br/>gridsearch = GridSearchCV(estimator = Ridge(), param_grid=param_grid, cv=panel_split)<br/>gridsearch.fit(X = panel_data[['x1','x2']], y = panel_data['y'])<br/><br/>print(gridsearch.best_params_)</span></pre><figure class="op oq or os ot fo fv fw paragraph-image"><div role="button" tabindex="0" class="ou ov ed ow bh ox"><div class="fv fw qk"><img src="../Images/a442388e0853686faa7ca8edac110bd3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ooNHY1U7jXM4tfyQMNHxeA.png"/></div></div><figcaption class="fs ft fu fv fw fx fy bf b bg z dx">In this search, the optimal alpha for the Ridge model is .5.</figcaption></figure><p id="a76e" class="pw-post-body-paragraph ms mt gc mu b ha mv mw mx hd my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn fj bk">Hooray! We’ve found the optimal set of hyper-parameters. Now we can use these to predict.</p><p id="2ccf" class="pw-post-body-paragraph ms mt gc mu b ha mv mw mx hd my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn fj bk"><em class="ql">Note: In a real setting we’d differentiate between the test set used for hyper-parameter tuning and the test set used for evaluating performance, but for this example let’s keep the validation set and the test set the same.</em></p><h2 id="4022" class="no np gc bf nq nr ns nt nu nv nw nx ny nb nz oa ob nf oc od oe nj of og oh oi bk">Generating predictions with cross_val_fit_predict</h2><p id="e701" class="pw-post-body-paragraph ms mt gc mu b ha oj mw mx hd ok mz na nb ol nd ne nf om nh ni nj on nl nm nn fj bk">Generating predictions is really easy with PanelSplit.</p><p id="8631" class="pw-post-body-paragraph ms mt gc mu b ha mv mw mx hd my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn fj bk">Using <strong class="mu gd">cross_val_fit_predict</strong>, we specify that we want to use our best Ridge model, our X and y, and PanelSplit will fit on each training set and predict on each test set, for each split.</p><pre class="op oq or os ot pq pr ps bp pt bb bk"><span id="ead8" class="pu np gc pr b bg pv pw l px py">predictions, models = panel_split.cross_val_fit_predict(estimator = Ridge(gridsearch.best_params_), <br/>                                                   X = panel_data[['x1','x2']], <br/>                                                   y = panel_data['y'])</span></pre><p id="4fdd" class="pw-post-body-paragraph ms mt gc mu b ha mv mw mx hd my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn fj bk">The predictions as well as the fitted models are returned. If we want to include the identifiers for the predictions, we can generate labels using <strong class="mu gd">gen_test_labels</strong> and then create a new Pandas Series in our predictions_df DataFrame.</p><pre class="op oq or os ot pq pr ps bp pt bb bk"><span id="e75d" class="pu np gc pr b bg pv pw l px py">predictions_df = panel_split.gen_test_labels(panel_data[['country_id','year']])<br/>predictions_df['y_pred'] = y_pred<br/>display(predictions_df)</span></pre><figure class="op oq or os ot fo fv fw paragraph-image"><div role="button" tabindex="0" class="ou ov ed ow bh ox"><div class="fv fw qi"><img src="../Images/966f0a4c82ab4dfa922575405633e5cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*As7nKaOaIUCKEEv2D0U57Q.png"/></div></div><figcaption class="fs ft fu fv fw fx fy bf b bg z dx">The DataFrame of predictions.</figcaption></figure><h1 id="6692" class="oy np gc bf nq oz pa hc nu pb pc hf ny pd pe pf pg ph pi pj pk pl pm pn po pp bk">What else can PanelSplit do?</h1><p id="5371" class="pw-post-body-paragraph ms mt gc mu b ha oj mw mx hd ok mz na nb ol nd ne nf om nh ni nj on nl nm nn fj bk">This is just a basic demo, but PanelSplit can do so much more! For example:</p><ul class=""><li id="0c55" class="ms mt gc mu b ha mv mw mx hd my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn qa qb qc bk">With <strong class="mu gd">cross_val_fit_transform</strong> we can fit on training sets and transform on test sets. If we have missing features that need imputation this is really helpful.</li><li id="2793" class="ms mt gc mu b ha qd mw mx hd qe mz na nb qf nd ne nf qg nh ni nj qh nl nm nn qa qb qc bk">What if we want to scale the data and each split needs its own ‘snapshot’ of the data in order to keep the scaling transformations separate? We can use <strong class="mu gd">gen_snapshots</strong> to do this! Or use a scikit-learn pipeline as the estimator in cross_val_fit_predict :)</li><li id="4c48" class="ms mt gc mu b ha qd mw mx hd qe mz na nb qf nd ne nf qg nh ni nj qh nl nm nn qa qb qc bk">What if we are missing a time period? By using the <strong class="mu gd">unique periods </strong>argument<strong class="mu gd"> </strong>with the <strong class="mu gd">drop_splits </strong>argument upon initialization, PanelSplit can handle this and drops splits where there aren’t any observations.</li></ul><p id="0098" class="pw-post-body-paragraph ms mt gc mu b ha mv mw mx hd my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn fj bk">If you’re looking to see some more examples and want to try PanelSplit out for yourself, check out the <a class="af fz" href="https://github.com/4Freye/panelsplit/blob/main/examples/An%20introduction%20to%20PanelSplit.ipynb" rel="noopener ugc nofollow" target="_blank">Jupyter notebook</a> I created where I cover some additional capabilities.</p><p id="a245" class="pw-post-body-paragraph ms mt gc mu b ha mv mw mx hd my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn fj bk">This is the first package I have written, so I learned a lot working on this project. Thank you for reading, and I hope PanelSplit helps you in your next panel data project!</p><p id="81e1" class="pw-post-body-paragraph ms mt gc mu b ha mv mw mx hd my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn fj bk"><em class="ql">Note: Unless otherwise noted, all images are by the author.</em></p></div></div></div></div>    
</body>
</html>