<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Understand SQL Window Functions Once and For All</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Understand SQL Window Functions Once and For All</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/understand-sql-window-functions-once-and-for-all-4447824c1cb4?source=collection_archive---------1-----------------------#2024-05-01">https://towardsdatascience.com/understand-sql-window-functions-once-and-for-all-4447824c1cb4?source=collection_archive---------1-----------------------#2024-05-01</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="dbc6" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx">A step-by-step guide to understanding window functions</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hd he hf hg hh ab"><div><div class="ab hi"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@mtrentz?source=post_page---byline--4447824c1cb4--------------------------------" rel="noopener follow"><div class="l hj hk by hl hm"><div class="l ed"><img alt="Mateus Trentz" class="l ep by dd de cx" src="../Images/8c50ef2bc9726b11094d6fa630015554.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/1*j-QGGuGro7JhNQbWCRGu4Q.jpeg"/><div class="hn by l dd de em n ho eo"/></div></div></a></div></div><div class="hp ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--4447824c1cb4--------------------------------" rel="noopener follow"><div class="l hq hr by hl hs"><div class="l ed"><img alt="Towards Data Science" class="l ep by br ht cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hn by l br ht em n ho eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hu ab q"><div class="ab q hv"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hw hx bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hy" data-testid="authorName" href="https://medium.com/@mtrentz?source=post_page---byline--4447824c1cb4--------------------------------" rel="noopener follow">Mateus Trentz</a></p></div></div></div><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hw hx dx"><button class="ib ic ah ai aj ak al am an ao ap aq ar id ie if" disabled="">Follow</button></p></div></div></span></div></div><div class="l ig"><span class="bf b bg z dx"><div class="ab cn ih ii ij"><div class="ik il ab"><div class="bf b bg z dx ab im"><span class="in l ig">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hy ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--4447824c1cb4--------------------------------" rel="noopener follow"><p class="bf b bg z io ip iq ir is it iu iv bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">9 min read</span><div class="iw ix l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">May 1, 2024</span></div></span></div></span></div></div></div><div class="ab cp iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn"><div class="h k w ea eb q"><div class="kd l"><div class="ab q ke kf"><div class="pw-multi-vote-icon ed in kg kh ki"><div class=""><div class="kj kk kl km kn ko kp am kq kr ks ki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kt ku kv kw kx ky kz"><p class="bf b dy z dx"><span class="kk">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kj lc ld ab q ee le lf" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="lb"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg><p class="bf b dy z dx"><span class="pw-responses-count la lb">11</span></p></button></div></div></div><div class="ab q jo jp jq jr js jt ju jv jw jx jy jz ka kb kc"><div class="lg k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lh an ao ap id li lj lk" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep ll cn"><div class="l ae"><div class="ab cb"><div class="lm ln lo lp lq lr ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk ml"><img src="../Images/4d7e65d387759934b9acf4a61ec24a33.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*s1aZg0Yabsw2A2iJ"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Photo by <a class="af nc" href="https://unsplash.com/@yasmina?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Yasmina H</a> on <a class="af nc" href="https://unsplash.com/?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="2bf7" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Window functions are key to writing SQL code that is both efficient and easy to understand. Knowing how they work and when to use them will unlock new ways of solving your reporting problems.</p><p id="e920" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">The objective of this article is to explain window functions in SQL step by step in an understandable way so that you don’t need to rely on only memorizing the syntax.</p><p id="1261" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Here is what we will cover:</p><ul class=""><li id="23b9" class="nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob bk">An explanation on how you should view window functions</li><li id="9725" class="nd ne fq nf b go oc nh ni gr od nk nl nm oe no np nq of ns nt nu og nw nx ny nz oa ob bk">Go over many examples in increasing difficulty</li><li id="3922" class="nd ne fq nf b go oc nh ni gr od nk nl nm oe no np nq of ns nt nu og nw nx ny nz oa ob bk">Look at one specific real-case scenario to put our learnings into practice</li><li id="0c92" class="nd ne fq nf b go oc nh ni gr od nk nl nm oe no np nq of ns nt nu og nw nx ny nz oa ob bk">Review what we’ve learned</li></ul><p id="5190" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Our dataset is simple, <strong class="nf fr">six rows of revenue data for two regions in the year 2023.</strong></p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk oh"><img src="../Images/0877edc3106b19906797d85e6cf07f76.png" data-original-src="https://miro.medium.com/v2/resize:fit:604/format:webp/1*JylksLvcGYwdsi55AVvNiA.png"/></div></figure><h1 id="01b6" class="oi oj fq bf ok ol om gq on oo op gt oq or os ot ou ov ow ox oy oz pa pb pc pd bk">Window Functions Are Sub Groups</h1><p id="dc9e" class="pw-post-body-paragraph nd ne fq nf b go pe nh ni gr pf nk nl nm pg no np nq ph ns nt nu pi nw nx ny fj bk">If we took this dataset and ran a <code class="cx pj pk pl pm b">GROUP BY</code> sum on the revenue of each region, it would be clear what happens, right? It would result in only two remaining rows, one for each region, and then the sum of the revenues:</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk pn"><img src="../Images/1dea1a92f4f1781cd737b55d004a47a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:312/format:webp/1*SrQFQaqB-p3UVCOXdOI57w.png"/></div></figure><p id="ab12" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">The way I want you to view window functions is very similar to this but, <strong class="nf fr">instead of reducing the number of rows, the aggregation will run “in the background” and the values will be added to our existing rows.</strong></p><p id="4d54" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">First, an example:</p><pre class="mm mn mo mp mq po pm pp bp pq bb bk"><span id="bec3" class="pr oj fq pm b bg ps pt l pu pv">SELECT<br/> id,<br/>    date,<br/>    region,<br/>    revenue,<br/>    SUM(revenue) OVER () as total_revenue<br/>FROM<br/>    sales</span></pre><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk pw"><img src="../Images/b3b315c4d15c66605f50167b857ebd3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:834/format:webp/1*oFN6FKx5Wo2AKn2E5_qDYA.png"/></div></figure><p id="7bd8" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Notice that we don’t have any <code class="cx pj pk pl pm b">GROUP BY</code> and our dataset is left intact. And yet we were able to get the sum of all revenues. Before we go more in depth in how this worked let’s just quickly talk about the full syntax before we start building up our knowledge.</p><h1 id="86af" class="oi oj fq bf ok ol om gq on oo op gt oq or os ot ou ov ow ox oy oz pa pb pc pd bk">The Window Function Syntax</h1><p id="a1a7" class="pw-post-body-paragraph nd ne fq nf b go pe nh ni gr pf nk nl nm pg no np nq ph ns nt nu pi nw nx ny fj bk">The syntax goes like this:</p><pre class="mm mn mo mp mq po pm pp bp pq bb bk"><span id="74fd" class="pr oj fq pm b bg ps pt l pu pv">SUM([some_column]) OVER (PARTITION BY [some_columns] ORDER BY [some_columns])</span></pre><p id="93f6" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Picking apart each section, this is what we have:</p><ul class=""><li id="a8bf" class="nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob bk">An aggregation or window function: <code class="cx pj pk pl pm b">SUM</code>, <code class="cx pj pk pl pm b">AVG</code>, <code class="cx pj pk pl pm b">MAX</code>, <code class="cx pj pk pl pm b">RANK</code>, <code class="cx pj pk pl pm b">FIRST_VALUE</code></li><li id="77a5" class="nd ne fq nf b go oc nh ni gr od nk nl nm oe no np nq of ns nt nu og nw nx ny nz oa ob bk">The <code class="cx pj pk pl pm b">OVER</code> keyword which says this is a window function</li><li id="1886" class="nd ne fq nf b go oc nh ni gr od nk nl nm oe no np nq of ns nt nu og nw nx ny nz oa ob bk">The <code class="cx pj pk pl pm b">PARTITION BY</code> section, which defines the <strong class="nf fr">groups</strong></li><li id="492e" class="nd ne fq nf b go oc nh ni gr od nk nl nm oe no np nq of ns nt nu og nw nx ny nz oa ob bk">The <code class="cx pj pk pl pm b">ORDER BY</code> section which defines if it’s a running function (we will cover this later on)</li></ul><p id="d3ac" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Don’t stress over what each of these means yet, as it will become clear when we go over the examples. <strong class="nf fr">For now just know that to define a window function we will use the </strong><code class="cx pj pk pl pm b"><strong class="nf fr">OVER</strong></code><strong class="nf fr"> keyword. And as we saw in the first example, that’s the only requirement.</strong></p><h1 id="6ddc" class="oi oj fq bf ok ol om gq on oo op gt oq or os ot ou ov ow ox oy oz pa pb pc pd bk">Building Our Understanding Step By Step</h1><p id="9599" class="pw-post-body-paragraph nd ne fq nf b go pe nh ni gr pf nk nl nm pg no np nq ph ns nt nu pi nw nx ny fj bk">Moving to something actually useful, we will now apply a group in our function. The initial calculation will be kept to show you that <strong class="nf fr">we can run more than one window function at once</strong>, which means we can do different aggregations at once in the same query, without requiring sub-queries.</p><pre class="mm mn mo mp mq po pm pp bp pq bb bk"><span id="8903" class="pr oj fq pm b bg ps pt l pu pv">SELECT<br/>    id,<br/>    date,<br/>    region,<br/>    revenue,<br/>    SUM(revenue) OVER (PARTITION BY region) as region_total,<br/>    SUM(revenue) OVER () as total_revenue<br/>FROM sales</span></pre><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk px"><img src="../Images/da5c8b809276353b2e95145598e95273.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9Vo1q9uVOnoL6iQ2GQWCsg.png"/></div></div></figure><p id="0722" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">As said, <strong class="nf fr">we use the </strong><code class="cx pj pk pl pm b"><strong class="nf fr">PARTITION BY</strong></code><strong class="nf fr"> to define our groups (windows) that are used by our aggregation function!</strong> So, keeping our dataset intact we’ve got:</p><ul class=""><li id="2d48" class="nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob bk">The total revenue for each region</li><li id="8435" class="nd ne fq nf b go oc nh ni gr od nk nl nm oe no np nq of ns nt nu og nw nx ny nz oa ob bk">The total revenue for the whole dataset</li></ul><p id="21a5" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">We’re also not restrained to a single group. Similar to <code class="cx pj pk pl pm b">GROUP BY</code> we can partition our data on Region and Quarter, for example:</p><pre class="mm mn mo mp mq po pm pp bp pq bb bk"><span id="1941" class="pr oj fq pm b bg ps pt l pu pv">SELECT<br/>    id,<br/>    date,<br/>    region,<br/>    revenue,<br/>    SUM(revenue) OVER (PARTITION BY <br/>          region, <br/>          date_trunc('quarter', date)<br/>    ) AS region_quarterly_revenue<br/>FROM sales</span></pre><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk py"><img src="../Images/8c855d938e778d5a711584e25f15e7f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XXwSP2nPZG1hNl_3LC-F7A.png"/></div></figure><p id="8c69" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk"><strong class="nf fr">In the image we see that the only two data points for the same region and quarter got grouped together!</strong></p><p id="c03b" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">At this point I hope it’s clear how we can view this as doing a <code class="cx pj pk pl pm b">GROUP BY</code> but in-place, without reducing the number of rows in our dataset. Of course, we don’t always want that, but it’s not that uncommon to see queries where someone groups data and then joins it back in the original dataset, complicating what could be a single window function.</p><p id="fc82" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Moving on to the <code class="cx pj pk pl pm b">ORDER BY</code> keyword. This one defines a running window function. You’ve probably heard of a Running Sum once in your life, but if not, we should start with an example to make everything clear.</p><pre class="mm mn mo mp mq po pm pp bp pq bb bk"><span id="360b" class="pr oj fq pm b bg ps pt l pu pv">SELECT<br/>    id,<br/>    date,<br/>    region,<br/>    revenue,<br/>    SUM(revenue) OVER (ORDER BY id) as running_total<br/>FROM sales</span></pre><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk pz"><img src="../Images/d1441cd881f2d0e95c2b54bb00aea05f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1202/format:webp/1*Eedl6T8UFzzV3tf_PWCaZg.png"/></div></figure><p id="514c" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">What happens here is that we’ve went, row by row, summing the revenue with all previous values. This was done following the order of the <code class="cx pj pk pl pm b">id</code> column, but it could’ve been any other column.</p><p id="11e7" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">This specific example is not particularly useful because we’re summing across random months and two regions, but using what we’ve learned we can now find <strong class="nf fr">the cumulative revenue per region. </strong>We do that by applying the running sum within each group.</p><pre class="mm mn mo mp mq po pm pp bp pq bb bk"><span id="4762" class="pr oj fq pm b bg ps pt l pu pv">SELECT<br/>    id,<br/>    date,<br/>    region,<br/>    revenue,<br/>    SUM(revenue) OVER (PARTITION BY region ORDER BY date) as running_total<br/>FROM sales</span></pre><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk qa"><img src="../Images/444b91883903ba7ecabf49479a7c948c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1194/format:webp/1*jgZguXMAosMYc1jIqzflXA.png"/></div></figure><p id="bfc4" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Take the time to make sure you understand what happened here:</p><ul class=""><li id="5928" class="nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob bk">For each region we’re walking up month by month and summing the revenue</li><li id="c362" class="nd ne fq nf b go oc nh ni gr od nk nl nm oe no np nq of ns nt nu og nw nx ny nz oa ob bk">Once it’s done for that region we move to the next one, starting from scratch and again moving up the months!</li></ul><p id="5722" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">It’s quite interesting to notice here that when we’re writing these running functions we have the “context” of other rows. What I mean is that to get the running sum at one point, we must know the previous values for the previous rows. This becomes more obvious when we learn that we can manually chose how many rows before/after we want to aggregate on.</p><pre class="mm mn mo mp mq po pm pp bp pq bb bk"><span id="37b4" class="pr oj fq pm b bg ps pt l pu pv">SELECT<br/>    id,<br/>    date,<br/>    region,<br/>    revenue,<br/>    SUM(revenue) OVER (ORDER BY id ROWS BETWEEN 1 PRECEDING AND 2 FOLLOWING) <br/>    AS useless_sum<br/>FROM<br/>    sales</span></pre><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk qb"><img src="../Images/5b08b522955119bafaa3e6ece4fcdd07.png" data-original-src="https://miro.medium.com/v2/resize:fit:1198/format:webp/1*rliIUO6l6PY6roU4_sWyYg.png"/></div></figure><p id="8e47" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">For this query we specified that for each row we wanted to look at one row behind and two rows ahead, so that means we get the sum of that range! Depending on the problem you’re solving this can be extremely powerful as it gives you complete control on how you’re grouping your data.</p><p id="9755" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Finally, one last function I want to mention before we move into a harder example is the <code class="cx pj pk pl pm b">RANK</code> function. This gets asked a lot in interviews and the logic behind it is the same as everything we’ve learned so far.</p><pre class="mm mn mo mp mq po pm pp bp pq bb bk"><span id="80d0" class="pr oj fq pm b bg ps pt l pu pv">SELECT<br/>    *,<br/>    RANK() OVER (PARTITION BY region ORDER BY revenue DESC) as rank,<br/>    RANK() OVER (ORDER BY revenue DESC) as overall_rank<br/>FROM<br/>    sales<br/>ORDER BY region, revenue DESC</span></pre><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk qc"><img src="../Images/1a0f2adb51728b3f8640fb02ed75ac6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1326/format:webp/1*7QHqISwZqBiD85kSv5WhFg.png"/></div></figure><p id="b5ba" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Just as before, we used <code class="cx pj pk pl pm b">ORDER BY</code> to specify the order which we will walk, row by row, and <code class="cx pj pk pl pm b">PARTITION BY</code> to specify our sub-groups.</p><p id="30f9" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">The first column ranks each row within each region, meaning that we will have multiple “rank one’s” in the dataset. The second calculation is the rank across all rows in the dataset.</p><h1 id="982b" class="oi oj fq bf ok ol om gq on oo op gt oq or os ot ou ov ow ox oy oz pa pb pc pd bk">Forward Filling Missing Data</h1><p id="35e1" class="pw-post-body-paragraph nd ne fq nf b go pe nh ni gr pf nk nl nm pg no np nq ph ns nt nu pi nw nx ny fj bk">This is a problem that shows up every now and then and to solve it on SQL it takes heavy usage of window functions. To explain this concept we will use a different dataset containing timestamps and temperature measurements. <strong class="nf fr">Our goal is to fill in the rows missing temperature measurements with the last measured value.</strong></p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk qd"><img src="../Images/264bdecb551419927c9cebfe06e1eef4.png" data-original-src="https://miro.medium.com/v2/resize:fit:592/format:webp/1*7JDsADPd2Sm0hFfkcHoXXQ.png"/></div></figure><p id="b48a" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Here is what we expect to have at the end:</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk qe"><img src="../Images/c1999c3e305edc1c1fbdfadf83226c99.png" data-original-src="https://miro.medium.com/v2/resize:fit:572/format:webp/1*HW0tSk6ZpSSFcHLE06C2yA.png"/></div></figure><p id="5bf4" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Before we start I just want to mention that if you’re using Pandas you can solve this problem simply by running <code class="cx pj pk pl pm b">df.ffill()</code> but if you’re on SQL the problem gets a bit more tricky.</p><p id="d954" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">The first step to solve this is to, somehow, group the NULLs with the previous non-null value. It might not be clear how we do this but I hope it’s clear that this will require a <strong class="nf fr">running function</strong>. Meaning that it’s a function that will “walk row by row”, knowing when we hit a null value and when we hit a non-null value.</p><p id="fd46" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">The solution is to use <code class="cx pj pk pl pm b">COUNT</code> and, more specifically, count the values of temperature measurements. In the following query I run both a normal running count and also a count over the temperature values.</p><pre class="mm mn mo mp mq po pm pp bp pq bb bk"><span id="5843" class="pr oj fq pm b bg ps pt l pu pv">SELECT<br/>    *,<br/>    COUNT() OVER (ORDER BY timestamp) as normal_count,<br/>    COUNT(temperature) OVER (ORDER BY timestamp) as group_count<br/>from sensor</span></pre><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk qf"><img src="../Images/93ed3b3f16f72d91b45c04007f370907.png" data-original-src="https://miro.medium.com/v2/resize:fit:1142/format:webp/1*ysp9C9o8Nv8DHeZq6EQGtw.png"/></div></figure><ul class=""><li id="9406" class="nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob bk">In the first calculation we simply counted up each row increasingly</li><li id="3b87" class="nd ne fq nf b go oc nh ni gr od nk nl nm oe no np nq of ns nt nu og nw nx ny nz oa ob bk">On the second one we counted every value of temperature we saw, not counting when it was NULL</li></ul><p id="c8b1" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">The <code class="cx pj pk pl pm b">normal_count</code> column is useless for us, I just wanted to show what a running <code class="cx pj pk pl pm b">COUNT</code> looked like. <strong class="nf fr">Our second calculation though, the </strong><code class="cx pj pk pl pm b"><strong class="nf fr">group_count</strong></code><strong class="nf fr"> moves us closer to solving our problem!</strong></p><p id="4fee" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Notice that this way of counting makes sure that the first value, just before the NULLs start, is counted and then, every time the function sees a null, nothing happens. This makes sure that we’re “tagging” every subsequent null with the same count we had when we stopped having measurements.</p><p id="3116" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Moving on, we now need to copy over the first value that got tagged into all the other rows within that same group. Meaning that for the group <code class="cx pj pk pl pm b">2</code> needs to all be filled with the value <code class="cx pj pk pl pm b">15.0</code>.</p><p id="eaa5" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Can you think of a function now that we can use here? There is more than one answer for this, but, again, I hope that at least it’s clear that now we’re looking at a simple window aggregation with <code class="cx pj pk pl pm b">PARTITION BY</code> .</p><pre class="mm mn mo mp mq po pm pp bp pq bb bk"><span id="e71b" class="pr oj fq pm b bg ps pt l pu pv">SELECT<br/>    *,<br/>    FIRST_VALUE(temperature) OVER (PARTITION BY group_count) as filled_v1,<br/>    MAX(temperature) OVER (PARTITION BY group_count) as filled_v2<br/>FROM (<br/>    SELECT<br/>        *,<br/>        COUNT(temperature) OVER (ORDER BY timestamp) as group_count<br/>    from sensor<br/>) as grouped<br/>ORDER BY timestamp ASC</span></pre><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk qg"><img src="../Images/188d89d977ccdb549772bfd3700cd8f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1310/format:webp/1*lwPv1OSwfYHxzuy102sdjw.png"/></div></figure><p id="429c" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">We can use both <code class="cx pj pk pl pm b">FIRST_VALUE</code> or <code class="cx pj pk pl pm b">MAX</code> to achieve what we want. The only goal is that we get the first non-null value. Since we know that each group contains one non-null value and a bunch of null values, both of these functions work!</p><p id="e32c" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">This example is a great way to practice window functions. If you want a similar challenge try to add two sensors and then forward fill the values with the previous reading of that sensor. Something similar to this:</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk qh"><img src="../Images/abff0d3e5b1c57b048d6bb0e6fed0e84.png" data-original-src="https://miro.medium.com/v2/resize:fit:920/format:webp/1*BhkruXVwGnKDqGhVJWKchw.png"/></div></figure><p id="2364" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Could you do it? It doesn’t use anything that we haven’t learned here so far.</p><p id="9176" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">By now we know everything that we need about how window functions work in SQL, so let’s just do a quick recap!</p><h1 id="18b7" class="oi oj fq bf ok ol om gq on oo op gt oq or os ot ou ov ow ox oy oz pa pb pc pd bk">Recap Time</h1><p id="4ab4" class="pw-post-body-paragraph nd ne fq nf b go pe nh ni gr pf nk nl nm pg no np nq ph ns nt nu pi nw nx ny fj bk">This is what we’ve learned:</p><ul class=""><li id="b7d0" class="nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob bk">We use the <code class="cx pj pk pl pm b">OVER</code> keyword to write window functions</li><li id="9670" class="nd ne fq nf b go oc nh ni gr od nk nl nm oe no np nq of ns nt nu og nw nx ny nz oa ob bk">We use <code class="cx pj pk pl pm b">PARTITION BY</code> to specify our sub-groups (windows)</li><li id="e561" class="nd ne fq nf b go oc nh ni gr od nk nl nm oe no np nq of ns nt nu og nw nx ny nz oa ob bk">If we provide only the <code class="cx pj pk pl pm b">OVER()</code> keyword our window is the whole dataset</li><li id="72c6" class="nd ne fq nf b go oc nh ni gr od nk nl nm oe no np nq of ns nt nu og nw nx ny nz oa ob bk">We use <code class="cx pj pk pl pm b">ORDER BY</code> when we want to have a running function, meaning that our calculation walks row by row</li><li id="f766" class="nd ne fq nf b go oc nh ni gr od nk nl nm oe no np nq of ns nt nu og nw nx ny nz oa ob bk">Window functions are useful when we want to group data to run an aggregation but we want to keep our dataset as is</li></ul></div></div></div><div class="ab cb qi qj qk ql" role="separator"><span class="qm by bm qn qo qp"/><span class="qm by bm qn qo qp"/><span class="qm by bm qn qo"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="77ee" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">I hope this helped you understand how window functions work and helps you apply it in the problems you need to solve.</p><p id="66a1" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk"><em class="qq">All images by the author unless stated otherwise</em></p></div></div></div></div>    
</body>
</html>