<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Real world Use Cases: Forecasting Service Utilization Using Tabnet and Optuna</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Real world Use Cases: Forecasting Service Utilization Using Tabnet and Optuna</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/real-world-use-cases-forecasting-service-utilization-using-tabnet-and-optuna-26308db615c3?source=collection_archive---------8-----------------------#2024-08-15">https://towardsdatascience.com/real-world-use-cases-forecasting-service-utilization-using-tabnet-and-optuna-26308db615c3?source=collection_archive---------8-----------------------#2024-08-15</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><figure class="fr fs ft fu fv fw fo fp paragraph-image"><div role="button" tabindex="0" class="fx fy ed fz bh ga"><div class="fo fp fq"><img src="../Images/316bd735324a679d8146caf7b72e8144.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O9CYGXvHOXdQPq2dYoRshg.png"/></div></div><figcaption class="gd ge gf fo fp gg gh bf b bg z dx">Image generated by Dall-e</figcaption></figure><div/><div><h2 id="779c" class="pw-subtitle-paragraph hh gj gk bf b hi hj hk hl hm hn ho hp hq hr hs ht hu hv hw cq dx">Data science is at its best out in the real world. I intend to share insights from various productionized projects I have been involved in.</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hx hy hz ia ib ab"><div><div class="ab ic"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@hampusg?source=post_page---byline--26308db615c3--------------------------------" rel="noopener follow"><div class="l id ie by if ig"><div class="l ed"><img alt="Hampus Gustavsson" class="l ep by dd de cx" src="../Images/a22f27fc40e4a612058379928d30f609.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/1*njAKh1Uz806vNtHR183GBA.jpeg"/><div class="ih by l dd de em n ii eo"/></div></div></a></div></div><div class="ij ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--26308db615c3--------------------------------" rel="noopener follow"><div class="l ik il by if im"><div class="l ed"><img alt="Towards Data Science" class="l ep by br in cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="ih by l br in em n ii eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="io ab q"><div class="ab q ip"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b iq ir bk"><a class="af ag ah ai aj ak al am an ao ap aq ar is" data-testid="authorName" href="https://medium.com/@hampusg?source=post_page---byline--26308db615c3--------------------------------" rel="noopener follow">Hampus Gustavsson</a></p></div></div></div><span class="it iu" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b iq ir dx"><button class="iv iw ah ai aj ak al am an ao ap aq ar ix iy iz" disabled="">Follow</button></p></div></div></span></div></div><div class="l ja"><span class="bf b bg z dx"><div class="ab cn jb jc jd"><div class="je jf ab"><div class="bf b bg z dx ab jg"><span class="jh l ja">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar is ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--26308db615c3--------------------------------" rel="noopener follow"><p class="bf b bg z ji jj jk jl jm jn jo jp bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="it iu" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">7 min read</span><div class="jq jr l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Aug 15, 2024</span></div></span></div></span></div></div></div><div class="ab cp js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh"><div class="h k w ea eb q"><div class="kx l"><div class="ab q ky kz"><div class="pw-multi-vote-icon ed jh la lb lc"><div class=""><div class="ld le lf lg lh li lj am lk ll lm lc"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l ln lo lp lq lr ls lt"><p class="bf b dy z dx"><span class="le">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao ld lu lv ab q ee lw lx" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="ly"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg></button></div></div></div><div class="ab q ki kj kk kl km kn ko kp kq kr ks kt ku kv kw"><div class="lz k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al ma an ao ap ix mb mc md" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep me cn"><div class="l ae"><div class="ab cb"><div class="mf mg mh mi mj gb ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al ma an ao ap ix mk ml lx mm mn mo mp mq s mr ms mt mu mv mw mx u my mz na"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al ma an ao ap ix mk ml lx mm mn mo mp mq s mr ms mt mu mv mw mx u my mz na"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al ma an ao ap ix mk ml lx mm mn mo mp mq s mr ms mt mu mv mw mx u my mz na"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><p id="ee8f" class="pw-post-body-paragraph nb nc gk nd b hi ne nf ng hl nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">During my years working as a Data Scientist, I have met a lot of students interested in becoming one themselves, or newly graduated just starting out. Starting a career in data science, like any field, involves a steep learning curve.</p><p id="8d46" class="pw-post-body-paragraph nb nc gk nd b hi ne nf ng hl nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">One, very good, question that I keep getting is: <em class="nx">I have learned a lot about the theoretical aspects of data science, but what does a real world example look like?</em></p><p id="23d7" class="pw-post-body-paragraph nb nc gk nd b hi ne nf ng hl nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">I want to share small pieces of work, from different projects I have been working on throughout my career. Even though some might be a few years old, I will only write about subjects which I still find relevant. I will try to keep the overarching picture clear and concise, so that new aspiring colleagues will get a grasp of what might be coming up. But I also want to stop and look into details, which I hope that more experienced developers might get some insights out of.</p><p id="6fff" class="pw-post-body-paragraph nb nc gk nd b hi ne nf ng hl nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk"><strong class="nd gl">Business Case</strong></p><p id="babe" class="pw-post-body-paragraph nb nc gk nd b hi ne nf ng hl nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">Let’s now delve into the specific business case that drove this initiative. The team included a project manager, client stakeholders, and myself. The client needed a way to forecast the usage of a specific service. The reason behind this was resource allocation for maintaining the service and dynamic pricing. Experience with behaviour about the service usage was mostly kept within skilled coworkers, and this application was a way to be more resilient towards them retiring together with their knowledge. Also, the onboarding process of new hirings was thought to be easier with this kind of tool at hand.</p><p id="6530" class="pw-post-body-paragraph nb nc gk nd b hi ne nf ng hl nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk"><strong class="nd gl">Data and Analytical Setup</strong></p><p id="0587" class="pw-post-body-paragraph nb nc gk nd b hi ne nf ng hl nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">The data had a lot of features, both categorical and numerical. For the use case, there was a need to forecast the usage with a dynamical horizon, i.e. a need to make predictions for different periods of time into the future. There were also many, correlated and uncorrelated, values needed to be forecasted.</p><p id="d817" class="pw-post-body-paragraph nb nc gk nd b hi ne nf ng hl nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">These multivariate time series made the attention mostly focused on experimenting with time series based models. But ultimately, Tabnet was adopted, a model that processes data as tabular.</p><p id="ee0d" class="pw-post-body-paragraph nb nc gk nd b hi ne nf ng hl nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">There are several interesting features in the Tabnet architecture. This article will not delve into model details. But for the theoretical background I recommend doing some research. If you don’t find any good resources, I find <a class="af ny" href="https://medium.com/@turkishtechnology/deep-learning-with-tabnet-b881236e28c1" rel="noopener">this article</a> a good overview or <a class="af ny" href="https://arxiv.org/abs/1908.07442" rel="noopener ugc nofollow" target="_blank">this paper</a> for a more in depth exploration.</p><p id="7727" class="pw-post-body-paragraph nb nc gk nd b hi ne nf ng hl nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">As a hyper parameter tuning framework, Optuna was used. There are also other frameworks in Python to use, but I have yet to find a reason not to use Optuna. Optuna was used as a Bayesian hyperparameter tuning, saved to disk. Other features utilized are early stopping and warm starting. Early stopping is used for resource saving purposes, not letting non promising looking trials run for too long. Warm starting is the ability to start from previous trials. This I find useful when new data arrives, and not having to start the tuning from scratch.</p><p id="e6bd" class="pw-post-body-paragraph nb nc gk nd b hi ne nf ng hl nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">The initial parameter widths, will be set as recommended in the <a class="af ny" href="https://github.com/dreamquark-ai/tabnet" rel="noopener ugc nofollow" target="_blank">Tabnet documentation</a> or from the parameter ranges discussed in the <a class="af ny" href="https://arxiv.org/abs/1908.07442" rel="noopener ugc nofollow" target="_blank">Tabnet paper</a>.</p><p id="b6fd" class="pw-post-body-paragraph nb nc gk nd b hi ne nf ng hl nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">To convey for the heteroscedastic nature of the residuals, Tabnet was implemented as a quantile regression model. To do this, or for implementing any model in this fashion, the<em class="nx"> pinball loss function</em>, with suitable upper and lower quantiles, was used. This loss function has a skewed loss function, punishing errors unequally depending if they are positive or negative.</p><p id="67c9" class="pw-post-body-paragraph nb nc gk nd b hi ne nf ng hl nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk"><strong class="nd gl">Walkthrough with Code</strong></p><p id="5f1a" class="pw-post-body-paragraph nb nc gk nd b hi ne nf ng hl nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">The requirements used for these snippets are as follows.</p><pre class="nz oa ob oc od oe of og bp oh bb bk"><span id="9900" class="oi oj gk of b bg ok ol l om on">pytorch-tabnet==4.1.0<br/>optuna==3.6.1<br/>pandas==2.1.4</span></pre><p id="d999" class="pw-post-body-paragraph nb nc gk nd b hi ne nf ng hl nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">Code for defining the model.</p><pre class="nz oa ob oc od oe of og bp oh bb bk"><span id="763c" class="oi oj gk of b bg ok ol l om on">import os<br/><br/>from pytorch_tabnet.tab_model import TabNetRegressor<br/>import pandas as pd<br/>import numpy as np<br/><br/>from utils import CostumPinballLoss<br/><br/>class mediumTabnetModel:<br/><br/><br/>   def __init__(self,<br/>                model_file_name,<br/>                dependent_variables=None,<br/>                independent_variables=None,<br/>                batch_size=16_000,<br/>                n_a=8,<br/>                n_steps=3,<br/>                n_independent=2,<br/>                n_shared=2,<br/>                cat_idxs=[],<br/>                cat_dims=[],<br/>                quantile=None):<br/>       self.model_file_name = model_file_name<br/>       self.quantile = quantile<br/>       self.clf = TabNetRegressor(n_d=n_a,<br/>                                  n_a=n_a,<br/>                                  cat_idxs=cat_idxs,<br/>                                  cat_dims=cat_dims,<br/>                                  n_steps=n_steps,<br/>                                  n_independent=n_independent,<br/>                                  n_shared=n_shared)<br/>       self.batch_size = batch_size<br/>       self.independent_variables = independent_variables<br/>       self.dependent_variables = dependent_variables<br/>       self.cat_idxs = cat_idxs  # Indexes for categorical values.<br/>       self.cat_dims = cat_dims  # Dimensions for categorical values.<br/>       self.ram_data = None<br/><br/><br/>def fit(self, training_dir, train_date_split):<br/><br/>   if self.ram_data is None:<br/>       data_path = os.path.join(training_dir, self.training_data_file)<br/>       df = pd.read_parquet(data_path)<br/><br/><br/>       df_train = df[df['dates'] &lt; train_date_split]<br/>       df_val = df[df['dates'] &gt;= train_date_split]<br/><br/><br/>       x_train = df_train[self.independent_variables].values.astype(np.int16)<br/>       y_train = df_train[self.dependent_variables].values.astype(np.int32)<br/><br/><br/>       x_valid = df_val[self.independent_variables].values.astype(np.int16)<br/>       y_valid = df_val[self.dependent_variables].values.astype(np.int32)<br/><br/><br/>       self.ram_data = {'x_train': x_train,<br/>                        'y_train': y_train,<br/>                        'x_val': x_valid,<br/>                        'y_val': y_valid}<br/><br/><br/><br/>   self.clf.fit(self.ram_data['x_train'],<br/>                self.ram_data['y_train'],<br/>                eval_set=[(self.ram_data['x_val'],<br/>                           self.ram_data['y_val'])],<br/>                batch_size=self.batch_size,<br/>                drop_last=True,<br/>                loss_fn=CostumPinballLoss(quantile=self.quantile),<br/>                eval_metric=[CostumPinballLoss(quantile=self.quantile)],<br/>                patience=3)<br/><br/><br/>   feat_score = dict(zip(self.independent_variables, self.clf.feature_importances_))<br/>   feat_score = dict(sorted(feat_score.items(), key=lambda item: item[1]))<br/>   self.feature_importances_dict = feat_score <br/>   # Dict of feature importance and importance score, ordered.</span></pre><p id="bb3e" class="pw-post-body-paragraph nb nc gk nd b hi ne nf ng hl nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">As a data manipulation framework, Pandas was used. I would also recommend using Polars, as a more efficient framework.</p><p id="b46f" class="pw-post-body-paragraph nb nc gk nd b hi ne nf ng hl nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">The Tabnet implementation comes with a pre-built local and global feature importance attribute to the fitted model. The inner workings on this can be studied in the article posted previous, but as the business use case goes this serves two purposes:</p><ul class=""><li id="1ccf" class="nb nc gk nd b hi ne nf ng hl nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw oo op oq bk">Sanity check — client can validate the model.</li><li id="05bd" class="nb nc gk nd b hi or nf ng hl os ni nj nk ot nm nn no ou nq nr ns ov nu nv nw oo op oq bk">Business insights — the model can provide new insights about the business to the client.</li></ul><p id="f001" class="pw-post-body-paragraph nb nc gk nd b hi ne nf ng hl nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">together with the subject matter experts. In the end application, the interpretability was included to be displayed to the user. Due to data anonymization, there will not be a deep dive into interpretability in this article, but rather save it for a case where the true features going into the model can be discussed and displayed.</p><p id="52e2" class="pw-post-body-paragraph nb nc gk nd b hi ne nf ng hl nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">Code for the fitting and searching steps.</p><pre class="nz oa ob oc od oe of og bp oh bb bk"><span id="abf3" class="oi oj gk of b bg ok ol l om on">import optuna<br/>import numpy as np<br/><br/><br/>def define_model(trial):<br/>   n_shared = trial.suggest_int('n_shared', 1, 7)<br/>   logging.info(f'n_shared: {n_shared}')<br/><br/><br/>   n_independent = trial.suggest_int('n_independent', 1, 16)<br/>   logging.info(f'n_independent: {n_independent}')<br/><br/><br/>   n_steps = trial.suggest_int('n_steps', 2, 8)<br/>   logging.info(f'n_steps: {n_steps}')<br/><br/><br/>   n_a = trial.suggest_int('n_a', 4, 32)<br/>   logging.info(f'n_a: {n_a}')<br/><br/><br/>   batch_size = trial.suggest_int('batch_size', 256, 18000)<br/>   logging.info(f'batch_size: {batch_size}')<br/><br/><br/><br/>   clf = mediumTabnetModel(model_file_name=model_file_name,<br/>                           dependent_variables=y_ls,<br/>                           independent_variables=x_ls,<br/>                           n_a=n_a,<br/>                           cat_idxs=cat_idxs,<br/>                           cat_dims=cat_dims,<br/>                           n_steps=n_steps,<br/>                           n_independent=n_independent,<br/>                           n_shared=n_shared,<br/>                           batch_size=batch_size,<br/>                           training_data_file=training_data_file)<br/><br/><br/>   return clf<br/><br/><br/>def objective(trial):<br/>   clf = define_model(trial)<br/><br/>   clf.fit(os.path.join(args.training_data_directory, args.dataset),<br/>           df[int(len(df) * split_test)])<br/><br/><br/>   y_pred = clf.predict(predict_data)<br/>   y_true = np.array(predict_data[y_ls].values).astype(np.int32)<br/><br/>   metric_value = call_metrics(y_true, y_pred)<br/><br/>   return metric_value<br/><br/><br/>study = optuna.create_study(direction='minimize',<br/>                            storage='sqlite:///db.sqlite3',<br/>                            study_name=model_name,<br/>                            load_if_exists=True)<br/><br/>study.optimize(objective,<br/>               n_trials=50)</span></pre><p id="1e5e" class="pw-post-body-paragraph nb nc gk nd b hi ne nf ng hl nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">The data are being split into a training, validation and testing set. The usage for the different datasets are:</p><ul class=""><li id="df5a" class="nb nc gk nd b hi ne nf ng hl nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw oo op oq bk">Train. This is the dataset the model learns from. Consists in this project of 80%.</li><li id="e782" class="nb nc gk nd b hi or nf ng hl os ni nj nk ot nm nn no ou nq nr ns ov nu nv nw oo op oq bk">Validation. Is the dataset Optuna calculates its metrics from, and hence the metric optimized for. 10% of the data for this project.</li><li id="2d1d" class="nb nc gk nd b hi or nf ng hl os ni nj nk ot nm nn no ou nq nr ns ov nu nv nw oo op oq bk">Test. This is the dataset used to determine the true model performance. If this metric is not good enough, it might be worth going back to investigating other models. This dataset is also used to decide when it is time to stop the hyper parameter tuning. It is also on the basis of this dataset the KPI’s are derived and visualisations shared with the stakeholders.</li></ul><p id="a643" class="pw-post-body-paragraph nb nc gk nd b hi ne nf ng hl nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">One final note is that to mimic the behavior of when the model is deployed, as much as possible, the datasets is being split on time. This means that the data from the first 80% of the period goes into the training part, the next 10% goes into validation and the most recent 10% into testing.</p></div></div><div class="fw"><div class="ab cb"><div class="mf ow mg ox mh oy cf oz cg pa ci bh"><figure class="nz oa ob oc od fw pc pd paragraph-image"><div role="button" tabindex="0" class="fx fy ed fz bh ga"><div class="fo fp pb"><img src="../Images/457c9b60de76deafea9d022d15c28ab4.png" data-original-src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*tQ5TU1X8S0it51xLYMrP-w.png"/></div></div><figcaption class="gd ge gf fo fp gg gh bf b bg z dx">Illustration of time series data split. Plots created by the author.</figcaption></figure></div></div></div><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="6845" class="pw-post-body-paragraph nb nc gk nd b hi ne nf ng hl nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">For the example presented here, the trials are saved to disk. A more common approach is to save it to a cloud storage for better accessibility and easier maintenance. Optuna also comes with a UI for visualization, which can be spin up running the following command in the terminal.</p><pre class="nz oa ob oc od oe of og bp oh bb bk"><span id="79e3" class="oi oj gk of b bg ok ol l om on">pip install optuna-dashboard<br/><br/>cd /path/to/directory_with-db.sqlite3/<br/><br/>optuna-dashboard sqlite:///db.sqlite3</span></pre><p id="612c" class="pw-post-body-paragraph nb nc gk nd b hi ne nf ng hl nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">A manual task for sanity checking the parameter tuning, is to see how close to the sampling limits, the optimal parameters are. If they are reasonably far away from the bounds set, there is no need to look further into broadening the search space.</p><p id="e683" class="pw-post-body-paragraph nb nc gk nd b hi ne nf ng hl nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">An in-depth look into what is displayed from the tuning can be found <a class="af ny" href="https://optuna-dashboard.readthedocs.io/en/latest/getting-started.html" rel="noopener ugc nofollow" target="_blank">here</a>.</p><p id="d984" class="pw-post-body-paragraph nb nc gk nd b hi ne nf ng hl nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">And here is a visualisation of some of the results.</p></div></div><div class="fw"><div class="ab cb"><div class="mf ow mg ox mh oy cf oz cg pa ci bh"><figure class="nz oa ob oc od fw pc pd paragraph-image"><div role="button" tabindex="0" class="fx fy ed fz bh ga"><div class="fo fp pe"><img src="../Images/2aa2d5280c0f9aebe258635ec2917aba.png" data-original-src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*DxT7HdkOk5zgUSxMtuS2KQ.png"/></div></div></figure><figure class="ly fw pc pd paragraph-image"><div role="button" tabindex="0" class="fx fy ed fz bh ga"><div class="fo fp pe"><img src="../Images/fa264aa50a22d3afb54580c6f7c987a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*UPQXFiFbw_XFXIXy-anzVQ.png"/></div></div></figure><figure class="ly fw pc pd paragraph-image"><div role="button" tabindex="0" class="fx fy ed fz bh ga"><div class="fo fp pe"><img src="../Images/5a099d16c8bb0be766afb92ee9ce6adf.png" data-original-src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*UaaJaF4QDq3nKHK5gxgrug.png"/></div></div><figcaption class="gd ge gf fo fp gg gh bf b bg z dx">Visualisation of model performance. Plots created by the author.</figcaption></figure></div></div></div><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="9e17" class="pw-post-body-paragraph nb nc gk nd b hi ne nf ng hl nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk"><strong class="nd gl">Conclusions and client remarks.</strong></p><p id="5f49" class="pw-post-body-paragraph nb nc gk nd b hi ne nf ng hl nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">The graph indicates increased uncertainty when forecasting service usage further into the future. This is to be expected, also confirmed by the client.</p><p id="99cf" class="pw-post-body-paragraph nb nc gk nd b hi ne nf ng hl nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">As noticed, the model is having difficulties finding the spikes that are out of the ordinary. In the real use case, the effort was focused on looking into more sources of data, to see if the model could better predict these outliers.</p><p id="2d8c" class="pw-post-body-paragraph nb nc gk nd b hi ne nf ng hl nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">In the final product there was also introduced a novelty score for the data point predicted, using the library Deepchecks. This came out of discussions with the client, trying to detect data drift and also for user insights into the data. In another article, there will be a deep dive on how this could be developed.</p><p id="efa8" class="pw-post-body-paragraph nb nc gk nd b hi ne nf ng hl nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk"><strong class="nd gl">Thank you for reading!</strong></p><p id="5190" class="pw-post-body-paragraph nb nc gk nd b hi ne nf ng hl nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">I hope you found this article useful and/or inspiring. If you have any comments or question, please reach out! You can also connect with me on <a class="af ny" href="https://www.linkedin.com/in/hampus-gustavsson-23721a116/" rel="noopener ugc nofollow" target="_blank">LinkedIn</a>.</p></div></div></div></div>    
</body>
</html>