<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Spotting Spatiotemporal Patterns in Earthquake Data</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Spotting Spatiotemporal Patterns in Earthquake Data</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/spotting-spatiotemporal-patterns-in-earthquake-data-b07068b84314?source=collection_archive---------14-----------------------#2024-01-10">https://towardsdatascience.com/spotting-spatiotemporal-patterns-in-earthquake-data-b07068b84314?source=collection_archive---------14-----------------------#2024-01-10</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="4d09" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx">Use density-based clustering and survival analysis to estimate when earthquakes occur</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hd he hf hg hh ab"><div><div class="ab hi"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@elz1582?source=post_page---byline--b07068b84314--------------------------------" rel="noopener follow"><div class="l hj hk by hl hm"><div class="l ed"><img alt="Elliot Humphrey" class="l ep by dd de cx" src="../Images/62f398bd178bd4eae0fb5c4062972e23.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/1*qaeGYf2hX7-XPMcoKNS71g.jpeg"/><div class="hn by l dd de em n ho eo"/></div></div></a></div></div><div class="hp ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--b07068b84314--------------------------------" rel="noopener follow"><div class="l hq hr by hl hs"><div class="l ed"><img alt="Towards Data Science" class="l ep by br ht cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hn by l br ht em n ho eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hu ab q"><div class="ab q hv"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hw hx bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hy" data-testid="authorName" href="https://medium.com/@elz1582?source=post_page---byline--b07068b84314--------------------------------" rel="noopener follow">Elliot Humphrey</a></p></div></div></div><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hw hx dx"><button class="ib ic ah ai aj ak al am an ao ap aq ar id ie if" disabled="">Follow</button></p></div></div></span></div></div><div class="l ig"><span class="bf b bg z dx"><div class="ab cn ih ii ij"><div class="ik il ab"><div class="bf b bg z dx ab im"><span class="in l ig">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hy ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--b07068b84314--------------------------------" rel="noopener follow"><p class="bf b bg z io ip iq ir is it iu iv bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">9 min read</span><div class="iw ix l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Jan 10, 2024</span></div></span></div></span></div></div></div><div class="ab cp iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn"><div class="h k w ea eb q"><div class="kd l"><div class="ab q ke kf"><div class="pw-multi-vote-icon ed in kg kh ki"><div class=""><div class="kj kk kl km kn ko kp am kq kr ks ki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kt ku kv kw kx ky kz"><p class="bf b dy z dx"><span class="kk">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kj lc ld ab q ee le lf" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="lb"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg><p class="bf b dy z dx"><span class="pw-responses-count la lb">1</span></p></button></div></div></div><div class="ab q jo jp jq jr js jt ju jv jw jx jy jz ka kb kc"><div class="lg k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lh an ao ap id li lj lk" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep ll cn"><div class="l ae"><div class="ab cb"><div class="lm ln lo lp lq lr ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk ml"><img src="../Images/4519b73a2e644d58c57fd4078fe17b72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*sayjdUvygDYDHJvs"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Photo by <a class="af nc" href="https://unsplash.com/@eli_from_prague?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Eliška Motisová</a> on <a class="af nc" href="https://unsplash.com/?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h2 id="4aef" class="nd ne fq bf nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa bk">Introduction</h2><p id="5793" class="pw-post-body-paragraph ob oc fq od b go oe of og gr oh oi oj no ok ol om ns on oo op nw oq or os ot fj bk">Whilst we have a fairly good understanding of where and why earthquakes occur, understanding when an earthquake will happen is very challenging. In this article we will use historical earthquake data and a combination of clustering and survival analysis to answer the following questions:</p><p id="3771" class="pw-post-body-paragraph ob oc fq od b go ou of og gr ov oi oj no ow ol om ns ox oo op nw oy or os ot fj bk"><em class="oz">“How are earthquake events spatially distributed?”</em></p><p id="7c7e" class="pw-post-body-paragraph ob oc fq od b go ou of og gr ov oi oj no ow ol om ns ox oo op nw oy or os ot fj bk"><em class="oz">“If an earthquake happens, what’s the probability of another earthquake happening within the next hour?”</em></p><p id="4957" class="pw-post-body-paragraph ob oc fq od b go ou of og gr ov oi oj no ow ol om ns ox oo op nw oy or os ot fj bk"><em class="oz">“Are there regional differences in the time between earthquake events?”</em></p><h2 id="b0fb" class="nd ne fq bf nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa bk">Getting the data</h2><p id="b04c" class="pw-post-body-paragraph ob oc fq od b go oe of og gr oh oi oj no ok ol om ns on oo op nw oq or os ot fj bk">We will be using data from the USGS[<a class="af nc" href="https://usgs.gov" rel="noopener ugc nofollow" target="_blank">1</a>] that records earthquake events (earthquake data resides in the Public Domain and is provided courtesy of the U.S. Geological Survey). They have a nice <a class="af nc" href="https://earthquake.usgs.gov/fdsnws/event/1/" rel="noopener ugc nofollow" target="_blank">API</a> that means we can get earthquake data in a straightforward way in Python:</p><pre class="mm mn mo mp mq pa pb pc bp pd bb bk"><span id="996e" class="pe ne fq pb b bg pf pg l ph pi">import http.client<br/>import pandas as pd<br/>import json<br/><br/>url = '/fdsnws/event/1/query'<br/>query_params = {<br/>    'format': 'geojson',<br/>    'starttime': "2020-01-01",<br/>    'limit': '10000',<br/>    'minmagnitude': 3,<br/>    'maxlatitude': '47.009499',<br/>    'minlatitude': '32.5295236',<br/>    'maxlongitude': '-114.1307816',<br/>    'minlongitude': '-124.482003',<br/>}<br/>full_url = f'https://earthquake.usgs.gov{url}?{"&amp;".join(f"{key}={value}" for key, value in query_params.items())}'<br/><br/>print('defined params...')<br/><br/>conn = http.client.HTTPSConnection('earthquake.usgs.gov')<br/>conn.request('GET', full_url)<br/>response = conn.getresponse()</span></pre><p id="1e60" class="pw-post-body-paragraph ob oc fq od b go ou of og gr ov oi oj no ow ol om ns ox oo op nw oy or os ot fj bk">In our API request we have a few parameters:</p><ul class=""><li id="4fbf" class="ob oc fq od b go ou of og gr ov oi oj no ow ol om ns ox oo op nw oy or os ot pj pk pl bk"><strong class="od fr">limit </strong>— <em class="oz">The maximum number of earthquake events we want</em></li><li id="c956" class="ob oc fq od b go pm of og gr pn oi oj no po ol om ns pp oo op nw pq or os ot pj pk pl bk"><strong class="od fr">starttime</strong> — <em class="oz">When should the earliest earthquake event be</em></li><li id="3ec4" class="ob oc fq od b go pm of og gr pn oi oj no po ol om ns pp oo op nw pq or os ot pj pk pl bk"><strong class="od fr">minmagnitude</strong> — <em class="oz">The minimum magnitude of an earthquake event</em></li><li id="3788" class="ob oc fq od b go pm of og gr pn oi oj no po ol om ns pp oo op nw pq or os ot pj pk pl bk"><strong class="od fr">maxlatitude</strong> — <em class="oz">Maximum latitude</em></li><li id="7429" class="ob oc fq od b go pm of og gr pn oi oj no po ol om ns pp oo op nw pq or os ot pj pk pl bk"><strong class="od fr">minlatitude</strong> — <em class="oz">Minimum latitude</em></li><li id="cc89" class="ob oc fq od b go pm of og gr pn oi oj no po ol om ns pp oo op nw pq or os ot pj pk pl bk"><strong class="od fr">maxlongitude</strong> — <em class="oz">Maximum longitude</em></li><li id="d8b3" class="ob oc fq od b go pm of og gr pn oi oj no po ol om ns pp oo op nw pq or os ot pj pk pl bk"><strong class="od fr">minlongitude</strong> — <em class="oz">Minimum longitude</em></li></ul><p id="955c" class="pw-post-body-paragraph ob oc fq od b go ou of og gr ov oi oj no ow ol om ns ox oo op nw oy or os ot fj bk">We will set the minimum magnitude to 3, as this is typically what can be felt at the surface, and provide latitude and longitude coordinates to make a bounding box around the US state of California. California is home to the famous <strong class="od fr">San Andreas Fault</strong>, so will have plenty of earthquake events for us to analyse.</p><p id="0937" class="pw-post-body-paragraph ob oc fq od b go ou of og gr ov oi oj no ow ol om ns ox oo op nw oy or os ot fj bk">To handle the GeoJSON response we use the following code:</p><pre class="mm mn mo mp mq pa pb pc bp pd bb bk"><span id="76e8" class="pe ne fq pb b bg pf pg l ph pi">if response.status == 200:<br/>    print('Got a response.')<br/>    data = response.read()<br/>    print('made the GET request...')<br/>    data = data.decode('utf-8')<br/>    json_data = json.loads(data)<br/>    features = json_data['features']<br/>    df = pd.json_normalize(features)<br/><br/>    if df.empty:<br/>        print('No earthquakes recorded.')<br/>    else:<br/>        df[['Longitude', 'Latitude', 'Depth']] = df['geometry.coordinates'].apply(lambda x: pd.Series(x))<br/>        df['datetime'] = df['properties.time'].apply(lambda x : datetime.datetime.fromtimestamp(x / 1000))<br/>        df['datetime'] = df['datetime'].astype(str)<br/>        df.sort_values(by=['datetime'], inplace=True)<br/>else:<br/>  print(f"Error: {response.status}")</span></pre><p id="cd0b" class="pw-post-body-paragraph ob oc fq od b go ou of og gr ov oi oj no ow ol om ns ox oo op nw oy or os ot fj bk">This will return a Pandas DataFrame where each row is an earthquake event, with columns describing event properties (i.e., latitude, longitude, magnitude, id etc.).</p><p id="10bc" class="pw-post-body-paragraph ob oc fq od b go ou of og gr ov oi oj no ow ol om ns ox oo op nw oy or os ot fj bk">For the geospatially-minded out there, you’ll recognise that the API call coordinates represent a <em class="oz">bounding box</em> of earthquakes (i.e., finds earthquakes in a boxed area), however we only care about <strong class="od fr">earthquakes in California</strong>. Therefore we will need to filter out all the earthquakes that did not occur in California (e.g., earthquake events in Nevada &amp; Oregon). To do this we will use the convenient OSMNX package to get a <strong class="od fr">MultiPolygon of the California border</strong>:</p><pre class="mm mn mo mp mq pa pb pc bp pd bb bk"><span id="6ddd" class="pe ne fq pb b bg pf pg l ph pi">import osmnx<br/>import geopandas as gpd<br/><br/>place = "California, USA"<br/>gdf = osmnx.geocode_to_gdf(place)<br/># Get the target geometry<br/>gdf = gdf[["geometry", "bbox_north", "bbox_south", "bbox_east", "bbox_west"]]</span></pre><p id="ab62" class="pw-post-body-paragraph ob oc fq od b go ou of og gr ov oi oj no ow ol om ns ox oo op nw oy or os ot fj bk">Next we’ll convert our earthquake coordinates into <strong class="od fr">Point geometries using Shapely</strong>, and then perform a <strong class="od fr">spatial join</strong> to filter our non-Californian earthquakes:</p><pre class="mm mn mo mp mq pa pb pc bp pd bb bk"><span id="e418" class="pe ne fq pb b bg pf pg l ph pi">from shapely.geometry import Point<br/># Convert to a GeoDataFrame with Point geometry<br/>geometry = [Point(xy) for xy in zip(df['Longitude'], df['Latitude'])]<br/>earthquake_gdf = gpd.GeoDataFrame(df, geometry=geometry, crs='EPSG:4326')<br/><br/># Filter to keep only points within the California bounding box<br/>points_within_california = gpd.sjoin(earthquake_gdf, gdf, how='inner', predicate='within')<br/><br/># Extract latitude, longitude etc.<br/>df = points_within_california[['id', 'Latitude', 'Longitude', 'datetime', 'properties.mag']]</span></pre><p id="f93b" class="pw-post-body-paragraph ob oc fq od b go ou of og gr ov oi oj no ow ol om ns ox oo op nw oy or os ot fj bk">Now to see our first map of Californian earthquakes colour-coded by magnitude:</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk pr"><img src="../Images/0b68b55b7593862f5be48a8f9e49fee1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ILpZJ5dbYHSXlEJOFdhgzA.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Map of earthquakes in California. Data from the USGS. Image by Author.</figcaption></figure><p id="27e2" class="pw-post-body-paragraph ob oc fq od b go ou of og gr ov oi oj no ow ol om ns ox oo op nw oy or os ot fj bk">Excellent, we now have a map of California earthquakes!</p><h2 id="5809" class="nd ne fq bf nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa bk">Spatial Clustering of earthquakes</h2><p id="5dac" class="pw-post-body-paragraph ob oc fq od b go oe of og gr oh oi oj no ok ol om ns on oo op nw oq or os ot fj bk">Looking at the earthquakes plotted on the map earlier you can see that events are spatially arranged in a linear SE-NW orientation, where you can see around 2–3 clear linear-shaped groupings of earthquakes. This makes sense because:</p><ol class=""><li id="fdb6" class="ob oc fq od b go ou of og gr ov oi oj no ow ol om ns ox oo op nw oy or os ot ps pk pl bk">Earthquakes occur due to movements along faults, which are linear features (i.e., cracks in the Earth’s crust).</li><li id="c48a" class="ob oc fq od b go pm of og gr pn oi oj no po ol om ns pp oo op nw pq or os ot ps pk pl bk">The orientation of earthquake events matches the orientation of the San Andreas Fault zone.</li></ol><p id="7195" class="pw-post-body-paragraph ob oc fq od b go ou of og gr ov oi oj no ow ol om ns ox oo op nw oy or os ot fj bk">Our goal is now to cluster these earthquake events based on their location, so that we can produce spatial clusters associated with regional faults.</p><p id="84ae" class="pw-post-body-paragraph ob oc fq od b go ou of og gr ov oi oj no ow ol om ns ox oo op nw oy or os ot fj bk">For clustering we will use <strong class="od fr">HDBSCAN</strong> (Hierarchical Density-Based Spatial Clustering of Applications with Noise) which is a density-based clustering algorithm useful for certain types of datasets, such as those with irregularly shaped clusters and varying cluster densities. This is relevant to our dataset since earthquake events can occur in <strong class="od fr">irregular shaped clusters</strong> (i.e., along faults of different orientations) and in <strong class="od fr">different densities</strong> (i.e, some fault zones are more active than others). HDBSCAN is also <strong class="od fr">robust to outliers</strong>, which is this case can be earthquakes that occur far away from fault zones.</p><p id="0938" class="pw-post-body-paragraph ob oc fq od b go ou of og gr ov oi oj no ow ol om ns ox oo op nw oy or os ot fj bk">Through some experimentation the following parameters produce okay results (<em class="oz">a bit of trial and error involved, but guided by our prior assumptions on how earthquakes should be clustered</em>):</p><pre class="mm mn mo mp mq pa pb pc bp pd bb bk"><span id="db9e" class="pe ne fq pb b bg pf pg l ph pi"># Fit HDBSCAN<br/>clusterer = HDBSCAN(min_cluster_size=200, metric='haversine', min_samples=20, cluster_selection_epsilon=0.05)<br/>result_df['cluster_label_hdbscan'] = clusterer.fit_predict(data_scaled)<br/><br/># Find the number of unique cluster labels<br/>num_clusters = result_df['cluster_label_hdbscan'].nunique()<br/><br/># Create a list of colors<br/>colors = ['lightgray', 'red', 'blue', 'green'][:num_clusters]<br/><br/># Create a Folium map centered at the mean coordinates<br/>map_center = [result_df['Latitude'].mean(), result_df['Longitude'].mean()]<br/>mymap = folium.Map(location=map_center, zoom_start=6)<br/><br/># Add markers for each data point with cluster color<br/>for _, row in result_df.iterrows():<br/>    cluster_color = colors[row['cluster_label_hdbscan'] + 1]  # Map cluster label to color<br/>    folium.CircleMarker(<br/>        location=[row['Latitude'], row['Longitude']],<br/>        radius=2,<br/>        color=cluster_color,<br/>        fill=True,<br/>        fill_color=cluster_color,<br/>        fill_opacity=0.7,<br/>        popup=f'Cluster: {row["cluster_label_hdbscan"]}'<br/>    ).add_to(mymap)<br/>mymap</span></pre><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk pt"><img src="../Images/2b5f834fd69d8787d7a685ad67af85cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qjRvTgjMWO2zGxAD3NFz3w.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Earthquake locations color-coded by HDBSCAN cluster. Image by Author.</figcaption></figure><p id="1ed6" class="pw-post-body-paragraph ob oc fq od b go ou of og gr ov oi oj no ow ol om ns ox oo op nw oy or os ot fj bk">Super, we have now used HDBSCAN to cluster our earthquake events into three areas, which corresponds with our prior regional knowledge. <em class="oz">Note that some earthquakes are considered outliers and coloured grey.</em></p><h2 id="64b3" class="nd ne fq bf nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa bk">Examining the time between earthquakes</h2><p id="4cdd" class="pw-post-body-paragraph ob oc fq od b go oe of og gr oh oi oj no ok ol om ns on oo op nw oq or os ot fj bk">Since we have the date and time of each earthquake we can calculate <strong class="od fr">the time between each event</strong> (i.e., the time duration between two earthquakes), which is required for our Survival Analysis in the next section. We have already sorted our values by the <em class="oz">‘datetime’ </em>column so they’re in chronological order, now we need to calculate the time difference:</p><pre class="mm mn mo mp mq pa pb pc bp pd bb bk"><span id="e686" class="pe ne fq pb b bg pf pg l ph pi">from datetime import datetime<br/><br/># Convert 'time' column to datetime objects<br/>df['time'] = pd.to_datetime(df['datetime'])<br/><br/># Sort dataframe by time<br/>df.sort_values(by=['time'], inplace=True)<br/><br/># Calculate time elapsed between consecutive events<br/>df['time_elapsed'] = df['time'].diff().shift(-1)</span></pre><p id="1844" class="pw-post-body-paragraph ob oc fq od b go ou of og gr ov oi oj no ow ol om ns ox oo op nw oy or os ot fj bk">Since there will be no time difference for the last earthquake (i.e., the most recent) we can calculate the difference from a time we’ll assume as the present day:</p><pre class="mm mn mo mp mq pa pb pc bp pd bb bk"><span id="7d06" class="pe ne fq pb b bg pf pg l ph pi"># Assuming present time is '2024-01-08 16:06:00.000'<br/>present_time = pd.to_datetime('2024-01-08 16:06:00.000')<br/><br/># For the last event of each group, replace NaN with time between event and present time<br/>df['time_elapsed'].fillna(present_time - df['time'], inplace=True)</span></pre><p id="5380" class="pw-post-body-paragraph ob oc fq od b go ou of og gr ov oi oj no ow ol om ns ox oo op nw oy or os ot fj bk">Finally we will add a new column indicating whether an earthquake was followed by another earthquake. Whilst this seems slightly redundant, given that only the last earthquake is affected by this, it highlights an interesting point about using survival analysis for these types of tasks (which we’ll cover later):</p><pre class="mm mn mo mp mq pa pb pc bp pd bb bk"><span id="040a" class="pe ne fq pb b bg pf pg l ph pi"># Label events based on whether they happened or not<br/>df['event_happened'] = df['time_elapsed'].apply(lambda x: 1 if pd.Timedelta(days=0) &gt; 0 else 0)</span></pre><p id="16b2" class="pw-post-body-paragraph ob oc fq od b go ou of og gr ov oi oj no ow ol om ns ox oo op nw oy or os ot fj bk">Here is a histogram of the elapsed time between earthquake events:</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk pu"><img src="../Images/b78b04686bcdb6a09057350df3f36897.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XArsalhXeq1QYzm_s4KWNg.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Histogram of earthquake interval times. Image by Author.</figcaption></figure><p id="769e" class="pw-post-body-paragraph ob oc fq od b go ou of og gr ov oi oj no ow ol om ns ox oo op nw oy or os ot fj bk">We can see that the majority of earthquakes occur in short succession of each other (approximately 2.5 hours of each other), with far fewer earthquakes occurring at longer time intervals apart (i.e., the maximum time between earthquakes in this dataset is 350 hours).</p><h2 id="eb9f" class="nd ne fq bf nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa bk">Survival Analysis of Earthquake Time Intervals</h2><p id="97f0" class="pw-post-body-paragraph ob oc fq od b go oe of og gr oh oi oj no ok ol om ns on oo op nw oq or os ot fj bk">We have our earthquake clusters, as well as the time between earthquakes, so now we use Survival Analysis to tell us about the probability of earthquake occurrences. Our goals will therefore be to:</p><ol class=""><li id="4be1" class="ob oc fq od b go ou of og gr ov oi oj no ow ol om ns ox oo op nw oy or os ot ps pk pl bk">Use survival analysis to create curves that show the probability of an earthquake occurring in time, given that an earthquake has just occurred.</li><li id="ecc1" class="ob oc fq od b go pm of og gr pn oi oj no po ol om ns pp oo op nw pq or os ot ps pk pl bk">Compare our probability curves across our already clustered earthquake regions, to see if there are any similarities/differences in regional earthquake activity.</li></ol><p id="75c0" class="pw-post-body-paragraph ob oc fq od b go ou of og gr ov oi oj no ow ol om ns ox oo op nw oy or os ot fj bk"><em class="oz">What is survival analysis?</em></p><p id="9e21" class="pw-post-body-paragraph ob oc fq od b go ou of og gr ov oi oj no ow ol om ns ox oo op nw oy or os ot fj bk">There are plenty of well-written articles [<a class="af nc" rel="noopener" target="_blank" href="/the-complete-introduction-to-survival-analysis-in-python-7523e17737e6">2</a>,<a class="af nc" href="https://medium.com/the-researchers-guide/survival-analysis-in-python-km-estimate-cox-ph-and-aft-model-5533843c5d5d" rel="noopener">3</a>,<a class="af nc" rel="noopener" target="_blank" href="/introduction-to-survival-analysis-6f7e19c31d96">4</a>] covering this, but in short, survival analysis is a statistical technique used to analyse time-to-event data, typically in the context of biomedical or observational studies. It focuses on estimating and modelling the time until an event of interest occurs, such as death, failure, or another specific outcome, providing insights into the probability of events happening over time and the impact of covariates on the event occurrence.</p><p id="eb53" class="pw-post-body-paragraph ob oc fq od b go ou of og gr ov oi oj no ow ol om ns ox oo op nw oy or os ot fj bk"><strong class="od fr">In our case, an earthquake has happened and we want to know the probability of another earthquake occurring over time. </strong><em class="oz">Note: we make the assumption that earthquake events are independent, as well as only retrieving events with a minimum magnitude of 3, which is a limitation of this work since it oversimplifies earthquake dynamics.</em></p><p id="af50" class="pw-post-body-paragraph ob oc fq od b go ou of og gr ov oi oj no ow ol om ns ox oo op nw oy or os ot fj bk">The <strong class="od fr">Kaplan-Meier estimator</strong> is a non-parametric method used in survival analysis to estimate the survival function, which will give us our probabilities. We will use the package <a class="af nc" href="https://pypi.org/project/lifelines/" rel="noopener ugc nofollow" target="_blank"><strong class="od fr">‘lifelines’</strong></a><strong class="od fr"> </strong>to fit the Kaplan-Meier estimator to the earthquakes in each cluster, to produce a probability curve:</p><pre class="mm mn mo mp mq pa pb pc bp pd bb bk"><span id="4cbf" class="pe ne fq pb b bg pf pg l ph pi">import plotly.graph_objects as go<br/>from lifelines import KaplanMeierFitter<br/><br/># Initialize Kaplan-Meier Fitter<br/>kmf = KaplanMeierFitter()<br/><br/># Create a Plotly Figure<br/>fig = go.Figure()<br/><br/>color_map = {0: 'red', 1: 'blue', 2: 'green', -1: 'gray'}<br/><br/># Fit and plot survival curves for each cluster excluding cluster -1<br/>for label, group in result_df.groupby('cluster_label_hdbscan'):<br/>    if label != -1:<br/>        durations = group['time_elapsed'].dt.total_seconds() / 3600  # Convert hours to days<br/>        event_observed = group['event_happened'].values<br/>        kmf.fit(durations=durations, event_observed=a)<br/>        <br/>        # Plot survival function<br/>        fig.add_trace(go.Scatter(<br/>            x=kmf.survival_function_.index,<br/>            y=1-kmf.survival_function_.KM_estimate,<br/>            mode='lines',<br/>            name=f'Cluster {label}',<br/>            line=dict(color=color_map[label])<br/>        ))<br/><br/># Customize the plot<br/>fig.update_layout(<br/>    xaxis_title='Elapsed Time (hours)',<br/>    yaxis_title='Probability of experiencing an earthquake',<br/>    legend_title='Cluster Labels',<br/>    width=800,  # Adjust width<br/>    height=500,  # Adjust height<br/>    margin=dict(l=50, r=20, t=50, b=50),  # Adjust margins<br/>    legend=dict(x=0.8, y=0.99),  # Adjust legend position<br/>)<br/><br/># Show the plot<br/>fig.show()</span></pre><p id="fd10" class="pw-post-body-paragraph ob oc fq od b go ou of og gr ov oi oj no ow ol om ns ox oo op nw oy or os ot fj bk">Before seeing the results, notice the ‘event_observed’ parameter that uses the ‘event_happened’ column we created earlier. Our final earthquake is an example of a right-censored data point, since there was no following earthquake, and is therefore treated as a partial observation.</p><p id="00e6" class="pw-post-body-paragraph ob oc fq od b go ou of og gr ov oi oj no ow ol om ns ox oo op nw oy or os ot fj bk">Now to view the curves:</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk pv"><img src="../Images/e8b53a4f807fd1e75b46f57be450ffcf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KJhOrffKycO6u9RSnkhvKQ.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Survival analysis probability curves for clustered earthquake regions. Image by Author.</figcaption></figure><p id="ae01" class="pw-post-body-paragraph ob oc fq od b go ou of og gr ov oi oj no ow ol om ns ox oo op nw oy or os ot fj bk">Each cluster of earthquakes has its own coloured curve, where the X axis represents the time elapsed after an earthquake, and the Y axis represents the probability of an earthquake occurring. Some interesting observations:</p><ul class=""><li id="6559" class="ob oc fq od b go ou of og gr ov oi oj no ow ol om ns ox oo op nw oy or os ot pj pk pl bk">The shape of the curves are similar.</li><li id="2a07" class="ob oc fq od b go pm of og gr pn oi oj no po ol om ns pp oo op nw pq or os ot pj pk pl bk">The initial steepness of the curves varies by cluster location.</li></ul><p id="07a2" class="pw-post-body-paragraph ob oc fq od b go ou of og gr ov oi oj no ow ol om ns ox oo op nw oy or os ot fj bk">Lets focus on the initial time after an earthquake has occurred, since most of our data shows that earthquakes happen in relatively quick succession:</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk pw"><img src="../Images/2c43d41fa913ec967e2bfed744cd775f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XMFBNfXF11v_9A03QIrwLA.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Survival analysis probability curves for clustered earthquake regions. Image by Author.</figcaption></figure><p id="ffb8" class="pw-post-body-paragraph ob oc fq od b go ou of og gr ov oi oj no ow ol om ns ox oo op nw oy or os ot fj bk">This suggests that the <strong class="od fr">time between earthquakes is not the same regionally</strong>. Looking at the graph we can say that once an earthquake event has happened, the probability of another earthquake happening within ten hours is approximately 35% for cluster 0, 60% for cluster 1, and 48% for cluster 2. This shows that earthquakes in the region that belong to cluster 1 happen in quick success relative to the other two areas.</p><p id="8cc4" class="pw-post-body-paragraph ob oc fq od b go ou of og gr ov oi oj no ow ol om ns ox oo op nw oy or os ot fj bk">We can double check this by looking at a histogram of elapsed time between earthquakes for each cluster location:</p><pre class="mm mn mo mp mq pa pb pc bp pd bb bk"><span id="a844" class="pe ne fq pb b bg pf pg l ph pi">import plotly.graph_objects as go<br/>from plotly.subplots import make_subplots<br/>import numpy as np<br/><br/># Filter data<br/>filtered_df = result_df[result_df['cluster_label_hdbscan'] != -1]<br/><br/># Create subplots in a 2 by 2 grid<br/>fig = make_subplots(rows=2, cols=2, subplot_titles=[f'Cluster {label}' for label in filtered_df['cluster_label_hdbscan'].unique()],<br/>                    shared_xaxes='all', shared_yaxes='all')<br/><br/># Create histograms for elapsed time for each cluster<br/>for i, (label, group) in enumerate(filtered_df.groupby('cluster_label_hdbscan')):<br/>    # Calculate histogram<br/>    hist_data, bin_edges = np.histogram(group['time_elapsed'].dt.total_seconds() / 3600, bins=20)<br/><br/>    # Add histogram trace to subplot<br/>    fig.add_trace(go.Bar(<br/>        x=bin_edges,<br/>        y=hist_data,<br/>        opacity=0.5,<br/>        name=f'Cluster {label}',<br/>        marker=dict(color=color_map[label])<br/>    ), row=(i // 2) + 1, col=(i % 2) + 1)<br/><br/>    # Customise subplot<br/>    fig.update_xaxes(title_text='Elapsed Time (hours)', row=(i // 2) + 1, col=(i % 2) + 1)<br/>    fig.update_yaxes(title_text='Frequency', row=(i // 2) + 1, col=(i % 2) + 1)<br/><br/># Update layout<br/>fig.update_layout(<br/>    showlegend=False,<br/>    margin=dict(l=50, r=50, t=50, b=50),  # Adjust margins<br/>    height=600,<br/>    width=800,<br/>)<br/><br/># Show the plot<br/>fig.show()</span></pre><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk px"><img src="../Images/d579ab6fdf6ae30d39347cdf2a49c56e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vb-TEoVKoTUlnMGPVFzwew.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Histograms of elapsed time between earthquakes in clustered regions. Image by Author.</figcaption></figure><p id="7ab2" class="pw-post-body-paragraph ob oc fq od b go ou of og gr ov oi oj no ow ol om ns ox oo op nw oy or os ot fj bk">As shown by the probability curves, cluster 1 has longer intervals between earthquake events relative to clusters 2 and 3.</p><h2 id="dec8" class="nd ne fq bf nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa bk">Conclusion</h2><p id="1bfe" class="pw-post-body-paragraph ob oc fq od b go oe of og gr oh oi oj no ok ol om ns on oo op nw oq or os ot fj bk">This work utilised <strong class="od fr">spatial clustering </strong>and <strong class="od fr">survival analysis</strong> to unravel temporal and geographic patterns within earthquake data. By employing techniques such as <strong class="od fr">HDBSCAN</strong> for spatial clustering and the <strong class="od fr">Kaplan-Meier</strong> estimator for survival analysis, we gained valuable insights into the <strong class="od fr">regional variations in time between earthquakes</strong>, which was translated into probability curves that can be useful for risk assessment and preparedness in earthquake-prone regions.</p><p id="959f" class="pw-post-body-paragraph ob oc fq od b go ou of og gr ov oi oj no ow ol om ns ox oo op nw oy or os ot fj bk">Thanks for reading!</p><p id="f6d7" class="pw-post-body-paragraph ob oc fq od b go ou of og gr ov oi oj no ow ol om ns ox oo op nw oy or os ot fj bk"><em class="oz">Disclaimer: This article should only be used for learning purposes.</em></p></div></div></div></div>    
</body>
</html>