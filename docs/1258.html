<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Generating Map Tiles with Rust</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Generating Map Tiles with Rust</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/generating-map-tiles-with-rust-dbdb0eb09b6b?source=collection_archive---------3-----------------------#2024-05-19">https://towardsdatascience.com/generating-map-tiles-with-rust-dbdb0eb09b6b?source=collection_archive---------3-----------------------#2024-05-19</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="92ea" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx">How easy is it to transition from Python to Rust?</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hd he hf hg hh ab"><div><div class="ab hi"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@joao.figueira?source=post_page---byline--dbdb0eb09b6b--------------------------------" rel="noopener follow"><div class="l hj hk by hl hm"><div class="l ed"><img alt="João Paulo Figueira" class="l ep by dd de cx" src="../Images/54e4176f66e4ab0324d86ec71d8b033d.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/1*KhSF0xxPYqlN4Y6vnClBQQ.png"/><div class="hn by l dd de em n ho eo"/></div></div></a></div></div><div class="hp ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--dbdb0eb09b6b--------------------------------" rel="noopener follow"><div class="l hq hr by hl hs"><div class="l ed"><img alt="Towards Data Science" class="l ep by br ht cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hn by l br ht em n ho eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hu ab q"><div class="ab q hv"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hw hx bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hy" data-testid="authorName" href="https://medium.com/@joao.figueira?source=post_page---byline--dbdb0eb09b6b--------------------------------" rel="noopener follow">João Paulo Figueira</a></p></div></div></div><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hw hx dx"><button class="ib ic ah ai aj ak al am an ao ap aq ar id ie if" disabled="">Follow</button></p></div></div></span></div></div><div class="l ig"><span class="bf b bg z dx"><div class="ab cn ih ii ij"><div class="ik il ab"><div class="bf b bg z dx ab im"><span class="in l ig">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hy ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--dbdb0eb09b6b--------------------------------" rel="noopener follow"><p class="bf b bg z io ip iq ir is it iu iv bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">6 min read</span><div class="iw ix l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">May 19, 2024</span></div></span></div></span></div></div></div><div class="ab cp iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn"><div class="h k w ea eb q"><div class="kd l"><div class="ab q ke kf"><div class="pw-multi-vote-icon ed in kg kh ki"><div class=""><div class="kj kk kl km kn ko kp am kq kr ks ki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kt ku kv kw kx ky kz"><p class="bf b dy z dx"><span class="kk">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kj lc ld ab q ee le lf" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="lb"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg><p class="bf b dy z dx"><span class="pw-responses-count la lb">4</span></p></button></div></div></div><div class="ab q jo jp jq jr js jt ju jv jw jx jy jz ka kb kc"><div class="lg k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lh an ao ap id li lj lk" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep ll cn"><div class="l ae"><div class="ab cb"><div class="lm ln lo lp lq lr ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk ml"><img src="../Images/b583922b0a97dcbb9e258d7e6538ecf4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*eTvFplOsnQ8zqVYM"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Photo by <a class="af nc" href="https://unsplash.com/@diegogarcia?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Diego García</a> on <a class="af nc" href="https://unsplash.com/?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="65b9" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Sometimes, you must display vast amounts of data on an interactive map while keeping it usable and responsive. Interactive online maps are implemented in HTML, and adding many visual elements to the map display generally degrades performance and usability. A possible alternative is to draw all of the elements offline and display them over the map as a transparent layer using tiles. Each square tile neatly overlaps the map’s tiles, and the interactive map control handles far fewer visual elements.</p><p id="6e08" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">I addressed this issue a few years ago by writing a custom map tile generator using Python and data from the <a class="af nc" href="https://github.com/gsoh/VED" rel="noopener ugc nofollow" target="_blank">Vehicle Energy Dataset</a>. This project illustrated how to display massive amounts of information on an interactive online map by using custom tile layers over the map. The process involves using a web application that generates, caches and serves the tiles.</p><div class="nz oa ob oc od oe"><a rel="noopener follow" target="_blank" href="/displaying-geographic-information-using-custom-map-tiles-c0e3344909a4?source=post_page-----dbdb0eb09b6b--------------------------------"><div class="of ab ig"><div class="og ab co cb oh oi"><h2 class="bf fr hw z io oj iq ir ok it iv fp bk">Displaying Geographic Information Using Custom Map Tiles</h2><div class="ol l"><h3 class="bf b hw z io oj iq ir ok it iv dx">Learn how to create custom tiles for your interactive maps.</h3></div><div class="om l"><p class="bf b dy z io oj iq ir ok it iv dx">towardsdatascience.com</p></div></div><div class="on l"><div class="oo l op oq or on os lr oe"/></div></div></a></div><p id="fd26" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">As you know, Python is not fast, so there is a significant performance hit while the web application generates each tile. When a tile is cached, the serving process is quick and is not noticeable while interacting with the map.</p><p id="9e79" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Still, I was unhappy with the performance, so I wanted to solve the problem again by dramatically improving the code execution speed. At first, I thought about converting the code base to <a class="af nc" href="https://cython.org/" rel="noopener ugc nofollow" target="_blank">Cython</a>, but then my attention was diverted to another candidate.</p><h1 id="61ff" class="ot ou fq bf ov ow ox gq oy oz pa gt pb pc pd pe pf pg ph pi pj pk pl pm pn po bk">Enter Rust</h1><p id="7bc9" class="pw-post-body-paragraph nd ne fq nf b go pp nh ni gr pq nk nl nm pr no np nq ps ns nt nu pt nw nx ny fj bk">The Rust programming language has been on my radar for quite some time. With a background in C, C++ and C#, I was intrigued by the language’s promise of memory safety and C-like performance. I finally decided to have a go at it, and this problem looked like a perfect starting point to learn and exercise the language.</p><p id="9464" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">After reviewing many YouTube videos and diverse written material, I started using Rust to address this problem. I had three primary questions: How hard is it to create a web application, access <a class="af nc" href="https://www.sqlite.org/" rel="noopener ugc nofollow" target="_blank">SQLite</a> data, and programmatically create a transparent PNG image? Fortunately, the answers to these questions were more straightforward to respond to than anticipated.</p><h2 id="6ad8" class="pu ou fq bf ov pv pw px oy py pz qa pb nm qb qc qd nq qe qf qg nu qh qi qj qk bk">Rocket</h2><p id="1342" class="pw-post-body-paragraph nd ne fq nf b go pp nh ni gr pq nk nl nm pr no np nq ps ns nt nu pt nw nx ny fj bk">To answer the web application question, I turned to <a class="af nc" href="https://rocket.rs/" rel="noopener ugc nofollow" target="_blank">Rocket</a>. The <a class="af nc" href="https://rocket.rs/guide/v0.5/getting-started/#getting-started" rel="noopener ugc nofollow" target="_blank">Getting Started</a> page from Rocket’s online documentation shows how easy it is to set up a basic web application. We will surely need more complexity to build our tile server, but the boilerplate seems minimal and straightforward. And, as it turned out to be, Rocket is very easy to use and adapt. It’s a keeper to me.</p><h2 id="4333" class="pu ou fq bf ov pv pw px oy py pz qa pb nm qb qc qd nq qe qf qg nu qh qi qj qk bk">sqlx</h2><p id="6835" class="pw-post-body-paragraph nd ne fq nf b go pp nh ni gr pq nk nl nm pr no np nq ps ns nt nu pt nw nx ny fj bk">After a few minutes online, I quickly realized that the most popular answer to accessing SQLite databases was through the <a class="af nc" href="https://docs.rs/sqlx/latest/sqlx/" rel="noopener ugc nofollow" target="_blank">sqlx</a> package. It presents a different paradigm from the one I used in Python but much closer to the one I used in my former life when I developed in C#. Instead of generic data structures or <a class="af nc" href="https://pandas.pydata.org/" rel="noopener ugc nofollow" target="_blank">Pandas</a> <a class="af nc" href="https://pandas.pydata.org/docs/user_guide/dsintro.html#dataframe" rel="noopener ugc nofollow" target="_blank">DataFrames</a>, you must use strongly typed data structures here. Although they are a bit more laborious to work with, they will bring an extra layer of sanity to your life.</p><p id="688c" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk"><strong class="nf fr">Figure 1</strong> below shows the first complete code sample I used to retrieve the data from the level range table.</p><figure class="mm mn mo mp mq mr"><div class="ql io l ed"><div class="qm qn l"/></div><figcaption class="mx my mz mj mk na nb bf b bg z dx"><strong class="al">Figure 1 </strong>— Sample code to retrieve the table of level ranges. (Image source: Author)</figcaption></figure><h2 id="9c47" class="pu ou fq bf ov pv pw px oy py pz qa pb nm qb qc qd nq qe qf qg nu qh qi qj qk bk">PNG</h2><p id="12d7" class="pw-post-body-paragraph nd ne fq nf b go pp nh ni gr pq nk nl nm pr no np nq ps ns nt nu pt nw nx ny fj bk">Creating, drawing, and saving PNG files using the <a class="af nc" href="https://docs.rs/image/0.25.1/image/" rel="noopener ugc nofollow" target="_blank"><strong class="nf fr">image</strong></a> crate is easy. The code to create a transparent tile is quite simple:</p><figure class="mm mn mo mp mq mr"><div class="ql io l ed"><div class="qm qn l"/></div><figcaption class="mx my mz mj mk na nb bf b bg z dx"><strong class="al">Figure 2 </strong>— The <strong class="al">image</strong> crate simplifies the manipulation of images. The code above shows how to create a solid color 256x256 map tile. (Image source: Author)</figcaption></figure><p id="8196" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">I also used the <a class="af nc" href="https://docs.rs/colorgrad/0.6.2/colorgrad/" rel="noopener ugc nofollow" target="_blank"><strong class="nf fr">colorgrad</strong></a> package to handle the color gradient for the tiles.</p><p id="c83b" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Before I discuss the code in detail, let’s review the principle behind drawing the traffic density tiles.</p><h1 id="ea2d" class="ot ou fq bf ov ow ox gq oy oz pa gt pb pc pd pe pf pg ph pi pj pk pl pm pn po bk">It’s Tiles All The Way Down</h1><p id="e4b4" class="pw-post-body-paragraph nd ne fq nf b go pp nh ni gr pq nk nl nm pr no np nq ps ns nt nu pt nw nx ny fj bk">Map tiles usually consist of square 256x256 bitmaps. We may address each tile by combining <em class="qo">x</em> and <em class="qo">y</em> coordinates, a “zoom” level, or a <a class="af nc" href="https://learn.microsoft.com/en-us/bingmaps/articles/bing-maps-tile-system" rel="noopener ugc nofollow" target="_blank">quadkey</a> code. To each zoom level corresponds a square patchwork of tiles of different dimensions. The whole Earth is depicted on a single tile at the topmost level. By zooming in, the original tile is split up into four tiles. The following <strong class="nf fr">Figures 2</strong> and <strong class="nf fr">3</strong> illustrate the process of zooming in.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk qp"><img src="../Images/08cd217d49c1c13aa9be0d531111f7d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:512/format:webp/0*R8H3FLcxWW1pwVsm.png"/></div><figcaption class="mx my mz mj mk na nb bf b bg z dx"><strong class="bf ov">Figure 3</strong> — The whole world on a single tile at zoom level 0. (Image source: OpenStreetMap)</figcaption></figure><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk qq"><img src="../Images/1bce5b6812ce6acc77850baf5c6f4b5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1056/format:webp/1*_aFwcGlAZxyWbo0oGF7LYA.png"/></div><figcaption class="mx my mz mj mk na nb bf b bg z dx"><strong class="bf ov">Figure 4 </strong>— Zooming into the previous tile, we get four tiles with the same individual dimension. (Image source: OpenStreetMap)</figcaption></figure><p id="f474" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">If we keep zooming in, and after eight iterations, each resulting tile corresponds to a pixel on the first tile. This observation is the insight that allows us to compute and display the traffic density information on the tiles.</p><p id="8a90" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">As described in the <a class="af nc" rel="noopener" target="_blank" href="/displaying-geographic-information-using-custom-map-tiles-c0e3344909a4">previous article</a>, the tile information is prepared and stored in a database. Please refer to that article for instructions on generating the density database from the <a class="af nc" href="https://github.com/gsoh/VED" rel="noopener ugc nofollow" target="_blank">Vehicle Energy Dataset</a>.</p><h1 id="0c0d" class="ot ou fq bf ov ow ox gq oy oz pa gt pb pc pd pe pf pg ph pi pj pk pl pm pn po bk">Serving Tiles With Rust</h1><p id="d589" class="pw-post-body-paragraph nd ne fq nf b go pp nh ni gr pq nk nl nm pr no np nq ps ns nt nu pt nw nx ny fj bk">We can now discuss the Rust server code to generate, cache, and serve tiles. The present solution closely follows the previous tile server design. <strong class="nf fr">Figure 5</strong> below shows the main entry point that decides whether to provide a painted tile or the default transparent one after parsing and accepting the query parameters.</p><figure class="mm mn mo mp mq mr"><div class="ql io l ed"><div class="qm qn l"/></div><figcaption class="mx my mz mj mk na nb bf b bg z dx"><strong class="al">Figure 5</strong> — The main entry point. (Image source: Author)</figcaption></figure><p id="1a4c" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">As you can see, the server replies to zoom levels ranging from one to eighteen only. This limitation was baked into the data generation process for the density database.</p><p id="c21c" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">The web application draws each tile using the function listed in <strong class="nf fr">Figure 6</strong> below.</p><figure class="mm mn mo mp mq mr"><div class="ql io l ed"><div class="qm qn l"/></div><figcaption class="mx my mz mj mk na nb bf b bg z dx"><strong class="al">Figure 6 </strong>— The function above generates the tile, if not already cached on disk, and returns the tile file name. (Image source: Author)</figcaption></figure><p id="f7ef" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">As you can see from the listing above, the tile painting process has three steps. First, on line 12, we collect the tile’s per-pixel density information. Next, we retrieve the tile’s level range, i.e., the minimum and maximum density levels for the tile’s “zoom” level. Finally, on line 14, we paint the tile’s bitmap. The function finalizes by saving the tile bitmap to the file cache.</p><figure class="mm mn mo mp mq mr"><div class="ql io l ed"><div class="qm qn l"/></div><figcaption class="mx my mz mj mk na nb bf b bg z dx"><strong class="al">Figure 7</strong> — The function above paints a single tile on a bitmap. Note how the density information is transformed into an entry into the color gradient using a logarithmic-based transformation. (Image source: Author)</figcaption></figure><h1 id="b75f" class="ot ou fq bf ov ow ox gq oy oz pa gt pb pc pd pe pf pg ph pi pj pk pl pm pn po bk">Using the Code</h1><p id="a45d" class="pw-post-body-paragraph nd ne fq nf b go pp nh ni gr pq nk nl nm pr no np nq ps ns nt nu pt nw nx ny fj bk">After correctly configuring the database file path, you start the tile server by opening a terminal window, changing to the Rust project directory, and running the following command:</p><pre class="mm mn mo mp mq qr qs qt bp qu bb bk"><span id="eedc" class="qv ou fq qs b bg qw qx l qy qz">cargo run --release</span></pre><p id="314d" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Next, you can open the map client and configure the density tile layer URI. <strong class="nf fr">Figure 8</strong> below shows the Jupyter Notebook code cell to load the interactive map:</p><figure class="mm mn mo mp mq mr"><div class="ql io l ed"><div class="qm qn l"/></div><figcaption class="mx my mz mj mk na nb bf b bg z dx"><strong class="al">Figure 8</strong> — Use the code above to display the Ann Arbor map with the density tiles overlayed. (Image source: Author)</figcaption></figure><p id="fb8c" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">And that’s it! <strong class="nf fr">Figure 9</strong> below displays the result.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk ra"><img src="../Images/26c9beb6a497ae643455d5109f51168f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r2NguQI766NNqHMGvUoOAw.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx"><strong class="bf ov">Figure 9 </strong>— The image above displays the base map with the overlayed traffic density tiles. (Image source: OpenStreetMap and author-generated tiles)</figcaption></figure><h1 id="ef45" class="ot ou fq bf ov ow ox gq oy oz pa gt pb pc pd pe pf pg ph pi pj pk pl pm pn po bk">Conclusion</h1><p id="b1d9" class="pw-post-body-paragraph nd ne fq nf b go pp nh ni gr pq nk nl nm pr no np nq ps ns nt nu pt nw nx ny fj bk">My first foray into Rust was not nearly as difficult as I expected. I started by immersing myself in the available literature and YouTube videos before giving it a go. Next, I ensured I was using a helping hand with a great IDE from <a class="af nc" href="https://www.jetbrains.com/" rel="noopener ugc nofollow" target="_blank">JetBrains</a>: <a class="af nc" href="https://www.jetbrains.com/rust/" rel="noopener ugc nofollow" target="_blank">RustRover</a>. Although still in preview mode, I found this IDE helpful and instructive when using Rust. Still, you will also be perfectly fine if you prefer <a class="af nc" href="https://code.visualstudio.com/" rel="noopener ugc nofollow" target="_blank">Visual Studio Code</a>. Just make sure you get the sanctioned plugins.</p><h1 id="2795" class="ot ou fq bf ov ow ox gq oy oz pa gt pb pc pd pe pf pg ph pi pj pk pl pm pn po bk">Credits</h1><p id="f660" class="pw-post-body-paragraph nd ne fq nf b go pp nh ni gr pq nk nl nm pr no np nq ps ns nt nu pt nw nx ny fj bk">I used <a class="af nc" href="https://app.grammarly.com/" rel="noopener ugc nofollow" target="_blank">Grammarly</a> to review the writing and accepted several of its rewriting suggestions.</p><p id="323a" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk"><a class="af nc" href="https://www.jetbrains.com/ai/" rel="noopener ugc nofollow" target="_blank">JetBrains’ AI</a> assistant wrote some of the code, and I also used it to learn Rust. It has become a staple of my everyday work with both Rust and Python.</p><h1 id="4597" class="ot ou fq bf ov ow ox gq oy oz pa gt pb pc pd pe pf pg ph pi pj pk pl pm pn po bk">Licensing Information</h1><p id="c1d2" class="pw-post-body-paragraph nd ne fq nf b go pp nh ni gr pq nk nl nm pr no np nq ps ns nt nu pt nw nx ny fj bk">The Extended Vehicle Energy Dataset is licensed under Apache 2.0, like its originator, the <a class="af nc" href="https://github.com/gsoh/VED" rel="noopener ugc nofollow" target="_blank">Vehicle Energy Dataset</a>.</p><h1 id="2a43" class="ot ou fq bf ov ow ox gq oy oz pa gt pb pc pd pe pf pg ph pi pj pk pl pm pn po bk">References</h1><p id="334c" class="pw-post-body-paragraph nd ne fq nf b go pp nh ni gr pq nk nl nm pr no np nq ps ns nt nu pt nw nx ny fj bk"><a class="af nc" href="https://github.com/gsoh/VED" rel="noopener ugc nofollow" target="_blank">Vehicle Energy Dataset</a> (GitHub)</p><p id="9af3" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk"><a class="af nc" href="https://github.com/joaofig/tilers" rel="noopener ugc nofollow" target="_blank">GitHub repository</a></p></div></div></div><div class="ab cb rb rc rd re" role="separator"><span class="rf by bm rg rh ri"/><span class="rf by bm rg rh ri"/><span class="rf by bm rg rh"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="ecb8" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">João Paulo Figueira is a Data Scientist at <a class="af nc" href="https://tblx.io/" rel="noopener ugc nofollow" target="_blank">tb.lx by Daimler Truck</a> in Lisbon, Portugal.</p></div></div></div></div>    
</body>
</html>