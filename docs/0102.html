<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Unleashing the Power of SQL Analytical Window Functions: A Deep Dive into Fusing IPv4 Blocks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Unleashing the Power of SQL Analytical Window Functions: A Deep Dive into Fusing IPv4 Blocks</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/unleashing-the-power-of-sql-analytical-window-functions-a-deep-dive-into-fusing-ipv4-blocks-62bf2b3405e0?source=collection_archive---------15-----------------------#2024-01-10">https://towardsdatascience.com/unleashing-the-power-of-sql-analytical-window-functions-a-deep-dive-into-fusing-ipv4-blocks-62bf2b3405e0?source=collection_archive---------15-----------------------#2024-01-10</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="41bd" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx">How to summarize a geolocation table by merging contiguous network IPv4 blocks</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hd he hf hg hh ab"><div><div class="ab hi"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@jean-claude.cote?source=post_page---byline--62bf2b3405e0--------------------------------" rel="noopener follow"><div class="l hj hk by hl hm"><div class="l ed"><img alt="Jean-Claude Cote" class="l ep by dd de cx" src="../Images/aea2df9c7b95fc85cc336f64d64b0a76.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/1*ZDeTO2JYRo3sVd9Y_iIQ-w.jpeg"/><div class="hn by l dd de em n ho eo"/></div></div></a></div></div><div class="hp ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--62bf2b3405e0--------------------------------" rel="noopener follow"><div class="l hq hr by hl hs"><div class="l ed"><img alt="Towards Data Science" class="l ep by br ht cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hn by l br ht em n ho eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hu ab q"><div class="ab q hv"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hw hx bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hy" data-testid="authorName" href="https://medium.com/@jean-claude.cote?source=post_page---byline--62bf2b3405e0--------------------------------" rel="noopener follow">Jean-Claude Cote</a></p></div></div></div><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hw hx dx"><button class="ib ic ah ai aj ak al am an ao ap aq ar id ie if" disabled="">Follow</button></p></div></div></span></div></div><div class="l ig"><span class="bf b bg z dx"><div class="ab cn ih ii ij"><div class="ik il ab"><div class="bf b bg z dx ab im"><span class="in l ig">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hy ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--62bf2b3405e0--------------------------------" rel="noopener follow"><p class="bf b bg z io ip iq ir is it iu iv bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">8 min read</span><div class="iw ix l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Jan 10, 2024</span></div></span></div></span></div></div></div><div class="ab cp iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn"><div class="h k w ea eb q"><div class="kd l"><div class="ab q ke kf"><div class="pw-multi-vote-icon ed in kg kh ki"><div class=""><div class="kj kk kl km kn ko kp am kq kr ks ki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kt ku kv kw kx ky kz"><p class="bf b dy z dx"><span class="kk">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kj lc ld ab q ee le lf" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="lb"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg><p class="bf b dy z dx"><span class="pw-responses-count la lb">1</span></p></button></div></div></div><div class="ab q jo jp jq jr js jt ju jv jw jx jy jz ka kb kc"><div class="lg k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lh an ao ap id li lj lk" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep ll cn"><div class="l ae"><div class="ab cb"><div class="lm ln lo lp lq lr ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk ml"><img src="../Images/e46edade3e88927aa214a1e67a73ca08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4FJz1A-RRzFevw9dACPS0w.jpeg"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Photo by Pascal Bernardon on Unsplash</figcaption></figure><p id="c4cc" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Every device on the internet is uniquely addressable via an Internet Protocol (IP) address. The global IP address space is overseen by the Internet Assigned Numbers Authority (IANA). Traditionally, IANA allocates address space in /8 prefix blocks for IPv4, which are subsequently assigned to Internet Service Providers and other organizations. Various databases exist to map these IP blocks to their respective owners, along with information about the originating country and city.</p><p id="d05d" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">As the Canadian national CSIRT, we, the <a class="af ny" href="https://cyber.gc.ca/en" rel="noopener ugc nofollow" target="_blank">Canadian Centre for Cyber Security</a>, rely heavily on referencing these databases for looking up a given IP or enhancing entire datasets through SQL JOINs. However, not all use cases necessitate precision up to the city level; sometimes, country information alone suffices.</p><p id="819b" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Within a country, many network blocks are contiguous. Consolidating these into mega blocks can significantly reduce the size of a table mapping mega blocks to countries, leading to improved JOIN operations.</p><p id="4b03" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">In this article, we will demonstrate how to summarize a geolocation table by merging contiguous network blocks.</p><p id="84fa" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Let’s assume our geolocation table contains the following data:</p><pre class="mm mn mo mp mq nz oa ob bp oc bb bk"><span id="9da6" class="od oe fq oa b bg of og l oh oi">+----------+-------+---------+-----------+-----------+<br/>| start_ip | end_ip| country |   city    |   owner   |<br/>+----------+-------+---------+-----------+-----------+<br/>| 1        | 2     | ca      | Toronto   | Telus     |<br/>| 3        | 4     | ca      | Quebec    | Rogers    |<br/>| 5        | 8     | ca      | Vancouver | Bell      |<br/>| 10       | 14    | ca      | Montreal  | Telus     |<br/>| 19       | 22    | ca      | Ottawa    | Rogers    |<br/>| 23       | 29    | ca      | Calgary   | Videotron |<br/>+----------+-------+---------+-----------+-----------+</span></pre><p id="e9c2" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Here, <code class="cx oj ok ol oa b">start_ip</code> represents the lowest number in the network block, and <code class="cx oj ok ol oa b">end_ip</code> represents the largest. Normally, these numbers are much larger. For example, Google’s DNS server 8.8.8.8 is represented by the number 134744072. We use simple synthetic values for illustration purposes.</p><p id="0e0a" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">To start, let’s perform a simple summarization. For example, counting the number of IP addresses assigned to each country. This can be achieved by grouping the data by country and summing the number of IPs in each network block.</p><pre class="mm mn mo mp mq nz oa ob bp oc bb bk"><span id="cada" class="od oe fq oa b bg of og l oh oi">SELECT<br/>    country,<br/>    SUM(end_ip - start_ip + 1) as num_ip<br/>FROM<br/>    geo_table<br/>GROUP BY<br/>    country</span></pre><p id="8a05" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">This statement groups rows by country and applies a <code class="cx oj ok ol oa b">SUM</code> aggregation function, calculating the total number of IPs for each country. It’s important to note that the <code class="cx oj ok ol oa b">SUM</code> aggregation is associative, meaning the order in which you sum does not matter, similar to additions in mathematics.</p><pre class="mm mn mo mp mq nz oa ob bp oc bb bk"><span id="2967" class="od oe fq oa b bg of og l oh oi">+---------+--------+<br/>| country | num_ip |<br/>+---------+--------+<br/>| ca      | 24     |<br/>+---------+--------+</span></pre><p id="b28e" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Now, let’s delve into the complexities of aggregating contiguous network blocks. Referring to our original table, we need to fuse together the first 3 rows. Bocks 1–2, 3–4, 5–8 should result in the mega block 1–8. We also need to fuse the last 2 rows. Blocks 19–22 and 23–29 result into 19–29. Our goal is to produce the following table:</p><pre class="mm mn mo mp mq nz oa ob bp oc bb bk"><span id="6dfa" class="od oe fq oa b bg of og l oh oi">+----------+-------+---------+<br/>| start_ip | end_ip| country |<br/>+----------+-------+---------+<br/>| 1        | 8     | ca      |<br/>| 10       | 14    | ca      |<br/>| 19       | 29    | ca      |<br/>+----------+-------+---------+</span></pre><p id="a3fa" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Detecting contiguous blocks requires inter-row information, and the order of rows becomes crucial. Fortunately, windowed analytical functions provide a solution by offering a mechanism for inter-record referencing. These functions, such as <code class="cx oj ok ol oa b">LEAD </code>and <code class="cx oj ok ol oa b">LAG</code>, enable comparisons with the values of the previous and subsequent rows, facilitating the identification of contiguous IP blocks.</p><p id="579f" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Let’s apply the <code class="cx oj ok ol oa b">LEAD</code> and <code class="cx oj ok ol oa b">LAG</code> windowing functions to our table. Notice that within the <code class="cx oj ok ol oa b">OVER</code> clause we still specify that our data should be grouped by country <code class="cx oj ok ol oa b">PARTITION BY country</code> but additionally we specify the ordering of this data <code class="cx oj ok ol oa b">ORDER BY start_ip</code>.</p><pre class="mm mn mo mp mq nz oa ob bp oc bb bk"><span id="8e6d" class="od oe fq oa b bg of og l oh oi">SELECT<br/>    *,<br/>    LAG(end_ip) OVER (<br/>      PARTITION BY country <br/>      ORDER BY start_ip) AS prev_end_ip,<br/>    LEAD(start_ip) OVER (<br/>      PARTITION BY country <br/>      ORDER BY start_ip) AS next_start_ip<br/>FROM<br/>    geo_table</span></pre><p id="0ad0" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">The resulting table <code class="cx oj ok ol oa b">view_1</code> is as follows:</p><pre class="mm mn mo mp mq nz oa ob bp oc bb bk"><span id="32c0" class="od oe fq oa b bg of og l oh oi">+----------+-------+---------+-------------+---------------+<br/>| start_ip | end_ip| country | prev_end_ip | next_start_ip |<br/>+----------+-------+---------+-------------+---------------+<br/>| 1        | 2     | ca      | null        | 3             |<br/>| 3        | 4     | ca      | 2           | 5             |<br/>| 5        | 8     | ca      | 4           | 10            |<br/>| 10       | 14    | ca      | 8           | 19            |<br/>| 19       | 22    | ca      | 14          | 23            |<br/>| 23       | 29    | ca      | 22          | null          |<br/>+----------+-------+---------+-------------+---------------+</span></pre><p id="2ab2" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">It’s crucial to distinguish between windowing functions and simple <code class="cx oj ok ol oa b">GROUP BY</code> functions. In an <code class="cx oj ok ol oa b">OVER()</code> operation, the results of <code class="cx oj ok ol oa b">LEAD</code> and <code class="cx oj ok ol oa b">LAG</code> are appended to every row, providing context for the previous and next row’s information. This is distinct from functions in a <code class="cx oj ok ol oa b">GROUP BY</code> clause that reduce a group of rows into a single aggregation result.</p><p id="294d" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Now that we have access to the details of both the preceding and succeeding rows, we can facilitate inter-row comparisons. This comparison is crucial for identifying contiguous IP blocks, enabling us to determine when to fuse adjacent blocks together.</p><p id="f083" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Each row can fall into one of four states:<br/>1) Remove: The block is contiguous with both the previous and next blocks.<br/>2) Start: The block is contiguous with only the next block.<br/>3) End: The block is contiguous with only the previous block.<br/>4) Keep: The block is not contiguous with either the previous nor the next block.</p><p id="9841" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Let’s add this <code class="cx oj ok ol oa b">state</code> column to our table.</p><pre class="mm mn mo mp mq nz oa ob bp oc bb bk"><span id="bd13" class="od oe fq oa b bg of og l oh oi">SELECT<br/>    *,<br/>    CASE<br/>        WHEN (end_ip = next_start_ip - 1) <br/>           AND (start_ip = prev_end_ip + 1) THEN 'remove'<br/>        WHEN (end_ip = next_start_ip - 1) THEN 'start'<br/>        WHEN (start_ip = prev_end_ip + 1) THEN 'end'<br/>        ELSE 'keep'<br/>    END AS state<br/>FROM<br/>    view_1</span></pre><p id="7b95" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">We obtain the following <code class="cx oj ok ol oa b">view_2</code> result:</p><pre class="mm mn mo mp mq nz oa ob bp oc bb bk"><span id="20a1" class="od oe fq oa b bg of og l oh oi">+----------+-------+---------+-------------+---------------+-------+<br/>| start_ip | end_ip| country | prev_end_ip | next_start_ip | state |<br/>+----------+-------+---------+-------------+---------------+-------+<br/>| 1        | 2     | ca      | null        | 3             | start |<br/>| 3        | 4     | ca      | 2           | 5             | remove|<br/>| 5        | 8     | ca      | 4           | 10            | end   |<br/>| 10       | 14    | ca      | 8           | 19            | keep  |<br/>| 19       | 22    | ca      | 14          | 23            | start |<br/>| 23       | 29    | ca      | 22          | null          | end   |<br/>+----------+-------+---------+-------------+---------------+-------+</span></pre><p id="51b0" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">We can proceed to remove the rows falling between the start and end blocks, specifically those identified with state <code class="cx oj ok ol oa b">remove</code>.</p><pre class="mm mn mo mp mq nz oa ob bp oc bb bk"><span id="6027" class="od oe fq oa b bg of og l oh oi">SELECT<br/>    start_ip,<br/>    end_ip,<br/>    country,<br/>    state<br/>FROM<br/>    view_2<br/>WHERE<br/>    state IN ('start', 'end', 'keep')</span></pre><p id="ffd0" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Resulting in <code class="cx oj ok ol oa b">view_3</code>:</p><pre class="mm mn mo mp mq nz oa ob bp oc bb bk"><span id="b6ae" class="od oe fq oa b bg of og l oh oi">+----------+-------+---------+-------+<br/>| start_ip | end_ip| country | state |<br/>+----------+-------+---------+-------+<br/>| 1        | 2     | ca      | start |<br/>| 5        | 8     | ca      | end   |<br/>| 10       | 14    | ca      | keep  |<br/>| 19       | 22    | ca      | start |<br/>| 23       | 29    | ca      | end   |<br/>+----------+-------+---------+-------+</span></pre><p id="72a2" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">We are getting close to our goal! All we have to do now is merge the <code class="cx oj ok ol oa b">start</code> and <code class="cx oj ok ol oa b">end</code> rows, which contain the <code class="cx oj ok ol oa b">start_ip </code>and <code class="cx oj ok ol oa b">end_ip </code>of the mega blocks we are seeking to produce. To achieve this, we once again use a window function. This time to fetch the <code class="cx oj ok ol oa b">end_ip</code> from the <code class="cx oj ok ol oa b">end</code> row.</p><pre class="mm mn mo mp mq nz oa ob bp oc bb bk"><span id="093f" class="od oe fq oa b bg of og l oh oi">SELECT<br/>    *,<br/>    LEAD(end_ip) OVER (<br/>      PARTITION BY country <br/>      ORDER BY start_ip) AS next_end_ip<br/>FROM<br/>    view_3</span></pre><p id="d2fd" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Result in <code class="cx oj ok ol oa b">view_4</code>:</p><pre class="mm mn mo mp mq nz oa ob bp oc bb bk"><span id="afad" class="od oe fq oa b bg of og l oh oi">+----------+-------+---------+-------+-------------+<br/>| start_ip | end_ip| country | state | next_end_ip |<br/>+----------+-------+---------+-------+-------------+<br/>| 1        | 2     | ca      | start | 8           |<br/>| 5        | 8     | ca      | end   | 14          |<br/>| 10       | 14    | ca      | keep  | 22          |<br/>| 19       | 22    | ca      | start | 29          |<br/>| 23       | 29    | ca      | end   | null        |<br/>+----------+-------+---------+-------+-------------+</span></pre><p id="2769" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Notice that the rows with state <code class="cx oj ok ol oa b">start</code> now have a <code class="cx oj ok ol oa b">start_ip</code> and a <code class="cx oj ok ol oa b">next_end_ip</code>, the information necessary to build a mega block.</p><p id="8599" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">The rows with state <code class="cx oj ok ol oa b">end</code> are no longer needed and can be removed.</p><p id="a397" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">The rows with state <code class="cx oj ok ol oa b">keep</code> already have the correct <code class="cx oj ok ol oa b">end_ip</code>.</p><p id="3004" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">We can now determine the <code class="cx oj ok ol oa b">final_end</code> value of the mega blocks. Two cases are possible:<br/>1) for a <code class="cx oj ok ol oa b">start</code> row, we obtain the end value from the <code class="cx oj ok ol oa b">next_end_ip</code>. <br/>2) for a <code class="cx oj ok ol oa b">keep</code> row, we simply use the original <code class="cx oj ok ol oa b">end_ip</code> value.</p><pre class="mm mn mo mp mq nz oa ob bp oc bb bk"><span id="f69b" class="od oe fq oa b bg of og l oh oi">SELECT<br/>    start_ip AS final_start,<br/>    CASE<br/>        WHEN (state = 'start') THEN next_end_ip<br/>        WHEN (state = 'keep') THEN end_ip<br/>        ELSE NULL<br/>    END AS final_end_ip<br/>FROM<br/>    view_4<br/>WHERE<br/>    state IN ('start', 'keep')</span></pre><p id="c345" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">We thus achieve our goal of fusing contiguous IPv4 blocks into mega blocks.</p><pre class="mm mn mo mp mq nz oa ob bp oc bb bk"><span id="9cee" class="od oe fq oa b bg of og l oh oi">+----------+-------+---------+-------+-------------+------------+----------+<br/>| start_ip | end_ip| country | state | next_end_ip | final_start| final_end|<br/>+----------+-------+---------+-------+-------------+------------+----------+<br/>| 1        | 2     | ca      | start | 8           | 1          | 8        |<br/>| 10       | 14    | ca      | keep  | 22          | 10         | 14       |<br/>| 19       | 22    | ca      | start | 29          | 19         | 29       |<br/>+----------+-------+---------+-------+-------------+------------+----------+</span></pre><p id="17ce" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Putting all the statements above together, we obtain a final statement:</p><pre class="mm mn mo mp mq nz oa ob bp oc bb bk"><span id="8055" class="od oe fq oa b bg of og l oh oi">SELECT<br/>    country,<br/>    final_start,<br/>    IF(state = 'start', next_end_ip, final_end) AS final_end<br/>FROM (<br/>    SELECT<br/>        country,<br/>        start_ip AS final_start,<br/>        end_ip AS final_end,<br/>        LEAD(end_ip) OVER (<br/>          PARTITION BY country <br/>          ORDER BY start_ip) AS next_end_ip<br/>    FROM (<br/>        SELECT<br/>            start_ip,<br/>            end_ip,<br/>            country,<br/>            CASE<br/>                WHEN (end_ip = next_start_ip - 1) <br/>                  AND (start_ip = prev_end_ip + 1) THEN 'remove'<br/>                WHEN (end_ip = next_start_ip - 1) THEN 'start'<br/>                WHEN (start_ip = prev_end_ip + 1) THEN 'end'<br/>                ELSE 'keep'<br/>            END AS state<br/>        FROM (<br/>            SELECT<br/>                *,<br/>                LAG(end_ip) OVER (<br/>                    PARTITION BY country <br/>                    ORDER BY start_ip) AS prev_end_ip,<br/>                LEAD(start_ip) OVER (<br/>                    PARTITION BY country <br/>                    ORDER BY start_ip) AS next_start_ip<br/>            FROM <br/>                geo_table<br/>        )<br/>        WHERE <br/>            state IN ('start', 'end', 'keep')<br/>    )<br/>)<br/>WHERE <br/>    state IN ('start', 'keep')</span></pre><p id="2029" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">In conclusion, SQL analytical window functions offer a robust framework for complex data analysis. They empower users to perform aggregations while retaining the context of individual rows, facilitating tasks such as running totals, averages, and percentile calculations. Moreover, these functions play a crucial role in ranking, time-series analysis, and detecting anomalies and outliers within datasets. These functions are indispensable assets in the toolkit of data practitioners.</p><p id="42ad" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Analytical window functions are very powerful. In this article, we only scratched the surface; for example, we did not make use of a <code class="cx oj ok ol oa b">window_frame</code>. A window frame allows you to further refine which rows are considered in the aggregation. Window frames are relative to the current row and can be based on the number of rows or time intervals, making these functions indispensable for a wide range of analyses. You can learn more about these features in the Spark documentation: <a class="af ny" href="https://spark.apache.org/docs/latest/sql-ref-syntax-qry-select-window.html" rel="noopener ugc nofollow" target="_blank">Spark SQL — Window Operations</a> .</p></div></div></div></div>    
</body>
</html>