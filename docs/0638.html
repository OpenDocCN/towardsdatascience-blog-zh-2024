<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>A Priority Based Scheduler for Amazon SageMaker Training Jobs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>A Priority Based Scheduler for Amazon SageMaker Training Jobs</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/a-priority-based-scheduler-for-amazon-sagemaker-training-jobs-a225327e0a94?source=collection_archive---------10-----------------------#2024-03-08">https://towardsdatascience.com/a-priority-based-scheduler-for-amazon-sagemaker-training-jobs-a225327e0a94?source=collection_archive---------10-----------------------#2024-03-08</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="5764" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx">Optimizing the use of limited AI training accelerators — Part 2</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hd he hf hg hh ab"><div><div class="ab hi"><div><div class="bm" aria-hidden="false"><a href="https://chaimrand.medium.com/?source=post_page---byline--a225327e0a94--------------------------------" rel="noopener follow"><div class="l hj hk by hl hm"><div class="l ed"><img alt="Chaim Rand" class="l ep by dd de cx" src="../Images/c52659c389f167ad5d6dc139940e7955.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/1*u4pzP95sl2wOlLhWKFgczg.jpeg"/><div class="hn by l dd de em n ho eo"/></div></div></a></div></div><div class="hp ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--a225327e0a94--------------------------------" rel="noopener follow"><div class="l hq hr by hl hs"><div class="l ed"><img alt="Towards Data Science" class="l ep by br ht cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hn by l br ht em n ho eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hu ab q"><div class="ab q hv"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hw hx bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hy" data-testid="authorName" href="https://chaimrand.medium.com/?source=post_page---byline--a225327e0a94--------------------------------" rel="noopener follow">Chaim Rand</a></p></div></div></div><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hw hx dx"><button class="ib ic ah ai aj ak al am an ao ap aq ar id ie if" disabled="">Follow</button></p></div></div></span></div></div><div class="l ig"><span class="bf b bg z dx"><div class="ab cn ih ii ij"><div class="ik il ab"><div class="bf b bg z dx ab im"><span class="in l ig">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hy ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--a225327e0a94--------------------------------" rel="noopener follow"><p class="bf b bg z io ip iq ir is it iu iv bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">12 min read</span><div class="iw ix l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Mar 8, 2024</span></div></span></div></span></div></div></div><div class="ab cp iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn"><div class="h k w ea eb q"><div class="kd l"><div class="ab q ke kf"><div class="pw-multi-vote-icon ed in kg kh ki"><div class=""><div class="kj kk kl km kn ko kp am kq kr ks ki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kt ku kv kw kx ky kz"><p class="bf b dy z dx"><span class="kk">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kj la lb ab q ee lc ld" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="le"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg></button></div></div></div><div class="ab q jo jp jq jr js jt ju jv jw jx jy jz ka kb kc"><div class="lf k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lg an ao ap id lh li lj" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep lk cn"><div class="l ae"><div class="ab cb"><div class="ll lm ln lo lp lq ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lg an ao ap id lr ls ld lt lu lv lw lx s ly lz ma mb mc md me u mf mg mh"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lg an ao ap id lr ls ld lt lu lv lw lx s ly lz ma mb mc md me u mf mg mh"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lg an ao ap id lr ls ld lt lu lv lw lx s ly lz ma mb mc md me u mf mg mh"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj mk"><img src="../Images/d4dd51c7492c9ad3b406d2ca1d86b429.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*PV9sbX7QZa1mVHfI"/></div></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">Photo by <a class="af nb" href="https://unsplash.com/@ahda_gallery?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Adrien Aletti</a> on <a class="af nb" href="https://unsplash.com/?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="c473" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">This post was created in collaboration with <a class="af nb" href="https://www.linkedin.com/in/maxrabin/" rel="noopener ugc nofollow" target="_blank">Max Rabin</a>.</p><p id="964b" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">This is the second part of a series of posts on the topic of maximizing the utility of scarce AI resources. In the <a class="af nb" rel="noopener" target="_blank" href="/maximizing-the-utility-of-scarce-ai-resources-a-kubernetes-approach-0230ba53965b">first post</a> we noted the increasing limitations on the ability to scale up AI resources at will and, as a consequence, the growing trend of AI development teams to guarantee AI compute capacity by means such as building up an in-house AI server farm and/or reserving dedicated instances in the cloud. The scarcity of AI compute resources motivates the design of specialized scheduling solutions to minimize idle time and prioritize critical workloads. Please see our <a class="af nb" rel="noopener" target="_blank" href="/maximizing-the-utility-of-scarce-ai-resources-a-kubernetes-approach-0230ba53965b">previous post</a> in which we proposed a detailed list of requirements for such solutions. The approach we took there was to leverage the existing priority-based <a class="af nb" href="https://kubernetes.io/docs/concepts/scheduling-eviction/kube-scheduler/" rel="noopener ugc nofollow" target="_blank">scheduler</a> that comes with <a class="af nb" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank">Kubernetes</a> and align our training development workflow to its use. In this post we explore the option of maintaining our existing framework for training AI models and enhancing it with our own custom implementation of a priority-based scheduler. Importantly, the need for this type of solution is often motivated not just by the scarcity of AI resources, but also by the desire to increase control over the orchestration and prioritization of training workloads so as to reduce development costs. For example, even in a scenario of abundant capacity, you may choose to limit your use to a fixed number of training instances so as to cap your training expenditure.</p><p id="3d32" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">For the purposes of this post, we will assume that our training framework of choice is AWS’s managed service for AI model training, <a class="af nb" href="https://aws.amazon.com/sagemaker/" rel="noopener ugc nofollow" target="_blank">Amazon SageMaker</a>. The solution we will propose will use additional AWS services such as <a class="af nb" href="https://aws.amazon.com/pm/dynamodb/" rel="noopener ugc nofollow" target="_blank">Amazon DynamoDB</a> and <a class="af nb" href="https://aws.amazon.com/pm/lambda/" rel="noopener ugc nofollow" target="_blank">AWS Lambda</a>. The choice to demonstrate our solution using AWS services should not be viewed as endorsement. There are many cloud-based service offerings available and the best one for you will depend on the particular details of your project. Similar solutions to the one that we will describe can be designed on other cloud-based environments and/or using alternative cloud-based services.</p><h1 id="bd36" class="ny nz fq bf oa ob oc gq od oe of gt og oh oi oj ok ol om on oo op oq or os ot bk">The Traditional Method for Starting Up SageMaker Training Jobs</h1><p id="fbb4" class="pw-post-body-paragraph nc nd fq ne b go ou ng nh gr ov nj nk nl ow nn no np ox nr ns nt oy nv nw nx fj bk">Traditionally, we would start up a SageMaker training job using the <a class="af nb" href="https://sagemaker.readthedocs.io/en/stable/" rel="noopener ugc nofollow" target="_blank">Amazon SageMaker Python SDK</a>. In the code block below we use the SageMaker SDK (version 2.208) to run a PyTorch training workload on a single instance of type <a class="af nb" href="https://aws.amazon.com/ec2/instance-types/p5/" rel="noopener ugc nofollow" target="_blank">p5.48xlarge</a>.</p><pre class="ml mm mn mo mp oz pa pb bp pc bb bk"><span id="860d" class="pd nz fq pa b bg pe pf l pg ph">from sagemaker.pytorch import PyTorch<br/><br/># define job<br/>estimator = PyTorch(<br/>    role='&lt;sagemaker role&gt;',<br/>    entry_point='train.py',<br/>    instance_type='ml.p5.48xlarge',<br/>    instance_count=1,<br/>    framework_version='2.0.1',<br/>    py_version='py310',<br/>    tags=[{'Key': 'priority', 'Value': '100'}<br/>)<br/><br/># start job<br/>estimator.fit()</span></pre><p id="8845" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">When the <em class="pi">estimator.fit()</em> function is called, the SageMaker library uploads our code to Amazon S3 and then transforms the request to a boto3 SageMaker client <a class="af nb" href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/sagemaker/client/create_training_job.html" rel="noopener ugc nofollow" target="_blank">create_training_job</a> request (see <a class="af nb" href="https://github.com/aws/sagemaker-python-sdk/blob/v2.208.0/src/sagemaker/session.py#L976" rel="noopener ugc nofollow" target="_blank">here</a>).</p><p id="ec2f" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">This method for starting up training jobs is dependent on the availability of the requested resources for its success. In our scenario of scarce AI resources, it is likely to fail more often than not. Although this can be partially mitigated by <a class="af nb" href="https://medium.com/@chaimrand/retaining-amazon-sagemaker-instance-capacity-with-sagemaker-managed-warm-pools-f7cfd78fa34c" rel="noopener">retaining provisioned compute instances for successive workloads</a>, the API does <em class="pi">not </em>provide the appropriate tooling for maximizing their utility. Let’s suppose that we wish to utilize precisely two <a class="af nb" href="https://aws.amazon.com/ec2/instance-types/p5/" rel="noopener ugc nofollow" target="_blank">p5.48xlarge</a> instances. To simplify our discussion, let’s assume that each training workload runs on a single instance. Typically, during an AI model development cycle there will be periods when there are more than two training workloads that are waiting to be processed. The existing API would try to start up a third <a class="af nb" href="https://aws.amazon.com/ec2/instance-types/p5/" rel="noopener ugc nofollow" target="_blank">p5.48xlarge</a> instance and would most likely fail due to its limited availability. Even when there is instance availability, we may wish to limit our training to just our two designated instances to increase our control over the costs of training.</p><p id="edcf" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">We require a new API for submitting jobs for training, one that does not immediately start up a new <a class="af nb" href="https://aws.amazon.com/ec2/instance-types/p5/" rel="noopener ugc nofollow" target="_blank">p5.48xlarge</a> instance, but rather enters the jobs to a priority queue. And we need an associated job scheduler that manages the use of our two resources while prioritizing critical workloads.</p><p id="fcd1" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Importantly, please note that as of the time of this writing, Amazon SageMaker does <em class="pi">not </em>support the option of training on <a class="af nb" href="https://aws.amazon.com/ec2/pricing/reserved-instances/" rel="noopener ugc nofollow" target="_blank">reserved Amazon EC2 instances</a>. And although <a class="af nb" href="https://aws.amazon.com/savingsplans/ml-pricing/" rel="noopener ugc nofollow" target="_blank">Amazon SageMaker Savings Plans</a> has similar properties to instance reservations, it does <em class="pi">not </em>guarantee instance capacity. In a <a class="af nb" href="https://chaimrand.medium.com/f7cfd78fa34c" rel="noopener">previous post</a> we addressed this limitation and proposed using <a class="af nb" href="https://docs.aws.amazon.com/sagemaker/latest/dg/train-warm-pools.html" rel="noopener ugc nofollow" target="_blank">SageMaker managed warm pools</a> as an alternative method for retaining access to provisioned instances. For the remainder of the post, we will assume that we are able to attain two instances of our choice whether it be through this or some other method.</p><h1 id="bc59" class="ny nz fq bf oa ob oc gq od oe of gt og oh oi oj ok ol om on oo op oq or os ot bk">Priority-Based Scheduling for Amazon SageMaker</h1><p id="9dcb" class="pw-post-body-paragraph nc nd fq ne b go ou ng nh gr ov nj nk nl ow nn no np ox nr ns nt oy nv nw nx fj bk">In this section we will describe the components of our proposed solution. We will use the <a class="af nb" href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-specification.html" rel="noopener ugc nofollow" target="_blank">AWS Serverless Application Model (SAM) specification</a>. More specifically, we will create an <a class="af nb" href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-specification-template-anatomy.html" rel="noopener ugc nofollow" target="_blank">AWS SAM template YAML file</a> and gradually add the AWS resources that we need. Please see the <a class="af nb" href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/what-is-sam.html" rel="noopener ugc nofollow" target="_blank">documentation</a> for details on how to define and deploy serverless solutions using AWS SAM.</p><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div class="mi mj pj"><img src="../Images/25932c7e09d19a30ed4bb4cffb192a95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1120/format:webp/1*uBhGUEeJH9nUcMjLCup-6g.png"/></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">AWS Architecture Diagram (by Author)</figcaption></figure><h1 id="6fb5" class="ny nz fq bf oa ob oc gq od oe of gt og oh oi oj ok ol om on oo op oq or os ot bk">A Private API for Submitting Training Jobs</h1><p id="1a19" class="pw-post-body-paragraph nc nd fq ne b go ou ng nh gr ov nj nk nl ow nn no np ox nr ns nt oy nv nw nx fj bk">We start by using <a class="af nb" href="https://aws.amazon.com/api-gateway/" rel="noopener ugc nofollow" target="_blank">Amazon API Gateway</a> to define a <a class="af nb" href="https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-private-apis.html" rel="noopener ugc nofollow" target="_blank">private REST API</a> for submitting training job requests. We name the API <em class="pi">training-job-queue</em>. Later, we will add a POST method called <em class="pi">add-job</em> and modify our training-job creation code to use this method instead of the SageMaker client <a class="af nb" href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/sagemaker/client/create_training_job.html" rel="noopener ugc nofollow" target="_blank">create_training_job</a> API. The code block below contains the definition of the private <a class="af nb" href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-resource-api.html" rel="noopener ugc nofollow" target="_blank">API resource</a> in SAM. In practice you will likely want to specify access limitations to the API and/or a method of authorization.</p><pre class="ml mm mn mo mp oz pa pb bp pc bb bk"><span id="9927" class="pd nz fq pa b bg pe pf l pg ph">AWSTemplateFormatVersion: '2010-09-09'<br/>Transform: AWS::Serverless-2016-10-31<br/><br/>Resources:<br/>  InternalAPI:<br/>    Type: AWS::Serverless::Api<br/>      # Auth: # Add access control to API<br/>      EndpointConfiguration:<br/>        Type: PRIVATE<br/>        # VPCEndpointIds: # Specify VPC Endpoint(s)<br/>      Name: training-job-queue<br/>      StageName: prod</span></pre><h2 id="86af" class="pk nz fq bf oa pl pm pn od po pp pq og nl pr ps pt np pu pv pw nt px py pz qa bk">Define an AWS DynamoDB Table for Storing Training Job Requests</h2><p id="830b" class="pw-post-body-paragraph nc nd fq ne b go ou ng nh gr ov nj nk nl ow nn no np ox nr ns nt oy nv nw nx fj bk">We will use an <a class="af nb" href="https://aws.amazon.com/pm/dynamodb/" rel="noopener ugc nofollow" target="_blank">Amazon DynamoDB</a> table named <em class="pi">sagemaker-queue</em> to store the submitted training workloads. Each entry will have the following fields:</p><ol class=""><li id="6cb0" class="nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx qb qc qd bk">jobName: Stores the unique name of the training job.</li><li id="add9" class="nc nd fq ne b go qe ng nh gr qf nj nk nl qg nn no np qh nr ns nt qi nv nw nx qb qc qd bk">entryTime: Stores the date and time that the job was added.</li><li id="9db7" class="nc nd fq ne b go qe ng nh gr qf nj nk nl qg nn no np qh nr ns nt qi nv nw nx qb qc qd bk">jobState: Stores the current state of the training job. The valid values are ‘pending’, ‘running’, and ‘preempted’.</li><li id="9e1e" class="nc nd fq ne b go qe ng nh gr qf nj nk nl qg nn no np qh nr ns nt qi nv nw nx qb qc qd bk">priority: Stores an integer value representing the relative priority of the job.</li><li id="030e" class="nc nd fq ne b go qe ng nh gr qf nj nk nl qg nn no np qh nr ns nt qi nv nw nx qb qc qd bk">jobDetails: Stores the details of the job request.</li></ol><p id="06e2" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">We define our DynamoDB table in our SAM template YAML file using the <a class="af nb" href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-resource-simpletable.html" rel="noopener ugc nofollow" target="_blank">AWS::Serverless::SimpleTable</a> resource.</p><pre class="ml mm mn mo mp oz pa pb bp pc bb bk"><span id="de00" class="pd nz fq pa b bg pe pf l pg ph">  DynamoSMQueue:<br/>    Type: AWS::Serverless::SimpleTable<br/>    Properties:<br/>      PrimaryKey:<br/>        Name: jobName<br/>        Type: String<br/>      TableName: sagemaker-queue</span></pre><p id="e8c8" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">We define a function that creates a table entry from a given training job request. We assume that request contains the same contents as the input to the <a class="af nb" href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/sagemaker/client/create_training_job.html" rel="noopener ugc nofollow" target="_blank">create_training_job</a> API in JSON format. We further assume that the <em class="pi">priority</em> of the workload is entered as a key-value <a class="af nb" href="https://docs.aws.amazon.com/sagemaker/latest/APIReference/API_Tag.html" rel="noopener ugc nofollow" target="_blank">tag</a> in the training job definition.</p><pre class="ml mm mn mo mp oz pa pb bp pc bb bk"><span id="2fa6" class="pd nz fq pa b bg pe pf l pg ph">import json, boto3, datetime<br/><br/>dynamodb = boto3.resource('dynamodb')<br/>table = dynamodb.Table('sagemaker-queue')<br/><br/>def add_job_entry(job_json):<br/>    job_details = json.loads(job_json)<br/><br/>    # extract job_name<br/>    job_name = job_details['TrainingJobName']<br/>    print(f'add entry {job_name}')<br/><br/>    # get current time<br/>    entry_time = datetime.now().strftime("%Y-%m-%dT%H:%M:%S")<br/><br/>    # default priority is 0<br/>    priority = 0<br/><br/>    # update priority based on tags<br/>    tags = job_details['Tags']<br/>    for tag in tags:<br/>        if tag['Key'] == 'priority':<br/>            priority = int(tag['Value'])<br/>            break<br/><br/>    # create entry<br/>    entry = {<br/>       'jobName': job_name,<br/>       'entryTime': entry_time,<br/>       'jobState': 'pending',<br/>       'priority': priority,<br/>       'jobDetails': job_json<br/>    }<br/>    table.put_item(Item=entry) #TODO handle errors<br/>    print(f'Added job {job_name} to queue')</span></pre><p id="9c64" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">The REST API <em class="pi">add-job </em>method that we will soon define will be programmed to call the <em class="pi">add_job_entry </em>function.</p><p id="9a27" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">We define a second function that extracts the pending jobs from the database and returns them in order of priority. In the case that multiple jobs have the same priority, they are ordered according to the amount of time they have been waiting in the queue.</p><pre class="ml mm mn mo mp oz pa pb bp pc bb bk"><span id="fe68" class="pd nz fq pa b bg pe pf l pg ph">from boto3.dynamodb.conditions import Attr<br/><br/># Get a list of all pending jobs sorted by priority<br/>def get_pending_jobs():<br/>    response = table.scan(<br/>        ProjectionExpression='jobName, priority, entryTime',<br/>        FilterExpression=Attr('jobState').ne('running')<br/>    )<br/>    jobs = response.get('Items', [])<br/><br/>    # sort jobs, first by priority (descending) and then by entryTime<br/>    sorted_jobs = sorted(jobs,<br/>                         key=lambda x: (-x['priority'], x['entryTime']))<br/><br/>    return sorted_jobs</span></pre><p id="2815" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">The following utility functions will come in handy in the next sections.</p><pre class="ml mm mn mo mp oz pa pb bp pc bb bk"><span id="fa2b" class="pd nz fq pa b bg pe pf l pg ph"># Get a jobName -&gt; priority mapping of all running jobs<br/>def get_running_jobs_dict():<br/>    # Get all running jobs<br/>    response = table.scan(<br/>        ProjectionExpression="jobName, priority",<br/>        FilterExpression=Attr('jobState').eq('running')<br/>    )<br/>    jobs = response.get('Items', [])<br/><br/>    running_jobs = {job['jobName']: job['priority'] for job in jobs}<br/><br/>    return running_jobs<br/><br/># Print the queue state<br/>def print_queue_state():<br/>    response = table.scan(<br/>        ProjectionExpression='jobName, jobState, priority'<br/>    )<br/>    jobs = response.get('Items', [])<br/><br/>    print_table = []<br/>    for job in jobs:<br/>        print_table.append([job['jobName'], job['jobState'], job['priority']])<br/><br/>    # sort by priority<br/>    sorted_table = sorted(print_table,<br/>                         key=lambda x: -x[2])<br/>    # Print the table<br/>    from tabulate import tabulate<br/>    print(tabulate(sorted_table, headers=['Job Name', 'State', 'Priority']))<br/><br/># get job details<br/>def get_job_details(job_name):<br/>    response = table.get_item(<br/>        Key={'jobName': job_name},<br/>        ProjectionExpression='jobDetails'<br/>    )<br/>    return json.loads(response.get('Item').get('jobDetails'))<br/><br/># get job state or None if the job does not exist<br/>def get_job_state(job_name):<br/>    response = table.get_item(<br/>        Key={'jobName': job_name},<br/>        ProjectionExpression='jobState'<br/>    )<br/>    job = response.get('Item')<br/>    return job.get('jobState') if job else None<br/><br/># update the job state<br/>def update_job_state(job_name, new_state):<br/>    table.update_item(<br/>        Key={'jobName': job_name},<br/>        UpdateExpression="SET jobState = :new_state",<br/>        ExpressionAttributeValues={":new_state": new_state}<br/>    )<br/>    print(f'Update job {job_name} to {new_state}')<br/><br/># remove a job entry<br/>def remove_job(job_name):<br/>    table.delete_item(<br/>        Key={'jobName': job_name}<br/>    )<br/>    print(f'Removed job {job_name} from queue')</span></pre><p id="c3ed" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Both our choice of DynamoDB and its usage (e.g., our use of the <a class="af nb" href="https://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API_Scan.html" rel="noopener ugc nofollow" target="_blank">Scan</a> API rather than the <a class="af nb" href="https://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API_Query.html" rel="noopener ugc nofollow" target="_blank">Query</a> API) assume that the overall number of jobs in our queue will be in the dozens, at most. For a larger scale solution, you may be better off with a heavier duty database (e.g., one that performs the sorting operation for you) or a more sophisticated use of DynamoDB (e.g., see <a class="af nb" href="https://aws.amazon.com/blogs/database/implementing-priority-queueing-with-amazon-dynamodb/" rel="noopener ugc nofollow" target="_blank">here</a>).</p><h2 id="3902" class="pk nz fq bf oa pl pm pn od po pp pq og nl pr ps pt np pu pv pw nt px py pz qa bk">Define the Training Job Queue Manager</h2><p id="9678" class="pw-post-body-paragraph nc nd fq ne b go ou ng nh gr ov nj nk nl ow nn no np ox nr ns nt oy nv nw nx fj bk">The main component of our solution is the training job scheduler. Here we implement a rather simple manager that performs the following steps:</p><ol class=""><li id="2cc4" class="nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx qb qc qd bk">Extract the list of queued jobs, ordered by priority. If none exist, return.</li><li id="ac4e" class="nc nd fq ne b go qe ng nh gr qf nj nk nl qg nn no np qh nr ns nt qi nv nw nx qb qc qd bk">Discover unused instance capacity. For each free instance, start one pending job on SageMaker. If no jobs remain after that, return.</li><li id="ba61" class="nc nd fq ne b go qe ng nh gr qf nj nk nl qg nn no np qh nr ns nt qi nv nw nx qb qc qd bk">Calculate the number of SageMaker jobs in the <em class="pi">Stopping </em>state. If greater than the number of pending jobs, return.</li><li id="3710" class="nc nd fq ne b go qe ng nh gr qf nj nk nl qg nn no np qh nr ns nt qi nv nw nx qb qc qd bk">Assess the need for preemption of running SageMaker jobs by comparing their <em class="pi">priorities </em>to those of our pending jobs.</li></ol><pre class="ml mm mn mo mp oz pa pb bp pc bb bk"><span id="646c" class="pd nz fq pa b bg pe pf l pg ph"># set the limit on total number of instances/jobs<br/>MAX_CAPACITY = 2<br/><br/>sagemaker = boto3.client('sagemaker')<br/><br/># apply a queue stamp to identify that the job came from the queue<br/>def apply_qstamp(job_name):<br/>    return f'{job_name}-qstamp-{datetime.now().strftime("%d%H%M")}'<br/><br/># strip the queue stamp<br/>def strip_qstamp(job_name):<br/>    return job_name.split('-qstamp-')[0]<br/><br/># start a SageMaker job and update job entry in queue<br/>def start_job(job_name):<br/>    print(f'start job {job_name}')<br/>    job_details = get_job_details(job_name)<br/>    job_details['TrainingJobName'] = apply_qstamp(job_name)<br/>    if(job_details):<br/>        # start job with detail from queue<br/>        # (you may optinally overwrite fields such as the iam role)<br/>        response = sagemaker.create_training_job(**job_details)<br/>        if response['ResponseMetadata']['HTTPStatusCode'] == 200:<br/>            print(f'started job {job_name}')<br/>            update_job_state(job_name, 'running')<br/><br/># preempt a SageMaker job and update job entry in queue<br/>def preempt_job(job_name):<br/>    print(f'preempt job {job_name}')<br/>    response = sagemaker.stop_training_job(TrainingJobName=job_name)<br/>    if response['ResponseMetadata']['HTTPStatusCode'] == 200:<br/>        print(f'preempted job {job_name}')<br/>        update_job_state(strip_qstamp(job_name), 'preempted')<br/><br/># get SageMaker jobs<br/>def get_sagemaker_jobs(status):<br/>    running = sagemaker.list_training_jobs(StatusEquals=status)<br/>    return running.get('TrainingJobSummaries', [])<br/><br/># queue manager<br/>def manage_queue():<br/>    # extract pending jobs to run<br/>    pending = get_pending_jobs()<br/><br/>    if not pending:<br/>        return<br/><br/>    if len(pending) &gt; MAX_CAPACITY:<br/>        pending = pending[:MAX_CAPACITY]<br/><br/>    # get running sagemaker jobs<br/>    running = get_sagemaker_jobs('InProgress')<br/>    total_running = len(running)<br/><br/>    # get stopping sagemaker jobs<br/>    stopping = get_sagemaker_jobs('Stopping')<br/>    total_stopping = len(stopping)<br/><br/>    # calculate the number of free instances    <br/>    free_slots = MAX_CAPACITY - total_running - total_stopping<br/><br/>    jobs_to_start = min(len(pending), free_slots)<br/><br/>    # for each free instance, start a job<br/>    for i in range(jobs_to_start):<br/>        start_job(pending[i].get('jobName'))<br/><br/>    still_pending = pending[jobs_to_start:]<br/><br/>    if not still_pending:<br/>        return<br/>    <br/>    # assume that 'total_stopping' number of jobs will start soon<br/>    test_for_preemption = len(still_pending) - total_stopping<br/>    if test_for_preemption &lt;= 0:<br/>        return<br/><br/>    # check if preemption is required<br/>    test_priority = still_pending[total_stopping:]<br/><br/>    running_jobs = get_running_jobs_dict()<br/>    priority_dict = {}<br/>    for job in running:<br/>        job_name = job['TrainingJobName']<br/>        priority_dict[job_name] = running_jobs[strip_qstamp(job_name)]<br/>        <br/>    # sort running jobs from lowest to highest priority<br/>    sorted_running = sorted(priority_dict.items(), key=lambda item: item[1])<br/><br/>    index = 0<br/>    while index &lt; test_for_preemption and \<br/>          test_priority[index].get('priority') &gt; sorted_running[index][1]:<br/>        preempt_job(sorted_running[index][0])<br/>        index = index + 1</span></pre><p id="8e88" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Important notes:</p><ol class=""><li id="2a2c" class="nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx qb qc qd bk">Our implementation is highly optimistic in the sense that we assume that all the jobs that are inserted are valid and that we will be able to start them up on SageMaker without issue. In practice, appropriate error handling should be added (e.g., removing faulty jobs from the queue with appropriate logging).</li><li id="3383" class="nc nd fq ne b go qe ng nh gr qf nj nk nl qg nn no np qh nr ns nt qi nv nw nx qb qc qd bk">In a production environment, we would need to take into consideration the likely occurrence of a <a class="af nb" href="https://en.wikipedia.org/wiki/Race_condition" rel="noopener ugc nofollow" target="_blank">race condition</a> when our <em class="pi">queue_manager </em>is triggered by multiple concurrent events. There are several ways of addressing this problem (e.g., see <a class="af nb" href="https://medium.com/@moradiyabhavik/race-condition-understanding-and-solution-926b6d2808cf" rel="noopener">here</a>) including enforcing atomicity (e.g., by setting our <a class="af nb" href="https://docs.aws.amazon.com/lambda/latest/dg/configuration-concurrency.html" rel="noopener ugc nofollow" target="_blank">Lambda function concurrency</a> to one), using some form of locking mechanism (e.g., as done <a class="af nb" href="https://aws.amazon.com/blogs/database/implementing-priority-queueing-with-amazon-dynamodb/" rel="noopener ugc nofollow" target="_blank">here</a>), or making our function <a class="af nb" href="https://en.wikipedia.org/wiki/Idempotence" rel="noopener ugc nofollow" target="_blank">idempotent</a>. Here we have taken the approach of what we call “optimistic idempotence”, where we rely on appropriate use of the API and on the idempotency of our underlying calls to the SageMaker APIs.</li><li id="b345" class="nc nd fq ne b go qe ng nh gr qf nj nk nl qg nn no np qh nr ns nt qi nv nw nx qb qc qd bk">We emphasize that our implementation is naïve. In practice, we recommend a more sophisticated algorithm that 1) accounts for the use of different types of instances and jobs that require more than one instance, 2) takes all edge cases into consideration, and 3) is tailored towards the specific needs of your project.</li></ol><h2 id="06a9" class="pk nz fq bf oa pl pm pn od po pp pq og nl pr ps pt np pu pv pw nt px py pz qa bk">Define the AWS Lambda Function</h2><p id="9142" class="pw-post-body-paragraph nc nd fq ne b go ou ng nh gr ov nj nk nl ow nn no np ox nr ns nt oy nv nw nx fj bk">The next component of the solution is the Lambda function. The following code block includes the <a class="af nb" href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-resource-function.html" rel="noopener ugc nofollow" target="_blank">SAM</a> definition of our serverless function. We program the function to run on two different types of events: any call to <a class="af nb" href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-property-function-api.html" rel="noopener ugc nofollow" target="_blank"><em class="pi">add-job</em></a> on our private API gateway and a <a class="af nb" href="https://docs.aws.amazon.com/sagemaker/latest/dg/automating-sagemaker-with-eventbridge.html" rel="noopener ugc nofollow" target="_blank">change to the state of a SageMaker training job</a>.</p><pre class="ml mm mn mo mp oz pa pb bp pc bb bk"><span id="cbb1" class="pd nz fq pa b bg pe pf l pg ph">  ManagedTrainingJobQueue:<br/>    Type: AWS::Serverless::Function<br/>    Properties:<br/>      CodeUri: job-queue/ # the directory containing our index.py file<br/>      Handler: index.lambda_handler<br/>      Runtime: python3.12<br/>      Architectures:<br/>        - arm64 # use graviton<br/>      Policies: # allow access to SageMaker and DynamoDB<br/>        - !Sub "arn:${AWS::Partition}:iam::aws:policy/AmazonSageMakerFullAccess"<br/>        - DynamoDBCrudPolicy:<br/>            TableName: !Ref DynamoSMQueue<br/>      Events:<br/>        CreateTraining:<br/>          Type: Api<br/>          Properties:<br/>            Path: /add-job<br/>            Method: post<br/>            RestApiId: !Ref InternalAPI<br/>        SageMakerEvent:<br/>          Type: EventBridgeRule<br/>          Properties:<br/>            Pattern:<br/>              source:<br/>                - aws.sagemaker<br/>              detail-type:<br/>                - SageMaker Training Job State Change<br/>              detail:<br/>                TrainingJobStatus:<br/>                  - "Completed"<br/>                  - "Failed"<br/>                  - "Stopped"</span></pre><p id="f290" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">The <em class="pi">lambda_handler </em>function is implemented as follows:</p><pre class="ml mm mn mo mp oz pa pb bp pc bb bk"><span id="516c" class="pd nz fq pa b bg pe pf l pg ph">def lambda_handler(event, context):<br/>    # identify source of event and take appropriate action<br/>    if 'requestContext' in event and 'apiId' in event['requestContext']:<br/>        print('Lambda triggerred by API Gateway')<br/>        job_details = json.loads(event.get('body'))<br/>        add_job_entry(job_details)<br/>    elif 'source' in event and event['source'] == 'aws.sagemaker':<br/>        print('Lambda triggerred by SageMaker job state change')<br/>        job_name = event['detail']['TrainingJobName']<br/>        job_status = event['detail']['TrainingJobStatus']<br/>        print(f'{job_name} status changed to {job_status}')<br/>        <br/>        # strip qstamp from job_name<br/>        job_name = strip_qstamp(job_name)<br/><br/>        if job_status in ['Completed' , 'Failed']:<br/>            remove_job(job_name)<br/>        elif job_status == 'Stopped':<br/>            # check if it was manually stopped or preempted by queue manager<br/>            if get_job_state(job_name) == 'preempted':<br/>                print(f'job {job_name} preemption completed')<br/>            else:<br/>                print(f'job {job_name} {job_status}, remove from queue')<br/>                remove_job(job_name)<br/><br/>    # in all cases invoke queue manager<br/>    manage_queue()</span></pre><h2 id="688c" class="pk nz fq bf oa pl pm pn od po pp pq og nl pr ps pt np pu pv pw nt px py pz qa bk">Intercept the Create Training Job Request</h2><p id="582d" class="pw-post-body-paragraph nc nd fq ne b go ou ng nh gr ov nj nk nl ow nn no np ox nr ns nt oy nv nw nx fj bk">The final modification required to make our solution complete is to intercept the call to the SageMaker <a class="af nb" href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/sagemaker/client/create_training_job.html" rel="noopener ugc nofollow" target="_blank">create_training_job</a> API and reroute it to our <em class="pi">add-job </em>method. We do this by overriding the <a class="af nb" href="https://github.com/aws/sagemaker-python-sdk/blob/v2.208.0/src/sagemaker/session.py#L6212" rel="noopener ugc nofollow" target="_blank">_intercept_create_request</a> function of the <a class="af nb" href="https://sagemaker.readthedocs.io/en/stable/api/utility/session.html" rel="noopener ugc nofollow" target="_blank">SageMaker Session class</a>:</p><pre class="ml mm mn mo mp oz pa pb bp pc bb bk"><span id="7e8f" class="pd nz fq pa b bg pe pf l pg ph">from sagemaker.pytorch import PyTorch<br/>from sagemaker.session import Session<br/>import requests, logging<br/>logger = logging.getLogger('sagemaker')<br/><br/>def submit_to_training_queue(job):<br/>    logger.info(f'Adding training-job {job['TrainingJobName']} to queue')<br/>    logger.debug('train request: {json.dumps(job, indent=4)}')<br/>    <br/>    vpce='&lt;vpc endpoint&gt;' # insert id of vpc endpoint<br/>    region='us-east-1' # specify region<br/>    url=f'https://{vpce}.execute-api.{region}.vpce.amazonaws.com/prod/add-job'<br/>    headers = {'x-apigw-api-id': '&lt;api-id&gt;'} # insert api gateway id<br/><br/>    # submit job<br/>    response = requests.post(url, headers=headers, json=job)<br/><br/>class QueueTrainingJobSession(Session):<br/>    def _intercept_create_request(self, request, create, func_name = None):<br/>        """This function intercepts the create job request<br/><br/>        Args:<br/>          request (dict): the create job request<br/>          create (functor): a functor calls the sagemaker client create method<br/>          func_name (str): the name of the function needed intercepting<br/>        """<br/>        if func_name == 'train':<br/>            submit_to_training_queue(request)<br/>        else:<br/>            super()._intercept_create_request(request,create,func_name)<br/><br/># define job<br/>estimator = PyTorch(<br/>    role='&lt;sagemaker role&gt;',<br/>    entry_point='train.py',<br/>    instance_type='ml.p5.48xlarge',<br/>    instance_count=1,<br/>    framework_version='2.0.1',<br/>    py_version='py310',<br/>    tags=[{'Key': 'priority', 'Value': '100'},<br/>    keep_alive_period_in_seconds=60, # keep warm for 1 minute<br/>    # use our custom Session class<br/>    sagemaker_session=QueueTrainingJobSession()<br/>)<br/><br/>estimator.fit(wait=False)</span></pre><h1 id="37e0" class="ny nz fq bf oa ob oc gq od oe of gt og oh oi oj ok ol om on oo op oq or os ot bk">Use Case Example</h1><p id="0a7c" class="pw-post-body-paragraph nc nd fq ne b go ou ng nh gr ov nj nk nl ow nn no np ox nr ns nt oy nv nw nx fj bk">To test our solution we submit the following sequence of jobs. After each call we print the status of the queue (using the <em class="pi">print_queue_state</em> function) and sleep for twenty seconds.</p><ol class=""><li id="02a5" class="nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx qb qc qd bk">Start job1 with priority 1.</li><li id="b2fd" class="nc nd fq ne b go qe ng nh gr qf nj nk nl qg nn no np qh nr ns nt qi nv nw nx qb qc qd bk">Start job2 with priority 2.</li><li id="ceee" class="nc nd fq ne b go qe ng nh gr qf nj nk nl qg nn no np qh nr ns nt qi nv nw nx qb qc qd bk">Start job3 with priority 1.</li><li id="9cf3" class="nc nd fq ne b go qe ng nh gr qf nj nk nl qg nn no np qh nr ns nt qi nv nw nx qb qc qd bk">Start job4 with priority 3.</li></ol><p id="23c5" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">The first two jobs are immediately submitted to SageMaker and updated to the <em class="pi">running</em> state. Since the third job has low priority and we have precisely two training instances, it remains in the <em class="pi">pending</em> state and waits its turn. After submitting the first three jobs, the queue state appears as:</p><pre class="ml mm mn mo mp oz pa pb bp pc bb bk"><span id="ec85" class="pd nz fq pa b bg pe pf l pg ph">Job Name    State      Priority<br/>----------  -------  ----------<br/>job2        running           2<br/>job1        running           1<br/>job3        pending           1</span></pre><p id="0037" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">The fourth job we submit has a higher priority than all of the jobs in the queue. Consequently, the running job with the lowest priority, <em class="pi">job1</em>, is preempted. The corresponding SageMaker job is stopped and once the instance is released, the queue state becomes:</p><pre class="ml mm mn mo mp oz pa pb bp pc bb bk"><span id="cf33" class="pd nz fq pa b bg pe pf l pg ph">Job Name    State        Priority<br/>----------  ---------  ----------<br/>job4        running             3<br/>job2        running             2<br/>job1        preempted           1<br/>job3        pending             1</span></pre><p id="b895" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">The SageMaker job running <em class="pi">job2</em> is the first to finish, <em class="pi">job2 </em>is removed from the queue, and our preempted job is resumed:</p><pre class="ml mm mn mo mp oz pa pb bp pc bb bk"><span id="5b85" class="pd nz fq pa b bg pe pf l pg ph">Job Name    State      Priority<br/>----------  -------  ----------<br/>job4        running           3<br/>job1        running           1<br/>job3        pending           1</span></pre><p id="5d8e" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Once <em class="pi">job4</em> is completed, it too is removed from the queue, making room for <em class="pi">job3</em>. The remaining jobs are also run to completion, ultimately leaving our queue empty.</p><h1 id="c264" class="ny nz fq bf oa ob oc gq od oe of gt og oh oi oj ok ol om on oo op oq or os ot bk">Summary</h1><p id="a250" class="pw-post-body-paragraph nc nd fq ne b go ou ng nh gr ov nj nk nl ow nn no np ox nr ns nt oy nv nw nx fj bk">The increasing difficulty of acquiring AI compute capacity has forced AI development teams to reevaluate the processes they use for training AI models. The approach we have demonstrated in this post is to augment the traditional APIs for training models with a custom-made priority queue and an associated job scheduler. Importantly, the proposal we have put forth should be viewed as a general scheme, not as a production-worthy solution. Appropriate modifications and enhancements would be required to address the specifics needs of your project.</p></div></div></div></div>    
</body>
</html>