<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Pandas: From Messy To Beautiful</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Pandas: From Messy To Beautiful</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/pandas-from-messy-to-beautiful-b03b0c32f767?source=collection_archive---------2-----------------------#2024-03-31">https://towardsdatascience.com/pandas-from-messy-to-beautiful-b03b0c32f767?source=collection_archive---------2-----------------------#2024-03-31</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="1ef8" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx">This is how to make your pandas code human readable &amp; bulletproof.</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hd he hf hg hh ab"><div><div class="ab hi"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@azawadzka?source=post_page---byline--b03b0c32f767--------------------------------" rel="noopener follow"><div class="l hj hk by hl hm"><div class="l ed"><img alt="Anna Zawadzka" class="l ep by dd de cx" src="../Images/bcdd9dfb9faeace44e831c057984bc63.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/1*E8r-Ih1XQYmr-ARyNUnt1w.png"/><div class="hn by l dd de em n ho eo"/></div></div></a></div></div><div class="hp ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--b03b0c32f767--------------------------------" rel="noopener follow"><div class="l hq hr by hl hs"><div class="l ed"><img alt="Towards Data Science" class="l ep by br ht cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hn by l br ht em n ho eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hu ab q"><div class="ab q hv"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hw hx bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hy" data-testid="authorName" href="https://medium.com/@azawadzka?source=post_page---byline--b03b0c32f767--------------------------------" rel="noopener follow">Anna Zawadzka</a></p></div></div></div><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hw hx dx"><button class="ib ic ah ai aj ak al am an ao ap aq ar id ie if" disabled="">Follow</button></p></div></div></span></div></div><div class="l ig"><span class="bf b bg z dx"><div class="ab cn ih ii ij"><div class="ik il ab"><div class="bf b bg z dx ab im"><span class="in l ig">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hy ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--b03b0c32f767--------------------------------" rel="noopener follow"><p class="bf b bg z io ip iq ir is it iu iv bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">9 min read</span><div class="iw ix l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Mar 31, 2024</span></div></span></div></span></div></div></div><div class="ab cp iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn"><div class="h k w ea eb q"><div class="kd l"><div class="ab q ke kf"><div class="pw-multi-vote-icon ed in kg kh ki"><div class=""><div class="kj kk kl km kn ko kp am kq kr ks ki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kt ku kv kw kx ky kz"><p class="bf b dy z dx"><span class="kk">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kj lc ld ab q ee le lf" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="lb"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg><p class="bf b dy z dx"><span class="pw-responses-count la lb">6</span></p></button></div></div></div><div class="ab q jo jp jq jr js jt ju jv jw jx jy jz ka kb kc"><div class="lg k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lh an ao ap id li lj lk" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep ll cn"><div class="l ae"><div class="ab cb"><div class="lm ln lo lp lq lr ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div></div></div><div class="mj bh"><figure class="mk ml mm mn mo mj bh paragraph-image"><img src="../Images/85b2209904b2b7ed17ff3d5b5e960141.png" data-original-src="https://miro.medium.com/v2/resize:fit:4112/format:webp/1*-IxV8k8g0cCxNHxsEPGqSw.png"/></figure></div><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="cf4b" class="pw-post-body-paragraph mq mr fq ms b go mt mu mv gr mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl fj bk">Scripting around a pandas <code class="cx nm nn no np b">DataFrame</code> can turn into an awkward pile of (not-so-)good old spaghetti code. Me and my colleagues use this package a lot and while we try to stick to good programming practices, like splitting code in modules and unit testing, sometimes we still get in the way of one another by producing confusing code.</p><p id="3b7c" class="pw-post-body-paragraph mq mr fq ms b go mt mu mv gr mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl fj bk">I have gathered some tips and pitfalls to avoid in order to make pandas code clean and infallible. Hopefully you’ll find them useful too. We'll get some help from Robert C. Martin's classic “Clean code” specifically for the context of the pandas package. TL;DR at the end.</p><h1 id="286c" class="nq nr fq bf ns nt nu gq nv nw nx gt ny nz oa ob oc od oe of og oh oi oj ok ol bk">Dont’s</h1><p id="b19d" class="pw-post-body-paragraph mq mr fq ms b go om mu mv gr on mx my mz oo nb nc nd op nf ng nh oq nj nk nl fj bk">Let’s begin by observing some faulty patterns inspired by real life. Later on, we’ll try to rephrase that code in order to favor readability and control.</p><h2 id="47e0" class="or nr fq bf ns os ot ou nv ov ow ox ny mz oy oz pa nd pb pc pd nh pe pf pg ph bk">Mutability</h2><p id="1f94" class="pw-post-body-paragraph mq mr fq ms b go om mu mv gr on mx my mz oo nb nc nd op nf ng nh oq nj nk nl fj bk">Pandas <code class="cx nm nn no np b">DataFrames</code> are value-<strong class="ms fr">mutable</strong> [<a class="af pi" href="https://pandas.pydata.org/pandas-docs/stable/getting_started/overview.html#mutability-and-copying-of-data" rel="noopener ugc nofollow" target="_blank">2</a>, <a class="af pi" href="https://realpython.com/python-mutable-vs-immutable-types/" rel="noopener ugc nofollow" target="_blank">3]</a> objects. Whenever you alter a mutable object, it affects the exact same instance that you originally created and its physical location in memory remains unchanged. In contrast, when you modify an <strong class="ms fr">immutable</strong> object (eg. a string), Python goes to create a whole new object at a new memory location and swaps the reference for the new one.</p><p id="2579" class="pw-post-body-paragraph mq mr fq ms b go mt mu mv gr mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl fj bk">This is the crucial point: in Python, objects get passed to the function <strong class="ms fr">by assignment</strong> <a class="af pi" href="https://medium.com/techtofreedom/5-levels-of-understanding-the-mutability-of-python-objects-a5ed839d6c24" rel="noopener">[4</a>, <a class="af pi" href="https://realpython.com/python-pass-by-reference/" rel="noopener ugc nofollow" target="_blank">5]</a><strong class="ms fr">. </strong>See the graph: the value of <code class="cx nm nn no np b">df</code> has been assigned to variable <code class="cx nm nn no np b">in_df</code> when it was passed to the function as an argument. Both the original <code class="cx nm nn no np b">df</code> and the <code class="cx nm nn no np b">in_df</code> inside the function point to the same memory location (numeric value in parentheses), even if they go by different variable names. During the modification of its attributes, the location of the mutable object remains unchanged. Now all other scopes can see the changes too — they reach to the same memory location.</p><figure class="mk ml mm mn mo mj pj pk paragraph-image"><div role="button" tabindex="0" class="pm pn ed po bh pp"><div class="pj pk pl"><img src="../Images/388fcc4c3aa872d7d1d0775d63fd45ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zoz5KwBVozCQPY9yDDYugA.png"/></div></div><figcaption class="pq pr ps pj pk pt pu bf b bg z dx">Modification of a mutable object in Python memory.</figcaption></figure><p id="464e" class="pw-post-body-paragraph mq mr fq ms b go mt mu mv gr mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl fj bk">Actually, since we have modified the original instance, it’s redundant to return the <code class="cx nm nn no np b">DataFrame</code> and assign it to the variable. This code has the exact same effect:</p><figure class="mk ml mm mn mo mj pj pk paragraph-image"><div role="button" tabindex="0" class="pm pn ed po bh pp"><div class="pj pk pl"><img src="../Images/5d40a39701f5dcc10a5cad4a1a5bbbce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*47nGU-0PUBqtlAGb6BVrSQ.png"/></div></div><figcaption class="pq pr ps pj pk pt pu bf b bg z dx">Modification of a mutable object in Python memory, redundant assignment removed.</figcaption></figure><p id="a2f0" class="pw-post-body-paragraph mq mr fq ms b go mt mu mv gr mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl fj bk">Heads-up: the function now returns <code class="cx nm nn no np b">None</code>, so be careful not to overwrite the <code class="cx nm nn no np b">df</code> with <code class="cx nm nn no np b">None</code> if you do perform the assignment: <code class="cx nm nn no np b">df = modify_df(df)</code>.</p><p id="ff6b" class="pw-post-body-paragraph mq mr fq ms b go mt mu mv gr mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl fj bk">In contrast, if the object is immutable, it will change the memory location throughout the modification just like in the example below. Since the red string cannot be modified (strings are immutable), the green string is created on top of the old one, but as a brand new object, claiming a new location in memory. The returned string is not the same string, whereas the returned <code class="cx nm nn no np b">DataFrame</code> was the exact same <code class="cx nm nn no np b">DataFrame</code>.</p><figure class="mk ml mm mn mo mj pj pk paragraph-image"><div role="button" tabindex="0" class="pm pn ed po bh pp"><div class="pj pk pv"><img src="../Images/749363a0bcce3c499a1c18844d6814c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0npRJR93fKMtQvFw_cqJ5w.png"/></div></div><figcaption class="pq pr ps pj pk pt pu bf b bg z dx">Modification of an immutable object in Python memory.</figcaption></figure><p id="5604" class="pw-post-body-paragraph mq mr fq ms b go mt mu mv gr mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl fj bk">The point is, mutating <code class="cx nm nn no np b">DataFrames</code> inside functions has a <strong class="ms fr">global effect</strong>. If you don’t keep that in mind, you may:</p><ul class=""><li id="c791" class="mq mr fq ms b go mt mu mv gr mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl pw px py bk">accidentally modify or remove part of your data, thinking that the action is only taking place inside the function scope — it is not,</li><li id="b942" class="mq mr fq ms b go pz mu mv gr qa mx my mz qb nb nc nd qc nf ng nh qd nj nk nl pw px py bk">lose control over what is added to your <code class="cx nm nn no np b">DataFrame</code> and when it's added, for example in nested function calls.</li></ul><h2 id="a043" class="or nr fq bf ns os ot ou nv ov ow ox ny mz oy oz pa nd pb pc pd nh pe pf pg ph bk">Output arguments</h2><p id="5150" class="pw-post-body-paragraph mq mr fq ms b go om mu mv gr on mx my mz oo nb nc nd op nf ng nh oq nj nk nl fj bk">We’ll fix that problem later, but here is another <code class="cx nm nn no np b">don't</code> before we pass to <code class="cx nm nn no np b">do</code>'s</p><p id="a878" class="pw-post-body-paragraph mq mr fq ms b go mt mu mv gr mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl fj bk">The design from the previous section is actually an anti-pattern called <strong class="ms fr">output argument </strong>[1 p.45]. Typically, <strong class="ms fr">inputs</strong> of a function will be used to create an <strong class="ms fr">output</strong> value. If the sole point of passing an argument to a function is to modify it, so that the input argument changes its state, then it’s challenging our intuitions. Such behavior is called <strong class="ms fr">side effect</strong> [1 p.44] of a function and those should be well documented and minimized because they force the programmer to remember the things that go in the background, therefore making the script error-prone.</p><blockquote class="qe qf qg"><p id="3054" class="mq mr qh ms b go mt mu mv gr mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl fj bk"><em class="fq">When we read a function, we are used to the idea of information going in to the function through arguments and out through the return value. We don’t usually expect information to be going out through the arguments. [1 p.41]</em></p></blockquote><p id="ff50" class="pw-post-body-paragraph mq mr fq ms b go mt mu mv gr mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl fj bk">Things get even worse if the function has a double responsibility: to modify the input <strong class="ms fr">and</strong> to return an output. Consider this function:</p><pre class="mk ml mm mn mo qi np qj bp qk bb bk"><span id="f677" class="ql nr fq np b bg qm qn l qo qp">def find_max_name_length(df: pd.DataFrame) -&gt; int:<br/>    df["name_len"] = df["name"].str.len()  # side effect<br/>    return max(df["name_len"])</span></pre><p id="9ecb" class="pw-post-body-paragraph mq mr fq ms b go mt mu mv gr mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl fj bk">It does return a value as you would expect, but it also permanently modifies the original <code class="cx nm nn no np b">DataFrame</code>. The side effect takes you by surprise - nothing in the function signature indicated that our input data was going to be affected. In the next step, we'll see how to avoid this kind of design.</p><h1 id="6814" class="nq nr fq bf ns nt nu gq nv nw nx gt ny nz oa ob oc od oe of og oh oi oj ok ol bk">Do’s</h1><h2 id="7416" class="or nr fq bf ns os ot ou nv ov ow ox ny mz oy oz pa nd pb pc pd nh pe pf pg ph bk">Reduce modifications</h2><p id="1990" class="pw-post-body-paragraph mq mr fq ms b go om mu mv gr on mx my mz oo nb nc nd op nf ng nh oq nj nk nl fj bk">To eliminate the side effect, in the code below we have created a new temporary variable instead of modifying the original <code class="cx nm nn no np b">DataFrame</code>. The notation <code class="cx nm nn no np b">lengths: pd.Series</code> indicates the datatype of the variable.</p><pre class="mk ml mm mn mo qi np qj bp qk bb bk"><span id="05de" class="ql nr fq np b bg qm qn l qo qp">def find_max_name_length(df: pd.DataFrame) -&gt; int:<br/>    lengths: pd.Series = df["name"].str.len()<br/>    return max(lengths)</span></pre><p id="6745" class="pw-post-body-paragraph mq mr fq ms b go mt mu mv gr mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl fj bk">This function design is better in that it encapsulates the intermediate state instead of producing a side effect.</p><p id="b2f9" class="pw-post-body-paragraph mq mr fq ms b go mt mu mv gr mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl fj bk">Another heads-up: please be mindful of the differences between <strong class="ms fr">deep and shallow copy</strong> <a class="af pi" href="https://realpython.com/copying-python-objects/" rel="noopener ugc nofollow" target="_blank">[6]</a> of elements from the <code class="cx nm nn no np b">DataFrame</code>. In the example above we have modified each element of the original <code class="cx nm nn no np b">df["name"]</code> <code class="cx nm nn no np b">Series</code>, so the old <code class="cx nm nn no np b">DataFrame</code> and the new variable have no shared elements. However, if you directly assign one of the original columns to a new variable, the underlying elements still have the same references in memory. See the examples:</p><pre class="mk ml mm mn mo qi np qj bp qk bb bk"><span id="0bf4" class="ql nr fq np b bg qm qn l qo qp">df = pd.DataFrame({"name": ["bert", "albert"]})<br/><br/>series = df["name"]     # shallow copy<br/>series[0] = "roberta"   # &lt;-- this changes the original DataFrame<br/><br/>series = df["name"].copy(deep=True)<br/>series[0] = "roberta"   # &lt;-- this does not change the original DataFrame<br/><br/>series = df["name"].str.title()  # not a copy whatsoever<br/>series[0] = "roberta"   # &lt;-- this does not change the original DataFrame</span></pre><p id="282e" class="pw-post-body-paragraph mq mr fq ms b go mt mu mv gr mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl fj bk">You can print out the <code class="cx nm nn no np b">DataFrame</code> after each step to observe the effect. Remember that creating a deep copy will allocate new memory, so it’s good to reflect whether your script needs to be memory-efficient.</p><h2 id="0186" class="or nr fq bf ns os ot ou nv ov ow ox ny mz oy oz pa nd pb pc pd nh pe pf pg ph bk">Group similar operations</h2><p id="49d7" class="pw-post-body-paragraph mq mr fq ms b go om mu mv gr on mx my mz oo nb nc nd op nf ng nh oq nj nk nl fj bk">Maybe for whatever reason you want to store the result of that length computation. It’s still not a good idea to append it to the <code class="cx nm nn no np b">DataFrame</code> inside the function because of the <strong class="ms fr">side effect</strong> breach as well as the accumulation of <strong class="ms fr">multiple responsibilities</strong> inside a single function.</p><p id="5226" class="pw-post-body-paragraph mq mr fq ms b go mt mu mv gr mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl fj bk">I like the <strong class="ms fr">One Level of Abstraction per Function</strong> rule that says:</p><blockquote class="qe qf qg"><p id="eb29" class="mq mr qh ms b go mt mu mv gr mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl fj bk"><em class="fq">We need to make sure that the statements within our function are all at the same level of abstraction.</em></p><p id="7a53" class="mq mr qh ms b go mt mu mv gr mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl fj bk"><em class="fq">Mixing levels of abstraction within a function is always confusing. Readers may not be able to tell whether a particular expression is an essential concept or a detail. [1 p.36]</em></p></blockquote><p id="5862" class="pw-post-body-paragraph mq mr fq ms b go mt mu mv gr mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl fj bk">Also let’s employ the <strong class="ms fr">Single responsibility principle</strong> [1 p.138] from OOP, even though we’re not focusing on object-oriented code right now.</p><p id="6c99" class="pw-post-body-paragraph mq mr fq ms b go mt mu mv gr mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl fj bk">Why not prepare your data beforehand? Let’s split data preparation and the actual computation in separate functions:</p><pre class="mk ml mm mn mo qi np qj bp qk bb bk"><span id="668d" class="ql nr fq np b bg qm qn l qo qp">def create_name_len_col(series: pd.Series) -&gt; pd.Series:<br/>    return series.str.len()<br/><br/>def find_max_element(collection: Collection) -&gt; int:<br/>    return max(collection) if len(collection) else 0<br/><br/>df = pd.DataFrame({"name": ["bert", "albert"]})<br/>df["name_len"] = create_name_len_col(df.name)<br/>max_name_len = find_max_element(df.name_len)</span></pre><p id="f4a8" class="pw-post-body-paragraph mq mr fq ms b go mt mu mv gr mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl fj bk">The individual task of creating the <code class="cx nm nn no np b">name_len</code> column has been outsourced to another function. It does not modify the original <code class="cx nm nn no np b">DataFrame</code> and it performs <strong class="ms fr">one task at a time</strong>. Later we retrieve the max element by passing the new column to another dedicated function. Notice how the aggregating function is generic for <code class="cx nm nn no np b">Collections</code>.</p><p id="8415" class="pw-post-body-paragraph mq mr fq ms b go mt mu mv gr mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl fj bk">Let’s brush the code up with the following steps:</p><ul class=""><li id="9eb5" class="mq mr fq ms b go mt mu mv gr mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl pw px py bk">We could use <code class="cx nm nn no np b">concat</code> function and extract it to a separate function called <code class="cx nm nn no np b">prepare_data</code>, which would group all data preparation steps in a single place,</li><li id="45b6" class="mq mr fq ms b go pz mu mv gr qa mx my mz qb nb nc nd qc nf ng nh qd nj nk nl pw px py bk">We could also make use of the <code class="cx nm nn no np b">apply</code> method and work on individual texts instead of <code class="cx nm nn no np b">Series</code> of texts,</li><li id="8293" class="mq mr fq ms b go pz mu mv gr qa mx my mz qb nb nc nd qc nf ng nh qd nj nk nl pw px py bk">Let’s remember to use shallow vs. deep copy, depending on whether the original data should or should not be modified:</li></ul><pre class="mk ml mm mn mo qi np qj bp qk bb bk"><span id="243f" class="ql nr fq np b bg qm qn l qo qp">def compute_length(word: str) -&gt; int:<br/>    return len(word)<br/><br/>def prepare_data(df: pd.DataFrame) -&gt; pd.DataFrame:<br/>    return pd.concat([<br/>        df.copy(deep=True),  # deep copy<br/>        df.name.apply(compute_length).rename("name_len"),<br/>        ...<br/>    ], axis=1)</span></pre><h2 id="7999" class="or nr fq bf ns os ot ou nv ov ow ox ny mz oy oz pa nd pb pc pd nh pe pf pg ph bk">Reusability</h2><p id="0d44" class="pw-post-body-paragraph mq mr fq ms b go om mu mv gr on mx my mz oo nb nc nd op nf ng nh oq nj nk nl fj bk">The way we have split the code really makes it easy to go back to the script later, take the entire function and reuse it in another script. We like that!</p><p id="57f9" class="pw-post-body-paragraph mq mr fq ms b go mt mu mv gr mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl fj bk">There is one more thing we can do to increase the level of reusability: pass column names as parameters to functions. The refactoring is going a little bit over the top, but sometimes it pays for the sake of flexibility or reusability.</p><pre class="mk ml mm mn mo qi np qj bp qk bb bk"><span id="d11a" class="ql nr fq np b bg qm qn l qo qp">def create_name_len_col(df: pd.DataFrame, orig_col: str, target_col: str) -&gt; pd.Series:<br/>    return df[orig_col].str.len().rename(target_col)<br/><br/>name_label, name_len_label = "name", "name_len"<br/>pd.concat([<br/>    df,<br/>    create_name_len_col(df, name_label, name_len_label)<br/>], axis=1)</span></pre><h2 id="8672" class="or nr fq bf ns os ot ou nv ov ow ox ny mz oy oz pa nd pb pc pd nh pe pf pg ph bk">Testability</h2><p id="d0bf" class="pw-post-body-paragraph mq mr fq ms b go om mu mv gr on mx my mz oo nb nc nd op nf ng nh oq nj nk nl fj bk">Did you ever figure out that your preprocessing was faulty after weeks of experiments on the preprocessed dataset? No? Lucky you. I actually had to repeat a batch of experiments because of broken annotations, which could have been avoided if I had tested just a couple of basic functions.</p><p id="6c8f" class="pw-post-body-paragraph mq mr fq ms b go mt mu mv gr mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl fj bk">Important scripts should be <strong class="ms fr">tested</strong> [1 p.121, 7]. Even if the script is just a helper, I now try to test at least the crucial, most low-level functions. Let’s revisit the steps that we made from the start:</p><p id="bdfe" class="pw-post-body-paragraph mq mr fq ms b go mt mu mv gr mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl fj bk">1. I am not happy to even think of testing this, it’s very redundant and we have paved over the side effect. It also tests a bunch of different features: the computation of name length and the aggregation of result for the max element. Plus it fails, did you see that coming?</p><pre class="mk ml mm mn mo qi np qj bp qk bb bk"><span id="78c2" class="ql nr fq np b bg qm qn l qo qp">def find_max_name_length(df: pd.DataFrame) -&gt; int:<br/>    df["name_len"] = df["name"].str.len()  # side effect<br/>    return max(df["name_len"])<br/><br/><br/>@pytest.mark.parametrize("df, result", [<br/>    (pd.DataFrame({"name": []}), 0),  # oops, this fails!<br/>    (pd.DataFrame({"name": ["bert"]}), 4),<br/>    (pd.DataFrame({"name": ["bert", "roberta"]}), 7),<br/>])<br/>def test_find_max_name_length(df: pd.DataFrame, result: int):<br/>    assert find_max_name_length(df) == result</span></pre><p id="a796" class="pw-post-body-paragraph mq mr fq ms b go mt mu mv gr mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl fj bk">2. This is much better — we have focused on one single task, so the test is simpler. We also don’t have to fixate on column names like we did before. However, I think that the format of the data gets in the way of verifying the correctness of the computation.</p><pre class="mk ml mm mn mo qi np qj bp qk bb bk"><span id="be8d" class="ql nr fq np b bg qm qn l qo qp">def create_name_len_col(series: pd.Series) -&gt; pd.Series:<br/>    return series.str.len()<br/><br/><br/>@pytest.mark.parametrize("series1, series2", [<br/>    (pd.Series([]), pd.Series([])),<br/>    (pd.Series(["bert"]), pd.Series([4])),<br/>    (pd.Series(["bert", "roberta"]), pd.Series([4, 7]))<br/>])<br/>def test_create_name_len_col(series1: pd.Series, series2: pd.Series):<br/>    pd.testing.assert_series_equal(create_name_len_col(series1), series2, check_dtype=False)</span></pre><p id="1f7c" class="pw-post-body-paragraph mq mr fq ms b go mt mu mv gr mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl fj bk">3. Here we have cleaned up the desk. We test the computation function inside out, leaving the pandas overlay behind. It’s easier to come up with edge cases when you focus on one thing at a time. I figured out that I’d like to test for <code class="cx nm nn no np b">None</code> values that may appear in the <code class="cx nm nn no np b">DataFrame</code> and I eventually had to improve my function for that test to pass. A bug caught!</p><pre class="mk ml mm mn mo qi np qj bp qk bb bk"><span id="63ac" class="ql nr fq np b bg qm qn l qo qp">def compute_length(word: Optional[str]) -&gt; int:<br/>    return len(word) if word else 0<br/><br/><br/>@pytest.mark.parametrize("word, length", [<br/>    ("", 0),<br/>    ("bert", 4),<br/>    (None, 0)<br/>])<br/>def test_compute_length(word: str, length: int):<br/>    assert compute_length(word) == length</span></pre><p id="284a" class="pw-post-body-paragraph mq mr fq ms b go mt mu mv gr mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl fj bk">4. We’re only missing the test for <code class="cx nm nn no np b">find_max_element</code>:</p><pre class="mk ml mm mn mo qi np qj bp qk bb bk"><span id="af32" class="ql nr fq np b bg qm qn l qo qp">def find_max_element(collection: Collection) -&gt; int:<br/>    return max(collection) if len(collection) else 0<br/><br/><br/>@pytest.mark.parametrize("collection, result", [<br/>    ([], 0),<br/>    ([4], 4),<br/>    ([4, 7], 7),<br/>    (pd.Series([4, 7]), 7),<br/>])<br/>def test_find_max_element(collection: Collection, result: int):<br/>    assert find_max_element(collection) == result</span></pre><p id="e98e" class="pw-post-body-paragraph mq mr fq ms b go mt mu mv gr mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl fj bk">One additional benefit of unit testing that I never forget to mention is that it is a way of <strong class="ms fr">documenting your code</strong>, as someone who doesn’t know it (like <strong class="ms fr">you</strong> from the future) can easily figure out the inputs and expected outputs, including edge cases, just by looking at the tests. Double gain!</p><h1 id="286e" class="nq nr fq bf ns nt nu gq nv nw nx gt ny nz oa ob oc od oe of og oh oi oj ok ol bk">Conclusion</h1><p id="8075" class="pw-post-body-paragraph mq mr fq ms b go om mu mv gr on mx my mz oo nb nc nd op nf ng nh oq nj nk nl fj bk">These are some tricks I found useful while coding and reviewing other people’s code. I’m far from telling you that one or another way of coding is the only correct one — you take what you want from it, you decide whether you need a quick scratch or a highly polished and tested codebase. I hope this thought piece helps you structure your scripts so that you’re happier with them and more confident about their infallibility.</p><p id="c3ec" class="pw-post-body-paragraph mq mr fq ms b go mt mu mv gr mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl fj bk">If you liked this article, I would love to know about it. Happy coding!</p><blockquote class="qe qf qg"><p id="ce47" class="mq mr qh ms b go mt mu mv gr mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl fj bk">TL;DR</p><p id="5795" class="mq mr qh ms b go mt mu mv gr mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl fj bk">There’s no one and only correct way of coding, but here are some inspirations for scripting with pandas:</p><p id="3710" class="mq mr qh ms b go mt mu mv gr mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl fj bk">Dont’s:</p><p id="a1e1" class="mq mr qh ms b go mt mu mv gr mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl fj bk">- don’t mutate your <code class="cx nm nn no np b"><em class="fq">DataFrame</em></code> too much inside functions, because you may lose control over what and where gets appended/removed from it,</p><p id="10f7" class="mq mr qh ms b go mt mu mv gr mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl fj bk">- don’t write methods that mutate a <code class="cx nm nn no np b"><em class="fq">DataFrame</em></code> and return nothing because that's confusing.</p><p id="34ef" class="mq mr qh ms b go mt mu mv gr mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl fj bk">Do’s:</p><p id="138c" class="mq mr qh ms b go mt mu mv gr mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl fj bk">- create new objects instead of modifying the source <code class="cx nm nn no np b"><em class="fq">DataFrame</em></code> and remember to make a deep copy when needed,</p><p id="21eb" class="mq mr qh ms b go mt mu mv gr mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl fj bk">- perform only similar-level operations inside a single function,</p><p id="911a" class="mq mr qh ms b go mt mu mv gr mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl fj bk">- design functions for flexibility and reusability,</p><p id="f366" class="mq mr qh ms b go mt mu mv gr mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl fj bk">- test your functions because this helps you design cleaner code, secure against bugs and edge cases and document it for free.</p></blockquote><h1 id="c7fc" class="nq nr fq bf ns nt nu gq nv nw nx gt ny nz oa ob oc od oe of og oh oi oj ok ol bk">References</h1><ul class=""><li id="65e2" class="mq mr fq ms b go om mu mv gr on mx my mz oo nb nc nd op nf ng nh oq nj nk nl pw px py bk">[1] Robert C. Martin, Clean code A Handbook of Agile Software Craftsmanship (2009), Pearson Education, Inc.</li><li id="d29d" class="mq mr fq ms b go pz mu mv gr qa mx my mz qb nb nc nd qc nf ng nh qd nj nk nl pw px py bk">[2] pandas documentation - Package overview — Mutability and copying of data, <a class="af pi" href="https://pandas.pydata.org/pandas-docs/stable/getting_started/overview.html#mutability-and-copying-of-data" rel="noopener ugc nofollow" target="_blank">https://pandas.pydata.org/pandas-docs/stable/getting_started/overview.html#mutability-and-copying-of-data</a></li><li id="4e91" class="mq mr fq ms b go pz mu mv gr qa mx my mz qb nb nc nd qc nf ng nh qd nj nk nl pw px py bk">[3] Python’s Mutable vs Immutable Types: What’s the Difference?, <a class="af pi" href="https://realpython.com/python-mutable-vs-immutable-types/" rel="noopener ugc nofollow" target="_blank">https://realpython.com/python-mutable-vs-immutable-types/</a></li><li id="0c0d" class="mq mr fq ms b go pz mu mv gr qa mx my mz qb nb nc nd qc nf ng nh qd nj nk nl pw px py bk">[4] 5 Levels of Understanding the Mutability of Python Objects, <a class="af pi" href="https://medium.com/techtofreedom/5-levels-of-understanding-the-mutability-of-python-objects-a5ed839d6c24" rel="noopener">https://medium.com/techtofreedom/5-levels-of-understanding-the-mutability-of-python-objects-a5ed839d6c24</a></li><li id="7bd7" class="mq mr fq ms b go pz mu mv gr qa mx my mz qb nb nc nd qc nf ng nh qd nj nk nl pw px py bk">[5] Pass by Reference in Python: Background and Best Practices, <a class="af pi" href="https://realpython.com/python-pass-by-reference/" rel="noopener ugc nofollow" target="_blank">https://realpython.com/python-pass-by-reference/</a></li><li id="a03c" class="mq mr fq ms b go pz mu mv gr qa mx my mz qb nb nc nd qc nf ng nh qd nj nk nl pw px py bk">[6] Shallow vs Deep Copying of Python Objects, <a class="af pi" href="https://realpython.com/copying-python-objects/" rel="noopener ugc nofollow" target="_blank">https://realpython.com/copying-python-objects/</a></li><li id="bc0d" class="mq mr fq ms b go pz mu mv gr qa mx my mz qb nb nc nd qc nf ng nh qd nj nk nl pw px py bk">[7] Brian Okken, Python Testing with pytest, Second Edition (2022), The Pragmatic Programmers, LLC.</li></ul><p id="6914" class="pw-post-body-paragraph mq mr fq ms b go mt mu mv gr mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl fj bk">The graphs were created by me using <a class="af pi" href="https://miro.com/" rel="noopener ugc nofollow" target="_blank">Miro</a>. The cover image was also created by me using the <a class="af pi" href="https://www.openml.org/search?type=data&amp;sort=runs&amp;id=40945&amp;status=active" rel="noopener ugc nofollow" target="_blank">Titanic</a> dataset and GIMP (smudge effect).</p></div></div></div></div>    
</body>
</html>