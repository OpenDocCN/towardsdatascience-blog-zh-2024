<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>GraphRAG in Action: From Commercial Contracts to a Dynamic Q&A Agent</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>GraphRAG in Action: From Commercial Contracts to a Dynamic Q&A Agent</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/graphrag-in-action-from-commercial-contracts-to-a-dynamic-q-a-agent-7d4a6caa6eb5?source=collection_archive---------0-----------------------#2024-11-04">https://towardsdatascience.com/graphrag-in-action-from-commercial-contracts-to-a-dynamic-q-a-agent-7d4a6caa6eb5?source=collection_archive---------0-----------------------#2024-11-04</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="46b9" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx">A question-based extraction approach</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hd he hf hg hh ab"><div><div class="ab hi"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@edward.sandoval.2000?source=post_page---byline--7d4a6caa6eb5--------------------------------" rel="noopener follow"><div class="l hj hk by hl hm"><div class="l ed"><img alt="Ed Sandoval" class="l ep by dd de cx" src="../Images/2bdc5126db03add63b2ee251db2c3e0b.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/1*crTWn7IfCEo7RRVkxHiZng.jpeg"/><div class="hn by l dd de em n ho eo"/></div></div></a></div></div><div class="hp ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--7d4a6caa6eb5--------------------------------" rel="noopener follow"><div class="l hq hr by hl hs"><div class="l ed"><img alt="Towards Data Science" class="l ep by br ht cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hn by l br ht em n ho eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hu ab q"><div class="ab q hv"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hw hx bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hy" data-testid="authorName" href="https://medium.com/@edward.sandoval.2000?source=post_page---byline--7d4a6caa6eb5--------------------------------" rel="noopener follow">Ed Sandoval</a></p></div></div></div><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hw hx dx"><button class="ib ic ah ai aj ak al am an ao ap aq ar id ie if" disabled="">Follow</button></p></div></div></span></div></div><div class="l ig"><span class="bf b bg z dx"><div class="ab cn ih ii ij"><div class="ik il ab"><div class="bf b bg z dx ab im"><span class="in l ig">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hy ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--7d4a6caa6eb5--------------------------------" rel="noopener follow"><p class="bf b bg z io ip iq ir is it iu iv bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">23 min read</span><div class="iw ix l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Nov 4, 2024</span></div></span></div></span></div></div></div><div class="ab cp iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn"><div class="h k w ea eb q"><div class="kd l"><div class="ab q ke kf"><div class="pw-multi-vote-icon ed in kg kh ki"><div class=""><div class="kj kk kl km kn ko kp am kq kr ks ki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kt ku kv kw kx ky kz"><p class="bf b dy z dx"><span class="kk">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kj lc ld ab q ee le lf" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="lb"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg><p class="bf b dy z dx"><span class="pw-responses-count la lb">1</span></p></button></div></div></div><div class="ab q jo jp jq jr js jt ju jv jw jx jy jz ka kb kc"><div class="lg k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lh an ao ap id li lj lk" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep ll cn"><div class="l ae"><div class="ab cb"><div class="lm ln lo lp lq lr ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><p id="a96f" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">In this blog post, we introduce an approach that leverages a Graph Retrieval Augmented Generation (GraphRAG) method — to streamline the process of ingesting commercial contract data and building a Q&amp;A Agent.</p><p id="a9de" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">This approach diverges from traditional RAG (Retrieval-Augmented Generation) by emphasizing efficiency in data extraction, rather than breaking down and vectorizing entire documents indiscriminately, which is the predominant RAG approach.</p><p id="2502" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">In conventional RAG, every document is split into chunks and vectorized for retrieval, which can result in a large volume of unnecessary data being split, chunked and stored in vector indexes. Here, however, the focus is on extracting only the most relevant information from every contract for a specifc use case, Commercial Contract Review. The data is then structured into a knowledge graph, which organizes key entities and relationships, allowing for more precise graph data retrieval through Cypher queries and vector search.</p><p id="8ffd" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">By minimizing the amount of vectorized content and focusing on highly relevant knowledge extracted, this method enhances the accuracy and performance of the Q&amp;A agent, making it suitable to handle complex and domain-specific questions.</p><p id="a1f3" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">The 4-stage approach includes: targeted information extraction (LLM + Prompt) to create a knowledge graph (LLM + Neo4J) and simple set of graph data retrieval functions (Cypher, Text to Cypher, Vector Search). Finally, a Q&amp;A agent leveraging the data retrieval functions is built with (<a class="af nf" href="https://learn.microsoft.com/en-us/semantic-kernel/overview/" rel="noopener ugc nofollow" target="_blank">Microsoft Semantic Kernel</a>)</p><p id="2b95" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">The diagram below illustrates the approach</p></div></div><div class="ng"><div class="ab cb"><div class="lm nh ln ni lo nj cf nk cg nl ci bh"><figure class="np nq nr ns nt ng nu nv paragraph-image"><div role="button" tabindex="0" class="nw nx ed ny bh nz"><div class="nm nn no"><img src="../Images/c97973ee81561dc36141cd7bcad3a15d.png" data-original-src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*JfjAK7PXH-eRRE7q7o9tVg.png"/></div></div><figcaption class="ob oc od nm nn oe of bf b bg z dx">The 4-stage GraphRAG approach: From question-based extraction -&gt; knowledge graph model-&gt; GraphRAG retrieval -&gt; Q&amp;A Agent. Image by Sebastian Nilsson @ Neo4J, reproduced here with permission from its author.</figcaption></figure></div></div></div><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="2d86" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">But first, for those of us not familiar with commercial law, let’s start with a brief intro to the contract review problem.</p><h1 id="c10e" class="og oh fq bf oi oj ok gq ol om on gt oo op oq or os ot ou ov ow ox oy oz pa pb bk">Contract Review and Large Language Models</h1><p id="4f2e" class="pw-post-body-paragraph mj mk fq ml b go pc mn mo gr pd mq mr ms pe mu mv mw pf my mz na pg nc nd ne fj bk">Commercial contract review is a labor-intensive process involving paralegals and junior lawyers meticulously identifying critical information in a contract.</p><blockquote class="ph pi pj"><p id="e8fe" class="mj mk pk ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">“Contract review is the process of thoroughly reading a contract to understand the rights and obligations of an individual or company signing it and assess the associated impact”. <br/>Hendrycks, Burns et al, NeurIPS 2021, in <a class="af nf" href="https://arxiv.org/pdf/2103.06268" rel="noopener ugc nofollow" target="_blank">CUAD an Expert-Annotated NLP Dataset for Legal Contract Review</a></p></blockquote><p id="9e92" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">The first stage of contract review involves reviewing hundreds of pages of contracts to find the relevant clauses or obligations. Contract reviewers must identify whether relevant clauses exist, what they say if they do exist, and keep track of where they are described.</p><blockquote class="ph pi pj"><p id="1f1c" class="mj mk pk ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">For example, They must determine whether the contract is a 3-year contract or a 1-year contract. They must determine the end date of a contract. They must determine whether a clause is, say, an Anti-assignment or an Exclusivity clause…”<br/>Hendrycks, Burns et al, NeurIPS 2021, in <a class="af nf" href="https://arxiv.org/pdf/2103.06268" rel="noopener ugc nofollow" target="_blank">CUAD an Expert-Annotated NLP Dataset for Legal Contract Review</a></p></blockquote><p id="0ed2" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">It’s a task that demands thoroughness but often suffers from inefficiencies but it is suitable for a Large Language Model!</p><p id="ada6" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Once the first stage is completed, senior law practitioners can start to examine contracts for weaknesses and risks. This is an area where a Q&amp;A agent powered by an LLM and grounded by information stored in Knowledge Graph is a perfect Copilot for a legal expert.</p><h1 id="eda3" class="og oh fq bf oi oj ok gq ol om on gt oo op oq or os ot ou ov ow ox oy oz pa pb bk">A 4-Step Approach to Build a Commercial Contract Review Agent with LLMs, Function Calling &amp; GraphRAG</h1><p id="6937" class="pw-post-body-paragraph mj mk fq ml b go pc mn mo gr pd mq mr ms pe mu mv mw pf my mz na pg nc nd ne fj bk">The remainder of this blog will describe each of the steps in this process. Along the way, I will use code snippets to illustrate the main ideas.</p><p id="d773" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">The four steps are:</p><ol class=""><li id="495a" class="mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne pl pm pn bk"><strong class="ml fr">Extracting Relevant Information from Contracts (LLM + Contract)</strong></li><li id="7813" class="mj mk fq ml b go po mn mo gr pp mq mr ms pq mu mv mw pr my mz na ps nc nd ne pl pm pn bk"><strong class="ml fr">Storing information extracted into a Knowledge Graph (Neo4j)</strong></li><li id="b4f8" class="mj mk fq ml b go po mn mo gr pp mq mr ms pq mu mv mw pr my mz na ps nc nd ne pl pm pn bk"><strong class="ml fr">Developing simple KG Data Retrieval Functions (Python)</strong></li><li id="1af8" class="mj mk fq ml b go po mn mo gr pp mq mr ms pq mu mv mw pr my mz na ps nc nd ne pl pm pn bk"><strong class="ml fr">Building a Q&amp;A Agent handling complex questions (Semantic Kernel, LLM, Neo4j)</strong></li></ol><h1 id="21bb" class="og oh fq bf oi oj ok gq ol om on gt oo op oq or os ot ou ov ow ox oy oz pa pb bk">The Dataset:</h1><p id="9593" class="pw-post-body-paragraph mj mk fq ml b go pc mn mo gr pd mq mr ms pe mu mv mw pf my mz na pg nc nd ne fj bk">The<a class="af nf" href="https://www.atticusprojectai.org/cuad" rel="noopener ugc nofollow" target="_blank"> CUAD (Contract Understanding Atticus Dataset)</a> is a CC BY 4.0 licensed and publicly available dataset of over 13,000 expert-labeled clauses across 510 legal contracts, designed to help build AI models for contract review. It covers a wide range of important legal clauses, such as confidentiality, termination, and indemnity, which are critical for contract analysis.</p><p id="94ee" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">We will use three contracts from this dataset to showcase how our approach to effectively extract and analyze key legal information, building a knowledge graph and leveraging it for precise, complex question answering.</p><p id="fe1e" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">The three contracts combined contain a total of 95 pages.</p><h1 id="345e" class="og oh fq bf oi oj ok gq ol om on gt oo op oq or os ot ou ov ow ox oy oz pa pb bk">Step 1: Extracting Relevant Information from Contracts</h1><p id="37eb" class="pw-post-body-paragraph mj mk fq ml b go pc mn mo gr pd mq mr ms pe mu mv mw pf my mz na pg nc nd ne fj bk">It is relatively straightforward to prompt an LLM to extract precise information from contracts and generate a JSON output, representing the relevant information from the contract.</p><p id="6b3f" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">In commercial review, a prompt can be drafted to to locate each of the critical elements mentioned above — parties, dates, clauses — and summarize them neatly in a machine-readable (JSON) file.</p><p id="10a5" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk"><strong class="ml fr">Extraction Prompt (simplified)</strong></p><blockquote class="ph pi pj"><p id="584d" class="mj mk pk ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Answer the following questions using information exclusively on this contract<br/>[Contract.pdf]</p><p id="a89f" class="mj mk pk ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">1) What type of contract is this?<br/>2) Who are the parties and their roles? Where are they incorporated? Name state and country (use ISO 3166 Country name)<br/>3) What is the Agreement Date?<br/>4) What is the Effective date?</p><p id="8ed7" class="mj mk pk ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">For each of the following types of contract clauses, extract two pieces of information:<br/>a) A Yes/No that indicates if you think the clause is found in this contract<br/>b) A list of excerpts that indicates this clause type exists.</p><p id="afea" class="mj mk pk ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Contract Clause types: Competitive Restriction Exception, Non-Compete Clause, Exclusivity, No-Solicit Of Customers, No-Solicit Of Employees, Non-Disparagement, Termination For Convenience, Rofr/Rofo/Rofn, Change Of Control, Anti-Assignment, Uncapped Liability, Cap On Liability</p><p id="b8c3" class="mj mk pk ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Provide your final answer in a JSON document.</p></blockquote><p id="521a" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Please note that the above section shows a simplified version of the extraction prompt. A full version can be <a class="af nf" href="https://github.com/neo4j-product-examples/graphrag-contract-review/blob/main/prompts/contract_extraction_prompt.txt" rel="noopener ugc nofollow" target="_blank">seen here</a>. You will find that the the last part of the prompt specifies the desired format of the JSON document. This is useful in ensuring a consistent JSON schema output.</p><p id="a2a7" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">This task is relatively simple in Python. The <code class="cx pt pu pv pw b">main()</code>function below is designed to process a set of PDF contract files by extracting relevant legal information (extraction_prompt), using <strong class="ml fr">OpenAI gpt-4o </strong>and saving the results in JSON format.</p><pre class="np nq nr ns nt px pw py bp pz bb bk"><span id="a1f6" class="qa oh fq pw b bg qb qc l qd qe">def main():<br/>    pdf_files = [filename for filename in os.listdir('./data/input/') if filename.endswith('.pdf')]<br/>    <br/>    for pdf_filename in pdf_files:<br/>        print('Processing ' + pdf_filename + '...')    <br/>        # Extract content from PDF using the assistant<br/>        complete_response = process_pdf('./data/input/' + pdf_filename)<br/>        # Log the complete response to debug<br/>        save_json_string_to_file(complete_response, './data/debug/complete_response_' + pdf_filename + '.json')<br/></span></pre><p id="083e" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">The “<strong class="ml fr"><em class="pk">process_pdf</em></strong>” function uses “<strong class="ml fr">OpenAI gpt-4o</strong>” to perform knowledge extraction from the contract with an “extraction prompt”.</p><pre class="np nq nr ns nt px pw py bp pz bb bk"><span id="0a6e" class="qa oh fq pw b bg qb qc l qd qe">def process_pdf(pdf_filename):<br/>    # Create OpenAI message thread<br/>    thread = client.beta.threads.create()<br/>    # Upload PDF file to the thread<br/>    file = client.files.create(file=open(pdf_filename, "rb"), purpose="assistants")<br/>    # Create message with contract as attachment and extraction_prompt<br/>    client.beta.threads.messages.create(thread_id=thread.id,role="user",<br/>        attachments=[<br/>            Attachment(<br/>                file_id=file.id, tools=[AttachmentToolFileSearch(type="file_search")])<br/>        ],<br/>        content=extraction_prompt,<br/>    )<br/>    # Run the message thread<br/>    run = client.beta.threads.runs.create_and_poll(<br/>        thread_id=thread.id, assistant_id=pdf_assistant.id, timeout=1000)<br/>    # Retrieve messages<br/>    messages_cursor = client.beta.threads.messages.list(thread_id=thread.id)<br/>    messages = [message for message in messages_cursor]<br/>    # Return last message in Thread <br/>    return messages[0].content[0].text.value</span></pre><p id="8e3b" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">For each contract, the message returned by <strong class="ml fr">“process_pdf”</strong> looks like</p><pre class="np nq nr ns nt px pw py bp pz bb bk"><span id="ec91" class="qa oh fq pw b bg qb qc l qd qe">{<br/>    "agreement": {<br/>        "agreement_name": "Marketing Affiliate Agreement",<br/>        "agreement_type": "Marketing Affiliate Agreement",<br/>        "effective_date": "May 8, 2014",<br/>        "expiration_date": "December 31, 2014",<br/>        "renewal_term": "1 year",<br/>        "Notice_period_to_Terminate_Renewal": "30 days",<br/>        "parties": [<br/>            {<br/>                "role": "Company",<br/>                "name": "Birch First Global Investments Inc.",<br/>                "incorporation_country": "United States Virgin Islands",<br/>                "incorporation_state": "N/A"<br/>            },<br/>            {<br/>                "role": "Marketing Affiliate",<br/>                "name": "Mount Knowledge Holdings Inc.",<br/>                "incorporation_country": "United States",<br/>                "incorporation_state": "Nevada"<br/>            }<br/>        ],<br/>        "governing_law": {<br/>            "country": "United States",<br/>            "state": "Nevada",<br/>            "most_favored_country": "United States"<br/>        },<br/>        "clauses": [<br/>            {<br/>                "clause_type": "Competitive Restriction Exception",<br/>                "exists": false,<br/>                "excerpts": []<br/>            },<br/>            {<br/>                "clause_type": "Exclusivity",<br/>                "exists": true,<br/>                "excerpts": [<br/>                    "Company hereby grants to MA the right to advertise, market and sell to corporate users, government agencies and educational facilities for their own internal purposes only, not for remarketing or redistribution."<br/>                ]<br/>            },<br/>            {<br/>                "clause_type": "Non-Disparagement",<br/>                "exists": true,<br/>                "excerpts": [<br/>                    "MA agrees to conduct business in a manner that reflects favorably at all times on the Technology sold and the good name, goodwill and reputation of Company."<br/>                ]<br/>            },<br/>            {<br/>                "clause_type": "Termination For Convenience",<br/>                "exists": true,<br/>                "excerpts": [<br/>                    "This Agreement may be terminated by either party at the expiration of its term or any renewal term upon thirty (30) days written notice to the other party."<br/>                ]<br/>            },<br/>            {<br/>                "clause_type": "Anti-Assignment",<br/>                "exists": true,<br/>                "excerpts": [<br/>                    "MA may not assign, sell, lease or otherwise transfer in whole or in part any of the rights granted pursuant to this Agreement without prior written approval of Company."<br/>                ]<br/>            },<br/>            <br/>            {<br/>                "clause_type": "Price Restrictions",<br/>                "exists": true,<br/>                "excerpts": [<br/>                    "Company reserves the right to change its prices and/or fees, from time to time, in its sole and absolute discretion."<br/>                ]<br/>            },<br/>            {<br/>                "clause_type": "Minimum Commitment",<br/>                "exists": true,<br/>                "excerpts": [<br/>                    "MA commits to purchase a minimum of 100 Units in aggregate within the Territory within the first six months of term of this Agreement."<br/>                ]<br/>            },<br/>            <br/>            {<br/>                "clause_type": "IP Ownership Assignment",<br/>                "exists": true,<br/>                "excerpts": [<br/>                    "Title to the Technology and all copyrights in Technology shall remain with Company and/or its Affiliates."<br/>                ]<br/>            },<br/>            <br/>            {<br/>                "clause_type": "License grant",<br/>                "exists": true,<br/>                "excerpts": [<br/>                    "Company hereby grants to MA the right to advertise, market and sell the Technology listed in Schedule A of this Agreement."<br/>                ]<br/>            },<br/>            {<br/>                "clause_type": "Non-Transferable License",<br/>                "exists": true,<br/>                "excerpts": [<br/>                    "MA acknowledges that MA and its Clients receive no title to the Technology contained on the Technology."<br/>                ]<br/>            },<br/>            {<br/>                "clause_type": "Cap On Liability",<br/>                "exists": true,<br/>                "excerpts": [<br/>                    "In no event shall Company be liable to MA, its Clients, or any third party for any tort or contract damages or indirect, special, general, incidental or consequential damages."<br/>                ]<br/>            },<br/>            <br/>            {<br/>                "clause_type": "Warranty Duration",<br/>                "exists": true,<br/>                "excerpts": [<br/>                    "Company's sole and exclusive liability for the warranty provided shall be to correct the Technology to operate in substantial accordance with its then current specifications."<br/>                ]<br/>            }<br/>            <br/>            <br/>        ]<br/>    }<br/>}</span></pre><h1 id="2604" class="og oh fq bf oi oj ok gq ol om on gt oo op oq or os ot ou ov ow ox oy oz pa pb bk">Step 2: Creating a Knowledge Graph</h1><p id="7917" class="pw-post-body-paragraph mj mk fq ml b go pc mn mo gr pd mq mr ms pe mu mv mw pf my mz na pg nc nd ne fj bk">With each contract now as a JSON file, the next step is to create a Knowledge Graph in Neo4J.</p><p id="d006" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">At this point is useful to spend some time designing the data model. You need to consider some key questions:</p><ul class=""><li id="a203" class="mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne qf pm pn bk">What do nodes and relationships in this graph represent?</li><li id="7d0f" class="mj mk fq ml b go po mn mo gr pp mq mr ms pq mu mv mw pr my mz na ps nc nd ne qf pm pn bk">What are the main properties for each node and relationship?,</li><li id="7c33" class="mj mk fq ml b go po mn mo gr pp mq mr ms pq mu mv mw pr my mz na ps nc nd ne qf pm pn bk">Should there be any properties indexed?</li><li id="480c" class="mj mk fq ml b go po mn mo gr pp mq mr ms pq mu mv mw pr my mz na ps nc nd ne qf pm pn bk">Which properties need vector embeddings to enable semantic similarity search on them?</li></ul><p id="e158" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">In our case, a suitable design (schema) includes the main entities: Agreements (contracts), their clauses, the organizations who are parties to the agreement and the relationships amongst them.</p><p id="4c39" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">A visual representation of the schema is shown below.</p><figure class="np nq nr ns nt ng nm nn paragraph-image"><div role="button" tabindex="0" class="nw nx ed ny bh nz"><div class="nm nn qg"><img src="../Images/28f50df8abdbf7e7816523de25b5bfaf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6pLCoA53cwIpGtm-YLwY_g.png"/></div></div><figcaption class="ob oc od nm nn oe of bf b bg z dx">Image by the Author</figcaption></figure><pre class="np nq nr ns nt px pw py bp pz bb bk"><span id="3610" class="qa oh fq pw b bg qb qc l qd qe"><br/>Node properties:<br/>Agreement {agreement_type: STRING, contract_id: INTEGER,<br/>          effective_date: STRING, expiration_date: STRING,<br/>          renewal_term: STRING, name: STRING}<br/>ContractClause {name: STRING, type: STRING}<br/>ClauseType {name: STRING}<br/>Country {name: STRING}<br/>Excerpt {text: STRING}<br/>Organization {name: STRING}<br/><br/>Relationship properties:<br/>IS_PARTY_TO {role: STRING}<br/>GOVERNED_BY_LAW {state: STRING}<br/>HAS_CLAUSE {type: STRING}<br/>INCORPORATED_IN {state: STRING}<br/><br/></span></pre><p id="3baa" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Only the “Excerpts” — the short text pieces identified by the LLM in Step 1 — require text embeddings. This approach dramatically reduces the number of vectors and the size of the vector index needed to represent each contract, making the process more efficient and scalable.</p><p id="b2bf" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">A simplified version of a python script loading each JSON into a Knowledge Graph with the above schema looks like</p><pre class="np nq nr ns nt px pw py bp pz bb bk"><span id="e690" class="qa oh fq pw b bg qb qc l qd qe">NEO4J_URI=os.getenv('NEO4J_URI', 'bolt://localhost:7687')<br/>NEO4J_USER=os.getenv('NEO4J_USERNAME', 'neo4j')<br/>NEO4J_PASSWORD=os.getenv('NEO4J_PASSWORD')<br/>OPENAI_API_KEY = os.getenv('OPENAI_API_KEY')<br/>JSON_CONTRACT_FOLDER = './data/output/'<br/><br/>driver = GraphDatabase.driver(NEO4J_URI, auth=(NEO4J_USER, NEO4J_PASSWORD))<br/><br/>contract_id = 1<br/><br/>json_contracts = [filename for filename in os.listdir(JSON_CONTRACT_FOLDER) if filename.endswith('.json')]<br/>for json_contract in json_contracts:<br/>  with open(JSON_CONTRACT_FOLDER + json_contract,'r') as file:<br/>    json_string = file.read()<br/>    json_data = json.loads(json_string)<br/>    agreement = json_data['agreement']<br/>    agreement['contract_id'] = contract_id<br/>    driver.execute_query(CREATE_GRAPH_STATEMENT,  data=json_data)<br/>    contract_id+=1<br/><br/>create_full_text_indices(driver)<br/>driver.execute_query(CREATE_VECTOR_INDEX_STATEMENT)<br/>print ("Generating Embeddings for Contract Excerpts...")<br/>driver.execute_query(EMBEDDINGS_STATEMENT, token = OPENAI_API_KEY)</span></pre><p id="69d3" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Here the “<strong class="ml fr">CREATE_GRAPH_STATEMENT</strong>” is the only “complex” piece. It is a CYPHER statement that maps the Contract (JSON) into the nodes and relationships in the Knowledge Graph.</p><p id="9e4c" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">The full Cypher statement is below</p><pre class="np nq nr ns nt px pw py bp pz bb bk"><span id="e9d1" class="qa oh fq pw b bg qb qc l qd qe">CREATE_GRAPH_STATEMENT = """<br/>WITH $data AS data<br/>WITH data.agreement as a<br/><br/>MERGE (agreement:Agreement {contract_id: a.contract_id})<br/>ON CREATE SET <br/>  agreement.contract_id  = a.contract_id,<br/>  agreement.name = a.agreement_name,<br/>  agreement.effective_date = a.effective_date,<br/>  agreement.expiration_date = a.expiration_date,<br/>  agreement.agreement_type = a.agreement_type,<br/>  agreement.renewal_term = a.renewal_term,<br/>  agreement.most_favored_country = a.governing_law.most_favored_country<br/>  //agreement.Notice_period_to_Terminate_Renewal = a.Notice_period_to_Terminate_Renewal<br/><br/>MERGE (gl_country:Country {name: a.governing_law.country})<br/>MERGE (agreement)-[gbl:GOVERNED_BY_LAW]-&gt;(gl_country)<br/>SET gbl.state = a.governing_law.state<br/><br/><br/>FOREACH (party IN a.parties |<br/>  // todo proper global id for the party<br/>  MERGE (p:Organization {name: party.name})<br/>  MERGE (p)-[ipt:IS_PARTY_TO]-&gt;(agreement)<br/>  SET ipt.role = party.role<br/>  MERGE (country_of_incorporation:Country {name: party.incorporation_country})<br/>  MERGE (p)-[incorporated:INCORPORATED_IN]-&gt;(country_of_incorporation)<br/>  SET incorporated.state = party.incorporation_state<br/>)<br/><br/>WITH a, agreement, [clause IN a.clauses WHERE clause.exists = true] AS valid_clauses<br/>FOREACH (clause IN valid_clauses |<br/>  CREATE (cl:ContractClause {type: clause.clause_type})<br/>  MERGE (agreement)-[clt:HAS_CLAUSE]-&gt;(cl)<br/>  SET clt.type = clause.clause_type<br/>  // ON CREATE SET c.excerpts = clause.excerpts<br/>  FOREACH (excerpt IN clause.excerpts |<br/>    MERGE (cl)-[:HAS_EXCERPT]-&gt;(e:Excerpt {text: excerpt})<br/>  )<br/>  //link clauses to a Clause Type label<br/>  MERGE (clType:ClauseType{name: clause.clause_type})<br/>  MERGE (cl)-[:HAS_TYPE]-&gt;(clType)<br/>)"""</span></pre><p id="feb9" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Here’s a breakdown of what the statement does:</p><h2 id="d5ff" class="qh oh fq bf oi qi qj qk ol ql qm qn oo ms qo qp qq mw qr qs qt na qu qv qw qx bk">Data Binding</h2><pre class="np nq nr ns nt px pw py bp pz bb bk"><span id="a429" class="qa oh fq pw b bg qb qc l qd qe">WITH $data AS data<br/>WITH data.agreement as a</span></pre><ul class=""><li id="801e" class="mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne qf pm pn bk"><code class="cx pt pu pv pw b">$data</code> is the input data being passed into the query in JSON format. It contains information about an agreement (contract).</li><li id="268d" class="mj mk fq ml b go po mn mo gr pp mq mr ms pq mu mv mw pr my mz na ps nc nd ne qf pm pn bk">The second line assigns <code class="cx pt pu pv pw b">data.agreement</code> to the alias <code class="cx pt pu pv pw b">a</code>, so the contract details can be referenced in the subsequent query.</li></ul><h2 id="4c51" class="qh oh fq bf oi qi qj qk ol ql qm qn oo ms qo qp qq mw qr qs qt na qu qv qw qx bk"><strong class="al">Upsert the Agreement Node</strong></h2><pre class="np nq nr ns nt px pw py bp pz bb bk"><span id="7517" class="qa oh fq pw b bg qb qc l qd qe">MERGE (agreement:Agreement {contract_id: a.contract_id})<br/>ON CREATE SET <br/>  agreement.name = a.agreement_name,<br/>  agreement.effective_date = a.effective_date,<br/>  agreement.expiration_date = a.expiration_date,<br/>  agreement.agreement_type = a.agreement_type,<br/>  agreement.renewal_term = a.renewal_term,<br/>  agreement.most_favored_country = a.governing_law.most_favored_country</span></pre><ul class=""><li id="7340" class="mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne qf pm pn bk"><code class="cx pt pu pv pw b">MERGE</code> attempts to find an existing <code class="cx pt pu pv pw b">Agreement</code> node with the specified <code class="cx pt pu pv pw b">contract_id</code>. If no such node exists, it creates one.</li><li id="96fc" class="mj mk fq ml b go po mn mo gr pp mq mr ms pq mu mv mw pr my mz na ps nc nd ne qf pm pn bk">The <code class="cx pt pu pv pw b">ON CREATE SET</code> clause sets various properties on the newly created <code class="cx pt pu pv pw b">Agreement</code> node, such as <code class="cx pt pu pv pw b">contract_id</code>, <code class="cx pt pu pv pw b">agreement_name</code>, <code class="cx pt pu pv pw b">effective_date</code>, and other agreement-related fields from the JSON input.</li></ul><h2 id="6b40" class="qh oh fq bf oi qi qj qk ol ql qm qn oo ms qo qp qq mw qr qs qt na qu qv qw qx bk"><strong class="al">Create Governing Law Relationship</strong></h2><pre class="np nq nr ns nt px pw py bp pz bb bk"><span id="beb2" class="qa oh fq pw b bg qb qc l qd qe">MERGE (gl_country:Country {name: a.governing_law.country})<br/>MERGE (agreement)-[gbl:GOVERNED_BY_LAW]-&gt;(gl_country)<br/>SET gbl.state = a.governing_law.state</span></pre><ul class=""><li id="1c39" class="mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne qf pm pn bk">This creates or merges a <code class="cx pt pu pv pw b">Country</code> node for the governing law country associated with the agreement.</li><li id="a2f9" class="mj mk fq ml b go po mn mo gr pp mq mr ms pq mu mv mw pr my mz na ps nc nd ne qf pm pn bk">Then, it creates or merges a relationship <code class="cx pt pu pv pw b">GOVERNED_BY_LAW</code> between the <code class="cx pt pu pv pw b">Agreement</code> and <code class="cx pt pu pv pw b">Country</code>.</li><li id="5f48" class="mj mk fq ml b go po mn mo gr pp mq mr ms pq mu mv mw pr my mz na ps nc nd ne qf pm pn bk">It also sets the <code class="cx pt pu pv pw b">state</code> property of the <code class="cx pt pu pv pw b">GOVERNED_BY_LAW</code> relationship</li></ul><h2 id="d0de" class="qh oh fq bf oi qi qj qk ol ql qm qn oo ms qo qp qq mw qr qs qt na qu qv qw qx bk"><strong class="al">Create Party and Incorporation Relationships</strong></h2><pre class="np nq nr ns nt px pw py bp pz bb bk"><span id="9b19" class="qa oh fq pw b bg qb qc l qd qe">FOREACH (party IN a.parties |<br/>  MERGE (p:Organization {name: party.name})<br/>  MERGE (p)-[ipt:IS_PARTY_TO]-&gt;(agreement)<br/>  SET ipt.role = party.role<br/>  MERGE (country_of_incorporation:Country {name: party.incorporation_country})<br/>  MERGE (p)-[incorporated:INCORPORATED_IN]-&gt;(country_of_incorporation)<br/>  SET incorporated.state = party.incorporation_state<br/>)</span></pre><p id="1f1a" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">For each party in the contract (<code class="cx pt pu pv pw b">a.parties</code>), it:</p><ul class=""><li id="e282" class="mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne qf pm pn bk">Upserts (Merge) an <code class="cx pt pu pv pw b">Organization</code> node for the party.</li><li id="597a" class="mj mk fq ml b go po mn mo gr pp mq mr ms pq mu mv mw pr my mz na ps nc nd ne qf pm pn bk">Creates an <code class="cx pt pu pv pw b">IS_PARTY_TO</code> relationship between the <code class="cx pt pu pv pw b">Organization</code> and the <code class="cx pt pu pv pw b">Agreement</code>, setting the <code class="cx pt pu pv pw b">role</code> of the party (e.g., buyer, seller).</li><li id="4ad2" class="mj mk fq ml b go po mn mo gr pp mq mr ms pq mu mv mw pr my mz na ps nc nd ne qf pm pn bk">Merges a <code class="cx pt pu pv pw b">Country</code> node for the country in which the organization is incorporated.</li><li id="6cfd" class="mj mk fq ml b go po mn mo gr pp mq mr ms pq mu mv mw pr my mz na ps nc nd ne qf pm pn bk">Creates an <code class="cx pt pu pv pw b">INCORPORATED_IN</code> relationship between the organization and the incorporation country, and sets the <code class="cx pt pu pv pw b">state</code> where the organization is incorporated</li></ul><h2 id="285b" class="qh oh fq bf oi qi qj qk ol ql qm qn oo ms qo qp qq mw qr qs qt na qu qv qw qx bk"><strong class="al">Create Contract Clauses and Excerpts</strong></h2><pre class="np nq nr ns nt px pw py bp pz bb bk"><span id="af8e" class="qa oh fq pw b bg qb qc l qd qe">WITH a, agreement, [clause IN a.clauses WHERE clause.exists = true] AS valid_clauses<br/>FOREACH (clause IN valid_clauses |<br/>  CREATE (cl:ContractClause {type: clause.clause_type})<br/>  MERGE (agreement)-[clt:HAS_CLAUSE]-&gt;(cl)<br/>  SET clt.type = clause.clause_type<br/>  FOREACH (excerpt IN clause.excerpts |<br/>    MERGE (cl)-[:HAS_EXCERPT]-&gt;(e:Excerpt {text: excerpt})<br/>  )<br/>  MERGE (clType:ClauseType{name: clause.clause_type})<br/>  MERGE (cl)-[:HAS_TYPE]-&gt;(clType)<br/>)</span></pre><ul class=""><li id="75b1" class="mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne qf pm pn bk">This part first filters the list of clauses (<code class="cx pt pu pv pw b">a.clauses</code>) to include only those where <code class="cx pt pu pv pw b">clause.exists = true</code> (i.e., clauses with excerpts identified by the LLM in Step 1)</li><li id="56b9" class="mj mk fq ml b go po mn mo gr pp mq mr ms pq mu mv mw pr my mz na ps nc nd ne qf pm pn bk">For each clause:</li><li id="f82b" class="mj mk fq ml b go po mn mo gr pp mq mr ms pq mu mv mw pr my mz na ps nc nd ne qf pm pn bk">It creates a <code class="cx pt pu pv pw b">ContractClause</code> node with a <code class="cx pt pu pv pw b">name</code> and <code class="cx pt pu pv pw b">type</code> corresponding to the clause type.</li><li id="4a3c" class="mj mk fq ml b go po mn mo gr pp mq mr ms pq mu mv mw pr my mz na ps nc nd ne qf pm pn bk">A <code class="cx pt pu pv pw b">HAS_CLAUSE</code> relationship is established between the <code class="cx pt pu pv pw b">Agreement</code> and the <code class="cx pt pu pv pw b">ContractClause</code>.</li><li id="edd0" class="mj mk fq ml b go po mn mo gr pp mq mr ms pq mu mv mw pr my mz na ps nc nd ne qf pm pn bk">For each <code class="cx pt pu pv pw b">excerpt</code> associated with the clause, it creates an <code class="cx pt pu pv pw b">Excerpt</code> node and links it to the <code class="cx pt pu pv pw b">ContractClause</code> using a <code class="cx pt pu pv pw b">HAS_EXCERPT</code> relationship.</li><li id="c0c6" class="mj mk fq ml b go po mn mo gr pp mq mr ms pq mu mv mw pr my mz na ps nc nd ne qf pm pn bk">Finally, a <code class="cx pt pu pv pw b">ClauseType</code> node is created (or merged) for the type of the clause, and the <code class="cx pt pu pv pw b">ContractClause</code> is linked to the <code class="cx pt pu pv pw b">ClauseType</code> using a <code class="cx pt pu pv pw b">HAS_TYPE</code> relationship.</li></ul><p id="6b63" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Once the import script runs, a single contract can be visualized in Neo4J as a Knowledge Graph</p><figure class="np nq nr ns nt ng nm nn paragraph-image"><div role="button" tabindex="0" class="nw nx ed ny bh nz"><div class="nm nn qy"><img src="../Images/f3dd8827f94f0b3130da91d1104f56b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E5aJtu_RLBszOYCtMG2tbw.png"/></div></div><figcaption class="ob oc od nm nn oe of bf b bg z dx">A Knowledge Graph representation of a single Contract: Parties (organizations) in green, Contract Clauses in blue, Excerpts in light brown, Countries in orange. Image by the Author</figcaption></figure><p id="0cdb" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">The three contracts in the knowledge graph required only a small graph (under 100 nodes and less than 200 relationships). Most importantly, only 40–50 vector embeddings for the Excerpts are needed. This knowledge graph with a small number of vectors can now be used to power a reasonably powerful Q&amp;A agent.</p><h1 id="e1bb" class="og oh fq bf oi oj ok gq ol om on gt oo op oq or os ot ou ov ow ox oy oz pa pb bk">Step 3: Developing data retrieval functions for GraphRAG</h1><p id="b6ba" class="pw-post-body-paragraph mj mk fq ml b go pc mn mo gr pd mq mr ms pe mu mv mw pf my mz na pg nc nd ne fj bk">With the contracts now structured in a Knowledge Graph, the next step involves creating a small set of graph data retrieval functions. These functions serve as the core building blocks, allowing us to develop a Q&amp;A agent in step 4.</p><p id="3024" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Let’s define a few basic data retrieval functions:</p><ol class=""><li id="31b5" class="mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne pl pm pn bk">Retrieve basic details about a contract (given a contract ID)</li><li id="aad7" class="mj mk fq ml b go po mn mo gr pp mq mr ms pq mu mv mw pr my mz na ps nc nd ne pl pm pn bk">Find contracts involving a specific organization (given a partial organization name)</li><li id="530d" class="mj mk fq ml b go po mn mo gr pp mq mr ms pq mu mv mw pr my mz na ps nc nd ne pl pm pn bk">Find contracts that <strong class="ml fr">DO NOT </strong>contain a particular clause type</li><li id="6dfe" class="mj mk fq ml b go po mn mo gr pp mq mr ms pq mu mv mw pr my mz na ps nc nd ne pl pm pn bk">Find contracts contain a specific type of clause</li><li id="26b1" class="mj mk fq ml b go po mn mo gr pp mq mr ms pq mu mv mw pr my mz na ps nc nd ne pl pm pn bk">Find contracts based on the semantic similarity with the text (Excerpt) in a clause (e.g., contracts mentioning the use of “prohibited items”)</li><li id="77c7" class="mj mk fq ml b go po mn mo gr pp mq mr ms pq mu mv mw pr my mz na ps nc nd ne pl pm pn bk">Run a natural language query against all contracts in the database. For example, an aggregation query that counts “how many contracts meet certain conditions”.</li></ol><p id="6398" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">In step 4, we will build a Q&amp;A using the <a class="af nf" href="https://learn.microsoft.com/en-us/semantic-kernel/overview/" rel="noopener ugc nofollow" target="_blank">Microsoft Semantic Kernel library</a>. This library simplifies the agent building process. It allows developers to define the functions and tools that an Agent will have at its disposal to answer a question.</p><p id="a772" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">In order to simplify the integration between Neo4J and the Semantic Kernel library, let’s define a <code class="cx pt pu pv pw b">ContractPlugin</code> that defines the “signature” of each our data retrieval functions. Note the <code class="cx pt pu pv pw b">@kernel_function</code> decorator for each of the functions and also the type information and description provided for each function.</p><p id="ceb2" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Semantic Kernel uses the concept of a “<strong class="ml fr">Plugin</strong>” class to encapsulate a group of functions available to an Agent. It will use the decorated functions, type information and documentation to inform the LLM function calling capabilities about functions available.</p><pre class="np nq nr ns nt px pw py bp pz bb bk"><span id="cf2e" class="qa oh fq pw b bg qb qc l qd qe">from typing import List, Optional, Annotated<br/>from AgreementSchema import Agreement, ClauseType<br/>from semantic_kernel.functions import kernel_function<br/>from ContractService import  ContractSearchService<br/><br/>class ContractPlugin:<br/>    def __init__(self, contract_search_service: ContractSearchService ):<br/>        self.contract_search_service = contract_search_service<br/>    <br/>    @kernel_function<br/>    async def get_contract(self, contract_id: int) -&gt; Annotated[Agreement, "A contract"]:<br/>        """Gets details about a contract with the given id."""<br/>        return await self.contract_search_service.get_contract(contract_id)<br/><br/>    @kernel_function<br/>    async def get_contracts(self, organization_name: str) -&gt; Annotated[List[Agreement], "A list of contracts"]:<br/>        """Gets basic details about all contracts where one of the parties has a name similar to the given organization name."""<br/>        return await self.contract_search_service.get_contracts(organization_name)<br/>    <br/>    @kernel_function<br/>    async def get_contracts_without_clause(self, clause_type: ClauseType) -&gt; Annotated[List[Agreement], "A list of contracts"]:<br/>        """Gets basic details from contracts without a clause of the given type."""<br/>        return await self.contract_search_service.get_contracts_without_clause(clause_type=clause_type)<br/>    <br/>    @kernel_function<br/>    async def get_contracts_with_clause_type(self, clause_type: ClauseType) -&gt; Annotated[List[Agreement], "A list of contracts"]:<br/>        """Gets basic details from contracts with a clause of the given type."""<br/>        return await self.contract_search_service.get_contracts_with_clause_type(clause_type=clause_type)<br/><br/>    @kernel_function<br/>    async def get_contracts_similar_text(self, clause_text: str) -&gt; Annotated[List[Agreement], "A list of contracts with similar text in one of their clauses"]:<br/>        """Gets basic details from contracts having semantically similar text in one of their clauses to the to the 'clause_text' provided."""<br/>        return await self.contract_search_service.get_contracts_similar_text(clause_text=clause_text)<br/>    <br/>    @kernel_function<br/>    async def answer_aggregation_question(self, user_question: str) -&gt; Annotated[str, "An answer to user_question"]:<br/>        """Answer obtained by turning user_question into a CYPHER query"""<br/>        return await self.contract_search_service.answer_aggregation_question(user_question=user_question)</span></pre><p id="2adc" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">I would recommend exploring the <a class="af nf" href="https://github.com/neo4j-product-examples/graphrag-contract-review/blob/main/ContractService.py" rel="noopener ugc nofollow" target="_blank">“ContractService”</a> class that contains the implementations of each of the above functions. Each function exercises a a different data retrieval technique.</p><p id="aeb4" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Let’s walk through the implementation of some of these functions as they showcase different GraphRAG data retrieval techniques / patterns</p><h2 id="5356" class="qh oh fq bf oi qi qj qk ol ql qm qn oo ms qo qp qq mw qr qs qt na qu qv qw qx bk">Get Contract (from contract ID) — A Cypher-based retrieval function</h2><p id="4cb1" class="pw-post-body-paragraph mj mk fq ml b go pc mn mo gr pd mq mr ms pe mu mv mw pf my mz na pg nc nd ne fj bk">The <code class="cx pt pu pv pw b">get_contract(self, contract_id: int)</code>, is an asynchronous method designed to retrieve details about a specific contract (<code class="cx pt pu pv pw b">Agreement</code>) from a Neo4J database using a Cypher query. The function returns an <code class="cx pt pu pv pw b">Agreement</code> object populated with information about the agreement, clauses, parties, and their relationships.</p><p id="ed6c" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Here’s the implementation of this function</p><pre class="np nq nr ns nt px pw py bp pz bb bk"><span id="77c4" class="qa oh fq pw b bg qb qc l qd qe">async def get_contract(self, contract_id: int) -&gt; Agreement:<br/>        <br/>        GET_CONTRACT_BY_ID_QUERY = """<br/>            MATCH (a:Agreement {contract_id: $contract_id})-[:HAS_CLAUSE]-&gt;(clause:ContractClause)<br/>            WITH a, collect(clause) as clauses<br/>            MATCH (country:Country)-[i:INCORPORATED_IN]-(p:Organization)-[r:IS_PARTY_TO]-(a)<br/>            WITH a, clauses, collect(p) as parties, collect(country) as countries, collect(r) as roles, collect(i) as states<br/>            RETURN a as agreement, clauses, parties, countries, roles, states<br/>        """<br/>        <br/>        agreement_node = {}<br/>        <br/>        records, _, _  = self._driver.execute_query(GET_CONTRACT_BY_ID_QUERY,{'contract_id':contract_id})<br/><br/>        if (len(records)==1):<br/>            agreement_node =    records[0].get('agreement')<br/>            party_list =        records[0].get('parties')<br/>            role_list =         records[0].get('roles')<br/>            country_list =      records[0].get('countries')<br/>            state_list =        records[0].get('states')<br/>            clause_list =       records[0].get('clauses')<br/>        <br/>        return await self._get_agreement(<br/>            agreement_node, format="long",<br/>            party_list=party_list, role_list=role_list,<br/>            country_list=country_list,state_list=state_list,<br/>            clause_list=clause_list<br/>        )</span></pre><p id="8f0e" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">The most important component is the The Cypher query in <code class="cx pt pu pv pw b"><strong class="ml fr">GET_CONTRACT_BY_ID_QUERY</strong></code> This query is executed using <strong class="ml fr">contract_id</strong> supplied as input parameter. The output is the matching Agreement, its clauses and parties involved (each party has a role and country/state of incorporation)</p><p id="2335" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">The data is then passed to an utility function <code class="cx pt pu pv pw b">_get_agreement</code>which simply maps the data to an “Agreement”. The agreement is a TypedDict defined as</p><pre class="np nq nr ns nt px pw py bp pz bb bk"><span id="a793" class="qa oh fq pw b bg qb qc l qd qe">class Agreement(TypedDict):  <br/>    contract_id: int<br/>    agreement_name: str<br/>    agreement_type: str<br/>    effective_date: str<br/>    expiration_date: str<br/>    renewal_term: str<br/>    notice_period_to_terminate_Renewal: str<br/>    parties: List[Party]<br/>    clauses: List[ContractClause]</span></pre><h2 id="0764" class="qh oh fq bf oi qi qj qk ol ql qm qn oo ms qo qp qq mw qr qs qt na qu qv qw qx bk">Get Contracts WITHOUT a Clause type — Another Cypher retrieval function</h2><p id="b1fd" class="pw-post-body-paragraph mj mk fq ml b go pc mn mo gr pd mq mr ms pe mu mv mw pf my mz na pg nc nd ne fj bk">This function illustrate a powerful feature of a knowledge graph, which is to test for the absence of a relationship.</p><p id="d4c3" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">The <code class="cx pt pu pv pw b">get_contracts_without_clause()</code> function retrieves all contracts (<code class="cx pt pu pv pw b">Agreements</code>) from the Neo4J database that <strong class="ml fr">do not</strong> contain a specific type of clause. The function takes a <code class="cx pt pu pv pw b">ClauseType</code> as input and returns a list of <code class="cx pt pu pv pw b">Agreement</code> objects that match the condition.</p><p id="0afd" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">This type of data retrieval information can’t be easily implemented with vector search. The full implementation follows</p><pre class="np nq nr ns nt px pw py bp pz bb bk"><span id="955d" class="qa oh fq pw b bg qb qc l qd qe">async def get_contracts_without_clause(self, clause_type: ClauseType) -&gt; List[Agreement]:<br/>        GET_CONTRACT_WITHOUT_CLAUSE_TYPE_QUERY = """<br/>            MATCH (a:Agreement)<br/>            OPTIONAL MATCH (a)-[:HAS_CLAUSE]-&gt;(cc:ContractClause {type: $clause_type})<br/>            WITH a,cc<br/>            WHERE cc is NULL<br/>            WITH a<br/>            MATCH (country:Country)-[i:INCORPORATED_IN]-(p:Organization)-[r:IS_PARTY_TO]-(a)<br/>            RETURN a as agreement, collect(p) as parties, collect(r) as roles, collect(country) as countries, collect(i) as states<br/>        """<br/>       <br/>        #run the Cypher query<br/>        records, _ , _ = self._driver.execute_query(GET_CONTRACT_WITHOUT_CLAUSE_TYPE_QUERY,{'clause_type':clause_type.value})<br/><br/>        all_agreements = []<br/>        for row in records:<br/>            agreement_node =  row['agreement']<br/>            party_list =  row['parties']<br/>            role_list =  row['roles']<br/>            country_list = row['countries']<br/>            state_list = row['states']<br/>            agreement : Agreement = await self._get_agreement(<br/>                format="short",<br/>                agreement_node=agreement_node,<br/>                party_list=party_list,<br/>                role_list=role_list,<br/>                country_list=country_list,<br/>                state_list=state_list<br/>            )<br/>            all_agreements.append(agreement)<br/>        return all_agreements</span></pre><p id="faaf" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Once again, the format is similar to the previous function. A Cypher query,<code class="cx pt pu pv pw b"><strong class="ml fr">GET_CONTRACTS_WITHOUT_CLAUSE_TYPE_QUERY</strong></code> , defines the nodes and relationship patterns to be matched. It performs an <strong class="ml fr">optional match</strong> to filters out contracts that do contain a clause type, and collects related data about the agreement, such as the involved parties and their details.</p><p id="5422" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">The function then constructs and returns a list of <code class="cx pt pu pv pw b">Agreement</code> objects, which encapsulate all the relevant information for each matching agreement.</p><h2 id="7691" class="qh oh fq bf oi qi qj qk ol ql qm qn oo ms qo qp qq mw qr qs qt na qu qv qw qx bk">Get Contract with Semantically Similar Text — A Vector-Search + Graph data retrieval function</h2><p id="fbc8" class="pw-post-body-paragraph mj mk fq ml b go pc mn mo gr pd mq mr ms pe mu mv mw pf my mz na pg nc nd ne fj bk">The <code class="cx pt pu pv pw b">get_contracts_similar_text()</code> function is designed to find agreements (contracts) that contain clauses with text similar to a provided <code class="cx pt pu pv pw b">clause_text</code>. It uses semantic vector search to identify related Excerpts and then traverses the graph to return information about the corresponding agreements and clauses, where those excerpts came from.</p><p id="db45" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">This function leverages a vector index defined on the “text” property of each Excerpt. It uses the recently released <a class="af nf" href="https://neo4j.com/blog/graphrag-python-package/" rel="noopener ugc nofollow" target="_blank">Neo4J GraphRAG package</a> to simplify the Cypher code needed to run semantic search + Graph traversal code.</p><pre class="np nq nr ns nt px pw py bp pz bb bk"><span id="912a" class="qa oh fq pw b bg qb qc l qd qe">async def get_contracts_similar_text(self, clause_text: str) -&gt; List[Agreement]:<br/><br/>        #Cypher to traverse from the semantically similar excerpts back to the agreement<br/>        EXCERPT_TO_AGREEMENT_TRAVERSAL_QUERY="""<br/>            MATCH (a:Agreement)-[:HAS_CLAUSE]-&gt;(cc:ContractClause)-[:HAS_EXCERPT]-(node) <br/>            RETURN a.name as agreement_name, a.contract_id as contract_id, cc.type as clause_type, node.text as excerpt<br/>        """<br/>        <br/>        #Set up vector Cypher retriever<br/>        retriever = VectorCypherRetriever(<br/>            driver= self._driver,  <br/>            index_name="excerpt_embedding",<br/>            embedder=self._openai_embedder, <br/>            retrieval_query=EXCERPT_TO_AGREEMENT_TRAVERSAL_QUERY,<br/>            result_formatter=my_vector_search_excerpt_record_formatter<br/>        )<br/>        <br/>        # run vector search query on excerpts and get results containing the relevant agreement and clause <br/>        retriever_result = retriever.search(query_text=clause_text, top_k=3)<br/><br/>        #set up List of Agreements (with partial data) to be returned<br/>        agreements = []<br/>        for item in retriever_result.items:<br/>            //extract information from returned items and append agreement to results<br/>            // full code not shown here but available on the Github repo<br/>            <br/><br/>        return agreements</span></pre><p id="302a" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Let’s go over the main components of this data retrieval function</p><ul class=""><li id="84ce" class="mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne qf pm pn bk">The Neo4j GraphRAG <strong class="ml fr">VectorCypherRetriever </strong>allows a developer to perform semantic similarity on a vector index. In our case, for each semantically similar Excerpt “node” found, an additional Cypher expression is used to fetch additional nodes in the graph related to the node.</li><li id="213e" class="mj mk fq ml b go po mn mo gr pp mq mr ms pq mu mv mw pr my mz na ps nc nd ne qf pm pn bk">The parameters of the <strong class="ml fr">VectorCypherRetriever are </strong>straightforward. The <code class="cx pt pu pv pw b">index_name</code> is the vector index on which to run semantic similarity. The <code class="cx pt pu pv pw b">embedder</code> generates a vector embedding for a piece of text. The <code class="cx pt pu pv pw b">driver</code> is just an instance of a Neo4j Python driver. The <code class="cx pt pu pv pw b">retrieval_query</code> specify the additional nodes and relationships connected with ever “Excerpt” node identified by semantic similarity</li><li id="4c0c" class="mj mk fq ml b go po mn mo gr pp mq mr ms pq mu mv mw pr my mz na ps nc nd ne qf pm pn bk">The <code class="cx pt pu pv pw b">EXCERPT_TO_AGREEMENT_TRAVERSAL_QUERY</code><br/>specifies the additional nodes to be retrieved. In this case, for every Excerpt, we are retrieving its related Contract Clause and corresponding Agreement</li></ul><pre class="np nq nr ns nt px pw py bp pz bb bk"><span id="e072" class="qa oh fq pw b bg qb qc l qd qe">EXCERPT_TO_AGREEMENT_TRAVERSAL_QUERY="""<br/>  MATCH (a:Agreement)-[:HAS_CLAUSE]-&gt;(cc:ContractClause)-[:HAS_EXCERPT]-(node) <br/>  RETURN a.name as agreement_name, a.contract_id as contract_id, cc.type as clause_type, node.text as excerpt<br/>"""</span></pre><h2 id="96f9" class="qh oh fq bf oi qi qj qk ol ql qm qn oo ms qo qp qq mw qr qs qt na qu qv qw qx bk">Run a Natural Language Query — A Text 2Cypher data retrieval function</h2><p id="51e4" class="pw-post-body-paragraph mj mk fq ml b go pc mn mo gr pd mq mr ms pe mu mv mw pf my mz na pg nc nd ne fj bk">The <code class="cx pt pu pv pw b">answer_aggregation_question()</code> function leverages Neo4j GraphRAG package “Text2CypherRetriever” to answer a question in natural language. The Text2CypherRetriever uses an LLM to turn the user question into a Cypher query and runs it against the Neo4j database.</p><p id="e13b" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">The function leverages <strong class="ml fr">OpenAI gpt-4o</strong> to generate the required Cypher query. Let’s walk through the main components of this data retrieval function.</p><pre class="np nq nr ns nt px pw py bp pz bb bk"><span id="68b9" class="qa oh fq pw b bg qb qc l qd qe"> async def answer_aggregation_question(self, user_question) -&gt; str:<br/>        answer = ""<br/><br/><br/>        NEO4J_SCHEMA = """<br/>            omitted for brevity (see below for the full value)<br/>        """<br/><br/>        # Initialize the retriever<br/>        retriever = Text2CypherRetriever(<br/>            driver=self._driver,<br/>            llm=self._llm,<br/>            neo4j_schema=NEO4J_SCHEMA<br/>        )<br/><br/>        # Generate a Cypher query using the LLM, send it to the Neo4j database, and return the results<br/>        retriever_result = retriever.search(query_text=user_question)<br/><br/>        for item in retriever_result.items:<br/>            content = str(item.content)<br/>            if content:<br/>                answer += content + '\n\n'<br/><br/>        return answer</span></pre><p id="593c" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">This function leverages Neo4j GraphRAG package “<strong class="ml fr">Text2CypherRetriever</strong>”. It uses an LLM, in this case OpenAI LLM is used to turn a user question (natural language) into a Cypher query that is executed against the database. The result of this query is returned.</p><p id="1965" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">A key element to ensure that the LLM generates a query that uses the nodes, relationships and properties defined in the database is to provide the LLM with a text description of the schema.</p><p id="fa3e" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">In our case, we used the following representation of the data model is sufficient.</p><pre class="np nq nr ns nt px pw py bp pz bb bk"><span id="c91b" class="qa oh fq pw b bg qb qc l qd qe">NEO4J_SCHEMA = """<br/>Node properties:<br/>Agreement {agreement_type: STRING, contract_id: INTEGER,effective_date: STRING,renewal_term: STRING, name: STRING}<br/>ContractClause {name: STRING, type: STRING}<br/>ClauseType {name: STRING}<br/>Country {name: STRING}<br/>Excerpt {text: STRING}<br/>Organization {name: STRING}<br/><br/>Relationship properties:<br/>IS_PARTY_TO {role: STRING}<br/>GOVERNED_BY_LAW {state: STRING}<br/>HAS_CLAUSE {type: STRING}<br/>INCORPORATED_IN {state: STRING}<br/><br/>The relationships:<br/>(:Agreement)-[:HAS_CLAUSE]-&gt;(:ContractClause)<br/>(:ContractClause)-[:HAS_EXCERPT]-&gt;(:Excerpt)<br/>(:ContractClause)-[:HAS_TYPE]-&gt;(:ClauseType)<br/>(:Agreement)-[:GOVERNED_BY_LAW]-&gt;(:Country)<br/>(:Organization)-[:IS_PARTY_TO]-&gt;(:Agreement)<br/>(:Organization)-[:INCORPORATED_IN]-&gt;(:Country)<br/>  """</span></pre><h1 id="08c9" class="og oh fq bf oi oj ok gq ol om on gt oo op oq or os ot ou ov ow ox oy oz pa pb bk">Step 4: Building a Q&amp;A Agent</h1><p id="102f" class="pw-post-body-paragraph mj mk fq ml b go pc mn mo gr pd mq mr ms pe mu mv mw pf my mz na pg nc nd ne fj bk">Armed with our Knowledge Graph data retrieval functions, we are ready to build an agent grounded by GraphRAG :-)</p><p id="6618" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Let’s sets up a chatbot agent capable of answering user queries about contracts using a combination of OpenAI’s <strong class="ml fr">gpt-4o</strong> model, our data retrieval functions and a Neo4j-powered knowledge graph.</p><p id="c179" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">We will use Microsoft <strong class="ml fr">Semantic Kernel, a framework that </strong>allows developers to integrate LLM function calling with existing APIs and data retrieval functions</p><p id="4a0d" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">The framework uses a concept called <strong class="ml fr">Plugins</strong> to represent specific functionality that the kernel can perform. In our case, all of our data retrieval functions defined in the “ContractPlugin” can be used by the LLM to answer the question.</p><p id="2363" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">The framework uses the concept of <strong class="ml fr">Memory</strong> to keep all interactions between user and agent, as well as functions executed and data retrieved.</p><p id="e5ca" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">A extremely simple Terminal-based agent can be implemented with a few lines of code. The snippet below shows the main parts of the agent (imports and environment vars removed).</p><pre class="np nq nr ns nt px pw py bp pz bb bk"><span id="2918" class="qa oh fq pw b bg qb qc l qd qe">logging.basicConfig(level=logging.INFO)<br/><br/># Initialize the kernel<br/>kernel = Kernel()<br/><br/># Add the Contract Search plugin to the kernel<br/>contract_search_neo4j = ContractSearchService(NEO4J_URI,NEO4J_USER,NEO4J_PASSWORD)<br/>kernel.add_plugin(ContractPlugin(contract_search_service=contract_search_neo4j),plugin_name="contract_search")<br/><br/># Add the OpenAI chat completion service to the Kernel<br/>kernel.add_service(OpenAIChatCompletion(ai_model_id="gpt-4o",api_key=OPENAI_KEY, service_id=service_id))<br/><br/># Enable automatic function calling<br/>settings: OpenAIChatPromptExecutionSettings = kernel.get_prompt_execution_settings_from_service_id(service_id=service_id)<br/>settings.function_choice_behavior = FunctionChoiceBehavior.Auto(filters={"included_plugins": ["contract_search"]})<br/><br/># Create a history of the conversation<br/>history = ChatHistory()<br/><br/>async def basic_agent() :<br/>    userInput = None<br/>    while True:<br/>        # Collect user input<br/>        userInput = input("User &gt; ")<br/><br/>        # Terminate the loop if the user says "exit"<br/>        if userInput == "exit":<br/>            break<br/><br/>        # Add user input to the history<br/>        history.add_user_message(userInput)<br/><br/>        # 3. Get the response from the AI with automatic function calling<br/>        chat_completion : OpenAIChatCompletion = kernel.get_service(type=ChatCompletionClientBase)<br/>        result = (await chat_completion.get_chat_message_contents(<br/>            chat_history=history,<br/>            settings=settings,<br/>            kernel=kernel,<br/>            arguments=KernelArguments(),<br/>        ))[0]<br/><br/>        # Print the results<br/>        print("Assistant &gt; " + str(result))<br/><br/>        # Add the message from the agent to the chat history<br/>        history.add_message(result)<br/><br/>if __name__ == "__main__":<br/>    asyncio.run(basic_agent())</span></pre><h1 id="1c25" class="og oh fq bf oi oj ok gq ol om on gt oo op oq or os ot ou ov ow ox oy oz pa pb bk">Let ask our agent some non-trivial questions</h1><blockquote class="ph pi pj"><p id="74a5" class="mj mk pk ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk"><strong class="ml fr">1. Find me contracts with Price Restrictions but no insurance clauses</strong></p></blockquote><pre class="np nq nr ns nt px pw py bp pz bb bk"><span id="7807" class="qa oh fq pw b bg qb qc l qd qe">Assistant &gt; I found the following contract that contains a Price Restrictions clause but does not contain an Insurance clause:<br/><br/>- **Name:** Birch First Global Investments Inc. and Mount Knowledge Holdings Inc. MARKETING AFFILIATE AGREEMENT<br/>- **Agreement Type:** MARKETING AFFILIATE AGREEMENT<br/>- **Parties:**<br/>  - **MOUNT KNOWLEDGE HOLDINGS INC.** (Marketing Affiliate), incorporated in Nevada, USA<br/>  - **BIRCH FIRST GLOBAL INVESTMENTS INC.** (Company), incorporated in the Virgin Islands (VIR)<br/><br/>Would you like to know more details about this contract?</span></pre><p id="c33d" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Here, The Semantic Agent planner has reviewed the available functions in the Kernel and determined that answering this question requires invoking two functions that, on their own, won’t provide the complete answer.</p><p id="b4ab" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">First, it executes the <strong class="ml fr">“Get Contracts with [Price Restriction] Clauses”</strong> function, followed by the <strong class="ml fr">“Get Contracts WITHOUT [Insurance] Clauses”</strong> function. The planner then combines the results from both functions to identify the intersection, ultimately arriving at the correct answer.</p><p id="6c0f" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">If you look at the debugging information, you can confirm the sequence of calls performed by the LLM, along with information on the number of tokens consumed by the call. Notice the calls with the 2 data retrieval functions.</p><figure class="np nq nr ns nt ng nm nn paragraph-image"><div role="button" tabindex="0" class="nw nx ed ny bh nz"><div class="nm nn qz"><img src="../Images/fab333a8a824e1d0ce2c3367bcfa10ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QmxOcKa8ORlFlZRMyytRtQ.png"/></div></div></figure><blockquote class="ph pi pj"><p id="180e" class="mj mk pk ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk"><strong class="ml fr">2. Yes, please. Provide more details</strong></p></blockquote><pre class="np nq nr ns nt px pw py bp pz bb bk"><span id="b65a" class="qa oh fq pw b bg qb qc l qd qe">Assistant &gt; Here are the detailed information about the contract:<br/><br/>### Contract Details:<br/>- **Name:** Birch First Global Investments Inc. and Mount Knowledge Holdings Inc. MARKETING AFFILIATE AGREEMENT<br/>- **Agreement Type:** MARKETING AFFILIATE AGREEMENT<br/>- **Expiration Date:** December 31, 2014<br/>- **Renewal Term:** One (1) year<br/><br/>### Parties Involved:<br/>1. **MOUNT KNOWLEDGE HOLDINGS INC.** <br/>   - **Role:** Marketing Affiliate<br/>   - **Incorporation Country:** USA<br/>   - **Incorporation State:** Nevada<br/>2. **BIRCH FIRST GLOBAL INVESTMENTS INC.**<br/>   - **Role:** Company<br/>   - **Incorporation Country:** Virgin Islands (VIR)<br/><br/>### Clauses Included:<br/>- No-Solicit Of Employees<br/>- Third Party Beneficiary<br/>- Price Restrictions<br/>- Affiliate License-Licensee<br/>- Affiliate License-Licensor<br/>- Cap On Liability<br/>- Audit Rights<br/>- Warranty Duration<br/>- Post-Termination Services<br/>- Non-Transferable License<br/>- License grant<br/>- IP Ownership Assignment<br/>- Minimum Commitment<br/>- Anti-Assignment<br/>- Non-Disparagement<br/><br/>### Clauses Not Included:<br/>- Insurance<br/><br/>Is there anything specific you would like to know or any particular clause details you are interested in?</span></pre><p id="c8ac" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">In this case, behind the scenes, the LLM used the <strong class="ml fr">“Find Contract by ID”</strong>. You may have noticed that the output shown to the user did not include the id of the contract. However, the Semantic Kernel stored all information returned from the functions from previous calls in the conversation memory!</p><p id="3137" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">This powerful combination of having the agent decide which function(s) to call, the use of memory and the automatic marshalling of the user queries into function calls with the right parameters explain the <strong class="ml fr">“Magic”</strong> behind an agent built with Semantic Kernel!</p><blockquote class="ph pi pj"><p id="8d08" class="mj mk pk ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk"><strong class="ml fr">3. Does any contract mention the ability to make price changes from time to time</strong></p></blockquote><pre class="np nq nr ns nt px pw py bp pz bb bk"><span id="f5f9" class="qa oh fq pw b bg qb qc l qd qe">Assistant &gt; Yes, there is a contract that mentions <br/>the ability to make price changes from time to time. <br/>Here is the relevant excerpt:<br/><br/>1. **Birch First Global Investments Inc. and Mount Knowledge Holdings Inc. MARKETING AFFILIATE AGREEMENT**<br/>   - **Contract ID:** 1<br/>   - **Clause Type:** Price Restrictions<br/>   - **Excerpt:**<br/>     ```<br/>     Company reserves the right to change its process and/or fees, from time to time, in its sole and absolute discretion. In the event of a price and/or fee change for Technology, Company shall notify MA in writing ninety (90) days prior to the effective date of any such change. All other prices and/or fees may be adjusted without prior notice to MA.<br/>     ```<br/><br/>Would you like more information about this contract or any other details?</span></pre><p id="6908" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">In order to answer this question, Semantic Kernel is executing the <strong class="ml fr">get_contract_similar_text data</strong> retrieval function.</p><pre class="np nq nr ns nt px pw py bp pz bb bk"><span id="6f24" class="qa oh fq pw b bg qb qc l qd qe">User &gt; any contract mentions the ability to make price changes from time to time<br/>INFO:semantic_kernel.connectors.ai.open_ai.services.open_ai_chat_completion_base:processing 1 tool calls in parallel.<br/><br/>INFO:semantic_kernel.kernel:Calling contract_search-get_contracts_similar_text<br/> function with args: {"clause_text":"price changes from time to time"}<br/><br/><br/>Assistant &gt; Yes, there is a contract that mentions the ability to make price changes from time to time. Here is the relevant excerpt:<br/><br/>1. **Birch First Global Investments Inc. and Mount Knowledge Holdings Inc. MARKETING AFFILIATE AGREEMENT**<br/>   - **Contract ID:** 1<br/>   - **Clause Type:** Price Restrictions<br/>   - **Excerpt:**<br/>     ```<br/>     Company reserves the right to change its process and/or fees, from time to time, in its sole and absolute discretion. In the event of a price and/or fee change for Technology, Company shall notify MA in writing ninety (90) days prior to the effective date of any such change. All other prices and/or fees may be adjusted without prior notice to MA.<br/>     ```</span></pre><p id="80d9" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">As explained earlier, this function uses vector search and a Cypher query to retrieve not just semantically similar excerpts but also the related contract and clauses that includes them.</p><p id="67f9" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Finally, let’s ask how many contracts are there on the database</p><blockquote class="ph pi pj"><p id="65a8" class="mj mk pk ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">4. How many contracts are there in the database?</p></blockquote><p id="197d" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">This questions requires the LLM to use the Text2Cypher data retriever</p><pre class="np nq nr ns nt px pw py bp pz bb bk"><span id="d74b" class="qa oh fq pw b bg qb qc l qd qe">Assistant &gt; There are a total of 3 contracts in the database.</span></pre><p id="c213" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">The debug information confirms that Semantic Kernel ran the Text2Cypher data retrieval function with “user_question” = “How many contracts are there in the database’?</p><pre class="np nq nr ns nt px pw py bp pz bb bk"><span id="1e94" class="qa oh fq pw b bg qb qc l qd qe">User &gt;  how many contracts are there on the database?<br/>INFO:httpx:HTTP Request: POST https://api.openai.com/v1/chat/completions "HTTP/1.1 200 OK"<br/>INFO:semantic_kernel.connectors.ai.open_ai.services.open_ai_chat_completion_base:processing 1 tool calls in parallel.<br/><br/>INFO:semantic_kernel.kernel:Calling contract_search-answer_aggregation_question function <br/>with args: {"user_question":"How many contracts are there in the database?"}<br/><br/><br/>INFO:semantic_kernel.functions.kernel_function:Function completed. Duration: 0.588805s<br/><br/>INFO:semantic_kernel.connectors.ai.open_ai.services.open_ai_handler:OpenAI usage: CompletionUsage(completion_tokens=13, prompt_tokens=3328, total_tokens=3341, completion_tokens_details={'reasoning_tokens': 0})<br/><br/>Assistant &gt; There are a total of 3 contracts in the database.</span></pre><h1 id="8204" class="og oh fq bf oi oj ok gq ol om on gt oo op oq or os ot ou ov ow ox oy oz pa pb bk"><strong class="al">Try it Yourself</strong></h1><p id="53f6" class="pw-post-body-paragraph mj mk fq ml b go pc mn mo gr pd mq mr ms pe mu mv mw pf my mz na pg nc nd ne fj bk">The <a class="af nf" href="https://github.com/neo4j-product-examples/graphrag-contract-review" rel="noopener ugc nofollow" target="_blank">github repo</a> contains a Streamlit app that provides a more elegant Agent UI. You are encouraged to interact with the agent and make changes to the ContractPlugin so your agent’s ability to handle more questions!</p><h1 id="e4a1" class="og oh fq bf oi oj ok gq ol om on gt oo op oq or os ot ou ov ow ox oy oz pa pb bk">Conclusion</h1><p id="1d7d" class="pw-post-body-paragraph mj mk fq ml b go pc mn mo gr pd mq mr ms pe mu mv mw pf my mz na pg nc nd ne fj bk">In this blog, we explored a Graph Retrieval Augmented Generation (GraphRAG) approach to transform labor-intensive tasks of commercial contract review into a more efficient, AI-driven process.</p><p id="24e9" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">By focusing on targeted information extraction using LLMs and prompts, building a structured knowledge graph with Neo4j, implementing simple data retrieval functions, and ultimately developing a Q&amp;A agent, we created an intelligent solution that handles complex questions effectively.</p><p id="f6ca" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">This approach minimizes inefficiencies found in traditional vector search based RAG, focusing instead on extracting only relevant information, reducing the need for unnecessary vector embeddings, and simplifying the overall process. We hope this journey from contract ingestion to an interactive Q&amp;A agent inspires you to leverage GraphRAG in your own projects for improved efficiency and smarter AI-driven decision-making.</p><p id="2284" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Start building your own commercial contract review agent today and experience the power of GraphRAG firsthand!</p><h1 id="a4f6" class="og oh fq bf oi oj ok gq ol om on gt oo op oq or os ot ou ov ow ox oy oz pa pb bk">Resources</h1><p id="3dc9" class="pw-post-body-paragraph mj mk fq ml b go pc mn mo gr pd mq mr ms pe mu mv mw pf my mz na pg nc nd ne fj bk">For those eager to take a deeper dive, please check out the resources linked below:</p><ul class=""><li id="16d7" class="mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne qf pm pn bk"><a class="af nf" href="https://github.com/neo4j-product-examples/graphrag-contract-review" rel="noopener ugc nofollow" target="_blank">GitHub repository with the code and detailed instructions</a></li><li id="9298" class="mj mk fq ml b go po mn mo gr pp mq mr ms pq mu mv mw pr my mz na ps nc nd ne qf pm pn bk"><a class="af nf" href="https://github.com/TheAtticusProject/cuad" rel="noopener ugc nofollow" target="_blank">Contract Understanding Atticus Dataset (CUAD) for Legal Contracts</a> (Github)</li><li id="e938" class="mj mk fq ml b go po mn mo gr pp mq mr ms pq mu mv mw pr my mz na ps nc nd ne qf pm pn bk"><a class="af nf" href="https://arxiv.org/pdf/2103.06268" rel="noopener ugc nofollow" target="_blank">CUAD: An Expert-Annotated NLP Dataset for Legal Contract Review. Hendrycks, Burns, Chen, Ball. NeurIPS 2021</a></li><li id="b2c0" class="mj mk fq ml b go po mn mo gr pp mq mr ms pq mu mv mw pr my mz na ps nc nd ne qf pm pn bk"><a class="af nf" href="https://neo4j.com/blog/graphrag-python-package/" rel="noopener ugc nofollow" target="_blank">Neo4j GraphRAG package launch blog post</a></li><li id="0ed6" class="mj mk fq ml b go po mn mo gr pp mq mr ms pq mu mv mw pr my mz na ps nc nd ne qf pm pn bk"><a class="af nf" href="https://learn.microsoft.com/en-us/semantic-kernel/overview/" rel="noopener ugc nofollow" target="_blank">Microsoft Semantic Kernel library</a></li></ul><p id="8f78" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Unless otherwise noted, all images are by the author</p></div></div></div></div>    
</body>
</html>