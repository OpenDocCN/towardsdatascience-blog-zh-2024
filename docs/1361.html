<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Introduction to Spatial Analysis of Cells for Neuroscientists (Part 1)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Introduction to Spatial Analysis of Cells for Neuroscientists (Part 1)</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/introduction-to-spatial-analysis-of-cells-for-neuroscientists-part-1-82bef519ad46?source=collection_archive---------12-----------------------#2024-05-30">https://towardsdatascience.com/introduction-to-spatial-analysis-of-cells-for-neuroscientists-part-1-82bef519ad46?source=collection_archive---------12-----------------------#2024-05-30</a></blockquote><div><div class="em ff fg fh fi fj"/><div class="fk fl fm fn fo"><div class="ab cb"><div class="ci bh ew ex ey ez"><div/><div><h2 id="9289" class="pw-subtitle-paragraph go fq fr bf b gp gq gr gs gt gu gv gw gx gy gz ha hb hc hd cq dx">An approach using point patterns analysis (PPA) with spatstat</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="he hf hg hh hi ab"><div><div class="ab hj"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@damanrique?source=post_page---byline--82bef519ad46--------------------------------" rel="noopener follow"><div class="l hk hl by hm hn"><div class="l ed"><img alt="Daniel Manrique-Castano" class="l ep by dd de cx" src="../Images/06f857ae6e82688113f1089c7f03be88.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/da:true/resize:fill:88:88/0*9lYBpTGF3RXmvDod"/><div class="ho by l dd de em n hp eo"/></div></div></a></div></div><div class="hq ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--82bef519ad46--------------------------------" rel="noopener follow"><div class="l hr hs by hm ht"><div class="l ed"><img alt="Towards Data Science" class="l ep by br hu cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="ho by l br hu em n hp eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hv ab q"><div class="ab q hw"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hx hy bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hz" data-testid="authorName" href="https://medium.com/@damanrique?source=post_page---byline--82bef519ad46--------------------------------" rel="noopener follow">Daniel Manrique-Castano</a></p></div></div></div><div class="ia ib l"><div class="ab ic"><div class="ab"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewbox="0 0 16 16"><path fill="#437AFF" d="M15.163 8c0 .65-.459 1.144-.863 1.575-.232.244-.471.5-.563.719s-.086.543-.092.875c-.006.606-.018 1.3-.49 1.781-.47.481-1.15.494-1.744.5-.324.006-.655.013-.857.094s-.465.337-.704.575c-.422.412-.906.881-1.542.881-.637 0-1.12-.469-1.543-.881-.239-.238-.49-.482-.704-.575-.214-.094-.532-.088-.857-.094-.593-.006-1.273-.019-1.744-.5s-.484-1.175-.49-1.781c-.006-.332-.012-.669-.092-.875-.08-.207-.33-.475-.563-.719-.404-.431-.863-.925-.863-1.575s.46-1.144.863-1.575c.233-.244.472-.5.563-.719.092-.219.086-.544.092-.875.006-.606.019-1.3.49-1.781s1.15-.494 1.744-.5c.325-.006.655-.012.857-.094.202-.081.465-.337.704-.575C7.188 1.47 7.671 1 8.308 1s1.12.469 1.542.881c.239.238.49.481.704.575s.533.088.857.094c.594.006 1.273.019 1.745.5.47.481.483 1.175.49 1.781.005.331.011.669.091.875s.33.475.563.719c.404.431.863.925.863 1.575"/><path fill="#fff" d="M7.328 10.5c.195 0 .381.08.519.22.137.141.215.331.216.53 0 .066.026.13.072.177a.24.24 0 0 0 .346 0 .25.25 0 0 0 .071-.177c.001-.199.079-.389.216-.53a.73.73 0 0 1 .519-.22h1.959c.13 0 .254-.053.346-.146a.5.5 0 0 0 .143-.354V6a.5.5 0 0 0-.143-.354.49.49 0 0 0-.346-.146h-1.47c-.324 0-.635.132-.865.366-.23.235-.359.552-.359.884v2.5c0 .066-.025.13-.071.177a.24.24 0 0 1-.346 0 .25.25 0 0 1-.072-.177v-2.5c0-.332-.13-.65-.359-.884A1.21 1.21 0 0 0 6.84 5.5h-1.47a.49.49 0 0 0-.346.146A.5.5 0 0 0 4.88 6v4c0 .133.051.26.143.354a.49.49 0 0 0 .347.146z"/></svg></div></div></div><span class="id ie" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hx hy dx"><button class="if ig ah ai aj ak al am an ao ap aq ar ih ii ij" disabled="">Follow</button></p></div></div></span></div></div><div class="l ik"><span class="bf b bg z dx"><div class="ab cn il im in"><div class="io ip ab"><div class="bf b bg z dx ab iq"><span class="ir l ik">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hz ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--82bef519ad46--------------------------------" rel="noopener follow"><p class="bf b bg z is it iu iv iw ix iy iz bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="id ie" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">10 min read</span><div class="ja jb l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">May 30, 2024</span></div></span></div></span></div></div></div><div class="ab cp jc jd je jf jg jh ji jj jk jl jm jn jo jp jq jr"><div class="h k w ea eb q"><div class="kh l"><div class="ab q ki kj"><div class="pw-multi-vote-icon ed ir kk kl km"><div class=""><div class="kn ko kp kq kr ks kt am ku kv kw km"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kx ky kz la lb lc ld"><p class="bf b dy z dx"><span class="ko">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kn lg lh ab q ee li lj" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="lf"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg><p class="bf b dy z dx"><span class="pw-responses-count le lf">1</span></p></button></div></div></div><div class="ab q js jt ju jv jw jx jy jz ka kb kc kd ke kf kg"><div class="lk k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al ll an ao ap ih lm ln lo" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep lp cn"><div class="l ae"><div class="ab cb"><div class="lq lr ls lt lu lv ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al ll an ao ap ih lw lx lj ly lz ma mb mc s md me mf mg mh mi mj u mk ml mm"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al ll an ao ap ih lw lx lj ly lz ma mb mc s md me mf mg mh mi mj u mk ml mm"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al ll an ao ap ih lw lx lj ly lz ma mb mc s md me mf mg mh mi mj u mk ml mm"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><figure class="mq mr ms mt mu mv mn mo paragraph-image"><div role="button" tabindex="0" class="mw mx ed my bh mz"><div class="mn mo mp"><img src="../Images/f5616b948d25d4a114fb18d9ade8062a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*f9tfVCVRO7ZhVKeurGXMXg.png"/></div></div><figcaption class="nb nc mp mn mo nd ne bf b bg z dx">Density kernel generated from point patterns</figcaption></figure><p id="227a" class="pw-post-body-paragraph nf ng fr nh b gp ni nj nk gs nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fk bk">As a neuroscientist, in recent years I have been interested in developing strategies that allow multimodal assessment of cell distribution in the brain. My motivation was to quantitatively understand the cellular rearrangement of neuroglia after brain injury. Along the way, I came across <code class="cx ob oc od oe b">spatstat</code>(<em class="of">1</em>), a multifunctional R package for spatial analysis based on point patterns, called point pattern analysis (PPA). This approach is well developed in fields such as geography, epidemiology, or ecology, but applications to neurobiology are very limited, if not non-existent. I recently published a short protocol (<em class="of">2</em>), and the reader can find a preprint (<em class="of">3</em>) with a much longer and dedicated application of this approach.</p><p id="455d" class="pw-post-body-paragraph nf ng fr nh b gp ni nj nk gs nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fk bk">In this post, my goal is to provide an accessible introduction to the use of this method for researchers interested in unraveling the spatial distribution of cells in different tissues, without the narrative rigidity of scientific papers.</p><h1 id="dae1" class="og oh fr bf oi oj ok gr ol om on gu oo op oq or os ot ou ov ow ox oy oz pa pb bk">What is point pattern analysis (PPA)?</h1><p id="7252" class="pw-post-body-paragraph nf ng fr nh b gp pc nj nk gs pd nm nn no pe nq nr ns pf nu nv nw pg ny nz oa fk bk">PPA is a spatial analysis technique used to study the distribution of individual events or objects in a given area (also called an observation window). This method allows researchers to examine the number of objects per unit area (called spatial intensity), whether the points are randomly distributed, clustered, or regularly spaced, and the variations in spatial intensity conditional on different covariants. Unlike raw and non-reproducible cell counts (e.g., 100 cells/mm2), PPA preserves all spatial information and allows multiple and reproducible manipulations of the point patterns. This allows researchers to identify underlying processes or structures that influence the distribution of objects of interest.</p><h1 id="1617" class="og oh fr bf oi oj ok gr ol om on gu oo op oq or os ot ou ov ow ox oy oz pa pb bk">Requirements for PPA</h1><p id="334d" class="pw-post-body-paragraph nf ng fr nh b gp pc nj nk gs pd nm nn no pe nq nr ns pf nu nv nw pg ny nz oa fk bk">The only requirement to perform PPA is to have xy coordinates of single objects (cells, proteins, subcellular structures, etc.). In this article, we focus on 2D PPA, although 3D approaches are also available. These coordinates are then processed using R and the spatstat function to create point patterns and store them as hyperframes.</p><p id="29a8" class="pw-post-body-paragraph nf ng fr nh b gp ni nj nk gs nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fk bk">I obtained the coordinates of individual cells using unbiased cell detection/quantification approaches using QuPath (<em class="of">4</em>) or CellProfiler (<em class="of">5</em>). I find that the detection and segmentation of round/circular objects like neurons (e.g. NeuN) is easier compared to irregular objects like astrocytes (GFAP) or microglia (IBA1), especially when cell density is high and there is a lot of cell overlap (e.g. glial aggregation after brain injury). The segmentation of irregular, highly clustered objects is still a frontier in this field. However, the QuPath or CellProfiler provide reasonable accuracy and, most importantly, are reproducible and can be validated. A human observer could not do better. Therefore, I recommend not to worry too much if in some cases you get the impression that certain objects only correspond to fragments of a cell or a combination of several cells. Fine-tune the parameters to ensure that the cell detection/segmentation does the best job possible. If the cells are far enough apart (e.g. healthy brain, cell culture), there is not much to worry about.</p><h1 id="6947" class="og oh fr bf oi oj ok gr ol om on gu oo op oq or os ot ou ov ow ox oy oz pa pb bk">Creating point patterns</h1><p id="4da7" class="pw-post-body-paragraph nf ng fr nh b gp pc nj nk gs pd nm nn no pe nq nr ns pf nu nv nw pg ny nz oa fk bk">When working with multiple samples, the creation of point patterns can be simplified by using functions like the following <a class="af ph" href="https://github.com/elalilab/Stroke_PDGFR-B_Reactivity/blob/main/Widefield_5x_Ipsilateral_Gfap-Pdgfrb_Handling.qmd" rel="noopener ugc nofollow" target="_blank">link</a>. The core of this procedure is to convert individual .csv files containing single-cell coordinates into point patterns (using the <code class="cx ob oc od oe b">ppp</code> function of <code class="cx ob oc od oe b">spatstat</code>) and organize them into a hyperframe that can be saved and shared as a .rds R object.</p><p id="fcf8" class="pw-post-body-paragraph nf ng fr nh b gp ni nj nk gs nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fk bk">Here, we’ll load a point pattern I have created during my research (<em class="of">3</em>). This file is available in the <a class="af ph" href="https://github.com/daniel-manrique/MediumBlog/tree/main/Data" rel="noopener ugc nofollow" target="_blank">GitHub repository</a> under the name <code class="cx ob oc od oe b">PointPatterns_5x.rds</code>. Please feel free to use it for research, education, or training purposes.</p><pre class="mq mr ms mt mu pi oe pj bp pk bb bk"><span id="bb87" class="pl oh fr oe b bg pm pn l po pp">library(brms)<br/>library(dplyr)<br/>library(ggplot2)<br/>library(gtsummary)<br/>library(modelr)<br/>library(spatstat)<br/>library(tidybayes)</span></pre><pre class="pq pi oe pj bp pk bb bk"><span id="4e75" class="pl oh fr oe b bg pm pn l po pp">PointPatterns &lt;- readRDS("Data/PointPatterns_5x.rds")<br/>row.names(PointPatterns) &lt;- PointPatterns$ID <br/><br/>head(PointPatterns)</span></pre><p id="a9b8" class="pw-post-body-paragraph nf ng fr nh b gp ni nj nk gs nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fk bk">You can see that the hyper-frame contains several columns of variables. Let’s focus on the first three columns, which contain point patterns for three types of brain cells: Neurons, Astrocytes, and Microglia. We will rewrite some variable columns in our own way to exercise the implementation of PPA. First, let’s take a look at what the point patterns look like by plotting them all at once (for neurons):</p><pre class="mq mr ms mt mu pi oe pj bp pk bb bk"><span id="280e" class="pl oh fr oe b bg pm pn l po pp">plot(PointPatterns$Neurons)</span></pre><figure class="mq mr ms mt mu mv mn mo paragraph-image"><div role="button" tabindex="0" class="mw mx ed my bh mz"><div class="mn mo pr"><img src="../Images/2adba861dc4f6d37902aa83ab1a36f4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9rV0jK7ehl7zBWyPPzx_Aw.png"/></div></div><figcaption class="nb nc mp mn mo nd ne bf b bg z dx">Figure 1: Multiple point patterns.</figcaption></figure><p id="5cbf" class="pw-post-body-paragraph nf ng fr nh b gp ni nj nk gs nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fk bk">Let’s see the details by looking at any single brain:</p><pre class="mq mr ms mt mu pi oe pj bp pk bb bk"><span id="67c0" class="pl oh fr oe b bg pm pn l po pp">plot(PointPatterns$Neurons$M05)</span></pre><figure class="mq mr ms mt mu mv mn mo paragraph-image"><div class="mn mo ps"><img src="../Images/1a2324987371eff9602376ee68e6d752.png" data-original-src="https://miro.medium.com/v2/resize:fit:664/format:webp/1*zUBgNPq9jNxw-BGzPDjZ8g.png"/></div><figcaption class="nb nc mp mn mo nd ne bf b bg z dx">Figure 2: Single point pattern.</figcaption></figure><p id="be25" class="pw-post-body-paragraph nf ng fr nh b gp ni nj nk gs nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fk bk">We can play a little bit with the plots, by displaying two cell types (point patterns) at the same type and changing the way (shape and color) they are plotted. Here is an example:</p><pre class="mq mr ms mt mu pi oe pj bp pk bb bk"><span id="a448" class="pl oh fr oe b bg pm pn l po pp"># We plot neurons in black with symbol (10)<br/>plot(PointPatterns$Neurons$M05, pch = 10, cex = 0.4, main = "Neurons and Astrocytes")<br/><br/># We add astrocytes in red with a different symbol (18)<br/>plot(PointPatterns$Astrocytes$M05, pch = 18, cex = 0.4, col = "red", add = TRUE)</span></pre><figure class="mq mr ms mt mu mv mn mo paragraph-image"><div class="mn mo pt"><img src="../Images/11ecbdaac7307350fd5eac5fe7eb28dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:604/format:webp/1*SOUAoLD9ZTbHnSF59WjVyQ.png"/></div><figcaption class="nb nc mp mn mo nd ne bf b bg z dx">Figure 3: Different cell types and aesthetics.</figcaption></figure><p id="d625" class="pw-post-body-paragraph nf ng fr nh b gp ni nj nk gs nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fk bk">This gives a first impression of the number and distribution of cells, but of course we need to quantify it. A first approach is to obtain the estimated spatial intensity for each point pattern. We can generate an extra column for each row in the hyperframe with a simple code. For the sake of this post, we will do this for astrocytes only:</p><pre class="mq mr ms mt mu pi oe pj bp pk bb bk"><span id="eb6b" class="pl oh fr oe b bg pm pn l po pp">PointPatterns$AstrocytesIntensity &lt;- with(PointPatterns, summary(Astrocytes)$intensity)<br/><br/>head(PointPatterns[,9:11])</span></pre><figure class="mq mr ms mt mu mv mn mo paragraph-image"><div class="mn mo pu"><img src="../Images/23a6ff8a53095d423a1fcff4eedfedaa.png" data-original-src="https://miro.medium.com/v2/resize:fit:654/format:webp/1*0BFWgOdjBkfWQ_dk-LYzsg.png"/></div></figure><p id="a26e" class="pw-post-body-paragraph nf ng fr nh b gp ni nj nk gs nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fk bk">You can see that we have created a new column that contains the spatial intensity of astrocytes. Next, we extract the information into a data frame along with the grouping variables:</p><pre class="mq mr ms mt mu pi oe pj bp pk bb bk"><span id="994e" class="pl oh fr oe b bg pm pn l po pp">Astrocytes_df &lt;- as.data.frame(PointPatterns[,9:11])<br/><br/># We make sure to organize our factor variable in the right order<br/>Astrocytes_df$DPI &lt;- factor(Astrocytes_df$DPI, levels = c("0D", "5D", "15D", "30D"))<br/><br/>gt::gt(Astrocytes_df[1:10,])</span></pre><figure class="mq mr ms mt mu mv mn mo paragraph-image"><div class="mn mo pv"><img src="../Images/f5d5a972b85bf35a50803dbfbd52aebc.png" data-original-src="https://miro.medium.com/v2/resize:fit:594/format:webp/1*Ct1JQEFf5WLZxbyHxWVwNw.png"/></div></figure><p id="673c" class="pw-post-body-paragraph nf ng fr nh b gp ni nj nk gs nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fk bk">This’s a good start, you are able to get the number of cells per unit area in a reproducible way using unbiased/automatic cell counting. Let’s make a simple scientific inference from this data.</p><h1 id="2290" class="og oh fr bf oi oj ok gr ol om on gu oo op oq or os ot ou ov ow ox oy oz pa pb bk">Fit a statistical model for the spatial intensity</h1><p id="f01e" class="pw-post-body-paragraph nf ng fr nh b gp pc nj nk gs pd nm nn no pe nq nr ns pf nu nv nw pg ny nz oa fk bk">As usual in my blog posts, we use <code class="cx ob oc od oe b">brms</code> (<em class="of">6</em>) to fit a Bayesian linear model where we investigate the Astrocyte spatial intensity conditioning on DPI, that is, the days post-ischemia (brain injury) for the animals in this data set. We’re going to build a model with heteroscedasticity (predicting sigma) because (I know) the variance between DPIs is not equal. It is much smaller for 0D.</p><pre class="mq mr ms mt mu pi oe pj bp pk bb bk"><span id="f3fb" class="pl oh fr oe b bg pm pn l po pp">Astrocytes_Mdl &lt;- bf(AstrocytesIntensity ~ DPI, <br/>                     sigma ~ DPI)<br/>  <br/>Astrocytes_Fit &lt;- brm(formula = Astrocytes_Mdl,<br/>                      family = student,<br/>                      data = Astrocytes_df, <br/>                      # seed for reproducibility purposes<br/>                      seed = 8807,<br/>                      control = list(adapt_delta = 0.99),<br/>                      # this is to save the model in my laptop<br/>                      file    = "Models/2024-05-24_PPA/Astrocytes_Fit.rds",<br/>                      file_refit = "never")<br/><br/># Add loo for model comparison<br/>Astrocytes_Fit &lt;- <br/>  add_criterion(Astrocytes_Fit, c("loo", "waic", "bayes_R2"))</span></pre><p id="483d" class="pw-post-body-paragraph nf ng fr nh b gp ni nj nk gs nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fk bk">Let’s look at the summary table for our model:</p><figure class="mq mr ms mt mu mv mn mo paragraph-image"><div class="mn mo pw"><img src="../Images/c678c24671811924977346241aa61521.png" data-original-src="https://miro.medium.com/v2/resize:fit:1382/format:webp/1*e6TlvpEqmcdeHa74s1zrsA.png"/></div></figure><p id="13cd" class="pw-post-body-paragraph nf ng fr nh b gp ni nj nk gs nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fk bk">We see that animals at 0D (intercept) have a mean spatial intensity of 4.3 with a 95% credible interval (CI) between 0.73 and 2.90. That’s a very small number of cells. On the other hand, we have a peak at 15D with a mean of 26.9 with CIs between 22 and 31.</p><p id="34cf" class="pw-post-body-paragraph nf ng fr nh b gp ni nj nk gs nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fk bk">Let’s plot the results using the great <code class="cx ob oc od oe b">TidyBayes</code> package (<em class="of">7</em>) from the great <a class="af ph" href="https://www.mjskay.com/" rel="noopener ugc nofollow" target="_blank">Matthew Kay</a></p><pre class="mq mr ms mt mu pi oe pj bp pk bb bk"><span id="50c6" class="pl oh fr oe b bg pm pn l po pp">Astrocytes_df %&gt;%<br/>  data_grid(Astrocytes_df) %&gt;%<br/>  add_epred_draws(Astrocytes_Fit) %&gt;%<br/>  ggplot(aes(x = .epred, y = DPI)) +<br/>  labs(x = "Spatial intensity") +<br/>  stat_halfeye() +<br/>  geom_vline(xintercept = 0) +<br/>  Plot_theme</span></pre><figure class="mq mr ms mt mu mv mn mo paragraph-image"><div role="button" tabindex="0" class="mw mx ed my bh mz"><div class="mn mo px"><img src="../Images/68d0761bd0aa09e9875d6515bdd522cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O6awV2ynP5XI_8YQCZhtXg.png"/></div></div><figcaption class="nb nc mp mn mo nd ne bf b bg z dx">Figure 4: Posterior distribution for the spatial intensity of astrocytes.</figcaption></figure><p id="1712" class="pw-post-body-paragraph nf ng fr nh b gp ni nj nk gs nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fk bk"><code class="cx ob oc od oe b">stat_halfeye()</code>from Figure 4 is a nice way to look at the results. This procedure is analogous to counting cells in a given area. The advantage of PPA is that you do not have to rely on the supposed visual acuity of a student counting cells (the supposed experts are not the ones counting them), but you can produce unbiased cell counts that can be validated and are reproducible and reusable. Clearly, dear reader, we can do much more with PPA.</p><h1 id="293a" class="og oh fr bf oi oj ok gr ol om on gu oo op oq or os ot ou ov ow ox oy oz pa pb bk">Creating density kernels</h1><p id="49ea" class="pw-post-body-paragraph nf ng fr nh b gp pc nj nk gs pd nm nn no pe nq nr ns pf nu nv nw pg ny nz oa fk bk">We have density kernels available in the loaded point patterns, but we’ll rewrite them for this post. A density kernel is a method of estimating the probability density function of a variable, in this case, the location of cells. This provides a smooth estimate of the intensity function that produced the observed data.</p><p id="c465" class="pw-post-body-paragraph nf ng fr nh b gp ni nj nk gs nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fk bk">Kernel density estimation for point patterns can be formulated as follows:</p><figure class="mq mr ms mt mu mv mn mo paragraph-image"><div role="button" tabindex="0" class="mw mx ed my bh mz"><div class="mn mo py"><img src="../Images/f4fe1e192c2108651bc83c4e80563ffd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N-dNIj7Iz2_V0CWVQD5dUQ.png"/></div></div></figure><p id="eb17" class="pw-post-body-paragraph nf ng fr nh b gp ni nj nk gs nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fk bk">We’ll recreate the density kernels for astrocytes and microglia using the <code class="cx ob oc od oe b">density</code> function from <code class="cx ob oc od oe b">spatstat</code>. Please make sure that this function is not overwritten by other packages. I find that a sigma (bandwidth) of 0.2 gives a fair readout for the point pattern density.</p><pre class="mq mr ms mt mu pi oe pj bp pk bb bk"><span id="f06f" class="pl oh fr oe b bg pm pn l po pp">PointPatterns$Astrocytes_Dens &lt;- with(PointPatterns, density(Astrocytes, sigma = 0.2, col = topo.colors))</span></pre><p id="56e3" class="pw-post-body-paragraph nf ng fr nh b gp ni nj nk gs nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fk bk">With this ready, I want to give you an example of the impact of sigma in the density kernel using a single brain:</p><pre class="mq mr ms mt mu pi oe pj bp pk bb bk"><span id="b201" class="pl oh fr oe b bg pm pn l po pp">par(mfrow = c(1,3), mar=c(1,1,1,1), oma=c(1,1,1,1))<br/><br/>plot(density(PointPatterns$Astrocytes$M05, sigma = 0.02), col = topo.colors, main = "sigma = 0.02")<br/>plot(density(PointPatterns$Astrocytes$M05, sigma = 0.2), col = topo.colors, main = "sigma = 0.2")<br/>plot(density(PointPatterns$Astrocytes$M05, sigma = 2), col = topo.colors, main = "sigma = 2")</span></pre><figure class="mq mr ms mt mu mv mn mo paragraph-image"><div class="mn mo pz"><img src="../Images/80a3138784acf26514e55584b6d3e98e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1390/format:webp/1*FlBJn3MYWUl7WAM2fxQ07w.png"/></div><figcaption class="nb nc mp mn mo nd ne bf b bg z dx">Figure 5: Density kernels with different sigma.</figcaption></figure><p id="655b" class="pw-post-body-paragraph nf ng fr nh b gp ni nj nk gs nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fk bk">Figure 5 shows that, in the first case, we see that a very low sigma maps single points. For sigma = 0.2, we see a mapping on a larger scale and we can distinguish much better regions with low and high density of astrocytes. Finally, sigma = 2 offers a perspective where we cannot really distinguish with precision the different densities of astrocytes. For this case, sigma = 0.2 is a good compromise.</p><p id="df21" class="pw-post-body-paragraph nf ng fr nh b gp ni nj nk gs nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fk bk">Now we’ll fit a simple point process model to investigate the relative distribution of neurons conditioning on astrocyte density (mapped by the density kernel).</p><h1 id="10f6" class="og oh fr bf oi oj ok gr ol om on gu oo op oq or os ot ou ov ow ox oy oz pa pb bk">Fit a point process model (ppm)</h1><p id="4e7c" class="pw-post-body-paragraph nf ng fr nh b gp pc nj nk gs pd nm nn no pe nq nr ns pf nu nv nw pg ny nz oa fk bk">Here, we use the <code class="cx ob oc od oe b">mppm</code> function from <code class="cx ob oc od oe b">spatstat</code> to fit a multiple-point process model for the point patterns in our hyperframe.Unfortunately, there are no Bayesian-like functions for multiple-point patterns in <code class="cx ob oc od oe b">spatstat</code>.</p><pre class="mq mr ms mt mu pi oe pj bp pk bb bk"><span id="d1b1" class="pl oh fr oe b bg pm pn l po pp"># We fit the mppm model<br/>Neurons_ppm &lt;- mppm(Neurons ~ Astrocytes_Dens, data = PointPatterns)<br/><br/># We check the results<br/>summary(Neurons_ppm)</span></pre><figure class="mq mr ms mt mu mv mn mo paragraph-image"><div class="mn mo qa"><img src="../Images/4c5f2b0bb516790213ef789aa4c326ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1330/format:webp/1*LJFn8ekYS1RlHckLcM8NtQ.png"/></div></figure><p id="fc9a" class="pw-post-body-paragraph nf ng fr nh b gp ni nj nk gs nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fk bk">Remember that spatial models are fitted with a Poisson distribution that uses the log link function to obtain only positive results. This means that we need to exponentiate the results in the table to convert them to the original scale. Therefore, we can see that the spatial intensity of neurons at a baseline (when the density of astrocytes is 0) is exp(3.54) = 34.4. This intensity decreases by ex(-0.002171358)=-0.99 for every unit increase in astrocyte spatial intensity (as defined by the density kernels). In other words, this model tells us that we have fewer neurons at points where we have more astrocytes. Note that we do not include DPI in the regression, an exercise you can do to see if this estimate changes with DPI.</p><p id="d5b3" class="pw-post-body-paragraph nf ng fr nh b gp ni nj nk gs nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fk bk">There are more aspects to explore for PPA. However, not to make this post long and heavy, I will cover them in the next two posts. Here you could learn how to calculate and extract the spatial intensity of cells, create density kernels, and build point process models with them. In the next post, we’ll explore how to perform calculations for relative distributions and how to use raster layers to further explore the cell distribution.</p><p id="9996" class="pw-post-body-paragraph nf ng fr nh b gp ni nj nk gs nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fk bk">I would appreciate your comments or feedback letting me know if this journey was useful to you. If you want more quality content on data science and other topics, you might consider becoming a <a class="af ph" href="https://medium.com/membership" rel="noopener">medium member</a>.</p><p id="a3c6" class="pw-post-body-paragraph nf ng fr nh b gp ni nj nk gs nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fk bk">You can find a complete/updated version of this post on my <a class="af ph" href="https://github.com/daniel-manrique/MediumBlog/blob/main/2024-05-24_SpatialAnalysis_Part1.qmd" rel="noopener ugc nofollow" target="_blank">GitHub site</a>.</p><ul class=""><li id="a175" class="nf ng fr nh b gp ni nj nk gs nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa qb qc qd bk">All images, unless otherwise stated, were generated by the authors using R code.</li></ul><h1 id="2726" class="og oh fr bf oi oj ok gr ol om on gu oo op oq or os ot ou ov ow ox oy oz pa pb bk">References</h1><p id="8298" class="pw-post-body-paragraph nf ng fr nh b gp pc nj nk gs pd nm nn no pe nq nr ns pf nu nv nw pg ny nz oa fk bk">1.A. Baddeley, E. Rubak, R. Turner, <em class="of">Spatial point patterns: Methodology and applications with R</em> (Chapman; Hall/CRC Press, London, 2015; <a class="af ph" href="https://www.routledge.com/Spatial-Point-Patterns-Methodology-and-Applications-with-R/Baddeley-Rubak-Turner/p/book/9781482210200/" rel="noopener ugc nofollow" target="_blank">https://www.routledge.com/Spatial-Point-Patterns-Methodology-and-Applications-with-R/Baddeley-Rubak-Turner/p/book/9781482210200/</a>).</p><p id="7128" class="pw-post-body-paragraph nf ng fr nh b gp ni nj nk gs nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fk bk">2. D. Manrique-Castano, A. ElAli, <a class="af ph" href="https://doi.org/10.1016/j.xpro.2024.102989" rel="noopener ugc nofollow" target="_blank">Unbiased quantification of the spatial distribution of murine cells using point pattern analysis</a>. <em class="of">STAR Protocols</em>. <strong class="nh fs">5</strong>, 102989 (2024).</p><p id="afd5" class="pw-post-body-paragraph nf ng fr nh b gp ni nj nk gs nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fk bk">3. D. Manrique-Castano, D. Bhaskar, A. ElAli, Dissecting glial scar formation by spatial point pattern and topological data analysis (2023), (available at <a class="af ph" href="http://dx.doi.org/10.1101/2023.10.04.560910" rel="noopener ugc nofollow" target="_blank">http://dx.doi.org/10.1101/2023.10.04.560910</a>).</p><p id="a604" class="pw-post-body-paragraph nf ng fr nh b gp ni nj nk gs nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fk bk">4. P. Bankhead, M. B. Loughrey, J. A. Fernández, Y. Dombrowski, D. G. McArt, P. D. Dunne, S. McQuaid, R. T. Gray, L. J. Murray, H. G. Coleman, J. A. James, M. Salto-Tellez, P. W. Hamilton, QuPath: Open source software for digital pathology image analysis. <em class="of">Scientific Reports</em>. <strong class="nh fs">7</strong> (2017), doi:<a class="af ph" href="https://doi.org/10.1038/s41598-017-17204-5" rel="noopener ugc nofollow" target="_blank">10.1038/s41598–017–17204–5</a>.</p><p id="ecd0" class="pw-post-body-paragraph nf ng fr nh b gp ni nj nk gs nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fk bk">5. D. R. Stirling, M. J. Swain-Bowden, A. M. Lucas, A. E. Carpenter, B. A. Cimini, A. Goodman, CellProfiler 4: improvements in speed, utility and usability. <em class="of">BMC Bioinformatics</em>. <strong class="nh fs">22</strong> (2021), doi:<a class="af ph" href="https://doi.org/10.1186/s12859-021-04344-9" rel="noopener ugc nofollow" target="_blank">10.1186/s12859–021–04344–9</a>.</p><p id="4e49" class="pw-post-body-paragraph nf ng fr nh b gp ni nj nk gs nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fk bk">6. P.-C. Bürkner, Brms: An r package for bayesian multilevel models using stan. <strong class="nh fs">80</strong> (2017), doi:<a class="af ph" href="https://doi.org/10.18637/jss.v080.i01" rel="noopener ugc nofollow" target="_blank">10.18637/jss.v080.i01</a>.</p><p id="5406" class="pw-post-body-paragraph nf ng fr nh b gp ni nj nk gs nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fk bk">7. M. Kay, <em class="of">tidybayes: Tidy data and geoms for Bayesian models</em> (2023; <a class="af ph" href="http://mjskay.github.io/tidybayes/" rel="noopener ugc nofollow" target="_blank">http://mjskay.github.io/tidybayes/</a>).</p></div></div></div></div>    
</body>
</html>