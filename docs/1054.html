<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Using Double Machine Learning and Linear Programming to optimise treatment strategies</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Using Double Machine Learning and Linear Programming to optimise treatment strategies</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/using-double-machine-learning-and-linear-programming-to-optimise-treatment-strategies-920c20a29553?source=collection_archive---------2-----------------------#2024-04-26">https://towardsdatascience.com/using-double-machine-learning-and-linear-programming-to-optimise-treatment-strategies-920c20a29553?source=collection_archive---------2-----------------------#2024-04-26</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="61fe" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx">Causal AI, exploring the integration of causal reasoning into machine learning</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hd he hf hg hh ab"><div><div class="ab hi"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@raz1470?source=post_page---byline--920c20a29553--------------------------------" rel="noopener follow"><div class="l hj hk by hl hm"><div class="l ed"><img alt="Ryan O'Sullivan" class="l ep by dd de cx" src="../Images/7cd161d38d67d2c0b7da2d8f3e7d33fe.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/1*tAw1S072P0f0sUswKPN6VQ.jpeg"/><div class="hn by l dd de em n ho eo"/></div></div></a></div></div><div class="hp ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--920c20a29553--------------------------------" rel="noopener follow"><div class="l hq hr by hl hs"><div class="l ed"><img alt="Towards Data Science" class="l ep by br ht cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hn by l br ht em n ho eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hu ab q"><div class="ab q hv"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hw hx bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hy" data-testid="authorName" href="https://medium.com/@raz1470?source=post_page---byline--920c20a29553--------------------------------" rel="noopener follow">Ryan O'Sullivan</a></p></div></div></div><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hw hx dx"><button class="ib ic ah ai aj ak al am an ao ap aq ar id ie if" disabled="">Follow</button></p></div></div></span></div></div><div class="l ig"><span class="bf b bg z dx"><div class="ab cn ih ii ij"><div class="ik il ab"><div class="bf b bg z dx ab im"><span class="in l ig">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hy ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--920c20a29553--------------------------------" rel="noopener follow"><p class="bf b bg z io ip iq ir is it iu iv bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">11 min read</span><div class="iw ix l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Apr 26, 2024</span></div></span></div></span></div></div></div><div class="ab cp iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn"><div class="h k w ea eb q"><div class="kd l"><div class="ab q ke kf"><div class="pw-multi-vote-icon ed in kg kh ki"><div class=""><div class="kj kk kl km kn ko kp am kq kr ks ki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kt ku kv kw kx ky kz"><p class="bf b dy z dx"><span class="kk">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kj lc ld ab q ee le lf" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="lb"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg><p class="bf b dy z dx"><span class="pw-responses-count la lb">1</span></p></button></div></div></div><div class="ab q jo jp jq jr js jt ju jv jw jx jy jz ka kb kc"><div class="lg k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lh an ao ap id li lj lk" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep ll cn"><div class="l ae"><div class="ab cb"><div class="lm ln lo lp lq lr ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk ml"><img src="../Images/5253ef494d83fe5dc0bb6e3962eda71c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*N4_MQDAQxel3usX6"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Photo by <a class="af nc" href="https://unsplash.com/@jordanmcdonald?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Jordan McDonald</a> on <a class="af nc" href="https://unsplash.com/?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="fe2d" class="nd ne fq bf nf ng nh gq ni nj nk gt nl nm nn no np nq nr ns nt nu nv nw nx ny bk">What is this series of articles about?</h1><p id="b160" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">Welcome to my series on Causal AI, where we will explore the integration of causal reasoning into machine learning models. Expect to explore a number of practical applications across different business contexts.</p><p id="c384" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">In the last article we explored <em class="pa">de-biasing treatment effects with Double Machine Learning</em>. This time we will delve further into the potential of DML covering <em class="pa">using Double Machine Learning and Linear Programming to optimise treatment strategies</em>.</p><p id="b62d" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">If you missed the last article on Double Machine Learning, check it out here:</p><div class="pb pc pd pe pf pg"><a rel="noopener follow" target="_blank" href="/de-biasing-treatment-effects-with-double-machine-learning-63b16fcb3e97?source=post_page-----920c20a29553--------------------------------"><div class="ph ab ig"><div class="pi ab co cb pj pk"><h2 class="bf fr hw z io pl iq ir pm it iv fp bk">De-biasing Treatment Effects with Double Machine Learning</h2><div class="pn l"><h3 class="bf b hw z io pl iq ir pm it iv dx">Causal AI, exploring the integration of causal reasoning into machine learning</h3></div><div class="po l"><p class="bf b dy z io pl iq ir pm it iv dx">towardsdatascience.com</p></div></div><div class="pp l"><div class="pq l pr ps pt pp pu lr pg"/></div></div></a></div><h1 id="5a44" class="nd ne fq bf nf ng nh gq ni nj nk gt nl nm nn no np nq nr ns nt nu nv nw nx ny bk">Introduction</h1><p id="befc" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">This article will showcase how Double Machine Learning and Linear Programming can be used optimise treatment strategies:</p><p id="08a4" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk"><strong class="ob fr">Expect to gain a broad understanding of:</strong></p><ul class=""><li id="18be" class="nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou pv pw px bk">Why businesses want to optimise treatment strategies.</li><li id="03ea" class="nz oa fq ob b go py od oe gr pz og oh oi qa ok ol om qb oo op oq qc os ot ou pv pw px bk">How conditional average treatment effects (CATE) can help personalise treatment strategies (also known as Uplift modelling).</li><li id="985c" class="nz oa fq ob b go py od oe gr pz og oh oi qa ok ol om qb oo op oq qc os ot ou pv pw px bk">How Linear Programming can be used to optimise treatment assignment given budget constraints.</li><li id="2b50" class="nz oa fq ob b go py od oe gr pz og oh oi qa ok ol om qb oo op oq qc os ot ou pv pw px bk">A worked case study in Python illustrating how we can use Double Machine Learning to estimate CATE and Linear Programming to optimise treatment strategies.</li></ul><p id="b8cf" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">The full notebook can be found here:</p><div class="pb pc pd pe pf pg"><a href="https://github.com/raz1470/causal_ai/blob/main/notebooks/estimating%20average%20treatment%20effects%20with%20double%20machine%20learning.ipynb?source=post_page-----920c20a29553--------------------------------" rel="noopener  ugc nofollow" target="_blank"><div class="ph ab ig"><div class="pi ab co cb pj pk"><h2 class="bf fr hw z io pl iq ir pm it iv fp bk">causal_ai/notebooks/estimating average treatment effects with double machine learning.ipynb at main…</h2><div class="pn l"><h3 class="bf b hw z io pl iq ir pm it iv dx">This project introduces Causal AI and how it can drive business value. - causal_ai/notebooks/estimating average…</h3></div><div class="po l"><p class="bf b dy z io pl iq ir pm it iv dx">github.com</p></div></div><div class="pp l"><div class="qd l pr ps pt pp pu lr pg"/></div></div></a></div><h1 id="c59f" class="nd ne fq bf nf ng nh gq ni nj nk gt nl nm nn no np nq nr ns nt nu nv nw nx ny bk">Optimising treatment strategies</h1><p id="1918" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">There is a common question which arises in most businesses: “What is the optimal treatment for a customer in order to maximise future sales whilst minimising cost?”.</p><p id="a83d" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Let’s break this idea down with a simple example.</p><p id="7277" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Your business sells socks online. You don’t sell an essential product, so you need to encourage existing customers to repeat purchase. Your main lever for this is sending out discounts. So the treatment strategy in this case is sending out discounts:</p><ul class=""><li id="c773" class="nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou pv pw px bk">10% discount</li><li id="345f" class="nz oa fq ob b go py od oe gr pz og oh oi qa ok ol om qb oo op oq qc os ot ou pv pw px bk">20% discount</li><li id="c159" class="nz oa fq ob b go py od oe gr pz og oh oi qa ok ol om qb oo op oq qc os ot ou pv pw px bk">50% discount</li></ul><p id="c084" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Each discount has a different return on investment. If you think back to the last article on average treatment effects, you can probably see how we can calculate ATE for each of these discounts and then select the one with the highest return.</p><p id="e7e8" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">However, what if we have heterogenous treatment effects — The treatment effect varies across different subgroups of the population.</p><p id="3e5a" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">This is when we need to start considering conditional average treatment effects (CATE)!</p><h1 id="1ff4" class="nd ne fq bf nf ng nh gq ni nj nk gt nl nm nn no np nq nr ns nt nu nv nw nx ny bk">Conditional Average Treatment Effects (CATE)</h1><h2 id="5456" class="qe ne fq bf nf qf qg qh ni qi qj qk nl oi ql qm qn om qo qp qq oq qr qs qt qu bk">CATE</h2><p id="c36b" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">CATE is the average impact of a treatment or intervention on different subgroups of a population. ATE was very much about “does this treatment work?” whereas CATE allows us to change the question to “who should we treat?”.</p><p id="6dad" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">We “condition” on our control features to allow treatment effects to vary depending on customer characteristics.</p><p id="ff06" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Think back to the example where we are sending out discounts. If customers with a higher number of previous orders respond better to discounts, we can condition on this customer characteristic.</p><p id="6a16" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">It is worth pointing out that in Marketing, estimating CATE is often referred to as Uplift Modelling.</p><h2 id="712d" class="qe ne fq bf nf qf qg qh ni qi qj qk nl oi ql qm qn om qo qp qq oq qr qs qt qu bk">Estimating CATE with Double Machine Learning</h2><p id="bfe5" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">We covered DML in the last article, but just in case you need a bit of a refresher:</p><p id="d4b5" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">“First stage:</p><ul class=""><li id="9d1b" class="nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou pv pw px bk"><strong class="ob fr"><em class="pa">Treatment model (de-biasing):</em></strong> Machine learning model used to estimate the probability of treatment assignment (often referred to as propensity score). The treatment model residuals are then calculated.</li><li id="1b47" class="nz oa fq ob b go py od oe gr pz og oh oi qa ok ol om qb oo op oq qc os ot ou pv pw px bk"><strong class="ob fr"><em class="pa">Outcome model (de-noising):</em></strong> Machine learning model used to estimate the outcome using just the control features. The outcome model residuals are then calculated.</li></ul><p id="d811" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Second stage:</p><ul class=""><li id="088c" class="nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou pv pw px bk">The treatment model residuals are used to predict the outcome model residuals.”</li></ul><p id="6320" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">We can use Double Machine Learning to estimate CATE by interacting our control features (X) with the treatment effect in the second stage model.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk qv"><img src="../Images/ac0f8e512d75a84ea1fecff41c663885.png" data-original-src="https://miro.medium.com/v2/resize:fit:808/format:webp/1*e8x1Q8NEW3sFakmoSTo7lQ.png"/></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">User generated image</figcaption></figure><p id="b430" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">This can be really powerful as we are now able to get customer level treatment effects!</p><h1 id="c891" class="nd ne fq bf nf ng nh gq ni nj nk gt nl nm nn no np nq nr ns nt nu nv nw nx ny bk">Linear Programming</h1><h2 id="a020" class="qe ne fq bf nf qf qg qh ni qi qj qk nl oi ql qm qn om qo qp qq oq qr qs qt qu bk">What is it?</h2><p id="34d7" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">Linear programming is an optimisation method which can be used to find the optimal solution of a linear function given some constraints. It is often used to solve transportation, scheduling and resource allocation problems. A more generic term which you might see used is Operations Research.</p><p id="6b38" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Let’s break linear programming down with a simple example:</p><ul class=""><li id="1ff8" class="nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou pv pw px bk"><strong class="ob fr"><em class="pa">Decision variables: </em></strong>These are the unknown quantities which we want to estimate optimal values for — The marketing spend on Social Media, TV and Paid Search.</li><li id="1e21" class="nz oa fq ob b go py od oe gr pz og oh oi qa ok ol om qb oo op oq qc os ot ou pv pw px bk"><strong class="ob fr"><em class="pa">Objectives function:</em></strong> The linear equation we are trying to minimise or maximise — The marketing Return on Investment (ROI).</li><li id="2844" class="nz oa fq ob b go py od oe gr pz og oh oi qa ok ol om qb oo op oq qc os ot ou pv pw px bk"><strong class="ob fr"><em class="pa">Constraints:</em></strong> Some restrictions on the decision variables, usually represented by linear inequalities — Total marketing spend between £100,000 and £500,000.</li></ul><p id="4aac" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">The intersection of all constraints forms a feasible region, which is the set of all possible solutions that satisfy the given constraints. The goal of linear programming is to find the point within the feasible region that optimizes the objective function.</p><h2 id="1556" class="qe ne fq bf nf qf qg qh ni qi qj qk nl oi ql qm qn om qo qp qq oq qr qs qt qu bk">Assignment problems</h2><p id="2ef3" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">Assignment problems are a specific type of linear programming problem where the goal is to assign a set of “tasks” to a set of “agents”. Lets use an example to bring it to life:</p><p id="aae5" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">You run an experiment where you send different discounts out to 4 random groups of existing customers (the 4th of which actually you don’t send any discount). You build 2 CATE models — (1) Estimating how the offer value effects the order value and (2) Estimating how offer value effects the cost.</p><ul class=""><li id="cd86" class="nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou pv pw px bk">Agents: Your existing customer base</li><li id="fefa" class="nz oa fq ob b go py od oe gr pz og oh oi qa ok ol om qb oo op oq qc os ot ou pv pw px bk">Tasks: Whether you send them a 10%, 20% or 50% discount</li><li id="8cd8" class="nz oa fq ob b go py od oe gr pz og oh oi qa ok ol om qb oo op oq qc os ot ou pv pw px bk">Decision variables: Binary decision variable</li><li id="2036" class="nz oa fq ob b go py od oe gr pz og oh oi qa ok ol om qb oo op oq qc os ot ou pv pw px bk">Objective function: The total order value minus costs</li><li id="546b" class="nz oa fq ob b go py od oe gr pz og oh oi qa ok ol om qb oo op oq qc os ot ou pv pw px bk">Constraint 1: Each agent is assigned to at most 1 task</li><li id="c9f0" class="nz oa fq ob b go py od oe gr pz og oh oi qa ok ol om qb oo op oq qc os ot ou pv pw px bk">Constraint 2: The cost ≥ £10,000</li><li id="68e1" class="nz oa fq ob b go py od oe gr pz og oh oi qa ok ol om qb oo op oq qc os ot ou pv pw px bk">Constraint 3: The cost ≤ £100,000</li></ul><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk qw"><img src="../Images/6936fdca2a707a249350cd61af92f284.png" data-original-src="https://miro.medium.com/v2/resize:fit:1054/format:webp/1*8ueeY3tNhbf5xHckroNFlg.png"/></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">User generated image</figcaption></figure><p id="1b7b" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">We basically want to find out the optimal treatment for each customer given some overall cost constraints. And linear programming can help us do this!</p><p id="ad0c" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">It is worth noting that this problem is “NP hard”, a classification of problems that are at least as hard as the hardest problems in NP (nondeterministic polynomial time).</p><p id="a78f" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Linear programming is a really tricky but rewarding topic. I’ve tried to introduce the idea to get us started — If you want to learn more I recommend this resource:</p><div class="pb pc pd pe pf pg"><a href="https://realpython.com/linear-programming-python/?source=post_page-----920c20a29553--------------------------------" rel="noopener  ugc nofollow" target="_blank"><div class="ph ab ig"><div class="pi ab co cb pj pk"><h2 class="bf fr hw z io pl iq ir pm it iv fp bk">Hands-On Linear Programming: Optimization With Python - Real Python</h2><div class="pn l"><h3 class="bf b hw z io pl iq ir pm it iv dx">In this tutorial, you'll learn about implementing optimization in Python with linear programming libraries. Linear…</h3></div><div class="po l"><p class="bf b dy z io pl iq ir pm it iv dx">realpython.com</p></div></div><div class="pp l"><div class="qx l pr ps pt pp pu lr pg"/></div></div></a></div><h2 id="5d5e" class="qe ne fq bf nf qf qg qh ni qi qj qk nl oi ql qm qn om qo qp qq oq qr qs qt qu bk">OR Tools</h2><p id="0847" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">OR tools is an open source package developed by Google which can solve a range of linear programming problems, including assignment problems. We will demonstrate it in action later in the article.</p><div class="pb pc pd pe pf pg"><a href="https://developers.google.com/optimization?source=post_page-----920c20a29553--------------------------------" rel="noopener  ugc nofollow" target="_blank"><div class="ph ab ig"><div class="pi ab co cb pj pk"><h2 class="bf fr hw z io pl iq ir pm it iv fp bk">OR-Tools | Google for Developers</h2><div class="pn l"><h3 class="bf b hw z io pl iq ir pm it iv dx">The OR-Tools suite provides operations research software libraries and APIs for constraint optimization, linear…</h3></div><div class="po l"><p class="bf b dy z io pl iq ir pm it iv dx">developers.google.com</p></div></div><div class="pp l"><div class="qy l pr ps pt pp pu lr pg"/></div></div></a></div><h1 id="5b33" class="nd ne fq bf nf ng nh gq ni nj nk gt nl nm nn no np nq nr ns nt nu nv nw nx ny bk">Marketing Case Study</h1><h2 id="cca6" class="qe ne fq bf nf qf qg qh ni qi qj qk nl oi ql qm qn om qo qp qq oq qr qs qt qu bk">Background</h2><p id="8238" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">We are going to continue with the assignment problem example and illustrate how we can solve this in Python.</p><h2 id="07a3" class="qe ne fq bf nf qf qg qh ni qi qj qk nl oi ql qm qn om qo qp qq oq qr qs qt qu bk">Data generating process</h2><p id="72fa" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">We set up a data generating process with the following characteristics:</p><ul class=""><li id="6c8e" class="nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou pv pw px bk">Difficult nuisance parameters (b)</li><li id="b172" class="nz oa fq ob b go py od oe gr pz og oh oi qa ok ol om qb oo op oq qc os ot ou pv pw px bk">Treatment effect heterogeneity (tau)</li></ul><p id="95b0" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">The X features are customer characteristics taken before the treatment:</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk qz"><img src="../Images/8afb0c2d4588af0545c01cc9248d533d.png" data-original-src="https://miro.medium.com/v2/resize:fit:554/format:webp/1*x77ovi9hSa2IjJpoqQexbA.png"/></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">User generated image</figcaption></figure><p id="b006" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">T is a binary flag indicating whether the customer received the offer. We create three different treatment interactions to allow us to simulate different treatment effects.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk ra"><img src="../Images/0c53dd6127d10b58a8b3d16279cac3b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aaQEc_52in_8gmJ6tiV12g.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">User generated image</figcaption></figure><pre class="mm mn mo mp mq rb rc rd bp re bb bk"><span id="36e0" class="rf ne fq rc b bg rg rh l ri rj">def data_generator(tau_weight, interaction_num):<br/>    <br/>    # Set number of observations<br/>    n=10000<br/><br/>    # Set number of features<br/>    p=10<br/><br/>    # Create features<br/>    X = np.random.uniform(size=n * p).reshape((n, -1))<br/><br/>    # Nuisance parameters<br/>    b = (<br/>        np.sin(np.pi * X[:, 0] * X[:, 1])<br/>        + 2 * (X[:, 2] - 0.5) ** 2<br/>        + X[:, 3]<br/>        + 0.5 * X[:, 4]<br/>        + X[:, 5] * X[:, 6]<br/>        + X[:, 7] ** 3<br/>        + np.sin(np.pi * X[:, 8] * X[:, 9])<br/>    )<br/><br/>    # Create binary treatment<br/>    T = np.random.binomial(1, expit(b))<br/><br/>    # treatment interactions<br/>    interaction_1 = X[:, 0] * X[:, 1] + X[:, 2]<br/>    interaction_2 = X[:, 3] * X[:, 4] + X[:, 5]<br/>    interaction_3 = X[:, 6] * X[:, 7] + X[:, 9]<br/><br/>    # Set treatment effect<br/>    if interaction_num==1:<br/>        tau = tau_weight * interaction_1<br/>    elif interaction_num==2:<br/>        tau = tau_weight * interaction_2<br/>    elif interaction_num==3:<br/>        tau = tau_weight * interaction_3<br/><br/>    # Calculate outcome<br/>    y = b + T * tau + np.random.normal(size=n)<br/>    <br/>    return X, T, tau, y</span></pre><p id="b167" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">We can use the data generator to simulate three treatments, each with a different treatment effect.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk rk"><img src="../Images/73cd2e166adf8aa3eaade2a83fa22f4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:398/format:webp/1*CVuFdFp2QITyPeObYN0Msg.png"/></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">User generated image</figcaption></figure><pre class="mm mn mo mp mq rb rc rd bp re bb bk"><span id="82d1" class="rf ne fq rc b bg rg rh l ri rj">np.random.seed(123)<br/><br/># Generate samples for 3 different treatments<br/>X1, T1, tau1, y1 = data_generator(0.75, 1)<br/>X2, T2, tau2, y2 = data_generator(0.50, 2)<br/>X3, T3, tau3, y3 = data_generator(0.90, 3)</span></pre><p id="f136" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">As in the last article, the data generating process python code is based on the synthetic data creator from Ubers Causal ML package:</p><div class="pb pc pd pe pf pg"><a href="https://github.com/uber/causalml/blob/master/causalml/dataset/regression.py?source=post_page-----920c20a29553--------------------------------" rel="noopener  ugc nofollow" target="_blank"><div class="ph ab ig"><div class="pi ab co cb pj pk"><h2 class="bf fr hw z io pl iq ir pm it iv fp bk">causalml/causalml/dataset/regression.py at master · uber/causalml</h2><div class="pn l"><h3 class="bf b hw z io pl iq ir pm it iv dx">Uplift modeling and causal inference with machine learning algorithms - causalml/causalml/dataset/regression.py at…</h3></div><div class="po l"><p class="bf b dy z io pl iq ir pm it iv dx">github.com</p></div></div></div></a></div><h2 id="9c14" class="qe ne fq bf nf qf qg qh ni qi qj qk nl oi ql qm qn om qo qp qq oq qr qs qt qu bk">Estimating CATE with DML</h2><p id="06c2" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">We then train three DML models using LightGBM as flexible first stage models. This should allow us to capture the difficult nuisance parameters whilst correctly calculating the treatment effect.</p><p id="4a73" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Pay attention to how we pass the X features in through X rather than W (unlike in the last article where we passed the X features through W). Features passed through X will be used in both the first and second stage models — In the second stage model the features are used to create interaction terms with the treatment residual.</p><pre class="mm mn mo mp mq rb rc rd bp re bb bk"><span id="d950" class="rf ne fq rc b bg rg rh l ri rj">np.random.seed(123)<br/><br/># Train DML model using flexible stage 1 models<br/>dml1 = LinearDML(model_y=LGBMRegressor(), model_t=LGBMClassifier(), discrete_treatment=True)<br/>dml1.fit(y1, T=T1, X=X1, W=None)<br/><br/># Train DML model using flexible stage 1 models<br/>dml2 = LinearDML(model_y=LGBMRegressor(), model_t=LGBMClassifier(), discrete_treatment=True)<br/>dml2.fit(y2, T=T2, X=X2, W=None)<br/><br/># Train DML model using flexible stage 1 models<br/>dml3 = LinearDML(model_y=LGBMRegressor(), model_t=LGBMClassifier(), discrete_treatment=True)<br/>dml3.fit(y3, T=T3, X=X3, W=None)</span></pre><p id="b582" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">When we plot the actual vs estimated CATE, we see that the model does a reasonable job.</p><pre class="mm mn mo mp mq rb rc rd bp re bb bk"><span id="9f4c" class="rf ne fq rc b bg rg rh l ri rj"># Create a figure and subplots<br/>fig, axes = plt.subplots(1, 3, figsize=(15, 5))<br/><br/># Plot scatter plots on each subplot<br/>sns.scatterplot(x=dml1.effect(X1), y=tau1, ax=axes[0])<br/>axes[0].set_title('Treatment 1')<br/>axes[0].set_xlabel('Estimated CATE')<br/>axes[0].set_ylabel('Actual CATE')<br/><br/>sns.scatterplot(x=dml2.effect(X2), y=tau2, ax=axes[1])<br/>axes[1].set_title('Treatment 2')<br/>axes[1].set_xlabel('Estimated CATE')<br/>axes[1].set_ylabel('Actual CATE')<br/><br/>sns.scatterplot(x=dml3.effect(X3), y=tau3, ax=axes[2])<br/>axes[2].set_title('Treatment 3')<br/>axes[2].set_xlabel('Estimated CATE')<br/>axes[2].set_ylabel('Actual CATE')<br/><br/># Add labels to the entire figure<br/>fig.suptitle('Actual vs Estimated')<br/><br/># Show plots<br/>plt.show()</span></pre><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk rl"><img src="../Images/1c1e7cd98de1b3a24a3dacbe62241ee3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NXfaTWQrV_hF0WO2wGohOA.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">User generated image</figcaption></figure><h2 id="1b7e" class="qe ne fq bf nf qf qg qh ni qi qj qk nl oi ql qm qn om qo qp qq oq qr qs qt qu bk">Naive optimisation</h2><p id="55f8" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">We will start by exploring this as an optimisation problem. We have a three treatments which a customer could receive. Below we create a mapping for the cost of each treatment, and set an overall cost constraint.</p><pre class="mm mn mo mp mq rb rc rd bp re bb bk"><span id="445e" class="rf ne fq rc b bg rg rh l ri rj"># Create mapping for cost of each treatment<br/>cost_dict = {'T1': 0.1, 'T2': 0.2, 'T3': 0.3}<br/><br/># Set constraints<br/>max_cost = 3000</span></pre><p id="ea20" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">We can then estimate the CATE for each customer and then initially select each customers best treatment. However, selecting the best treatment doesn’t keep us within the maximum cost constraint. Therefore select the customers with the highest CATE until we reach our max cost constraint.</p><pre class="mm mn mo mp mq rb rc rd bp re bb bk"><span id="9177" class="rf ne fq rc b bg rg rh l ri rj"># Concatenate features<br/>X = np.concatenate((X1, X2, X3), axis=0)<br/><br/># Estimate CATE for each treatment using DML models<br/>Treatment_1 = dml1.effect(X)<br/>Treatment_2 = dml2.effect(X)<br/>Treatment_3 = dml3.effect(X)<br/>cate = pd.DataFrame({"T1": Treatment_1, "T2": Treatment_2, "T3": Treatment_3})<br/><br/># Select the best treatment for each customer<br/>best_treatment = cate.idxmax(axis=1)<br/>best_value = cate.max(axis=1)<br/><br/># Map cost for each treatment<br/>best_cost = pd.Series([cost_dict[value] for value in best_treatment])<br/><br/># Create dataframe with each customers best treatment and associated cost<br/>best_df = pd.concat([best_value, best_cost], axis=1)<br/>best_df.columns = ["value", "cost"]<br/>best_df = best_df.sort_values(by=['value'], ascending=False).reset_index(drop=True)<br/><br/># Naive optimisation<br/>best_df_cum = best_df.cumsum()<br/>opt_index = best_df_cum['cost'].searchsorted(max_cost)<br/>naive_order_value = round(best_df_cum.iloc[opt_index]['value'], 0)<br/>naive_cost_check = round(best_df_cum.iloc[opt_index]['cost'], 0)<br/><br/>print(f'The total order value from the naive treatment strategy is {naive_order_value} with a cost of {naive_cost_check}')</span></pre><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk rm"><img src="../Images/a46b695da116108f0e4be158e342bb1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lLfkAwAiKw0S52B12UDDMg.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">User generated image</figcaption></figure><h2 id="4870" class="qe ne fq bf nf qf qg qh ni qi qj qk nl oi ql qm qn om qo qp qq oq qr qs qt qu bk">Optimising treatment strategies with Linear Programming</h2><p id="1bf9" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">We start by creating a dataframe with the cost of each treatment for each customer.</p><pre class="mm mn mo mp mq rb rc rd bp re bb bk"><span id="01d4" class="rf ne fq rc b bg rg rh l ri rj"># Cost mapping for all treatments<br/>cost_mapping = {'T1': [cost_dict["T1"]] * 30000,<br/>                'T2': [cost_dict["T2"]] * 30000,<br/>                'T3': [cost_dict["T3"]] * 30000}<br/><br/># Create DataFrame<br/>df_costs = pd.DataFrame(cost_mapping)</span></pre><p id="adce" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Now it’s time to use the OR Tools package to solve this assignment problem! The code takes the following inputs:</p><ul class=""><li id="8269" class="nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou pv pw px bk">Cost constraints</li><li id="c0b6" class="nz oa fq ob b go py od oe gr pz og oh oi qa ok ol om qb oo op oq qc os ot ou pv pw px bk">Array containing the cost of each treatment for each customer</li><li id="6925" class="nz oa fq ob b go py od oe gr pz og oh oi qa ok ol om qb oo op oq qc os ot ou pv pw px bk">Array containing the estimated order value for each treatment for each customer</li></ul><p id="fb53" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">The code outputs a dataframe with each customers potential treatment, and a column indicating which one is the optimal assignment.</p><pre class="mm mn mo mp mq rb rc rd bp re bb bk"><span id="f929" class="rf ne fq rc b bg rg rh l ri rj">solver = pywraplp.Solver.CreateSolver('SCIP')<br/><br/># Set constraints<br/>max_cost = 3000<br/>min_cost = 3000<br/><br/># Create input arrays<br/>costs = df_costs.to_numpy()<br/>order_value = cate.to_numpy()<br/><br/>num_custs = len(costs)<br/>num_treatments = len(costs[0])<br/><br/># x[i, j] is an array of 0-1 variables, which will be 1 if customer i is assigned to treatment j.<br/>x = {}<br/>for i in range(num_custs):<br/>    for j in range(num_treatments):<br/>        x[i, j] = solver.IntVar(0, 1, '')<br/>    <br/># Each customer is assigned to at most 1 treatment.<br/>for i in range(num_custs):<br/>    solver.Add(solver.Sum([x[i, j] for j in range(num_treatments)]) &lt;= 1)<br/><br/># Cost constraints<br/>solver.Add(sum([costs[i][j] * x[i, j] for j in range(num_treatments) for i in range(num_custs)]) &lt;= max_cost)<br/>solver.Add(sum([costs[i][j] * x[i, j] for j in range(num_treatments) for i in range(num_custs)]) &gt;= min_cost)<br/><br/># Objective<br/>objective_terms = []<br/>for i in range(num_custs):<br/>    for j in range(num_treatments):<br/>        objective_terms.append((order_value[i][j] * x[i, j] - costs[i][j] * x[i, j] ))<br/>solver.Maximize(solver.Sum(objective_terms))<br/><br/># Solve<br/>status = solver.Solve()<br/><br/>assignments = []<br/>values = []<br/><br/>if status == pywraplp.Solver.OPTIMAL or status == pywraplp.Solver.FEASIBLE:<br/>    for i in range(num_custs):<br/>        for j in range(num_treatments):<br/>            # Test if x[i,j] is 1 (with tolerance for floating point arithmetic).<br/>            if x[i, j].solution_value() &gt; -0.5:<br/>                assignments.append([i, j])<br/>                values.append([x[i, j].solution_value(), costs[i][j] * x[i, j].solution_value(), order_value[i][j]])<br/><br/># Create a DataFrame from the collected data<br/>df = pd.DataFrame(assignments, columns=['customer', 'treatment'])<br/>df['assigned'] = [x[0] for x in values]<br/>df['cost'] = [x[1] for x in values]<br/>df['order_value'] = [x[2] for x in values]<br/><br/>df</span></pre><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk rn"><img src="../Images/58259d64a587b13f48a54939e79ab795.png" data-original-src="https://miro.medium.com/v2/resize:fit:1026/format:webp/1*7qoQ3CAzDMQOgBGWR-cEeA.png"/></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">User generated image</figcaption></figure><p id="93cb" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Whilst keeping to the cost constraint of £3k, we can generate £18k in order value using the optimised treatment strategy. This is 36% higher than the naive approach!</p><pre class="mm mn mo mp mq rb rc rd bp re bb bk"><span id="12fe" class="rf ne fq rc b bg rg rh l ri rj">opt_order_value = round(df['order_value'][df['assigned'] == 1].sum(), 0)<br/>opt_cost_check = round(df['cost'][df['assigned'] == 1].sum(), 0)<br/><br/>print(f'The total order value from the optimised treatment strategy is {opt_order_value} with a cost of {opt_cost_check}')</span></pre><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk ro"><img src="../Images/b2a5b7d0562553c7365d3dbd6f3a9ffb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q5HivDmww-30pZEnYoIWOg.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">User generated image</figcaption></figure><h1 id="fbd7" class="nd ne fq bf nf ng nh gq ni nj nk gt nl nm nn no np nq nr ns nt nu nv nw nx ny bk">Final thoughts</h1><p id="a7ef" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">Today we covered using Double Machine Learning and Linear Programming to optimise treatment strategies. Here are some closing thoughts:</p><ul class=""><li id="aa33" class="nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou pv pw px bk">We covered Linear DML, you may want to explore alternative approaches which are more suited to dealing with complex interaction effects in the second stage model:</li></ul><div class="pb pc pd pe pf pg"><a href="https://github.com/py-why/EconML/blob/main/notebooks/Double%20Machine%20Learning%20Examples.ipynb?source=post_page-----920c20a29553--------------------------------" rel="noopener  ugc nofollow" target="_blank"><div class="ph ab ig"><div class="pi ab co cb pj pk"><h2 class="bf fr hw z io pl iq ir pm it iv fp bk">EconML/notebooks/Double Machine Learning Examples.ipynb at main · py-why/EconML</h2><div class="pn l"><h3 class="bf b hw z io pl iq ir pm it iv dx">ALICE (Automated Learning and Intelligence for Causation and Economics) is a Microsoft Research project aimed at…</h3></div><div class="po l"><p class="bf b dy z io pl iq ir pm it iv dx">github.com</p></div></div><div class="pp l"><div class="rp l pr ps pt pp pu lr pg"/></div></div></a></div><ul class=""><li id="9630" class="nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou pv pw px bk">But also remember you don’t have to use DML, other methods like T-Learner or DR-Learner could be used.</li><li id="5fb8" class="nz oa fq ob b go py od oe gr pz og oh oi qa ok ol om qb oo op oq qc os ot ou pv pw px bk">To keep this article to a quick read I did not tune the hyper-parameters — As we increase the complexity of the problem and approach used, we need to pay closer attention to this part.</li><li id="f9de" class="nz oa fq ob b go py od oe gr pz og oh oi qa ok ol om qb oo op oq qc os ot ou pv pw px bk">Linear programming/assignment problems are NP hard, so if you have a large customer base and/or several treatments this part of the code may take a long time to run.</li><li id="ed7b" class="nz oa fq ob b go py od oe gr pz og oh oi qa ok ol om qb oo op oq qc os ot ou pv pw px bk">It can be challenging operationalising a daily pipeline with linear programming/assignment problems — An alternative is running the optimisation periodically and learning the optimal policy based on the results in order to create a segmentation to use in a daily pipeline.</li></ul></div></div></div><div class="ab cb rq rr rs rt" role="separator"><span class="ru by bm rv rw rx"/><span class="ru by bm rv rw rx"/><span class="ru by bm rv rw"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="1938" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Follow me if you want to continue this journey into Causal AI — In the next article we will explore how we can estimate non-linear treatment effects in pricing and marketing optimisation problems.</p></div></div></div></div>    
</body>
</html>