<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Create an Agent with OpenAI Function Calling Capabilities</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Create an Agent with OpenAI Function Calling Capabilities</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/create-an-agent-with-openai-function-calling-capabilities-ad52122c3d12?source=collection_archive---------3-----------------------#2024-03-31">https://towardsdatascience.com/create-an-agent-with-openai-function-calling-capabilities-ad52122c3d12?source=collection_archive---------3-----------------------#2024-03-31</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="7557" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx">OpenAI Function Calling in 2024</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hd he hf hg hh ab"><div><div class="ab hi"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@bianbianzhu123?source=post_page---byline--ad52122c3d12--------------------------------" rel="noopener follow"><div class="l hj hk by hl hm"><div class="l ed"><img alt="Tianyi Li" class="l ep by dd de cx" src="../Images/40fce472f42c650daa1433641bf732df.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/da:true/resize:fill:88:88/0*Maf5doyZMjEIBpI6"/><div class="hn by l dd de em n ho eo"/></div></div></a></div></div><div class="hp ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--ad52122c3d12--------------------------------" rel="noopener follow"><div class="l hq hr by hl hs"><div class="l ed"><img alt="Towards Data Science" class="l ep by br ht cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hn by l br ht em n ho eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hu ab q"><div class="ab q hv"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hw hx bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hy" data-testid="authorName" href="https://medium.com/@bianbianzhu123?source=post_page---byline--ad52122c3d12--------------------------------" rel="noopener follow">Tianyi Li</a></p></div></div></div><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hw hx dx"><button class="ib ic ah ai aj ak al am an ao ap aq ar id ie if" disabled="">Follow</button></p></div></div></span></div></div><div class="l ig"><span class="bf b bg z dx"><div class="ab cn ih ii ij"><div class="ik il ab"><div class="bf b bg z dx ab im"><span class="in l ig">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hy ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--ad52122c3d12--------------------------------" rel="noopener follow"><p class="bf b bg z io ip iq ir is it iu iv bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">15 min read</span><div class="iw ix l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Mar 31, 2024</span></div></span></div></span></div></div></div><div class="ab cp iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn"><div class="h k w ea eb q"><div class="kd l"><div class="ab q ke kf"><div class="pw-multi-vote-icon ed in kg kh ki"><div class=""><div class="kj kk kl km kn ko kp am kq kr ks ki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kt ku kv kw kx ky kz"><p class="bf b dy z dx"><span class="kk">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kj lc ld ab q ee le lf" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="lb"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg><p class="bf b dy z dx"><span class="pw-responses-count la lb">2</span></p></button></div></div></div><div class="ab q jo jp jq jr js jt ju jv jw jx jy jz ka kb kc"><div class="lg k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lh an ao ap id li lj lk" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep ll cn"><div class="l ae"><div class="ab cb"><div class="lm ln lo lp lq lr ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk ml"><img src="../Images/c3386f14f9203c4c638eb602716bc548.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s6xecLnXymAByi6yyjJveg.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Image generated by <a class="af nc" href="https://openai.com/dall-e-3" rel="noopener ugc nofollow" target="_blank">DALL·E 3</a></figcaption></figure><p id="a96f" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk"><strong class="nf fr">Authors</strong>: <span class="ia"><span class="ia" aria-hidden="false"><a class="nz ib oa" href="https://medium.com/u/4092d7367010?source=post_page---user_mention--ad52122c3d12--------------------------------" rel="noopener" target="_blank">Tianyi Li</a></span></span>, <span class="ia"><span class="ia" aria-hidden="false"><a class="nz ib oa" href="https://medium.com/u/7b9ea39b0d79?source=post_page---user_mention--ad52122c3d12--------------------------------" rel="noopener" target="_blank">Selina Li</a></span></span></p><p id="bd50" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">· <a class="af nc" href="#bd50" rel="noopener ugc nofollow">Introduction</a><br/>· <a class="af nc" href="#8727" rel="noopener ugc nofollow">What AI can do</a><br/>· <a class="af nc" href="#77ee" rel="noopener ugc nofollow">Current challenges</a><br/>· <a class="af nc" href="#d52b" rel="noopener ugc nofollow">How it works</a><br/> ∘ <a class="af nc" href="#cfee" rel="noopener ugc nofollow">Four key concepts that may be confusing at first:</a><br/>· <a class="af nc" href="#98f6" rel="noopener ugc nofollow">Step-by-Step Guide to Building an Agent</a><br/> ∘ <a class="af nc" href="#4c18" rel="noopener ugc nofollow">Business Case: Development of a Farm Trip Assistant Agent</a><br/> ∘ <a class="af nc" href="#6729" rel="noopener ugc nofollow">Application Architecture:</a><br/> ∘ <a class="af nc" href="#6df5" rel="noopener ugc nofollow">Pre-requisites:</a><br/> ∘ <a class="af nc" href="#b04f" rel="noopener ugc nofollow">Step 1: Prepare to call the model:</a><br/> ∘ <a class="af nc" href="#d998" rel="noopener ugc nofollow">Step 2: Define the tools</a><br/> ∘ <a class="af nc" href="#0df9" rel="noopener ugc nofollow">Step 3: Call the model with the messages and the tools</a><br/> ∘ <a class="af nc" href="#5cd8" rel="noopener ugc nofollow">Step 4: Handling Model Responses</a><br/> ∘ <a class="af nc" href="#de43" rel="noopener ugc nofollow">Step 5: Execute the function and call the model again</a><br/> ∘ <a class="af nc" href="#0f4e" rel="noopener ugc nofollow">Step 6: Summarize the results back to the user</a><br/>· <a class="af nc" href="#dbba" rel="noopener ugc nofollow">Conclusion</a><br/>· <a class="af nc" href="#1c90" rel="noopener ugc nofollow">Enjoyed This Story?</a></p><p id="74b8" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">As we navigate through 2024, the rush to develop AI-powered applications is unmistakable, thanks to their clear benefits.</p><p id="eeea" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Traditionally, creating an app involves writing separate functions or services for each feature, like user login or booking a ticket. This process often requires users to fill out forms, ticking boxes and entering data, which must then pass through various validation checks to ensure that the data is usable. This method, especially when involving multiple steps, significantly detracts from the user experience.</p><p id="6ee0" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Consider planning a one-day farm trip for Easter. You’re undecided about the date but have specific requirements: the farm must be within a two-hour drive, offer certain activities, have cloudy weather (as your child is allergic to the sun), and you need to consult your partner before making a decision. The traditional approach would involve navigating through multiple pages, steps, and forms — a snapshot of the complexities in daily decision-making. This complexity is a key reason why, despite the prevalence of booking websites, many still prefer the personalized service of a travel agent for planning trips.</p></div></div></div><div class="ab cb ob oc od oe" role="separator"><span class="of by bm og oh oi"/><span class="of by bm og oh oi"/><span class="of by bm og oh"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><h1 id="8727" class="oj ok fq bf ol om on gq oo op oq gt or os ot ou ov ow ox oy oz pa pb pc pd pe bk">What AI can do</h1><p id="3fa2" class="pw-post-body-paragraph nd ne fq nf b go pf nh ni gr pg nk nl nm ph no np nq pi ns nt nu pj nw nx ny fj bk">AI introduces significant improvements by:</p><ol class=""><li id="1acb" class="nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny pk pl pm bk">Providing a conversational experience, making interactions feel more natural and user-friendly.</li><li id="3f08" class="nd ne fq nf b go pn nh ni gr po nk nl nm pp no np nq pq ns nt nu pr nw nx ny pk pl pm bk">Consolidating app features into a single entry point. Unlike traditional apps, where different pages and forms are needed for different functions, AI can interpret user inputs and seamlessly select and execute the necessary functions, even handling complex requests in a step-by-step manner.</li></ol><p id="7f98" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">However, a major challenge remains: dealing with the unstructured text data returned by AI models.</p><p id="7477" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Traditionally, extracting structured data (like JSON) from model outputs required complex prompt engineering or regular expressions (RegEx), which can be error-prone and inconsistent due to the unpredictable nature of AI models and the variability of user inputs.</p><p id="af10" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">To address this, OpenAI has rolled out two innovative features: <code class="cx ps pt pu pv b">Json mode</code> and <code class="cx ps pt pu pv b">Function calling</code>. This article will delve into the Function calling feature, illustrating how it streamlines the extraction of structured data from model outputs, complemented by TypeScript code examples.</p><p id="1f52" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Discover all the code examples in this <a class="af nc" href="https://github.com/bianbianzhu/openai-function-calling" rel="noopener ugc nofollow" target="_blank">Github repository</a> and consider giving it a star if you find it useful.</p></div></div></div><div class="ab cb ob oc od oe" role="separator"><span class="of by bm og oh oi"/><span class="of by bm og oh oi"/><span class="of by bm og oh"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><h1 id="77ee" class="oj ok fq bf ol om on gq oo op oq gt or os ot ou ov ow ox oy oz pa pb pc pd pe bk">Current challenges</h1><ul class=""><li id="ecb1" class="nd ne fq nf b go pf nh ni gr pg nk nl nm ph no np nq pi ns nt nu pj nw nx ny pw pl pm bk">Structured Data Handling: Previously, developers relied on RegEx or intricate prompt engineering to parse text data, a process fraught with complexity and errors. Function Calling simplifies this by allowing models to process user-defined functions, generating structured outputs like JSON without the need for cumbersome techniques.</li><li id="1845" class="nd ne fq nf b go pn nh ni gr po nk nl nm pp no np nq pq ns nt nu pr nw nx ny pw pl pm bk">Consistency and Predictability: Function Calling ensures consistent and predictable outcomes from AI models by enabling the definition of custom functions for precise information extraction. This guarantees structured and reliable outputs across varied inputs, essential for applications requiring dependable data extraction for text summarization, document analysis, and integrations with external APIs or databases.</li></ul></div></div></div><div class="ab cb ob oc od oe" role="separator"><span class="of by bm og oh oi"/><span class="of by bm og oh oi"/><span class="of by bm og oh"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><h1 id="d52b" class="oj ok fq bf ol om on gq oo op oq gt or os ot ou ov ow ox oy oz pa pb pc pd pe bk">How it works</h1><p id="3999" class="pw-post-body-paragraph nd ne fq nf b go pf nh ni gr pg nk nl nm ph no np nq pi ns nt nu pj nw nx ny fj bk">According to <a class="af nc" href="https://platform.openai.com/docs/guides/function-calling" rel="noopener ugc nofollow" target="_blank">OpenAI’s documentation</a>, the basic sequence of steps for function calling is as follows:</p><ol class=""><li id="cdbd" class="nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny pk pl pm bk">Call the model with the user query and a set of functions defined in the functions(tools) parameter.</li><li id="d10b" class="nd ne fq nf b go pn nh ni gr po nk nl nm pp no np nq pq ns nt nu pr nw nx ny pk pl pm bk">The model can choose to call one or more functions; if so, the content will be a stringified JSON object adhering to your custom schema (note: the model may hallucinate parameters).</li><li id="5533" class="nd ne fq nf b go pn nh ni gr po nk nl nm pp no np nq pq ns nt nu pr nw nx ny pk pl pm bk">Parse the string into JSON in your code, and call your function with the provided arguments if they exist.</li><li id="8dce" class="nd ne fq nf b go pn nh ni gr po nk nl nm pp no np nq pq ns nt nu pr nw nx ny pk pl pm bk">Call the model again by appending the function response as a new message, and let the model summarize the results back to the user.</li></ol></div></div><div class="mr"><div class="ab cb"><div class="lm px ln py lo pz cf qa cg qb ci bh"><figure class="mm mn mo mp mq mr qd qe paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk qc"><img src="../Images/2f7e826c238feb17d00a04b394e00016.png" data-original-src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*CW_yAr-qv1sRCm13YFskrw.jpeg"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">A sequence diagram of how OpenAI function calling works</figcaption></figure></div></div></div><div class="ab cb"><div class="ci bh ev ew ex ey"><h2 id="cfee" class="qf ok fq bf ol qg qh qi oo qj qk ql or nm qm qn qo nq qp qq qr nu qs qt qu qv bk">Four key concepts that may be confusing at first:</h2><ol class=""><li id="c952" class="nd ne fq nf b go pf nh ni gr pg nk nl nm ph no np nq pi ns nt nu pj nw nx ny pk pl pm bk"><strong class="nf fr">Tools</strong>: The term <code class="cx ps pt pu pv b">Functions</code> is depreciated and replaced by <code class="cx ps pt pu pv b">Tools</code>. Currently, <code class="cx ps pt pu pv b">Tools</code> exclusively support what is essentially the function type. Essentially, this change is in name and syntax</li><li id="8b77" class="nd ne fq nf b go pn nh ni gr po nk nl nm pp no np nq pq ns nt nu pr nw nx ny pk pl pm bk"><strong class="nf fr">Tools Description</strong>: When we say you’re passing “tools” to the model, think of it as providing a list or menu of what the model can do, not the actual functions. It’s like telling the model, “Here are the actions you can choose to perform,” without giving it the direct means to do so.</li><li id="d89f" class="nd ne fq nf b go pn nh ni gr po nk nl nm pp no np nq pq ns nt nu pr nw nx ny pk pl pm bk"><strong class="nf fr">Function Call Returns</strong>: When the model suggests a function call, it’s essentially saying, “I think we should use this tool and here’s what we need for it,” by naming the function and specifying any required information (<code class="cx ps pt pu pv b">arguments</code>). However, at this point, it's just a suggestion; the actual action is carried out in your application.</li><li id="5bc0" class="nd ne fq nf b go pn nh ni gr po nk nl nm pp no np nq pq ns nt nu pr nw nx ny pk pl pm bk"><strong class="nf fr">Using Responses to Inform the Next Steps</strong>: Once a function is actually executed in your application and you have the results, you feed these results back to the model as part of a new prompt. This helps the model understand what happened and guides it in making the next move or response.</li></ol></div></div></div><div class="ab cb ob oc od oe" role="separator"><span class="of by bm og oh oi"/><span class="of by bm og oh oi"/><span class="of by bm og oh"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><h1 id="98f6" class="oj ok fq bf ol om on gq oo op oq gt or os ot ou ov ow ox oy oz pa pb pc pd pe bk">Step-by-Step Guide to Building an Agent</h1><h2 id="4c18" class="qf ok fq bf ol qg qh qi oo qj qk ql or nm qm qn qo nq qp qq qr nu qs qt qu qv bk">Business Case: Development of a Farm Trip Assistant Agent</h2><p id="efe0" class="pw-post-body-paragraph nd ne fq nf b go pf nh ni gr pg nk nl nm ph no np nq pi ns nt nu pj nw nx ny fj bk">We aim to develop a farm trip assistant agent designed to enhance the user experience in planning farm visits. This digital assistant will offer comprehensive support by:</p><ul class=""><li id="ac8e" class="nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny pw pl pm bk">Identifying top farm destinations tailored to user location.</li><li id="9060" class="nd ne fq nf b go pn nh ni gr po nk nl nm pp no np nq pq ns nt nu pr nw nx ny pw pl pm bk">Providing detailed information on available activities at each farm.</li><li id="0079" class="nd ne fq nf b go pn nh ni gr po nk nl nm pp no np nq pq ns nt nu pr nw nx ny pw pl pm bk">Facilitating the booking of selected activities.</li><li id="3f12" class="nd ne fq nf b go pn nh ni gr po nk nl nm pp no np nq pq ns nt nu pr nw nx ny pw pl pm bk">Offering a straightforward process for filing complaints, if necessary.</li></ul><h2 id="6729" class="qf ok fq bf ol qg qh qi oo qj qk ql or nm qm qn qo nq qp qq qr nu qs qt qu qv bk">Application Architecture:</h2><p id="d9e7" class="pw-post-body-paragraph nd ne fq nf b go pf nh ni gr pg nk nl nm ph no np nq pi ns nt nu pj nw nx ny fj bk">This flowchart shows the architecture of the application:</p></div></div><div class="mr"><div class="ab cb"><div class="lm px ln py lo pz cf qa cg qb ci bh"><figure class="mm mn mo mp mq mr qd qe paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk qw"><img src="../Images/41b3331d39fbdf6b9b01c9b61286959c.png" data-original-src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*bxV2sn5goW6TgRHxppGJHA.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">The flowchart of the agent</figcaption></figure></div></div></div><div class="ab cb"><div class="ci bh ev ew ex ey"><h2 id="6df5" class="qf ok fq bf ol qg qh qi oo qj qk ql or nm qm qn qo nq qp qq qr nu qs qt qu qv bk">Pre-requisites:</h2><p id="fc54" class="pw-post-body-paragraph nd ne fq nf b go pf nh ni gr pg nk nl nm ph no np nq pi ns nt nu pj nw nx ny fj bk"><strong class="nf fr">OpenAI API key</strong>: You can obtain this from the OpenAI platform.</p><h2 id="b04f" class="qf ok fq bf ol qg qh qi oo qj qk ql or nm qm qn qo nq qp qq qr nu qs qt qu qv bk">Step 1: Prepare to call the model:</h2><p id="7af8" class="pw-post-body-paragraph nd ne fq nf b go pf nh ni gr pg nk nl nm ph no np nq pi ns nt nu pj nw nx ny fj bk">To initiate a conversation, begin with a system message and a user prompt for the task:</p><ul class=""><li id="ef9a" class="nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny pw pl pm bk">Create a <code class="cx ps pt pu pv b">messages</code> array to keep track of the conversation history.</li><li id="293e" class="nd ne fq nf b go pn nh ni gr po nk nl nm pp no np nq pq ns nt nu pr nw nx ny pw pl pm bk">Include a system message in the <code class="cx ps pt pu pv b">messages</code> array to to establish the assistant's role and context.</li><li id="d3ac" class="nd ne fq nf b go pn nh ni gr po nk nl nm pp no np nq pq ns nt nu pr nw nx ny pw pl pm bk">Welcome the users with a greeting message and prompt them to specify their task.</li><li id="8cd6" class="nd ne fq nf b go pn nh ni gr po nk nl nm pp no np nq pq ns nt nu pr nw nx ny pw pl pm bk">Add the user prompt to the <code class="cx ps pt pu pv b">messages</code> array.</li></ul><pre class="mm mn mo mp mq qx pv qy bp qz bb bk"><span id="cc35" class="ra ok fq pv b bg rb rc l rd re">const messages: ChatCompletionMessageParam[] = [];<br/><br/>console.log(StaticPrompts.welcome);<br/><br/>messages.push(SystemPrompts.context);<br/><br/>const userPrompt = await createUserMessage();<br/>messages.push(userPrompt);</span></pre><p id="df24" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">As my personal preference, all the prompts are stored in objects for easy access and modification. Please refer to the following code snippets for all the prompts used in the application. Feel free to adopt or modify this approach as suits you.</p><ul class=""><li id="e067" class="nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny pw pl pm bk"><strong class="nf fr">StaticPrompts</strong>: Static messages that are used throughout the conversation.</li></ul><pre class="mm mn mo mp mq qx pv qy bp qz bb bk"><span id="3a4d" class="ra ok fq pv b bg rb rc l rd re">export const StaticPrompts = {<br/>  welcome:<br/>    "Welcome to the farm assistant! What can I help you with today? You can ask me what I can do.",<br/>  fallback: "I'm sorry, I don't understand.",<br/>  end: "I hope I was able to help you. Goodbye!",<br/>} as const;</span></pre><ul class=""><li id="e04f" class="nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny pw pl pm bk"><strong class="nf fr">UserPrompts</strong>: User messages that are generated based on user input.</li></ul><pre class="mm mn mo mp mq qx pv qy bp qz bb bk"><span id="af98" class="ra ok fq pv b bg rb rc l rd re">import OpenAI from "openai";<br/>type ChatCompletionUserMessageParam = OpenAI.ChatCompletionUserMessageParam;<br/><br/>type UserPromptKey = "task";<br/>type UserPromptValue = (userInput?: string) =&gt; ChatCompletionUserMessageParam;<br/><br/>export const UserPrompts: Record&lt;UserPromptKey, UserPromptValue&gt; = {<br/>  task: (userInput) =&gt; ({<br/>    role: "user",<br/>    content: userInput || "What can you do?",<br/>  }),<br/>};</span></pre><ul class=""><li id="c3f7" class="nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny pw pl pm bk"><strong class="nf fr">SystemPrompts</strong>: System messages that are generated based on system context.</li></ul><pre class="mm mn mo mp mq qx pv qy bp qz bb bk"><span id="6166" class="ra ok fq pv b bg rb rc l rd re">import OpenAI from "openai";<br/>type ChatCompletionSystemMessageParam = OpenAI.ChatCompletionSystemMessageParam;<br/><br/>type SystemPromptKey = "context";<br/><br/>export const SystemPrompts: Record&lt;<br/>  SystemPromptKey,<br/>  ChatCompletionSystemMessageParam<br/>&gt; = {<br/>  context: {<br/>    role: "system",<br/>    content:<br/>      "You are an farm visit assistant. You are upbeat and friendly. You introduce yourself when first saying `Howdy!`. If you decide to call a function, you should retrieve the required fields for the function from the user. Your answer should be as precise as possible. If you have not yet retrieve the required fields of the function completely, you do not answer the question and inform the user you do not have enough information.",<br/>  },<br/>};</span></pre><ul class=""><li id="d0b1" class="nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny pw pl pm bk"><strong class="nf fr">FunctionPrompts</strong>: Function messages that are basically the return values of the functions.</li></ul><pre class="mm mn mo mp mq qx pv qy bp qz bb bk"><span id="d794" class="ra ok fq pv b bg rb rc l rd re">import OpenAI from "openai";<br/>type ChatCompletionToolMessageParam = OpenAI.ChatCompletionToolMessageParam;<br/><br/>type FunctionPromptKey = "function_response";<br/><br/>type FunctionPromptValue = (<br/>  args: Omit&lt;ChatCompletionToolMessageParam, "role"&gt;<br/>) =&gt; ChatCompletionToolMessageParam;<br/><br/>export const FunctionPrompts: Record&lt;FunctionPromptKey, FunctionPromptValue&gt; = {<br/>  function_response: (options) =&gt; ({<br/>    role: "tool",<br/>    ...options,<br/>  }),<br/>};</span></pre><h2 id="d998" class="qf ok fq bf ol qg qh qi oo qj qk ql or nm qm qn qo nq qp qq qr nu qs qt qu qv bk">Step 2: Define the tools</h2><p id="286a" class="pw-post-body-paragraph nd ne fq nf b go pf nh ni gr pg nk nl nm ph no np nq pi ns nt nu pj nw nx ny fj bk">As mentioned earlier, <code class="cx ps pt pu pv b">tools</code> are essentially the descriptions of functions that the model can call. In this case, we define four tools to meet the requirements of the farm trip assistant agent:</p><ol class=""><li id="4da2" class="nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny pk pl pm bk"><code class="cx ps pt pu pv b">get_farms</code>: Retrieves a list of farm destinations based on user's location.</li><li id="710f" class="nd ne fq nf b go pn nh ni gr po nk nl nm pp no np nq pq ns nt nu pr nw nx ny pk pl pm bk"><code class="cx ps pt pu pv b">get_activities_per_farm</code>: Provides detailed information on activities available at a specific farm.</li><li id="e0ab" class="nd ne fq nf b go pn nh ni gr po nk nl nm pp no np nq pq ns nt nu pr nw nx ny pk pl pm bk"><code class="cx ps pt pu pv b">book_activity</code>: Facilitates the booking of a selected activity.</li><li id="31a7" class="nd ne fq nf b go pn nh ni gr po nk nl nm pp no np nq pq ns nt nu pr nw nx ny pk pl pm bk"><code class="cx ps pt pu pv b">file_complaint</code>: Offers a straightforward process for filing complaints.</li></ol><p id="ad7e" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">The following code snippet demonstrates how these tools are defined:</p><pre class="mm mn mo mp mq qx pv qy bp qz bb bk"><span id="01ed" class="ra ok fq pv b bg rb rc l rd re">import OpenAI from "openai";<br/>import {<br/>  ConvertTypeNameStringLiteralToType,<br/>  JsonAcceptable,<br/>} from "../utils/type-utils.js";<br/><br/>type ChatCompletionTool = OpenAI.ChatCompletionTool;<br/>type FunctionDefinition = OpenAI.FunctionDefinition;<br/><br/>// An enum to define the names of the functions. This will be shared between the function descriptions and the actual functions<br/>export enum DescribedFunctionName {<br/>  FileComplaint = "file_complaint",<br/>  getFarms = "get_farms",<br/>  getActivitiesPerFarm = "get_activities_per_farm",<br/>  bookActivity = "book_activity",<br/>}<br/>// This is a utility type to narrow down the `parameters` type in the `FunctionDefinition`.<br/>// It pairs with the keyword `satisfies` to ensure that the properties of parameters are correctly defined.<br/>// This is a workaround as the default type of `parameters` in `FunctionDefinition` is `type FunctionParameters = Record&lt;string, unknown&gt;` which is overly broad.<br/>type FunctionParametersNarrowed&lt;<br/>  T extends Record&lt;string, PropBase&lt;JsonAcceptable&gt;&gt;<br/>&gt; = {<br/>  type: JsonAcceptable; // basically all the types that JSON can accept<br/>  properties: T;<br/>  required: (keyof T)[];<br/>};<br/>// This is a base type for each property of the parameters<br/>type PropBase&lt;T extends JsonAcceptable = "string"&gt; = {<br/>  type: T;<br/>  description: string;<br/>};<br/>// This utility type transforms parameter property string literals into usable types for function parameters.<br/>// Example: { email: { type: "string" } } -&gt; { email: string }<br/>export type ConvertedFunctionParamProps&lt;<br/>  Props extends Record&lt;string, PropBase&lt;JsonAcceptable&gt;&gt;<br/>&gt; = {<br/>  [K in keyof Props]: ConvertTypeNameStringLiteralToType&lt;Props[K]["type"]&gt;;<br/>};<br/>// Define the parameters for each function<br/>export type FileComplaintProps = {<br/>  name: PropBase;<br/>  email: PropBase;<br/>  text: PropBase;<br/>};<br/>export type GetFarmsProps = {<br/>  location: PropBase;<br/>};<br/>export type GetActivitiesPerFarmProps = {<br/>  farm_name: PropBase;<br/>};<br/>export type BookActivityProps = {<br/>  farm_name: PropBase;<br/>  activity_name: PropBase;<br/>  datetime: PropBase;<br/>  name: PropBase;<br/>  email: PropBase;<br/>  number_of_people: PropBase&lt;"number"&gt;;<br/>};<br/><br/>// Define the function descriptions<br/>const FunctionDescriptions: Record&lt;<br/>  DescribedFunctionName,<br/>  FunctionDefinition<br/>&gt; = {<br/>  [DescribedFunctionName.FileComplaint]: {<br/>    name: DescribedFunctionName.FileComplaint,<br/>    description: "File a complaint as a customer",<br/>    parameters: {<br/>      type: "object",<br/>      properties: {<br/>        name: {<br/>          type: "string",<br/>          description: "The name of the user, e.g. John Doe",<br/>        },<br/>        email: {<br/>          type: "string",<br/>          description: "The email address of the user, e.g. john@doe.com",<br/>        },<br/>        text: {<br/>          type: "string",<br/>          description: "Description of issue",<br/>        },<br/>      },<br/>      required: ["name", "email", "text"],<br/>    } satisfies FunctionParametersNarrowed&lt;FileComplaintProps&gt;,<br/>  },<br/>  [DescribedFunctionName.getFarms]: {<br/>    name: DescribedFunctionName.getFarms,<br/>    description: "Get the information of farms based on the location",<br/>    parameters: {<br/>      type: "object",<br/>      properties: {<br/>        location: {<br/>          type: "string",<br/>          description: "The location of the farm, e.g. Melbourne VIC",<br/>        },<br/>      },<br/>      required: ["location"],<br/>    } satisfies FunctionParametersNarrowed&lt;GetFarmsProps&gt;,<br/>  },<br/>  [DescribedFunctionName.getActivitiesPerFarm]: {<br/>    name: DescribedFunctionName.getActivitiesPerFarm,<br/>    description: "Get the activities available on a farm",<br/>    parameters: {<br/>      type: "object",<br/>      properties: {<br/>        farm_name: {<br/>          type: "string",<br/>          description: "The name of the farm, e.g. Collingwood Children's Farm",<br/>        },<br/>      },<br/>      required: ["farm_name"],<br/>    } satisfies FunctionParametersNarrowed&lt;GetActivitiesPerFarmProps&gt;,<br/>  },<br/>  [DescribedFunctionName.bookActivity]: {<br/>    name: DescribedFunctionName.bookActivity,<br/>    description: "Book an activity on a farm",<br/>    parameters: {<br/>      type: "object",<br/>      properties: {<br/>        farm_name: {<br/>          type: "string",<br/>          description: "The name of the farm, e.g. Collingwood Children's Farm",<br/>        },<br/>        activity_name: {<br/>          type: "string",<br/>          description: "The name of the activity, e.g. Goat Feeding",<br/>        },<br/>        datetime: {<br/>          type: "string",<br/>          description: "The date and time of the activity",<br/>        },<br/>        name: {<br/>          type: "string",<br/>          description: "The name of the user",<br/>        },<br/>        email: {<br/>          type: "string",<br/>          description: "The email address of the user",<br/>        },<br/>        number_of_people: {<br/>          type: "number",<br/>          description: "The number of people attending the activity",<br/>        },<br/>      },<br/>      required: [<br/>        "farm_name",<br/>        "activity_name",<br/>        "datetime",<br/>        "name",<br/>        "email",<br/>        "number_of_people",<br/>      ],<br/>    } satisfies FunctionParametersNarrowed&lt;BookActivityProps&gt;,<br/>  },<br/>};<br/>// Format the function descriptions into tools and export them<br/>export const tools = Object.values(<br/>  FunctionDescriptions<br/>).map&lt;ChatCompletionTool&gt;((description) =&gt; ({<br/>  type: "function",<br/>  function: description,<br/>}));</span></pre><blockquote class="rf rg rh"><p id="fded" class="nd ne ri nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk"><strong class="nf fr">Understanding Function Descriptions</strong></p></blockquote><p id="2745" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Function descriptions require the following keys:</p><ul class=""><li id="dbd7" class="nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny pw pl pm bk"><code class="cx ps pt pu pv b">name</code>: Identifies the function.</li><li id="683d" class="nd ne fq nf b go pn nh ni gr po nk nl nm pp no np nq pq ns nt nu pr nw nx ny pw pl pm bk"><code class="cx ps pt pu pv b">description</code>: Provides a summary of what the function does.</li><li id="f474" class="nd ne fq nf b go pn nh ni gr po nk nl nm pp no np nq pq ns nt nu pr nw nx ny pw pl pm bk"><code class="cx ps pt pu pv b">parameters</code>: Defines the function's parameters, including their <code class="cx ps pt pu pv b">type</code>, <code class="cx ps pt pu pv b">description</code>, and whether they are <code class="cx ps pt pu pv b">required</code>.</li><li id="205b" class="nd ne fq nf b go pn nh ni gr po nk nl nm pp no np nq pq ns nt nu pr nw nx ny pw pl pm bk"><code class="cx ps pt pu pv b">type</code>: Specifies the parameter type, typically an object.</li><li id="f5ef" class="nd ne fq nf b go pn nh ni gr po nk nl nm pp no np nq pq ns nt nu pr nw nx ny pw pl pm bk"><code class="cx ps pt pu pv b">properties</code>: Details each parameter, including its type and description.</li><li id="3167" class="nd ne fq nf b go pn nh ni gr po nk nl nm pp no np nq pq ns nt nu pr nw nx ny pw pl pm bk"><code class="cx ps pt pu pv b">required</code>: Lists the parameters that are essential for the function to operate.</li></ul><blockquote class="rf rg rh"><p id="bdce" class="nd ne ri nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk"><strong class="nf fr">Adding a New Function</strong></p></blockquote><p id="23d9" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">To introduce a new function, proceed as follows:</p><ol class=""><li id="8204" class="nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny pk pl pm bk">Extend DescribedFunctionName with a new enum, such as <code class="cx ps pt pu pv b">DoNewThings</code>.</li><li id="331c" class="nd ne fq nf b go pn nh ni gr po nk nl nm pp no np nq pq ns nt nu pr nw nx ny pk pl pm bk">Define a Props type for the parameters, e.g., <code class="cx ps pt pu pv b">DoNewThingsProps</code>.</li><li id="4373" class="nd ne fq nf b go pn nh ni gr po nk nl nm pp no np nq pq ns nt nu pr nw nx ny pk pl pm bk">Insert a new entry in the <em class="ri">FunctionDescriptions</em> object.</li><li id="40bd" class="nd ne fq nf b go pn nh ni gr po nk nl nm pp no np nq pq ns nt nu pr nw nx ny pk pl pm bk">Implement the new function in the function directory, naming it after the enum value.</li></ol><h2 id="0df9" class="qf ok fq bf ol qg qh qi oo qj qk ql or nm qm qn qo nq qp qq qr nu qs qt qu qv bk">Step 3: Call the model with the messages and the tools</h2><p id="fad6" class="pw-post-body-paragraph nd ne fq nf b go pf nh ni gr pg nk nl nm ph no np nq pi ns nt nu pj nw nx ny fj bk">With the messages and tools set up, we’re ready to call the model using them.</p><p id="e099" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">It’s important to note that as of March 2024, function calling is supported only by the <code class="cx ps pt pu pv b">gpt-3.5-turbo-0125</code> and <code class="cx ps pt pu pv b">gpt-4-turbo-preview</code> models.</p><p id="54e6" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Code implementation:</p><pre class="mm mn mo mp mq qx pv qy bp qz bb bk"><span id="f350" class="ra ok fq pv b bg rb rc l rd re">export const startChat = async (messages: ChatCompletionMessageParam[]) =&gt; {<br/>  const response = await openai.chat.completions.create({<br/>    model: "gpt-3.5-turbo",<br/>    top_p: 0.95,<br/>    temperature: 0.5,<br/>    max_tokens: 1024,<br/><br/>    messages, // The messages array we created earlier<br/>    tools, // The function descriptions we defined earlier<br/>    tool_choice: "auto", // The model will decide whether to call a function and which function to call<br/>  });<br/>  const { message } = response.choices[0] ?? {};<br/>  if (!message) {<br/>    throw new Error("Error: No response from the API.");<br/>  }<br/>  messages.push(message);<br/>  return processMessage(message);<br/>};</span></pre><blockquote class="rf rg rh"><p id="2fa1" class="nd ne ri nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk"><code class="cx ps pt pu pv b"><strong class="nf fr">tool_choice</strong></code><strong class="nf fr"> Options</strong></p></blockquote><p id="53aa" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">The <code class="cx ps pt pu pv b">tool_choice</code> option controls the model's approach to function calls:</p><ul class=""><li id="b1b6" class="nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny pw pl pm bk"><code class="cx ps pt pu pv b">Specific Function</code>: To specify a particular function, set <code class="cx ps pt pu pv b">tool_choice</code> to an object with <code class="cx ps pt pu pv b">type: "function"</code> and include the function's name and details. For instance, <code class="cx ps pt pu pv b">tool_choice: { type: "function", function: { name: "get_farms"}}</code> tells the model to call the <code class="cx ps pt pu pv b">get_farms</code> function regardless of the context. Even a simple user prompt like "Hi." will trigger this function call.</li><li id="a66f" class="nd ne fq nf b go pn nh ni gr po nk nl nm pp no np nq pq ns nt nu pr nw nx ny pw pl pm bk"><code class="cx ps pt pu pv b">No Function</code>: To have the model generate a response without any function calls, use <code class="cx ps pt pu pv b">tool_choice: "none"</code>. This option prompts the model to rely solely on the input messages for generating its response.</li><li id="fcbf" class="nd ne fq nf b go pn nh ni gr po nk nl nm pp no np nq pq ns nt nu pr nw nx ny pw pl pm bk"><code class="cx ps pt pu pv b">Automatic Selection</code>: The default setting, <code class="cx ps pt pu pv b">tool_choice: "auto"</code>, lets the model autonomously decide if and which function to call, based on the conversation's context. This flexibility is beneficial for dynamic decision-making regarding function calls.</li></ul><h2 id="5cd8" class="qf ok fq bf ol qg qh qi oo qj qk ql or nm qm qn qo nq qp qq qr nu qs qt qu qv bk">Step 4: Handling Model Responses</h2><p id="1b2f" class="pw-post-body-paragraph nd ne fq nf b go pf nh ni gr pg nk nl nm ph no np nq pi ns nt nu pj nw nx ny fj bk">The model’s responses fall into two primary categories, with a potential for errors that necessitate a fallback message:</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk rj"><img src="../Images/1d5be5b5218c97887adba782d1ee01a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8RaPiBWMSjnKWMsda17NEQ.png"/></div></div></figure><ol class=""><li id="ec7e" class="nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny pk pl pm bk"><strong class="nf fr">Function Call Request</strong>: The model indicates a desire to call function(s). This is the true potential of function calling. The model intelligently selects which function(s) to execute based on context and user queries. For instance, if the user asks for farm recommendations, the model may suggest calling the <code class="cx ps pt pu pv b">get_farms</code> function.</li></ol><p id="cf1e" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">But it doesn’t just stop there, the model also analyzes the user input to determine if it contains the necessary information (<code class="cx ps pt pu pv b">arguments</code>) for the function call. If not, the model would prompt the user for the missing details.</p><p id="5582" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Once it has gathered all required information (<code class="cx ps pt pu pv b">arguments</code>), the model returns a JSON object detailing the function name and arguments. This structured response can be effortlessly translated into a JavaScript object within our application, enabling us to invoke the specified function seamlessly, thereby ensuring a fluid user experience.</p><p id="d9dd" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Additionally, the model can choose to call multiple functions, either simultaneously or in sequence, each requiring specific details. Managing this within the application is crucial for smooth operation.</p><p id="1e64" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk"><strong class="nf fr">Example of model’s response:</strong></p><pre class="mm mn mo mp mq qx pv qy bp qz bb bk"><span id="b2ab" class="ra ok fq pv b bg rb rc l rd re">{<br/>  "role": "assistant",<br/>  "content": null,<br/>  "tool_calls": [<br/>    {<br/>      "id": "call_JWoPQYmdxNXdNu1wQ1iDqz2z",<br/>      "type": "function",<br/>      "function": {<br/>        "name": "get_farms", // The function name to be called<br/>        "arguments": "{\"location\":\"Melbourne\"}" // The arguments required for the function<br/>      }<br/>    }<br/>    ... // multiple function calls can be present<br/>  ]<br/>}</span></pre><p id="dae4" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk"><strong class="nf fr">2. Plain Text Response</strong>: The model provides a direct text response. This is the standard output we’re accustomed to from AI models, offering straightforward answers to user queries. Simply returning the text content suffices for these responses.</p><p id="d154" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk"><strong class="nf fr">Example of model’s response:</strong></p><pre class="mm mn mo mp mq qx pv qy bp qz bb bk"><span id="2ea1" class="ra ok fq pv b bg rb rc l rd re">{<br/>  "role": "assistant",<br/>  "content": {<br/>    "text": "I can help you with that. What is your location?"<br/>  }<br/>}</span></pre><p id="c68b" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">The key distinction is the presence of a <code class="cx ps pt pu pv b">tool_calls</code> key for <code class="cx ps pt pu pv b">function calls</code>. If <code class="cx ps pt pu pv b">tool_calls</code> is present, the model is requesting to execute a function; otherwise, it delivers a straightforward text response.</p><p id="218d" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">To process these responses, consider the following approach based on the response type:</p><pre class="mm mn mo mp mq qx pv qy bp qz bb bk"><span id="deef" class="ra ok fq pv b bg rb rc l rd re">type ChatCompletionMessageWithToolCalls = RequiredAll&lt;<br/>  Omit&lt;ChatCompletionMessage, "function_call"&gt;<br/>&gt;;<br/><br/>// If the message contains tool_calls, it extracts the function arguments. Otherwise, it returns the content of the message.<br/>export function processMessage(message: ChatCompletionMessage) {<br/>  if (isMessageHasToolCalls(message)) {<br/>    return extractFunctionArguments(message);<br/>  } else {<br/>    return message.content;<br/>  }<br/>}<br/>// Check if the message has `tool calls`<br/>function isMessageHasToolCalls(<br/>  message: ChatCompletionMessage<br/>): message is ChatCompletionMessageWithToolCalls {<br/>  return isDefined(message.tool_calls) &amp;&amp; message.tool_calls.length !== 0;<br/>}<br/>// Extract function name and arguments from the message<br/>function extractFunctionArguments(message: ChatCompletionMessageWithToolCalls) {<br/>  return message.tool_calls.map((toolCall) =&gt; {<br/>    if (!isDefined(toolCall.function)) {<br/>      throw new Error("No function found in the tool call");<br/>    }<br/>    try {<br/>      return {<br/>        tool_call_id: toolCall.id,<br/>        function_name: toolCall.function.name,<br/>        arguments: JSON.parse(toolCall.function.arguments),<br/>      };<br/>    } catch (error) {<br/>      throw new Error("Invalid JSON in function arguments");<br/>    }<br/>  });<br/>}</span></pre><p id="3115" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">The <code class="cx ps pt pu pv b">arguments</code> extracted from the function calls are then used to execute the actual functions in the application, while the text content helps to carry on the conversation.</p><p id="2fb7" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Below is an<strong class="nf fr"> if-else block</strong> illustrating how this process unfolds:</p><pre class="mm mn mo mp mq qx pv qy bp qz bb bk"><span id="7301" class="ra ok fq pv b bg rb rc l rd re">const result = await startChat(messages);<br/><br/>if (!result) {<br/>  // Fallback message if response is empty (e.g., network error)<br/>  console.log(StaticPrompts.fallback);<br/>} else if (isNonEmptyString(result)) {<br/>  // If the response is a string, log it and prompt the user for the next message<br/>  console.log(`Assistant: ${result}`);<br/>  const userPrompt = await createUserMessage();<br/>  messages.push(userPrompt);<br/>} else {<br/>  // If the response contains function calls, execute the functions and call the model again with the updated messages<br/>  for (const item of result) {<br/>    const { tool_call_id, function_name, arguments: function_arguments } = item;<br/>    // Execute the function and get the function return<br/>    const functionReturn = await AvailableFunctions[<br/>      function_name as keyof typeof AvailableFunctions<br/>    ](function_arguments);<br/>    // Add the function output back to the messages with a role of "tool", the id of the tool call, and the function return as the content<br/>    messages.push(<br/>      FunctionPrompts.function_response({<br/>        tool_call_id,<br/>        content: functionReturn,<br/>      })<br/>    );<br/>  }<br/>}</span></pre><h2 id="de43" class="qf ok fq bf ol qg qh qi oo qj qk ql or nm qm qn qo nq qp qq qr nu qs qt qu qv bk">Step 5: Execute the function and call the model again</h2><p id="9c37" class="pw-post-body-paragraph nd ne fq nf b go pf nh ni gr pg nk nl nm ph no np nq pi ns nt nu pj nw nx ny fj bk">When the model requests a function call, we execute that function in our application and then update the model with the new messages. This keeps the model informed about the function’s result, allowing it to give a pertinent reply to the user.</p><p id="aa26" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Maintaining the correct sequence of function executions is crucial, especially when the model chooses to execute multiple functions in a sequence to complete a task. Using a <code class="cx ps pt pu pv b">for</code> loop instead of <code class="cx ps pt pu pv b">Promise.all</code> preserves the execution order, essential for a successful workflow. However, if the functions are independent and can be executed in parallel, consider custom optimizations to enhance performance.</p><p id="cfb7" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Here’s how to execute the function:</p><pre class="mm mn mo mp mq qx pv qy bp qz bb bk"><span id="d77a" class="ra ok fq pv b bg rb rc l rd re">for (const item of result) {<br/>  const { tool_call_id, function_name, arguments: function_arguments } = item;<br/><br/>  console.log(<br/>    `Calling function "${function_name}" with ${JSON.stringify(<br/>      function_arguments<br/>    )}`<br/>  );<br/>  // Available functions are stored in an object for easy access<br/>  const functionReturn = await AvailableFunctions[<br/>    function_name as keyof typeof AvailableFunctions<br/>  ](function_arguments);<br/>}</span></pre><p id="8882" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">And here’s how to update the messages array with the function response:</p><pre class="mm mn mo mp mq qx pv qy bp qz bb bk"><span id="2e89" class="ra ok fq pv b bg rb rc l rd re">for (const item of result) {<br/>  const { tool_call_id, function_name, arguments: function_arguments } = item;<br/><br/>  console.log(<br/>    `Calling function "${function_name}" with ${JSON.stringify(<br/>      function_arguments<br/>    )}`<br/>  );<br/>  const functionReturn = await AvailableFunctions[<br/>    function_name as keyof typeof AvailableFunctions<br/>  ](function_arguments);<br/>  // Add the function output back to the messages with a role of "tool", the id of the tool call, and the function return as the content<br/>  messages.push(<br/>    FunctionPrompts.function_response({<br/>      tool_call_id,<br/>      content: functionReturn,<br/>    })<br/>  );<br/>}</span></pre><p id="0372" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Example of the functions that can be called:</p><pre class="mm mn mo mp mq qx pv qy bp qz bb bk"><span id="1bf1" class="ra ok fq pv b bg rb rc l rd re">// Mocking getting farms based on location from a database<br/>export async function get_farms(<br/>  args: ConvertedFunctionParamProps&lt;GetFarmsProps&gt;<br/>): Promise&lt;string&gt; {<br/>  const { location } = args;<br/>  return JSON.stringify({<br/>    location,<br/>    farms: [<br/>      {<br/>        name: "Farm 1",<br/>        location: "Location 1",<br/>        rating: 4.5,<br/>        products: ["product 1", "product 2"],<br/>        activities: ["activity 1", "activity 2"],<br/>      },<br/>      ...<br/>    ],<br/>  });<br/>}</span></pre><p id="d2a3" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Example of the <code class="cx ps pt pu pv b">tool</code> message with function response:</p><pre class="mm mn mo mp mq qx pv qy bp qz bb bk"><span id="bdd9" class="ra ok fq pv b bg rb rc l rd re">{<br/>  "role": "tool",<br/>  "tool_call_id": "call_JWoPQYmdxNXdNu1wQ1iDqz2z",<br/>  "content": {<br/>    // Function return value<br/>    "location": "Melbourne",<br/>    "farms": [<br/>      {<br/>        "name": "Farm 1",<br/>        "location": "Location 1",<br/>        "rating": 4.5,<br/>        "products": [<br/>          "product 1",<br/>          "product 2"<br/>        ],<br/>        "activities": [<br/>          "activity 1",<br/>          "activity 2"<br/>        ]<br/>      },<br/>      ...<br/>    ]<br/>  }<br/>}</span></pre><h2 id="0f4e" class="qf ok fq bf ol qg qh qi oo qj qk ql or nm qm qn qo nq qp qq qr nu qs qt qu qv bk">Step 6: Summarize the results back to the user</h2><p id="2c5a" class="pw-post-body-paragraph nd ne fq nf b go pf nh ni gr pg nk nl nm ph no np nq pi ns nt nu pj nw nx ny fj bk">After running the functions and updating the message array, we re-engage the model with these updated messages to brief the user on the outcomes. This involves repeatedly invoking the <strong class="nf fr"><em class="ri">startChat</em></strong> function via a loop.</p><p id="f752" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">To avoid endless looping, it’s crucial to monitor for user inputs signaling the end of the conversation, like “Goodbye” or “End,” ensuring the loop terminates appropriately.</p><p id="ee97" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Code implementation:</p><pre class="mm mn mo mp mq qx pv qy bp qz bb bk"><span id="a21b" class="ra ok fq pv b bg rb rc l rd re">const CHAT_END_SIGNALS = [<br/>  "end",<br/>  "goodbye",<br/>  ...<br/>];<br/><br/>export function isChatEnding(<br/>  message: ChatCompletionMessageParam | undefined | null<br/>) {<br/>  // If the message is not defined, log a fallback message<br/>  if (!isDefined(message)) {<br/>    throw new Error("Cannot find the message!");<br/>  }<br/>  // Check if the message is from the user<br/>  if (!isUserMessage(message)) {<br/>    return false;<br/>  }<br/>  const { content } = message;<br/>  return CHAT_END_SIGNALS.some((signal) =&gt; {<br/>    if (typeof content === "string") {<br/>      return includeSignal(content, signal);<br/>    } else {<br/>      // content has a typeof ChatCompletionContentPart, which can be either ChatCompletionContentPartText or ChatCompletionContentPartImage<br/>      // If user attaches an image to the current message first, we assume they are not ending the chat<br/>      const contentPart = content.at(0);<br/>      if (contentPart?.type !== "text") {<br/>        return false;<br/>      } else {<br/>        return includeSignal(contentPart.text, signal);<br/>      }<br/>    }<br/>  });<br/>}<br/>function isUserMessage(<br/>  message: ChatCompletionMessageParam<br/>): message is ChatCompletionUserMessageParam {<br/>  return message.role === "user";<br/>}<br/>function includeSignal(content: string, signal: string) {<br/>  return content.toLowerCase().includes(signal);<br/>}</span></pre></div></div></div><div class="ab cb ob oc od oe" role="separator"><span class="of by bm og oh oi"/><span class="of by bm og oh oi"/><span class="of by bm og oh"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><h1 id="dbba" class="oj ok fq bf ol om on gq oo op oq gt or os ot ou ov ow ox oy oz pa pb pc pd pe bk">Conclusion</h1><p id="716b" class="pw-post-body-paragraph nd ne fq nf b go pf nh ni gr pg nk nl nm ph no np nq pi ns nt nu pj nw nx ny fj bk">OpenAI’s function calling represents a major advancement in AI, allowing models to perform custom functions in response to user queries. This feature simplifies obtaining structured data from outputs, improving user interaction and enabling more complex exchanges.</p></div></div></div><div class="ab cb ob oc od oe" role="separator"><span class="of by bm og oh oi"/><span class="of by bm og oh oi"/><span class="of by bm og oh"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><h1 id="1c90" class="oj ok fq bf ol om on gq oo op oq gt or os ot ou ov ow ox oy oz pa pb pc pd pe bk">Enjoyed This Story?</h1><p id="c850" class="pw-post-body-paragraph nd ne fq nf b go pf nh ni gr pg nk nl nm ph no np nq pi ns nt nu pj nw nx ny fj bk"><strong class="nf fr">Selina Li</strong> (<a class="af nc" href="https://medium.com/u/7b9ea39b0d79" rel="noopener">Selina Li</a>, <a class="af nc" href="https://www.linkedin.com/in/selina-zhuohang-li-3b7355120/" rel="noopener ugc nofollow" target="_blank">LinkedIn</a>) is a Principal Data Engineer working at <a class="af nc" href="https://www.officeworks.com.au/" rel="noopener ugc nofollow" target="_blank">Officeworks</a> in Melbourne Australia. Selina is passionate about AI/ML, data engineering and investment.</p><p id="5017" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk"><strong class="nf fr">Jason Li</strong> (<a class="af nc" href="https://medium.com/u/4092d7367010" rel="noopener">Tianyi Li</a>, <a class="af nc" href="https://www.linkedin.com/in/tianyi-li-jason/" rel="noopener ugc nofollow" target="_blank">LinkedIn</a>) is a Full-stack Developer working at <a class="af nc" href="https://www.mindsethealth.com/" rel="noopener ugc nofollow" target="_blank">Mindset Health</a> in Melbourne Australia. Jason is passionate about AI, front-end development and space related technologies.</p><p id="2995" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Selina and Jason would love to explore technologies to help people achieve their goals.</p><p id="23a2" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk"><em class="ri">Unless otherwise noted, all images are by the authors.</em></p></div></div></div></div>    
</body>
</html>