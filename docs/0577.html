<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>How to Read OSM Data with DuckDB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>How to Read OSM Data with DuckDB</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-read-osm-data-with-duckdb-ffeb15197390?source=collection_archive---------0-----------------------#2024-03-02">https://towardsdatascience.com/how-to-read-osm-data-with-duckdb-ffeb15197390?source=collection_archive---------0-----------------------#2024-03-02</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="5b88" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx">A deep dive into OpenStreetMap data structure and how to utilize it in a scalable way</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hd he hf hg hh ab"><div><div class="ab hi"><div><div class="bm" aria-hidden="false"><a href="https://raczeq.medium.com/?source=post_page---byline--ffeb15197390--------------------------------" rel="noopener follow"><div class="l hj hk by hl hm"><div class="l ed"><img alt="Kamil Raczycki" class="l ep by dd de cx" src="../Images/2c45075e217e60660ad3b4475530333d.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/1*buR4DM2npH_MUBhasaAPWw.jpeg"/><div class="hn by l dd de em n ho eo"/></div></div></a></div></div><div class="hp ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--ffeb15197390--------------------------------" rel="noopener follow"><div class="l hq hr by hl hs"><div class="l ed"><img alt="Towards Data Science" class="l ep by br ht cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hn by l br ht em n ho eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hu ab q"><div class="ab q hv"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hw hx bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hy" data-testid="authorName" href="https://raczeq.medium.com/?source=post_page---byline--ffeb15197390--------------------------------" rel="noopener follow">Kamil Raczycki</a></p></div></div></div><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hw hx dx"><button class="ib ic ah ai aj ak al am an ao ap aq ar id ie if" disabled="">Follow</button></p></div></div></span></div></div><div class="l ig"><span class="bf b bg z dx"><div class="ab cn ih ii ij"><div class="ik il ab"><div class="bf b bg z dx ab im"><span class="in l ig">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hy ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--ffeb15197390--------------------------------" rel="noopener follow"><p class="bf b bg z io ip iq ir is it iu iv bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">29 min read</span><div class="iw ix l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Mar 2, 2024</span></div></span></div></span></div></div></div><div class="ab cp iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn"><div class="h k w ea eb q"><div class="kd l"><div class="ab q ke kf"><div class="pw-multi-vote-icon ed in kg kh ki"><div class=""><div class="kj kk kl km kn ko kp am kq kr ks ki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kt ku kv kw kx ky kz"><p class="bf b dy z dx"><span class="kk">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kj lc ld ab q ee le lf" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="lb"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg><p class="bf b dy z dx"><span class="pw-responses-count la lb">1</span></p></button></div></div></div><div class="ab q jo jp jq jr js jt ju jv jw jx jy jz ka kb kc"><div class="lg k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lh an ao ap id li lj lk" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep ll cn"><div class="l ae"><div class="ab cb"><div class="lm ln lo lp lq lr ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div></div></div><div class="mj"><div class="ab cb"><div class="lm mk ln ml lo mm cf mn cg mo ci bh"><figure class="ms mt mu mv mw mj mx my paragraph-image"><div role="button" tabindex="0" class="mz na ed nb bh nc"><div class="mp mq mr"><img src="../Images/1b9c4439391aa4851cbe3131de09a318.png" data-original-src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*uyXB2hQETSJ3wJaZVXPVyw.jpeg"/></div></div><figcaption class="ne nf ng mp mq nh ni bf b bg z dx">Dall-E 3 image: Adorable and cute 3D render duck studying a paper map, bright sky, with blur background, high quality, 8k</figcaption></figure></div></div></div><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="6f50" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">This article will provide an in-depth look at how to read OpenStreetMap data using the DuckDB database.</p><p id="39c9" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">The steps described in this guide will allow the reader to load the OSM data using the Monaco example divided into nodes, ways, and relations.</p></div></div><div class="mj"><div class="ab cb"><div class="lm mk ln ml lo mm cf mn cg mo ci bh"><div class="ms mt mu mv mw ab ke"><figure class="lb mj of og mx my oh paragraph-image"><div role="button" tabindex="0" class="mz na ed nb bh nc"><img src="../Images/d0ebfd971420ab909f885f939cc1ca64.png" data-original-src="https://miro.medium.com/v2/resize:fit:654/format:webp/1*WVVublrE3NtZfADjDEW4sw.png"/></div></figure><figure class="lb mj oi og mx my oh paragraph-image"><div role="button" tabindex="0" class="mz na ed nb bh nc"><img src="../Images/0ff4cf3693bfcbf785e16967120a527e.png" data-original-src="https://miro.medium.com/v2/resize:fit:702/format:webp/1*xciO1Bem4PvxgcVQxARPhQ.png"/></div></figure><figure class="lb mj oj og mx my oh paragraph-image"><div role="button" tabindex="0" class="mz na ed nb bh nc"><img src="../Images/05b73197def9157df492056b089d8d72.png" data-original-src="https://miro.medium.com/v2/resize:fit:648/format:webp/1*rh6F3fRMS4cTIFuCkeyfeQ.png"/></div><figcaption class="ne nf ng mp mq nh ni bf b bg z dx ok ed ol om">The final result of OSM elements read using the DuckDB engine. From the left: nodes, ways and relations. Generated by the author using GeoPandas library.</figcaption></figure></div></div></div></div><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="35cd" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">A basic knowledge of the SQL language is expected to fully understand the steps described in this tutorial. Most of the GIS-related operations and special joins are described further in the article.</p><h2 id="4e49" class="on oo fq bf op oq or os ot ou ov ow ox ns oy oz pa nw pb pc pd oa pe pf pg ph bk">Outline of the article</h2><ul class=""><li id="f854" class="nj nk fq nl b go pi nn no gr pj nq nr ns pk nu nv nw pl ny nz oa pm oc od oe pn po pp bk">What is OSM? — introduction to the OSM service.</li><li id="e2a8" class="nj nk fq nl b go pq nn no gr pr nq nr ns ps nu nv nw pt ny nz oa pu oc od oe pn po pp bk">OpenStreetMap data model — definition of objects used in the OSM.</li><li id="f2a5" class="nj nk fq nl b go pq nn no gr pr nq nr ns ps nu nv nw pt ny nz oa pu oc od oe pn po pp bk">Reading OSM data — basic operations on the data using DuckDB.</li><li id="2938" class="nj nk fq nl b go pq nn no gr pr nq nr ns ps nu nv nw pt ny nz oa pu oc od oe pn po pp bk">Constructing point geometries from the <strong class="nl fr">nodes</strong></li><li id="e431" class="nj nk fq nl b go pq nn no gr pr nq nr ns ps nu nv nw pt ny nz oa pu oc od oe pn po pp bk">Constructing linestring and polygon geometries from the <strong class="nl fr">ways</strong></li><li id="7e84" class="nj nk fq nl b go pq nn no gr pr nq nr ns ps nu nv nw pt ny nz oa pu oc od oe pn po pp bk">Constructing polygon and multi-polygon geometries from the <strong class="nl fr">relations</strong></li><li id="c252" class="nj nk fq nl b go pq nn no gr pr nq nr ns ps nu nv nw pt ny nz oa pu oc od oe pn po pp bk">Examples of badly defined relation objects</li><li id="bfa3" class="nj nk fq nl b go pq nn no gr pr nq nr ns ps nu nv nw pt ny nz oa pu oc od oe pn po pp bk">QuackOSM — a hassle-free tool for reading OSM data</li></ul><h1 id="f4dc" class="pv oo fq bf op pw px gq ot py pz gt ox qa qb qc qd qe qf qg qh qi qj qk ql qm bk">What is OSM?</h1><p id="5ff5" class="pw-post-body-paragraph nj nk fq nl b go pi nn no gr pj nq nr ns pk nu nv nw pl ny nz oa pm oc od oe fj bk">OpenStreetMap (<a class="af qn" href="https://openstreetmap.org/" rel="noopener ugc nofollow" target="_blank">OSM</a>) is the most popular free map of the world and it's kept alive by a growing base of volunteers and contributors.</p><p id="40cd" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">The data collected and built by the community is available publicly for free and commercial purposes, so many companies, academic researchers and individual developers use this resource in their projects. All data is provided under the <a class="af qn" href="https://opendatacommons.org/licenses/odbl/1.0/" rel="noopener ugc nofollow" target="_blank">Open Data Commons Open Database License</a> (ODbL).</p><p id="ab5e" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">The data can be accessed in multiple ways:</p><ul class=""><li id="13c3" class="nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe pn po pp bk">Using Overpass API (with Web GUI at <a class="af qn" href="https://overpass-turbo.eu/" rel="noopener ugc nofollow" target="_blank">Overpass Turbo</a>)</li><li id="6363" class="nj nk fq nl b go pq nn no gr pr nq nr ns ps nu nv nw pt ny nz oa pu oc od oe pn po pp bk">Downloading full data as <a class="af qn" href="https://planet.openstreetmap.org/" rel="noopener ugc nofollow" target="_blank">Planet OSM</a> (currently over 70 GB in 2024)</li><li id="cfd8" class="nj nk fq nl b go pq nn no gr pr nq nr ns ps nu nv nw pt ny nz oa pu oc od oe pn po pp bk">Smaller extract downloads: <a class="af qn" href="https://download.geofabrik.de/" rel="noopener ugc nofollow" target="_blank">Geofabrik</a>, <a class="af qn" href="https://extract.bbbike.org/" rel="noopener ugc nofollow" target="_blank">BBBike</a>, <a class="af qn" href="https://download.openstreetmap.fr/" rel="noopener ugc nofollow" target="_blank">OpenStreetMap.fr</a>, <a class="af qn" href="https://app.protomaps.com/" rel="noopener ugc nofollow" target="_blank">Protomaps</a></li></ul><p id="f22e" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">The most space-efficient file type in which the data is stored is Protocolbuffer Binary Format with an extension <code class="cx qo qp qq qr b">*.osm.pbf</code> . You can read more about it <a class="af qn" href="https://wiki.openstreetmap.org/wiki/PBF_Format" rel="noopener ugc nofollow" target="_blank">here</a>.</p><p id="3671" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">You can also read this short article about OpenStreetMap from <span class="ia"><span class="ia" aria-hidden="false"><a class="qs ib qt" href="https://medium.com/u/86fdc517c278?source=post_page---user_mention--ffeb15197390--------------------------------" rel="noopener" target="_blank">Eugenia Anello</a></span></span>:</p><div class="qu qv qw qx qy qz"><a rel="noopener follow" target="_blank" href="/a-comprehensive-guide-for-getting-started-with-openstreetmap-e92dff95fc80?source=post_page-----ffeb15197390--------------------------------"><div class="ra ab ig"><div class="rb ab co cb rc rd"><h2 class="bf fr hw z io re iq ir rf it iv fp bk">A comprehensive guide for getting started with OpenStreetMap</h2><div class="rg l"><h3 class="bf b hw z io re iq ir rf it iv dx">Learn the basics concepts of OpenStreetMap while practising using the website</h3></div><div class="rh l"><p class="bf b dy z io re iq ir rf it iv dx">towardsdatascience.com</p></div></div><div class="ri l"><div class="rj l rk rl rm ri rn lr qz"/></div></div></a></div><h1 id="d4c4" class="pv oo fq bf op pw px gq ot py pz gt ox qa qb qc qd qe qf qg qh qi qj qk ql qm bk">OpenStreetMap data model</h1><blockquote class="ro rp rq"><p id="817e" class="nj nk rr nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">This section is based on <a class="af qn" href="https://wiki.openstreetmap.org/wiki/Elements" rel="noopener ugc nofollow" target="_blank">OSM Wiki page</a> about Elements</p></blockquote><p id="e2af" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">Conceptually the data in OpenStreetMap is split into 3 components:</p><p id="2ba1" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk rs"><span class="l rt ru rv bo rw rx ry rz sa ed">N</span>odes represent points in space. They are represented by a pair of coordinates in a WGS84 Coordinate Reference System — longitude and latitude. Nodes can be used to define a single feature on a map (eg. bench, lamp post, tree) or be used with other nodes to represent a shape of a way.</p><figure class="ms mt mu mv mw mj mp mq paragraph-image"><div role="button" tabindex="0" class="mz na ed nb bh nc"><div class="mp mq sb"><img src="../Images/d1b8a31585dcda83fce64f09a495b165.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JT1fhwAeylTGM7YfdhDvZQ.png"/></div></div><figcaption class="ne nf ng mp mq nh ni bf b bg z dx">Example of a node — a tree in the park. Screenshot from the OpenStreetMap by the author.</figcaption></figure><p id="22f6" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk rs"><span class="l rt ru rv bo rw rx ry rz sa ed">W</span>ays are shapes representing a polyline by using an <strong class="nl fr">ordered </strong>list of nodes. Those polylines can be open and represent roads, canals, and walls, or they can be closed to form a polygon and represent buildings, forests, lakes or other simple shapes.</p><figure class="ms mt mu mv mw mj mp mq paragraph-image"><div role="button" tabindex="0" class="mz na ed nb bh nc"><div class="mp mq sc"><img src="../Images/66e199dab95b9bcb14552b0375443a37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bAFNcGDhn-lJ1ZwgGKl1kg.png"/></div></div><figcaption class="ne nf ng mp mq nh ni bf b bg z dx">Example of a way — a part of a highway road. Screenshot from the OpenStreetMap by the author.</figcaption></figure><p id="a340" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk rs"><span class="l rt ru rv bo rw rx ry rz sa ed">R</span>elations represent relationships between multiple objects and data elements defined in the OSM. This could be for example a bus route with ways showing roads on which the bus travels and nodes showing stops of a route, or a multi polygon with holes represented by at least 2 ways: these can be an <em class="rr">outer </em>polygon and an <em class="rr">inner </em>polygon.</p><figure class="ms mt mu mv mw mj mp mq paragraph-image"><div role="button" tabindex="0" class="mz na ed nb bh nc"><div class="mp mq sd"><img src="../Images/638f80e316ca63427f0d70bd3f89cf98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O06Tp6aZaugf9zkJvUeUfA.png"/></div></div><figcaption class="ne nf ng mp mq nh ni bf b bg z dx">An example of a relation— a hotel building outline with holes. Screenshot from the OpenStreetMap by the author.</figcaption></figure><p id="da52" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">Each element can, but doesn’t have to, have <strong class="nl fr">tags</strong> attached. Tags describe the meaning of the element. They are composed of a key and a value. There is no fixed dictionary of those values, but users should stay within conventions documented in the OSM Wiki.</p><p id="4f63" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">Additionally, each element has an ID that is unique in a given element type space (so there can be a node with ID = 100, a way with ID = 100 and a relation with ID = 100).</p><h1 id="40c8" class="pv oo fq bf op pw px gq ot py pz gt ox qa qb qc qd qe qf qg qh qi qj qk ql qm bk">Reading OSM data</h1><p id="7606" class="pw-post-body-paragraph nj nk fq nl b go pi nn no gr pj nq nr ns pk nu nv nw pl ny nz oa pm oc od oe fj bk">Many tools allow users to transform the OSM data model to file formats commonly used in the GIS domain, such as<a class="af qn" href="https://gdal.org/drivers/vector/osm.html" rel="noopener ugc nofollow" target="_blank"> GDAL</a>. These tools are automatically reconstructing geometries from the raw data. We will try to read it and reconstruct geometries manually.</p><blockquote class="ro rp rq"><p id="ed65" class="nj nk rr nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">Examples below show how to access raw data and are written in SQL using <a class="af qn" href="https://duckdb.org/" rel="noopener ugc nofollow" target="_blank">DuckDB</a> engine with <a class="af qn" href="https://duckdb.org/docs/extensions/spatial.html" rel="noopener ugc nofollow" target="_blank">Spatial</a> extension. All queries with a full Jupyer notebook can be accessed in the GitHub repository.<br/>You can run the notebook in the parallel or you can <a class="af qn" href="https://duckdb.org/#quickinstall" rel="noopener ugc nofollow" target="_blank">install the DuckDB engine</a> and open the CLI to execute the queries there.</p></blockquote><div class="qu qv qw qx qy qz"><a href="https://github.com/RaczeQ/medium-articles/blob/main/articles/osm-duckdb/code.ipynb?source=post_page-----ffeb15197390--------------------------------" rel="noopener  ugc nofollow" target="_blank"><div class="ra ab ig"><div class="rb ab co cb rc rd"><h2 class="bf fr hw z io re iq ir rf it iv fp bk">medium-articles/articles/osm-duckdb/code.ipynb at main · RaczeQ/medium-articles</h2><div class="rg l"><h3 class="bf b hw z io re iq ir rf it iv dx">A repository for the code and data used in Medium articles - medium-articles/articles/osm-duckdb/code.ipynb at main ·…</h3></div><div class="rh l"><p class="bf b dy z io re iq ir rf it iv dx">github.com</p></div></div><div class="ri l"><div class="se l rk rl rm ri rn lr qz"/></div></div></a></div><h2 id="c1d2" class="on oo fq bf op oq or os ot ou ov ow ox ns oy oz pa nw pb pc pd oa pe pf pg ph bk">Getting the data</h2><p id="96b5" class="pw-post-body-paragraph nj nk fq nl b go pi nn no gr pj nq nr ns pk nu nv nw pl ny nz oa pm oc od oe fj bk">For simplicity and easy access, examples are focused entirely on the Monaco region. You can download the current extract from the Geofabrik download server: <a class="af qn" href="https://download.geofabrik.de/europe/monaco.html" rel="noopener ugc nofollow" target="_blank">https://download.geofabrik.de/europe/monaco.html</a> (and click <code class="cx qo qp qq qr b">monaco-latest.osm.pbf</code> download link)</p><h2 id="83ff" class="on oo fq bf op oq or os ot ou ov ow ox ns oy oz pa nw pb pc pd oa pe pf pg ph bk">Familiarisation with the data structure</h2><p id="d62c" class="pw-post-body-paragraph nj nk fq nl b go pi nn no gr pj nq nr ns pk nu nv nw pl ny nz oa pm oc od oe fj bk">To start, we will use the <code class="cx qo qp qq qr b">DESCRIBE</code>function to get information about the columns:</p><pre class="ms mt mu mv mw sf qr sg bp sh bb bk"><span id="ce39" class="si oo fq qr b bg sj sk l sl sm">DESCRIBE SELECT * FROM ST_READOSM('monaco-latest.osm.pbf');<br/><br/>┌─────────────┬──────────────────────────────────────────────┬─────────┬─────────┬─────────┬─────────┐<br/>│ column_name │                 column_type                  │  null   │   key   │ default │  extra  │<br/>│   varchar   │                   varchar                    │ varchar │ varchar │ varchar │ varchar │<br/>├─────────────┼──────────────────────────────────────────────┼─────────┼─────────┼─────────┼─────────┤<br/>│ kind        │ ENUM('node', 'way', 'relation', 'changeset') │ YES     │ NULL    │ NULL    │ NULL    │<br/>│ id          │ BIGINT                                       │ YES     │ NULL    │ NULL    │ NULL    │<br/>│ tags        │ MAP(VARCHAR, VARCHAR)                        │ YES     │ NULL    │ NULL    │ NULL    │<br/>│ refs        │ BIGINT[]                                     │ YES     │ NULL    │ NULL    │ NULL    │<br/>│ lat         │ DOUBLE                                       │ YES     │ NULL    │ NULL    │ NULL    │<br/>│ lon         │ DOUBLE                                       │ YES     │ NULL    │ NULL    │ NULL    │<br/>│ ref_roles   │ VARCHAR[]                                    │ YES     │ NULL    │ NULL    │ NULL    │<br/>│ ref_types   │ ENUM('node', 'way', 'relation')[]            │ YES     │ NULL    │ NULL    │ NULL    │<br/>└─────────────┴──────────────────────────────────────────────┴─────────┴─────────┴─────────┴─────────┘</span></pre><p id="87db" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">There are 8 columns returned by the <code class="cx qo qp qq qr b">ST_READOSM</code>function:</p><ul class=""><li id="5133" class="nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe pn po pp bk">kind — this is the type of an element. It can also have a value of <code class="cx qo qp qq qr b">changeset</code>representing the changes after editing the existing element in the OSM. Extracts from the Geofabrik download server don’t contain changesets, so we don’t have to think about them.</li><li id="8625" class="nj nk fq nl b go pq nn no gr pr nq nr ns ps nu nv nw pt ny nz oa pu oc od oe pn po pp bk">id — the element identifier.</li><li id="85c8" class="nj nk fq nl b go pq nn no gr pr nq nr ns ps nu nv nw pt ny nz oa pu oc od oe pn po pp bk">tags — map (or a dictionary) of two strings: a tag key and a tag value.</li><li id="fe30" class="nj nk fq nl b go pq nn no gr pr nq nr ns ps nu nv nw pt ny nz oa pu oc od oe pn po pp bk">refs — list of member IDs related to the element. Nodes should have this list empty and ways and relations can’t have it empty.</li><li id="4581" class="nj nk fq nl b go pq nn no gr pr nq nr ns ps nu nv nw pt ny nz oa pu oc od oe pn po pp bk">lat and lon — latitude and longitude of a node. Ways and relations should have these fields empty since only nodes can have coordinates in the OSM.</li><li id="9483" class="nj nk fq nl b go pq nn no gr pr nq nr ns ps nu nv nw pt ny nz oa pu oc od oe pn po pp bk">ref_roles and ref_types — a list of additional information about members: what role is assigned to the member and what type is it (node, way or relation).</li></ul><h2 id="f8f3" class="on oo fq bf op oq or os ot ou ov ow ox ns oy oz pa nw pb pc pd oa pe pf pg ph bk">Counting the elements</h2><p id="147c" class="pw-post-body-paragraph nj nk fq nl b go pi nn no gr pj nq nr ns pk nu nv nw pl ny nz oa pm oc od oe fj bk">Let’s see how many elements there are in total and per element type.</p><pre class="ms mt mu mv mw sf qr sg bp sh bb bk"><span id="667b" class="si oo fq qr b bg sj sk l sl sm">SELECT COUNT(*) as total_elements<br/>FROM ST_READOSM('monaco-latest.osm.pbf');<br/><br/>┌────────────────┐<br/>│ total_elements │<br/>│     int64      │<br/>├────────────────┤<br/>│          35782 │<br/>└────────────────┘<br/><br/>SELECT kind, COUNT(*) as total_elements<br/>FROM ST_READOSM('monaco-latest.osm.pbf')<br/>GROUP BY 1;<br/><br/>┌──────────────────────────────────────────────┬────────────────┐<br/>│                     kind                     │ total_features │<br/>│ enum('node', 'way', 'relation', 'changeset') │     int64      │<br/>├──────────────────────────────────────────────┼────────────────┤<br/>│ node                                         │          30643 │<br/>│ way                                          │           4849 │<br/>│ relation                                     │            290 │<br/>└──────────────────────────────────────────────┴────────────────┘</span></pre><h2 id="9272" class="on oo fq bf op oq or os ot ou ov ow ox ns oy oz pa nw pb pc pd oa pe pf pg ph bk">Looking at the elements</h2><p id="4bd0" class="pw-post-body-paragraph nj nk fq nl b go pi nn no gr pj nq nr ns pk nu nv nw pl ny nz oa pm oc od oe fj bk">Let’s check the examples of the data for each element type.</p><pre class="ms mt mu mv mw sf qr sg bp sh bb bk"><span id="f6da" class="si oo fq qr b bg sj sk l sl sm">SELECT *<br/>FROM ST_READOSM('monaco-latest.osm.pbf')<br/>WHERE kind = 'node'<br/>LIMIT 5;<br/><br/>┌──────────────────────┬──────────┬─────────────────────────────┬─────────┬────────────────────┬────────────────────┬───────────┬───────────────────────────────────┐<br/>│         kind         │    id    │            tags             │  refs   │        lat         │        lon         │ ref_roles │             ref_types             │<br/>│ enum('node', 'way'…  │  int64   │    map(varchar, varchar)    │ int64[] │       double       │       double       │ varchar[] │ enum('node', 'way', 'relation')[] │<br/>├──────────────────────┼──────────┼─────────────────────────────┼─────────┼────────────────────┼────────────────────┼───────────┼───────────────────────────────────┤<br/>│ node                 │ 21911883 │                             │         │ 43.737117500000004 │  7.422909300000001 │           │                                   │<br/>│ node                 │ 21911886 │ {crossing=zebra, crossing…  │         │ 43.737239900000006 │  7.423498500000001 │           │                                   │<br/>│ node                 │ 21911894 │                             │         │ 43.737773100000005 │          7.4259193 │           │                                   │<br/>│ node                 │ 21911901 │                             │         │ 43.737762100000005 │ 7.4267099000000005 │           │                                   │<br/>│ node                 │ 21911908 │                             │         │         43.7381906 │           7.426961 │           │                                   │<br/>└──────────────────────┴──────────┴─────────────────────────────┴─────────┴────────────────────┴────────────────────┴───────────┴───────────────────────────────────┘<br/><br/>SELECT *<br/>FROM ST_READOSM('monaco-latest.osm.pbf')<br/>WHERE kind = 'way'<br/>LIMIT 5;<br/><br/>┌──────────────────────┬─────────┬──────────────────────┬─────────────────────────────────────────┬────────┬────────┬───────────┬───────────────────────────────────┐<br/>│         kind         │   id    │         tags         │                  refs                   │  lat   │  lon   │ ref_roles │             ref_types             │<br/>│ enum('node', 'way'…  │  int64  │ map(varchar, varch…  │                 int64[]                 │ double │ double │ varchar[] │ enum('node', 'way', 'relation')[] │<br/>├──────────────────────┼─────────┼──────────────────────┼─────────────────────────────────────────┼────────┼────────┼───────────┼───────────────────────────────────┤<br/>│ way                  │ 4097656 │ {highway=secondary…  │ [21912089, 7265761724, 1079750744, 21…  │        │        │           │                                   │<br/>│ way                  │ 4098197 │ {highway=tertiary,…  │ [21918500, 10723812919, 1204288480, 2…  │        │        │           │                                   │<br/>│ way                  │ 4224972 │ {highway=residenti…  │ [25177418, 4939779378, 4939779381, 49…  │        │        │           │                                   │<br/>│ way                  │ 4224978 │ {access=no, addr:c…  │ [25178088, 25178091, 25178045, 251780…  │        │        │           │                                   │<br/>│ way                  │ 4226740 │ {highway=secondary…  │ [25192130, 6444966483, 1737389127, 64…  │        │        │           │                                   │<br/>└──────────────────────┴─────────┴──────────────────────┴─────────────────────────────────────────┴────────┴────────┴───────────┴───────────────────────────────────┘<br/><br/>SELECT *<br/>FROM ST_READOSM('monaco-latest.osm.pbf')<br/>WHERE kind = 'relation'<br/>LIMIT 5;<br/><br/>┌──────────────────────┬───────┬──────────────────────┬──────────────────────┬────────┬────────┬──────────────────────┬─────────────────────────────────────────────┐<br/>│         kind         │  id   │         tags         │         refs         │  lat   │  lon   │      ref_roles       │                  ref_types                  │<br/>│ enum('node', 'way'…  │ int64 │ map(varchar, varch…  │       int64[]        │ double │ double │      varchar[]       │      enum('node', 'way', 'relation')[]      │<br/>├──────────────────────┼───────┼──────────────────────┼──────────────────────┼────────┼────────┼──────────────────────┼─────────────────────────────────────────────┤<br/>│ relation             │  7385 │ {ISO3166-2=FR-06, …  │ [1701090139, 32665…  │        │        │ [admin_centre, lab…  │ [node, node, way, way, way, way, way, way…  │<br/>│ relation             │  8654 │ {ISO3166-2=FR-PAC,…  │ [26761400, 1251610…  │        │        │ [admin_centre, lab…  │ [node, node, way, way, way, way, way, way…  │<br/>│ relation             │ 11980 │ {ISO3166-1=FR, ISO…  │ [17807753, 1363947…  │        │        │ [admin_centre, lab…  │ [node, node, relation, relation, relation…  │<br/>│ relation             │ 36990 │ {ISO3166-1=MC, ISO…  │ [1790048269, 77077…  │        │        │ [admin_centre, out…  │ [node, way, way, way, way, way, way, way,…  │<br/>│ relation             │ 90352 │ {admin_level=2, bo…  │ [770774507, 377944…  │        │        │ [outer, outer, out…  │ [way, way, way, way, way, way, way, way, …  │<br/>└──────────────────────┴───────┴──────────────────────┴──────────────────────┴────────┴────────┴──────────────────────┴─────────────────────────────────────────────┘</span></pre><p id="9bb0" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">Now we can see how the elements are defined: nodes have coordinates, ways have <em class="rr">refs</em> lists filled with node IDs and relations have the most complicated structure with <em class="rr">refs</em> lists filled with IDs and <em class="rr">ref_types</em> lists showing which ID correspond to which element type. Additionally, <em class="rr">ref_roles </em>have information about the role of the member (admin_centre, label, inner, outer).</p><h1 id="f31e" class="pv oo fq bf op pw px gq ot py pz gt ox qa qb qc qd qe qf qg qh qi qj qk ql qm bk">Constructing point geometries from the nodes</h1><p id="a23c" class="pw-post-body-paragraph nj nk fq nl b go pi nn no gr pj nq nr ns pk nu nv nw pl ny nz oa pm oc od oe fj bk">Now that we know what the structure looks like, we can start building some geometries. Starting with nodes should be the easiest since it’s just a pair of latitudes and longitudes in the WGS84 Coordinate Reference System.</p><p id="5a11" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">We should only extract nodes with at least one tag attached since those have any semantical meaning for analytical purposes. Nodes without any tags could be used to construct ways in the later stages.</p><pre class="ms mt mu mv mw sf qr sg bp sh bb bk"><span id="86f1" class="si oo fq qr b bg sj sk l sl sm">SELECT<br/>    id,<br/>    tags,<br/>    ST_POINT(lon, lat) geometry<br/>FROM ST_READOSM('monaco-latest.osm.pbf')<br/>WHERE kind = 'node'<br/>    AND tags IS NOT NULL<br/>    AND cardinality(tags) &gt; 0;<br/><br/>┌─────────────┬─────────────────────────────────────────────────────────┬──────────────────────────────────────────────┐<br/>│     id      │                          tags                           │                   geometry                   │<br/>│    int64    │                  map(varchar, varchar)                  │                   geometry                   │<br/>├─────────────┼─────────────────────────────────────────────────────────┼──────────────────────────────────────────────┤<br/>│    21911886 │ {crossing=zebra, crossing:island=no, crossing_ref=zeb…  │ POINT (7.423498500000001 43.737239900000006) │<br/>│    21912962 │ {crossing=zebra, crossing_ref=zebra, highway=crossing}  │ POINT (7.426912100000001 43.737912800000004) │<br/>│    21914341 │ {crossing=uncontrolled, crossing_ref=zebra, highway=c…  │ POINT (7.4233732 43.737010000000005)         │<br/>│    21915639 │ {highway=traffic_signals}                               │ POINT (7.4256003 43.7404449)                 │<br/>│    21917308 │ {bus=yes, name=Monte-Carlo (Casino), public_transport…  │ POINT (7.4259854 43.740984700000006)         │<br/>│    21918329 │ {crossing=marked, crossing:markings=yes, highway=cros…  │ POINT (7.427889100000001 43.7423616)         │<br/>│    21918589 │ {crossing=marked, crossing:island=yes, crossing:marki…  │ POINT (7.4317478 43.7472774)                 │<br/>│    21918697 │ {crossing=marked, crossing:island=no, crossing:markin…  │ POINT (7.432645000000001 43.747892900000004) │<br/>│    21918939 │ {bus=yes, name=Portier, public_transport=stop_position} │ POINT (7.430429800000001 43.741472800000004) │<br/>│    21919093 │ {crossing=marked, crossing:markings=yes, crossing_ref…  │ POINT (7.4352171 43.748160000000006)         │<br/>│        ·    │                   ·                                     │                  ·                           │<br/>│        ·    │                   ·                                     │                  ·                           │<br/>│        ·    │                   ·                                     │                  ·                           │<br/>│ 11450012980 │ {direction=forward, highway=give_way}                   │ POINT (7.416853100000001 43.735809700000004) │<br/>│ 11450012981 │ {direction=forward, highway=give_way}                   │ POINT (7.416783000000001 43.735872900000004) │<br/>│ 11450012982 │ {direction=forward, highway=give_way}                   │ POINT (7.416664900000001 43.735887000000005) │<br/>│ 11450012983 │ {direction=forward, highway=give_way}                   │ POINT (7.4166968 43.7356945)                 │<br/>│ 11451922579 │ {bus=yes, highway=bus_stop, name=Larvotto, public_tra…  │ POINT (7.435032400000001 43.7481639)         │<br/>│ 11451922580 │ {bus=yes, highway=bus_stop, name=Grimaldi Forum, publ…  │ POINT (7.4311343 43.7442067)                 │<br/>│ 11451922581 │ {bench=yes, bus=yes, highway=bus_stop, name=Portier, …  │ POINT (7.430357300000001 43.742209100000004) │<br/>│ 11451922582 │ {bench=no, bin=no, bus=yes, highway=bus_stop, lit=yes…  │ POINT (7.4107674 43.7296193)                 │<br/>│ 11451922600 │ {direction=backward, highway=give_way}                  │ POINT (7.4105622 43.7291648)                 │<br/>│ 11452057060 │ {direction=backward, highway=give_way}                  │ POINT (7.419164 43.737116)                   │<br/>├─────────────┴─────────────────────────────────────────────────────────┴──────────────────────────────────────────────┤<br/>│ 3167 rows (20 shown)                                                                                       3 columns │<br/>└──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘</span></pre></div></div><div class="mj"><div class="ab cb"><div class="lm mk ln ml lo mm cf mn cg mo ci bh"><figure class="ms mt mu mv mw mj mx my paragraph-image"><div role="button" tabindex="0" class="mz na ed nb bh nc"><div class="mp mq sn"><img src="../Images/c940d87cb6db1a98fff59db98498049a.png" data-original-src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*WVVublrE3NtZfADjDEW4sw.png"/></div></div><figcaption class="ne nf ng mp mq nh ni bf b bg z dx">Nodes plotted on a map. Generated by the author using GeoPandas library.</figcaption></figure></div></div></div><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="1b7f" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">After filtering the nodes based on tags, we are left with 3167 points. <br/>It’s around 10% of the total number of nodes in the source file.</p><h1 id="32f8" class="pv oo fq bf op pw px gq ot py pz gt ox qa qb qc qd qe qf qg qh qi qj qk ql qm bk">Constructing linestring and polygon geometries from the ways</h1><p id="22ab" class="pw-post-body-paragraph nj nk fq nl b go pi nn no gr pj nq nr ns pk nu nv nw pl ny nz oa pm oc od oe fj bk">With nodes out of the <em class="rr">way </em>😉, let’s focus now on ways. Ways can take the form of linestrings or polygons. Let’s focus on linestrings first and then we will assign proper geometry types.</p><p id="f331" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">To construct the ways we have to do multiple operations:</p><ul class=""><li id="28a9" class="nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe pn po pp bk">Select matching ways with tags.</li><li id="adc7" class="nj nk fq nl b go pq nn no gr pr nq nr ns ps nu nv nw pt ny nz oa pu oc od oe pn po pp bk">Unnest all nodes refs for each way element and keep them in the proper order (remember - nodes refs order matter!).</li><li id="7d9c" class="nj nk fq nl b go pq nn no gr pr nq nr ns ps nu nv nw pt ny nz oa pu oc od oe pn po pp bk">Select required nodes with geometries.</li><li id="df64" class="nj nk fq nl b go pq nn no gr pr nq nr ns ps nu nv nw pt ny nz oa pu oc od oe pn po pp bk">Group nodes per way ID and construct a linestring geometry using <code class="cx qo qp qq qr b">ST_MakeLine</code>function.</li><li id="85be" class="nj nk fq nl b go pq nn no gr pr nq nr ns ps nu nv nw pt ny nz oa pu oc od oe pn po pp bk">Join constructed geometries with tags.</li></ul><p id="5077" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">Let’s start with selecting ways with tags.</p><pre class="ms mt mu mv mw sf qr sg bp sh bb bk"><span id="f4a5" class="si oo fq qr b bg sj sk l sl sm">CREATE TEMP TABLE matching_ways AS <br/>SELECT id, tags<br/>FROM ST_READOSM('monaco-latest.osm.pbf')<br/>WHERE kind = 'way' AND tags IS NOT NULL AND cardinality(tags) &gt; 0;<br/><br/>SELECT * FROM matching_ways;<br/><br/>┌────────────┬─────────────────────────────────────────────────────────────────┐<br/>│     id     │                              tags                               │<br/>│   int64    │                      map(varchar, varchar)                      │<br/>├────────────┼─────────────────────────────────────────────────────────────────┤<br/>│    4097656 │ {highway=secondary, lanes=2, lit=yes, maxspeed=30, name=Avenu…  │<br/>│    4098197 │ {highway=tertiary, lanes=2, lit=yes, name=Boulevard d`Italie,…  │<br/>│    4224972 │ {highway=residential, lit=yes, name=Avenue des Papalins, onew…  │<br/>│    4224978 │ {access=no, addr:country=MC, leisure=pitch, lit=yes, sport=so…  │<br/>│    4226740 │ {highway=secondary, lanes=2, lit=yes, maxspeed=50, name=Boule…  │<br/>│    4227155 │ {area=yes, highway=pedestrian, lit=yes, name=Place du Palais,…  │<br/>│    4227156 │ {access=no, bus=yes, demolished:highway=service, oneway=yes, …  │<br/>│    4227157 │ {highway=residential, name=Rue des Remparts, oneway=yes, surf…  │<br/>│    4227158 │ {highway=residential, name=Rue Philibert Florence, oneway=yes…  │<br/>│    4227164 │ {highway=secondary, lanes=2, lit=yes, name=Virage Antony Nogu…  │<br/>│       ·    │                                ·                                │<br/>│       ·    │                                ·                                │<br/>│       ·    │                                ·                                │<br/>│ 1230247124 │ {bench=no, bin=yes, bus=yes, check_date=2023-12-10, covered=y…  │<br/>│ 1230273018 │ {access=yes, leisure=playground, wheelchair=yes}                │<br/>│ 1230273019 │ {highway=footway, surface=paving_stones}                        │<br/>│ 1230398878 │ {abandoned:railway=rail, highway=primary, lanes=2, lit=yes, m…  │<br/>│ 1233828725 │ {highway=service, lit=yes, name=Place Moulins, oneway=yes}      │<br/>│ 1233828726 │ {highway=tertiary, junction=roundabout, lanes=2, lit=yes, non…  │<br/>│ 1233853668 │ {highway=secondary, lanes=2, lit=yes, maxspeed=50, name=Boule…  │<br/>│ 1238339144 │ {cycleway:left=lane, highway=tertiary, lanes=2, lit=yes, maxs…  │<br/>│ 1238339145 │ {cycleway:left=lane, highway=tertiary, lanes=2, lit=yes, maxs…  │<br/>│ 1239415633 │ {footway=sidewalk, highway=footway}                             │<br/>├────────────┴─────────────────────────────────────────────────────────────────┤<br/>│ 4786 rows (20 shown)                                               2 columns │<br/>└──────────────────────────────────────────────────────────────────────────────┘</span></pre><p id="c1a7" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">Now we will unnest refs lists and split them into individual rows. We will also utilize DuckDB’s indexing functions to remember the order of elements in the original list.</p><pre class="ms mt mu mv mw sf qr sg bp sh bb bk"><span id="3820" class="si oo fq qr b bg sj sk l sl sm">CREATE TEMP TABLE matching_ways_with_nodes_refs AS<br/>SELECT id, UNNEST(refs) as ref, UNNEST(range(length(refs))) as ref_idx<br/>FROM ST_READOSM('monaco-latest.osm.pbf')<br/>SEMI JOIN matching_ways USING (id)<br/>WHERE kind = 'way';<br/><br/>SELECT * FROM matching_ways_with_nodes_refs;<br/><br/>┌───────────┬────────────┬─────────┐<br/>│    id     │    ref     │ ref_idx │<br/>│   int64   │   int64    │  int64  │<br/>├───────────┼────────────┼─────────┤<br/>│   4097656 │   21912089 │       0 │<br/>│   4097656 │ 7265761724 │       1 │<br/>│   4097656 │ 1079750744 │       2 │<br/>│   4097656 │ 2104793864 │       3 │<br/>│   4097656 │ 6340961560 │       4 │<br/>│   4097656 │ 1110560507 │       5 │<br/>│   4097656 │   21912093 │       6 │<br/>│   4097656 │ 6340961559 │       7 │<br/>│   4097656 │   21912095 │       8 │<br/>│   4097656 │ 7265762803 │       9 │<br/>│      ·    │      ·     │       · │<br/>│      ·    │      ·     │       · │<br/>│      ·    │      ·     │       · │<br/>│ 151154357 │ 7927855820 │       2 │<br/>│ 151154358 │ 1868015912 │       0 │<br/>│ 151154358 │ 1868015910 │       1 │<br/>│ 151154358 │ 1868015900 │       2 │<br/>│ 151154358 │ 4437858221 │       3 │<br/>│ 151154358 │ 1868015889 │       4 │<br/>│ 151154358 │ 1790048390 │       5 │<br/>│ 151154358 │ 1868015881 │       6 │<br/>│ 151154358 │ 1868015894 │       7 │<br/>│ 151154358 │ 1868015896 │       8 │<br/>├───────────┴────────────┴─────────┤<br/>│  ? rows (&gt;9999 rows, 20 shown)   │<br/>└──────────────────────────────────┘</span></pre><p id="e6df" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">As you can see, there are now multiple rows per way element and multiple ref values. Ref_idx represents the original order in the <em class="rr">refs </em>list.</p><p id="3f52" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">You can also see the <code class="cx qo qp qq qr b">SEMI JOIN</code>clause in the query. This is a special join available in the DuckDB, that just filters rows without actually joining the second table. You can read more about it in the official documentation:</p><div class="qu qv qw qx qy qz"><a href="https://duckdb.org/docs/sql/query_syntax/from?source=post_page-----ffeb15197390--------------------------------#semi-and-anti-joins" rel="noopener  ugc nofollow" target="_blank"><div class="ra ab ig"><div class="rb ab co cb rc rd"><h2 class="bf fr hw z io re iq ir rf it iv fp bk">FROM &amp; JOIN Clauses</h2><div class="rg l"><h3 class="bf b hw z io re iq ir rf it iv dx">The FROM clause specifies the source of the data on which the remainder of the query should operate. Logically, the…</h3></div><div class="rh l"><p class="bf b dy z io re iq ir rf it iv dx">duckdb.org</p></div></div><div class="ri l"><div class="so l rk rl rm ri rn lr qz"/></div></div></a></div><p id="1f5e" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">Now we can select the required nodes based on the refs from the previous step:</p><pre class="ms mt mu mv mw sf qr sg bp sh bb bk"><span id="5560" class="si oo fq qr b bg sj sk l sl sm">CREATE TEMP TABLE required_nodes_with_geometries AS<br/>SELECT id, ST_POINT(lon, lat) geometry<br/>FROM ST_READOSM('monaco-latest.osm.pbf') nodes<br/>SEMI JOIN matching_ways_with_nodes_refs<br/>ON nodes.id = matching_ways_with_nodes_refs.ref<br/>WHERE kind = 'node';<br/><br/>SELECT * FROM required_nodes_with_geometries;<br/><br/>┌────────────┬──────────────────────────────────────────────┐<br/>│     id     │                   geometry                   │<br/>│   int64    │                   geometry                   │<br/>├────────────┼──────────────────────────────────────────────┤<br/>│ 4547239708 │ POINT (7.4219302 43.7307441)                 │<br/>│ 4547239709 │ POINT (7.421943700000001 43.730763)          │<br/>│ 4547239710 │ POINT (7.421885100000001 43.7308797)         │<br/>│ 4547239711 │ POINT (7.421869 43.730828200000005)          │<br/>│ 4547239712 │ POINT (7.4218596 43.7307865)                 │<br/>│ 4547239713 │ POINT (7.4219166 43.7307701)                 │<br/>│ 4547239714 │ POINT (7.4220242 43.730742)                  │<br/>│ 4547239715 │ POINT (7.4220765 43.730725500000005)         │<br/>│ 4547239716 │ POINT (7.4220677 43.730680400000004)         │<br/>│ 4547239717 │ POINT (7.422105200000001 43.730662)          │<br/>│      ·     │                  ·                           │<br/>│      ·     │                  ·                           │<br/>│      ·     │                  ·                           │<br/>│ 9983243582 │ POINT (7.427689600000001 43.732439400000004) │<br/>│ 9983243583 │ POINT (7.4238021 43.7298837)                 │<br/>│ 9983243584 │ POINT (7.4272774 43.7321503)                 │<br/>│ 9983243585 │ POINT (7.4287133 43.7403807)                 │<br/>│ 9983243586 │ POINT (7.429299500000001 43.740351100000005) │<br/>│ 9983243587 │ POINT (7.4265819 43.7399094)                 │<br/>│ 9983243588 │ POINT (7.4275342 43.7323072)                 │<br/>│ 9983243589 │ POINT (7.427783700000001 43.732368)          │<br/>│ 9983243590 │ POINT (7.428839600000001 43.7402718)         │<br/>│ 9983243591 │ POINT (7.4269439 43.739707700000004)         │<br/>├────────────┴──────────────────────────────────────────────┤<br/>│ ? rows (&gt;9999 rows, 20 shown)                   2 columns │<br/>└───────────────────────────────────────────────────────────┘</span></pre><p id="9add" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">Now we can construct the full linestrings:</p><pre class="ms mt mu mv mw sf qr sg bp sh bb bk"><span id="fb19" class="si oo fq qr b bg sj sk l sl sm">CREATE TEMP TABLE matching_ways_linestrings AS<br/>SELECT<br/>    matching_ways.id,<br/>    matching_ways.tags,<br/>    ST_MakeLine(list(nodes.geometry ORDER BY ref_idx ASC)) linestring<br/>FROM matching_ways<br/>JOIN matching_ways_with_nodes_refs<br/>ON matching_ways.id = matching_ways_with_nodes_refs.id<br/>JOIN required_nodes_with_geometries nodes<br/>ON matching_ways_with_nodes_refs.ref = nodes.id<br/>GROUP BY 1, 2;<br/><br/>SELECT * FROM matching_ways_linestrings;<br/><br/>┌────────────┬──────────────────────┬──────────────────────────────────────────┐<br/>│     id     │         tags         │                linestring                │<br/>│   int64    │ map(varchar, varch…  │                 geometry                 │<br/>├────────────┼──────────────────────┼──────────────────────────────────────────┤<br/>│    4227212 │ {highway=residenti…  │ LINESTRING (7.424979 43.73150620000000…  │<br/>│    4227230 │ {access=yes, admin…  │ LINESTRING (7.4220576 43.7321018, 7.42…  │<br/>│    4227273 │ {highway=secondary…  │ LINESTRING (7.4214168 43.7365583000000…  │<br/>│    4229325 │ {highway=secondary…  │ LINESTRING (7.4201113 43.7373194000000…  │<br/>│    4229900 │ {highway=secondary…  │ LINESTRING (7.4167819 43.7299324, 7.41…  │<br/>│    4230116 │ {highway=footway, …  │ LINESTRING (7.4302666 43.7467818, 7.43…  │<br/>│   24672725 │ {highway=residenti…  │ LINESTRING (7.4356746 43.7516752, 7.43…  │<br/>│   25082701 │ {area=yes, highway…  │ LINESTRING (7.421602 43.7370201, 7.421…  │<br/>│   31900562 │ {area=yes, floatin…  │ LINESTRING (7.422541900000001 43.73529…  │<br/>│   37794470 │ {admin_level=2, bo…  │ LINESTRING (7.438411400000001 43.74942…  │<br/>│       ·    │        ·             │                    ·                     │<br/>│       ·    │        ·             │                    ·                     │<br/>│       ·    │        ·             │                    ·                     │<br/>│ 1203859766 │ {landuse=grass}      │ LINESTRING (7.4172849 43.7324023000000…  │<br/>│ 1203859775 │ {landuse=grass}      │ LINESTRING (7.417039300000001 43.73209…  │<br/>│ 1218054879 │ {highway=footway, …  │ LINESTRING (7.4257143 43.7307631000000…  │<br/>│ 1229465608 │ {amenity=shelter, …  │ LINESTRING (7.417716100000001 43.73075…  │<br/>│ 1230102086 │ {footway=crossing,…  │ LINESTRING (7.414346 43.72708160000000…  │<br/>│ 1230123519 │ {footway=link, hig…  │ LINESTRING (7.4238967 43.7370229, 7.42…  │<br/>│ 1202747620 │ {crossing=unmarked…  │ LINESTRING (7.420526100000001 43.72671…  │<br/>│ 1203858289 │ {crossing=uncontro…  │ LINESTRING (7.4179021 43.7344211000000…  │<br/>│ 1203861575 │ {amenity=parking}    │ LINESTRING (7.430036100000001 43.74015…  │<br/>│ 1203861579 │ {landuse=construct…  │ LINESTRING (7.4323636 43.7423150000000…  │<br/>├────────────┴──────────────────────┴──────────────────────────────────────────┤<br/>│ 4786 rows (20 shown)                                               3 columns │<br/>└──────────────────────────────────────────────────────────────────────────────┘</span></pre></div></div><div class="mj"><div class="ab cb"><div class="lm mk ln ml lo mm cf mn cg mo ci bh"><figure class="ms mt mu mv mw mj mx my paragraph-image"><div role="button" tabindex="0" class="mz na ed nb bh nc"><div class="mp mq sp"><img src="../Images/4ac75ad2615c915d36bbd5d22d94dbf3.png" data-original-src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*dBlz3_FcEoOfuOgBInKKng.png"/></div></div><figcaption class="ne nf ng mp mq nh ni bf b bg z dx">Ways linestrings plotted on a map. Generated by the author using GeoPandas library.</figcaption></figure></div></div></div><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="4614" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">After doing all of those operations, we have ways in the linestring form. Now we have to select the ways that are supposed to be polygons. We can do this based on tag values. Unfortunately, there is no single source of truth for this operation. We can look at the page from the OSM wiki to see one of the definitions created by the community.</p><div class="qu qv qw qx qy qz"><a href="https://wiki.openstreetmap.org/wiki/Overpass_turbo/Polygon_Features?source=post_page-----ffeb15197390--------------------------------" rel="noopener  ugc nofollow" target="_blank"><div class="ra ab ig"><div class="rb ab co cb rc rd"><h2 class="bf fr hw z io re iq ir rf it iv fp bk">Overpass turbo/Polygon Features</h2><div class="rg l"><h3 class="bf b hw z io re iq ir rf it iv dx">As OpenStreetMap doesn't have an intrinsic area data type, an heuristic has to be applied to determine whether a way is…</h3></div><div class="rh l"><p class="bf b dy z io re iq ir rf it iv dx">wiki.openstreetmap.org</p></div></div><div class="ri l"><div class="sq l rk rl rm ri rn lr qz"/></div></div></a></div><figure class="ms mt mu mv mw mj mp mq paragraph-image"><div role="button" tabindex="0" class="mz na ed nb bh nc"><div class="mp mq sr"><img src="../Images/78cf5e001831f9276d433c6b61d252da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*STTaGhcJ0vKjiSHN0lTe6A.png"/></div></div><figcaption class="ne nf ng mp mq nh ni bf b bg z dx">A screenshot from the Overpass turbo/Polygon Features wiki page. Taken on 2024-01-17.</figcaption></figure><p id="fa14" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">As you can see, this list is quite long, so for brevity we will only check if the linestring forms a closed loop and if the area tag value is not ‘no’.</p><pre class="ms mt mu mv mw sf qr sg bp sh bb bk"><span id="d030" class="si oo fq qr b bg sj sk l sl sm">WITH way_polygon_feature AS (<br/>    SELECT<br/>        id,<br/>        (<br/>            -- if first and last nodes are the same<br/>            ST_Equals(ST_StartPoint(linestring), ST_EndPoint(linestring))<br/>            -- if the element doesn't have any tags leave it as a Linestring<br/>            AND tags IS NOT NULL<br/>            -- if the element is specifically tagged 'area':'no' -&gt; LineString<br/>            AND NOT (<br/>                list_contains(map_keys(tags), 'area')<br/>                AND list_extract(map_extract(tags, 'area'), 1) = 'no'<br/>            )<br/>        ) AS is_polygon<br/>    FROM matching_ways_linestrings<br/>)<br/>SELECT<br/>    matching_ways_linestrings.id,<br/>    matching_ways_linestrings.tags,<br/>    (CASE<br/>        WHEN is_polygon<br/>        THEN ST_MakePolygon(linestring)<br/>        ELSE linestring<br/>    END)::GEOMETRY AS geometry<br/>FROM matching_ways_linestrings<br/>JOIN way_polygon_feature<br/>ON matching_ways_linestrings.id = way_polygon_feature.id;<br/><br/>┌────────────┬──────────────────────┬──────────────────────────────────────────┐<br/>│     id     │         tags         │                 geometry                 │<br/>│   int64    │ map(varchar, varch…  │                 geometry                 │<br/>├────────────┼──────────────────────┼──────────────────────────────────────────┤<br/>│    4226740 │ {highway=secondary…  │ LINESTRING (7.422170500000001 43.73286…  │<br/>│    4227198 │ {highway=residenti…  │ LINESTRING (7.420338900000001 43.73223…  │<br/>│    4227216 │ {highway=service, …  │ LINESTRING (7.423448400000001 43.73268…  │<br/>│    4227242 │ {highway=secondary…  │ LINESTRING (7.4221786 43.7322418000000…  │<br/>│    4227272 │ {highway=secondary…  │ LINESTRING (7.422117500000001 43.73702…  │<br/>│    4229292 │ {foot=no, highway=…  │ LINESTRING (7.41643 43.7311373, 7.4168…  │<br/>│    4229577 │ {highway=residenti…  │ LINESTRING (7.4251499 43.7397216, 7.42…  │<br/>│    4230122 │ {alt_name=rue R. P…  │ LINESTRING (7.428823400000001 43.74602…  │<br/>│   25082741 │ {highway=secondary…  │ LINESTRING (7.4231414 43.7369886000000…  │<br/>│   25722909 │ {highway=footway, …  │ LINESTRING (7.423659300000001 43.73134…  │<br/>│       ·    │          ·           │                    ·                     │<br/>│       ·    │          ·           │                    ·                     │<br/>│       ·    │          ·           │                    ·                     │<br/>│ 1089844256 │ {handrail=no, high…  │ LINESTRING (7.4229453 43.7326080000000…  │<br/>│ 1089844296 │ {highway=footway}    │ LINESTRING (7.427017200000001 43.74044…  │<br/>│ 1202570722 │ {access=private, l…  │ POLYGON ((7.4263241 43.7390763, 7.4263…  │<br/>│  946167565 │ {disused:leisure=p…  │ POLYGON ((7.4276993 43.739335100000005…  │<br/>│ 1089844271 │ {highway=footway}    │ LINESTRING (7.4277667 43.732816, 7.427…  │<br/>│  335731716 │ {highway=footway}    │ LINESTRING (7.417764200000001 43.73439…  │<br/>│  779454018 │ {building=resident…  │ POLYGON ((7.4217522 43.7277202, 7.4218…  │<br/>│  943330855 │ {landuse=grass}      │ POLYGON ((7.4151844 43.7332252, 7.4152…  │<br/>│ 1089844229 │ {highway=steps, in…  │ LINESTRING (7.4274525 43.7328052, 7.42…  │<br/>│   49209608 │ {addr:city=Monaco,…  │ POLYGON ((7.4223448 43.7304076, 7.4221…  │<br/>├────────────┴──────────────────────┴──────────────────────────────────────────┤<br/>│ 4786 rows (20 shown)                                               3 columns │<br/>└──────────────────────────────────────────────────────────────────────────────┘</span></pre><p id="3f9e" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">Now we can see the mix of linestring and polygon geometries in the final result. Of course, the predicate for the <em class="rr">is_polygon</em> column could (or even <em class="rr">should</em>) be extended by the logic mentioned above regarding the values of the tags.</p><p id="35ba" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">Compared to the image above, many more filled polygons are now visible on the map.</p></div></div><div class="mj"><div class="ab cb"><div class="lm mk ln ml lo mm cf mn cg mo ci bh"><figure class="ms mt mu mv mw mj mx my paragraph-image"><div role="button" tabindex="0" class="mz na ed nb bh nc"><div class="mp mq sp"><img src="../Images/15582954eacc19644cb8eff1f018f0cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*K8v8NjrTliLmBY3QqDnFhg.png"/></div></div><figcaption class="ne nf ng mp mq nh ni bf b bg z dx">Ways geometries plotted on a map. Generated by the author using GeoPandas library.</figcaption></figure></div></div></div><div class="ab cb"><div class="ci bh ev ew ex ey"><h1 id="0eec" class="pv oo fq bf op pw px gq ot py pz gt ox qa qb qc qd qe qf qg qh qi qj qk ql qm bk">Constructing polygon and multi-polygon geometries from the relations</h1><p id="1c43" class="pw-post-body-paragraph nj nk fq nl b go pi nn no gr pj nq nr ns pk nu nv nw pl ny nz oa pm oc od oe fj bk">Relations are utilized in OSM to group multiple other elements into a single object. Here we will focus solely on the (multi-) polygons. These specific elements have a <code class="cx qo qp qq qr b">type</code> tag with one of two values: <code class="cx qo qp qq qr b">boundary</code>, and <code class="cx qo qp qq qr b">multipolygon</code>.</p><p id="fdbc" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">This kind of object is the most complex to reconstruct the geometry for and here is the list of steps we have to do:</p><ul class=""><li id="5d5f" class="nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe pn po pp bk">Select relations with proper <code class="cx qo qp qq qr b">type</code> value.</li><li id="1297" class="nj nk fq nl b go pq nn no gr pr nq nr ns ps nu nv nw pt ny nz oa pu oc od oe pn po pp bk">Unnest all refs related to the relation and keep only way refs — we only need related way refs to reconstruct a polygon.</li><li id="0fae" class="nj nk fq nl b go pq nn no gr pr nq nr ns ps nu nv nw pt ny nz oa pu oc od oe pn po pp bk">Select required ways with linestring geometries — here we can utilize steps from constructing ways.</li><li id="c8f2" class="nj nk fq nl b go pq nn no gr pr nq nr ns ps nu nv nw pt ny nz oa pu oc od oe pn po pp bk">Assign an ‘outer’ role to the way ref if it’s <code class="cx qo qp qq qr b">null</code> and check if any ref from the relation has the role ‘outer’ — if a relation has no ‘outer’ refs then treat all of them as ‘outer’.</li><li id="d842" class="nj nk fq nl b go pq nn no gr pr nq nr ns ps nu nv nw pt ny nz oa pu oc od oe pn po pp bk">Group all linestrings per ‘outer’ and ‘inner’ role and merge them into a single multilinestring — many relations are defined with multiple single linestrings that only together create a closed polygon.</li><li id="b919" class="nj nk fq nl b go pq nn no gr pr nq nr ns ps nu nv nw pt ny nz oa pu oc od oe pn po pp bk">Split multilinestrings into single closed-loop linestrings and save them as polygons.</li><li id="aed3" class="nj nk fq nl b go pq nn no gr pr nq nr ns ps nu nv nw pt ny nz oa pu oc od oe pn po pp bk">Split geometries into ‘outer’ and ‘inner’ polygons. These can be extracted from the <code class="cx qo qp qq qr b">ref_role</code> column of the relation object.</li><li id="0abd" class="nj nk fq nl b go pq nn no gr pr nq nr ns ps nu nv nw pt ny nz oa pu oc od oe pn po pp bk">For each ‘outer’ polygon, select all ‘inner’ polygons that are fully within it and make holes in this polygon.</li><li id="8fb2" class="nj nk fq nl b go pq nn no gr pr nq nr ns ps nu nv nw pt ny nz oa pu oc od oe pn po pp bk">Make a union of all ‘outer’ polygons with holes.</li></ul><p id="c9e3" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">Let’s start with selecting relations with matching tag values.</p><pre class="ms mt mu mv mw sf qr sg bp sh bb bk"><span id="8406" class="si oo fq qr b bg sj sk l sl sm">CREATE TEMP TABLE matching_relations AS <br/>SELECT id, tags<br/>FROM ST_READOSM('monaco-latest.osm.pbf')<br/>WHERE kind = 'relation' AND len(refs) &gt; 0<br/>    AND tags IS NOT NULL AND cardinality(tags) &gt; 0<br/>    AND list_contains(map_keys(tags), 'type')<br/>    AND list_has_any(map_extract(tags, 'type'), ['boundary', 'multipolygon']);<br/><br/>SELECT * FROM matching_relations;<br/><br/>┌──────────┬───────────────────────────────────────────────────────────────────┐<br/>│    id    │                               tags                                │<br/>│  int64   │                       map(varchar, varchar)                       │<br/>├──────────┼───────────────────────────────────────────────────────────────────┤<br/>│     7385 │ {ISO3166-2=FR-06, admin_level=6, alt_name:de=Meeralpen, border_…  │<br/>│     8654 │ {ISO3166-2=FR-PAC, admin_level=4, border_type=region, boundary=…  │<br/>│    36990 │ {ISO3166-1=MC, ISO3166-1:alpha2=MC, ISO3166-1:alpha3=MCO, admin…  │<br/>│   174558 │ {admin_level=8, boundary=administrative, name=Roquebrune-Cap-Ma…  │<br/>│   174562 │ {admin_level=8, boundary=administrative, name=Beausoleil, name:…  │<br/>│   174956 │ {admin_level=8, alt_name:it=Capo d`Aglio, boundary=administrati…  │<br/>│   174958 │ {admin_level=8, boundary=administrative, name=La Turbie, name:i…  │<br/>│   393226 │ {building=castle, castle_type=palace, charge=10€, email=visites…  │<br/>│   393481 │ {building=school, name=Pensionnat des Dames de Saint-Maur, type…  │<br/>│  1124039 │ {ISO3166-1=MC, ISO3166-1:alpha2=MC, ISO3166-1:alpha3=MCO, ISO31…  │<br/>│     ·    │                             ·                                     │<br/>│     ·    │                             ·                                     │<br/>│     ·    │                             ·                                     │<br/>│ 14399505 │ {area=yes, floating=yes, man_made=pier, type=multipolygon}        │<br/>│ 16248281 │ {building=apartments, name=F, type=multipolygon}                  │<br/>│ 16248282 │ {building=apartments, name=E, type=multipolygon}                  │<br/>│ 16248283 │ {building=apartments, name=D, type=multipolygon}                  │<br/>│ 16248284 │ {building=apartments, name=C, type=multipolygon}                  │<br/>│ 16248285 │ {building=apartments, name=B, type=multipolygon}                  │<br/>│ 16248286 │ {building=apartments, name=A, type=multipolygon}                  │<br/>│ 16250182 │ {addr:country=MC, alt_name=Parc de la Roseraie, leisure=park, n…  │<br/>│ 16261416 │ {natural=water, type=multipolygon, water=pond}                    │<br/>│ 16467322 │ {admin_level=2, boundary=land_area, land_area=administrative, n…  │<br/>├──────────┴───────────────────────────────────────────────────────────────────┤<br/>│ 78 rows (20 shown)                                                 2 columns │<br/>└──────────────────────────────────────────────────────────────────────────────┘</span></pre><p id="e3e6" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">Now we will unnest refs lists and split them into individual rows. Like with ways, here we will also utilize DuckDB’s indexing functions to remember the order of elements in the original list. Additionally, we will only keep the <code class="cx qo qp qq qr b">way</code> refs.</p><pre class="ms mt mu mv mw sf qr sg bp sh bb bk"><span id="bdbf" class="si oo fq qr b bg sj sk l sl sm">CREATE TEMP TABLE matching_relations_with_ways_refs AS<br/>WITH unnested_relation_refs AS (<br/>    SELECT<br/>        r.id,<br/>        UNNEST(refs) as ref,<br/>        UNNEST(ref_types) as ref_type,<br/>        UNNEST(ref_roles) as ref_role,<br/>        UNNEST(range(length(refs))) as ref_idx<br/>    FROM ST_READOSM('monaco-latest.osm.pbf') r<br/>    SEMI JOIN matching_relations USING (id)<br/>    WHERE kind = 'relation'<br/>)<br/>SELECT id, ref, ref_role, ref_idx<br/>FROM unnested_relation_refs<br/>WHERE ref_type = 'way';<br/><br/>SELECT * FROM matching_relations_with_ways_refs;<br/><br/>┌──────────┬───────────┬──────────┬─────────┐<br/>│    id    │    ref    │ ref_role │ ref_idx │<br/>│  int64   │   int64   │ varchar  │  int64  │<br/>├──────────┼───────────┼──────────┼─────────┤<br/>│     7385 │  30836152 │ outer    │       2 │<br/>│     7385 │ 889278953 │ outer    │       3 │<br/>│     7385 │ 889278956 │ outer    │       4 │<br/>│     7385 │ 889278957 │ outer    │       5 │<br/>│     7385 │ 889278958 │ outer    │       6 │<br/>│     7385 │ 889278962 │ outer    │       7 │<br/>│     7385 │ 960087656 │ outer    │       8 │<br/>│     7385 │  30836155 │ outer    │       9 │<br/>│     7385 │ 889278965 │ outer    │      10 │<br/>│     7385 │ 889278963 │ outer    │      11 │<br/>│       ·  │      ·    │   ·      │       · │<br/>│       ·  │      ·    │   ·      │       · │<br/>│       ·  │      ·    │   ·      │       · │<br/>│ 11278320 │  35150936 │ outer    │     197 │<br/>│ 11278320 │ 466647567 │ outer    │     198 │<br/>│ 11278320 │ 214008684 │ outer    │     199 │<br/>│ 11278320 │ 466647569 │ outer    │     200 │<br/>│ 11278320 │ 466647568 │ outer    │     201 │<br/>│ 11278320 │ 214008689 │ outer    │     202 │<br/>│ 11278320 │ 263776194 │ outer    │     203 │<br/>│ 11278320 │  31124893 │ outer    │     204 │<br/>│ 11278320 │  31124895 │ outer    │     205 │<br/>│ 11278320 │  31124899 │ outer    │     206 │<br/>├──────────┴───────────┴──────────┴─────────┤<br/>│ ? rows (&gt;9999 rows, 20 shown)   4 columns │<br/>└───────────────────────────────────────────┘</span></pre><p id="1506" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">In the next step, we will construct linestrings for the ways required by the relations. The query below compresses almost full logic of reading ways in one go (getting required nodes, constructing points and grouping them into linestrings):</p><pre class="ms mt mu mv mw sf qr sg bp sh bb bk"><span id="e0d5" class="si oo fq qr b bg sj sk l sl sm">CREATE TEMP TABLE required_ways_linestrings AS<br/>WITH ways_required_by_relations_with_nodes_refs AS (<br/>    SELECT id, UNNEST(refs) as ref, UNNEST(range(length(refs))) as ref_idx<br/>    FROM ST_READOSM('monaco-latest.osm.pbf') ways<br/>    SEMI JOIN matching_relations_with_ways_refs<br/>    ON ways.id = matching_relations_with_ways_refs.ref<br/>    WHERE kind = 'way'<br/>),<br/>nodes_required_by_relations_with_geometries AS (<br/>    SELECT id, ST_POINT(lon, lat) geometry<br/>    FROM ST_READOSM('monaco-latest.osm.pbf') nodes<br/>    SEMI JOIN ways_required_by_relations_with_nodes_refs<br/>    ON nodes.id = ways_required_by_relations_with_nodes_refs.ref<br/>    WHERE kind = 'node'<br/>)<br/>SELECT<br/>    ways.id,<br/>    ST_MakeLine(list(nodes.geometry ORDER BY ref_idx ASC)) linestring<br/>FROM ways_required_by_relations_with_nodes_refs ways<br/>JOIN nodes_required_by_relations_with_geometries nodes<br/>ON ways.ref = nodes.id<br/>GROUP BY 1;<br/><br/>SELECT * FROM required_ways_linestrings;<br/><br/>┌────────────┬─────────────────────────────────────────────────────────────────┐<br/>│     id     │                           linestring                            │<br/>│   int64    │                            geometry                             │<br/>├────────────┼─────────────────────────────────────────────────────────────────┤<br/>│   37794470 │ LINESTRING (7.438411400000001 43.749422300000006, 7.4384056 4…  │<br/>│   87878917 │ LINESTRING (7.418041100000001 43.7256933, 7.4181547 43.725613…  │<br/>│   94252430 │ LINESTRING (7.4141873 43.729494100000004, 7.414203400000001 4…  │<br/>│   94399618 │ LINESTRING (7.4239717 43.740543100000004, 7.4238252 43.740372…  │<br/>│   94399736 │ LINESTRING (7.423881400000001 43.7402971, 7.4239411 43.740265…  │<br/>│  104863462 │ LINESTRING (7.424840000000001 43.731281800000005, 7.424917000…  │<br/>│  120114110 │ LINESTRING (7.420872 43.7370979, 7.4207787 43.7370534, 7.4206…  │<br/>│  156242249 │ LINESTRING (7.4294728 43.739895600000004, 7.429579500000001 4…  │<br/>│  165636038 │ LINESTRING (7.419717100000001 43.732398700000005, 7.419772900…  │<br/>│  169297863 │ LINESTRING (7.422815300000001 43.7321967, 7.4234109 43.732263…  │<br/>│       ·    │                                ·                                │<br/>│       ·    │                                ·                                │<br/>│       ·    │                                ·                                │<br/>│   24874398 │ LINESTRING (7.418523400000001 43.7247599, 7.419012800000001 4…  │<br/>│   92627424 │ LINESTRING (7.4166521 43.7322122, 7.4162303 43.73173910000000…  │<br/>│   94452829 │ LINESTRING (7.4317066 43.7469647, 7.4317998 43.7470371, 7.431…  │<br/>│  335740502 │ LINESTRING (7.4185151 43.7353633, 7.418442000000001 43.735298…  │<br/>│  398377193 │ LINESTRING (7.420872 43.7370979, 7.420939000000001 43.7371298…  │<br/>│  405529436 │ LINESTRING (7.417534900000001 43.7258914, 7.4175347 43.725833…  │<br/>│  423632259 │ LINESTRING (7.4212208 43.7320944, 7.421461300000001 43.732057…  │<br/>│  572935479 │ LINESTRING (7.427508100000001 43.7394168, 7.427496700000001 4…  │<br/>│  586494707 │ LINESTRING (7.4270357 43.739109000000006, 7.4269512 43.739155…  │<br/>│ 1202570715 │ LINESTRING (7.426448400000001 43.739491400000006, 7.4264682 4…  │<br/>├────────────┴─────────────────────────────────────────────────────────────────┤<br/>│ 141 rows (20 shown)                                                2 columns │<br/>└──────────────────────────────────────────────────────────────────────────────┘</span></pre><p id="20d9" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">After creating the required linestrings, now we can join them with relations data. We will also make sure that the required <code class="cx qo qp qq qr b">ref_role</code> is properly parsed — fill in the empty values or replace them if the relation has incorrectly defined <code class="cx qo qp qq qr b">ref_roles</code> in the OSM database.</p><pre class="ms mt mu mv mw sf qr sg bp sh bb bk"><span id="c36d" class="si oo fq qr b bg sj sk l sl sm">CREATE TEMP TABLE matching_relations_with_ways_linestrings AS<br/>WITH unnested_relations_with_way_linestrings AS (<br/>    SELECT<br/>        r.id,<br/>        COALESCE(r.ref_role, 'outer') as ref_role,<br/>        r.ref,<br/>        w.linestring::GEOMETRY as geometry<br/>    FROM matching_relations_with_ways_refs r<br/>    JOIN required_ways_linestrings w<br/>    ON w.id = r.ref<br/>    ORDER BY r.id, r.ref_idx<br/>),<br/>any_outer_refs AS (<br/>    -- check if any way attached to the relation has the `outer` role<br/>    SELECT id, bool_or(ref_role == 'outer') has_any_outer_refs<br/>    FROM unnested_relations_with_way_linestrings<br/>    GROUP BY id<br/>)<br/>SELECT<br/>    unnested_relations_with_way_linestrings.* EXCLUDE (ref_role),<br/>    -- if none of the way refs has `outer` role - treat each ref as `outer`<br/>    CASE WHEN any_outer_refs.has_any_outer_refs<br/>        THEN unnested_relations_with_way_linestrings.ref_role<br/>        ELSE 'outer'<br/>    END as ref_role<br/>FROM unnested_relations_with_way_linestrings<br/>JOIN any_outer_refs<br/>ON any_outer_refs.id = unnested_relations_with_way_linestrings.id;<br/><br/>SELECT * FROM matching_relations_with_ways_linestrings;<br/><br/>┌──────────┬───────────┬────────────────────────────────────────────┬──────────┐<br/>│    id    │    ref    │                  geometry                  │ ref_role │<br/>│  int64   │   int64   │                  geometry                  │ varchar  │<br/>├──────────┼───────────┼────────────────────────────────────────────┼──────────┤<br/>│     7385 │ 772081595 │ LINESTRING (7.415291600000001 43.7234393…  │ outer    │<br/>│     7385 │ 212810311 │ LINESTRING (7.4120416 43.7280955, 7.4123…  │ outer    │<br/>│     7385 │ 176533407 │ LINESTRING (7.412670800000001 43.7316348…  │ outer    │<br/>│     7385 │  37811853 │ LINESTRING (7.4127007 43.7346954, 7.4126…  │ outer    │<br/>│     7385 │  37794471 │ LINESTRING (7.428754700000001 43.7460174…  │ outer    │<br/>│     7385 │ 398372186 │ LINESTRING (7.436885 43.7519173, 7.43677…  │ outer    │<br/>│     7385 │  37794470 │ LINESTRING (7.438411400000001 43.7494223…  │ outer    │<br/>│     7385 │ 770774507 │ LINESTRING (7.439171000000001 43.7490109…  │ outer    │<br/>│     8654 │ 772081595 │ LINESTRING (7.415291600000001 43.7234393…  │ outer    │<br/>│     8654 │ 212810311 │ LINESTRING (7.4120416 43.7280955, 7.4123…  │ outer    │<br/>│       ·  │     ·     │                     ·                      │   ·      │<br/>│       ·  │     ·     │                     ·                      │   ·      │<br/>│       ·  │     ·     │                     ·                      │   ·      │<br/>│ 11546878 │ 840890844 │ LINESTRING (7.420754 43.735872900000004,…  │ outer    │<br/>│ 11546878 │ 840890848 │ LINESTRING (7.4207413 43.7356673, 7.4207…  │ outer    │<br/>│ 16467322 │ 772081595 │ LINESTRING (7.415291600000001 43.7234393…  │ outer    │<br/>│ 16467322 │ 212810311 │ LINESTRING (7.4120416 43.7280955, 7.4123…  │ outer    │<br/>│ 16467322 │ 176533407 │ LINESTRING (7.412670800000001 43.7316348…  │ outer    │<br/>│ 16467322 │  37811853 │ LINESTRING (7.4127007 43.7346954, 7.4126…  │ outer    │<br/>│ 16467322 │  37794471 │ LINESTRING (7.428754700000001 43.7460174…  │ outer    │<br/>│ 16467322 │ 398372186 │ LINESTRING (7.436885 43.7519173, 7.43677…  │ outer    │<br/>│ 16467322 │  37794470 │ LINESTRING (7.438411400000001 43.7494223…  │ outer    │<br/>│ 16467322 │ 770774507 │ LINESTRING (7.439171000000001 43.7490109…  │ outer    │<br/>├──────────┴───────────┴────────────────────────────────────────────┴──────────┤<br/>│ 410 rows (20 shown)                                                4 columns │<br/>└──────────────────────────────────────────────────────────────────────────────┘</span></pre><p id="dcc3" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">As you can see, there are multiple ways with linestrings assigned to each relation. Let’s look at an example to see how they look on the map:</p><figure class="ms mt mu mv mw mj mp mq paragraph-image"><div role="button" tabindex="0" class="mz na ed nb bh nc"><div class="mp mq ss"><img src="../Images/a34fe385da26c62cce2dd5d832df57a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ajRHS7NMlThwmOoSOjpDxA.png"/></div></div><figcaption class="ne nf ng mp mq nh ni bf b bg z dx">A single relation (<a class="af qn" href="https://www.openstreetmap.org/relation/5986437" rel="noopener ugc nofollow" target="_blank">5986437</a>) with colour-coded ways that are part of it. Generated by the author using GeoPandas library.</figcaption></figure><p id="e92e" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">To create full polygons, we have to utilize a <code class="cx qo qp qq qr b">ST_LineMerge</code> function, that will combine a list of linestrings (you can compare it to tying pieces of string together). You can read more about this operation here:</p><div class="qu qv qw qx qy qz"><a href="https://postgis.net/docs/ST_LineMerge.html?source=post_page-----ffeb15197390--------------------------------" rel="noopener  ugc nofollow" target="_blank"><div class="ra ab ig"><div class="rb ab co cb rc rd"><h2 class="bf fr hw z io re iq ir rf it iv fp bk">ST_LineMerge</h2><div class="rg l"><h3 class="bf b hw z io re iq ir rf it iv dx">ST_LineMerge - Return the lines formed by sewing together a MultiLineString.</h3></div><div class="rh l"><p class="bf b dy z io re iq ir rf it iv dx">postgis.net</p></div></div><div class="ri l"><div class="st l rk rl rm ri rn lr qz"/></div></div></a></div><p id="01b2" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">As an additional validation step, we will check if the produced linestrings have at least 4 points and if the first point equals the last point, before converting them into polygons:</p><pre class="ms mt mu mv mw sf qr sg bp sh bb bk"><span id="11a2" class="si oo fq qr b bg sj sk l sl sm">CREATE TEMP TABLE matching_relations_with_merged_polygons AS<br/>WITH merged_linestrings AS (<br/>    SELECT<br/>        id,<br/>        ref_role,<br/>        UNNEST(<br/>            ST_Dump(ST_LineMerge(ST_Collect(list(geometry)))),<br/>            recursive := true<br/>        ),<br/>    FROM matching_relations_with_ways_linestrings<br/>    GROUP BY id, ref_role<br/>),<br/>relations_with_linestrings AS (<br/>    SELECT<br/>        id,<br/>        ref_role,<br/>        -- ST_Dump returns column named `geom`<br/>        geom AS geometry,<br/>        row_number() OVER (PARTITION BY id) as geometry_id<br/>    FROM<br/>        merged_linestrings<br/>    -- discard linestrings with less than 4 points<br/>    WHERE ST_NPoints(geom) &gt;= 4<br/>),<br/>valid_relations AS (<br/>    SELECT id, is_valid<br/>    FROM (<br/>        SELECT<br/>            id,<br/>            bool_and(<br/>                -- Check if start point equals the end point<br/>                ST_Equals(ST_StartPoint(geometry), ST_EndPoint(geometry))<br/>            ) is_valid<br/>        FROM relations_with_linestrings<br/>        GROUP BY id<br/>    )<br/>    WHERE is_valid = true<br/>)<br/>SELECT <br/>    id,<br/>    ref_role,<br/>    ST_MakePolygon(geometry) geometry,<br/>    geometry_id<br/>FROM relations_with_linestrings<br/>SEMI JOIN valid_relations<br/>ON relations_with_linestrings.id = valid_relations.id;<br/><br/>SELECT * FROM matching_relations_with_merged_polygons;<br/><br/>┌──────────┬──────────┬──────────────────────────────────────────┬─────────────┐<br/>│    id    │ ref_role │                 geometry                 │ geometry_id │<br/>│  int64   │ varchar  │                 geometry                 │    int64    │<br/>├──────────┼──────────┼──────────────────────────────────────────┼─────────────┤<br/>│  1369631 │ inner    │ POLYGON ((7.438232200000001 43.7511057…  │           1 │<br/>│  1369631 │ outer    │ POLYGON ((7.438008600000001 43.7502850…  │           2 │<br/>│  1484217 │ outer    │ POLYGON ((7.423010700000001 43.7307028…  │           1 │<br/>│  1484217 │ inner    │ POLYGON ((7.423114600000001 43.7305994…  │           2 │<br/>│  5986436 │ outer    │ POLYGON ((7.428754700000001 43.7460174…  │           1 │<br/>│  8269572 │ outer    │ POLYGON ((7.4287048 43.737701400000006…  │           1 │<br/>│  8269572 │ inner    │ POLYGON ((7.4284492 43.7375604, 7.4286…  │           2 │<br/>│ 16248286 │ outer    │ POLYGON ((7.426306200000001 43.7391565…  │           1 │<br/>│ 16248286 │ inner    │ POLYGON ((7.4263241 43.7390763, 7.4263…  │           2 │<br/>│ 16261416 │ inner    │ POLYGON ((7.417829200000001 43.731382,…  │           1 │<br/>│     ·    │   ·      │                    ·                     │           · │<br/>│     ·    │   ·      │                    ·                     │           · │<br/>│     ·    │   ·      │                    ·                     │           · │<br/>│  8280869 │ inner    │ POLYGON ((7.426753300000001 43.7388868…  │           2 │<br/>│  8280869 │ inner    │ POLYGON ((7.4270357 43.739109000000006…  │           3 │<br/>│  8280869 │ inner    │ POLYGON ((7.4271374 43.739011500000004…  │           4 │<br/>│  8280869 │ inner    │ POLYGON ((7.4272666 43.7389165, 7.4273…  │           5 │<br/>│ 11384697 │ outer    │ POLYGON ((7.427075 43.7315167, 7.42749…  │           1 │<br/>│ 11384697 │ inner    │ POLYGON ((7.426917700000001 43.7313266…  │           2 │<br/>│ 11384697 │ inner    │ POLYGON ((7.427001400000001 43.7313937…  │           3 │<br/>│ 11546878 │ outer    │ POLYGON ((7.4207413 43.7356673, 7.4207…  │           1 │<br/>│ 11538023 │ inner    │ POLYGON ((7.426528200000001 43.7329359…  │           1 │<br/>│ 11538023 │ outer    │ POLYGON ((7.426554 43.7328276, 7.42654…  │           2 │<br/>├──────────┴──────────┴──────────────────────────────────────────┴─────────────┤<br/>│ 88 rows (20 shown)                                                 4 columns │<br/>└──────────────────────────────────────────────────────────────────────────────┘</span></pre><p id="897b" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">Let’s see the previous example after this operation. We should expect two separate polygons to be present:</p><figure class="ms mt mu mv mw mj mp mq paragraph-image"><div role="button" tabindex="0" class="mz na ed nb bh nc"><div class="mp mq su"><img src="../Images/d72c2b5c71b7e6a1349da547f29bb068.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2igly4xbv4tR3XEHIwg8zQ.png"/></div></div><figcaption class="ne nf ng mp mq nh ni bf b bg z dx">A single relation (<a class="af qn" href="https://www.openstreetmap.org/relation/5986437" rel="noopener ugc nofollow" target="_blank">5986437</a>) with merged ways as two separate polygons. Generated by the author using GeoPandas library.</figcaption></figure><p id="6bba" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">I’ve mentioned previously the <code class="cx qo qp qq qr b">outer</code> and <code class="cx qo qp qq qr b">inner</code> ‘ref_types’ of ways that create a relation. Here you can see what it looks like:</p><figure class="ms mt mu mv mw mj mp mq paragraph-image"><div role="button" tabindex="0" class="mz na ed nb bh nc"><div class="mp mq sv"><img src="../Images/4bf65f217dccd5aedeea10bf2b511cde.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E-v_0h0lGtYnHdj9TmsD2A.png"/></div></div><figcaption class="ne nf ng mp mq nh ni bf b bg z dx">A single relation (<a class="af qn" href="https://www.openstreetmap.org/relation/828086" rel="noopener ugc nofollow" target="_blank">8280869</a>) with merged ways grouped into outer and inner polygons. Generated by the author using GeoPandas library.</figcaption></figure><p id="55b2" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">The roles mean that the <code class="cx qo qp qq qr b">inner</code> ways are the ‘holes’ within <code class="cx qo qp qq qr b">outer</code> polygons and we have to reproduce this step to make proper geometries.</p><p id="1d3f" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">Let’s focus now on splitting the polygons into groups with and without holes, using the <code class="cx qo qp qq qr b">ST_Within</code> predicate, which checks if a geometry is fully within another.</p><pre class="ms mt mu mv mw sf qr sg bp sh bb bk"><span id="202f" class="si oo fq qr b bg sj sk l sl sm">CREATE TEMP TABLE matching_relations_with_outer_polygons_with_holes AS<br/>WITH outer_polygons AS (<br/>    SELECT id, geometry_id, geometry<br/>    FROM matching_relations_with_merged_polygons<br/>    WHERE ref_role = 'outer'<br/>), inner_polygons AS (<br/>    SELECT id, geometry_id, geometry<br/>    FROM matching_relations_with_merged_polygons<br/>    WHERE ref_role = 'inner'<br/>)<br/>SELECT<br/>    op.id,<br/>    op.geometry_id,<br/>    ST_Difference(any_value(op.geometry), ST_Union_Agg(ip.geometry)) geometry<br/>FROM outer_polygons op<br/>JOIN inner_polygons ip<br/>ON op.id = ip.id AND ST_WITHIN(ip.geometry, op.geometry)<br/>GROUP BY op.id, op.geometry_id;<br/><br/>CREATE TEMP TABLE matching_relations_with_outer_polygons_without_holes AS<br/>WITH outer_polygons AS (<br/>    SELECT id, geometry_id, geometry<br/>    FROM matching_relations_with_merged_polygons<br/>    WHERE ref_role = 'outer'<br/>)<br/>SELECT<br/>    op.id,<br/>    op.geometry_id,<br/>    op.geometry<br/>FROM outer_polygons op<br/>ANTI JOIN matching_relations_with_outer_polygons_with_holes opwh<br/>ON op.id = opwh.id AND op.geometry_id = opwh.geometry_id;<br/><br/>SELECT * FROM matching_relations_with_outer_polygons_with_holes<br/>UNION ALL<br/>SELECT * FROM matching_relations_with_outer_polygons_without_holes;<br/><br/>┌──────────┬─────────────┬─────────────────────────────────────────────────────┐<br/>│    id    │ geometry_id │                      geometry                       │<br/>│  int64   │    int64    │                      geometry                       │<br/>├──────────┼─────────────┼─────────────────────────────────────────────────────┤<br/>│ 16248286 │           1 │ POLYGON ((7.4263139 43.7391602, 7.426324900000001…  │<br/>│  1369192 │           1 │ POLYGON ((7.4226247 43.7402251, 7.4227848 43.7396…  │<br/>│  8147763 │           1 │ POLYGON ((7.438223000000001 43.7477296, 7.4382403…  │<br/>│   393226 │           1 │ POLYGON ((7.4204802 43.731016700000005, 7.4203979…  │<br/>│ 11484092 │           4 │ POLYGON ((7.417896900000001 43.724827000000005, 7…  │<br/>│ 11384697 │           1 │ POLYGON ((7.4274934 43.731250700000004, 7.4267196…  │<br/>│  8269572 │           1 │ POLYGON ((7.4287166 43.7376724, 7.4287948 43.7376…  │<br/>│ 16261416 │           3 │ POLYGON ((7.4178309 43.731391, 7.417877000000001 …  │<br/>│ 16248284 │           1 │ POLYGON ((7.426637500000001 43.7394678, 7.4266485…  │<br/>│ 16248285 │           1 │ POLYGON ((7.426114600000001 43.739267600000005, 7…  │<br/>│     ·    │           · │                          ·                          │<br/>│     ·    │           · │                          ·                          │<br/>│     ·    │           · │                          ·                          │<br/>│ 11546879 │           1 │ POLYGON ((7.4209316 43.7356234, 7.421037 43.73562…  │<br/>│  2220206 │           1 │ POLYGON ((7.4120416 43.7280955, 7.412103900000001…  │<br/>│  5986438 │           1 │ POLYGON ((7.4191482 43.738887500000004, 7.4199833…  │<br/>│  2221178 │           1 │ POLYGON ((7.415860400000001 43.7313885, 7.416195 …  │<br/>│  2221179 │           1 │ POLYGON ((7.422280000000001 43.7367186, 7.4227584…  │<br/>│  2220208 │           1 │ POLYGON ((7.41849 43.730922400000004, 7.4185156 4…  │<br/>│  2254506 │           1 │ POLYGON ((7.432995900000001 43.7447102, 7.4329125…  │<br/>│  5986437 │           1 │ POLYGON ((7.4307593 43.745595, 7.4306621 43.74541…  │<br/>│  5986437 │           2 │ POLYGON ((7.4343358 43.7457085, 7.4341337 43.7455…  │<br/>│ 11546878 │           1 │ POLYGON ((7.4207413 43.7356673, 7.4207413 43.7357…  │<br/>├──────────┴─────────────┴─────────────────────────────────────────────────────┤<br/>│ 47 rows (20 shown)                                                 3 columns │<br/>└──────────────────────────────────────────────────────────────────────────────┘</span></pre><p id="1efd" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">In this query, there is utilized another special join — <code class="cx qo qp qq qr b">ANTI JOIN</code>. This one filters out all the rows on the left-side table that are joined by the right-side table.</p><p id="1696" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">The last step that is needed is to merge all the polygons for a single relation using the <code class="cx qo qp qq qr b">ST_Union_Agg</code> operation. It will combine all polygons into multipolygons (if there is more than one) and produce a single geometry.</p><pre class="ms mt mu mv mw sf qr sg bp sh bb bk"><span id="656d" class="si oo fq qr b bg sj sk l sl sm">WITH unioned_outer_geometries AS (<br/>    SELECT id, geometry<br/>    FROM matching_relations_with_outer_polygons_with_holes<br/>    UNION ALL<br/>    SELECT id, geometry<br/>    FROM matching_relations_with_outer_polygons_without_holes<br/>),<br/>final_geometries AS (<br/>    SELECT id, ST_Union_Agg(geometry) geometry<br/>    FROM unioned_outer_geometries<br/>    GROUP BY id<br/>)<br/>SELECT r_g.id, r.tags, r_g.geometry<br/>FROM final_geometries r_g<br/>JOIN matching_relations r<br/>ON r.id = r_g.id;<br/><br/>┌──────────┬──────────────────────┬────────────────────────────────────────────┐<br/>│    id    │         tags         │                  geometry                  │<br/>│  int64   │ map(varchar, varch…  │                  geometry                  │<br/>├──────────┼──────────────────────┼────────────────────────────────────────────┤<br/>│   393226 │ {building=castle, …  │ POLYGON ((7.4204802 43.731016700000005, …  │<br/>│   393481 │ {building=school, …  │ POLYGON ((7.423992800000001 43.731841800…  │<br/>│  1369191 │ {building=apartmen…  │ POLYGON ((7.4231004 43.7412894, 7.423314…  │<br/>│  1369192 │ {building=apartmen…  │ POLYGON ((7.4226247 43.7402251, 7.422784…  │<br/>│  1369193 │ {building=apartmen…  │ POLYGON ((7.424 43.7405491, 7.4240401 43…  │<br/>│  1369195 │ {building=apartmen…  │ POLYGON ((7.418679900000001 43.738187100…  │<br/>│  1369631 │ {addr:housenumber=…  │ POLYGON ((7.4379729 43.7502505, 7.437937…  │<br/>│  1369632 │ {addr:city=Monaco,…  │ POLYGON ((7.4317121 43.74709, 7.4318277 …  │<br/>│  1484190 │ {addr:city=Monaco,…  │ POLYGON ((7.425469 43.731494000000005, 7…  │<br/>│  1484217 │ {building=retail, …  │ POLYGON ((7.423202300000001 43.7307117, …  │<br/>│     ·    │          ·           │                     ·                      │<br/>│     ·    │          ·           │                     ·                      │<br/>│     ·    │          ·           │                     ·                      │<br/>│ 14399505 │ {area=yes, floatin…  │ POLYGON ((7.4195986 43.7265293, 7.419595…  │<br/>│ 16248281 │ {building=apartmen…  │ POLYGON ((7.4260438 43.739789800000004, …  │<br/>│ 16248282 │ {building=apartmen…  │ POLYGON ((7.426243100000001 43.7396824, …  │<br/>│ 16248283 │ {building=apartmen…  │ POLYGON ((7.426438200000001 43.739575200…  │<br/>│ 16248284 │ {building=apartmen…  │ POLYGON ((7.426637500000001 43.7394678, …  │<br/>│ 16248285 │ {building=apartmen…  │ POLYGON ((7.426114600000001 43.739267600…  │<br/>│ 16248286 │ {building=apartmen…  │ POLYGON ((7.4263139 43.7391602, 7.426324…  │<br/>│ 16250182 │ {addr:country=MC, …  │ POLYGON ((7.418348300000001 43.7256979, …  │<br/>│ 16261416 │ {natural=water, ty…  │ POLYGON ((7.4178309 43.731391, 7.4178770…  │<br/>│ 11546878 │ {addr:city=Monaco,…  │ POLYGON ((7.4207413 43.7356673, 7.420741…  │<br/>├──────────┴──────────────────────┴────────────────────────────────────────────┤<br/>│ 46 rows (20 shown)                                                 3 columns │<br/>└──────────────────────────────────────────────────────────────────────────────┘</span></pre><p id="23b6" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">Here is the previous relation example, now with holes:</p><figure class="ms mt mu mv mw mj mp mq paragraph-image"><div role="button" tabindex="0" class="mz na ed nb bh nc"><div class="mp mq sw"><img src="../Images/217a6f093c325a233d93a5d152a284d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0GCxyrEb02fCNe7-XzITkw.png"/></div></div><figcaption class="ne nf ng mp mq nh ni bf b bg z dx">A single relation (<a class="af qn" href="https://www.openstreetmap.org/relation/828086" rel="noopener ugc nofollow" target="_blank">8280869</a>) — a polygon with holes. Generated by the author using GeoPandas library.</figcaption></figure></div></div><div class="mj"><div class="ab cb"><div class="lm mk ln ml lo mm cf mn cg mo ci bh"><figure class="ms mt mu mv mw mj mx my paragraph-image"><div role="button" tabindex="0" class="mz na ed nb bh nc"><div class="mp mq sx"><img src="../Images/206d0d2c26863920fd791636813f0d85.png" data-original-src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*rh6F3fRMS4cTIFuCkeyfeQ.png"/></div></div><figcaption class="ne nf ng mp mq nh ni bf b bg z dx">Relations geometries plotted on a map. Generated by the author using GeoPandas library.</figcaption></figure></div></div></div><div class="ab cb"><div class="ci bh ev ew ex ey"><h1 id="531f" class="pv oo fq bf op pw px gq ot py pz gt ox qa qb qc qd qe qf qg qh qi qj qk ql qm bk">Examples of badly defined relation objects</h1><p id="ba55" class="pw-post-body-paragraph nj nk fq nl b go pi nn no gr pj nq nr ns pk nu nv nw pl ny nz oa pm oc od oe fj bk">As OpenStreetMap data is mainly added by the community, there are examples where geometries are not properly defined. The OSM wiki describes rules for map makers on how to add geometries to a map.</p><div class="qu qv qw qx qy qz"><a href="https://wiki.openstreetmap.org/wiki/Relation:multipolygon/validity?source=post_page-----ffeb15197390--------------------------------" rel="noopener  ugc nofollow" target="_blank"><div class="ra ab ig"><div class="rb ab co cb rc rd"><h2 class="bf fr hw z io re iq ir rf it iv fp bk">Relation:multipolygon/validity</h2><div class="rg l"><h3 class="bf b hw z io re iq ir rf it iv dx">This page is only a proposition, it doesn't represent a consenus of what is or isn't valid, but only what could and…</h3></div><div class="rh l"><p class="bf b dy z io re iq ir rf it iv dx">wiki.openstreetmap.org</p></div></div><div class="ri l"><div class="sy l rk rl rm ri rn lr qz"/></div></div></a></div><p id="de3d" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">This section will outline some common mistakes with examples.</p><h2 id="bd6e" class="on oo fq bf op oq or os ot ou ov ow ox ns oy oz pa nw pb pc pd oa pe pf pg ph bk">Two overlapping ‘outer’ ways in the relation</h2><p id="69bd" class="pw-post-body-paragraph nj nk fq nl b go pi nn no gr pj nq nr ns pk nu nv nw pl ny nz oa pm oc od oe fj bk">This building is defined by two shapes: a rectangle and almost a circle. Since these two overlap, you can see how the rendering engine created a gap where there probably shouldn’t be any.</p><figure class="ms mt mu mv mw mj mp mq paragraph-image"><div role="button" tabindex="0" class="mz na ed nb bh nc"><div class="mp mq sz"><img src="../Images/671b8dd3fbcd20c09c06f10a11affd08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C8S3pRWnVT1KoMFNAROmsA.png"/></div></div><figcaption class="ne nf ng mp mq nh ni bf b bg z dx">Screenshot from the OpenStreetMap by the author.</figcaption></figure><h2 id="129b" class="on oo fq bf op oq or os ot ou ov ow ox ns oy oz pa nw pb pc pd oa pe pf pg ph bk">No ‘outer’ way in the relation</h2><p id="685f" class="pw-post-body-paragraph nj nk fq nl b go pi nn no gr pj nq nr ns pk nu nv nw pl ny nz oa pm oc od oe fj bk">Here you can see a paintball field with <code class="cx qo qp qq qr b">way</code> members defined as ‘Main Building’ and 4 ‘Arenas’. These should be all defined as <code class="cx qo qp qq qr b">outer</code> ways.</p><figure class="ms mt mu mv mw mj mp mq paragraph-image"><div role="button" tabindex="0" class="mz na ed nb bh nc"><div class="mp mq sp"><img src="../Images/927a31510d513e7214b9c5a477933ade.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pLh2_LXWp1vY2j1ayM0vTQ.png"/></div></div><figcaption class="ne nf ng mp mq nh ni bf b bg z dx">Screenshot from the OpenStreetMap by the author.</figcaption></figure><h2 id="2cfb" class="on oo fq bf op oq or os ot ou ov ow ox ns oy oz pa nw pb pc pd oa pe pf pg ph bk">Two overlapping or touching ‘inner’ ways</h2><figure class="ms mt mu mv mw mj mp mq paragraph-image"><div role="button" tabindex="0" class="mz na ed nb bh nc"><div class="mp mq ta"><img src="../Images/2dd6cb3b3ac6ea1ed1b73d63d44823ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gCx3oz0URM_yzGS2YyqF6g.png"/></div></div><figcaption class="ne nf ng mp mq nh ni bf b bg z dx">Screenshot from the OpenStreetMap by the author.</figcaption></figure><p id="e853" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">If you are interested in reading more about how these can be fixed, look into this repository:</p><div class="qu qv qw qx qy qz"><a href="https://github.com/osmlab/fixing-polygons-in-osm/blob/master/doc/background.md?source=post_page-----ffeb15197390--------------------------------" rel="noopener  ugc nofollow" target="_blank"><div class="ra ab ig"><div class="rb ab co cb rc rd"><h2 class="bf fr hw z io re iq ir rf it iv fp bk">fixing-polygons-in-osm/doc/background.md at master · osmlab/fixing-polygons-in-osm</h2><div class="rg l"><h3 class="bf b hw z io re iq ir rf it iv dx">Fixing (multi)polygons in OpenStreetMap. Contribute to osmlab/fixing-polygons-in-osm development by creating an account…</h3></div><div class="rh l"><p class="bf b dy z io re iq ir rf it iv dx">github.com</p></div></div><div class="ri l"><div class="tb l rk rl rm ri rn lr qz"/></div></div></a></div><h1 id="0251" class="pv oo fq bf op pw px gq ot py pz gt ox qa qb qc qd qe qf qg qh qi qj qk ql qm bk">QuackOSM — a hassle-free tool for reading OSM data</h1><p id="85e1" class="pw-post-body-paragraph nj nk fq nl b go pi nn no gr pj nq nr ns pk nu nv nw pl ny nz oa pm oc od oe fj bk">To end this article I want to highlight a library that can automatically download the OSM data, filter it by the geometry or using OSM tags and save it as a GeoParquet file that can be easily integrated into more scalable solutions. The library is written in Python and is open-source.</p><p id="3bf8" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">You can install it with a single command: <code class="cx qo qp qq qr b">pip install quackosm[cli]</code>.</p><p id="e6d0" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">This tutorial contains a simplified version of the queries used in the QuackOSM 🦆, but these won’t scale very well for the bigger regions. The library can easily parse whole countries such as France on a consumer-grade PC if you need to. You can of course utilize the DuckDB engine later on the prepared GeoParquet file using <code class="cx qo qp qq qr b">SPATIAL</code> extension.</p><p id="92ee" class="pw-post-body-paragraph nj nk fq nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">All of the steps defined here can be replaced with a single line of code:</p><pre class="ms mt mu mv mw sf qr sg bp sh bb bk"><span id="468a" class="si oo fq qr b bg sj sk l sl sm">&gt;&gt;&gt; import quackosm as qosm<br/>&gt;&gt;&gt; qosm.get_features_gdf('monaco-latest.osm.pbf')<br/>                                                              tags                                           geometry<br/>feature_id                                                                                                           <br/>way/834616137                               {'highway': 'footway'}  LINESTRING (7.42133 43.72711, 7.42134 43.72710...<br/>way/408817108    {'addr:country': 'MC', 'building': 'yes', 'nam...  POLYGON ((7.43533 43.74965, 7.43534 43.74955, ...<br/>way/686435440                               {'highway': 'footway'}  LINESTRING (7.41381 43.73258, 7.41388 43.73266...<br/>node/7799514898              {'name': 'Cino Bar', 'shop': 'kiosk'}                           POINT (7.42702 43.73118)<br/>way/143214794                                  {'building': 'yes'}  POLYGON ((7.42788 43.74437, 7.42786 43.74437, ...<br/>...                                                            ...                                                ...<br/>way/161882794    {'highway': 'secondary', 'lanes': '2', 'lit': ...  LINESTRING (7.42142 43.73656, 7.42147 43.73662...<br/>way/1082330089             {'highway': 'steps', 'incline': 'down'}  LINESTRING (7.42438 43.72990, 7.42440 43.72988...<br/>way/834313093    {'highway': 'service', 'smoothness': 'intermed...  LINESTRING (7.42709 43.73256, 7.42708 43.73262...<br/>way/94399451             {'addr:country': 'MC', 'building': 'yes'}  POLYGON ((7.41678 43.73699, 7.41661 43.73689, ...<br/>node/2462515787  {'crossing': 'uncontrolled', 'highway': 'cross...                           POINT (7.41656 43.73208)<br/><br/>[7940 rows x 2 columns]<br/>&gt;&gt;&gt; qosm.convert_pbf_to_gpq('monaco-latest.osm.pbf')<br/>PosixPath('files/monaco-latest_nofilter_noclip_compact.geoparquet')</span></pre><div class="qu qv qw qx qy qz"><a href="https://github.com/kraina-ai/quackosm?source=post_page-----ffeb15197390--------------------------------" rel="noopener  ugc nofollow" target="_blank"><div class="ra ab ig"><div class="rb ab co cb rc rd"><h2 class="bf fr hw z io re iq ir rf it iv fp bk">GitHub - kraina-ai/quackosm: QuackOSM: an open-source Python and CLI tool for reading OpenStreetMap…</h2><div class="rg l"><h3 class="bf b hw z io re iq ir rf it iv dx">QuackOSM: an open-source Python and CLI tool for reading OpenStreetMap PBF files using DuckDB - kraina-ai/quackosm</h3></div><div class="rh l"><p class="bf b dy z io re iq ir rf it iv dx">github.com</p></div></div><div class="ri l"><div class="tc l rk rl rm ri rn lr qz"/></div></div></a></div><h2 id="06e3" class="on oo fq bf op oq or os ot ou ov ow ox ns oy oz pa nw pb pc pd oa pe pf pg ph bk">Disclaimer</h2><p id="687f" class="pw-post-body-paragraph nj nk fq nl b go pi nn no gr pj nq nr ns pk nu nv nw pl ny nz oa pm oc od oe fj bk">I’m the author of the <code class="cx qo qp qq qr b">QuackOSM</code> library.</p></div></div></div><div class="ab cb td te tf tg" role="separator"><span class="th by bm ti tj tk"/><span class="th by bm ti tj tk"/><span class="th by bm ti tj"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><blockquote class="ro rp rq"><p id="a0a6" class="nj nk rr nl b go nm nn no gr np nq nr ns nt nu nv nw nx ny nz oa ob oc od oe fj bk">You can reach me here:<br/><a class="af qn" href="https://www.linkedin.com/in/raczyckikamil/" rel="noopener ugc nofollow" target="_blank">https://www.linkedin.com/in/raczyckikamil/</a><br/><a class="af qn" href="https://github.com/raczeq" rel="noopener ugc nofollow" target="_blank">https://github.com/raczeq</a></p></blockquote></div></div></div></div>    
</body>
</html>