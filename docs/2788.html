<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Data Validation with Pandera in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Data Validation with Pandera in Python</h1>
<blockquote>ÂéüÊñáÔºö<a href="https://towardsdatascience.com/data-validation-with-pandera-in-python-f07b0f845040?source=collection_archive---------0-----------------------#2024-11-18">https://towardsdatascience.com/data-validation-with-pandera-in-python-f07b0f845040?source=collection_archive---------0-----------------------#2024-11-18</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="9b1e" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx">Validating your Dataframes for Production ML Pipelines</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hd he hf hg hh ab"><div><div class="ab hi"><div><div class="bm" aria-hidden="false"><a href="https://gabrielfurnieles.medium.com/?source=post_page---byline--f07b0f845040--------------------------------" rel="noopener follow"><div class="l hj hk by hl hm"><div class="l ed"><img alt="Gabriel Furnieles" class="l ep by dd de cx" src="../Images/710c939d8114ea8a4db16fd9f2c71f8a.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/1*Gd1MZ62WPsDmi4tWWQvSYA.jpeg"/><div class="hn by l dd de em n ho eo"/></div></div></a></div></div><div class="hp ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--f07b0f845040--------------------------------" rel="noopener follow"><div class="l hq hr by hl hs"><div class="l ed"><img alt="Towards Data Science" class="l ep by br ht cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hn by l br ht em n ho eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hu ab q"><div class="ab q hv"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hw hx bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hy" data-testid="authorName" href="https://gabrielfurnieles.medium.com/?source=post_page---byline--f07b0f845040--------------------------------" rel="noopener follow">Gabriel Furnieles</a></p></div></div></div><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">¬∑</span></span><p class="bf b hw hx dx"><button class="ib ic ah ai aj ak al am an ao ap aq ar id ie if" disabled="">Follow</button></p></div></div></span></div></div><div class="l ig"><span class="bf b bg z dx"><div class="ab cn ih ii ij"><div class="ik il ab"><div class="bf b bg z dx ab im"><span class="in l ig">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hy ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--f07b0f845040--------------------------------" rel="noopener follow"><p class="bf b bg z io ip iq ir is it iu iv bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">¬∑</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">9 min read</span><div class="iw ix l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">¬∑</span></span></div><span data-testid="storyPublishDate">Nov 18, 2024</span></div></span></div></span></div></div></div><div class="ab cp iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn"><div class="h k w ea eb q"><div class="kd l"><div class="ab q ke kf"><div class="pw-multi-vote-icon ed in kg kh ki"><div class=""><div class="kj kk kl km kn ko kp am kq kr ks ki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kt ku kv kw kx ky kz"><p class="bf b dy z dx"><span class="kk">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kj la lb ab q ee lc ld" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="le"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg></button></div></div></div><div class="ab q jo jp jq jr js jt ju jv jw jx jy jz ka kb kc"><div class="lf k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lg an ao ap id lh li lj" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep lk cn"><div class="l ae"><div class="ab cb"><div class="ll lm ln lo lp lq ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lg an ao ap id lr ls ld lt lu lv lw lx s ly lz ma mb mc md me u mf mg mh"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lg an ao ap id lr ls ld lt lu lv lw lx s ly lz ma mb mc md me u mf mg mh"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lg an ao ap id lr ls ld lt lu lv lw lx s ly lz ma mb mc md me u mf mg mh"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj mk"><img src="../Images/53c2470e3fd017ad184018a7824bc84c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fnEG1guS0sYHTxc4guHNag.jpeg"/></div></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">Image generated with <a class="af nb" href="https://creator.nightcafe.studio/" rel="noopener ugc nofollow" target="_blank">NightCafe</a>.</figcaption></figure><p id="af5b" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Data validation is a crucial step for production applications. You need to ensure the data you are ingesting is compatible with your pipeline and that unexpected values aren‚Äôt present. Moreover, validating the data is a security measure that prevents any corrupted or inaccurate information from being further processed, raising a flag on the first steps.</p><p id="5629" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Python already counts with a great OS project for this task called <a class="af nb" href="https://docs.pydantic.dev/latest/" rel="noopener ugc nofollow" target="_blank">Pydantic</a>. However, when dealing with large dataframe-like objects such as in Machine Learning, <a class="af nb" href="https://pandera.readthedocs.io/en/stable/index.html" rel="noopener ugc nofollow" target="_blank">Pandera</a> is a much faster and scalable way of validating data (check <a class="af nb" href="https://www.union.ai/blog-post/pandera-0-17-adds-support-for-pydantic-v2" rel="noopener ugc nofollow" target="_blank">this article</a> with public notebooks).</p><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div class="mi mj ny"><img src="../Images/eb2c0f75b2f743dedaa7a6fe7b1a33b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1388/format:webp/0*JHg4ZVNkQ-WYyQRH.png"/></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">Performance comparison between pandera and row-wise validation with Pydantic for different-sized pandas.DataFrame objects. Image from <a class="af nb" href="https://www.union.ai/blog-post/pandera-0-17-adds-support-for-pydantic-v2#:~:text=%22records%22))-,Benchmarking%20Pandera%E2%80%99s%20row%2Dwise%20validation%20with%20Pydantic,-Because%20Pandera%20validates" rel="noopener ugc nofollow" target="_blank">source</a>.</figcaption></figure><p id="ac5c" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">In addition, Pandera offers support for a great variety of dataframe libraries like <code class="cx nz oa ob oc b">pandas</code>, <code class="cx nz oa ob oc b">polars</code>, <code class="cx nz oa ob oc b">dask</code>, <code class="cx nz oa ob oc b">modin</code>, and <code class="cx nz oa ob oc b">pyspark.pandas</code>. For more information on these refer to <a class="af nb" href="https://pandera.readthedocs.io/en/stable/index.html" rel="noopener ugc nofollow" target="_blank">Pandera‚Äôs docsüìÑ</a>.</p><blockquote class="od oe of"><p id="fea0" class="nc nd og ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk"><strong class="ne fr">Disclaimer.</strong> Pandera is an open-source project licensed under the MIT License. I have no affiliation with the Pandera team or Union.ai. This post has no commercial interest.</p></blockquote><h1 id="f2ac" class="oh oi fq bf oj ok ol gq om on oo gt op oq or os ot ou ov ow ox oy oz pa pb pc bk">Validating data with Pandera</h1><p id="49c2" class="pw-post-body-paragraph nc nd fq ne b go pd ng nh gr pe nj nk nl pf nn no np pg nr ns nt ph nv nw nx fj bk">Pandera has two ways of defining validators: <strong class="ne fr">Schemas</strong> and <strong class="ne fr">Models</strong>. I will focus on the second one because of its similarity with Pydantic models and the cleanness of the code.</p><p id="3580" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">To define a Pandera model create a child class that inherits from DataframeModel and start declaring the columns and dtypes that the dataframe must have:</p><pre class="ml mm mn mo mp pi oc pj bp pk bb bk"><span id="087d" class="pl oi fq oc b bg pm pn l po pp">import pandera as pa<br/><br/><br/>class UserModel(pa.DataFrameModel):<br/>    id: int<br/>    username: str<br/>    email: str<br/>    is_active: bool<br/>    membership: str<br/>    creation_date: pd.DatetimeTZDtype</span></pre><pre class="pq pi oc pj bp pk bb bk"><span id="f618" class="pl oi fq oc b bg pm pn l po pp"># Use<br/>df = pd.DataFrame(...)<br/>UserModel.validate(df) # &lt;- If invalidad raises SchemaError</span></pre><p id="6070" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Note that to define the user‚Äôs creation timestamp I used Pandas native date type instead of others like <code class="cx nz oa ob oc b">datetime.datetime</code>. Pandera only supports built-in Python, NumPy, and Pandas data types. You can also create <a class="af nb" href="https://pandera.readthedocs.io/en/stable/dtypes.html#logical-data-types" rel="noopener ugc nofollow" target="_blank">custom data types</a>, but this is an advanced topic and rarely necessary in most cases.</p><h2 id="1a4c" class="pr oi fq bf oj ps pt pu om pv pw px op nl py pz qa np qb qc qd nt qe qf qg qh bk">Validating column properties</h2><p id="15d7" class="pw-post-body-paragraph nc nd fq ne b go pd ng nh gr pe nj nk nl pf nn no np pg nr ns nt ph nv nw nx fj bk">With Pandera, you can also validate other column properties in addition to the type of data:</p><pre class="ml mm mn mo mp pi oc pj bp pk bb bk"><span id="26d5" class="pl oi fq oc b bg pm pn l po pp">class UserModel(pa.DataFrameModel):<br/>    id: int  = pa.Field(unique=True, ge=0)<br/>    username: str = pa.Field(str_matches=r"^[a-zA-Z0-9_]+$")<br/>    email: str = pa.Field(str_matches=r"^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+$")<br/>    is_active: bool<br/>    membership: str = pa.Field(isin=["premium", "free"])<br/>    creation_date: pd.DatetimeTZDtype = pa.Field(dtype_kwargs={"unit": "ns", "tz": "UTC"})</span></pre><p id="0dc1" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Here I am using pandera‚Äôs Field just like pydantics‚Äô.</p><ul class=""><li id="9f0a" class="nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx qi qj qk bk">First, I am specifying that the <code class="cx nz oa ob oc b">id</code> column must not contain duplicated values and these have to be greater or equal to 0.</li><li id="bc76" class="nc nd fq ne b go ql ng nh gr qm nj nk nl qn nn no np qo nr ns nt qp nv nw nx qi qj qk bk">In <code class="cx nz oa ob oc b">username</code> and <code class="cx nz oa ob oc b">email</code> I‚Äôm checking using regex expressions if strings are valid. User names must only contain alphanumeric characters and underscore, while emails can also contain dashes and dots but always follow the pattern ‚Äúsmth@smth.smth‚Äù.</li><li id="02b5" class="nc nd fq ne b go ql ng nh gr qm nj nk nl qn nn no np qo nr ns nt qp nv nw nx qi qj qk bk"><code class="cx nz oa ob oc b">membership</code> can only take a value from the list. A better approach is using a StrEnum to define the valid values instead of hardcoding them.</li><li id="c07c" class="nc nd fq ne b go ql ng nh gr qm nj nk nl qn nn no np qo nr ns nt qp nv nw nx qi qj qk bk">Finally, <code class="cx nz oa ob oc b">creation_date</code> must be in nanosecond units and UTC timezone. This line can be cleaner using Annotated from typing library <code class="cx nz oa ob oc b">creation_date: Annotated[pd.DatetimeTZDtype, "ns", "UTC"]</code></li></ul><p id="2b79" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Check out <a class="af nb" href="https://pandera.readthedocs.io/en/stable/reference/generated/pandera.api.dataframe.model_components.Field.html#pandera.api.dataframe.model_components.Field" rel="noopener ugc nofollow" target="_blank">the docs</a> to read all Field optionsüòã</p><h2 id="9bd9" class="pr oi fq bf oj ps pt pu om pv pw px op nl py pz qa np qb qc qd nt qe qf qg qh bk">Custom Validations</h2><p id="f217" class="pw-post-body-paragraph nc nd fq ne b go pd ng nh gr pe nj nk nl pf nn no np pg nr ns nt ph nv nw nx fj bk">Sometimes it is necessary to add your own custom validations. Pandera allows you to inject <a class="af nb" href="https://pandera.readthedocs.io/en/stable/dataframe_models.html#dataframe-checks:~:text=as%20class%20methods.-,Column/Index%20checks,-%C2%B6" rel="noopener ugc nofollow" target="_blank">column/index checks</a> (custom checks of single columns) and <a class="af nb" href="https://pandera.readthedocs.io/en/stable/dataframe_models.html#dataframe-checks:~:text=1%3A%20%3CCheck%20check_means%3E-,DataFrame%20Checks,-%C2%B6" rel="noopener ugc nofollow" target="_blank">dataframe checks</a> (checks between several columns).</p><pre class="ml mm mn mo mp pi oc pj bp pk bb bk"><span id="fffa" class="pl oi fq oc b bg pm pn l po pp">import pandera as pa<br/>from pandera.typing import Series<br/><br/><br/>class UserModel(pa.DataFrameModel):<br/>    id: int = pa.Field(unique=True, ge=0)<br/>    username: str = pa.Field(str_matches=r"^[a-zA-Z0-9_]+$")<br/>    email: str = pa.Field(<br/>        str_matches=r"^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+$"<br/>    )<br/>    is_active: bool<br/>    membership: str = pa.Field(isin=["premium", "free"])<br/>    creation_date: Annotated[pd.DatetimeTZDtype, "ns", "UTC"]<br/><br/>    # column/index checks<br/>    @pa.check("username", name="username_length")<br/>    def username_length(cls, x: Series[str]) -&gt; Series[bool]:<br/>        """<br/>        Check username length is between 1 and 20 characters<br/>        """<br/>        return x.str.len().between(1, 20)<br/><br/>    @pa.check("creation_date", name="min_creation_date")<br/>    def min_creation_date(cls, x: Series[pd.DatetimeTZDtype]) -&gt; Series[bool]:<br/>        """<br/>        Check creation date is after 2000-01-01<br/>        """<br/>        return x &gt;= dt.datetime(2000, 1, 1, tzinfo=dt.timezone.utc)<br/>    <br/>    # dataframe check<br/>    @pa.dataframe_check<br/>    def membership_is_valid(<br/>        cls, df: pd.DataFrame, name="membership_is_valid"<br/>    ) -&gt; Series[bool]:<br/>        """<br/>        Check account age for free memebers is &lt;= 30 days<br/>        """<br/>        current_time = dt.datetime.now(dt.timezone.utc)<br/>        thirty_days = dt.timedelta(days=30)<br/><br/>        return (df["membership"] == "premium") | (<br/>            (df["membership"] == "free")<br/>            &amp; ((current_time - df["creation_date"]) &lt;= thirty_days)<br/>        )</span></pre><p id="77a4" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Keep in mind that you are working with entire column objects (<code class="cx nz oa ob oc b">Series</code>) so that operations in checks should be vectorized for better performance.</p><h2 id="166b" class="pr oi fq bf oj ps pt pu om pv pw px op nl py pz qa np qb qc qd nt qe qf qg qh bk">Other Configurations</h2><p id="9473" class="pw-post-body-paragraph nc nd fq ne b go pd ng nh gr pe nj nk nl pf nn no np pg nr ns nt ph nv nw nx fj bk"><strong class="ne fr">Aliases<br/></strong>When column names can‚Äôt be declared as Python variables due to the language syntax, Pandera allows setting an alias for the column validator to match the dataframe.</p><pre class="ml mm mn mo mp pi oc pj bp pk bb bk"><span id="ed3a" class="pl oi fq oc b bg pm pn l po pp">class MyModel(pa.DataFrameModel):<br/>    alias_column: int = pa.Field(..., alias="Alias Column")<br/>    ...</span></pre><p id="4dd7" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk"><strong class="ne fr">Strict and Coerce<br/></strong>When the <code class="cx nz oa ob oc b">strict</code> option is set to true, it forces the validated dataframe to only contain the columns defined in the Pandera DataFrameModel. On the other hand, when the <code class="cx nz oa ob oc b">coerce</code> option is activated, Pandera will try to cast the column data to match the model‚Äôs dtype.</p><pre class="ml mm mn mo mp pi oc pj bp pk bb bk"><span id="8897" class="pl oi fq oc b bg pm pn l po pp">class MyModel(pa.DataFrameModel):<br/>    ...<br/>    <br/>    class Config:<br/>        strict = True # defaul: False<br/>        coerce = True # default: False</span></pre><p id="f532" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">The coerce option can be set at the Field level too using <code class="cx nz oa ob oc b">pa.Field(..., coerce=True)</code></p><p id="f0ac" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk"><strong class="ne fr">Lazy validation<br/></strong>By default, pandera raises an error whenever a validation check isn‚Äôt passed. This can be annoying because it only displays the first validation error encountered, and prevents the rest of the data from being checked.</p><p id="e619" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">In some cases, it is better to let the whole dataframe validate and collect all errors in one run, rather than fixing them one by one and waiting for the validation to run again. The first is what lazy validation does.</p><pre class="ml mm mn mo mp pi oc pj bp pk bb bk"><span id="c324" class="pl oi fq oc b bg pm pn l po pp">df = pd.DataFrame(...)<br/>Mymodel.validate(df, lazy_validation=True)</span></pre><h1 id="ccb4" class="oh oi fq bf oj ok ol gq om on oo gt op oq or os ot ou ov ow ox oy oz pa pb pc bk">An ML Production Pipeline with Data Validation</h1><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj qq"><img src="../Images/c9b4dfd55516a8c114ec37de0fc9ae03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tcTDRG7zmsbKNFbxpBQHTg.jpeg"/></div></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">Image generated with <a class="af nb" href="https://creator.nightcafe.studio/" rel="noopener ugc nofollow" target="_blank">NightCafe</a>.</figcaption></figure><p id="e70e" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Because the majority of ML Pipelines are trained in Python with tabular data encoded into dataframe structures, <strong class="ne fr">Pandera</strong> is a great and powerful tool to validate their Inputs and Outputs.</p><pre class="ml mm mn mo mp pi oc pj bp pk bb bk"><span id="de58" class="pl oi fq oc b bg pm pn l po pp"># pipeline.py<br/><br/>class MLPipeline:<br/>    """General ML Pipeline"""<br/>    def __init__(self, model_id: str):<br/>        self.model_id = model_id<br/>    <br/>    def load_model(self) -&gt; None:<br/>        ...<br/>    <br/>    def transform_data(self, df: pd.DataFrame) -&gt; pd.DataFrame:<br/>        ...   # &lt;- Potential invalid data error<br/>        return df_transform<br/><br/>    def predict(self, df: pd.DataFrame) -&gt; pd.DataFrame:<br/>        self.load_model()<br/>        df_transform = self.transform(df)<br/>        df['score'] = self.model.predict(df_transform)  # &lt;- Potential invalid data error<br/>        return df</span></pre><p id="bf4a" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">We want to avoid the model raising an error due to invalid data. That would mean that we‚Äôve done all the work of loading the model into memory and processing the raw data for nothing, wasting resources and preventing the rest of the data points from being evaluated.</p><p id="56b5" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Similarly, if the model‚Äôs output has an incorrect structure our postprocessing pipeline (uploading results to DB, returning results by RESTful API, etc.) will fail.</p><p id="2901" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">After defining the validation models using Pandera, we can leverage its <a class="af nb" href="https://pandera.readthedocs.io/en/stable/decorators.html#:~:text=Auto%20color%20theme-,Decorators%20for%20Pipeline%20Integration,-%C2%B6" rel="noopener ugc nofollow" target="_blank">decorators for pipeline integration</a> to perform I/O validation.</p><pre class="ml mm mn mo mp pi oc pj bp pk bb bk"><span id="5ed3" class="pl oi fq oc b bg pm pn l po pp"># models.py<br/>import pandera as pa<br/><br/>class InputModel(pa.DataFrameModel):<br/>    ...<br/><br/>class PredictorModel(pa.DataFrameModel):<br/>    ...<br/><br/># OutputModel inherits all InputModel validation fields<br/># and also includes the score<br/>class OutputModel(InputModel):<br/>    score: float = pa.Field(ge=0, le=1) # assuming model returns probab.</span></pre><pre class="pq pi oc pj bp pk bb bk"><span id="7b58" class="pl oi fq oc b bg pm pn l po pp"># pipeline.py<br/>import pandera as pa<br/>from .models import InputModel, PredictorModel, OutputModel<br/><br/><br/>class MLPipeline:<br/>    """General ML Pipeline"""<br/>    def __init__(self, model_id: str):<br/>        self.model_id = model_id<br/>    <br/>    def load_model(self) -&gt; None:<br/>        ...<br/>    <br/>    @pa.check_io(df=InputModel.to_schema(), out=PredictorModel.to_schema(), lazy=True)<br/>    def transform_data(self, df: pd.DataFrame) -&gt; pd.DataFrame:<br/>        ...<br/>        return df_transform<br/><br/>    @pa.check_output(OutputModel.to_schema(), lazy=True)<br/>    def predict(self, df: pd.DataFrame) -&gt; pd.DataFrame:<br/>        self.load_model()<br/>        df_transform = self.transform(df)  <br/>        df['score'] = self.model.predict(df_transform)<br/>        return df</span></pre><p id="6881" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Because we are generating an intermediate dataframe object <code class="cx nz oa ob oc b">df_transform </code>in the ML Pipeline, it is a good practice to validate it too to prevent errors. The <em class="og">predict</em> method input is not validated as it is already done by <em class="og">transform_data</em>.</p><h2 id="c07a" class="pr oi fq bf oj ps pt pu om pv pw px op nl py pz qa np qb qc qd nt qe qf qg qh bk">Handling invalid rows</h2><p id="65dc" class="pw-post-body-paragraph nc nd fq ne b go pd ng nh gr pe nj nk nl pf nn no np pg nr ns nt ph nv nw nx fj bk">We don‚Äôt want our pipeline to break just because some data points have incorrect data. In case of a validation error, the strategy should be to set aside the problematic data points and continue running the pipeline with the rest of the data. The pipeline cannot stop!üî•</p><p id="e585" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Pandera models have the option to automatically remove all invalid rows:</p><pre class="ml mm mn mo mp pi oc pj bp pk bb bk"><span id="b385" class="pl oi fq oc b bg pm pn l po pp">class MyModel(pa.DataFrameModel):<br/>    ...<br/><br/>    class Config:<br/>        drop_invalid_rows = True</span></pre><p id="cdb9" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">However, dropping all invalid rows without logging them can be dangerous. You need to know why those data points were invalid so that later you can communicate to the client or to the data engineer what was the cause of the error.</p><p id="988d" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">That is why instead of using pandera decorators I rather create my own validation helper functions:</p><pre class="ml mm mn mo mp pi oc pj bp pk bb bk"><span id="0344" class="pl oi fq oc b bg pm pn l po pp">from typing import Tuple<br/>import logging<br/><br/>logging.basicConfig(level=logging.INFO)<br/>logger = logging.getLogger(__name__)<br/><br/><br/>def log_pandera_errors(exc: pa.errors.SchemaErrors) -&gt; None:<br/>    """<br/>    Logs all errors from a SchemaErrors exception.<br/>    """<br/>    for err_type, categories in exc.message.items():<br/>        for _, errors in categories.items():<br/>            for err in errors:<br/>                logger.error(f"{err_type} ERROR: {err['column']}. {err['error']}")<br/><br/><br/>def handle_invalid(<br/>    df: pd.DataFrame, exc: pa.errors.SchemaErrors<br/>) -&gt; Tuple[pd.DataFrame, pd.DataFrame]:<br/>    """<br/>    Handles invalid data in a DataFrame based on a SchemaErrors exception.<br/>    """<br/>    log_pandera_errors(exc)<br/><br/>    df_failure = exc.failure_cases<br/><br/>    # Check for errors that cannot be resolved<br/>    # i.e. they aren't associated with a specific row index<br/>    nan_indices = df_failure["index"].isna()<br/>    if nan_indices.any():<br/>        error_msg = "\n".join(<br/>            f"    - Column: {row['column']}, check: {row['check']}, "<br/>            f"failure_case: {row['failure_case']}"<br/>            for row in df_failure[nan_indices].to_dict("records")<br/>        )<br/>        raise ValueError(<br/>            f"Schema validation failed with no possibility of continuing:\n{error_msg}\n"<br/>            "The pipeline cannot continue üò¢. Resolve before rerunning"<br/>        )<br/><br/>    invalid_idcs = df.index.isin(df_failure["index"].unique())<br/>    df_invalid = format_invalid_df(df.loc[invalid_idcs, :], exc)<br/>    df_valid = df.iloc[~invalid_idcs]<br/><br/>    return df_valid, df_invalid<br/><br/><br/>def validate(<br/>    df: pd.DataFrame, model: pa.DataFrameModel<br/>) -&gt; Tuple[pd.DataFrame, pd.DataFrame]:<br/>    """<br/>    Validates a DataFrame against a DataFrameModel and handles errors.<br/>    """<br/>    try:<br/>        return model.validate(df, lazy=True), pd.DataFrame()<br/>    except pa.errors.SchemaErrors as ex:<br/>        return handle_invalid(df, ex)</span></pre><p id="e71a" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Output forcing some errors and removing column <code class="cx nz oa ob oc b">id</code>:</p><pre class="ml mm mn mo mp pi oc pj bp pk bb bk"><span id="0069" class="pl oi fq oc b bg pm pn l po pp"># Error output<br/>ERROR:__main__:SCHEMA ERROR: UserModel. column 'id' not in dataframe. Columns in dataframe: ['username', 'email', 'membership', 'is_active', 'creation_date']<br/>ERROR:__main__:DATA ERROR: username. Column 'username' failed element-wise validator number 0: str_matches('^[a-zA-Z0-9_]+$') failure cases: b%09<br/>ERROR:__main__:DATA ERROR: email. Column 'email' failed element-wise validator number 0: str_matches('^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+$') failure cases: ef.com<br/>ERROR:__main__:DATA ERROR: UserModel. DataFrameSchema 'UserModel' failed element-wise validator number 0: &lt;Check membership_is_valid&gt; failure cases: c, ef.com, free, True, 2000-12-31 00:00:00+00:00<br/><br/>ValueError: Schema validation failed with no possibility of continuing:<br/>    - Column: UserModel, check: column_in_dataframe, failure_case: id<br/>The pipeline cannot continue üò¢. Resolve before rerunning</span></pre><p id="f702" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">In case of an unresolvable error that involves an entire column, the pipeline cannot continue.</p><h2 id="42a4" class="pr oi fq bf oj ps pt pu om pv pw px op nl py pz qa np qb qc qd nt qe qf qg qh bk">Testing</h2><p id="7666" class="pw-post-body-paragraph nc nd fq ne b go pd ng nh gr pe nj nk nl pf nn no np pg nr ns nt ph nv nw nx fj bk">Last but not least, Pandera models and schemas also incorporate a method for generating sample data according to their definition. You will need to install <code class="cx nz oa ob oc b"><a class="af nb" href="https://hypothesis.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank">hypothesis</a></code> library to use it.</p><p id="686e" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">However, after testing it with some examples I do not recommend it. As soon as you start adding a few constraints, it takes too long to generate the synthetic data and most of the time it isn‚Äôt varied (the generated data do not cover the entire restriction space and repeats itself) The best alternative I found is to add data generators for each model you want to test ‚Äî after all, there aren‚Äôt so many data frames to validate in a pipeline either ‚Äî .</p><pre class="ml mm mn mo mp pi oc pj bp pk bb bk"><span id="389c" class="pl oi fq oc b bg pm pn l po pp">class UserModel(pa.DataFrameModel):<br/>    ...<br/><br/>    def sample(size: int = 10) -&gt; pd.DataFrame:<br/>        """Added method to generate valid test data manually"""<br/>        current_time = dt.datetime.now(dt.timezone.utc)<br/>        return pd.DataFrame(<br/>            {<br/>                "id": range(size),<br/>                "username": [f"user_{i}" for i in range(size)],<br/>                "email": [f"user_{i}@example.com" for i in range(size)],<br/>                "is_active": [True] * size,<br/>                "membership": ["premium"] * size,  # All premium to pass checks<br/>                "creation_date": [current_time] * size,<br/>            }<br/>        )</span></pre><h1 id="116f" class="oh oi fq bf oj ok ol gq om on oo gt op oq or os ot ou ov ow ox oy oz pa pb pc bk">Conclusion</h1><p id="c63b" class="pw-post-body-paragraph nc nd fq ne b go pd ng nh gr pe nj nk nl pf nn no np pg nr ns nt ph nv nw nx fj bk">Data validation is vital for every data processing pipeline and especially in Machine Learning. Pandera simplifies a lot of this work by providing a flexible, and efficient model-based approach to validating data in dataframes.</p><p id="f2dc" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">With Pandera, you can define model classes that enforce column types, ranges, and even complex conditional constraints. This makes it easy to catch data quality issues early in the pipeline, ensuring that the data conforms to expected standards before it reaches the next steps.</p><p id="d879" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">By integrating Pandera into an ML pipeline, you can create robust data checks that help prevent errors and improve the reliability of model outputs.</p><p id="e872" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Final pandera.DataFrameModel used in the tests:</p><pre class="ml mm mn mo mp pi oc pj bp pk bb bk"><span id="378d" class="pl oi fq oc b bg pm pn l po pp">import pandas as pd<br/>import pandera as pa<br/>from pandera.typing import Series<br/>from typing import Annotated<br/>import datetime as dt<br/><br/><br/>class UserModel(pa.DataFrameModel):<br/>    id: int = pa.Field(unique=True, ge=0, coerce=False)<br/>    username: str = pa.Field(str_matches=r"^[a-zA-Z0-9_]+$")<br/>    email: str = pa.Field(<br/>        str_matches=r"^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+$"<br/>    )<br/>    is_active: bool<br/>    membership: str = pa.Field(isin=["premium", "free"])<br/>    creation_date: Annotated[pd.DatetimeTZDtype, "ns", "UTC"]<br/><br/>    @pa.check("username", name="username_length")<br/>    def username_length(cls, x: Series[str]) -&gt; Series[bool]:<br/>        """<br/>        Check username length is between 1 and 20 characters<br/>        """<br/>        return x.str.len().between(1, 20)<br/><br/>    @pa.check("creation_date", name="min_creation_date")<br/>    def min_creation_date(cls, x: Series[pd.DatetimeTZDtype]) -&gt; Series[bool]:<br/>        """<br/>        Check creation date is after 2000-01-01<br/>        """<br/>        return x &gt;= dt.datetime(2000, 1, 1, tzinfo=dt.timezone.utc)<br/><br/>    @pa.dataframe_check<br/>    def membership_is_valid(<br/>        cls, df: pd.DataFrame, name="membership_is_valid"<br/>    ) -&gt; Series[bool]:<br/>        """<br/>        Check account age for free memebers is &lt;= 30 days<br/>        """<br/>        current_time = dt.datetime.now(dt.timezone.utc)<br/>        thirty_days = dt.timedelta(days=30)<br/><br/>        return (df["membership"] == "premium") | (<br/>            (df["membership"] == "free")<br/>            &amp; ((current_time - df["creation_date"]) &lt;= thirty_days)<br/>        )<br/><br/>    class Config:<br/>        strict = True<br/>        coerce = True<br/><br/>    def sample(size: int = 10) -&gt; pd.DataFrame:<br/>        """Added method to generate valid test data manually"""<br/>        current_time = dt.datetime.now(dt.timezone.utc)<br/>        return pd.DataFrame(<br/>            {<br/>                "id": range(size),<br/>                "username": [f"user_{i}" for i in range(size)],<br/>                "email": [f"user_{i}@example.com" for i in range(size)],<br/>                "is_active": [True] * size,<br/>                "membership": ["premium"]<br/>                * size,  # All premium to avoid date restrictions<br/>                "creation_date": [current_time] * size,<br/>            }<br/>        )</span></pre></div></div></div><div class="ab cb qr qs qt qu" role="separator"><span class="qv by bm qw qx qy"/><span class="qv by bm qw qx qy"/><span class="qv by bm qw qx"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="1ac2" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk"><em class="og">Hi, I‚Äôm Gabriel Furnieles, a Mathematical Engineer specializing in Artificial Intelligence, Data Pipelines, and MLOps. I hope you enjoyed the article and found it helpful, if so, please consider following me </em><span class="ia"><span class="ia" aria-hidden="false"><a class="qz ib ra" href="https://medium.com/u/e77c10fd9715?source=post_page---user_mention--f07b0f845040--------------------------------" rel="noopener" target="_blank"><em class="og">Gabriel Furnieles</em></a></span></span>,<em class="og"> and subscribing to my newsletter so stories will be sent directly to you üëá</em></p><div class="rb rc rd re rf rg"><a href="https://medium.com/@gabrielfurnieles?source=post_page-----f07b0f845040--------------------------------" rel="noopener follow" target="_blank"><div class="rh ab ig"><div class="ri ab co cb rj rk"><h2 class="bf fr hw z io rl iq ir rm it iv fp bk">Gabriel Furnieles - Medium</h2><div class="rn l"><h3 class="bf b hw z io rl iq ir rm it iv dx">Read writing from Gabriel Furnieles on Medium. Mathematical engineer specializing in AI and ML. I write casually on‚Ä¶</h3></div><div class="ro l"><p class="bf b dy z io rl iq ir rm it iv dx">medium.com</p></div></div><div class="rp l"><div class="rq l rr rs rt rp ru lq rg"/></div></div></a></div></div></div></div></div>    
</body>
</html>