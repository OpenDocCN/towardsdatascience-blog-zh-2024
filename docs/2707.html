<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Removing Spikes from Raman Spectra with Python: A Step-by-Step Guide</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Removing Spikes from Raman Spectra with Python: A Step-by-Step Guide</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/removing-spikes-from-raman-spectra-a-step-by-step-guide-with-python-b6fd90e8ea77?source=collection_archive---------4-----------------------#2024-11-06">https://towardsdatascience.com/removing-spikes-from-raman-spectra-a-step-by-step-guide-with-python-b6fd90e8ea77?source=collection_archive---------4-----------------------#2024-11-06</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="5871" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx">Find, remove and replace spikes with interpolated values</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hd he hf hg hh ab"><div><div class="ab hi"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@nicopez?source=post_page---byline--b6fd90e8ea77--------------------------------" rel="noopener follow"><div class="l hj hk by hl hm"><div class="l ed"><img alt="Nicolas Coca, PhD" class="l ep by dd de cx" src="../Images/548630c393526a802cf560344990a1e3.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/2*v7XGLi27QWFHm8WJRby09Q.jpeg"/><div class="hn by l dd de em n ho eo"/></div></div></a></div></div><div class="hp ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--b6fd90e8ea77--------------------------------" rel="noopener follow"><div class="l hq hr by hl hs"><div class="l ed"><img alt="Towards Data Science" class="l ep by br ht cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hn by l br ht em n ho eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hu ab q"><div class="ab q hv"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hw hx bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hy" data-testid="authorName" href="https://medium.com/@nicopez?source=post_page---byline--b6fd90e8ea77--------------------------------" rel="noopener follow">Nicolas Coca, PhD</a></p></div></div></div><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hw hx dx"><button class="ib ic ah ai aj ak al am an ao ap aq ar id ie if" disabled="">Follow</button></p></div></div></span></div></div><div class="l ig"><span class="bf b bg z dx"><div class="ab cn ih ii ij"><div class="ik il ab"><div class="bf b bg z dx ab im"><span class="in l ig">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hy ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--b6fd90e8ea77--------------------------------" rel="noopener follow"><p class="bf b bg z io ip iq ir is it iu iv bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">7 min read</span><div class="iw ix l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Nov 6, 2024</span></div></span></div></span></div></div></div><div class="ab cp iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn"><div class="h k w ea eb q"><div class="kd l"><div class="ab q ke kf"><div class="pw-multi-vote-icon ed in kg kh ki"><div class=""><div class="kj kk kl km kn ko kp am kq kr ks ki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kt ku kv kw kx ky kz"><p class="bf b dy z dx"><span class="kk">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kj la lb ab q ee lc ld" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="le"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg></button></div></div></div><div class="ab q jo jp jq jr js jt ju jv jw jx jy jz ka kb kc"><div class="lf k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lg an ao ap id lh li lj" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep lk cn"><div class="l ae"><div class="ab cb"><div class="ll lm ln lo lp lq ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lg an ao ap id lr ls ld lt lu lv lw lx s ly lz ma mb mc md me u mf mg mh"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lg an ao ap id lr ls ld lt lu lv lw lx s ly lz ma mb mc md me u mf mg mh"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lg an ao ap id lr ls ld lt lu lv lw lx s ly lz ma mb mc md me u mf mg mh"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><p id="9770" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk">This tutorial is part of a growing series on <a class="af ne" rel="noopener" target="_blank" href="/data-science-for-raman-spectroscopy-a-practical-example-e81c56cf25f">Data Science for Raman Spectroscopy with Python</a> published in <a class="af ne" href="https://towardsdatascience.com/" rel="noopener" target="_blank">towards data science</a>. It is based on this <a class="af ne" href="https://doi.org/10.1016/j.aca.2024.342312" rel="noopener ugc nofollow" target="_blank">publication</a> in the journal Analytica Chimica Acta. By following along, you’ll add a valuable tool to your data analysis toolkit — an effective method for cleaning up Raman spectra that’s already used in published research.</p><figure class="ni nj nk nl nm nn nf ng paragraph-image"><div role="button" tabindex="0" class="no np ed nq bh nr"><div class="nf ng nh"><img src="../Images/7b4c0ebe0c2398f9f9dbcf05ecffd68a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HRGEmPt0mCvqlv3Jv9nSKA.jpeg"/></div></div><figcaption class="nt nu nv nf ng nw nx bf b bg z dx">Despiking Graphene’s Raman spectrum. Image by author.</figcaption></figure><h1 id="56c8" class="ny nz fq bf oa ob oc gq od oe of gt og oh oi oj ok ol om on oo op oq or os ot bk"><strong class="al">Introduction</strong></h1><p id="7392" class="pw-post-body-paragraph mi mj fq mk b go ou mm mn gr ov mp mq mr ow mt mu mv ox mx my mz oy nb nc nd fj bk">Spike removal is an essential part of Raman data preprocessing. Spikes, caused by cosmic rays impacting the detector, appear as intense, narrow peaks that can distort the analysis. These bursts of energy hit the charge-coupled device (CCD) camera, creating sharp, high-intensity peaks that, if left uncorrected, can interfere with further processing steps like normalization, spectral search, or multivariate data analysis. Cleaning these artifacts is therefore a priority. This tutorial will cover a practical algorithm for removing spikes from Raman spectra. Using Python, we’ll walk through a user-friendly, customizable approach for spike detection and correction to keep Raman data accurate and reliable.</p><p id="1f17" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk">Figure 1 shows an example of a graphene Raman spectrum where a spike is present. Graphene’s exceptional physical properties — such as its electrical and thermal conductivity — have made it a highly studied material. Its Raman spectrum contains peaks that reflect structural characteristics, revealing information about doping, strain, and grain boundaries. Therefore, Raman spectroscopy is a widely used technique to characterize graphene. However, to make the most of this tool, spikes must be previously removed.</p><figure class="ni nj nk nl nm nn nf ng paragraph-image"><div role="button" tabindex="0" class="no np ed nq bh nr"><div class="nf ng oz"><img src="../Images/0de7cbb79612e8ba4c036fcb4f2ef06f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*APzQMIlrMgV37kDqtben3g.jpeg"/></div></div><figcaption class="nt nu nv nf ng nw nx bf b bg z dx">Figure 1. Raman spectrum from graphene with a spike. The code to generate this figure is shown below. Image by author.</figcaption></figure><pre class="ni nj nk nl nm pa pb pc bp pd bb bk"><span id="c327" class="pe nz fq pb b bg pf pg l ph pi">import numpy as np<br/># Load data directly into a numpy array<br/>data = np.loadtxt(spiked_spectrum.asc, delimiter=',', skiprows=1)<br/><br/># Extract Raman shift from the first column (index)<br/>ramanshift = data[:, 0]<br/><br/># Extract intensity from the second column (index 1in Python)<br/>intensity = data[:, 1]<br/><br/># Plot the data<br/>import matplotlib.pyplot as plt<br/>fig = plt.figure(figsize = (5,3))<br/>plt.plot(ramanshift, intensity)<br/>plt.xlabel('Raman shift (cm$^{-1}$)')<br/>plt.ylabel('Intensity (a.u.)')<br/>plt.show()</span></pre><h1 id="536c" class="ny nz fq bf oa ob oc gq od oe of gt og oh oi oj ok ol om on oo op oq or os ot bk">The spike removal algorithm</h1><p id="d302" class="pw-post-body-paragraph mi mj fq mk b go ou mm mn gr ov mp mq mr ow mt mu mv ox mx my mz oy nb nc nd fj bk">The spike removal algorithm presented here consists of four main steps:</p><p id="9155" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk"><strong class="mk fr">1. Peak finding</strong><br/> <strong class="mk fr">2. Spike detection</strong><br/> <strong class="mk fr">3. Spike flagging</strong><br/> <strong class="mk fr">4. Spectrum correction</strong></p><p id="c435" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk">Let’s take a look at the different steps with Python code snippets:</p><p id="54bd" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk"><strong class="mk fr">1. Peak finding:</strong> First, the algorithm identifies significant peaks by checking for local maxima with a minimum prominence threshold. Adding a prominence threshold helps to exclude small noise-generated peaks, as we don’t aim to correct all the noise. See the following figure for comparison.</p><pre class="ni nj nk nl nm pa pb pc bp pd bb bk"><span id="1039" class="pe nz fq pb b bg pf pg l ph pi">from scipy.signal import find_peaks<br/># Find the peaks in the spectrum (with and without prominence threshold)<br/>peaks_wo_p, _ = find_peaks(intensity) # Peaks found without a prominence threshold<br/>peaks_w_p, _ = find_peaks(intensity, prominence = 20) # Peaks found without a prominence threshold<br/><br/>fig, ax = plt.subplots(1, 2, figsize = (10,3))<br/>ax[0].plot(ramanshift, intensity, zorder=0, label='Raw spectrum')<br/>ax[0].scatter(ramanshift[peaks_wo_p], intensity[peaks_wo_p], marker ='.', color = 'red',label='Found peaks')<br/>ax[1].plot(ramanshift, intensity, zorder=0, label='Raw spectrum')<br/>ax[1].scatter(ramanshift[peaks_w_p], intensity[peaks_w_p], marker ='.', color = 'red',label='Found peaks')<br/>plt.show()</span></pre><figure class="ni nj nk nl nm nn nf ng paragraph-image"><div role="button" tabindex="0" class="no np ed nq bh nr"><div class="nf ng pj"><img src="../Images/df05fdd0e60900a17df9f01be6273e5a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jVMpwIUUWhBgrLDAWklZBQ.jpeg"/></div></div><figcaption class="nt nu nv nf ng nw nx bf b bg z dx">Step 1: Find the peaks in a spectrum. Image by author.</figcaption></figure><p id="b5b0" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk"><strong class="mk fr">2. Spike detection:</strong> Then, spikes are flagged based on their characteristic narrow widths. This point might help in the automation of large spectral datasets. If we know the width of the Raman bands present in our spectra, we can choose a threshold below such a value. For example, with our system resolution, we do not expect to have graphene Raman bands with widths below 10 cm-1.</p><pre class="ni nj nk nl nm pa pb pc bp pd bb bk"><span id="e30f" class="pe nz fq pb b bg pf pg l ph pi">from scipy.signal import peak_widths<br/>widths = peak_widths(intensity, peaks_w_p)[0]<br/><br/>fig, ax = plt.subplots(figsize = (5,3))<br/>ax.plot(ramanshift, intensity, zorder=0, label='Raw spectrum')<br/>ax2 = ax.twinx()<br/>ax2.scatter(ramanshift[peaks_w_p], widths, marker ='+', color = 'red',label='Peak widths')<br/>plt.show()</span></pre><figure class="ni nj nk nl nm nn nf ng paragraph-image"><div role="button" tabindex="0" class="no np ed nq bh nr"><div class="nf ng pk"><img src="../Images/2ac54ea631976e354b792ba9f176db79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vjeLhAg_PyoZ6cQ4bmEg1w.jpeg"/></div></div><figcaption class="nt nu nv nf ng nw nx bf b bg z dx">Step 2: Finding the widths of the peaks. Image by author.</figcaption></figure><p id="2cd9" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk"><strong class="mk fr">3. Spike flagging</strong> Next, any data points affected by spikes are flagged using a range calculated from the peak’s prominence, effectively isolating corrupted pixels. In other words, we select the window that must be corrected</p><pre class="ni nj nk nl nm pa pb pc bp pd bb bk"><span id="9d7e" class="pe nz fq pb b bg pf pg l ph pi"># Let's set the parameters:<br/>width_param_rel = 0.8<br/>width_threshold = 10 # Estimation of the width of the narrowest Raman band<br/><br/># Calculation of the range where the spectral points are asumed to be corrupted<br/>widths_ext_a = peak_widths(intensity, peaks_w_p, rel_height=width_param_rel)[2]<br/>widths_ext_b = peak_widths(intensity, peaks_w_p, rel_height=width_param_rel)[3]<br/><br/># Create a vector where spikes will be flag: no spike = 0, spike = 1.<br/>spikes = np.zeros(len(intensity))<br/>    <br/># Flagging the area previously defined if the peak is considered a spike (width below width_threshold)<br/>for a, width, ext_a, ext_b in zip(range(len(widths)), widths, widths_ext_a, widths_ext_b):<br/>    if width &lt; width_threshold:<br/>        spikes[int(ext_a) - 1: int(ext_b) + 2] = 1 <br/><br/>fig = plt.figure(figsize = (5,3))<br/>plt.plot(ramanshift, intensity, zorder=0,label='Raw spectrum')<br/>a=1<br/>plt.scatter(ramanshift[int(widths_ext_a[a])-1 : int(widths_ext_b[a])+1], <br/>            intensity[int(widths_ext_a[a])-1 : int(widths_ext_b[a])+1], <br/>            color ='red', label = 'corrupted points')<br/>plt.axvline(x = ramanshift[int(widths_ext_a[a]) -1], linestyle = '--', color = 'red')<br/>plt.axvline(x = ramanshift[int(widths_ext_b[a]) + 1], linestyle = '--', color = 'red')  <br/>plt.show()</span></pre><figure class="ni nj nk nl nm nn nf ng paragraph-image"><div role="button" tabindex="0" class="no np ed nq bh nr"><div class="nf ng pl"><img src="../Images/6ca5b8f53884b5222fac8b105f5c4608.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I64b-LlWLDq1rXMat93lQg.jpeg"/></div></div><figcaption class="nt nu nv nf ng nw nx bf b bg z dx">Step 3: Flagging the corrupted bins. Image by author.</figcaption></figure><p id="8365" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk"><strong class="mk fr">4. Spectrum correction</strong> Finally, these points are corrected through interpolation of nearby values, preserving the spectrum’s integrity for subsequent analyses.</p><pre class="ni nj nk nl nm pa pb pc bp pd bb bk"><span id="413b" class="pe nz fq pb b bg pf pg l ph pi">from scipy import interpolate<br/># Let's set the parameter:<br/>moving_average_window = 10<br/><br/>intensity_out = intensity.copy()<br/>    <br/># Interpolation of corrupted points<br/>for i, spike in enumerate(spikes):<br/>    if spike != 0: # If we have an spike in position i<br/>        window = np.arange(i - moving_average_window, i + moving_average_window + 1) # we select 2 ma + 1 points around our spike<br/>        window_exclude_spikes = window[spikes[window] == 0] # From such interval, we choose the ones which are not spikes<br/>        interpolator = interpolate.interp1d(window_exclude_spikes, intensity[window_exclude_spikes], kind='linear') # We use the not corrupted points around the spike to calculate the interpolation<br/>        intensity_out[i] = interpolator(i) # The corrupted point is exchanged by the interpolated value.<br/><br/>fig = plt.figure(figsize = (5,3))<br/>plt.plot(ramanshift, intensity, zorder=0, color ='red',label='Raw spectrum')<br/>plt.plot(ramanshift, intensity_out, zorder=0, label='Corrected spectrum')<br/>plt.show()</span></pre><figure class="ni nj nk nl nm nn nf ng paragraph-image"><div role="button" tabindex="0" class="no np ed nq bh nr"><div class="nf ng pl"><img src="../Images/1a41d905031018d2af7adab04d555510.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F-UgBJizzjS6FKU5IySuHQ.jpeg"/></div></div><figcaption class="nt nu nv nf ng nw nx bf b bg z dx">Step 4: Spectrum correction. Image by author.</figcaption></figure><h1 id="2bb0" class="ny nz fq bf oa ob oc gq od oe of gt og oh oi oj ok ol om on oo op oq or os ot bk">A full spike removal function in Python</h1><p id="68b1" class="pw-post-body-paragraph mi mj fq mk b go ou mm mn gr ov mp mq mr ow mt mu mv ox mx my mz oy nb nc nd fj bk">All these snippets can be summarized in a single function. This function is designed to be customizable based on your specific data needs, with parameters for adjusting prominence and width:</p><pre class="ni nj nk nl nm pa pb pc bp pd bb bk"><span id="a71b" class="pe nz fq pb b bg pf pg l ph pi">import numpy as np<br/>from scipy.signal import find_peaks, peak_widths, peak_prominences<br/>from scipy import interpolate<br/><br/>def spike_removal(y, <br/>                  width_threshold, <br/>                  prominence_threshold=None, <br/>                  moving_average_window=10, <br/>                  width_param_rel=0.8, <br/>                  interp_type='linear'):<br/>    """<br/>    Detects and replaces spikes in the input spectrum with interpolated values. Algorithm first <br/>    published by N. Coca-Lopez in Analytica Chimica Acta. https://doi.org/10.1016/j.aca.2024.342312<br/><br/>    Parameters:<br/>    y (numpy.ndarray): Input spectrum intensity.<br/>    width_threshold (float): Threshold for peak width.<br/>    prominence_threshold (float): Threshold for peak prominence.<br/>    moving_average_window (int): Number of points in moving average window.<br/>    width_param_rel (float): Relative height parameter for peak width.<br/>    tipo: type of interpolation (linear, quadratic, cubic)<br/>    <br/>    Returns:<br/>    numpy.ndarray: Signal with spikes replaced by interpolated values.<br/>    """<br/><br/>    # First, we find all peaks showing a prominence above prominence_threshold on the spectra<br/>    peaks, _ = find_peaks(y, prominence=prominence_threshold)<br/>    <br/>    # Create a vector where spikes will be flag: no spike = 0, spike = 1.<br/>    spikes = np.zeros(len(y))<br/>    <br/>    # Calculation of the widths of the found peaks<br/>    widths = peak_widths(y, peaks)[0]<br/>    <br/>    # Calculation of the range where the spectral points are asumed to be corrupted<br/>    widths_ext_a = peak_widths(y, peaks, rel_height=width_param_rel)[2]<br/>    widths_ext_b = peak_widths(y, peaks, rel_height=width_param_rel)[3]<br/>    <br/>    # Flagging the area previously defined if the peak is considered a spike (width below width_threshold)<br/>    for a, width, ext_a, ext_b in zip(range(len(widths)), widths, widths_ext_a, widths_ext_b):<br/>        if width &lt; width_threshold:<br/>            spikes[int(ext_a) - 1: int(ext_b) + 2] = 1 <br/>            <br/>    y_out = y.copy()<br/>    <br/>    # Interpolation of corrupted points<br/>    for i, spike in enumerate(spikes):<br/>        if spike != 0: # If we have an spike in position i<br/>            window = np.arange(i - moving_average_window, i + moving_average_window + 1) # we select 2 ma + 1 points around our spike<br/>            window_exclude_spikes = window[spikes[window] == 0] # From such interval, we choose the ones which are not spikes<br/>            interpolator = interpolate.interp1d(window_exclude_spikes, y[window_exclude_spikes], kind=interp_type) # We use the not corrupted points around the spike to calculate the interpolation<br/>            y_out[i] = interpolator(i) # The corrupted point is exchanged by the interpolated value.<br/>            <br/>    return y_out</span></pre><p id="019a" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk">The function with the algorithm can then be applied to the spiked graphene spectrum as follows:</p><pre class="ni nj nk nl nm pa pb pc bp pd bb bk"><span id="9da5" class="pe nz fq pb b bg pf pg l ph pi">intensity_despiked = spike_removal(intensity, <br/>                                     width_threshold = 3, <br/>                                     prominence_threshold = 20, <br/>                                     moving_average_window=10, <br/>                                     width_param_rel=0.8, <br/>                                     interp_type='linear')<br/><br/>fig, ax = plt.subplots(1, 2, figsize = (2*5,3))<br/>ax[0].plot(ramanshift, intensity, label = 'spike', color ='red', linewidth = 0.9)<br/>ax[0].plot(ramanshift, intensity_despiked)<br/>ax[1].plot(ramanshift, intensity_despiked)<br/>plt.show()</span></pre><figure class="ni nj nk nl nm nn nf ng paragraph-image"><div role="button" tabindex="0" class="no np ed nq bh nr"><div class="nf ng pj"><img src="../Images/f9d4520f321b03ec94650f47c718108d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gnkHtzGHl4ZRLMNBAxXLxg.jpeg"/></div></div><figcaption class="nt nu nv nf ng nw nx bf b bg z dx">Example of spike removal in a Raman spectrum. Image by author.</figcaption></figure><p id="c27f" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk">With this spike removal approach, you can ensure your Raman spectra are clean and reliable, minimizing artefacts without losing essential spectral details. The method is ideal for automation, especially if the expected minimum peak width is known, making it highly adaptable for large-scale spectral datasets and high-throughput analysis</p><p id="47a4" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk">I hope you enjoyed this tutorial. Feel free to drop any questions or share your own Raman data challenges in the comments — I’d love to hear how this algorithm helps in your projects!</p><p id="395f" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk">Ready to try it out? Download the Jupyter Notebook <a class="af ne" href="https://github.com/nicocopez/pyspikes/blob/main/Tutorial%20to%20remove%20spikes%20from%20Raman%20spectra%20-%20A%20step%20by%20step%20guide.ipynb" rel="noopener ugc nofollow" target="_blank">here</a>. And if you found this useful, please, remember to cite the <a class="af ne" href="https://doi.org/10.1016/j.aca.2024.342312" rel="noopener ugc nofollow" target="_blank">original work</a>, that would help me a lot! :)</p></div></div></div></div>    
</body>
</html>