<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>A Deep Dive into Fine-Tuning</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>A Deep Dive into Fine-Tuning</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/stepping-out-of-the-comfort-zone-through-domain-adaptation-a-deep-dive-into-dynamic-prompting-4860c6d16224?source=collection_archive---------0-----------------------#2024-06-03">https://towardsdatascience.com/stepping-out-of-the-comfort-zone-through-domain-adaptation-a-deep-dive-into-dynamic-prompting-4860c6d16224?source=collection_archive---------0-----------------------#2024-06-03</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="197a" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx">Stepping out of the “comfort zone” — part 3/3 of a deep-dive into domain adaptation approaches for LLMs</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hd he hf hg hh ab"><div><div class="ab hi"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@aris.tsakpinis?source=post_page---byline--4860c6d16224--------------------------------" rel="noopener follow"><div class="l hj hk by hl hm"><div class="l ed"><img alt="Aris Tsakpinis" class="l ep by dd de cx" src="../Images/2cc1101aed68e1f71a0026bfdec28f58.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/1*HiuDPBJ3_XhJLRi40lBb7Q.jpeg"/><div class="hn by l dd de em n ho eo"/></div></div></a></div></div><div class="hp ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--4860c6d16224--------------------------------" rel="noopener follow"><div class="l hq hr by hl hs"><div class="l ed"><img alt="Towards Data Science" class="l ep by br ht cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hn by l br ht em n ho eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hu ab q"><div class="ab q hv"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hw hx bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hy" data-testid="authorName" href="https://medium.com/@aris.tsakpinis?source=post_page---byline--4860c6d16224--------------------------------" rel="noopener follow">Aris Tsakpinis</a></p></div></div></div><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hw hx dx"><button class="ib ic ah ai aj ak al am an ao ap aq ar id ie if" disabled="">Follow</button></p></div></div></span></div></div><div class="l ig"><span class="bf b bg z dx"><div class="ab cn ih ii ij"><div class="ik il ab"><div class="bf b bg z dx ab im"><span class="in l ig">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hy ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--4860c6d16224--------------------------------" rel="noopener follow"><p class="bf b bg z io ip iq ir is it iu iv bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">24 min read</span><div class="iw ix l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Jun 3, 2024</span></div></span></div></span></div></div></div><div class="ab cp iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn"><div class="h k w ea eb q"><div class="kd l"><div class="ab q ke kf"><div class="pw-multi-vote-icon ed in kg kh ki"><div class=""><div class="kj kk kl km kn ko kp am kq kr ks ki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kt ku kv kw kx ky kz"><p class="bf b dy z dx"><span class="kk">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kj la lb ab q ee lc ld" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="le"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg></button></div></div></div><div class="ab q jo jp jq jr js jt ju jv jw jx jy jz ka kb kc"><div class="lf k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lg an ao ap id lh li lj" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep lk cn"><div class="l ae"><div class="ab cb"><div class="ll lm ln lo lp lq ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lg an ao ap id lr ls ld lt lu lv lw lx s ly lz ma mb mc md me u mf mg mh"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lg an ao ap id lr ls ld lt lu lv lw lx s ly lz ma mb mc md me u mf mg mh"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lg an ao ap id lr ls ld lt lu lv lw lx s ly lz ma mb mc md me u mf mg mh"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj mk"><img src="../Images/0f95d6e4633f3120af41fb5091422cde.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EXTS4rlUA_YNfo9NXVfiVw.png"/></div></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">Photo by StableDiffusionXL on Amazon Web Services</figcaption></figure><p id="8c39" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">Exploring domain adapting large language models (LLMs) to your specific domain or use case? This <strong class="nd fr">3-part blog post series </strong>explains the motivation for domain adaptation and dives deep into various options to do so. Further, a detailed guide for mastering the entire domain adaptation journey covering popular tradeoffs is being provided.</p><p id="cb38" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk"><a class="af nx" rel="noopener" target="_blank" href="/stepping-out-of-the-comfort-zone-through-domain-adaptation-a-deep-dive-into-dynamic-prompting-47a865b16740"><em class="ny">Part 1: Introduction into domain adaptation — motivation, options, tradeoffs </em></a><em class="ny"><br/></em><a class="af nx" rel="noopener" target="_blank" href="/stepping-out-of-the-comfort-zone-through-domain-adaptation-a-deep-dive-into-dynamic-prompting-9ee1d71d1e35"><em class="ny">Part 2: A deep dive into in-context learning</em></a><strong class="nd fr"><em class="ny"> </em></strong><em class="ny"><br/>Part 3: A deep dive into fine-tuning</em><strong class="nd fr"><em class="ny"> — You’re here!</em></strong></p><p id="e0da" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">Note: All images, unless otherwise noted, are by the author.</p><h1 id="e37c" class="nz oa fq bf ob oc od gq oe of og gt oh oi oj ok ol om on oo op oq or os ot ou bk">Recap</h1><p id="68e8" class="pw-post-body-paragraph nb nc fq nd b go ov nf ng gr ow ni nj nk ox nm nn no oy nq nr ns oz nu nv nw fj bk">In the previous part of this blog post series, we explored the concept of in-context learning as a powerful approach to overcome the “comfort zone” limitations of large language models (LLMs). We discussed how these techniques can be used to transform tasks and move them back into the models’ areas of expertise, leading to improved performance and alignment with the key design principles of Helpfulness, Honesty, and Harmlessness. In this third part, we will shift our focus to the second domain adaptation approach: fine-tuning. We will dive into the details of fine-tuning, exploring how it can be leveraged to expand the models’ “comfort zones” and hence uplift performance by adapting them to specific domains and tasks. We will discuss the trade-offs between prompt engineering and fine-tuning, and provide guidance on when to choose one approach over the other based on factors such as data velocity, task ambiguity, and other considerations.</p><h1 id="40dc" class="nz oa fq bf ob oc od gq oe of og gt oh oi oj ok ol om on oo op oq or os ot ou bk">Transformers 101</h1><p id="e31e" class="pw-post-body-paragraph nb nc fq nd b go ov nf ng gr ow ni nj nk ox nm nn no oy nq nr ns oz nu nv nw fj bk">Most state-of-the-art LLMs are powered by the transformer architecture, a family of deep neural network architectures which has disrupted the field of NLP after being proposed by <a class="af nx" href="https://arxiv.org/abs/1706.03762" rel="noopener ugc nofollow" target="_blank">Vaswani et al in 2017</a>, breaking all common benchmarks across the domain. The core differentiator of this architecture family is a concept called “attention” which excels in capturing the semantic meaning of words or larger pieces of natural language based on the context they are used in.</p><p id="72fa" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">The transformer architecture consists of two fundamentally different building blocks. On the one side, the “encoder” block focuses on translating the semantics of natural language into so-called contextualized embeddings, which are mathematical representations in the vector space. This makes encoder models particularly useful in use cases utilizing these vector representations for downstream deterministic or probabilistic tasks like classification problems, NER, or semantic search. On the other side, the decoder block is trained on next-token prediction and hence capable of generatively producing text if used in a recursive manner. They can be used for all tasks relying on the generation of text. These building blocks can be used independently of each other, but also in combination. Most of the models referred to within the field of generative AI today are decoder-only models. This is why this blog post will focus on this type of model.</p><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj pa"><img src="../Images/169c0e20afc902b109b03c67b20db3f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N6uYH5eKmwe_QrNPjGLtyQ.jpeg"/></div></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">Figure 1: The transformer architecture (adapted from Vaswani et al, 2017)</figcaption></figure><h1 id="c60a" class="nz oa fq bf ob oc od gq oe of og gt oh oi oj ok ol om on oo op oq or os ot ou bk">E2E fine-tuning pipeline</h1><p id="0b29" class="pw-post-body-paragraph nb nc fq nd b go ov nf ng gr ow ni nj nk ox nm nn no oy nq nr ns oz nu nv nw fj bk">Fine-tuning leverages transfer learning to efficiently inject niche expertise into a foundation model like LLaMA2. The process involves updating the model’s weights through training on domain-specific data, while keeping the overall network architecture unchanged. Unlike full pre-training which requires massive datasets and compute, fine-tuning is highly sample and compute efficient. On a high level, the end-to-end process can be broken down into the following phases:</p><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj pb"><img src="../Images/48caf5fb29411dde0f0a062bbf783067.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DrIrZxvkzaahbT8bzdLxog.jpeg"/></div></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">Figure 2: E2E fine-tuning pipeline</figcaption></figure><ul class=""><li id="94fb" class="nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw pc pd pe bk"><strong class="nd fr">Data collection and selection:</strong> The set of proprietary data to be ingested into the model needs to be carefully selected. On top of that, for specific fine-tuning purposes data might not be available yet and has to be purposely collected. Depending on the data available and task to be achieved through fine-tuning, data of different quantitative or qualitative characteristics might be selected (e.g. labeled, un-labeled, preference data — see below) Besides the data quality aspect, dimensions like data source, confidentiality and IP, licensing, copyright, PII and more need to be considered.</li></ul><p id="1339" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">LLM pre-training usually leverages a mix of web scrapes and curated corpora, the nature of fine-tuning as a domain adaptation approach implies that the datasets used are mostly curated corpora of labeled or unlabelled data specific to an organizational, knowledge, or task-specific domain.</p><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj pf"><img src="../Images/ff6d46928f4776dc9590d9ce6f876f41.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GgiVj7A420NX8ZHY5fuE9w.png"/></div></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">Figure 3: Pre-training vs. fine-tuning: data composition and selection criteria</figcaption></figure><p id="3a97" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">While this data can be sourced differently (document repositories, human-created content, etc.), this underlines that for fine-tuning, it is important to carefully select the data with respect to quality, but as mentioned above, also consider topics like confidentiality and IP, licensing, copyright, PII, and others.</p><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj pg"><img src="../Images/a4742eeaea7bfc6447c2a812fa29cd9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q-fBAIvI3LQYrov1BKmM6w.png"/></div></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">Figure 4: Data requirements per fine-tuning approach</figcaption></figure><p id="b012" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">In addition to this, an important dimension is the categorization of the training dataset into unlabelled and labeled (including preference) data. Domain adaptation fine-tuning requires unlabelled textual data (as opposed to other fine-tuning approaches, see the figure 4). In other words, we can simply use any full-text documents in natural language that we consider to be of relevant content and sufficient quality. This could be user manuals, internal documentation, or even legal contracts, depending on the actual use case.</p><p id="0ed0" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">On the other hand, labeled datasets like an instruction-context-response dataset can be used for supervised fine-tuning approaches. Lately, reinforcement learning approaches for aligning models to actual user feedback have shown great results, leveraging human- or machine-created preference data, e.g., binary human feedback (thumbs up/down) or multi-response ranking.</p><p id="ad97" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">As opposed to unlabeled data, labeled datasets are more difficult and expensive to collect, especially at scale and with sufficient domain expertise. Open-source data hubs like <a class="af nx" href="https://huggingface.co/docs/hub/en/datasets-overview" rel="noopener ugc nofollow" target="_blank">HuggingFace Datasets</a> can be good sources for labeled datasets, especially in areas where the broader part of a relevant human population group agrees (e.g., a toxicity dataset for red-teaming), and using an open-source dataset as a proxy for the model’s real users’ preferences is sufficient.</p><p id="d704" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">Still, many use cases are more specific and open-source proxy datasets are not sufficient. This is when datasets labeled by real humans, potentially with significant domain expertise, are required. Tools like <a class="af nx" href="https://aws.amazon.com/sagemaker/groundtruth/" rel="noopener ugc nofollow" target="_blank">Amazon SageMaker Ground Truth</a> can help with collecting the data, be it by providing fully managed user interfaces and workflows or the entire workforce.</p><p id="1c81" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">Recently, synthetic data collection has become more and more a topic in the space of fine-tuning. This is the practice of using powerful LLMs to synthetically create labeled datasets, be it for SFT or preference alignment. Even though this approach has already shown promising results, it is currently still subject to further research and has to prove itself to be useful at scale in practice.</p><ul class=""><li id="5b76" class="nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw pc pd pe bk"><strong class="nd fr">Data pre-processing:</strong> The selected data needs to be pre-processed to make it “well digestible” for the downstream training algorithm. Popular pre-processing steps are the following:</li><li id="0896" class="nb nc fq nd b go ph nf ng gr pi ni nj nk pj nm nn no pk nq nr ns pl nu nv nw pc pd pe bk"><strong class="nd fr">Quality-related pre-processing</strong>, e.g. formatting, deduplication, PII filtering</li><li id="61f3" class="nb nc fq nd b go ph nf ng gr pi ni nj nk pj nm nn no pk nq nr ns pl nu nv nw pc pd pe bk"><strong class="nd fr">Fine-tuning approach related pre-processing</strong>: e.g. rendering into prompt templates for supervised fine-tuning</li><li id="e13a" class="nb nc fq nd b go ph nf ng gr pi ni nj nk pj nm nn no pk nq nr ns pl nu nv nw pc pd pe bk"><strong class="nd fr">NLP-related pre-processing</strong>, e.g. tokenisation, embedding, chunking (according to context window)</li><li id="ed03" class="nb nc fq nd b go ph nf ng gr pi ni nj nk pj nm nn no pk nq nr ns pl nu nv nw pc pd pe bk"><strong class="nd fr">Model training:</strong> training of the deep neural network according to selected fine-tuning approach. Popular fine-tuning approaches we will discuss in detail further below are:</li><li id="e04c" class="nb nc fq nd b go ph nf ng gr pi ni nj nk pj nm nn no pk nq nr ns pl nu nv nw pc pd pe bk"><strong class="nd fr">Continued pre-training aka domain-adaptation fine-tuning:</strong> training on full-text data, alignment tied to a next-token-prediction task</li><li id="82c4" class="nb nc fq nd b go ph nf ng gr pi ni nj nk pj nm nn no pk nq nr ns pl nu nv nw pc pd pe bk"><strong class="nd fr">Supervised fine-tuning: </strong>fine-tuning approach leveraging labeled data, alignment tied towards the target label</li><li id="c191" class="nb nc fq nd b go ph nf ng gr pi ni nj nk pj nm nn no pk nq nr ns pl nu nv nw pc pd pe bk"><strong class="nd fr">Preference-alignment approaches: </strong>fine-tuning approach leveraging preference data, aligning to a desired behaviour defined by the actual users of a model / system</li></ul><p id="f1ce" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">Subsequently, we will dive deeper into the single phases, starting with an introduction to the training approach and different fine-tuning approaches before we move over to the dataset and data processing requirements.</p><h1 id="bd67" class="nz oa fq bf ob oc od gq oe of og gt oh oi oj ok ol om on oo op oq or os ot ou bk">Training</h1><p id="cb18" class="pw-post-body-paragraph nb nc fq nd b go ov nf ng gr ow ni nj nk ox nm nn no oy nq nr ns oz nu nv nw fj bk">In this section we will explore the approach for training decoder transformer models. This applies for pre-training as well as fine-tuning.<br/>As opposed to traditional ML training approaches like unsupervised learning with unlabeled data or supervised learning with labeled data, training of transformer models utilizes a hybrid approach referred to as self-supervised learning. This is because although being fed with unlabeled textual data, the algorithm is actually intrinsically supervising itself by masking specific input tokens. Given the below input sequence of tokens “Berlin is the capital of Germany.”, this natively leads into a supervised sample with y being the masked token and X being the rest.</p><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj pm"><img src="../Images/e2badc9e497d5745f328e429526b6008.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7MFTNnNOQj36m2KbxAc-gA.jpeg"/></div></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">Figure 5: Self-supervised training of language models</figcaption></figure><p id="e787" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">The above-mentioned self-supervised training approach is optimizing the model weights towards a language modeling (LM) specific loss function. While encoder model training is utilizing Masked Language Modeling (MLM) to leverage a bi-directional context by randomly masking tokens, decoder-only models are tied towards a Causal Language Modeling (CLM) approach with a uni-directional context by always masking the rightmost token of a sequence. In simple words, this means that they are trained towards predicting the subsequent token in an auto-regressive manner based on the previous ones as semantic context. Beyond this, other LM approaches like Permutation Language Modelling (PLM) exist, where a model is conditioned towards bringing a sequence of randomly shuffled tokens back into sorted order.</p><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj pn"><img src="../Images/b208927803b712df5c02e54aa2929d48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SJM3vROE19ip2yhg2z9TOg.jpeg"/></div></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">Figure 6: Language modeling variations and loss functions</figcaption></figure><p id="70c0" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">By using the CLM task as a proxy, a prediction and ground truth are created which can be utilized to calculate the prediction loss. Therefore, the predicted probability distribution over all tokens of a model’s vocabulary is compared to the ground truth, a sparse vector with a probability of 1.0 for the token representing the ground truth. The actual loss function used depends on the specific model architecture, but loss functions like cross-entropy or perplexity loss, which perform well in categorical problem spaces like token prediction, are commonly used. The loss function is leveraged to gradually minimize the loss and hence optimize the model weights towards our training goal with every iteration through performing gradient descent in the deep neural network backpropagation.</p><h1 id="fb99" class="nz oa fq bf ob oc od gq oe of og gt oh oi oj ok ol om on oo op oq or os ot ou bk">Fine-tuning variations — scenario</h1><p id="1070" class="pw-post-body-paragraph nb nc fq nd b go ov nf ng gr ow ni nj nk ox nm nn no oy nq nr ns oz nu nv nw fj bk">Enough of theory, let’s move into practice. Let’s assume you are an organization from the BioTech domain, aiming to leverage an LLM, let’s say LLaMA2, as a foundation model for various NLP use cases around COVID-19 vaccine research. Unfortunately, there are quite a few dimensions in which this domain is not part of the “comfort zone” of general-purpose off-the-shelf pre-trained LLMs, leading to performance being below your expected bar. In the next sections, we will discuss different fine-tuning approaches and how they can help elevate LLaMA2’s performance above the bar in various dimensions in our fictitious scenario.</p><h1 id="fdf2" class="nz oa fq bf ob oc od gq oe of og gt oh oi oj ok ol om on oo op oq or os ot ou bk">Fine-tuning variations — continued pre-training aka. domain-adaptation fine-tuning</h1><p id="7eae" class="pw-post-body-paragraph nb nc fq nd b go ov nf ng gr ow ni nj nk ox nm nn no oy nq nr ns oz nu nv nw fj bk">As the headline indicates, while the field starts to converge into the term “continued pre-training” a definite term for the fine-tuning approach discussed in this sections has yet to be agreed on by community. But what is this fine-tuning approach really about?</p><p id="9e39" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">Research papers in the BioTech domain are quite peculiar in writing style, full of domain-specific knowledge and industry- or even organisation-specific acronyms (e.g. <a class="af nx" href="https://pubmed.ncbi.nlm.nih.gov/33301246/" rel="noopener ugc nofollow" target="_blank">Polack et al, 2020</a>; see Figure 7).</p><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj po"><img src="../Images/d9f716433347a11a756ed13b8de5adf4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I-99yFKxNqBRbLU4CkdTSw.png"/></div></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">Figure 7: Domain specifics of research papers illustrated using the example of Polack et al (2020)</figcaption></figure><p id="db04" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">On the other hand, a detailed look into the pre-training dataset mixtures of the Meta LLaMA models (Touvron et al., 2023; Figure 8) and the TII Falcon model family (Almazrouei et al., 2023; Figure 9) indicates that with 2.5% and 2%, general-purpose LLMs contain only a very little portion of data from the research or even BioTech domain (pre-training data mixture of LLaMA 3 family not public at the time of blog publication).</p><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div class="mi mj pp"><img src="../Images/cd3b31356155e1029a6f9c1be0b4bc94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1104/format:webp/1*IYxjvShadllVJszRbvcPYA.jpeg"/></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">Figure 8: Pre-training dataset mixture of Meta LLaMA models — Source: Touvron et al. (2023)</figcaption></figure><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj pq"><img src="../Images/1fcba7426ab5fa6a8d103e40f4cba06a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kUipo_dlUZbhNsAxp2vaXw.jpeg"/></div></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">Figure 9: Pre-training dataset mixture of TII Falcon models — Source: Almazrouei et al. (2023)</figcaption></figure><p id="bfd4" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">Hence, we need to bridge this gap by utilizing fine-tuning to expand the model’s “comfort zone” for better performance on the specific tasks to carry out. Continued pre-training excels at exactly the above-mentioned dimensions. It involves the process of adjusting a pre-trained LLM on a specific dataset consisting of plain textual data. This technique is helpful for infusing domain-specific information like linguistic patterns (domain-specific language, acronyms, etc.) or information implicitly contained in raw full-text into the model’s parametric knowledge to align the model’s responses to fit this specific language or knowledge domain. For this approach, pre-trained decoder models are fine-tuned on next-token prediction using unlabeled textual data. This makes continued pre-training the most similar fine-tuning approach to pre-training.</p><p id="6668" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">In our example, we could use the content of the mentioned paper together with related literature from a similar field and convert it into a concatenated textual file. Depending on the tuning goal and other requirements, data curation steps like removal of unnecessary content (e.g., authors, tables of content, etc.), deduplication, or PII reduction can be applied. Finally, the dataset undergoes some NLP-specific preprocessing (e.g., tokenization, chunking according to the context window, etc. — see above), before it is used for training the model. The training itself is a classic CLM-based training as discussed in the previous section. After having adapted LLaMA2 with continued pre-training on a set of research publications from the BioTech domain, we can now utilize it in this specific domain as a text-completion model “BioLLaMA2.”</p><h1 id="14d1" class="nz oa fq bf ob oc od gq oe of og gt oh oi oj ok ol om on oo op oq or os ot ou bk">Fine-tuning variations — supervised fine-tuning (SFT)</h1><p id="ff65" class="pw-post-body-paragraph nb nc fq nd b go ov nf ng gr ow ni nj nk ox nm nn no oy nq nr ns oz nu nv nw fj bk">Unfortunately, we humans don’t like to frame the problems we want to get solved in a pure text-completion/token-prediction form. Instead, we are a conversational species with a tendency towards chatty or instructive behavior, especially when we are aiming to get things done.</p><p id="e810" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">Hence, we require some sophistication beyond simple next-token prediction in the model’s behavior. This is where supervised fine-tuning approaches come into the game. Supervised fine-tuning (SFT) involves the process of aligning a pre-trained LLM on a specific dataset with labeled examples. This technique is essential for tailoring the model’s responses to fit particular domains or tasks, e.g., the above-mentioned conversational nature or instruction following. By training on a dataset that closely represents the target application, SFT allows the LLM to develop a deeper understanding and produce more accurate outputs in line with the specialized requirements and behaviour.</p><p id="1c3f" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">Beyond the above-mentioned ones, good examples of SFT can be the training of the model for Q&amp;A, a data extraction task such as entity recognition, or red-teaming to prevent harmful responses.</p><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj pr"><img src="../Images/9cfd021b9de4dbaf6b90552b69daa6ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7JFiTQFCr8DtKIZ_u5djtA.png"/></div></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">Figure 10: E2E supervised fine-tuning pipeline</figcaption></figure><p id="9b28" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">As we understood above, SFT requires a labeled dataset. There are plenty of general-purpose labeled datasets in open-source, however, to tailor the model best to your specific use case, industry, or knowledge domain, it can make sense to manually craft a custom one. Recently, the approach of using powerful LLMs like Claude 3 or GPT-4 for crafting such datasets has evolved as a resource- and time-effective alternative to human labelling.</p><p id="51ed" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">The “dolly-15k” dataset is a popular general-purpose open-source instruct fine-tuning dataset manually crafted by Databricks’ employees. It consists of roughly 15k examples of an instruction and a context labeled with a desired response. This dataset could be used to align our BioLLaMA2 model towards following instructions, e.g. for a closed Q&amp;A task. For SFT towards instruction following, we would proceed and convert every single item of the dataset into a full-text prompt, embedded into a prompt structure representing the task we want to align the model towards. This could look as follows:</p><pre class="ml mm mn mo mp ps pt pu bp pv bb bk"><span id="bf56" class="pw oa fq pt b bg px py l pz qa">### Instruction:<br/>{item.instruction}<br/>### Context:<br/>{item.context}<br/>### Response:<br/>{item.response}</span></pre><p id="6520" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">The prompt template can vary depending on the model family, as some models prefer HTML tags or other special characters over hashtags. This procedure is being applied for every item of the dataset before all of them are concatenated into a large piece of text. Finally, after the above-explained NLP-specific preprocessing, this file can be trained into the model by utilizing next-token prediction and a CLM-based training objective. Since it is consistently being exposed to this specific prompt structure, the model will learn to stick to it and act in a respective manner — in our case, instruction following. After aligning our BioLLaMA2 to the dolly-15k dataset, our BioLLaMA2-instruct model will thoroughly follow instructions submitted through the prompt.</p><h1 id="bf06" class="nz oa fq bf ob oc od gq oe of og gt oh oi oj ok ol om on oo op oq or os ot ou bk">Fine-tuning variations — human preference alignment techniques (RLHF/PPO, DPO, KTO, ORPO)</h1><p id="6969" class="pw-post-body-paragraph nb nc fq nd b go ov nf ng gr ow ni nj nk ox nm nn no oy nq nr ns oz nu nv nw fj bk">With BioLLaMA2 we have a model adapted to the BioTech research domain, following our instructions conveniently to what our users expect. But wait — is the model really aligned with our actual users? This highlights a core problem with the fine-tuning approaches discussed so far. The datasets we have used are proxies for what we think our users like or need: the content, language, acronyms from the selected research papers, as well as the desired instruct-behavior of a handful of Databricks employees crafting dolly-15k. This contrasts with the concept of user-centric product development, one of the core and well-established principles of agile product development. Iteratively looping in feedback from actual target users has proven to be highly successful when developing great products. In fact, this is definetly something we want to do if we are aiming to build a great experience for your users!</p><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj qb"><img src="../Images/a4eff0ffb3203b3f5ee164fa703c27c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DTsklCpoM8xhI7Io8AOd3Q.jpeg"/></div></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">Figure 11: Reinforcement learning framework</figcaption></figure><p id="11f4" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">With this in mind, researchers have put quite some effort into finding ways to incorporate human feedback into improving the performance of LLMs. On the path towards that, they realized a significant overlap with (deep) reinforcement learning (RL), which deals with autonomous agents performing actions in an action space within an environment, producing a next state, which is always coupled to a reward. The agents are acting based on a policy or a value-map, which has been gradually optimized towards maximizing the reward during the training phase.</p><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj qc"><img src="../Images/a7ccf68164b7ab714f3cc6655c7c96b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ThyUMDDhbIbEflx6ZZzNIQ.jpeg"/></div></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">Figure 12: Adapted reinforcement learning framework for language modeling</figcaption></figure><p id="2618" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">This concept — projected into the world of LLMs — comes down to the LLM itself acting as the agent. During inference, with every step of its auto-regressive token-prediction nature, it performs an action, where the action space is the model’s vocabulary, and the environment is all possible token combinations. With every new inference cycle, a new state is established, which is honored with a reward that is ideally correlated with some human feedback.</p><p id="ed94" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">Based on this idea, several human preference alignment approaches have been proposed and tested. In what follows, we will walk through some of the most important ones:</p><h2 id="3fbf" class="qd oa fq bf ob qe qf qg oe qh qi qj oh nk qk ql qm no qn qo qp ns qq qr qs qt bk">Reinforcement Learning from Human Feedback (RLHF) with Proximal Policy Optimization (PPO)</h2><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj qu"><img src="../Images/b0a8bad7a89e5fd657ae7a358524d8b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2Ucob_WPAkDhed89Bg8dTg.jpeg"/></div></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">Figure 13: Reward model training for RLHF</figcaption></figure><p id="84d8" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">Reinforcement learning from human feedback was one of the major hidden technical backbones of the early Generative AI hype, giving the breakthrough achieved with great large decoder models like Anthropic Claude or GPT-3.5 an additional boost into the direction of user alignment. <br/>RLHF works in a two-step process and is illustrated in Figures 13 and 14:</p><p id="faf1" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">Step 1 (Figure 13): First, a reward model needs to be trained for later usage in the actual RL-powered training approach. Therefore, a prompt dataset aligned with the objective (in the case of our BioLLaMA2-instruct model, this would be pairs of an instruction and a context) to optimize is being fed to the model to be fine-tuned, while requesting not only one but two or more inference results. These results will be presented to human labelers for scoring (1st, 2nd, 3rd, …) based on the optimization objective. There are also a few open-sourced preference ranking datasets, among them <a class="af nx" href="https://huggingface.co/datasets/Anthropic/hh-rlhf" rel="noopener ugc nofollow" target="_blank">“Anthropic/hh-rlhf”</a>which is tailored towards red-teaming and the objectives of honesty and harmlessness. After a normalization step as well as a translation into reward values, a reward model is being trained based on the single sample-reward pairs, where the sample is a single model response. The reward model architecture is usually similar to the model to be fine-tuned, adapted with a small head eventually projecting the latent space into a reward value instead of a probability distribution over tokens. However, the ideal sizing of this model in parameters is still subject to research, and different approaches have been chosen by model providers in the past.</p><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj qv"><img src="../Images/dc984cb826448732166f22fbc86030b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*01egwl3glitabKzl4tqHUg.jpeg"/></div></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">Figure 14: Reinforcement learning based model tuning with PPO for RLHF</figcaption></figure><p id="597b" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">Step 2 (Figure 14): Our new reward model is now used for training the actual model. Therefore, another set of prompts is fed through the model to be tuned (grey box in illustration), resulting in one response each. Subsequently, these responses are fed into the reward model for retrieval of the individual reward. Then, Proximal Policy Optimization (PPO), a policy-based RL algorithm, is used to gradually adjust the model’s weights in order to maximize the reward allocated to the model’s answers. As opposed to CLM, instead of gradient descent, this approach leverages gradient ascent (or gradient descent over <em class="ny">1 — reward</em>) since we are now trying to maximize an objective (reward). For increased algorithmic stability to prevent too heavy drifts in model behavior during training, which can be caused by RL-based approaches like PPO, a prediction shift penalty is being added to the reward term, penalizing answers diverging too much from the initial language model’s predicted probability distribution on the same input prompt.</p><p id="fed7" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">Beyond RLHF with PPO, which currently is the most widely adopted and proven approach to preference alignment several other approaches have been developed. In the next couple of sections we will dive deep into some of these approaches on an advanced level. This is for advanced readers only, so depending on your level of experience with deep learning and reinforcement learning you might want to skip directly to the next section “<strong class="nd fr">Decision flow chart — which model to choose, which fine-tuning path to pick</strong>”.</p><h2 id="509b" class="qd oa fq bf ob qe qf qg oe qh qi qj oh nk qk ql qm no qn qo qp ns qq qr qs qt bk">Direct Policy Optimization (DPO)</h2><p id="f1bb" class="pw-post-body-paragraph nb nc fq nd b go ov nf ng gr ow ni nj nk ox nm nn no oy nq nr ns oz nu nv nw fj bk">Direct Policy Optimization (DPO) is a preference alignment approach deducted from RLHF, tackling two major downsides of it:</p><ul class=""><li id="b84b" class="nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw pc pd pe bk">Training a reward model first is additional resource investment and can be significant depending on the reward model size</li><li id="5708" class="nb nc fq nd b go ph nf ng gr pi ni nj nk pj nm nn no pk nq nr ns pl nu nv nw pc pd pe bk">The training phase of RLHF with PPO requires massive compute clusters since three replicas of the model (initial LM, tuned LM, reward model) need to be hosted and orchestrated simultaneously in a low latency setup</li><li id="768f" class="nb nc fq nd b go ph nf ng gr pi ni nj nk pj nm nn no pk nq nr ns pl nu nv nw pc pd pe bk">RLHF can be an unstable procedure (→ prediction shift penalty tries to mitigate this)</li></ul><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj qw"><img src="../Images/9840b077f94d719ae8ae706fb73e3d3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sjSz3TgIBJLIArV7nJUGfQ.jpeg"/></div></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">Figure 15: RLHF vs. DPO (Rafailov et al., 2023)</figcaption></figure><p id="f7f0" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">DPO is an alternative preference alignment approach and was proposed by Rafailov et al. in 2023. The core idea of DPO is to skip the reward model training and tune the final preference-aligned LLM directly on the preference data. This is being achieved by applying some mathematical tweaks to transform the parameterization of the reward model (reward term) into a loss function (figure 16) while replacing the actual reward values with probability values over the preference data.</p><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj qx"><img src="../Images/f4ac00726f1ca1456a19a66955bbab90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*moyIuUFhex3FDR69Sn84ww.jpeg"/></div></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">Figure 16: Loss function for DPO (Rafailov et al., 2023)</figcaption></figure><p id="f874" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">This saves computational as well as algorithmic complexity on the way towards a preference-aligned model. While the paper is also showing performance increases as compared to RLHF, this approach is fairly recent and hence the results are subject to practical proof.</p><h2 id="fd72" class="qd oa fq bf ob qe qf qg oe qh qi qj oh nk qk ql qm no qn qo qp ns qq qr qs qt bk">Kahneman-Tversky Optimization (KTO)</h2><p id="9255" class="pw-post-body-paragraph nb nc fq nd b go ov nf ng gr ow ni nj nk ox nm nn no oy nq nr ns oz nu nv nw fj bk">Existing methods for aligning language models with human feedback, such as RLHF and DPO, require preference data — pairs of outputs where one is preferred over the other for a given input. However, collecting high-quality preference data at scale is challenging and expensive in the real world. Preference data often suffers from noise, inconsistencies, and intransitivities, as different human raters may have conflicting views on which output is better. KTO was <a class="af nx" href="https://arxiv.org/pdf/2402.01306" rel="noopener ugc nofollow" target="_blank">proposed</a> by Ethayarajh et al. (2024) as an alternative approach that can work with a simpler, more abundant signal — just whether a given output is desirable or undesirable for an input, without needing to know the relative preference between outputs.</p><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div class="mi mj qy"><img src="../Images/17c251b83d01948689c4d3b94848ad8c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1064/format:webp/1*QgRyTS85JqunSYemA2jXqg.jpeg"/></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">Figure 17: Implied human utility of desicions according to Kahneman and Tversky’s prospect theory (Ethayarajh et al., 2024)</figcaption></figure><p id="97b8" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">At a high level, KTO works by defining a reward function that captures the relative “goodness” of a generation, and then optimizing the model to maximize the expected value of this reward under a Kahneman-Tversky value function. Kahneman and Tversky’s prospect theory explains how humans make decisions about uncertain outcomes in a biased but well-defined manner. The theory posits that human utility depends on a value function that is concave in gains and convex in losses, with a reference point that separates gains from losses (see figure 17). KTO directly optimizes this notion of human utility, rather than just maximizing the likelihood of preferences.</p><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj qz"><img src="../Images/3f9262b1cd548e14214003bd150d1f41.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bRNzgU98Dv4kbSCEwuI6Ow.jpeg"/></div></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">Figure 18: RLHF vs. DPO vs. KTO (Ethayarajh et al., 2024)</figcaption></figure><p id="e389" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">The key innovation is that KTO only requires a binary signal of whether an output is desirable or undesirable, rather than full preference pairs. This allows KTO to be more data-efficient than preference-based methods, as the binary feedback signal is much more abundant and cheaper to collect. (see figure 18)</p><p id="c7e0" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">KTO is particularly useful in scenarios where preference data is scarce or expensive to collect, but you have access to a larger volume of binary feedback on the quality of model outputs. According to the paper, it can match or even exceed the performance of preference-based methods like DPO, especially at larger model scales. However, this needs to be validated at scale in practice. KTO may be preferable when the goal is to directly optimize for human utility rather than just preference likelihood. However, if the preference data is very high-quality with little noise or intransitivity, then preference-based methods could still be the better choice. KTO also has theoretical advantages in handling extreme data imbalances and avoiding the need for supervised fine-tuning in some cases.</p><h2 id="f145" class="qd oa fq bf ob qe qf qg oe qh qi qj oh nk qk ql qm no qn qo qp ns qq qr qs qt bk">Odds Ration Preference Optimization (ORPO)</h2><p id="4dda" class="pw-post-body-paragraph nb nc fq nd b go ov nf ng gr ow ni nj nk ox nm nn no oy nq nr ns oz nu nv nw fj bk">The key motivation behind ORPO is to address the limitations of existing preference alignment methods, such as RLHF and DPO, which often require a separate supervised fine-tuning (SFT) stage, a reference model, or a reward model. The paper by Hong et al. (2024) argues that SFT alone can inadvertently increase the likelihood of generating tokens in undesirable styles, as the cross-entropy loss does not provide a direct penalty for the disfavored responses. At the same time, they claim that SFT is vital for converging into powerful preference alignment models. This leads to a two-stage alignment process heavily incurring resources. By combining these stages into one, ORPO aims to preserve the domain adaptation benefits of SFT while concurrently discerning and mitigating unwanted generation styles as aimed towards by preference-alignment approaches. (see figure 19)</p><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj ra"><img src="../Images/1e7f778a63d29db342a3b57f72642818.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KDFLDeYmzm-goijybUhBAw.png"/></div></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">Figure 19: RLHF vs. DPO vs. ORPO (Hong et al., 2024)</figcaption></figure><p id="dabc" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">ORPO introduces a novel preference alignment algorithm that incorporates an odds ratio-based penalty to the conventional causal language modeling tied loss (e.g., cross-entropy loss). The objective function of ORPO consists of two components: the SFT loss and the relative ratio loss (LOR). The LOR term maximizes the odds ratio between the likelihood of generating the favored response and the disfavored response, effectively penalizing the model for assigning high probabilities to the rejected responses.</p><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj rb"><img src="../Images/29a50143618fbc9873643aaa6c24d053.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*b82E9mkcIjegpWhUVExx2w.png"/></div></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">Figure 20: ORPO loss function incorporating both SFT loss and preference odds ratio into a single loss term</figcaption></figure><p id="7640" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">ORPO is particularly useful when you want to fine-tune a pre-trained language model to adapt to a specific domain or task while ensuring that the model’s outputs align with human preferences. It can be applied in scenarios where you have access to a pairwise preference dataset (yw = favored, yl = disfavored, such as the <a class="af nx" href="https://huggingface.co/datasets/argilla/ultrafeedback-binarized-preferences-cleaned" rel="noopener ugc nofollow" target="_blank">UltraFeedback</a> or <a class="af nx" href="https://huggingface.co/datasets/Anthropic/hh-rlhf" rel="noopener ugc nofollow" target="_blank">HH-RLHF</a> datasets. With this in mind, ORPO is designed to be a more efficient and effective alternative to RLHF and DPO, as it does not require a separate reference model, reward model or a two-step fine-tuning approach.</p><h1 id="58eb" class="nz oa fq bf ob oc od gq oe of og gt oh oi oj ok ol om on oo op oq or os ot ou bk">Decision flow chart — which model to choose, which fine-tuning path to pick</h1><p id="5837" class="pw-post-body-paragraph nb nc fq nd b go ov nf ng gr ow ni nj nk ox nm nn no oy nq nr ns oz nu nv nw fj bk">After diving deep into plenty of fine-tuning approaches, the obvious question arises as to which model to start with and which approach to pick best based on specific requirements. The approach for picking the right model for fine-tuning purposes is a two-step approach. The first step is very similar to picking a base model without any fine-tuning intentions, including considerations alongside the following dimensions (not exhaustive):</p><ol class=""><li id="b7ba" class="nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw rc pd pe bk"><strong class="nd fr">Platform to be used:</strong> Every platform comes with a set of models accessible through it. This needs to be taken into consideration. Please note that region-specific differences in model availability can apply. Please check the respective platform’s documentation for more information on this.</li><li id="e713" class="nb nc fq nd b go ph nf ng gr pi ni nj nk pj nm nn no pk nq nr ns pl nu nv nw rc pd pe bk"><strong class="nd fr">Performance:</strong> Organizations should aim to use the leanest model for a specific task. While no generic guidance on this can be given and fine-tuning can significantly uplift a model’s performance (smaller fine-tuned models can outperform larger general-purpose models), leveraging evaluation results of base models can be helpful as an indicator.</li><li id="2fc5" class="nb nc fq nd b go ph nf ng gr pi ni nj nk pj nm nn no pk nq nr ns pl nu nv nw rc pd pe bk"><strong class="nd fr">Budget (TCO):</strong> In general, larger models require more compute and potentially multi-GPU instances for training and serving across multiple accelerators. This has a direct impact on factors like training and inference cost, complexity of training and inference, resources and skills required, etc., as part of TCO along a model’s entire lifecycle. This needs to be aligned with the short- and long-term budget allocated.</li><li id="9881" class="nb nc fq nd b go ph nf ng gr pi ni nj nk pj nm nn no pk nq nr ns pl nu nv nw rc pd pe bk"><strong class="nd fr">Licensing model: </strong>Models, wether proprietary or open-source ones come with licensing constraints depending on the domain of usage and commercial model to be used. This needs to be taken into account.</li><li id="c8ea" class="nb nc fq nd b go ph nf ng gr pi ni nj nk pj nm nn no pk nq nr ns pl nu nv nw rc pd pe bk"><strong class="nd fr">Governance, Ethics, Responsible AI: </strong>Every organisation has compliance guidelines alongside these dimensions. This needs to be considered in the model’s choice.</li></ol><p id="c273" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk"><em class="ny">Example: An organisation might decide to consider LLaMA 2 models and rule out the usage of proprietary models like Anthropic Claude or AI21Labs Jurassic based on evaluation results of the base models. Further, they decide to only use the 7B-parameter version of this model to be able to train and serve them on single GPU instances.</em></p><p id="c7de" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">The second step is concerned with narrowing down the initial selection of models to 1-few models to be taken into consideration for the experimenting phase. The final decision on which specific approach to choose is dependent on the desired entry point into the fine-tuning lifecycle of language models illustrated in the below figure.</p><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj rd"><img src="../Images/c1306adc65c5bbb291a06e167f44c76c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oJo9ho30RXukpN4SbuffFA.png"/></div></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">Figure 21: Decision flow chart for domain adaptation through fine-tuning</figcaption></figure><p id="4aea" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">Thereby, the following dimensions need to be taken into consideration:</p><ol class=""><li id="bc85" class="nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw rc pd pe bk"><strong class="nd fr">Task to be performed: </strong>Different use cases require specific model behaviour. While for some use cases a simple text-completion model (next-token-prediction) might be sufficient, most use cases require task-specific behaviour like chattiness, instruction-following or other task-specific behaviour. To meet this requirement, we can take a working backwards approach from the desired task to be performed. This means we need to define our specific fine-tuning journey to end at a model aligned to this specific task. With regards to the illustration this implies that the model must — aligned with the desired model behaviour — end in the blue, orange or green circle while the fine-tuning journey is defined alongside the possible paths of the flow diagram.</li><li id="dc90" class="nb nc fq nd b go ph nf ng gr pi ni nj nk pj nm nn no pk nq nr ns pl nu nv nw rc pd pe bk"><strong class="nd fr">Choose the right starting point (as long as reasonable): </strong>While we should be very clear on where our fine-tuning journey should end, we can start anywhere in the flow diagram by picking a respective base model. This however needs to be reasonable — in times of model hubs with millions of published models, it can make sense to check if the fine-tuning step has not already been performed by someone else who shared the resulting model, especially when considering popular models in combination with open-source datasets.</li><li id="f79c" class="nb nc fq nd b go ph nf ng gr pi ni nj nk pj nm nn no pk nq nr ns pl nu nv nw rc pd pe bk"><strong class="nd fr">Fine-tuning is an iterative, potentially recursive process:</strong> It is possible to perform multiple subsequent fine-tuning jobs on the way to our desired model. However, please note that catastrophic forgetting is something we need to keep in mind as models can’t encode an infinite amount of information in their weights. To mitigate this, you can leverage parameter-efficient fine-tuning approaches like LoRA as shown in this <a class="af nx" href="https://arxiv.org/abs/2405.09673" rel="noopener ugc nofollow" target="_blank">paper</a> and <a class="af nx" href="https://medium.com/towards-data-science/leveraging-qlora-for-fine-tuning-of-task-fine-tuned-models-without-catastrophic-forgetting-d9bcd594cff4" rel="noopener">blog</a>.</li><li id="5a19" class="nb nc fq nd b go ph nf ng gr pi ni nj nk pj nm nn no pk nq nr ns pl nu nv nw rc pd pe bk"><strong class="nd fr">Task-specific performance uplift targeted:</strong> Fine-tuning is performed to uplift a model’s performance in a specific task. If we are looking for performance uplift in linguistic patterns (domain-specific language, acronyms, etc.) or information implicitly contained in your training data, continued pre-training is the right choice. If we want to uplift performance towards a specific task, supervised fine-tuning should be chosen. If we want to align your model behaviour towards our actual users, human preference alignment is the right choice.</li><li id="f38d" class="nb nc fq nd b go ph nf ng gr pi ni nj nk pj nm nn no pk nq nr ns pl nu nv nw rc pd pe bk"><strong class="nd fr">Data availability: </strong>Training data will also influence which path we choose. In general, organisations hold larger amounts of unlabelled textual data is as opposed to labelled data, and acquiring labelled data can be an expensive task. This dimension needs to be taken into consideration when navigating through the flow chart.</li></ol><p id="be98" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">With this working backwards approach alongside the above flow chart we can identify the model to start with and the path to take while traversing the fine-tuning flow diagram.</p><p id="c677" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">To make this a bit more obvious we are providing two examples:</p><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj re"><img src="../Images/ad42bd3807216e2d9142c08e6fff9a86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fuoHokE1dXSYVKgXCnSjpA.png"/></div></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">Figure 22: Decision flow chart for example 1</figcaption></figure><p id="03d7" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk"><em class="ny">Example 1: Following the example illustrated in the fine-tuning section above, we could constitute the desire of having an instruct model for our specific use case, aligned to our actual user’s preferences. However, we want to uplift performance in the BioTech domain. Unlabelled data in the form of research papers are available. We choose the LLaMA-2–7b model family as the desired starting point. Since Meta has not published an LLaMA-2–7b instruct model, we start from the text completion model LLaMA-2–7b-base. Then we perform continued pre-training on the corpus of research papers, followed by supervised fine-tuning on an open-source instruct dataset like the dolly-15k dataset. This results in an instruct-fine-tuned BioTech version of LLaMA-2–7B-base, which we call BioLLaMA-2–7b-instruct. In the next step, we want to align the model to our actual users’ preferences. We collect a preference dataset, train a reward model, and use RLHF with PPO to preference-align our model.</em></p><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj rf"><img src="../Images/edea3768ebb2322e1beaa20475944b90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3MQ4daF1pEx59-q73PeVvg.png"/></div></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">Figure 23: Decision flow chart for example 2</figcaption></figure><p id="b051" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk"><em class="ny">Example 2: In this example we are aiming to use a chat model, however aligned to our actual user’s preferences. We choose the LLaMA-2–7b model family as the desired starting point. We figure out that Meta is providing an off-the-shelf chat-fine-tuned model LLaMA-2–7b-chat, which we can use as a starting point. In the next step, we want to align the model to our actual user’s preferences. We collect a preference dataset from our users, train a reward model and use RLHF with PPO to preference-align our model.</em></p><h1 id="d56c" class="nz oa fq bf ob oc od gq oe of og gt oh oi oj ok ol om on oo op oq or os ot ou bk">Conclusion</h1><p id="d0c2" class="pw-post-body-paragraph nb nc fq nd b go ov nf ng gr ow ni nj nk ox nm nn no oy nq nr ns oz nu nv nw fj bk">Generative AI has many exciting use cases for businesses and organizations. However, these applications are usually much more complex than individual consumer uses like generating recipes or speeches. For companies, the AI needs to understand the organization’s specific domain knowledge, processes, and data. It must integrate with existing enterprise systems and applications. And it needs to provide a highly customized experience for different employees and roles while acting in a harmless way. To successfully implement generative AI in an enterprise setting, the technology must be carefully designed and tailored to the unique needs of the organization. Simply using a generic, publicly-trained model won’t be sufficient.</p><p id="fb2c" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">In this blog post we discussed how domain adaptation can help bridging this gap by overcoming situations where a model is confronted with tasks outside of its “comfort zone”. With in-context learning and fine-tuning we dived deep into two powerful approaches for domain adaptation. Finally, we discussed tradeoffs to take when deciding between these approaches.</p><p id="a1c7" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">Successfully bridging this gap between powerful AI capabilities and real-world business requirements is key for unlocking the full potential of generative AI for companies.</p></div></div></div></div>    
</body>
</html>