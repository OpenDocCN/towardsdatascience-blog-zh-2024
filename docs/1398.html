<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Predicting Chicago Taxi Trips with R Time Series Model — BSTS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Predicting Chicago Taxi Trips with R Time Series Model — BSTS</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/predicting-chicago-taxi-trips-with-r-time-series-model-bsts-f857efe38bb4?source=collection_archive---------9-----------------------#2024-06-04">https://towardsdatascience.com/predicting-chicago-taxi-trips-with-r-time-series-model-bsts-f857efe38bb4?source=collection_archive---------9-----------------------#2024-06-04</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="f9a8" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx">Step-by-step tutorial on how to forecast daily number of taxi trips using R time series model</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hd he hf hg hh ab"><div><div class="ab hi"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@leaw77172?source=post_page---byline--f857efe38bb4--------------------------------" rel="noopener follow"><div class="l hj hk by hl hm"><div class="l ed"><img alt="Lea Wu" class="l ep by dd de cx" src="../Images/448f50424d44ca88a8d7187d4ea1ad01.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/1*1cDMmWjtaBw0M-JUPl02Qw.jpeg"/><div class="hn by l dd de em n ho eo"/></div></div></a></div></div><div class="hp ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--f857efe38bb4--------------------------------" rel="noopener follow"><div class="l hq hr by hl hs"><div class="l ed"><img alt="Towards Data Science" class="l ep by br ht cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hn by l br ht em n ho eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hu ab q"><div class="ab q hv"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hw hx bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hy" data-testid="authorName" href="https://medium.com/@leaw77172?source=post_page---byline--f857efe38bb4--------------------------------" rel="noopener follow">Lea Wu</a></p></div></div></div><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hw hx dx"><button class="ib ic ah ai aj ak al am an ao ap aq ar id ie if" disabled="">Follow</button></p></div></div></span></div></div><div class="l ig"><span class="bf b bg z dx"><div class="ab cn ih ii ij"><div class="ik il ab"><div class="bf b bg z dx ab im"><span class="in l ig">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hy ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--f857efe38bb4--------------------------------" rel="noopener follow"><p class="bf b bg z io ip iq ir is it iu iv bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">9 min read</span><div class="iw ix l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Jun 4, 2024</span></div></span></div></span></div></div></div><div class="ab cp iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn"><div class="h k w ea eb q"><div class="kd l"><div class="ab q ke kf"><div class="pw-multi-vote-icon ed in kg kh ki"><div class=""><div class="kj kk kl km kn ko kp am kq kr ks ki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kt ku kv kw kx ky kz"><p class="bf b dy z dx"><span class="kk">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kj lc ld ab q ee le lf" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="lb"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg><p class="bf b dy z dx"><span class="pw-responses-count la lb">1</span></p></button></div></div></div><div class="ab q jo jp jq jr js jt ju jv jw jx jy jz ka kb kc"><div class="lg k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lh an ao ap id li lj lk" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep ll cn"><div class="l ae"><div class="ab cb"><div class="lm ln lo lp lq lr ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk ml"><img src="../Images/b7af5b5c1e6116b13565141cc568b14a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*viU1SflO7X4aizx4"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Photo by <a class="af nc" href="https://unsplash.com/@waldemarbrandt67w?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Waldemar</a> on <a class="af nc" href="https://unsplash.com/?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="ff5c" class="nd ne fq bf nf ng nh gq ni nj nk gt nl nm nn no np nq nr ns nt nu nv nw nx ny bk"><strong class="al">Introduction</strong></h1><p id="85fc" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">Imaging you’re planning marketing strategies for your taxi company or even considering market entry as a new competitor — predicting number of taxi trips in the big cities can be an interesting business problem. Or, if you’re just a curious resident like me, this article is perfect for you to learn how to use the R Bayesian Structural Time Series (BSTS) model to forecast daily taxi trips and uncover fascinating insights.</p><p id="e9ca" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">In this article, I will walk you through the pipeline including data preparation, explorational data analysis, time series modeling, forecast result analysis, and business insight. I aim to predict the daily number of trips for the second half year of 2023.</p><h1 id="c96f" class="nd ne fq bf nf ng nh gq ni nj nk gt nl nm nn no np nq nr ns nt nu nv nw nx ny bk">Data Preparation</h1><p id="2575" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">The data was acquired from the <a class="af nc" href="https://data.cityofchicago.org/Transportation/Taxi-Trips-2013-2023-/wrvz-psew/about_data" rel="noopener ugc nofollow" target="_blank">Chicago Data Portal</a>. (You will find this platform with access to various government data!) On the website, simply find the “Action” drop down list to query data.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk pa"><img src="../Images/afa5031b63d0cff4ce859c2b6ef94921.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Utm5Z7Si_qf2WpAKBgM-5A.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Chicago Data Portal provides query tool to acquire selected data</figcaption></figure><p id="ed08" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Within the query tool, you’ll find filter, group, and column manager tools. You can simply download the raw dataset. However, to save computing complexity, I grouped the data by pickup timestamp to aggregate the count of trips per 15 minutes.</p><blockquote class="pb pc pd"><p id="ef14" class="nz oa pe ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">With exploration of the dataset, I also filtered out the record with 0 trip miles and N/A pickup area code (which means the pickup location is not within Chicago). You should explore the data to decide how you would like to query the data. It should based on the use case of your analysis.</p></blockquote><p id="27b0" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Then, export the processed data. Downloading could take some time !</p><h1 id="8184" class="nd ne fq bf nf ng nh gq ni nj nk gt nl nm nn no np nq nr ns nt nu nv nw nx ny bk">Exploratory Data Analysis</h1><p id="3c2c" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">Understanding the data is the most crucial step to preprocessing and model choices reasoning. In the following part, I dived into different characteristics of the dataset including seasonality, trend, and statistical test for stationary and autocorrelation in the lags.</p><p id="0496" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk"><strong class="ob fr">Seasonality</strong> refers to periodic fluctuations in data that occur at regular intervals. These patterns repeat over a specific period, such as days, weeks, months, or quarters.</p><p id="9366" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">To understand the seasonality, we first aggregate trip counts by date and month to visualize the effect.</p><pre class="mm mn mo mp mq pf pg ph bp pi bb bk"><span id="c816" class="pj ne fq pg b bg pk pl l pm pn">library(lubridate)<br/>library(dplyr)<br/>library(xts)<br/>library(bsts)<br/>library(forecast)<br/>library(tseries)<br/><br/>demand_data &lt;- read.csv("taxi_trip_data.csv")<br/>colnames(demand_data) &lt;- c('trip_cnt','trip_datetime') <br/>demand_data$trip_datetime &lt;- mdy_hms(demand_data$trip_datetime)<br/>demand_data$rounded_day &lt;- floor_date(demand_data$trip_datetime, unit = "day")<br/>demand_data$rounded_month &lt;- floor_date(demand_data$trip_datetime, unit = "month")<br/><br/>monthly_agg &lt;- demand_data %&gt;%<br/>    group_by(rounded_month) %&gt;%<br/>    summarise(<br/>        trip_cnt = sum(trip_cnt, na.rm = TRUE)<br/>)<br/><br/>daily_agg &lt;- demand_data %&gt;%<br/>    group_by(rounded_day) %&gt;%<br/>    summarise(<br/>        trip_cnt = sum(trip_cnt, na.rm = TRUE)<br/>)</span></pre><p id="9045" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">The taxi demand in Chicago peaked in 2014, showed a declining trend with annual seasonality, and was drastically reduced by COVID in 2020.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk po"><img src="../Images/1bbc7b3cd3042eed461fcb8f99beb2b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NuRLeEJbsLic-hWbcKIs5A.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Monthly counts of taxi trips | Graph by author</figcaption></figure><p id="6ac6" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Daily count before COVID suggests weekly seasonality, with higher trip numbers on Fridays and Saturdays.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk pp"><img src="../Images/38bbe9bb0d9800d3e3f26414307bcafa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3Zn2DyCsWdWJBoRnEmv-Hw.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Daily counts of taxi trips | Graph by author</figcaption></figure><p id="5936" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Interestingly, the post-COVID weekly seasonality has shifted, the Thursdays now have the highest demand. This provides hypothesis about COVID intervention.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk pq"><img src="../Images/f4ed985246718ab170e3efce9774ce8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B64uYeJZatnJUL6asaBELg.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Daily counts of taxi trips — post COVID | Graph by author</figcaption></figure><p id="b30c" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk"><strong class="ob fr">Trend</strong> in time series data refers to underlying pattern or tendency of the data to increase, decrease, or remain stable over time. I transformed the dataframe to a time series data for STL decomposition to monitor the trend.</p><pre class="mm mn mo mp mq pf pg ph bp pi bb bk"><span id="a081" class="pj ne fq pg b bg pk pl l pm pn">zoo_data &lt;- zoo(daily_agg$trip_cnt, order.by = daily_agg$rounded_day)<br/>start_time &lt;- as.numeric(format(index(zoo_data)[1], "%Y"))<br/>ts_data &lt;- ts(coredata(zoo_data), start = start_time, frequency = 365)<br/>stl_decomposition &lt;- stl(ts_data, s.window = "periodic")<br/>plot(stl_decomposition)</span></pre><p id="de25" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">The result of STL composition shows that there’s a non-linear trend. The seasonal part also shows a yearly seasonality. After a closer look to the yearly seasonality, I found that Thanksgiving and Christmas have the lowest demand every year.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk pr"><img src="../Images/6946aa414c75e1c21ee29555317fbf4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y-UvbaXq-jG7lCiNK6lIHw.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">STL decomposition | Graph by author</figcaption></figure><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk ps"><img src="../Images/b1277540604725acaa9380fc3216c2a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VbBGeJPXxaJnmQDq7z4rGg.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Daily counts of taxi trips for holidays | Graph by author</figcaption></figure><p id="2eed" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">A time series is considered <strong class="ob fr">stationary</strong> if its statistical properties (e.g. mean, variance, and autocorrelation) remain constant over time. From the above graphs we already know this data is not stationary since it exhibits trends and seasonality. If you would like to be more robust, ADF and KPSS test are usually leveraged to validate the null hypothesis of non-stationary and stationary respectively.</p><pre class="mm mn mo mp mq pf pg ph bp pi bb bk"><span id="c8e3" class="pj ne fq pg b bg pk pl l pm pn">adf.test(zoo_data)<br/>kpss.test(zoo_data)</span></pre><p id="0f7a" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk"><strong class="ob fr">Lag autocorrelation</strong> measures the correlation between a time series and its lagged over successive time intervals. It explains how the current value is related to its past values. By autocorrelation in the lags we can identify patterns and help us select appropriate time series models (For example, understanding the autocorrelation structure helps determine the order of AR and MA components for ARIMA model). The graph shows significant autocorrelations at many lags.</p><pre class="mm mn mo mp mq pf pg ph bp pi bb bk"><span id="f0ef" class="pj ne fq pg b bg pk pl l pm pn">acf(zoo_data)</span></pre><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk pt"><img src="../Images/9b6985ce1bdc7bb4b33f822a210540ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q3ig4v4J3A1-3Nc6s1eJCQ.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">ACF result | Graph by author</figcaption></figure><h1 id="e9c5" class="nd ne fq bf nf ng nh gq ni nj nk gt nl nm nn no np nq nr ns nt nu nv nw nx ny bk">Data Transformation</h1><p id="f107" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">The EDA provided crucial insights into how we should transform and preprocess the data to achieve the best forecasting results.</p><p id="1525" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">COVID changed the time series significantly. It is unreasonable to include data that had changed so much. Here I fit the model on data from 2020 June to 2023 June. This still remains a 6:1 train-test-ratio predicting numbers for the second half of 2023.</p><pre class="mm mn mo mp mq pf pg ph bp pi bb bk"><span id="def1" class="pj ne fq pg b bg pk pl l pm pn">train &lt;- window(zoo_data, start = as.Date("2020-07-01"), end = as.Date("2023-06-30"))<br/>test &lt;- window(zoo_data, start = as.Date("2023-07-01"), end = as.Date("2023-12-31"))</span></pre><p id="2050" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">The non-stationary data shows huge variance and non-linear trend. Here I applied log and differencing transformation to mitigate the effect of these characteristics on the predicting performance.</p><pre class="mm mn mo mp mq pf pg ph bp pi bb bk"><span id="97cb" class="pj ne fq pg b bg pk pl l pm pn">train_log &lt;- log(train + 1) <br/>train_diff &lt;- diff(train, differences = 1)</span></pre><p id="3cf0" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">The following code operates on the log-transformed data, as it yielded better forecasting performance during preliminary tests.</p><h1 id="51d1" class="nd ne fq bf nf ng nh gq ni nj nk gt nl nm nn no np nq nr ns nt nu nv nw nx ny bk">Choosing and Designing the Model</h1><p id="d544" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">Let’s quickly recap the findings from the EDA:</p><ol class=""><li id="d435" class="nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou pu pv pw bk">Multiple Seasonality and Non-Linear Trend</li><li id="8d25" class="nz oa fq ob b go px od oe gr py og oh oi pz ok ol om qa oo op oq qb os ot ou pu pv pw bk">Impact of Holidays and Events: Significant events like holidays affect taxi demand.</li><li id="9e64" class="nz oa fq ob b go px od oe gr py og oh oi pz ok ol om qa oo op oq qb os ot ou pu pv pw bk">Long Prediction Horizon: We need to forecast for 180 days.</li></ol><p id="da93" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Given these characteristics, the Bayesian Structural Time Series (BSTS) model is a suitable choice. The BSTS model decomposes a time series into multiple components using Bayesian methods, capturing the underlying latent variables that evolve over time. The key components typically include:</p><ol class=""><li id="6b95" class="nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou pu pv pw bk">Trend Component</li><li id="0abe" class="nz oa fq ob b go px od oe gr py og oh oi pz ok ol om qa oo op oq qb os ot ou pu pv pw bk">Seasonal Component</li><li id="4748" class="nz oa fq ob b go px od oe gr py og oh oi pz ok ol om qa oo op oq qb os ot ou pu pv pw bk">Regressor Component: Incorporates the influence of external variables that might affect the time series.</li></ol><p id="7819" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">This is the model I used to predict the taxi trips:</p><pre class="mm mn mo mp mq pf pg ph bp pi bb bk"><span id="0079" class="pj ne fq pg b bg pk pl l pm pn">ss &lt;- AddSemilocalLinearTrend(list(), train_log) <br/>ss &lt;- AddSeasonal(ss, train_log, nseasons = 7)<br/>ss &lt;- AddSeasonal(ss, train_log, nseasons = 365)<br/>ss &lt;- AddMonthlyAnnualCycle(ss, train_log)<br/>ss &lt;- AddRegressionHoliday(ss, train_log, holiday_list)<br/>model_log_opti &lt;- bsts(train_log, state.specification = ss, niter = 5000, verbose = TRUE, seed=1014)<br/>summary(model_log_opti)</span></pre><p id="accd" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk"><strong class="ob fr">AddSemilocalLinearTrend()<br/></strong>From the EDA, the trend in our data is not a random walk. Therefore, we use a semi-local linear trend, which assumes the level component moves according to a random walk, but the slope component follows an AR1 process centered on a potentially non-zero value. This is useful for long-term forecasting.</p><p id="4616" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk"><strong class="ob fr">AddSeasonal()<br/></strong>The seasonal model can be thought of as a regression on <code class="cx qc qd qe pg b">nseasons</code> dummy variables. Here we include weekly and yearly seasonality by setting <code class="cx qc qd qe pg b">nseasons</code> to 7 and 365.</p><p id="b034" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk"><strong class="ob fr">AddMonthlyAnnualCycle()<br/></strong>This represents the contribution of each month. Alternatively, you can set <code class="cx qc qd qe pg b">nseasons=12</code> in <code class="cx qc qd qe pg b">AddSeasonal()</code> to address monthly seasonality.</p><p id="ac1d" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk"><strong class="ob fr">AddRegressionHoliday()<br/></strong>Previously in EDA we learned that Thanksgiving and Christmas negatively impact taxi trips. This function estimate the effect of each holiday or events using regression. For this, I asked a friend of mine who is familiar with Chicago (well, ChatGPT of course) for the list of huge holidays and events in Chicago. For example, the Chicago Marathon might boost the number of taxi trips.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk qf"><img src="../Images/b393768f123c8a17fc4627611728e7a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*NtNdBiwjRaf1JJdC"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Photo by <a class="af nc" href="https://unsplash.com/@josephjtwo?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Joseph Two</a> on <a class="af nc" href="https://unsplash.com/?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="f4a8" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Then I set up the date of these dates:</p><pre class="mm mn mo mp mq pf pg ph bp pi bb bk"><span id="e0cd" class="pj ne fq pg b bg pk pl l pm pn">christmas &lt;- NamedHoliday("Christmas")<br/>new_year &lt;- NamedHoliday("NewYear")<br/>thanksgiving &lt;- NamedHoliday("Thanksgiving")<br/>independence_day &lt;- NamedHoliday("IndependenceDay")<br/>labor_day &lt;- NamedHoliday("LaborDay")<br/>memorial_day &lt;- NamedHoliday("MemorialDay")</span></pre><pre class="qg pf pg ph bp pi bb bk"><span id="5923" class="pj ne fq pg b bg pk pl l pm pn">auto.show &lt;- DateRangeHoliday("Auto_show", start = as.Date(c("2013-02-09", "2014-02-08", "2015-02-14", "2016-02-13", "2017-02-11"<br/>                                                             , "2018-02-10", "2019-02-09", "2020-02-08", "2021-07-15", "2022-02-12"<br/>                                                             , "2023-02-11")), <br/>                              end = as.Date(c("2013-02-18", "2014-02-17", "2015-02-22", "2016-02-21", "2017-02-20"<br/>                                                , "2018-02-19", "2019-02-18", "2020-02-17"<br/>                                                , "2021-07-19", "2022-02-21", "2023-02-20")))<br/>st.patrick &lt;- DateRangeHoliday("stPatrick", start = as.Date(c("2013/3/16", "2014/3/15", "2015/3/14", "2016/3/12"<br/>                                                              , "2017/3/11", "2018/3/17", "2019/3/16", "2020/3/14"<br/>                                                              , "2021/3/13", "2022/3/12", "2023/3/11")), <br/>                              end = as.Date(c("2013/3/16", "2014/3/15", "2015/3/14", "2016/3/12"<br/>                                                              , "2017/3/11", "2018/3/17", "2019/3/16", "2020/3/14"<br/>                                                              , "2021/3/13", "2022/3/12", "2023/3/11")))<br/>air.show &lt;- DateRangeHoliday("air_show", start = as.Date(c("2013/8/17", "2014/8/16", "2015/8/15", "2016/8/20"<br/>                                                           , "2017/8/19", "2018/8/18", "2019/8/17"<br/>                                                           , "2021/8/21", "2022/8/20", "2023/8/19")), <br/>                              end = as.Date(c("2013/8/18", "2014/8/17", "2015/8/16", "2016/8/21", "2017/8/20"<br/>                                              , "2018/8/19", "2019/8/18", "2021/8/22", "2022/8/21", "2023/8/20")))<br/>lolla &lt;- DateRangeHoliday("lolla", start = as.Date(c("2013/8/2", "2014/8/1", "2015/7/31", "2016/7/28", "2017/8/3"<br/>                                                     , "2018/8/2", "2019/8/1", "2021/7/29", "2022/7/28", "2023/8/3")), <br/>                              end = as.Date(c("2013/8/4", "2014/8/3", "2015/8/2", "2016/7/31", "2017/8/6", "2018/8/5"<br/>                                              , "2019/8/4", "2021/8/1", "2022/7/31", "2023/8/6")))<br/>marathon &lt;- DateRangeHoliday("marathon", start = as.Date(c("2013/10/13", "2014/10/12", "2015/10/11", "2016/10/9", "2017/10/8"<br/>                                                        , "2018/10/7", "2019/10/13", "2021/10/10", "2022/10/9", "2023/10/8")), <br/>                              end = as.Date(c("2013/10/13", "2014/10/12", "2015/10/11", "2016/10/9", "2017/10/8"<br/>                                                        , "2018/10/7", "2019/10/13", "2021/10/10", "2022/10/9", "2023/10/8")))</span></pre><p id="34a6" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk"><strong class="ob fr">DateRangeHoliday()</strong> allows us to define events that happen at different date each year or last for multiple days. <strong class="ob fr">NameHoliday()</strong> helps with federal holidays.</p><p id="ab12" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Then, define the list of these holidays for the AddRegressionHoliday() attribute:</p><pre class="mm mn mo mp mq pf pg ph bp pi bb bk"><span id="ed1b" class="pj ne fq pg b bg pk pl l pm pn">holiday_list &lt;- list(auto.show, st.patrick, air.show, lolla, marathon<br/>              , christmas, new_year, thanksgiving, independence_day<br/>              , labor_day, memorial_day)</span></pre><p id="357b" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">I found <a class="af nc" href="https://rdrr.io/cran/bsts/" rel="noopener ugc nofollow" target="_blank">this website</a> very helpful in exploring different component and parameters.</p><p id="e430" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">The fitted result shows that the model well captured the component of the time series.</p><pre class="mm mn mo mp mq pf pg ph bp pi bb bk"><span id="ab8e" class="pj ne fq pg b bg pk pl l pm pn">fitted_values &lt;- as.numeric(residuals.bsts(model_log_opti, mean.only=TRUE)) + as.numeric(train_log)<br/>train_hat &lt;- exp(fitted_values) - 1<br/>plot(as.numeric(train), type = "l", col = "blue", ylim=c(500, 30000), main="Fitted result")<br/>lines(train_hat, col = "red")<br/>legend("topleft", legend = c("Actual value", "Fitted value"), col = c("blue", "red"), lty = c(1, 1), lwd = c(1, 1))</span></pre><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk qh"><img src="../Images/b576d2357e61f3ddf4250f0411881c7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tMwPwaHnXudutvNFXRskOg.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">BSTS fitted result | Graph by author</figcaption></figure><p id="fe94" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">In the residual analysis, although the residuals have a mean of zero, there is still some remaining seasonality. Additionally, the residuals exhibit autocorrelation in the first few lags.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk qi"><img src="../Images/d64d6b173446bfd6ddc3ca48f4c698ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cCBYgudlo0YcrWWvM1J5xQ.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Residuals of the BSTS model | Graph by author</figcaption></figure><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk qj"><img src="../Images/7293dfe6dc3863a302bb60fcc5c3ee44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F6qLnZkD449PIEYjEUxmEw.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">ACF on the residuals | Graph by author</figcaption></figure><p id="bf87" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">However, when comparing these results to the original time series, it is evident that the model has successfully captured most of the seasonality, holiday effects, and trend components. This indicates that the BSTS model effectively addresses the key patterns in the data, leaving only minor residual structures to be examined further.</p><h1 id="bc0a" class="nd ne fq bf nf ng nh gq ni nj nk gt nl nm nn no np nq nr ns nt nu nv nw nx ny bk">Forecast Result and Insights</h1><p id="ffdb" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">Now, let’s evaluate the forecast results of the model. Remember to transform the predicted values, as the model provides logged values.</p><pre class="mm mn mo mp mq pf pg ph bp pi bb bk"><span id="6857" class="pj ne fq pg b bg pk pl l pm pn">horizon &lt;- length(test)<br/>pred_log_opti &lt;- predict(model_log_opti, horizon = horizon, burn = SuggestBurn(.1, ss))<br/>forecast_values_log_opti &lt;- exp(pred_log_opti$mean) - 1</span></pre><pre class="qg pf pg ph bp pi bb bk"><span id="5823" class="pj ne fq pg b bg pk pl l pm pn">plot(as.numeric(test), type = "l", col = "blue", ylim=c(500, 30000), main="Forecast result", xlab="Time", ylab="Trip count")<br/>lines(forecast_values_log_opti, col = "red")<br/>legend("topleft", legend = c("Actual value", "Forecast value"), col = c("blue", "red"), lty = c(1, 1), lwd = c(1, 1))</span></pre><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk qk"><img src="../Images/803a984dd3e43f5e5a266f683c0bfc31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Hfvh1zfyQdv75Kir2AIMAg.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Forecast and actual values | Graph by author</figcaption></figure><p id="8bd6" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">The model achieves a Mean Absolute Percentage Error (MAPE) of 9.76%, successfully capturing the seasonality and the effects of holidays.</p><p id="a75e" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">The analysis of holiday and event effects offers valuable insights for business strategies. The following graphs illustrate the impact of holiday regressions:</p><pre class="mm mn mo mp mq pf pg ph bp pi bb bk"><span id="1aad" class="pj ne fq pg b bg pk pl l pm pn">PlotHoliday(thanksgiving, model_log_opti)<br/>PlotHoliday(marathon, model_log_opti)</span></pre><p id="5602" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">The day before federal holidays has a significantly negative impact on the number of trips. For example, both Thanksgiving Day and the day before show a noticeable drop in taxi trips. This reduction could be due to lower demand or limited supply. Companies can investigate these reasons further and develop strategies to address them.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk ql"><img src="../Images/5ed25fee6cac1731c856652074a8653c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ez1Kj6G-ZDG0nvfWmEKoAw.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Effect of holidays | Graph by author</figcaption></figure><p id="7fc3" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Contrary to the initial hypothesis, major events like the Chicago Marathon did not show a significant increase in taxi demand. This suggests that demand during such events may not be as high as expected. Conducting customer segmentation research can help identify specific groups that might be influenced by events, revealing potential opportunities for targeted marketing and services. Breaking down the data by sub-areas in Chicago can also provide better insights. The impact of events might vary across different neighborhoods, and understanding these variations can help tailor localized strategies.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk qm"><img src="../Images/e05d717e523498bd6efcec7599df58d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Lo39DrioY27dyZNKX8H8eg.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Effect of events | Graph by author</figcaption></figure><h1 id="f0d1" class="nd ne fq bf nf ng nh gq ni nj nk gt nl nm nn no np nq nr ns nt nu nv nw nx ny bk">Conclusion</h1><p id="d60d" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">So this is how you can use BSTS model to predict Chicago taxi rides! You can experiment different state component or parameters to see how the model fit the data differently. Hope you enjoy the process and please give me claps if you find this article helpful!</p></div></div></div></div>    
</body>
</html>