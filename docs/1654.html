<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>LLM Alignment: Reward-Based vs Reward-Free Methods</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>LLM Alignment: Reward-Based vs Reward-Free Methods</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/llm-alignment-reward-based-vs-reward-free-methods-ef0c0f6e8d88?source=collection_archive---------0-----------------------#2024-07-05">https://towardsdatascience.com/llm-alignment-reward-based-vs-reward-free-methods-ef0c0f6e8d88?source=collection_archive---------0-----------------------#2024-07-05</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="e917" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx">Optimization methods for LLM alignment</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hd he hf hg hh ab"><div><div class="ab hi"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@anishdubey?source=post_page---byline--ef0c0f6e8d88--------------------------------" rel="noopener follow"><div class="l hj hk by hl hm"><div class="l ed"><img alt="Anish Dubey" class="l ep by dd de cx" src="../Images/f85f17fb79718c819b4bd1c9a16338a7.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/0*dFpHgf3fMyv1h6Ut."/><div class="hn by l dd de em n ho eo"/></div></div></a></div></div><div class="hp ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--ef0c0f6e8d88--------------------------------" rel="noopener follow"><div class="l hq hr by hl hs"><div class="l ed"><img alt="Towards Data Science" class="l ep by br ht cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hn by l br ht em n ho eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hu ab q"><div class="ab q hv"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hw hx bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hy" data-testid="authorName" href="https://medium.com/@anishdubey?source=post_page---byline--ef0c0f6e8d88--------------------------------" rel="noopener follow">Anish Dubey</a></p></div></div></div><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hw hx dx"><button class="ib ic ah ai aj ak al am an ao ap aq ar id ie if" disabled="">Follow</button></p></div></div></span></div></div><div class="l ig"><span class="bf b bg z dx"><div class="ab cn ih ii ij"><div class="ik il ab"><div class="bf b bg z dx ab im"><span class="in l ig">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hy ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--ef0c0f6e8d88--------------------------------" rel="noopener follow"><p class="bf b bg z io ip iq ir is it iu iv bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">10 min read</span><div class="iw ix l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Jul 5, 2024</span></div></span></div></span></div></div></div><div class="ab cp iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn"><div class="h k w ea eb q"><div class="kd l"><div class="ab q ke kf"><div class="pw-multi-vote-icon ed in kg kh ki"><div class=""><div class="kj kk kl km kn ko kp am kq kr ks ki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kt ku kv kw kx ky kz"><p class="bf b dy z dx"><span class="kk">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kj lc ld ab q ee le lf" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="lb"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg><p class="bf b dy z dx"><span class="pw-responses-count la lb">1</span></p></button></div></div></div><div class="ab q jo jp jq jr js jt ju jv jw jx jy jz ka kb kc"><div class="lg k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lh an ao ap id li lj lk" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep ll cn"><div class="l ae"><div class="ab cb"><div class="lm ln lo lp lq lr ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><h1 id="47ad" class="mj mk fq bf ml mm mn gq mo mp mq gt mr ms mt mu mv mw mx my mz na nb nc nd ne bk">Context</h1><p id="8f13" class="pw-post-body-paragraph nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fj bk">Language models have demonstrated remarkable abilities in producing a wide range of compelling text based on prompts provided by users. However, defining what constitutes “good” text is challenging, as it often depends on personal preferences and the specific context. For instance, in storytelling, creativity is key; in crafting informative content, accuracy and reliability are crucial; and when generating code, ensuring it runs correctly is essential. Hence the <em class="ob">“LLM alignment problem,” </em>which refers to the challenge of ensuring that large language models (LLMs) act in ways that are consistent with human values, intentions, and preferences.</p><p id="a998" class="pw-post-body-paragraph nf ng fq nh b go oc nj nk gr od nm nn no oe nq nr ns of nu nv nw og ny nz oa fj bk">Designing a loss function that captures the diverse qualities we value in text — like creativity, accuracy, or executability — is highly complex and often impractical. Concepts like these are not differentiable and hence not back-propagated and cannot be trained upon with simple next token generation.</p><p id="1dfc" class="pw-post-body-paragraph nf ng fq nh b go oc nj nk gr od nm nn no oe nq nr ns of nu nv nw og ny nz oa fj bk">Imagine if we could harness human feedback to evaluate the quality of generated text or, even better, use that feedback as a guiding loss function to improve the model’s performance. This concept is at the heart of Reinforcement Learning from Human Feedback (RLHF). By applying reinforcement learning techniques, RLHF allows us to fine-tune language models based on direct human feedback, aligning the models more closely with nuanced human values and expectations. This approach has opened up new possibilities for training language models that are not only more responsive but also more aligned with the complexity of human preferences.</p><p id="6761" class="pw-post-body-paragraph nf ng fq nh b go oc nj nk gr od nm nn no oe nq nr ns of nu nv nw og ny nz oa fj bk">Below, we will aim to learn more about RLHF via reward-based and then about RLHF via reward-free methods.</p><h1 id="e5c2" class="mj mk fq bf ml mm mn gq mo mp mq gt mr ms mt mu mv mw mx my mz na nb nc nd ne bk">What is Reinforcement learning through human feedback (RLHF) via a reward-based system?</h1><p id="8681" class="pw-post-body-paragraph nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fj bk">Let’s go through Reinforcement learning through human feedback (RLHF). It consist of 3 main stages:</p><ol class=""><li id="ff3d" class="nf ng fq nh b go oc nj nk gr od nm nn no oe nq nr ns of nu nv nw og ny nz oa oh oi oj bk">Supervised fine tuning</li><li id="4a8f" class="nf ng fq nh b go ok nj nk gr ol nm nn no om nq nr ns on nu nv nw oo ny nz oa oh oi oj bk">Reward modeling phase</li><li id="350c" class="nf ng fq nh b go ok nj nk gr ol nm nn no om nq nr ns on nu nv nw oo ny nz oa oh oi oj bk">RL fine-tuning phase</li></ol><h2 id="6ed7" class="op mk fq bf ml oq or os mo ot ou ov mr no ow ox oy ns oz pa pb nw pc pd pe pf bk"><strong class="al">Supervised fine tuning</strong></h2><p id="e63d" class="pw-post-body-paragraph nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fj bk">RLHF is a pre-trained model which is fine tuned already on a high quality data set. Its objective is simple i.e. when given an input (prompt), it produces an output. The ultimate objective here is to further fine tune this model to produce output according to human preference. Hence, let’s call this a <strong class="nh fr"><em class="ob">base model</em> </strong>for reference. Currently, this model is a vanilla base model which is not aware of any human preference.</p><h2 id="7678" class="op mk fq bf ml oq or os mo ot ou ov mr no ow ox oy ns oz pa pb nw pc pd pe pf bk"><strong class="al">Reward Modelling Phase</strong></h2><p id="a69c" class="pw-post-body-paragraph nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fj bk"><em class="ob">Reward model innovation:</em> This is where the new innovation begins on how reward models are incorporated into RLHF. The idea behind the reward model is that a new LLM model, which can be same as the above mentioned base model, will have the ability to generate human preference score. The reason it is similar to a large language model is because this model also needs to understand the language semantics before it can rate if an output is human preferred or not. Since the reward is scalar, we add a linear layer on top of LLM to generate a scalar score in terms of human preference.</p><p id="69b0" class="pw-post-body-paragraph nf ng fq nh b go oc nj nk gr od nm nn no oe nq nr ns of nu nv nw og ny nz oa fj bk"><em class="ob">Data collection phase</em>: This is done from the supervised fine tuning stage where the base model is asked to generate 2 outputs for a given text. Example: For an input token x, two output tokens are generated, y1 and y2 by the base model. These outputs are shown to human raters to rate and human preference is recorded for each individual output.</p><p id="3ca0" class="pw-post-body-paragraph nf ng fq nh b go oc nj nk gr od nm nn no oe nq nr ns of nu nv nw og ny nz oa fj bk"><em class="ob">Training phase:</em> Once the data sample is collected from the data collection phase, the <strong class="nh fr"><em class="ob">reward model</em></strong> is trained with the following prompt. <em class="ob">“Given the following input: &lt;x&gt;, LLM generated &lt;y&gt; output. Can you rate the performance of the output?”. </em>The model will output r(reward) and we already know the actual value of reward r1 from the data collection phase. Now, this can be back-propagated with the loss function and the model can be trained. Below is the objective loss function which the model optimises for through back-propagation:</p><figure class="pj pk pl pm pn po pg ph paragraph-image"><div class="pg ph pi"><img src="../Images/1f126383029386b638a86cd909424bcd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1116/format:webp/0*Zoin1QS_7i5h8Lkl"/></div><figcaption class="pq pr ps pg ph pt pu bf b bg z dx">Equation from this paper: <a class="af pv" href="https://arxiv.org/pdf/2305.18290" rel="noopener ugc nofollow" target="_blank">https://arxiv.org/pdf/2305.18290</a></figcaption></figure><p id="222a" class="pw-post-body-paragraph nf ng fq nh b go oc nj nk gr od nm nn no oe nq nr ns of nu nv nw og ny nz oa fj bk"><em class="ob">Notation:</em></p><ul class=""><li id="a0de" class="nf ng fq nh b go oc nj nk gr od nm nn no oe nq nr ns of nu nv nw og ny nz oa pw oi oj bk">rΦ(x, y): a reward model parameterized by Φ which estimates the reward. Parameterized means we don’t know the actual value and this needs to be optimized from the above equation. This is the reward LLM model itself. Mostly, the LLM parameters are frozen here and only few parameters are left to change. Most important layer is the linear layer added at the top. This does most of the learning to rate the score of output.</li><li id="ac8e" class="nf ng fq nh b go ok nj nk gr ol nm nn no om nq nr ns on nu nv nw oo ny nz oa pw oi oj bk">Ɗ: A dataset of triplets (<em class="ob">x, yw, yl</em>) where <em class="ob">x</em>: input, <em class="ob">yw</em>: the winner output and <em class="ob">yl</em>: the loser output</li><li id="6431" class="nf ng fq nh b go ok nj nk gr ol nm nn no om nq nr ns on nu nv nw oo ny nz oa pw oi oj bk">σ: the sigmoid function which maps the difference in reward to a probability (0–1)</li><li id="9b84" class="nf ng fq nh b go ok nj nk gr ol nm nn no om nq nr ns on nu nv nw oo ny nz oa pw oi oj bk">∑(x, y,w yl) ~Ɗ means <em class="ob">x, yw, yl</em> are all sampled from Ɗ</li></ul><p id="9f49" class="pw-post-body-paragraph nf ng fq nh b go oc nj nk gr od nm nn no oe nq nr ns of nu nv nw og ny nz oa fj bk"><em class="ob">Example scenario:</em> Imagine you’re training a reward model to evaluate responses. You have pairs of responses to a given prompt, and human feedback tells you which response is better. For context, <em class="ob">x</em>(“What is the capital of France?”), you have <em class="ob">yw</em>(“The capital of France is Paris.”) as winner and <em class="ob">yl</em>(“The capital of France is Berlin.” ) as loser. The reward model should eventually learn to give higher reward for “The capital of France is Paris.” output when compared to “The capital of France is Berlin.” output if “What is the capital of France?” input is given.</p><h2 id="0930" class="op mk fq bf ml oq or os mo ot ou ov mr no ow ox oy ns oz pa pb nw pc pd pe pf bk"><strong class="al">RL fine-tuning phase</strong></h2><p id="89fc" class="pw-post-body-paragraph nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fj bk"><em class="ob">Reinforcement learning idea: </em>Now the <em class="ob">base model</em> and <em class="ob">reward model</em> are trained, the idea is how to leverage reward model score and update base model parameters to reflect human preference. <strong class="nh fr"><em class="ob">Since the reward model outputs a scalar score and is not differentiable, we cannot use simple back-propogation to update the base model param</em></strong>. Hence, we need other techniques to update the base model. This is where reinforcement learning comes which helps the base model to change the params through reward model score. This is done through PPO (proximal policy optimization). Understanding the core architecture of PPO is not required to grasp this concept and hence we will not cover it here but on a high level, the idea is that PPO can use scalar score to update base model parameters. Now let’s understand how base and reward models are incorporated to make base models learn human preference.</p><p id="0823" class="pw-post-body-paragraph nf ng fq nh b go oc nj nk gr od nm nn no oe nq nr ns of nu nv nw og ny nz oa fj bk"><em class="ob">RL fine-tuning idea: </em>In reinforcement learning, we have action, space and rewards. The idea is to come up with a policy which any action agent can take in the space which maximizes the reward. This becomes quite complicated but in a simplified sense, π is the policy which is our base LLM model only. <em class="ob">Πref</em> means the base model and <em class="ob">ΠӨ</em> means a different LLM optimal model which we are trying to generate. We need to find <em class="ob">ΠӨ</em> (the base model’s neural network weights will be fine-tuned) which gives human-preferred output. It’s just that we don’t know ΠӨ and the idea is to find this optimal model.</p><p id="ab79" class="pw-post-body-paragraph nf ng fq nh b go oc nj nk gr od nm nn no oe nq nr ns of nu nv nw og ny nz oa fj bk"><em class="ob">RL training and feedback loop phase: </em>An input x is given to 2 policy models, <em class="ob">Πref</em> (baseline model) and <em class="ob">ΠӨ</em> (optimal model which we are trying to generate). Initially both models are kept the same. Input x to two models individually will give two outputs correspondingly. The output from ΠӨ model is also fed to reward model (input: x, output: y; as discussed above) and asked to output the reward score which is rΦ(x, y). Now we have 3 things, output from the baseline model, output from the optimal model, and a reward score from the optimal model. There are 2 things we are optimizing here, one is to <em class="ob">maximize the reward </em>because eventually we want the model to be as close as human preference and another is to <em class="ob">minimize the divergence from baseline model</em>. Maximizing the reward is easy since it is already a scalar quantity but how do we minimize the divergence of baseline and optimal model. Here we use <em class="ob">“Kullback–Leibler divergence” </em>which estimates the difference between 2 continuous probability distributions. Let’s take a deeper look into the objective loss function</p><figure class="pj pk pl pm pn po pg ph paragraph-image"><div class="pg ph px"><img src="../Images/62b0ece843cfa43a76a0035f21c15b45.png" data-original-src="https://miro.medium.com/v2/resize:fit:1194/format:webp/0*1le3PeZdDY9EKU5q"/></div><figcaption class="pq pr ps pg ph pt pu bf b bg z dx">Equation from this paper: <a class="af pv" href="https://arxiv.org/pdf/2305.18290" rel="noopener ugc nofollow" target="_blank">https://arxiv.org/pdf/2305.18290</a></figcaption></figure><p id="80d1" class="pw-post-body-paragraph nf ng fq nh b go oc nj nk gr od nm nn no oe nq nr ns of nu nv nw og ny nz oa fj bk"><em class="ob">Notation</em>:</p><ul class=""><li id="95c9" class="nf ng fq nh b go oc nj nk gr od nm nn no oe nq nr ns of nu nv nw og ny nz oa pw oi oj bk">rΦ(x, y): a scalar value for an input x and output y (from optimal model). To be explicit, output from the optimal model is fed into the reward model.</li><li id="da1a" class="nf ng fq nh b go ok nj nk gr ol nm nn no om nq nr ns on nu nv nw oo ny nz oa pw oi oj bk">Dkl (ΠӨ (y | x) || Πref (y | x)): This computes the <em class="ob">Kullback–Leibler divergence </em>between 2 probability distributions<em class="ob">. </em>Each token from each model is a probability distribution. KL estimates how far the distribution is from each other.</li><li id="b86f" class="nf ng fq nh b go ok nj nk gr ol nm nn no om nq nr ns on nu nv nw oo ny nz oa pw oi oj bk">β : Hyperparameter which is used to determine how important it is to have optimal model close to baseline model.</li></ul><p id="fb28" class="pw-post-body-paragraph nf ng fq nh b go oc nj nk gr od nm nn no oe nq nr ns of nu nv nw og ny nz oa fj bk"><em class="ob">Example scenario: </em>Imagine you are asking (“What is the capital of France?”), Πref (baseline model) says: “The capital of France is Berlin.” and ΠӨ (optimal model) “There are 3 capitals, Paris, Versailles, and Lyon, but Paris is considered as the official capital”. Now rΦ(“x: What is the capital…”, “y: There are 3 capital..”) should give low score as it is less human-preferred and Kullback–Leibler divergence of (ΠӨ (y | x) || Πref (y | x)) should be high as well since the probability distribution space differs for both individual output. Hence the loss will be high from both terms. We do not want the model to only optimize for reward but also stay closer to the baseline model and hence both the terms are used to optimize the reward. In the next iteration with learning let’s say, ΠӨ (optimal model) says “The capital of France is Delhi”, in this case model learned to stay closer to Πref (baseline model) and output the format closer to baseline model but the reward component will still be lower. Hopefully, in the third iteration ΠӨ (optimal model) should be able to learn and output “The capital of France is Paris” with higher reward and model output aligning closely with baseline model.</p><p id="b925" class="pw-post-body-paragraph nf ng fq nh b go oc nj nk gr od nm nn no oe nq nr ns of nu nv nw og ny nz oa fj bk">The below diagram helps illustrate the logic. I will also highly recommend to go through <a class="af pv" href="https://huggingface.co/blog/rlhf" rel="noopener ugc nofollow" target="_blank">RLHF link</a> from hugging face.</p><figure class="pj pk pl pm pn po pg ph paragraph-image"><div role="button" tabindex="0" class="pz qa ed qb bh qc"><div class="pg ph py"><img src="../Images/751a0f87e0b251e69b17e3e65bad459e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eYiO-NvBLzY39mS1R4odKA.png"/></div></div><figcaption class="pq pr ps pg ph pt pu bf b bg z dx">Image by author, inspired by <a class="af pv" href="https://huggingface.co/blog/rlhf" rel="noopener ugc nofollow" target="_blank">https://huggingface.co/blog/rlhf</a></figcaption></figure><h1 id="ebb4" class="mj mk fq bf ml mm mn gq mo mp mq gt mr ms mt mu mv mw mx my mz na nb nc nd ne bk">What is Reinforcement learning through human feedback (RLHF) via reward-free method ?</h1><p id="9165" class="pw-post-body-paragraph nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fj bk">With RLHF using a reward-based method in mind, let’s move to the reward-free method. According to the paper:<em class="ob"> “our key insight is to leverage an analytical mapping from reward functions to optimal policies, which enables us to transform a loss function over reward functions into a loss function over policies. This change-of-variables approach avoids fitting an explicit, standalone reward model, while still optimizing under existing models of human preferences”. </em>Very complicated to understand, but let’s try to break this down in simple phases in the next section.</p><p id="3596" class="pw-post-body-paragraph nf ng fq nh b go oc nj nk gr od nm nn no oe nq nr ns of nu nv nw og ny nz oa fj bk"><em class="ob">Reward-free method’s key idea: </em>In RLHF, a separate new reward model is trained which is expensive and costly to maintain. Is there any mechanism to avoid training a new reward model and use the existing base model to achieve a new optimal model? This is exactly what reward-free method does i.e. it avoids training a new reward model and in turn changes the equation in such a way that there is no reward model term in the loss function of DPO (Direct preference optimization). One way to think about this is that we need to reach optimal model policy(ΠӨ) from base model (Πref). It can be reached <strong class="nh fr"><em class="ob">either through optimizing the reward function space which helps build a proxy to reach optimal model policy or directly learning a mapping function from reward to policy and in turn optimize for policy itself</em></strong>. This is exactly what the authors have tried by removing the reward function component in loss function and substitute it directly by model policy parameter. This is what the author meant when they say <em class="ob">“leverage an analytical mapping from reward function to optimal policies …. into a loss function over policies”. </em>This is the core innovation of the paper.</p><p id="fd8c" class="pw-post-body-paragraph nf ng fq nh b go oc nj nk gr od nm nn no oe nq nr ns of nu nv nw og ny nz oa fj bk"><em class="ob">DPO training and feedback loop phase: </em>Using Πref (baseline model), input x is given and asked to produce 2 outputs (y1 and y2). All x, y1 and y2 are used by human raters to decide winning yw and losing yl. Offline data set is collected with triplet information &lt;x, yw and yl&gt;. With this information, we know what the winning (human preferred) and losing (human not preferred) answers are. Now, the same input x is given to 2 policy (models) Πref (baseline model) and ΠӨ (optimal model). Initially both models are kept the same for training purposes. Input x to two models individually will give two outputs correspondingly. We compute how far the output is from winning and losing answers from both reference and optimal model through <em class="ob">“Kullback–Leibler divergence”</em>. Let’s take a deeper look into the objective loss function</p><p id="6bb4" class="pw-post-body-paragraph nf ng fq nh b go oc nj nk gr od nm nn no oe nq nr ns of nu nv nw og ny nz oa fj bk"><em class="ob">Equation</em></p><figure class="pj pk pl pm pn po pg ph paragraph-image"><div role="button" tabindex="0" class="pz qa ed qb bh qc"><div class="pg ph qd"><img src="../Images/62aa446dfe029c31daee49c2f31cb3fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*p9TAHz79nLpfEGYj"/></div></div><figcaption class="pq pr ps pg ph pt pu bf b bg z dx">Equation from <a class="af pv" href="https://arxiv.org/pdf/2305.18290" rel="noopener ugc nofollow" target="_blank">https://arxiv.org/pdf/2305.18290</a></figcaption></figure><ul class=""><li id="1482" class="nf ng fq nh b go oc nj nk gr od nm nn no oe nq nr ns of nu nv nw og ny nz oa pw oi oj bk">ΠӨ (yw | x) -&gt; Given x(input), how far is the corresponding output of the model say youtput from the winning output yw. Output youtput and yw are probability distributions and differences among both will be computed through “<em class="ob">Kullback–Leibler divergence</em>”. This will be a scalar value. Also this is computed for both models with different combinations of Πref (yw | x), Πref (yl | x), ΠӨ (yw | x) and ΠӨ (yl | x).</li><li id="4218" class="nf ng fq nh b go ok nj nk gr ol nm nn no om nq nr ns on nu nv nw oo ny nz oa pw oi oj bk">β : Hyperparameter which is used to determine how important it is to have optimal model close to baseline model.</li></ul><figure class="pj pk pl pm pn po pg ph paragraph-image"><div role="button" tabindex="0" class="pz qa ed qb bh qc"><div class="pg ph qe"><img src="../Images/830c15cf030cab6633ac5e530ebb7464.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YxJNKie51EYbrkz6SAyEfw.png"/></div></div><figcaption class="pq pr ps pg ph pt pu bf b bg z dx">Image by author, inspired by <a class="af pv" href="https://huggingface.co/blog/rlhf" rel="noopener ugc nofollow" target="_blank">https://huggingface.co/blog/rlhf</a></figcaption></figure><h1 id="8d15" class="mj mk fq bf ml mm mn gq mo mp mq gt mr ms mt mu mv mw mx my mz na nb nc nd ne bk">Conclusion</h1><ul class=""><li id="4631" class="nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa pw oi oj bk">Naturally, the question comes down to which one is better, RLHF through reward-based method using PPO or reward-free method using DPO. There is no right answer to this question. A recent paper compares <em class="ob">“Is DPO superior to PPO for LLM alignment”</em> (paper <a class="af pv" href="https://arxiv.org/pdf/2404.10719" rel="noopener ugc nofollow" target="_blank">link</a>) and concludes that PPO is generally better than DPO and that DPO suffers more heavily from out-of-distribution data. “Out-of-distribution” data means the human preference data is different from the baseline trained data. This can happen if base model training is done on some dataset while preference output is done for some other dataset.</li><li id="13d6" class="nf ng fq nh b go ok nj nk gr ol nm nn no om nq nr ns on nu nv nw oo ny nz oa pw oi oj bk">Overall, the research is still out on which one is better while we have seen companies like OpenAI, Anthropic, Meta leverage both RLHF via PPO and DPO as a tool for LLM alignment.</li></ul><h1 id="dc0a" class="mj mk fq bf ml mm mn gq mo mp mq gt mr ms mt mu mv mw mx my mz na nb nc nd ne bk">Reference</h1><ul class=""><li id="6df5" class="nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa pw oi oj bk">Direct Preference Optimization: Your Language Model is Secretly a Reward Model: <a class="af pv" href="https://arxiv.org/pdf/2305.18290" rel="noopener ugc nofollow" target="_blank">https://arxiv.org/pdf/2305.18290</a></li><li id="1002" class="nf ng fq nh b go ok nj nk gr ol nm nn no om nq nr ns on nu nv nw oo ny nz oa pw oi oj bk">Is DPO Superior to PPO for LLM Alignment? A Comprehensive Study <a class="af pv" href="https://arxiv.org/pdf/2404.10719" rel="noopener ugc nofollow" target="_blank">https://arxiv.org/pdf/2404.10719</a></li><li id="d914" class="nf ng fq nh b go ok nj nk gr ol nm nn no om nq nr ns on nu nv nw oo ny nz oa pw oi oj bk">Hugging face RLHF article <a class="af pv" href="https://huggingface.co/blog/rlhf" rel="noopener ugc nofollow" target="_blank">https://huggingface.co/blog/rlhf</a></li></ul></div></div></div></div>    
</body>
</html>