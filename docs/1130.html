<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Prompt Like a Data Scientist: Auto Prompt Optimization and Testing with DSPy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Prompt Like a Data Scientist: Auto Prompt Optimization and Testing with DSPy</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/prompt-like-a-data-scientist-auto-prompt-optimization-and-testing-with-dspy-ff699f030cb7?source=collection_archive---------0-----------------------#2024-05-05">https://towardsdatascience.com/prompt-like-a-data-scientist-auto-prompt-optimization-and-testing-with-dspy-ff699f030cb7?source=collection_archive---------0-----------------------#2024-05-05</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="cad6" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx">Applying machine learning methodology to prompt building</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hd he hf hg hh ab"><div><div class="ab hi"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@jyipkl?source=post_page---byline--ff699f030cb7--------------------------------" rel="noopener follow"><div class="l hj hk by hl hm"><div class="l ed"><img alt="Julian Yip" class="l ep by dd de cx" src="../Images/2afc0ac6c4dcccaa57ffe70b2f5a14d0.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/1*mymOKtsl9xup838ppb5J6g.jpeg"/><div class="hn by l dd de em n ho eo"/></div></div></a></div></div><div class="hp ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--ff699f030cb7--------------------------------" rel="noopener follow"><div class="l hq hr by hl hs"><div class="l ed"><img alt="Towards Data Science" class="l ep by br ht cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hn by l br ht em n ho eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hu ab q"><div class="ab q hv"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hw hx bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hy" data-testid="authorName" href="https://medium.com/@jyipkl?source=post_page---byline--ff699f030cb7--------------------------------" rel="noopener follow">Julian Yip</a></p></div></div></div><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hw hx dx"><button class="ib ic ah ai aj ak al am an ao ap aq ar id ie if" disabled="">Follow</button></p></div></div></span></div></div><div class="l ig"><span class="bf b bg z dx"><div class="ab cn ih ii ij"><div class="ik il ab"><div class="bf b bg z dx ab im"><span class="in l ig">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hy ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--ff699f030cb7--------------------------------" rel="noopener follow"><p class="bf b bg z io ip iq ir is it iu iv bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">40 min read</span><div class="iw ix l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">May 5, 2024</span></div></span></div></span></div></div></div><div class="ab cp iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn"><div class="h k w ea eb q"><div class="kd l"><div class="ab q ke kf"><div class="pw-multi-vote-icon ed in kg kh ki"><div class=""><div class="kj kk kl km kn ko kp am kq kr ks ki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kt ku kv kw kx ky kz"><p class="bf b dy z dx"><span class="kk">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kj lc ld ab q ee le lf" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="lb"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg><p class="bf b dy z dx"><span class="pw-responses-count la lb">9</span></p></button></div></div></div><div class="ab q jo jp jq jr js jt ju jv jw jx jy jz ka kb kc"><div class="lg k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lh an ao ap id li lj lk" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep ll cn"><div class="l ae"><div class="ab cb"><div class="lm ln lo lp lq lr ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk ml"><img src="../Images/266f734fa2fbe701359eb41fa9d06e9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s_Xn52jw2opmaN0mm3lDxA.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Drawn by the author</figcaption></figure><p id="4943" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">LLMs are grounded in data science, but our approach to prompt engineering might strike us as unscientific:</p><ol class=""><li id="58ff" class="nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa bk"><strong class="ne fr">Manual prompt engineering which does not generalize well</strong>: LLMs are highly sensitive to how they are prompted for each task, so we need to handcraft long strings of instructions and demonstrations. This requires not only time-consuming prompt writing process, but the given string prompt might not generalize to different pipelines or across different LMs, data domains, or even inputs. To deal with a new problem we often need to handcraft a new prompt.</li><li id="ef66" class="nc nd fq ne b go ob ng nh gr oc nj nk nl od nn no np oe nr ns nt of nv nw nx ny nz oa bk"><strong class="ne fr">Lack framework to conduct testing</strong>: Instead of the usual train-test regime in typical data science applications to pick the model which maximizes a certain metric like AUC, with LLMs we arrive at the best prompt via trial and error, often without an objective metric to say how well our model is performing. Thus no matter how we try to improve the prompt, we can’t confidently say how reliable our application is.</li></ol><p id="06e2" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">To address these issues, Stanford NLP has published a <a class="af og" href="https://arxiv.org/abs/2310.03714" rel="noopener ugc nofollow" target="_blank">paper</a> introducing a new approach with prompt writing: instead of manipulating free-form strings, we generate prompts via modularized programming. The associated library, called DSPy, can be found <a class="af og" href="https://github.com/stanfordnlp/dspy" rel="noopener ugc nofollow" target="_blank">here</a>.</p><p id="9c2b" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">This article aims to show how this “prompt programming” is done, to go deeper in explaining what’s happening behind the optimization process. The code can also be found <a class="af og" href="https://github.com/yip-kl/llm_dspy_tutorial" rel="noopener ugc nofollow" target="_blank">here</a>.</p><p id="399e" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk"><em class="oh">(Speaking of which, you might also find coaxing LLMs to output properly formatted JSON very unscientific too, I have also written an article about how to address this with Function Calling. Check it out !)</em></p><div class="oi oj ok ol om on"><a rel="noopener follow" target="_blank" href="/build-autonomous-ai-agents-with-function-calling-0bb483753975?source=post_page-----ff699f030cb7--------------------------------"><div class="oo ab ig"><div class="op ab co cb oq or"><h2 class="bf fr hw z io os iq ir ot it iv fp bk">Build Autonomous AI Agents with Function Calling</h2><div class="ou l"><h3 class="bf b hw z io os iq ir ot it iv dx">Transform your chatbot into an agent that can interact with external APIs</h3></div><div class="ov l"><p class="bf b dy z io os iq ir ot it iv dx">towardsdatascience.com</p></div></div><div class="ow l"><div class="ox l oy oz pa ow pb lr on"/></div></div></a></div></div></div></div><div class="ab cb pc pd pe pf" role="separator"><span class="pg by bm ph pi pj"/><span class="pg by bm ph pi pj"/><span class="pg by bm ph pi"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="de79" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">We will spend some time to go over the environment preparation. Afterwards, this article is divided into 3 sections:</p><ol class=""><li id="eede" class="nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa bk"><strong class="ne fr"><em class="oh">Basic concept of DSPy: Signature and Module</em></strong><br/>Basic building blocks in DSPy for describing your task, and the prompt technique used</li><li id="ccfd" class="nc nd fq ne b go ob ng nh gr oc nj nk nl od nn no np oe nr ns nt of nv nw nx ny nz oa bk"><strong class="ne fr"><em class="oh">Optimizer: Train our prompt as with machine learning</em></strong><br/>How DSPy optimizes your prompt with bootstrapping</li><li id="6157" class="nc nd fq ne b go ob ng nh gr oc nj nk nl od nn no np oe nr ns nt of nv nw nx ny nz oa bk"><strong class="ne fr"><em class="oh">Full fledged example: Prompt comparison with LLM</em></strong><br/>Applying the rigour of traditional machine learning for prompt testing and selection</li></ol><p id="50dd" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">We are now ready to start!</p><h1 id="81e9" class="pk pl fq bf pm pn po gq pp pq pr gt ps pt pu pv pw px py pz qa qb qc qd qe qf bk">Preparation</h1><ol class=""><li id="b685" class="nc nd fq ne b go qg ng nh gr qh nj nk nl qi nn no np qj nr ns nt qk nv nw nx ny nz oa bk">Head over to <a class="af og" href="https://github.com/yip-kl/llm_dspy_tutorial" rel="noopener ugc nofollow" target="_blank">Github</a> to clone my code. The contents in my article can be found in the <code class="cx ql qm qn qo b">dspy_tutorial</code> Notebook.</li><li id="969a" class="nc nd fq ne b go ob ng nh gr oc nj nk nl od nn no np oe nr ns nt of nv nw nx ny nz oa bk">Please also create and activate a virtual environment, then <code class="cx ql qm qn qo b">pip install -r requirements.txt</code> to install the required packages. If you are on Windows, please also install Windows C++ build tools which are required for the <code class="cx ql qm qn qo b">phoneix</code> library with which we will observe how DSPy works</li><li id="7970" class="nc nd fq ne b go ob ng nh gr oc nj nk nl od nn no np oe nr ns nt of nv nw nx ny nz oa bk">My code uses OpenRouter, which allow us to access OpenAI API in blocked regions. Please set up your <code class="cx ql qm qn qo b">OPENROUTER_API_KEY</code> as environment variable, and execute the code under the “Preparation” block. Alternatively, you can use <code class="cx ql qm qn qo b">dspy.OpenAI</code> class directly and define Open AI API key if it works for you</li></ol><h1 id="aec5" class="pk pl fq bf pm pn po gq pp pq pr gt ps pt pu pv pw px py pz qa qb qc qd qe qf bk">Basic concept of DSPy: Signature and Module</h1><p id="595c" class="pw-post-body-paragraph nc nd fq ne b go qg ng nh gr qh nj nk nl qi nn no np qj nr ns nt qk nv nw nx fj bk">They are the building blocks of prompt programming in DSPy. Let’s dive in to see what they are about!</p><h2 id="05f1" class="qp pl fq bf pm qq qr qs pp qt qu qv ps nl qw qx qy np qz ra rb nt rc rd re rf bk"><strong class="al">Signatures: Specification of input/output</strong></h2><p id="36ed" class="pw-post-body-paragraph nc nd fq ne b go qg ng nh gr qh nj nk nl qi nn no np qj nr ns nt qk nv nw nx fj bk">A signature is the most fundamental building block in DSPy’s prompt programming, which is a declarative specification of input/output behavior of a DSPy module. Signatures allow you to tell the LM <strong class="ne fr">what </strong>it needs to do, rather than specify how we should ask the LM to do it.</p><p id="c090" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Say we want to obtain the sentiment of a sentence, traditionally we might write such prompt:</p><pre class="mm mn mo mp mq rg qo rh bp ri bb bk"><span id="a945" class="rj pl fq qo b bg rk rl l rm rn">Given a sentence {the_sentence_itself}, deduce its sentiment.</span></pre><p id="ef80" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">But in DSPy, we can achieve the same by defining a <code class="cx ql qm qn qo b">signature</code> as below. At its most basic form, a signature is as simple as a single string separating the inputs and output with a <code class="cx ql qm qn qo b">-&gt;</code></p><p id="7fc5" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk"><em class="oh">Note: Code in this section contains those referred from DSPy’s documentation of </em><a class="af og" href="https://dspy-docs.vercel.app/docs/building-blocks/signatures" rel="noopener ugc nofollow" target="_blank"><em class="oh">Signatures</em></a></p><pre class="mm mn mo mp mq rg qo rh bp ri bb bk"><span id="73f6" class="rj pl fq qo b bg rk rl l rm rn"># Define signature<br/>signature = 'sentence -&gt; sentiment'<br/>classify = dspy.Predict(signature)<br/><br/># Run<br/>sentence = "it's a charming and often affecting journey."<br/>classify(sentence=sentence).sentiment</span></pre><pre class="ro rg qo rh bp ri bb bk"><span id="51d7" class="rj pl fq qo b bg rk rl l rm rn">--- Output ---<br/>"I'm sorry, but I am unable to determine the sentiment of the sentence without additional context or information. If you provide me with more details or specific criteria for determining sentiment, I would be happy to assist you further."</span></pre><p id="3d59" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">The prediction is not a good one, but for instructional purpose let’s inspect what was the issued prompt.</p><pre class="mm mn mo mp mq rg qo rh bp ri bb bk"><span id="0474" class="rj pl fq qo b bg rk rl l rm rn"># This is how we inpect the last issued prompt to the LM<br/>lm.inspect_history(n=1)</span></pre><pre class="ro rg qo rh bp ri bb bk"><span id="b8b4" class="rj pl fq qo b bg rk rl l rm rn">--- Output ---<br/><strong class="qo fr">Given the fields `sentence`, produce the fields `sentiment`.<br/><br/>---<br/><br/>Follow the following format.<br/><br/>Sentence: ${sentence}<br/>Sentiment: ${sentiment}</strong><br/><br/>---<br/><br/>Sentence: it's a charming and often affecting journey.<br/>Sentiment: I'm sorry, but I am unable to determine the sentiment of the sentence without additional context or information. If you provide me with more details or specific criteria for determining sentiment, I would be happy to assist you further.</span></pre><p id="4a63" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">We can see the above prompt is assembled from the <code class="cx ql qm qn qo b">sentence -&gt; sentiment</code> signature. But how did DSPy came up with the <code class="cx ql qm qn qo b">Given the fields…</code> in the prompt?</p><p id="560a" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Inspecting the <code class="cx ql qm qn qo b">dspy.Predict()</code> class, we see when we pass to it our signature, the signature will be parsed as the <code class="cx ql qm qn qo b">signature</code> attribute of the class, and subsequently assembled as a prompt. The <code class="cx ql qm qn qo b">instructions</code> is a default one hardcoded in the DSPy library.</p><pre class="mm mn mo mp mq rg qo rh bp ri bb bk"><span id="6d0a" class="rj pl fq qo b bg rk rl l rm rn"># Check the variables of the `classify` object,<br/># which was created by passing the signature to `dspy.Predict()` class<br/>vars(classify)</span></pre><pre class="ro rg qo rh bp ri bb bk"><span id="78be" class="rj pl fq qo b bg rk rl l rm rn">--- Output ---<br/>{<br/> <strong class="qo fr">'signature': StringSignature(sentence -&gt; sentiment<br/>     instructions='Given the fields `sentence`, produce the fields `sentiment`.'<br/>     sentence = Field(annotation=str required=True json_schema_extra={'__dspy_field_type': 'input', 'prefix': 'Sentence:', 'desc': '${sentence}'})<br/>     sentiment = Field(annotation=str required=True json_schema_extra={'__dspy_field_type': 'output', 'prefix': 'Sentiment:', 'desc': '${sentiment}'})<br/> )</strong>,<br/> 'some_other_attributes': 'xxx'}</span></pre><p id="c90a" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">What if we want to provide a more detailed description of our objective to the LLM, beyond the basic <code class="cx ql qm qn qo b">sentence -&gt; sentiment</code> signature? To do so we need to provide a more verbose signature in form of <strong class="ne fr">Class-based DSPy Signatures</strong>.</p><p id="ef0a" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Notice we provide no explicit instruction as to how the LLM should obtain the sentiment. We are just describing the task at hand, and also the expected output.</p><pre class="mm mn mo mp mq rg qo rh bp ri bb bk"><span id="9f1f" class="rj pl fq qo b bg rk rl l rm rn"># Define signature in Class-based form<br/>class Emotion(dspy.Signature):<br/>    # Describe the task<br/>    """Classify emotions in a sentence."""<br/>    <br/>    sentence = dspy.InputField()<br/>    # Adding description to the output field<br/>    sentiment = dspy.OutputField(desc="Possible choices: sadness, joy, love, anger, fear, surprise.")<br/><br/>classify_class_based = dspy.Predict(Emotion)<br/><br/># Issue prediction<br/>classify_class_based(sentence=sentence).sentiment</span></pre><pre class="ro rg qo rh bp ri bb bk"><span id="6010" class="rj pl fq qo b bg rk rl l rm rn">--- Output ---<br/>Sentence: It's a charming and often affecting journey.<br/>Sentiment: <strong class="qo fr">joy</strong></span></pre><p id="2d48" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">It is now outputting a much better prediction! Again we see the descriptions we made when defining the class-based DSPy signatures are assembled into a prompt.</p><pre class="mm mn mo mp mq rg qo rh bp ri bb bk"><span id="e007" class="rj pl fq qo b bg rk rl l rm rn"><strong class="qo fr">Classify emotions in a sentence.</strong><br/><br/>---<br/><br/>Follow the following format.<br/><br/>Sentence: ${sentence}<br/><strong class="qo fr">Sentiment: Possible choices: sadness, joy, love, anger, fear, surprise.</strong><br/><br/>---<br/><br/>Sentence: it's a charming and often affecting journey.<br/>Sentiment: Sentence: It's a charming and often affecting journey.<br/>Sentiment: joy</span></pre><p id="bd94" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">This might do for simple tasks, but advanced applications might require sophisticated prompting techniques like Chain of Thought or ReAct. In DSPy these are implemented as <strong class="ne fr">Modules</strong></p><h2 id="eafb" class="qp pl fq bf pm qq qr qs pp qt qu qv ps nl qw qx qy np qz ra rb nt rc rd re rf bk"><strong class="al">Modules: Abstracting prompting techniques</strong></h2><p id="4692" class="pw-post-body-paragraph nc nd fq ne b go qg ng nh gr qh nj nk nl qi nn no np qj nr ns nt qk nv nw nx fj bk">We may be used to apply “prompting techniques” by hardcoding phrases like <code class="cx ql qm qn qo b">let’s think step by step</code> in our prompt . In DSPy these prompting techniques are abstracted as <strong class="ne fr">Modules</strong>. Let’s see below for an example of applying our class-based signature to the <code class="cx ql qm qn qo b">dspy.ChainOfThought</code> module</p><pre class="mm mn mo mp mq rg qo rh bp ri bb bk"><span id="ef41" class="rj pl fq qo b bg rk rl l rm rn"># Apply the class-based signature to Chain of Thought<br/>classify_cot = dspy.ChainOfThought(Emotion)<br/><br/># Run<br/>classify_cot(sentence=sentence).sentiment<br/><br/># Inspect prompt<br/>lm.inspect_history(n=1)</span></pre><pre class="ro rg qo rh bp ri bb bk"><span id="01cd" class="rj pl fq qo b bg rk rl l rm rn">--- Output ---<br/>Classify emotions in a sentence.<br/><br/>---<br/><br/>Follow the following format.<br/><br/>Sentence: ${sentence}<br/><strong class="qo fr">Reasoning: Let's think step by step in order to ${produce the sentiment}. We ...</strong><br/>Sentiment: Possible choices: sadness, joy, love, anger, fear, surprise.<br/><br/>---<br/><br/>Sentence: it's a charming and often affecting journey.<br/>Reasoning: Let's think step by step in order to Sentence: It's a charming and often affecting journey.<br/><strong class="qo fr">Reasoning: Let's think step by step in order to determine the sentiment. The use of the words "charming" and "affecting" suggests positive emotions associated with enjoyment and emotional impact. We can infer that the overall tone is positive and heartwarming, evoking feelings of joy and possibly love.</strong><br/>Sentiment: Joy, love</span></pre><p id="52fd" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Notice how the “Reasoning: Let’s think step by step…” phrase is added to our prompt, and the quality of our prediction is even better now.</p><p id="a295" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">According to DSPy’s <a class="af og" href="https://dspy-docs.vercel.app/docs/building-blocks/modules" rel="noopener ugc nofollow" target="_blank">documentation</a>, as of time of writing DSPy provides the following prompting techniques in form of Modules. Notice the <code class="cx ql qm qn qo b">dspy.Predict</code> we used in the initial example is also a Module, representing no prompting technique!</p><ol class=""><li id="68f4" class="nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa bk"><code class="cx ql qm qn qo b">dspy.Predict</code>: Basic predictor. Does not modify the signature. Handles the key forms of learning (i.e., storing the instructions and demonstrations and updates to the LM).</li><li id="54ab" class="nc nd fq ne b go ob ng nh gr oc nj nk nl od nn no np oe nr ns nt of nv nw nx ny nz oa bk"><code class="cx ql qm qn qo b">dspy.ChainOfThought</code>: Teaches the LM to think step-by-step before committing to the signature’s response.</li><li id="1edb" class="nc nd fq ne b go ob ng nh gr oc nj nk nl od nn no np oe nr ns nt of nv nw nx ny nz oa bk"><code class="cx ql qm qn qo b">dspy.ProgramOfThought</code>: Teaches the LM to output code, whose execution results will dictate the response.</li><li id="2c84" class="nc nd fq ne b go ob ng nh gr oc nj nk nl od nn no np oe nr ns nt of nv nw nx ny nz oa bk"><code class="cx ql qm qn qo b">dspy.ReAct</code>: An agent that can use tools to implement the given signature.</li><li id="f5b0" class="nc nd fq ne b go ob ng nh gr oc nj nk nl od nn no np oe nr ns nt of nv nw nx ny nz oa bk"><code class="cx ql qm qn qo b">dspy.MultiChainComparison</code>: Can compare multiple outputs from ChainOfThought to produce a final prediction.</li></ol><p id="470e" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">It also have some function-style modules:</p><p id="8fc4" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">6. <code class="cx ql qm qn qo b">dspy.majority</code>: Can do basic voting to return the most popular response from a set of predictions.</p><p id="29f1" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">You can check out further examples in <a class="af og" href="https://dspy-docs.vercel.app/api/category/modules" rel="noopener ugc nofollow" target="_blank">each module’s respective guide</a>.</p><h2 id="eaaa" class="qp pl fq bf pm qq qr qs pp qt qu qv ps nl qw qx qy np qz ra rb nt rc rd re rf bk">Chaining the modules</h2><p id="51db" class="pw-post-body-paragraph nc nd fq ne b go qg ng nh gr qh nj nk nl qi nn no np qj nr ns nt qk nv nw nx fj bk">On the other hand, what about RAG? We can chain the modules together to deal with bigger problems!</p><p id="0a9e" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">First we define a retriever, for our example we use a ColBERT retriever getting information from Wikipedia Abstracts 2017</p><pre class="mm mn mo mp mq rg qo rh bp ri bb bk"><span id="590e" class="rj pl fq qo b bg rk rl l rm rn"># Configure retriever<br/>rm = dspy.ColBERTv2(url='http://20.102.90.50:2017/wiki17_abstracts')<br/>dspy.settings.configure(rm = rm)</span></pre><p id="ebbc" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Then we define the <code class="cx ql qm qn qo b">RAG</code> class inherited from <code class="cx ql qm qn qo b">dspy.Module</code>. It needs two methods:</p><ul class=""><li id="fdf3" class="nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx rp nz oa bk">The <code class="cx ql qm qn qo b">__init__</code> method will simply declare the sub-modules it needs: <code class="cx ql qm qn qo b">dspy.Retrieve</code> and <code class="cx ql qm qn qo b">dspy.ChainOfThought</code>. The latter is defined to implement our <code class="cx ql qm qn qo b">context, question -&gt; answer</code> signature.</li><li id="b32f" class="nc nd fq ne b go ob ng nh gr oc nj nk nl od nn no np oe nr ns nt of nv nw nx rp nz oa bk">The <code class="cx ql qm qn qo b">forward</code> method will describe the control flow of answering the question using the modules we have.</li></ul><p id="6782" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk"><em class="oh">Note: Code in this section is borrowed from </em><a class="af og" href="https://github.com/stanfordnlp/dspy/blob/main/intro.ipynb" rel="noopener ugc nofollow" target="_blank"><em class="oh">DSPy’s introduction notebook</em></a></p><pre class="mm mn mo mp mq rg qo rh bp ri bb bk"><span id="b54a" class="rj pl fq qo b bg rk rl l rm rn"># Define a class-based signature<br/>class GenerateAnswer(dspy.Signature):<br/>    """Answer questions with short factoid answers."""<br/><br/>    context = dspy.InputField(desc="may contain relevant facts")<br/>    question = dspy.InputField()<br/>    answer = dspy.OutputField(desc="often between 1 and 5 words")<br/><br/># Chain different modules together to retrieve information from Wikipedia Abstracts 2017, then pass it as context for Chain of Thought to generate an answer<br/>class RAG(dspy.Module):<br/>    def __init__(self, num_passages=3):<br/>        super().__init__()<br/>        self.retrieve = dspy.Retrieve(k=num_passages)<br/>        self.generate_answer = dspy.ChainOfThought(GenerateAnswer)<br/>    <br/>    def forward(self, question):<br/>        context = self.retrieve(question).passages<br/>        answer = self.generate_answer(context=context, question=question)<br/>        return answer</span></pre><p id="841c" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Then we make use of the class to perform a RAG</p><pre class="mm mn mo mp mq rg qo rh bp ri bb bk"><span id="f826" class="rj pl fq qo b bg rk rl l rm rn"># Initilize our RAG class<br/>rag = RAG()<br/><br/># Define a question and pass it into the RAG class<br/>my_question = "When was the first FIFA World Cup held?"<br/>rag(question=my_question).answer</span></pre><pre class="ro rg qo rh bp ri bb bk"><span id="820c" class="rj pl fq qo b bg rk rl l rm rn">--- Output ---<br/>'1930'</span></pre><p id="1d60" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Inspecting the prompt, we see that 3 passages retrieved from Wikipedia Abstracts 2017 is interpersed as context for Chain of Thought generation</p><pre class="mm mn mo mp mq rg qo rh bp ri bb bk"><span id="b594" class="rj pl fq qo b bg rk rl l rm rn">Answer questions with short factoid answers.<br/><br/>---<br/><br/>Follow the following format.<br/><br/>Context: may contain relevant facts<br/><br/>Question: ${question}<br/><br/>Reasoning: Let's think step by step in order to ${produce the answer}. We ...<br/><br/>Answer: often between 1 and 5 words<br/><br/>---<br/><br/><strong class="qo fr">Context:<br/>[1] «History of the FIFA World Cup | The FIFA World Cup was first held in 1930, when FIFA president Jules Rimet decided to stage an international football tournament. The inaugural edition, held in 1930, was contested as a final tournament of only thirteen teams invited by the organization. Since then, the World Cup has experienced successive expansions and format remodeling to its current 32-team final tournament preceded by a two-year qualifying process, involving over 200 teams from around the world.»<br/>[2] «1950 FIFA World Cup | The 1950 FIFA World Cup, held in Brazil from 24 June to 16 July 1950, was the fourth FIFA World Cup. It was the first World Cup since 1938, the planned 1942 and 1946 competitions having been cancelled owing to World War II. It was won by Uruguay, who had won the inaugural competition in 1930, clinching the cup by beating the hosts Brazil 2–1 in the deciding match of the four-team final group (this was the only tournament not decided by a one-match final). It was also the first tournament where the trophy was referred to as the Jules Rimet Cup, to mark the 25th anniversary of Jules Rimet's presidency of FIFA.»<br/>[3] «1970 FIFA World Cup | The 1970 FIFA World Cup was the ninth FIFA World Cup, the quadrennial international football championship for men's national teams. Held from 31 May to 21 June in Mexico, it was the first World Cup tournament staged in North America, and the first held outside Europe and South America. Teams representing 75 nations from all six populated continents entered the competition, and its qualification rounds began in May 1968. Fourteen teams qualified from this process to join host nation Mexico and defending champions England in the sixteen-team final tournament. El Salvador, Israel, and Morocco made their first appearances at the final stage, and Peru their first since 1930.»</strong><br/><br/>Question: When was the first FIFA World Cup held?<br/><br/>Reasoning: Let's think step by step in order to Answer: 1930<br/><br/>Answer: 1930</span></pre><p id="31c3" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">The above examples might not seem much. At its most basic application the DSPy seemed only doing nothing that can’t be done with f-string, but it actually present a paradigm shift for prompt writing, as this brings <strong class="ne fr">modularity</strong> to prompt composition!</p><p id="f417" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">First we describe our objective with <code class="cx ql qm qn qo b">Signature</code>, then we apply different prompting techniques with <code class="cx ql qm qn qo b">Modules</code>. To test different prompt techniques for a given problem, we can simply switch the modules used and compare their results, rather than hardcoding the “let’s think step by step…” (for Chain of Thought) or “you will interleave Thought, Action, and Observation steps” (for ReAct) phrases. The benefit of modularity will be demonstrated later in this article with a full-fledged example.</p><p id="792d" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">The power of DSPy is not only limited to modularity, it can also optimize our prompt based on training samples, and test it systematically. We will be exploring this in the next section!</p><h1 id="4661" class="pk pl fq bf pm pn po gq pp pq pr gt ps pt pu pv pw px py pz qa qb qc qd qe qf bk"><strong class="al">Optimizer: Train our prompt as with machine learning</strong></h1><p id="eb17" class="pw-post-body-paragraph nc nd fq ne b go qg ng nh gr qh nj nk nl qi nn no np qj nr ns nt qk nv nw nx fj bk">In this section we try to optimize our prompt for a RAG application with DSPy.</p><p id="4246" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Taking Chain of Thought as an example, beyond just adding the “let’s think step by step” phrase, we can boost its performance with a few tweaks:</p><ol class=""><li id="592f" class="nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa bk">Adding suitable examples (aka <strong class="ne fr">few-shot learning</strong>).</li><li id="f532" class="nc nd fq ne b go ob ng nh gr oc nj nk nl od nn no np oe nr ns nt of nv nw nx ny nz oa bk">Furthermore, we can <strong class="ne fr">bootstrap demonstrations of reasoning</strong> to teach the LMs to apply proper reasoning to deal with the task at hand.</li></ol><p id="39e8" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Doing this manually would be highly time-consuming and can’t generalize to different problems, but with DSPy this can be done automatically. Let’s dive in!</p><h2 id="b0dd" class="qp pl fq bf pm qq qr qs pp qt qu qv ps nl qw qx qy np qz ra rb nt rc rd re rf bk">Preparation</h2><p id="93cf" class="pw-post-body-paragraph nc nd fq ne b go qg ng nh gr qh nj nk nl qi nn no np qj nr ns nt qk nv nw nx fj bk"><strong class="ne fr">#1: Loading test data</strong>: Like machine learning, to train our prompt we need to prepare our training and test datasets. Initially this cell will take around 20 minutes to run.</p><pre class="mm mn mo mp mq rg qo rh bp ri bb bk"><span id="f881" class="rj pl fq qo b bg rk rl l rm rn">from dspy.datasets.hotpotqa import HotPotQA<br/><br/># For demonstration purpose we will use a small subset of the HotPotQA dataset, 20 for training and testing each<br/>dataset = HotPotQA(train_seed=1, train_size=20, eval_seed=2023, dev_size=20, test_size=0)<br/>trainset = [x.with_inputs('question') for x in dataset.train]<br/>testset = [x.with_inputs('question') for x in dataset.dev]<br/><br/>len(trainset), len(testset)</span></pre><p id="b5bb" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Inspecting our dataset, which is basically a set of question-and-answer pairs</p><pre class="mm mn mo mp mq rg qo rh bp ri bb bk"><span id="1d45" class="rj pl fq qo b bg rk rl l rm rn">Example({'question': 'At My Window was released by which American singer-songwriter?', 'answer': 'John Townes Van Zandt'}) (input_keys={'question'})</span></pre><p id="258d" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk"><strong class="ne fr">#2 Set up Phoenix for observability</strong>: To facilitate understanding of the optimization process, we launch <strong class="ne fr">Phoenix </strong>to observe our DSPy application, which is a great tool for LLM observability in general! I will skip pasting the code here, but you can execute it in the notebook.</p><p id="b78b" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Note: If you are on Windows, please also install Windows C++ Build Tools <a class="af og" href="https://visualstudio.microsoft.com/visual-cpp-build-tools/" rel="noopener ugc nofollow" target="_blank">here</a>, which is necessary for Phoenix</p><h2 id="3f08" class="qp pl fq bf pm qq qr qs pp qt qu qv ps nl qw qx qy np qz ra rb nt rc rd re rf bk">Prompt Optimization</h2><p id="5d0f" class="pw-post-body-paragraph nc nd fq ne b go qg ng nh gr qh nj nk nl qi nn no np qj nr ns nt qk nv nw nx fj bk">Then we are ready to see what this opimitzation is about! To “train” our prompt, we need 3 things:</p><ol class=""><li id="5e8d" class="nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa bk">A training set. We’ll just use our 20 question–answer examples from <code class="cx ql qm qn qo b">trainset</code>.</li><li id="1b20" class="nc nd fq ne b go ob ng nh gr oc nj nk nl od nn no np oe nr ns nt of nv nw nx ny nz oa bk">A metric for validation. Here we use the native <code class="cx ql qm qn qo b">dspy.evaluate.answer_exact_match</code> which checks if the predicted answer exactly matches the right answer (questionable but suffice for demonstration). For real-life applications you can define your own evaluation criteria</li><li id="54b2" class="nc nd fq ne b go ob ng nh gr oc nj nk nl od nn no np oe nr ns nt of nv nw nx ny nz oa bk">A specific <strong class="ne fr">Optimizer</strong> (formerly teleprompter). The DSPy library includes a number of optimization strategies and you can check them out <a class="af og" href="https://dspy-docs.vercel.app/docs/building-blocks/optimizers" rel="noopener ugc nofollow" target="_blank">here</a>. For our example we use <code class="cx ql qm qn qo b">BootstrapFewShot</code>. Instead of describing it here with lengthy description, I will demonstrate it with code subsequently</li></ol><p id="4409" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Now we train our prompt.</p><pre class="mm mn mo mp mq rg qo rh bp ri bb bk"><span id="65ce" class="rj pl fq qo b bg rk rl l rm rn">from dspy.teleprompt import BootstrapFewShot<br/><br/># Simple optimizer example. I am explicitly stating the default values for max_bootstrapped_demos and max_labeled_demos for demonstration purposes<br/>optimizer = BootstrapFewShot(metric=dspy.evaluate.answer_exact_match, max_bootstrapped_demos=4)<br/><br/># Compile!<br/>compiled_rag = optimizer.compile(RAG(), trainset=trainset)</span></pre><pre class="ro rg qo rh bp ri bb bk"><span id="b680" class="rj pl fq qo b bg rk rl l rm rn">--- Successful execution should show this output ---<br/>Bootstrapped 4 full traces after n examples in round 0</span></pre><p id="4be7" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Before using the <code class="cx ql qm qn qo b">compiled_rag</code> to answer a question, let’s see what went behind the scene during the training process (aka compile). We launch the Phoenix console by visiting <code class="cx ql qm qn qo b">http://localhost:6006/</code> in browser</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk rq"><img src="../Images/d94f1dbe53ce5b4aef6a0ea2796a406a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*URfCpJOJ_YlxC9kR"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">14 calls during “compile”</figcaption></figure><p id="0de8" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">In my run I have made 14 calls using the <code class="cx ql qm qn qo b">RAG</code> class, in each of those calls we post a question to LM to obtain a prediction.</p><p id="3bec" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Refer to the result summary table in my notebook, 4 correct answers are made from these 14 samples, thus reaching our <code class="cx ql qm qn qo b">max_bootstrapped_demos</code> parameter and stopping the calls.</p><p id="53ba" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">But what are the prompts DSPy issued to obtain the bootstrapped demos? Here’s the prompt for question #14. We can see as DSPy tries to generate one bootstrapped demo, it would randomly add samples from our <code class="cx ql qm qn qo b">trainset</code> for few-short learning.</p><pre class="mm mn mo mp mq rg qo rh bp ri bb bk"><span id="0b63" class="rj pl fq qo b bg rk rl l rm rn">Answer questions with short factoid answers.<br/><br/>---<br/><br/><strong class="qo fr">{Pairs of question-and-answer as samples}</strong><br/><br/>---<br/><br/>Follow the following format.<br/><br/>Context: may contain relevant facts<br/><br/>Question: ${question}<br/><br/>Reasoning: Let's think step by step in order to ${produce the answer}. We ...<br/><br/>Answer: often between 1 and 5 words<br/><br/>---<br/><br/>Context:<br/>[1] «Eric Davis (baseball) | Eric Keith Davis (born May 29, 1962) is a former center fielder for several Major League Baseball teams. Davis was 21 years old when he broke into the big leagues on May 19, 1984 with the Cincinnati Reds, the team for which he is most remembered. Blessed with a rare combination of excellent foot speed and bat speed, Davis became the first major league player to hit at least 30 home runs and steal at least 50 bases in the same season in 1987.»<br/>[2] «Willie Davis (baseball) | William Henry Davis, Jr. (April 15, 1940 – March 9, 2010) was a center fielder in Major League Baseball who played most of his career for the Los Angeles Dodgers. At the end of his career he ranked seventh in major league history in putouts (5449) and total chances (5719) in the outfield, and third in games in center field (2237). He was ninth in National League history in total outfield games (2274), and won Gold Glove Awards from 1971 to 1973. He had 13 seasons of 20 or more stolen bases, led the NL in triples twice, and retired with the fourth most triples (138) by any major leaguer since 1945. He holds Los Angeles club records (1958–present) for career hits (2091), runs (1004), triples (110), at bats (7495), total bases (3094) and extra base hits (585). His 31-game hitting streak in 1969 remains the longest by a Dodger. At one point during the streak, when the team was playing at home, the big message board at Dodger Stadium quoted a message from a telegram sent to Davis and the team from Zack Wheat, the team's former record holder, at his home in Missouri.»<br/>[3] «1992 Los Angeles Dodgers season | The 1992 Los Angeles Dodgers season was a poor one for the team as it finished last in the Western Division of the National League with a record of 63 wins and 99 losses. Despite boasting what was nicknamed the "Outfield of Dreams", being manned by Eric Davis, Brett Butler, and Darryl Strawberry, injuries to key players and slumps from others contributed to the franchise's worst season since moving to Los Angeles. Additionally, the Dodgers cancelled four home games during the season due to the L.A. Riots. Despite the poor finish, the Dodgers had some hope for the future as first baseman Eric Karros won the National League Rookie of the Year Award, the first of five consecutive Dodger players to do so. The 1992 season also saw the Dodgers drop television station KTTV Ch.11 as their chief broadcaster of Dodger baseball, ending a 34 year-35 consecutive season association with that station. Additionally, it was the first time the Dodgers lost 90 games in a season since 1944.»<br/><br/>Question: Having the combination of excellent foot speed and bat speed helped Eric Davis, create what kind of outfield for the Los Angeles Dodgers?<br/><br/>Reasoning: Let's think step by step in order to Answer: "Outfield of Dreams"<br/><br/>Answer: "Outfield of Dreams"</span></pre><p id="4781" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Time to put the <code class="cx ql qm qn qo b">compiled_rag</code> to test! Here we raise a question which was answered wrongly in our summary table, and see if we can get the right answer this time.</p><pre class="mm mn mo mp mq rg qo rh bp ri bb bk"><span id="505e" class="rj pl fq qo b bg rk rl l rm rn">compiled_rag(question="Which of these publications was most recently published, Who Put the Bomp or Self?")</span></pre><pre class="ro rg qo rh bp ri bb bk"><span id="2c2e" class="rj pl fq qo b bg rk rl l rm rn">--- Output ---<br/>Prediction(<br/>    rationale='Answer: Self',<br/>    answer='Self'<br/>)</span></pre><p id="78a1" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">We now get the right answer!</p><p id="cabf" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Again let’s inspect the prompt issued. Notice how the compiled prompt is different from the ones that were used during bootstrapping. Apart from the few-shot examples, <strong class="ne fr">bootstrapped Context-Question-Reasoning-Answer demonstrations from correct predictions are added to the prompt</strong>, improving the LM’s capability.</p><pre class="mm mn mo mp mq rg qo rh bp ri bb bk"><span id="bee9" class="rj pl fq qo b bg rk rl l rm rn">Answer questions with short factoid answers.<br/><br/>---<br/><br/>{Pairs of question-and-answer as samples}<br/><br/>---<br/><br/>Follow the following format.<br/><br/>Context: may contain relevant facts<br/><br/>Question: ${question}<br/><br/>Reasoning: Let's think step by step in order to ${produce the answer}. We ...<br/><br/>Answer: often between 1 and 5 words<br/><br/>---<br/><br/><strong class="qo fr">{4 sets of Context-Question-Reasoning-Answer demonstrations}</strong><br/><br/>---<br/><br/>Context:<br/>[1] «Who Put the Bomp | Who Put The Bomp was a rock music fanzine edited and published by Greg Shaw from 1970 to 1979. Its name came from the hit 1961 doo-wop song by Barry Mann, "Who Put the Bomp". Later, the name was shortened to "Bomp!"»<br/>[2] «Bompiani | Bompiani is an Italian publishing house based in Milan, Italy. It was founded in 1929 by Valentino Bompiani.»<br/>[3] «What Color is Your Parachute? | What Color is Your Parachute? by Richard Nelson Bolles is a book for job-seekers that has been in print since 1970 and has been revised every year since 1975, sometimes substantially. Bolles initially self-published the book (December 1, 1970), but it has been commercially published since November 1972 by Ten Speed Press in Berkeley, California. As of September 28, 2010, the book is available in 22 languages, it is used in 26 countries around the world, and over ten million copies have been sold worldwide. It is one of the most highly regarded career advice books in print. In the latest edition of the book, the author writes about how to adapt one's job search to the Web 2.0 age.»<br/><br/>Question: Which of these publications was most recently published, Who Put the Bomp or Self?<br/><br/>Reasoning: Let's think step by step in order to Answer: Self<br/><br/>Answer: Self</span></pre><p id="d9f0" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">So the below is basically went behind the scene with BootstrapFewShot during compilation:</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk rr"><img src="../Images/843ab35d315078ee9a3d523c13b6f5a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hIMKb4Vf0fgfvPoyHWlZSg.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Bootstrapping demonstrations to enhance the prompt</figcaption></figure><p id="34bd" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">The above example still falls short of what we typically do with machine learning: Even boostrapping maybe useful, we are not yet proving it to improve the quality of the responses.</p><p id="4d4d" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Ideally, like in traditional machine learning we should define a couple of candidate models, see how they perform against the test set, and select the one achieving the highest performance score. This is what we will do next!</p><h1 id="26af" class="pk pl fq bf pm pn po gq pp pq pr gt ps pt pu pv pw px py pz qa qb qc qd qe qf bk"><strong class="al">Full fledged example: Prompt comparison with LLM</strong></h1><h2 id="336d" class="qp pl fq bf pm qq qr qs pp qt qu qv ps nl qw qx qy np qz ra rb nt rc rd re rf bk">The aim of this example</h2><p id="8e17" class="pw-post-body-paragraph nc nd fq ne b go qg ng nh gr qh nj nk nl qi nn no np qj nr ns nt qk nv nw nx fj bk">In this section, we want to evaluate what is the “best prompt” <strong class="ne fr">(expressed in terms of module and optimizer combination)</strong> to perform a RAG against the <a class="af og" href="https://hotpotqa.github.io/" rel="noopener ugc nofollow" target="_blank">HotpotQA dataset</a> (distributed under a <a class="af og" href="http://creativecommons.org/licenses/by-sa/4.0/" rel="noopener ugc nofollow" target="_blank">CC BY-SA 4.0 License</a>), given the LM we use (GPT 3.5 Turbo).</p><p id="0948" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">The Modules under evaluation are:</p><ul class=""><li id="48a7" class="nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx rp nz oa bk"><strong class="ne fr">Vanilla</strong>: Single-hop RAG to answer a question based on the retrieved context, without key phrases like “let’s think step by step”</li><li id="a61d" class="nc nd fq ne b go ob ng nh gr oc nj nk nl od nn no np oe nr ns nt of nv nw nx rp nz oa bk"><strong class="ne fr">COT</strong>: Single-hop RAG with Chain of Thought</li><li id="0ea5" class="nc nd fq ne b go ob ng nh gr oc nj nk nl od nn no np oe nr ns nt of nv nw nx rp nz oa bk"><strong class="ne fr">ReAct</strong>: Single-hop RAG with ReAct prompting</li><li id="a503" class="nc nd fq ne b go ob ng nh gr oc nj nk nl od nn no np oe nr ns nt of nv nw nx rp nz oa bk"><strong class="ne fr">BasicMultiHop</strong>: 2-hop RAG with Chain of Thought</li></ul><p id="7400" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">And the Optimizer candidates are:</p><ul class=""><li id="bb23" class="nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx rp nz oa bk"><strong class="ne fr">None</strong>: No additional instructions apart from the signature</li><li id="9aec" class="nc nd fq ne b go ob ng nh gr oc nj nk nl od nn no np oe nr ns nt of nv nw nx rp nz oa bk"><strong class="ne fr">Labeled few-shot</strong>: Simply constructs few-shot examples from provided labeled Q/A pairs</li><li id="d1e1" class="nc nd fq ne b go ob ng nh gr oc nj nk nl od nn no np oe nr ns nt of nv nw nx rp nz oa bk"><strong class="ne fr">Bootstrap few-shot</strong>: As we demonstrated, self-generate complete demonstrations for every stage of our module. Will simply use the generated demonstrations (if they pass the metric) without any further optimization. For <code class="cx ql qm qn qo b">Vanilla</code> it is just equal to “Labeled few-shot”</li></ul><p id="f05e" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">As for evaluation metric, we again use exact match as criteria (<code class="cx ql qm qn qo b">dspy.evaluate.metrics.answer_exact_match</code>) against the test set.</p><h2 id="7461" class="qp pl fq bf pm qq qr qs pp qt qu qv ps nl qw qx qy np qz ra rb nt rc rd re rf bk">Comparison</h2><p id="85c9" class="pw-post-body-paragraph nc nd fq ne b go qg ng nh gr qh nj nk nl qi nn no np qj nr ns nt qk nv nw nx fj bk">Let’s begin! First, we define our modules</p><pre class="mm mn mo mp mq rg qo rh bp ri bb bk"><span id="7732" class="rj pl fq qo b bg rk rl l rm rn"># Vanilla<br/>class Vanilla(dspy.Module):<br/>    def __init__(self, num_passages=3):<br/>        super().__init__()<br/>        self.retrieve = dspy.Retrieve(k=num_passages)<br/>        self.generate_answer = dspy.Predict("context, question -&gt; answer")<br/>    <br/>    def forward(self, question):<br/>        context = self.retrieve(question).passages<br/>        answer = self.generate_answer(context=context, question=question)<br/>        return answer<br/>    <br/>vanilla = Vanilla()<br/><br/># COT<br/>class COT(dspy.Module):<br/>    def __init__(self, num_passages=3):<br/>        super().__init__()<br/>        self.retrieve = dspy.Retrieve(k=num_passages)<br/>        self.generate_answer = dspy.ChainOfThought("context, question -&gt; answer")<br/>    <br/>    def forward(self, question):<br/>        context = self.retrieve(question).passages<br/>        answer = self.generate_answer(context=context, question=question)<br/>        return answer<br/>    <br/>cot = COT()<br/><br/># ReAct<br/>react = dspy.ReAct("question-&gt; answer", tools=[dspy.Retrieve(k=3)], max_iters=5)<br/><br/># BasicMultiHop<br/>class BasicMultiHop(dspy.Module):<br/>    def __init__(self, passages_per_hop=3):<br/>        self.retrieve = dspy.Retrieve(k=passages_per_hop)<br/>        self.generate_query = dspy.ChainOfThought("context, question-&gt; search_query")<br/>        self.generate_answer = dspy.ChainOfThought("context, question-&gt; answer")<br/><br/>    def forward(self, question):<br/>        context = []<br/><br/>        for hop in range(2):<br/>            query = self.generate_query(context=context, question=question).search_query<br/>            context += self.retrieve(query).passages<br/><br/>        return self.generate_answer(context=context, question=question)<br/>    <br/>multihop = BasicMultiHop(passages_per_hop=3)</span></pre><p id="b8e8" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Then define permutations for our model candidates</p><pre class="mm mn mo mp mq rg qo rh bp ri bb bk"><span id="47b1" class="rj pl fq qo b bg rk rl l rm rn">from dspy.teleprompt import LabeledFewShot, BootstrapFewShot<br/><br/>metric = dspy.evaluate.metrics.answer_exact_match<br/><br/>modules = {<br/>    'vanilla': vanilla,<br/>    'cot': cot,<br/>    'react': react,<br/>    'multihop': multihop,<br/>}<br/><br/>optimizers = {<br/>    'none': None,<br/>    'labeled_few_shot': LabeledFewShot(),<br/>    'bootstrap_few_shot': BootstrapFewShot(metric=metric, max_errors=20),<br/>}</span></pre><p id="bc21" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Then I defined a helper class to facilitate the evaluation. The code is a tad bit long so I am not pasting it here, but it could be found in my notebook. What it does is to apply each the optimizers against the modules, compile the prompt, then perform evaluation against the test set.</p><p id="353c" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">We are now ready to start the evaluation, it would take around 20 minutes to complete</p><pre class="mm mn mo mp mq rg qo rh bp ri bb bk"><span id="41b5" class="rj pl fq qo b bg rk rl l rm rn"># Compile the models<br/>ms = ModelSelection(modules=modules, optimizers=optimizers, metric=metric, trainset=trainset)<br/><br/># Evaluate them<br/>ms.evaluate(testset=testset)</span></pre><p id="e669" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Here’s the evaluation result. We can see the <code class="cx ql qm qn qo b">COT</code> module with <code class="cx ql qm qn qo b">BootstrapFewShot</code> optimizer has the best performance. The scores represent the percentage of correct answers (judged by exact match) made for the test set.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk rs"><img src="../Images/5d270eb34c7f0f594923555c9e6499f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:710/format:webp/1*uE75a4iqFF1YaiW9LVFU4w.png"/></div></figure><p id="3b2a" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">But before we conclude the exercise, it might be useful to inspect the result more deeply: <strong class="ne fr">Multihop with BootstrapFewShot</strong>, which supposedly equips with more relevant context than <strong class="ne fr">COT with BootstrapFewShot</strong>, has a worse performance. It is strange!</p><h2 id="82f7" class="qp pl fq bf pm qq qr qs pp qt qu qv ps nl qw qx qy np qz ra rb nt rc rd re rf bk">Debug and fine-tune our prompt</h2><p id="e1c2" class="pw-post-body-paragraph nc nd fq ne b go qg ng nh gr qh nj nk nl qi nn no np qj nr ns nt qk nv nw nx fj bk">Now head to the Phoenix Console to see what’s going on. We pick a random question <code class="cx ql qm qn qo b">William Hughes Miller was born in a city with how many inhabitants ?</code>, and inspect how did COT, ReAct, BasicMultiHop with BoostrapFewShot optimizer came up with their answer. You can type this in the search bar for filter: <code class="cx ql qm qn qo b">"""William Hughes Miller was born in a city with how many inhabitants ?""" in input.value</code></p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk rt"><img src="../Images/588fb6cbfd28970cd79b6918e2a6f614.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*lnI3yJkYKd_VY1RE"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">The calls follow sequential order, so for each of the module we can pick the BootstrapFewShot variant by picking the 3rd call</figcaption></figure><p id="1cb1" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">These are the answers provided by the 3 models during my run:</p><ul class=""><li id="9821" class="nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx rp nz oa bk"><strong class="ne fr">Multihop with BootstrapFewShot</strong>: <code class="cx ql qm qn qo b">The answer will vary based on the specific city of William Hughes Miller’s birthplace.</code></li><li id="f526" class="nc nd fq ne b go ob ng nh gr oc nj nk nl od nn no np oe nr ns nt of nv nw nx rp nz oa bk"><strong class="ne fr">ReAct with BootstrapFewShot</strong>: <code class="cx ql qm qn qo b">Kosciusko, Mississippi</code></li><li id="6a8c" class="nc nd fq ne b go ob ng nh gr oc nj nk nl od nn no np oe nr ns nt of nv nw nx rp nz oa bk"><strong class="ne fr">COT with BootstrapFewShot</strong>: <code class="cx ql qm qn qo b">The city of Kosciusko, Mississippi, has a population of approximately 7,402 inhabitants.</code></li></ul><p id="f55b" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">The correct answer is <code class="cx ql qm qn qo b">7,402 at the 2010 census</code>. Both <strong class="ne fr">ReAct with BootstrapFewShot</strong> and <strong class="ne fr">COT with BootstrapFewShot</strong> provided relevant answers, but <strong class="ne fr">Multihop with BootstrapFewShot</strong> simply failed to provide one.</p><p id="2ada" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Checking the execution trace in Phoenix for Multihop with BootstrapFewShot, looks like the LM fails to understand what is expected for the <code class="cx ql qm qn qo b">search_query</code> specified in the <strong class="ne fr">signature</strong>.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk ru"><img src="../Images/0e1e7217ff54735470d988cac17fea8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*8DnUZOxhVumPHKYz"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">The LM can’t come up with the search_query during the 1st hop</figcaption></figure><p id="4e4c" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">So we revise the signature, and re-run the evaluation with the code below</p><pre class="mm mn mo mp mq rg qo rh bp ri bb bk"><span id="c397" class="rj pl fq qo b bg rk rl l rm rn"># Define a class-based signature<br/>class GenerateAnswer(dspy.Signature):<br/>    """Answer questions with short factoid answers."""<br/><br/>    context = dspy.InputField(desc="may contain relevant facts")<br/>    question = dspy.InputField()<br/>    answer = dspy.OutputField(desc="often between 1 and 5 words")<br/><br/>class BasicQA(dspy.Signature):<br/>    """Answer questions with short factoid answers."""<br/>    <br/>    question = dspy.InputField()<br/>    answer = dspy.OutputField(desc="often between 1 and 5 words")<br/><br/>class FollowupQuery(dspy.Signature):<br/>    """Generate a query which is conducive to answering the question"""<br/><br/>    context = dspy.InputField(desc="may contain relevant facts")<br/>    question = dspy.InputField()<br/>    search_query = dspy.OutputField(desc="Judge if the context is adequate to answer the question, if not adequate or if it is blank, generate a search query that would help you answer the question.")</span></pre><pre class="ro rg qo rh bp ri bb bk"><span id="73aa" class="rj pl fq qo b bg rk rl l rm rn"># Revise the modules with the class-based signatures. You can find the relevant code in my notebook<br/># To keep the article concise I am not pasting it here.<br/><br/># Then run the below command to re-compile and evaluate<br/>ms_revised = ModelSelection(modules=modules_revised, optimizers=optimizers, metric=metric, trainset=trainset)<br/>ms_revised.evaluate(testset=testset)<br/>ms_revised.evaluation_matrix</span></pre><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk rv"><img src="../Images/09f52de40780a66ef1cad4de15b306b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:716/format:webp/1*zW1UIOOWWsyEja-d1FGZmg.png"/></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Performance improved after updating the signatures</figcaption></figure><p id="7224" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">We now see the score improved across all models, and <strong class="ne fr">Multihop with LabeledFewShot</strong> and <strong class="ne fr">Multihop with no examples</strong> now have the best performance! This indicates despite DSPy tries to optimize the prompt, <strong class="ne fr">there is still some prompt engineering involved by articulating your objective in signature</strong>.</p><p id="bb05" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk"><em class="oh">Note: Even the signature itself can be optimized with DSPy’s </em><a class="af og" href="https://dspy-docs.vercel.app/docs/deep-dive/teleprompter/signature-optimizer" rel="noopener ugc nofollow" target="_blank"><em class="oh">COPRO</em></a><em class="oh">! But this article will not deep dive into COPRO, as all could be too much to digest.</em></p><p id="34cc" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">The best model now produce an exact match for our question!</p><pre class="mm mn mo mp mq rg qo rh bp ri bb bk"><span id="0bff" class="rj pl fq qo b bg rk rl l rm rn"># The correct answer is 7,402<br/>question = """`William Hughes Miller was born in a city with how many inhabitants ?"""<br/>ms_revised.question_for_model('multihop','labeled_few_shot',question)</span></pre><pre class="ro rg qo rh bp ri bb bk"><span id="7751" class="rj pl fq qo b bg rk rl l rm rn">--- Output ---<br/>Prediction(<br/>    rationale='Answer: 7,402',<br/>    answer='7,402'<br/>)</span></pre><p id="fc9c" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Since the best prompt is Multihop with LabeledFewShot, the prompt does not contain bootstrapped Context-Question-Reasoning-Answer demonstrations. So bootstrapping may not surely lead to better performance, <strong class="ne fr">we need to prove which one is the best prompt scientifically.</strong></p><pre class="mm mn mo mp mq rg qo rh bp ri bb bk"><span id="3f6f" class="rj pl fq qo b bg rk rl l rm rn">Answer questions with short factoid answers.<br/><br/>---<br/><br/><strong class="qo fr">{Pairs of question-and-answer as samples}</strong><br/><br/>---<br/><br/>Follow the following format.<br/><br/>Context: may contain relevant facts<br/><br/>Question: ${question}<br/><br/>Reasoning: Let's think step by step in order to ${produce the answer}. We ...<br/><br/>Answer: often between 1 and 5 words<br/><br/>---<br/><br/>Context:<br/>[1] «William Hughes Miller | William Hughes Miller (born March 16, 1941, Kosciusko, Mississippi) is a professor at the University of California, Berkeley and a leading researcher in the field of theoretical chemistry.»<br/>[2] «William Herbert Miller, Jr. | William Hubert Miller, Jr. (September 1932 – November 4, 1988), of New York City, was an aerophilatelist who published philatelic literature on the subject.»<br/>[3] «William Green Miller | William Green Miller (born August 15, 1931 in New York City, New York), served as the United States Ambassador to Ukraine under Bill Clinton, from 1993 to 1998.»<br/>[4] «Kosciusko, Mississippi | Kosciusko is a city in Attala County, Mississippi, United States. The population was 7,402 at the 2010 census. It is the county seat of Attala County.»<br/>[5] «Attala County, Mississippi | Attala County is a county located in the U.S. state of Mississippi. As of the 2010 census, the population was 19,564. Its county seat is Kosciusko. Attala County is named for Atala, a fictional Native American heroine from an early-19th-century novel of the same name by François-René de Chateaubriand.»<br/>[6] «Kosciusko Island | Kosciusko Island is an island in the Alexander Archipelago of southeastern Alaska, United States. It lies near the northwest corner of Prince of Wales Island, just across the El Capitan Passage from the larger island. The island is near Mount Francis, Holbrook Mountain, and Tokeen Peak. Kosciusko Island has a land area of 171.585 sq mi (444.403 km²), making it the 38th largest island in the United States. It had a population of 52 persons as of the 2000 census, mostly in Edna Bay, its largest community.»<br/><br/>Question: `William Hughes Miller was born in a city with how many inhabitants ?<br/><br/>Reasoning: Let's think step by step in order to Answer: 7,402<br/><br/>Answer: 7,402</span></pre><p id="8fa9" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">It does not mean Multihop with BootstrapFewShot has a worse performance <strong class="ne fr">in general</strong> however. Only that for our task, if we use GPT 3.5 Turbo to bootstrap demonstration (which might be of questionable quality) and output prediction, then we might better do without the bootstrapping, and keep only the few-shot examples.</p><p id="eeac" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">This lead to the question: Is it possible to use a more powerful LM, say GPT 4 Turbo (aka <code class="cx ql qm qn qo b">teacher</code>) to generate demonstrations, while keeping cheaper models like GPT 3.5 Turbo (aka <code class="cx ql qm qn qo b">student</code>) for prediction?</p><h2 id="d336" class="qp pl fq bf pm qq qr qs pp qt qu qv ps nl qw qx qy np qz ra rb nt rc rd re rf bk"><strong class="al">“Teacher” to power-up bootstrapping capability</strong></h2><p id="88e0" class="pw-post-body-paragraph nc nd fq ne b go qg ng nh gr qh nj nk nl qi nn no np qj nr ns nt qk nv nw nx fj bk">The answer is <strong class="ne fr">YES</strong> as the following cell demonstrates, we will use GPT 4 Turbo as teacher.</p><pre class="mm mn mo mp mq rg qo rh bp ri bb bk"><span id="9e5a" class="rj pl fq qo b bg rk rl l rm rn"># Define the GPT-4 Turbo model<br/>gpt4_turbo = dspy.Databricks(api_key=OPENROUTER_API_KEY,<br/>  api_base="https://openrouter.ai/api/v1",<br/>  model="openai/gpt-4-turbo")<br/><br/># Define new Optimizer which uses GPT-4 Turbo as a teacher<br/>optimizers_gpt4_teacher = {<br/>    'bootstrap_few_shot': BootstrapFewShot(metric=metric, max_errors=20, teacher_settings=dict(lm=gpt4_turbo)),<br/>}<br/><br/># Compile the models and evaluate them as before<br/>ms_gpt4_teacher = ModelSelection(modules=modules_revised, optimizers=optimizers_gpt4_teacher, metric=metric, trainset=trainset)<br/>ms_gpt4_teacher.evaluate(testset=testset)<br/>ms_gpt4_teacher.evaluation_matrix</span></pre><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk rw"><img src="../Images/4d747518e8a217acfc20102d3ffef23c.png" data-original-src="https://miro.medium.com/v2/resize:fit:720/format:webp/1*iEUs54H8X09SK1SRoBjoRA.png"/></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Result using GPT-4 as teacher</figcaption></figure><p id="fd66" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Using GPT-4 Turbo as <code class="cx ql qm qn qo b">teacher</code> does not significantly boost our models’ performance however. Still it is worthwhile to see its effect to our prompt. Below is the prompt generated just using GPT 3.5</p><pre class="mm mn mo mp mq rg qo rh bp ri bb bk"><span id="3c76" class="rj pl fq qo b bg rk rl l rm rn">Answer questions with short factoid answers.<br/><br/>---<br/><br/>{Pairs of question-and-answer as samples}<br/><br/>---<br/><br/>Follow the following format.<br/><br/>Context: may contain relevant facts<br/><br/>Question: ${question}<br/><br/>Reasoning: Let's think step by step in order to ${produce the answer}. We ...<br/><br/>Answer: often between 1 and 5 words<br/><br/>---<br/><br/><strong class="qo fr">Context:<br/>[1] «Candace Kita | Kita's first role was as a news anchor in the 1991 movie "Stealth Hunters". Kita's first recurring television role was in Fox's "Masked Rider", from 1995 to 1996. She appeared as a series regular lead in all 40 episodes. Kita also portrayed a frantic stewardess in a music video directed by Mark Pellington for the British group, Catherine Wheel, titled, "Waydown" in 1995. In 1996, Kita also appeared in the film "Barb Wire" (1996) and guest starred on "The Wayans Bros.". She also guest starred in "Miriam Teitelbaum: Homicide" with "Saturday Night Live" alumni Nora Dunn, "Wall To Wall Records" with Jordan Bridges, "Even Stevens", "Felicity" with Keri Russell, "V.I.P." with Pamela Anderson, "Girlfriends", "The Sweet Spot" with Bill Murray, and "Movies at Our House". She also had recurring roles on the FX spoof, "Son of the Beach" from 2001 to 2002, ABC-Family's "Dance Fever" and Oxygen Network's "Running with Scissors". Kita also appeared in the films "Little Heroes" (2002) and "Rennie's Landing" (2001).»<br/>[2] «Jilly Kitzinger | Jilly Kitzinger is a fictional character in the science fiction series "Torchwood", portrayed by American actress Lauren Ambrose. The character was promoted as one of five new main characters to join "Torchwood" in its fourth series, "" (2011), as part of a new co-production between "Torchwood"' s British network, BBC One, and its American financiers on US premium television network Starz. Ambrose appears in seven of the ten episodes, and is credited as a "special guest star" throughout. Whilst reaction to the serial was mixed, Ambrose' portrayal was often singled out by critics for particular praise and in 2012 she received a Saturn Award nomination for Best Supporting Actress on Television.»<br/>[3] «Candace Brown | Candace June Brown (born June 15, 1980) is an American actress and comedian best known for her work on shows such as "Grey's Anatomy", "Desperate Housewives", "Head Case", The "Wizards Of Waverly Place". In 2011, she joined the guest cast for "Torchwood"' s fourth series' "", airing on BBC One in the United Kingdom and premium television network Starz.»<br/>[4] «Candace Kita | Kita's first role was as a news anchor in the 1991 movie "Stealth Hunters". Kita's first recurring television role was in Fox's "Masked Rider", from 1995 to 1996. She appeared as a series regular lead in all 40 episodes. Kita also portrayed a frantic stewardess in a music video directed by Mark Pellington for the British group, Catherine Wheel, titled, "Waydown" in 1995. In 1996, Kita also appeared in the film "Barb Wire" (1996) and guest starred on "The Wayans Bros.". She also guest starred in "Miriam Teitelbaum: Homicide" with "Saturday Night Live" alumni Nora Dunn, "Wall To Wall Records" with Jordan Bridges, "Even Stevens", "Felicity" with Keri Russell, "V.I.P." with Pamela Anderson, "Girlfriends", "The Sweet Spot" with Bill Murray, and "Movies at Our House". She also had recurring roles on the FX spoof, "Son of the Beach" from 2001 to 2002, ABC-Family's "Dance Fever" and Oxygen Network's "Running with Scissors". Kita also appeared in the films "Little Heroes" (2002) and "Rennie's Landing" (2001).»<br/>[5] «Kiti Manver | María Isabel Ana Mantecón Vernalte (born 11 May 1953) better known as Kiti Mánver is a Spanish actress. She has appeared in more than 100 films and television shows since 1970. She starred in the 1973 film "Habla, mudita", which was entered into the 23rd Berlin International Film Festival.»<br/>[6] «Amy Steel | Amy Steel (born Alice Amy Steel; May 3, 1960) is an American film and television actress. She is best known for her roles as Ginny Field in "Friday the 13th Part 2" (1981) and Kit Graham in "April Fool's Day" (1986). She has starred in films such as "Exposed" (1983), "Walk Like a Man" (1987), "What Ever Happened to Baby Jane? " (1991), and "Tales of Poe" (2014). Steel has had numerous guest appearances on several television series, such as "Family Ties" (1983), "The A-Team" (1983), "Quantum Leap" (1990), and "China Beach" (1991), as well as a starring role in "The Powers of Matthew Star" (1982–83).»<br/><br/>Question: which American actor was Candace Kita guest starred with<br/><br/>Reasoning: Let's think step by step in order to Answer: Bill Murray<br/><br/>Answer: Bill Murray<br/><br/>---<br/><br/>Context:<br/>[1] «Monthly Magazine | The Monthly Magazine (1796–1843) of London began publication in February 1796. Richard Phillips was the publisher and a contributor on political issues. The editor for the first ten years was the literary jack-of-all-trades, Dr John Aikin. Other contributors included William Blake, Samuel Taylor Coleridge, George Dyer, Henry Neele and Charles Lamb. The magazine also published the earliest fiction of Charles Dickens, the first of what would become "Sketches by Boz".»<br/>[2] «Bodega Magazine | Bodega Magazine is an online literary magazine that releases new issues on the first Monday of every month, featuring stories, poems, essays and interviews from a mix of emerging and established writers. It was founded in early spring of 2012 by creative writing MFA graduates from New York University who had previously worked together on the "Washington Square Review", and continues to be based out of Manhattan and Brooklyn. The inaugural issue was published on September 4, 2012.»<br/>[3] «Who Put the Bomp | Who Put The Bomp was a rock music fanzine edited and published by Greg Shaw from 1970 to 1979. Its name came from the hit 1961 doo-wop song by Barry Mann, "Who Put the Bomp". Later, the name was shortened to "Bomp!"»<br/>[4] «The Most (album) | The Most is the third album released by straight edge hardcore punk band Down to Nothing. It was released on July 17, 2007.»<br/>[5] «The Most Incredible Thing | “The Most Incredible Thing" (Danish: "Det Utroligste" ) is a literary fairy tale by Danish poet and author Hans Christian Andersen (1805–1875). The story is about a contest to find the most incredible thing and the wondrous consequences when the winner is chosen. The tale was first published in an English translation by Horace Scudder, an American correspondent of Andersen's, in the United States in September 1870 before being published in the original Danish in Denmark in October 1870. "The Most Incredible Thing" was the first of Andersen's tales to be published in Denmark during World War II. Andersen considered the tale one of his best.»<br/>[6] «Augusta Triumphans | Augusta Triumphans: or, the Way to Make London the Most Flourishing City in the Universe by Daniel Defoe was first published on 16 March 1728. The fictitious speaker of this pamphlet, Andrew Moreton, is a man in his sixties who offers suggestions for the improvement of London. In particular, he fosters the establishment of a university, an academy of music, a hospital for foundlings and licensed institutions for the treatment of mental diseases. Moreover, he encourages the introduction of measures to prevent moral corruption and street robbery.»<br/><br/>Question: Which of these publications was most recently published, Who Put the Bomp or Self?<br/><br/>Reasoning: Let's think step by step in order to Answer: Self<br/><br/>Answer: Self<br/><br/>---<br/><br/>Context:<br/>[1] «The Victorians | The Victorians - Their Story In Pictures is a 2009 British documentary series which focuses on Victorian art and culture. The four-part series is written and presented by Jeremy Paxman and debuted on BBC One at 9:00pm on Sunday 15 February 2009.»<br/>[2] «What the Victorians Did for Us | What the Victorians Did for Us is a 2001 BBC documentary series that examines the impact of the Victorian era on modern society. It concentrates primarily on the scientific and social advances of the era, which bore the Industrial Revolution and set the standards for polite society today.»<br/>[3] «The Great Victorian Collection | The Great Victorian Collection, published in 1975, is a novel by Northern Irish-Canadian writer Brian Moore. Set in Carmel, California, it tells the story of a man who dreams that the empty parking lot he can see from his hotel window has been transformed by the arrival of a collection of priceless Victoriana on display in a vast open-air market. When he awakes he finds that he can no longer distinguish the dream from reality.»<br/>[4] «Jeremy Paxman | Jeremy Dickson Paxman (born 11 May 1950) is an English broadcaster, journalist, and author. He is the question master of "University Challenge", having succeeded Bamber Gascoigne when the programme was revived in 1994.»<br/>[5] «Jeremy I | Jeremy I was king of the Miskito nation, who came to power following the death of his father, Oldman, in 1686 or 1687. according to an English visitor, W. M., in 1699, he was about 60 years old at that time, making his birth year about 1639.»<br/>[6] «Jeremy Cheeseman | Jeremy Cheeseman (born June 6, 1990 in Manorville, New York) is a former American professional soccer player. Playing two seasons for the Dayton Dutch Lions in the USL Professional Division before retiring due to injury»<br/><br/>Question: The Victorians - Their Story In Pictures is a documentary series written by an author born in what year?<br/><br/>Reasoning: Let's think step by step in order to Answer: 1950<br/><br/>Answer: 1950<br/><br/>---<br/><br/>Context:<br/>[1] «Tae Kwon Do Times | Tae Kwon Do Times is a magazine devoted to the martial art of taekwondo, and is published in the United States of America. While the title suggests that it focuses on taekwondo exclusively, the magazine also covers other Korean martial arts. "Tae Kwon Do Times" has published articles by a wide range of authors, including He-Young Kimm, Thomas Kurz, Scott Shaw, and Mark Van Schuyver.»<br/>[2] «Scott Shaw (artist) | Scott Shaw (often spelled Scott Shaw!) is a United States cartoonist and animator, and historian of comics. Among Scott's comic-book work is Hanna-Barbera's "The Flintstones" (for Marvel Comics and Harvey Comics), "Captain Carrot and His Amazing Zoo Crew" (for DC Comics), and "Simpsons Comics" (for Bongo Comics). He was also the first artist for Archie Comics' "Sonic the Hedgehog" comic book series.»<br/>[3] «Scott Shaw | Scott Shaw (born September 23, 1958) is an American actor, author, film director, film producer, journalist, martial artist, musician, photographer, and professor.»<br/>[4] «Scott Shaw (artist) | Scott Shaw (often spelled Scott Shaw!) is a United States cartoonist and animator, and historian of comics. Among Scott's comic-book work is Hanna-Barbera's "The Flintstones" (for Marvel Comics and Harvey Comics), "Captain Carrot and His Amazing Zoo Crew" (for DC Comics), and "Simpsons Comics" (for Bongo Comics). He was also the first artist for Archie Comics' "Sonic the Hedgehog" comic book series.»<br/>[5] «Scott Shaw | Scott Shaw (born September 23, 1958) is an American actor, author, film director, film producer, journalist, martial artist, musician, photographer, and professor.»<br/>[6] «Arnold Shaw (author) | Arnold Shaw (1909–1989) was a songwriter and music business executive, primarily in the field of music publishing, who is best known for his comprehensive series of books on 20th century American popular music.»<br/><br/>Question: Which magazine has published articles by Scott Shaw, Tae Kwon Do Times or Southwest Art?<br/><br/>Reasoning: Let's think step by step in order to Answer: Tae Kwon Do Times<br/><br/>Answer: Tae Kwon Do Times</strong><br/><br/>---<br/><br/>Context:<br/>[1] «William Hughes Miller | William Hughes Miller (born March 16, 1941, Kosciusko, Mississippi) is a professor at the University of California, Berkeley and a leading researcher in the field of theoretical chemistry.»<br/>[2] «William Herbert Miller, Jr. | William Hubert Miller, Jr. (September 1932 – November 4, 1988), of New York City, was an aerophilatelist who published philatelic literature on the subject.»<br/>[3] «William Rickarby Miller | William Rickarby Miller (May 20, 1818 in Staindrop – July 1893 in New York City) was an American painter, of the Hudson River School.»<br/>[4] «Kosciusko, Mississippi | Kosciusko is a city in Attala County, Mississippi, United States. The population was 7,402 at the 2010 census. It is the county seat of Attala County.»<br/>[5] «Attala County, Mississippi | Attala County is a county located in the U.S. state of Mississippi. As of the 2010 census, the population was 19,564. Its county seat is Kosciusko. Attala County is named for Atala, a fictional Native American heroine from an early-19th-century novel of the same name by François-René de Chateaubriand.»<br/>[6] «Kosciusko Island | Kosciusko Island is an island in the Alexander Archipelago of southeastern Alaska, United States. It lies near the northwest corner of Prince of Wales Island, just across the El Capitan Passage from the larger island. The island is near Mount Francis, Holbrook Mountain, and Tokeen Peak. Kosciusko Island has a land area of 171.585 sq mi (444.403 km²), making it the 38th largest island in the United States. It had a population of 52 persons as of the 2000 census, mostly in Edna Bay, its largest community.»<br/><br/>Question: `William Hughes Miller was born in a city with how many inhabitants ?<br/><br/>Reasoning: Let's think step by step in order to Answer: 7,402<br/><br/>Answer: 7,402</span></pre><p id="448c" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">And here’s the prompt generated using GPT-4 Turbo as <code class="cx ql qm qn qo b">teacher</code>. Notice how the “Reasoning” is much better articulated here!</p><pre class="mm mn mo mp mq rg qo rh bp ri bb bk"><span id="7229" class="rj pl fq qo b bg rk rl l rm rn">Answer questions with short factoid answers.<br/><br/>---<br/><br/>{Pairs of question-and-answer as samples}<br/><br/>---<br/><br/>Follow the following format.<br/><br/>Context: may contain relevant facts<br/><br/>Question: ${question}<br/><br/>Reasoning: Let's think step by step in order to ${produce the answer}. We ...<br/><br/>Answer: often between 1 and 5 words<br/><br/>---<br/><br/><strong class="qo fr">Context:<br/>[1] «Monthly Magazine | The Monthly Magazine (1796–1843) of London began publication in February 1796. Richard Phillips was the publisher and a contributor on political issues. The editor for the first ten years was the literary jack-of-all-trades, Dr John Aikin. Other contributors included William Blake, Samuel Taylor Coleridge, George Dyer, Henry Neele and Charles Lamb. The magazine also published the earliest fiction of Charles Dickens, the first of what would become "Sketches by Boz".»<br/>[2] «Who Put the Bomp | Who Put The Bomp was a rock music fanzine edited and published by Greg Shaw from 1970 to 1979. Its name came from the hit 1961 doo-wop song by Barry Mann, "Who Put the Bomp". Later, the name was shortened to "Bomp!"»<br/>[3] «Desktop Publishing Magazine | Desktop Publishing magazine (ISSN 0884-0873) was founded, edited, and published by Tony Bove and Cheryl Rhodes of TUG/User Publications, Inc., of Redwood City, CA. ) . Its first issue appeared in October, 1985, and was created and produced on a personal computer with desktop publishing software (PageMaker on a Macintosh), preparing output on a prototype PostScript-driven typesetting machine from Mergenthaler Linotype Company. Erik Sandberg-Diment, a columnist at "The New York Times", tried to buy the venture outright when he saw an early edition.»<br/>[4] «Self (magazine) | Self is an American magazine for women that specializes in health, wellness, beauty, and style. Part of Condé Nast, Self had a circulation of 1,515,880 and a total audience of 5,282,000 readers, according to its corporate media kit n 2013. The editor-in-chief is Carolyn Kylstra. "Self" is based in the Condé Nast U.S. headquarters at 1 World Trade Center in New York, NY. In February 2017 the magazine became an online publication.»<br/>[5] «Self-Publishing Review | Self-Publishing Review (or "SPR") is an online book review magazine for indie authors founded in 2008 by American author Henry Baum.»<br/>[6] «Self-publishing | Self-publishing is the publication of any book, album or other media by its author without the involvement of an established publisher. A self-published physical book is said to have been privately printed. The author is in control of the entire process including, for a book, the design of the cover and interior, formats, price, distribution, marketing, and public relations. The authors can do it all themselves or may outsource some or all of the work to companies which offer these services.»<br/><br/>Question: Which of these publications was most recently published, Who Put the Bomp or Self?<br/><br/>Reasoning: Let's think step by step in order to determine which publication was most recently published. According to the context, "Who Put the Bomp" was published from 1970 to 1979. On the other hand, "Self" magazine became an online publication in February 2017 after being a print publication. Therefore, "Self" was most recently published.<br/><br/>Answer: Self<br/><br/>---<br/><br/>Context:<br/>[1] «The Victorians | The Victorians - Their Story In Pictures is a 2009 British documentary series which focuses on Victorian art and culture. The four-part series is written and presented by Jeremy Paxman and debuted on BBC One at 9:00pm on Sunday 15 February 2009.»<br/>[2] «The Great Victorian Collection | The Great Victorian Collection, published in 1975, is a novel by Northern Irish-Canadian writer Brian Moore. Set in Carmel, California, it tells the story of a man who dreams that the empty parking lot he can see from his hotel window has been transformed by the arrival of a collection of priceless Victoriana on display in a vast open-air market. When he awakes he finds that he can no longer distinguish the dream from reality.»<br/>[3] «Victorian (comics) | The Victorian is a 25-issue comic book series published by Penny-Farthing Press and starting in 1999. The brainchild of creator Trainor Houghton, the series included a number of notable script writers and illustrators, including Len Wein, Glen Orbik and Howard Chaykin.»<br/>[4] «Jeremy Paxman | Jeremy Dickson Paxman (born 11 May 1950) is an English broadcaster, journalist, and author. He is the question master of "University Challenge", having succeeded Bamber Gascoigne when the programme was revived in 1994.»<br/>[5] «Jeremy I | Jeremy I was king of the Miskito nation, who came to power following the death of his father, Oldman, in 1686 or 1687. according to an English visitor, W. M., in 1699, he was about 60 years old at that time, making his birth year about 1639.»<br/>[6] «Jeremy Cheeseman | Jeremy Cheeseman (born June 6, 1990 in Manorville, New York) is a former American professional soccer player. Playing two seasons for the Dayton Dutch Lions in the USL Professional Division before retiring due to injury»<br/><br/>Question: The Victorians - Their Story In Pictures is a documentary series written by an author born in what year?<br/><br/>Reasoning: Let's think step by step in order to determine the birth year of the author who wrote "The Victorians - Their Story In Pictures." According to context [4], Jeremy Paxman, an English broadcaster and journalist, wrote and presented this documentary series. His birth year is provided in the same context.<br/><br/>Answer: 1950<br/><br/>---<br/><br/>Context:<br/>[1] «Tae Kwon Do Times | Tae Kwon Do Times is a magazine devoted to the martial art of taekwondo, and is published in the United States of America. While the title suggests that it focuses on taekwondo exclusively, the magazine also covers other Korean martial arts. "Tae Kwon Do Times" has published articles by a wide range of authors, including He-Young Kimm, Thomas Kurz, Scott Shaw, and Mark Van Schuyver.»<br/>[2] «Kwon Tae-man | Kwon Tae-man (born 1941) was an early Korean hapkido practitioner and a pioneer of the art, first in Korea and then in the United States. He formed one of the earliest dojang's for hapkido in the United States in Torrance, California, and has been featured in many magazine articles promoting the art.»<br/>[3] «Scott Shaw (artist) | Scott Shaw (often spelled Scott Shaw!) is a United States cartoonist and animator, and historian of comics. Among Scott's comic-book work is Hanna-Barbera's "The Flintstones" (for Marvel Comics and Harvey Comics), "Captain Carrot and His Amazing Zoo Crew" (for DC Comics), and "Simpsons Comics" (for Bongo Comics). He was also the first artist for Archie Comics' "Sonic the Hedgehog" comic book series.»<br/>[4] «Tae Kwon Do Times | Tae Kwon Do Times is a magazine devoted to the martial art of taekwondo, and is published in the United States of America. While the title suggests that it focuses on taekwondo exclusively, the magazine also covers other Korean martial arts. "Tae Kwon Do Times" has published articles by a wide range of authors, including He-Young Kimm, Thomas Kurz, Scott Shaw, and Mark Van Schuyver.»<br/>[5] «Scott Savitt | Scott Savitt is a former foreign correspondent for The Los Angeles Times and United Press International in Beijing. His articles have been published in The Los Angeles Times, Washington Post http://www.washingtonpost.com/wp-dyn/content/article/2008/04/18/AR2008041802635.html, Wall Street Journal, New York Times, and many other publications.»<br/>[6] «Scott Poulson-Bryant | Scott Poulson-Bryant is an award-winning American journalist and author. One of the co-founding editors of Vibe magazine in 1992 (and the editor who gave the magazine its name), Poulson-Bryant's journalism, profiles, reviews, and essays have appeared in such publications as the "New York Times", "the Village Voice", "Rolling Stone", "Spin", "Essence", "Ebony", and "The Source". He is the author of "HUNG: A Meditation on the Measure of Black Men in America" (published by Doubleday Books in 2006) and a novel called "The VIPs".»<br/><br/>Question: Which magazine has published articles by Scott Shaw, Tae Kwon Do Times or Southwest Art?<br/><br/>Reasoning: Let's think step by step in order to determine which magazine published articles by Scott Shaw. According to the context provided, Scott Shaw has contributed to "Tae Kwon Do Times," which is mentioned in both [1] and [4]. There is no mention of Scott Shaw contributing to "Southwest Art."<br/><br/>Answer: Tae Kwon Do Times<br/><br/>---<br/><br/>Context:<br/>[1] «1972 FA Charity Shield | The 1972 FA Charity Shield was contested between Manchester City and Aston Villa.»<br/>[2] «1968 FA Charity Shield | The 1968 FA Charity Shield was a football match played on 3 August 1968 between Football League champions Manchester City and FA Cup winners West Bromwich Albion. It was the 46th Charity Shield match and was played at City's home ground, Maine Road. Manchester City won 6–1.»<br/>[3] «1973 FA Charity Shield | The 1973 FA Charity Shield was contested between Burnley and Manchester City in a fixture that took place at Maine Road.»<br/>[4] «List of Aston Villa F.C. seasons | This is a list of seasons played by Aston Villa Football Club in English and European football, from 1879 (the year of the club's first FA Cup entry) to the most recent completed season. Aston Villa football club was founded in March, 1874, by members of the Villa Cross Wesleyan Chapel in Aston. Throughout the 1870s Aston Villa played a small amount of games. At least one game, against Aston Brook St Mary's was played with one half under Rugby rules and the other under football rules. In the 1880s the game became more formalised and in 1888, William McGregor formed the Football League with 11 other clubs.»<br/>[5] «List of Aston Villa F.C. records and statistics | Aston Villa Football Club are an English professional association football club based in Aston, Birmingham, who currently play in the EFL Championship. The club was founded in 1874 and have played at their current home ground, Villa Park, since 1897. Aston Villa were founding members of the Football League in 1888 and the Premier League in 1992. They are one of the oldest and most successful football clubs in England, having won the First Division Championship seven times and the FA Cup seven times. In 1982 the club became one of only five English clubs to win the European Cup.»<br/>[6] «Aston Villa F.C. | Aston Villa Football Club ( ; nicknamed Villa, The Villa, The Villans and The Lions) is a professional football club in Aston, Birmingham, that plays in the Championship, the second level of English football. Founded in 1874, they have played at their current home ground, Villa Park, since 1897. Aston Villa were one of the founder members of the Football League in 1888 and of the Premier League in 1992.»<br/><br/>Question: In what year was the club founded that played Manchester City in the 1972 FA Charity Shield<br/><br/>Reasoning: Let's think step by step in order to determine the founding year of the club that played against Manchester City in the 1972 FA Charity Shield. According to context [1], the match was contested between Manchester City and Aston Villa. To find the founding year of Aston Villa, we refer to context [4], which states that Aston Villa Football Club was founded in March, 1874.<br/><br/>Answer: 1874</strong><br/><br/>---<br/><br/>Context:<br/>[1] «William Hughes Miller | William Hughes Miller (born March 16, 1941, Kosciusko, Mississippi) is a professor at the University of California, Berkeley and a leading researcher in the field of theoretical chemistry.»<br/>[2] «William Read Miller | William Read Miller (November 23, 1823November 29, 1887) was the 12th Governor of the State of Arkansas. Born in Batesville, Arkansas; Miller was Arkansas's first native born Governor. Serving two terms in the turbulent period after Reconstruction, Miller's four-year administration marked the beginnings of New Departure Democrats in Arkansas. Running on a platform of economic growth via reconciliation between whites and freedmen, Miller often was opposed by members of his own party during the infancy of the Lost Cause ideology. His plans to pay back a large state debt including the Holford Bonds, valued at $14 million ($ million today), were often interrupted by racial violence, and his support for public schools and universities was often combated by those in his own party.»<br/>[3] «William &amp;quot;Willie&amp;quot; Armstrong | William Armstrong was born c1804 in Painter Heugh (or Hugh), (which was an old lane dating from medieval Newcastle, a lane joining lower part of Dean Street to the higher part of Pilgrim Street), the name possibly derived from the fact that ships tied up here in the tidal parts of the Lort Burn (now filled).»<br/>[4] «Kosciusko, Mississippi | Kosciusko is a city in Attala County, Mississippi, United States. The population was 7,402 at the 2010 census. It is the county seat of Attala County.»<br/>[5] «Attala County, Mississippi | Attala County is a county located in the U.S. state of Mississippi. As of the 2010 census, the population was 19,564. Its county seat is Kosciusko. Attala County is named for Atala, a fictional Native American heroine from an early-19th-century novel of the same name by François-René de Chateaubriand.»<br/>[6] «Kosciusko Island | Kosciusko Island is an island in the Alexander Archipelago of southeastern Alaska, United States. It lies near the northwest corner of Prince of Wales Island, just across the El Capitan Passage from the larger island. The island is near Mount Francis, Holbrook Mountain, and Tokeen Peak. Kosciusko Island has a land area of 171.585 sq mi (444.403 km²), making it the 38th largest island in the United States. It had a population of 52 persons as of the 2000 census, mostly in Edna Bay, its largest community.»<br/><br/>Question: `William Hughes Miller was born in a city with how many inhabitants ?<br/><br/>Reasoning: Let's think step by step in order to Answer: 7,402<br/><br/>Answer: 7,402</span></pre><h1 id="6603" class="pk pl fq bf pm pn po gq pp pq pr gt ps pt pu pv pw px py pz qa qb qc qd qe qf bk">Conclusion</h1><p id="c7e6" class="pw-post-body-paragraph nc nd fq ne b go qg ng nh gr qh nj nk nl qi nn no np qj nr ns nt qk nv nw nx fj bk">Currently we often rely on manual prompt engineering at best abstracted as f-string. Also, for LM comparison we often raise underspecified questions like “how do different LMs compare on a certain problem”, borrowed from the <a class="af og" href="https://arxiv.org/abs/2310.03714" rel="noopener ugc nofollow" target="_blank">Stanford NLP paper</a>’s saying.</p><p id="12cc" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">But as the above examples demonstrate, with DSPy’s modular, composable programs and optimizers, we are now equipped to answer toward <strong class="ne fr">“how they compare on a certain problem with Module X when compiled with Optimizer Y”</strong>, which is a well-defined and reproducible run, thus reducing the role of artful prompt construction in modern AI.</p><p id="c154" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">That’s it! Hope you enjoy this article.</p><p id="703f" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk"><em class="oh">*Unless otherwise noted, all images are by the author</em></p></div></div></div></div>    
</body>
</html>