<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Improving Code Quality During Data Transformation with Polars</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Improving Code Quality During Data Transformation with Polars</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/improving-code-quality-during-data-transformation-with-polars-92997e67c8a9?source=collection_archive---------10-----------------------#2024-08-09">https://towardsdatascience.com/improving-code-quality-during-data-transformation-with-polars-92997e67c8a9?source=collection_archive---------10-----------------------#2024-08-09</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="gr gs gt gu gv ab"><div><div class="ab gw"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@npotapov?source=post_page---byline--92997e67c8a9--------------------------------" rel="noopener follow"><div class="l gx gy by gz ha"><div class="l ed"><img alt="Nikolai Potapov" class="l ep by dd de cx" src="../Images/d2ac4b8c12c0cf70df05b8908b875a19.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/1*PsaRu1yGvqnvkofyj6pyNQ.jpeg"/><div class="hb by l dd de em n hc eo"/></div></div></a></div></div><div class="hd ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--92997e67c8a9--------------------------------" rel="noopener follow"><div class="l he hf by gz hg"><div class="l ed"><img alt="Towards Data Science" class="l ep by br hh cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hb by l br hh em n hc eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hi ab q"><div class="ab q hj"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hk hl bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hm" data-testid="authorName" href="https://medium.com/@npotapov?source=post_page---byline--92997e67c8a9--------------------------------" rel="noopener follow">Nikolai Potapov</a></p></div></div></div><span class="hn ho" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hk hl dx"><button class="hp hq ah ai aj ak al am an ao ap aq ar hr hs ht" disabled="">Follow</button></p></div></div></span></div></div><div class="l hu"><span class="bf b bg z dx"><div class="ab cn hv hw hx"><div class="hy hz ab"><div class="bf b bg z dx ab ia"><span class="ib l hu">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hm ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--92997e67c8a9--------------------------------" rel="noopener follow"><p class="bf b bg z ic id ie if ig ih ii ij bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="hn ho" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">6 min read</span><div class="ik il l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Aug 9, 2024</span></div></span></div></span></div></div></div><div class="ab cp im in io ip iq ir is it iu iv iw ix iy iz ja jb"><div class="h k w ea eb q"><div class="jr l"><div class="ab q js jt"><div class="pw-multi-vote-icon ed ib ju jv jw"><div class=""><div class="jx jy jz ka kb kc kd am ke kf kg jw"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kh ki kj kk kl km kn"><p class="bf b dy z dx"><span class="jy">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao jx ko kp ab q ee kq kr" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="ks"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg></button></div></div></div><div class="ab q jc jd je jf jg jh ji jj jk jl jm jn jo jp jq"><div class="kt k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al ku an ao ap hr kv kw kx" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep ky cn"><div class="l ae"><div class="ab cb"><div class="kz la lb lc ld le ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al ku an ao ap hr lf lg kr lh li lj lk ll s lm ln lo lp lq lr ls u lt lu lv"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al ku an ao ap hr lf lg kr lh li lj lk ll s lm ln lo lp lq lr ls u lt lu lv"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al ku an ao ap hr lf lg kr lh li lj lk ll s lm ln lo lp lq lr ls u lt lu lv"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><figure class="lz ma mb mc md me lw lx paragraph-image"><div role="button" tabindex="0" class="mf mg ed mh bh mi"><div class="lw lx ly"><img src="../Images/32683c335dbe8f17d37fc6ceaac04d46.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YZtz4BEvv9uTjxxUfCUogw.jpeg"/></div></div><figcaption class="mk ml mm lw lx mn mo bf b bg z dx">Image created with AI by Dall-E</figcaption></figure><p id="727a" class="pw-post-body-paragraph mp mq fq mr b ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm fj bk nn"><span class="l no np nq bo nr ns nt nu nv ed">In</span> our daily lives as Data/Analytic Engineers, writing ETL/ELT workflows and pipelines (or perhaps your company uses a different term) is a routine and integral part of our work. However, in this article, I will focus only on the Transformation stage. Why? Because at this stage, data from various sources and of different types acquires business significance for the company. This stage is very important and also incredibly delicate, as an error can instantly mislead the user, causing them to lose trust in your data.</p><p id="f527" class="pw-post-body-paragraph mp mq fq mr b ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm fj bk">To illustrate the process of improving code quality, let’s consider a hypothetical example. Imagine a website where we log user actions, such as what they viewed and purchased. We’ll have <code class="cx nw nx ny nz b">user_id</code> for the user ID, <code class="cx nw nx ny nz b">product_id</code> for the product, <code class="cx nw nx ny nz b">action_type</code> for the type of action (either a view or purchase), and <code class="cx nw nx ny nz b">action_dt</code> for the action timestamp.</p><pre class="oa ob oc od oe of nz og bp oh bb bk"><span id="8229" class="oi oj fq nz b bg ok ol l om on">from dataclasses import dataclass<br/>from datetime import datetime, timedelta<br/>from random import choice, gauss, randrange, seed<br/>from typing import Any, Dict<br/><br/>import polars as pl<br/><br/>seed(42)</span></pre><pre class="oo of nz og bp oh bb bk"><span id="674e" class="oi oj fq nz b bg ok ol l om on">base_time= datetime(2024, 8, 9, 0, 0, 0, 0)<br/><br/>user_actions_data = [<br/>    {<br/>        "user_id": randrange(10),<br/>        "product_id": choice(["0001", "0002", "0003"]),<br/>        "action_type": ("purchase" if gauss() &gt; 0.6 else "view"),<br/>        "action_dt": base_time - timedelta(minutes=randrange(100_000)),<br/>    }<br/>    for x in range(100_000)<br/>]<br/><br/>user_actions_df = pl.DataFrame(user_actions_data)</span></pre><p id="f147" class="pw-post-body-paragraph mp mq fq mr b ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm fj bk">Additionally, for our task, we’ll need a product catalog, which in our case will include only <code class="cx nw nx ny nz b">product_id</code> and its price (<code class="cx nw nx ny nz b">price</code>). Our data is now ready for the example.</p><pre class="oa ob oc od oe of nz og bp oh bb bk"><span id="7494" class="oi oj fq nz b bg ok ol l om on">product_catalog_data = {"product_id": ["0001", "0002", "0003"], "price": [10, 30, 70]}<br/>product_catalog_df = pl.DataFrame(product_catalog_data)</span></pre><p id="7d18" class="pw-post-body-paragraph mp mq fq mr b ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm fj bk">Now, let’s tackle our first task: creating a report that will contain the total purchase amount and the ratio of the number of purchased items to viewed items from the previous day for each user. This task isn’t particularly complex and can be quickly implemented. Here’s how it might look using Polars:</p><pre class="oa ob oc od oe of nz og bp oh bb bk"><span id="0132" class="oi oj fq nz b bg ok ol l om on">yesterday = base_time - timedelta(days=1)<br/>result = (<br/>    user_actions_df.filter(pl.col("action_dt").dt.date() == yesterday.date())<br/>    .join(product_catalog_df, on="product_id")<br/>    .group_by(pl.col("user_id"))<br/>    .agg(<br/>        [<br/>            (<br/>                pl.col("price")<br/>                .filter(pl.col("action_type") == "purchase")<br/>                .sum()<br/>            ).alias("total_purchase_amount"),<br/>            (<br/>                pl.col("product_id").filter(pl.col("action_type") == "purchase").len()<br/>                / pl.col("product_id").filter(pl.col("action_type") == "view").len()<br/>            ).alias("purchase_to_view_ratio"),<br/>        ]<br/>    )<br/>    .sort("user_id")<br/>)</span></pre><p id="ac8b" class="pw-post-body-paragraph mp mq fq mr b ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm fj bk">This is a working solution that could be deployed to production, some might say, but not us since you’ve opened this article. At the beginning, I emphasized that I would focus specifically on the transformation step.</p><p id="ff54" class="pw-post-body-paragraph mp mq fq mr b ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm fj bk">If we think about the long-term maintenance of this code, testing, and remember that there will be hundreds of such reports, we must recognize that each subsequent developer will understand this code less than the previous one, thereby increasing the chances of errors with every change.</p><p id="6873" class="pw-post-body-paragraph mp mq fq mr b ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm fj bk">I would like to reduce this risk, and that’s why I’ve come to the following approach:</p><p id="8083" class="pw-post-body-paragraph mp mq fq mr b ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm fj bk"><strong class="mr fr">Step 1</strong>: Let’s separate all the business logic into a distinct class, such as <code class="cx nw nx ny nz b">DailyUserPurchaseReport</code>.</p><pre class="oa ob oc od oe of nz og bp oh bb bk"><span id="6b57" class="oi oj fq nz b bg ok ol l om on">@dataclass<br/>class DailyUserPurchaseReport:</span></pre><p id="7629" class="pw-post-body-paragraph mp mq fq mr b ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm fj bk"><strong class="mr fr">Step 2</strong>: Let’s define the arguments this class should accept: <code class="cx nw nx ny nz b">sources</code> - various sources we need for our work, and <code class="cx nw nx ny nz b">params</code> - variable parameters that may change, in our case, this could be the report date.</p><pre class="oa ob oc od oe of nz og bp oh bb bk"><span id="09e8" class="oi oj fq nz b bg ok ol l om on">@dataclass<br/>class DailyUserPurchaseReport:<br/><br/>    sources: Dict[str, pl.LazyFrame]<br/>    params: Dict[str, Any]</span></pre><p id="6248" class="pw-post-body-paragraph mp mq fq mr b ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm fj bk"><strong class="mr fr">Step 3</strong>: Define a method that will perform the transformation, for example, <code class="cx nw nx ny nz b">execute</code>.</p><pre class="oa ob oc od oe of nz og bp oh bb bk"><span id="e3bd" class="oi oj fq nz b bg ok ol l om on">@dataclass<br/>class DailyUserPurchaseReport:<br/><br/>    sources: Dict[str, pl.LazyFrame]<br/>    params: Dict[str, Any]<br/><br/>    def execute(self) -&gt; pl.DataFrame:<br/>        pass</span></pre><p id="9eb2" class="pw-post-body-paragraph mp mq fq mr b ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm fj bk"><strong class="mr fr">Step 4</strong>: Break down the entire process into separate functions that accept a <code class="cx nw nx ny nz b">pl.LazyFrame</code> and also return a <code class="cx nw nx ny nz b">pl.LazyFrame</code>.</p><pre class="oa ob oc od oe of nz og bp oh bb bk"><span id="d581" class="oi oj fq nz b bg ok ol l om on">@dataclass<br/>class DailyUserPurchaseReport:<br/><br/>    sources: Dict[str, pl.LazyFrame]<br/>    params: Dict[str, Any]<br/><br/>    def _filter_actions_by_date(self, frame: pl.LazyFrame) -&gt; pl.LazyFrame:<br/>        pass<br/><br/>    def _enrich_user_actions_from_product_catalog(self, frame: pl.LazyFrame) -&gt; pl.LazyFrame:<br/>        pass<br/>    <br/>    def _calculate_key_metrics(self, frame: pl.LazyFrame) -&gt; pl.LazyFrame:<br/>        pass<br/><br/>    def execute(self) -&gt; pl.DataFrame:<br/>        pass</span></pre><p id="2877" class="pw-post-body-paragraph mp mq fq mr b ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm fj bk"><strong class="mr fr">Step 5</strong>: Now, use the magic function <code class="cx nw nx ny nz b">pipe</code> to connect our entire pipeline together. This is precisely why we use <code class="cx nw nx ny nz b">pl.LazyFrame</code> everywhere:</p><pre class="oa ob oc od oe of nz og bp oh bb bk"><span id="ae96" class="oi oj fq nz b bg ok ol l om on">    def execute(self) -&gt; pl.DataFrame:<br/>        result: pl.DataFrame = (<br/>            self.sources["user_actions"]<br/>            .pipe(self._filter_actions_by_date)<br/>            .pipe(self._enrich_user_actions_from_product_catalog)<br/>            .pipe(self._calculate_key_metrics)<br/>            .collect()<br/>        )<br/>        return result</span></pre><blockquote class="op oq or"><p id="36e0" class="mp mq os mr b ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm fj bk"><em class="fq">It is recommended to use LazyFrame when piping operations, in order to fully take advantage of query optimization and parallelization.</em></p></blockquote><p id="c8ff" class="pw-post-body-paragraph mp mq fq mr b ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm fj bk">Final code:</p><pre class="oa ob oc od oe of nz og bp oh bb bk"><span id="0d20" class="oi oj fq nz b bg ok ol l om on">@dataclass<br/>class DailyUserPurchaseReport:<br/>    """<br/>    Generates a report containing the total purchase amount and the ratio of purchased items<br/>    to viewed items from the previous day for each user.<br/><br/>    Attributes:<br/>        sources (Dict[str, pl.LazyFrame]): A dictionary containing the data sources, including:<br/>            - 'user_actions': A LazyFrame containing user actions data.<br/>            - 'product_catalog': A LazyFrame containing product catalog data.<br/>        params (Dict[str, Any]): A dictionary containing parameters, including:<br/>            - 'report_date': The date for which the report should be generated (previous day).<br/>    """<br/><br/>    sources: Dict[str, pl.LazyFrame]<br/>    params: Dict[str, Any]<br/><br/>    def _filter_actions_by_date(self, frame: pl.LazyFrame) -&gt; pl.LazyFrame:<br/>        """<br/>         Filters user actions data to include only records from the specified date.<br/><br/>        Args:<br/>            frame (pl.LazyFrame): A LazyFrame containing user actions data.<br/><br/>        Returns:<br/>            pl.LazyFrame: A LazyFrame containing user actions data filtered by the specified date.<br/>        """<br/>        return frame.filter(pl.col("action_dt").dt.date() == self.params["report_date"])<br/><br/>    def _enrich_user_actions_from_product_catalog(<br/>        self, frame: pl.LazyFrame<br/>    ) -&gt; pl.LazyFrame:<br/>        """<br/>        Joins the user actions data with the product catalog to include product prices.<br/><br/>        Args:<br/>            frame (pl.LazyFrame): A LazyFrame containing user actions data.<br/><br/>        Returns:<br/>            pl.LazyFrame: A LazyFrame containing user actions data enriched with product prices.<br/>        """<br/>        return frame.join(self.sources["product_catalog"], on="product_id")<br/><br/>    def _calculate_key_metrics(self, frame: pl.LazyFrame) -&gt; pl.LazyFrame:<br/>        """<br/>        Calculates the total purchase amount and the ratio of purchased items to viewed items.<br/><br/>        Args:<br/>            frame (pl.LazyFrame): A LazyFrame containing enriched user actions data.<br/><br/>        Returns:<br/>            pl.LazyFrame: A LazyFrame containing the total purchase amount and purchase-to-view ratio for each user.<br/>        <br/>        """<br/>        return (<br/>            frame.group_by(pl.col("user_id"))<br/>            .agg(<br/>                [<br/>                    (<br/>                        pl.col("price")<br/>                        .filter(pl.col("action_type") == "purchase")<br/>                        .sum()<br/>                    ).alias("total_purchase_amount"),<br/>                    (<br/>                        pl.col("product_id")<br/>                        .filter(pl.col("action_type") == "purchase")<br/>                        .len()<br/>                        / pl.col("product_id").filter(pl.col("action_type") == "view").len()<br/>                    ).alias("purchase_to_view_ratio"),<br/>                ]<br/>            )<br/>            .sort("user_id")<br/>        )<br/><br/>    def execute(self) -&gt; pl.DataFrame:<br/>        """<br/>        Executes the report generation process.<br/><br/>        This method performs the following steps:<br/>            1. Filters user actions data to include only records from the previous day.<br/>            2. Joins the filtered user actions data with the product catalog.<br/>            3. Calculates the total purchase amount and purchase-to-view ratio for each user.<br/>            4. Returns the final report as a DataFrame.<br/><br/>        Returns:<br/>            pl.DataFrame: A DataFrame containing the total purchase amount and purchase-to-view ratio for each user.<br/>        """<br/>        result: pl.DataFrame = (<br/>            self.sources["user_actions"]<br/>            .pipe(self._filter_actions_by_date)<br/>            .pipe(self._enrich_user_actions_from_product_catalog)<br/>            .pipe(self._calculate_key_metrics)<br/>            .collect()<br/>        )<br/>        return result</span></pre><p id="9f91" class="pw-post-body-paragraph mp mq fq mr b ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm fj bk">Let’s check the execution:</p><pre class="oa ob oc od oe of nz og bp oh bb bk"><span id="f44c" class="oi oj fq nz b bg ok ol l om on"># prepare sources<br/>user_actions: pl.LazyFrame = user_actions_df.lazy()<br/>product_catalog: pl.LazyFrame = product_catalog_df.lazy()<br/><br/># get report date<br/>yesterday: datetime = base_time - timedelta(days=1)<br/><br/># report calculation<br/>df: pl.DataFrame = DailyUserPurchaseReport(<br/>    sources={"user_actions": user_actions, "product_catalog": product_catalog},<br/>    params={"report_date": yesterday},<br/>).execute()</span></pre><p id="2723" class="pw-post-body-paragraph mp mq fq mr b ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm fj bk">Result:</p><pre class="oa ob oc od oe of nz og bp oh bb bk"><span id="8536" class="oi oj fq nz b bg ok ol l om on">┌─────────┬───────────────────────┬────────────────────────┐<br/>│ user_id ┆ total_purchase_amount ┆ purchase_to_view_ratio │<br/>│ ---     ┆ ---                   ┆ ---                    │<br/>│ i64     ┆ i64                   ┆ f64                    │<br/>╞═════════╪═══════════════════════╪════════════════════════╡<br/>│ 0       ┆ 1880                  ┆ 0.422018               │<br/>│ 1       ┆ 1040                  ┆ 0.299065               │<br/>│ 2       ┆ 2220                  ┆ 0.541667               │<br/>│ 3       ┆ 1480                  ┆ 0.436782               │<br/>│ 4       ┆ 1240                  ┆ 0.264463               │<br/>│ 5       ┆ 930                   ┆ 0.254717               │<br/>│ 6       ┆ 1080                  ┆ 0.306122               │<br/>│ 7       ┆ 1510                  ┆ 0.345133               │<br/>│ 8       ┆ 2050                  ┆ 0.536842               │<br/>│ 9       ┆ 1320                  ┆ 0.414414               │<br/>└─────────┴───────────────────────┴────────────────────────┘</span></pre><h1 id="a619" class="ot oj fq bf ou ov ow ox oy oz pa pb pc pd pe pf pg ph pi pj pk pl pm pn po pp bk">Bonus</h1><p id="36a1" class="pw-post-body-paragraph mp mq fq mr b ms pq mu mv mw pr my mz na ps nc nd ne pt ng nh ni pu nk nl nm fj bk">For those using Test-Driven Development (TDD), this approach is especially beneficial. TDD emphasizes writing tests before the actual implementation. By having clearly defined, small functions, you can write precise tests for each part of the transformation process, ensuring that each function behaves as expected. This not only makes the process smoother but also ensures that your transformations are thoroughly validated at each step.</p><h1 id="5f4f" class="ot oj fq bf ou ov ow ox oy oz pa pb pc pd pe pf pg ph pi pj pk pl pm pn po pp bk">Conclusion</h1><p id="a898" class="pw-post-body-paragraph mp mq fq mr b ms pq mu mv mw pr my mz na ps nc nd ne pt ng nh ni pu nk nl nm fj bk">In this article, I have outlined a structured approach to improving code quality in your data workflows using Polars. By isolating the transformation step and breaking down the process into distinct, manageable parts, we ensure that our code is both robust and maintainable. Through the use of <code class="cx nw nx ny nz b">pl.LazyFrame</code> and the <code class="cx nw nx ny nz b">pipe</code> function, we take full advantage of Polars capabilities for query optimization and parallelization. This method not only enhances the efficiency of our data transformations but also ensures the integrity and business relevance of the data we work with. By following these steps, you can create more reliable and scalable data workflows, ultimately leading to better data-driven decision-making.</p><h1 id="5ee2" class="ot oj fq bf ou ov ow ox oy oz pa pb pc pd pe pf pg ph pi pj pk pl pm pn po pp bk">Share Your Experience</h1><p id="2fe4" class="pw-post-body-paragraph mp mq fq mr b ms pq mu mv mw pr my mz na ps nc nd ne pt ng nh ni pu nk nl nm fj bk">If you have experience or useful tips, share your opinion in the comments. It’s always interesting to learn the experiences of other developers.</p></div></div></div></div>    
</body>
</html>