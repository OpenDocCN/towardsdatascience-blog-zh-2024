<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Drawing From a Random Distribution in SQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Drawing From a Random Distribution in SQL</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/drawing-from-a-random-distribution-in-sql-b6c97c89e45c?source=collection_archive---------10-----------------------#2024-02-09">https://towardsdatascience.com/drawing-from-a-random-distribution-in-sql-b6c97c89e45c?source=collection_archive---------10-----------------------#2024-02-09</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="7bbe" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx">From a probability density function to random samples</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hd he hf hg hh ab"><div><div class="ab hi"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@samiabboud?source=post_page---byline--b6c97c89e45c--------------------------------" rel="noopener follow"><div class="l hj hk by hl hm"><div class="l ed"><img alt="Sami Abboud" class="l ep by dd de cx" src="../Images/546a33fe92a194068816e6173eaa854a.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/1*ZRViF6RmvVuhQzcIynWm8g.jpeg"/><div class="hn by l dd de em n ho eo"/></div></div></a></div></div><div class="hp ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--b6c97c89e45c--------------------------------" rel="noopener follow"><div class="l hq hr by hl hs"><div class="l ed"><img alt="Towards Data Science" class="l ep by br ht cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hn by l br ht em n ho eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hu ab q"><div class="ab q hv"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hw hx bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hy" data-testid="authorName" href="https://medium.com/@samiabboud?source=post_page---byline--b6c97c89e45c--------------------------------" rel="noopener follow">Sami Abboud</a></p></div></div></div><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hw hx dx"><button class="ib ic ah ai aj ak al am an ao ap aq ar id ie if" disabled="">Follow</button></p></div></div></span></div></div><div class="l ig"><span class="bf b bg z dx"><div class="ab cn ih ii ij"><div class="ik il ab"><div class="bf b bg z dx ab im"><span class="in l ig">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hy ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--b6c97c89e45c--------------------------------" rel="noopener follow"><p class="bf b bg z io ip iq ir is it iu iv bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">8 min read</span><div class="iw ix l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Feb 9, 2024</span></div></span></div></span></div></div></div><div class="ab cp iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn"><div class="h k w ea eb q"><div class="kd l"><div class="ab q ke kf"><div class="pw-multi-vote-icon ed in kg kh ki"><div class=""><div class="kj kk kl km kn ko kp am kq kr ks ki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kt ku kv kw kx ky kz"><p class="bf b dy z dx"><span class="kk">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kj la lb ab q ee lc ld" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="le"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg></button></div></div></div><div class="ab q jo jp jq jr js jt ju jv jw jx jy jz ka kb kc"><div class="lf k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lg an ao ap id lh li lj" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep lk cn"><div class="l ae"><div class="ab cb"><div class="ll lm ln lo lp lq ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lg an ao ap id lr ls ld lt lu lv lw lx s ly lz ma mb mc md me u mf mg mh"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lg an ao ap id lr ls ld lt lu lv lw lx s ly lz ma mb mc md me u mf mg mh"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lg an ao ap id lr ls ld lt lu lv lw lx s ly lz ma mb mc md me u mf mg mh"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj mk"><img src="../Images/22d2395939286048baeef0d7e72e1687.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vX6T4Uz3wC6dZwr3PaqIBg.jpeg"/></div></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">Photo by <a class="af nb" href="https://unsplash.com/@moritz_photography?utm_content=creditCopyText&amp;utm_medium=referral&amp;utm_source=unsplash" rel="noopener ugc nofollow" target="_blank">Moritz Kindler</a> on <a class="af nb" href="https://unsplash.com/photos/white-and-black-polka-dot-ceramic-mug-with-water-okiy0SxOaBg?utm_content=creditCopyText&amp;utm_medium=referral&amp;utm_source=unsplash" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="e117" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk ny"><span class="l nz oa ob bo oc od oe of og ed">T</span>here are different methods for updating a reinforcement learning agent’s policy at each iteration. A few weeks ago we started experimenting with replacing our current method with a Bayesian inference step. Some of the data workloads within our agent are written in SQL that is executed on GCP’s BigQuery engine. We use this stack because it provides scalable computational capabilities, ML packages and a straightforward SQL interface.</p><p id="a0e5" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">The Bayesian inference step we looked to implement uses one of the <a class="af nb" href="https://en.wikipedia.org/wiki/Beta_distribution#Mean_and_sample_size" rel="noopener ugc nofollow" target="_blank">alternative parametrizations of a beta distribution</a>. Which means that we will need to be able to draw from a beta distribution in SQL. While working on this, I discovered that drawing from the random distribution in SQL is a topic with very few well documented examples. So I’m writing about it here..</p><h1 id="7c20" class="oh oi fq bf oj ok ol gq om on oo gt op oq or os ot ou ov ow ox oy oz pa pb pc bk">Step 1: How hard could it be?</h1><p id="356b" class="pw-post-body-paragraph nc nd fq ne b go pd ng nh gr pe nj nk nl pf nn no np pg nr ns nt ph nv nw nx fj bk">BigQuery doesn’t have a beta distribution. It doesn’t have the capability to draw from <em class="pi">any</em> random distribution. So my first intuition was to take the definition of the beta distribution, write it in SQL, set the parameters using a CTA, draw a random number between 0 and 1 and compute the value of that function.</p><p id="e971" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">But it’s 2024, so I asked ChatGPT how it would do it:</p><p id="535d" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk"><strong class="ne fr">Me</strong>: “​How do you create random draws from a beta distribution in BigQuery?</p><p id="ef0f" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk"><strong class="ne fr">ChatGPT</strong>:</p><pre class="ml mm mn mo mp pj pk pl bp pm bb bk"><span id="a139" class="pn oi fq pk b bg po pp l pq pr">WITH beta_draws AS (<br/> SELECT<br/> (alpha — 1) / (alpha + beta — 2) AS a,<br/> (beta — 1) / (alpha + beta — 2) AS b<br/> FROM<br/> (SELECT 2 AS alpha, 5 AS beta) — Set your desired alpha and beta values<br/>)<br/>SELECT<br/> (a * POW(RAND(), alpha - 1) * POW(1 - RAND(), beta - 1) + b) AS beta_draw<br/>FROM<br/> beta_draws,<br/> UNNEST(GENERATE_ARRAY(1, 1000)) AS rand_num</span></pre><p id="9fde" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk"><strong class="ne fr">Me</strong> <em class="pi">thinking to myself</em>: Right, so that clearly won’t work.</p><p id="9946" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Do you see the problem in the code? ChatGPT draws two <em class="pi">different</em> x values for the presumed beta distribution PDF. I fixed this, cleaned up the query a little and sampled 1,000 values. And here’s the SQL code for doing that:</p><pre class="ml mm mn mo mp pj pk pl bp pm bb bk"><span id="13e8" class="pn oi fq pk b bg po pp l pq pr">WITH raw_data AS (<br/> SELECT<br/> ‘user_a’ AS contact_id<br/> , 0.674 AS probability<br/> , 72 AS lifetime_messages_received<br/>), parameters AS (<br/> SELECT<br/> contact_id<br/> , probability*lifetime_messages_received AS alpha<br/> , (1.0 — probability)*lifetime_messages_received AS beta<br/> , RAND() AS x<br/> FROM raw_data<br/> CROSS JOIN UNNEST(GENERATE_ARRAY(1, 1000)) AS draw_id<br/>)<br/>SELECT<br/> contact_id<br/> , ARRAY_AGG(POW(x, alpha — 1.0) * POW(1.0 — x, beta — 1)) AS beta_x<br/>FROM parameters<br/>GROUP BY contact_id</span></pre><p id="a301" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Thank you all, that’s a wrap 🎁 See you in the next post!</p><p id="c8f2" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">WRONG! 🔴</p><p id="95a4" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Let’s take a trusted implementation of drawing from a beta distribution using the same parameters and compare the results. I’ve used SciPy’s <code class="cx ps pt pu pk b">beta.rvs()</code> in Python and here are two 100-bin histograms that will allow comparing the two drawn distributions.</p><pre class="ml mm mn mo mp pj pk pl bp pm bb bk"><span id="8cee" class="pn oi fq pk b bg po pp l pq pr">from scipy.stats import beta<br/><br/>alpha_param = 0.674 * 72<br/>beta_param = (1–0.674) * 72<br/><br/>scipy_beta_draw = beta.rvs(alpha_param, beta_param, size=1000)</span></pre><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj pv"><img src="../Images/8fd72857adf2b4861d92580c4316de1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kk5MNZfWFDhydj7IyWc14Q.png"/></div></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">(<strong class="bf oj">Left)</strong>: Naive draws using BigQuery. (<strong class="bf oj">Right</strong>): Draws using SciPy’s beta.rvs()</figcaption></figure><p id="7ee7" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Well, it doesn’t take a magnifying glass to realize that the distributions are different. I went back the beta distribution definition and realized that it might be because the beta distribution also has a scaling constant which depends on the <a class="af nb" href="https://en.wikipedia.org/wiki/Gamma_function" rel="noopener ugc nofollow" target="_blank">gamma function</a> that I didn’t include in the calculation 🤦.</p><p id="acdf" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk"><strong class="ne fr">Problem:</strong> the gamma function does not have a <a class="af nb" href="https://en.wikipedia.org/wiki/Closed-form_expression" rel="noopener ugc nofollow" target="_blank">closed-form expression</a>, and BigQuery doesn’t provide an implementation that approximates it. So at this point I decided to switch to Python, a language that I’m more familiar with and will make my experimentation more efficient. The thinking was that if I nail it down in Python, I’ll be able to translate it to SQL. I would still need some way to approximate a gamma function, but one step at a time.</p><h1 id="ec9c" class="oh oi fq bf oj ok ol gq om on oo gt op oq or os ot ou ov ow ox oy oz pa pb pc bk">Step 2: What does drawing from a random distribution actually mean?</h1><p id="74e5" class="pw-post-body-paragraph nc nd fq ne b go pd ng nh gr pe nj nk nl pf nn no np pg nr ns nt ph nv nw nx fj bk">Let’s implement a manual draw from a beta distribution in Python, but now with the correct constant using SciPy’s gamma function:</p><pre class="ml mm mn mo mp pj pk pl bp pm bb bk"><span id="a438" class="pn oi fq pk b bg po pp l pq pr">import numpy as np<br/>from scipy.special import gamma<br/>from scipy.stats import uniform<br/><br/>alpha_param = 0.674 * 72<br/>beta_param = (1–0.674) * 72<br/><br/>constant = gamma(alpha_param + beta_param) / (gamma(alpha_param) * gamma(beta_param))<br/>scipy_manual_beta_draw = np.array([<br/> constant*pow(x, alpha_param-1)*pow(1-x, beta_param-1)<br/> for x in uniform.rvs(size=1000)<br/>])</span></pre><p id="7bcd" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Let’s examine the distribution using a 100-bin histogram again:</p><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div class="mi mj pw"><img src="../Images/de29f9bc9661da1f062515f5e5ea0db7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/0*5X3_kPTn145tllOe"/></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">Naive draws using Python</figcaption></figure><p id="42b1" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">The first thing we notice is that the scale is now different, but the distribution still looks like the one drawn in BigQuery.</p><p id="3d1b" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk"><em class="pi">… something is wrong…</em> it’s time for a short walk to think 🚶</p><p id="2756" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">…</p><p id="879d" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk"><em class="pi">After a short walk:</em></p><p id="221d" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">What does drawing from a random distribution actually mean? What I’ve implemented so far is randomly sampling from the beta probability density function (PDF) and it wasn’t working.</p><p id="62a7" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">So I had to dig up some statistics classes.</p><p id="fc1a" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Here are a couple of good refreshers on:</p><ul class=""><li id="007e" class="nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx px py pz bk"><a class="af nb" href="https://stats.libretexts.org/Courses/Saint_Mary's_College_Notre_Dame/MATH_345__-_Probability_(Kuter)/4%3A_Continuous_Random_Variables/4.1%3A_Probability_Density_Functions_(PDFs)_and_Cumulative_Distribution_Functions_(CDFs)_for_Continuous_Random_Variables" rel="noopener ugc nofollow" target="_blank">Probability Density Functions (PDFs) and Cumulative Distribution Functions (CDFs) for Continuous Random Variables</a>, and</li><li id="beb0" class="nc nd fq ne b go qa ng nh gr qb nj nk nl qc nn no np qd nr ns nt qe nv nw nx px py pz bk"><a class="af nb" href="https://web.mit.edu/urban_or_book/www/book/chapter7/7.1.3.html" rel="noopener ugc nofollow" target="_blank">Generating Samples from Probability Distributions</a> that I found helpful.</li></ul><p id="7137" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">In short, the conclusion is that drawing from a random variable actually means <strong class="ne fr">sampling from the inverse cumulative distribution function (CDF)</strong>, not from the probability density function (PDF) like I was doing so far.</p><p id="0bb7" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Of course 🤦. My <a class="af nb" href="https://web.iem.technion.ac.il/dmitry-dima-ioffe-1963-2020/" rel="noopener ugc nofollow" target="_blank">probability professor</a>, who I just learned had passed away from illness in 2020, would have encouraged me to “review the basics” at this point..</p><p id="a086" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Ok. Let’s revisit the Python code, now drawing samples from the inverse CDF (which is also called <a class="af nb" href="https://en.wikipedia.org/wiki/Quantile_function" rel="noopener ugc nofollow" target="_blank">the quantile function</a>) of our beta distribution, and compare it to the distribution drawn using SciPy’s beta.rvs():</p><pre class="ml mm mn mo mp pj pk pl bp pm bb bk"><span id="2720" class="pn oi fq pk b bg po pp l pq pr">import numpy as np<br/>from scipy.special import gamma<br/>from scipy.stats import uniform, beta<br/><br/>alpha_param = 0.674 * 72<br/>beta_param = (1–0.674) * 72<br/>n_draws = 1000<br/><br/># Use SciPy RVS for comparison<br/>scipy_beta_draw = beta.rvs(alpha_param, beta_param, size=n_draws)<br/><br/># Manual beta draw with the help of the SciPy Gamma function<br/><br/># We start with a discrete analogue of the Beta PDF we wish to draw from.<br/># This is just sampling from the PDF at fixed intervals but do check out<br/># this review for a more in-depth treatment of the subject:<br/># https://jsdajournal.springeropen.com/articles/10.1186/s40488-015-0028-6<br/><br/># Set the resolution for generating the discrete PDF<br/>n_samples = 1000<br/><br/># The beta distribution is supported on the range [0, 1], so we set the<br/># pdf min and max parameters accordingly<br/>pdf_min = 0.0<br/>pdf_max = 1.0<br/><br/>x_span = np.linspace(pdf_min, pdf_max, n_samples)<br/>constant = gamma(alpha_param + beta_param) / (gamma(alpha_param) * gamma(beta_param))<br/>beta_pdf = np.array([<br/> constant * pow(x, alpha_param — 1) * pow(1 — x, beta_param — 1)<br/> for x in x_span<br/>])<br/><br/># Using the discrete Beta PDF, we now compute a discrete Beta CDF.<br/># To do that, we integrate the PDF. For each point x, we sum the PDF until<br/># that point and multiple with the width of each sample.<br/>freq = 1.0 / n_samples<br/>beta_cdf = beta_pdf.cumsum() * freq<br/><br/>def inv(cdf, q):<br/> “””Return inverse CDF for value q using the quantile function”””<br/> return x_span[np.argmin(cdf &lt; q)]<br/><br/># Finally, we can now draw n_draws from the discrete inverse of CDF, aka<br/># generate random samples from a beta distribution<br/>manual_beta_draw = np.array([<br/> inv(beta_cdf, x)<br/> for x in uniform.rvs(size=n_draws)<br/>])</span></pre><p id="fbf5" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">*phew* this looks much better:</p><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div class="mi mj pw"><img src="../Images/eb08d3d0bc8cb8c045eba5cf4cbc73fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/0*65hoqYkgLkCF6MPt"/></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">An overlay of two histograms comparing a 1,000 draws using SciPy’s beta.rvs() and a manual draw</figcaption></figure><h1 id="d825" class="oh oi fq bf oj ok ol gq om on oo gt op oq or os ot ou ov ow ox oy oz pa pb pc bk">Step 3: Back to SQL</h1><p id="c9b8" class="pw-post-body-paragraph nc nd fq ne b go pd ng nh gr pe nj nk nl pf nn no np pg nr ns nt ph nv nw nx fj bk">Now that we’ve got drawing samples from a random variable straight, it’s time to move back to SQL. For the sake of simplicity, and because BigQuery does not readily come with an implementation of a Gamma function¹ I’m going to draw from the <a class="af nb" href="https://en.wikipedia.org/wiki/Logistic_distribution" rel="noopener ugc nofollow" target="_blank">logistic distribution</a> (with parameters a=0 and b=1).</p><pre class="ml mm mn mo mp pj pk pl bp pm bb bk"><span id="bda5" class="pn oi fq pk b bg po pp l pq pr"> — The following 3 parameters need to be adjusted based on the support of the<br/> — PDF of the distribution you wish to draw from. This values are set for a logistic<br/> — distribution with a=0 and b=1<br/><br/>DECLARE pdf_min INT64 DEFAULT -10;<br/>DECLARE pdf_max INT64 DEFAULT 10;<br/>DECLARE n_samples INT64 DEFAULT 5000;<br/>DECLARE sampling_step FLOAT64 DEFAULT (pdf_max — pdf_min) / n_samples;<br/><br/>— The number of random draws you wish to perform<br/>DECLARE n_draws INT64 DEFAULT 1000;<br/><br/>WITH pdf AS (<br/><br/> — The discrete sampling of the logistic distribution PDF<br/> <br/> SELECT<br/> x<br/> , exp(-x) / pow(1 + exp(-x), 2) AS y — a=0, b=1<br/> FROM UNNEST(GENERATE_ARRAY(pdf_min, pdf_max, sampling_step)) AS x<br/>), cdf AS (<br/><br/> — The discrete CDF<br/> <br/> SELECT<br/> x<br/> , SUM(y)<br/> OVER (<br/> ORDER BY x<br/> ) * (1.0 / n_samples) AS y<br/> FROM pdf<br/>), random_draws AS (<br/> <br/> — Random draws in the range of [0, max(cdf)]<br/> <br/> SELECT<br/> RAND() * (SELECT MAX(y) FROM cdf) as q<br/> , draw_id<br/> FROM UNNEST(GENERATE_ARRAY(1, n_draws)) AS draw_id<br/>)<br/><br/> — Calculate the inverse CDF per draw using the quantile function by generating<br/> — and array of the discrete support of the distribution and returning the value<br/> — of the index just before the randomly generated number is larger than the CDF<br/><br/>SELECT<br/> ARRAY_AGG(x ORDER BY x)[OFFSET(SUM(CAST(y &lt; q AS INT64)))] AS x<br/>FROM random_draws<br/>JOIN cdf<br/>ON TRUE<br/>GROUP BY draw_id;</span></pre><p id="f5e2" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Let’s now compare the distributions of the three sampling methods:</p><ol class=""><li id="133b" class="nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx qf py pz bk">SciPy’s <code class="cx ps pt pu pk b">logistic.rvs()</code></li><li id="51f4" class="nc nd fq ne b go qa ng nh gr qb nj nk nl qc nn no np qd nr ns nt qe nv nw nx qf py pz bk">Manually sampling the logistic distribution PDF in Python and drawing a random sample as per Step 2 above</li><li id="b882" class="nc nd fq ne b go qa ng nh gr qb nj nk nl qc nn no np qd nr ns nt qe nv nw nx qf py pz bk">Doing the same in SQL</li></ol><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div class="mi mj qg"><img src="../Images/48e0f6a2ad13082a144664db8a95f8dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1058/format:webp/0*BiAc34V2JxcocY-G"/></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">An overlay of three histograms comparing 1,000 draws using SciPy’s beta.rvs(), a manual draw in Python and a manual draw in SQL</figcaption></figure><p id="316c" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">This looks like a success to me! 💪</p><p id="4055" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">This SQL code above samples from the logistic distribution, but it should work on any distribution where you are able to get a discrete representation of the PDF by sampling it at consistent intervals!</p></div></div></div><div class="ab cb qh qi qj qk" role="separator"><span class="ql by bm qm qn qo"/><span class="ql by bm qm qn qo"/><span class="ql by bm qm qn"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="b201" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">[1] I did go looking for an approximation of the Gamma function in SQL and eventually gave up. It is most probably possible to code an approximation of the Gamma function in SQL but that will need more research than I had time allocated. Beware of naively copy/pasting an approximation (e.g. translating one the of snippets in Rosetta Code to SQL) because those make assumptions on the gamma parameter that are not always obvious. For example, the Python snippet (translated from Ada) is only accurate for small gamma values.</p><p id="48a0" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">—</p><p id="9664" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk"><strong class="ne fr">This is the kind of work we do to keep improving Aampe, a reinforcement learning agent that personalizes emails, web/push notifications, SMS and WhatsApp messages for users.</strong></p><p id="b8a6" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk"><em class="pi">Unless stated otherwise, all images are by the author.</em></p></div></div></div></div>    
</body>
</html>