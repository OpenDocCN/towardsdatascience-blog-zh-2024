<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>How X (Twitter) Designed Its Home Timeline API: Lessons to Learn</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>How X (Twitter) Designed Its Home Timeline API: Lessons to Learn</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/api-design-of-x-twitter-home-timeline-da426f19edfe?source=collection_archive---------7-----------------------#2024-12-12">https://towardsdatascience.com/api-design-of-x-twitter-home-timeline-da426f19edfe?source=collection_archive---------7-----------------------#2024-12-12</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="f2e4" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx">A closer look at X’s API: fetching data, linking entities, and solving under-fetching.</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hd he hf hg hh ab"><div><div class="ab hi"><div><div class="bm" aria-hidden="false"><a href="https://trekhleb.medium.com/?source=post_page---byline--da426f19edfe--------------------------------" rel="noopener follow"><div class="l hj hk by hl hm"><div class="l ed"><img alt="Oleksii Trekhleb" class="l ep by dd de cx" src="../Images/9419c8111bc8907db115c822b2d11773.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/1*Wta1U5y3Q7wJ7EC_iEq7Nw.jpeg"/><div class="hn by l dd de em n ho eo"/></div></div></a></div></div><div class="hp ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--da426f19edfe--------------------------------" rel="noopener follow"><div class="l hq hr by hl hs"><div class="l ed"><img alt="Towards Data Science" class="l ep by br ht cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hn by l br ht em n ho eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hu ab q"><div class="ab q hv"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hw hx bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hy" data-testid="authorName" href="https://trekhleb.medium.com/?source=post_page---byline--da426f19edfe--------------------------------" rel="noopener follow">Oleksii Trekhleb</a></p></div></div></div><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hw hx dx"><button class="ib ic ah ai aj ak al am an ao ap aq ar id ie if" disabled="">Follow</button></p></div></div></span></div></div><div class="l ig"><span class="bf b bg z dx"><div class="ab cn ih ii ij"><div class="ik il ab"><div class="bf b bg z dx ab im"><span class="in l ig">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hy ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--da426f19edfe--------------------------------" rel="noopener follow"><p class="bf b bg z io ip iq ir is it iu iv bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">17 min read</span><div class="iw ix l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Dec 12, 2024</span></div></span></div></span></div></div></div><div class="ab cp iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn"><div class="h k w ea eb q"><div class="kd l"><div class="ab q ke kf"><div class="pw-multi-vote-icon ed in kg kh ki"><div class=""><div class="kj kk kl km kn ko kp am kq kr ks ki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kt ku kv kw kx ky kz"><p class="bf b dy z dx"><span class="kk">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kj la lb ab q ee lc ld" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="le"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg></button></div></div></div><div class="ab q jo jp jq jr js jt ju jv jw jx jy jz ka kb kc"><div class="lf k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lg an ao ap id lh li lj" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep lk cn"><div class="l ae"><div class="ab cb"><div class="ll lm ln lo lp lq ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lg an ao ap id lr ls ld lt lu lv lw lx s ly lz ma mb mc md me u mf mg mh"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lg an ao ap id lr ls ld lt lu lv lw lx s ly lz ma mb mc md me u mf mg mh"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lg an ao ap id lr ls ld lt lu lv lw lx s ly lz ma mb mc md me u mf mg mh"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj mk"><img src="../Images/d08c0fd3e725c601bde9d1ec4e754bf2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l-50r_ron0alhK-3H6lwuA.png"/></div></div></figure><p id="c23c" class="pw-post-body-paragraph mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk">When designing a system’s API, software engineers often evaluate various approaches, such as <a class="af ns" href="https://okso.app/showcase/system-design/page/0d03d895-b5b1-40c6-3549-945df9d98dcd" rel="noopener ugc nofollow" target="_blank">REST vs RPC vs GraphQL</a>, or hybrid models, to determine the best fit for a specific task or project. These approaches define how data flows between the backend and frontend, as well as the structure of the response data:</p><ul class=""><li id="d3b7" class="mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr nt nu nv bk">Should all data be packed into a single “batch” and returned in one response?</li><li id="6561" class="mw mx fq my b go nw na nb gr nx nd ne nf ny nh ni nj nz nl nm nn oa np nq nr nt nu nv bk">Can the “batch” be configured to include only the required fields for a specific client (e.g., browser vs. mobile) to avoid over-fetching?</li><li id="ac06" class="mw mx fq my b go nw na nb gr nx nd ne nf ny nh ni nj nz nl nm nn oa np nq nr nt nu nv bk">What happens if the client under-fetches data and requires additional backend calls to retrieve missing entities?</li><li id="d7d5" class="mw mx fq my b go nw na nb gr nx nd ne nf ny nh ni nj nz nl nm nn oa np nq nr nt nu nv bk">How should parent-child relationships be handled? Should child entities be embedded within their parent, or should normalization be applied, where parent entities only reference child entity IDs to improve reusability and reduce response size?</li></ul><p id="4237" class="pw-post-body-paragraph mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk">In this article, we explore how the X (formerly Twitter) home timeline API (x.com/home) addresses these challenges, including:</p><ul class=""><li id="b6b3" class="mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr nt nu nv bk">Fetching the list of tweets</li><li id="99d0" class="mw mx fq my b go nw na nb gr nx nd ne nf ny nh ni nj nz nl nm nn oa np nq nr nt nu nv bk">Returning hierarchical or linked data (e.g., tweets, users, media)</li><li id="1fb5" class="mw mx fq my b go nw na nb gr nx nd ne nf ny nh ni nj nz nl nm nn oa np nq nr nt nu nv bk">Sorting and paginating results</li><li id="5654" class="mw mx fq my b go nw na nb gr nx nd ne nf ny nh ni nj nz nl nm nn oa np nq nr nt nu nv bk">Retrieving tweet details</li><li id="e9d1" class="mw mx fq my b go nw na nb gr nx nd ne nf ny nh ni nj nz nl nm nn oa np nq nr nt nu nv bk">Liking a tweet</li></ul><p id="5103" class="pw-post-body-paragraph mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk">Our focus will be on the API design and functionality, treating the backend as a black box since its implementation is inaccessible.</p><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj ob"><img src="../Images/1ff17b3000177d4493d993014e3ce514.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*_JPxQKlj1ky8Zx9H.jpg"/></div></div><figcaption class="oc od oe mi mj of og bf b bg z dx">Example of X home timeline</figcaption></figure><blockquote class="oh oi oj"><p id="2664" class="mw mx ok my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk"><em class="fq">Showing the exact requests and responses here might be cumbersome and hard to follow since the deeply nested and repetitive objects are hard to read. To make it easier to see the request/response payload structure, I’ve made my attempt to “type out” the home timeline API in TypeScript. So when it comes to the request/response examples I’ll use the request and response types instead of actual JSON objects. Also, remember that the types are simplified and many properties are omitted for brevity.</em></p><p id="6069" class="mw mx ok my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk"><em class="fq">You may find all types in </em><a class="af ns" href="https://github.com/trekhleb/trekhleb.github.io/blob/master/src/posts/2024/api-design-x-home-timeline/types/x.ts" rel="noopener ugc nofollow" target="_blank"><em class="fq">types/x.ts</em></a><em class="fq"> file or at the bottom of this article in the “Appendix: All types at one place” section.</em></p><p id="2e78" class="mw mx ok my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk">All images, unless othewise noted, are by the author.</p></blockquote><h1 id="8877" class="ol om fq bf on oo op gq oq or os gt ot ou ov ow ox oy oz pa pb pc pd pe pf pg bk">Fetching the list of tweets</h1><h1 id="e99b" class="ol om fq bf on oo op gq oq or os gt ot ou ov ow ox oy oz pa pb pc pd pe pf pg bk">The endpoint and request/response structure</h1><p id="7668" class="pw-post-body-paragraph mw mx fq my b go ph na nb gr pi nd ne nf pj nh ni nj pk nl nm nn pl np nq nr fj bk">Fetching the list of tweets for the home timeline starts with the <code class="cx pm pn po pp b">POST</code> request to the following endpoint:</p><pre class="ml mm mn mo mp pq pp pr bp ps bb bk"><span id="0f21" class="pt om fq pp b bg pu pv l pw px">POST https://x.com/i/api/graphql/{query-id}/HomeTimeline</span></pre><p id="c4a7" class="pw-post-body-paragraph mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk">Here is a simplified request body type:</p><pre class="ml mm mn mo mp pq pp pr bp ps bb bk"><span id="9037" class="pt om fq pp b bg pu pv l pw px">type TimelineRequest = {<br/>  queryId: string; // 's6ERr1UxkxxBx4YundNsXw'<br/>  variables: {<br/>    count: number; // 20<br/>    cursor?: string; // 'DAAACgGBGedb3Vx__9sKAAIZ5g4QENc99AcAAwAAIAIAAA'<br/>    seenTweetIds: string[]; // ['1867041249938530657', '1867041249938530659']<br/>  };<br/>  features: Features;<br/>};<br/><br/>type Features = {<br/>  articles_preview_enabled: boolean;<br/>  view_counts_everywhere_api_enabled: boolean;<br/>  // ...<br/>}</span></pre><p id="b14c" class="pw-post-body-paragraph mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk">Here is a simplified response body type (we’ll dive deeper into the response sub-types below):</p><pre class="ml mm mn mo mp pq pp pr bp ps bb bk"><span id="c36f" class="pt om fq pp b bg pu pv l pw px">type TimelineResponse = {<br/>  data: {<br/>    home: {<br/>      home_timeline_urt: {<br/>        instructions: (TimelineAddEntries | TimelineTerminateTimeline)[];<br/>        responseObjects: {<br/>          feedbackActions: TimelineAction[];<br/>        };<br/>      };<br/>    };<br/>  };<br/>};<br/><br/>type TimelineAddEntries = {<br/>  type: 'TimelineAddEntries';<br/>  entries: (TimelineItem | TimelineCursor | TimelineModule)[];<br/>};<br/><br/>type TimelineItem = {<br/>  entryId: string; // 'tweet-1867041249938530657'<br/>  sortIndex: string; // '1866561576636152411'<br/>  content: {<br/>    __typename: 'TimelineTimelineItem';<br/>    itemContent: TimelineTweet;<br/>    feedbackInfo: {<br/>      feedbackKeys: ActionKey[]; // ['-1378668161']<br/>    };<br/>  };<br/>};<br/><br/>type TimelineTweet = {<br/>  __typename: 'TimelineTweet';<br/>  tweet_results: {<br/>    result: Tweet;<br/>  };<br/>};<br/><br/>type TimelineCursor = {<br/>  entryId: string; // 'cursor-top-1867041249938530657'<br/>  sortIndex: string; // '1866961576813152212'<br/>  content: {<br/>    __typename: 'TimelineTimelineCursor';<br/>    value: string; // 'DACBCgABGedb4VyaJwuKbIIZ40cX3dYwGgaAAwAEAEEAA'<br/>    cursorType: 'Top' | 'Bottom';<br/>  };<br/>};<br/><br/>type ActionKey = string;</span></pre><p id="6f92" class="pw-post-body-paragraph mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk">It is interesting to note here, that “getting” the data is done via “POSTing”, which is not common for the REST-like API but it is common for a GraphQL-like API. Also, the <code class="cx pm pn po pp b">graphql</code> part of the URL indicates that X is using the GraphQL flavor for their API.</p><p id="87ab" class="pw-post-body-paragraph mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk">I’m using the word <em class="ok">“flavor”</em> here because the request body itself doesn’t look like a pure <a class="af ns" href="https://graphql.org/learn/queries/" rel="noopener ugc nofollow" target="_blank">GraphQL query</a>, where we may describe the required response structure, listing all the properties we want to fetch:</p><pre class="ml mm mn mo mp pq pp pr bp ps bb bk"><span id="ad29" class="pt om fq pp b bg pu pv l pw px"># An example of a pure GraphQL request structure that is *not* being used in the X API.<br/>{<br/>  tweets {<br/>    id<br/>    description<br/>    created_at<br/>    medias {<br/>      kind<br/>      url<br/>      # ...<br/>    }<br/>    author {<br/>      id<br/>      name<br/>      # ...<br/>    }<br/>    # ...<br/>  }<br/>}</span></pre><p id="0928" class="pw-post-body-paragraph mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk">The assumption here is that the home timeline API is not a pure GraphQL API, but is a mix of several approaches. Passing the parameters in a POST request like this seems closer to the “functional” RPC call. But at the same time, it seems like the GraphQL features might be used somewhere on the backend behind the <em class="ok">HomeTimeline</em> endpoint handler/controller. A mix like this might also be caused by a legacy code or some sort of ongoing migration. But again, these are just my speculations.</p><p id="04a4" class="pw-post-body-paragraph mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk">You may also notice that the same <code class="cx pm pn po pp b">TimelineRequest.queryId</code> is used in the API URL as well as in the API request body. This queryId is most probably generated on the backend, then it gets embedded in the <code class="cx pm pn po pp b">main.js</code> bundle, and then it is used when fetching the data from the backend. It is hard for me to understand how this <code class="cx pm pn po pp b">queryId</code> is used exactly since X's backend is a black box in our case. But, again, the speculation here might be that, it might be needed for some sort of performance optimization (re-using some pre-computed query results?), caching (Apollo related?), debugging (join logs by queryId?), or tracking/tracing purposes.</p><p id="5a9b" class="pw-post-body-paragraph mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk">It is also interesting to note, that the <code class="cx pm pn po pp b">TimelineResponse</code> contains not a list of tweets, but rather a list of instructions, like <em class="ok">"add a tweet to the timeline"</em> (see the <code class="cx pm pn po pp b">TimelineAddEntries</code> type), or <em class="ok">"terminate the timeline"</em> (see the <code class="cx pm pn po pp b">TimelineTerminateTimeline</code> type).</p><p id="2f8a" class="pw-post-body-paragraph mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk">The <code class="cx pm pn po pp b">TimelineAddEntries</code> instruction itself may also contain different types of entities:</p><ul class=""><li id="3fa9" class="mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr nt nu nv bk">Tweets — see the <code class="cx pm pn po pp b">TimelineItem</code> type</li><li id="0e37" class="mw mx fq my b go nw na nb gr nx nd ne nf ny nh ni nj nz nl nm nn oa np nq nr nt nu nv bk">Cursors — see the <code class="cx pm pn po pp b">TimelineCursor</code> type</li><li id="6443" class="mw mx fq my b go nw na nb gr nx nd ne nf ny nh ni nj nz nl nm nn oa np nq nr nt nu nv bk">Conversations/comments/threads — see the <code class="cx pm pn po pp b">TimelineModule</code> type</li></ul><pre class="ml mm mn mo mp pq pp pr bp ps bb bk"><span id="84bf" class="pt om fq pp b bg pu pv l pw px">type TimelineResponse = {<br/>  data: {<br/>    home: {<br/>      home_timeline_urt: {<br/>        instructions: (TimelineAddEntries | TimelineTerminateTimeline)[]; // &lt;-- Here<br/>        // ...<br/>      };<br/>    };<br/>  };<br/>};<br/><br/>type TimelineAddEntries = {<br/>  type: 'TimelineAddEntries';<br/>  entries: (TimelineItem | TimelineCursor | TimelineModule)[]; // &lt;-- Here<br/>};</span></pre><p id="f2d3" class="pw-post-body-paragraph mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk">This is interesting from the extendability point of view since it allows a wider variety of what can be rendered in the home timeline without tweaking the API too much.</p><h1 id="4a8e" class="ol om fq bf on oo op gq oq or os gt ot ou ov ow ox oy oz pa pb pc pd pe pf pg bk">Pagination</h1><p id="662e" class="pw-post-body-paragraph mw mx fq my b go ph na nb gr pi nd ne nf pj nh ni nj pk nl nm nn pl np nq nr fj bk">The <code class="cx pm pn po pp b">TimelineRequest.variables.count</code> property sets how many tweets we want to fetch at once (per page). The default is 20. However, more than 20 tweets can be returned in the <code class="cx pm pn po pp b">TimelineAddEntries.entries</code> array. For example, the array might contain 37 entries for the first page load, because it includes tweets (29), pinned tweets (1), promoted tweets (5), and pagination cursors (2). I'm not sure why there are 29 regular tweets with the requested count of 20 though.</p><p id="b529" class="pw-post-body-paragraph mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk">The <code class="cx pm pn po pp b">TimelineRequest.variables.cursor</code> is responsible for the cursor-based pagination.</p><blockquote class="oh oi oj"><p id="aa13" class="mw mx ok my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk"><em class="fq">“Cursor pagination is most often used for real-time data due to the frequency new records are added and because when reading data you often see the latest results first. It eliminates the possibility of skipping items and displaying the same item more than once. In cursor-based pagination, a constant pointer (or cursor) is used to keep track of where in the data set the next items should be fetched from.” See the </em><a class="af ns" href="https://stackoverflow.com/questions/55744926/offset-pagination-vs-cursor-pagination" rel="noopener ugc nofollow" target="_blank"><em class="fq">Offset pagination vs Cursor pagination</em></a><em class="fq"> thread for the context.</em></p></blockquote><p id="fa9b" class="pw-post-body-paragraph mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk">When fetching the list of tweets for the first time the <code class="cx pm pn po pp b">TimelineRequest.variables.cursor</code> is empty, since we want to fetch the top tweets from the default (most probably pre-computed) list of personalized tweets.</p><p id="7e02" class="pw-post-body-paragraph mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk">However, in the response, along with the tweet data, the backend also returns the cursor entries. Here is the response type hierarchy: <code class="cx pm pn po pp b">TimelineResponse → TimelineAddEntries → TimelineCursor</code>:</p><pre class="ml mm mn mo mp pq pp pr bp ps bb bk"><span id="678d" class="pt om fq pp b bg pu pv l pw px">type TimelineResponse = {<br/>  data: {<br/>    homet: {<br/>      home_timeline_urt: {<br/>        instructions: (TimelineAddEntries | TimelineTerminateTimeline)[]; // &lt;-- Here<br/>        // ...<br/>      };<br/>    };<br/>  };<br/>};<br/><br/>type TimelineAddEntries = {<br/>  type: 'TimelineAddEntries';<br/>  entries: (TimelineItem | TimelineCursor | TimelineModule)[]; // &lt;-- Here (tweets + cursors)<br/>};<br/><br/>type TimelineCursor = {<br/>  entryId: string;<br/>  sortIndex: string;<br/>  content: {<br/>    __typename: 'TimelineTimelineCursor';<br/>    value: string; // 'DACBCgABGedb4VyaJwuKbIIZ40cX3dYwGgaAAwAEAEEAA' &lt;-- Here<br/>    cursorType: 'Top' | 'Bottom';<br/>  };<br/>};</span></pre><p id="867b" class="pw-post-body-paragraph mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk">Every page contains the list of tweets along with “top” and “bottom” cursors:</p><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj ob"><img src="../Images/e7fccea0dff69df5fc3f4350d2e732eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*9HwhCJfskn1lZWJn.jpg"/></div></div><figcaption class="oc od oe mi mj of og bf b bg z dx">Examples of how cursors are passed along with tweets</figcaption></figure><p id="b974" class="pw-post-body-paragraph mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk">After the page data is loaded, we can go from the current page in both directions and fetch either the “previous/older” tweets using the “bottom” cursor or the “next/newer” tweets using the “top” cursor. My assumption is that fetching the “next” tweets using the “top” cursor happens in two cases: when the new tweets were added while the user is still reading the current page, or when the user starts scrolling the feed upwards (and there are no cached entries or if the previous entries were deleted for the performance reasons).</p><p id="fba5" class="pw-post-body-paragraph mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk">The X’s cursor itself might look like this: <code class="cx pm pn po pp b">DAABCgABGemI6Mk__9sKAAIZ6MSYG9fQGwgAAwAAAAIAAA</code>. In some API designs, the cursor may be a Base64 encoded string that contains the id of the last entry in the list, or the timestamp of the last seen entry. For example: <code class="cx pm pn po pp b">eyJpZCI6ICIxMjM0NTY3ODkwIn0= --&gt; {"id": "1234567890"}</code>, and then, this data is used to query the database accordingly. In the case of X API, it looks like the cursor is being Base64 decoded into some custom binary sequence that might require some further decoding to get any meaning out of it (i.e. via the Protobuf message definitions). Since we don't know if it is a <code class="cx pm pn po pp b">.proto</code> encoding and also we don't know the <code class="cx pm pn po pp b">.proto</code> message definition we may just assume that the backend knows how to query the next batch of tweets based on the cursor string.</p><p id="0bc8" class="pw-post-body-paragraph mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk">The <code class="cx pm pn po pp b">TimelineResponse.variables.seenTweetIds</code> parameter is used to inform the server about which tweets from the currently active page of the infinite scrolling the client has already seen. This most probably helps ensure that the server does not include duplicate tweets in subsequent pages of results.</p><h1 id="3376" class="ol om fq bf on oo op gq oq or os gt ot ou ov ow ox oy oz pa pb pc pd pe pf pg bk">Linked/hierarchical entities</h1><p id="7a4d" class="pw-post-body-paragraph mw mx fq my b go ph na nb gr pi nd ne nf pj nh ni nj pk nl nm nn pl np nq nr fj bk">One of the challenges to be solved in the APIs like home timeline (or Home Feed) is to figure out how to return the linked or hierarchical entities (i.e. <code class="cx pm pn po pp b">tweet → user</code>, <code class="cx pm pn po pp b">tweet → media</code>, <code class="cx pm pn po pp b">media → author</code>, etc):</p><ul class=""><li id="1363" class="mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr nt nu nv bk">Should we only return the list of tweets first and then fetch the dependent entities (like user details) in a bunch of separate queries on-demand?</li><li id="5588" class="mw mx fq my b go nw na nb gr nx nd ne nf ny nh ni nj nz nl nm nn oa np nq nr nt nu nv bk">Or should we return all the data at once, increasing the time and the size of the first load, but saving the time for all subsequent calls?</li><li id="d429" class="mw mx fq my b go nw na nb gr nx nd ne nf ny nh ni nj nz nl nm nn oa np nq nr nt nu nv bk">Do we need to normalize the data in this case to reduce the payload size (i.e. when the same user is an author of many tweets and we want to avoid repeating the user data over and over again in each tweet entity)?</li><li id="6f1e" class="mw mx fq my b go nw na nb gr nx nd ne nf ny nh ni nj nz nl nm nn oa np nq nr nt nu nv bk">Or should it be a combination of the approaches above?</li></ul><p id="7278" class="pw-post-body-paragraph mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk">Let’s see how X handles it.</p><p id="0c87" class="pw-post-body-paragraph mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk">Earlier in the <code class="cx pm pn po pp b">TimelineTweet</code> type the <code class="cx pm pn po pp b">Tweet</code> sub-type was used. Let's see how it looks:</p><pre class="ml mm mn mo mp pq pp pr bp ps bb bk"><span id="d395" class="pt om fq pp b bg pu pv l pw px">export type TimelineResponse = {<br/>  data: {<br/>    home: {<br/>      home_timeline_urt: {<br/>        instructions: (TimelineAddEntries | TimelineTerminateTimeline)[]; // &lt;-- Here<br/>        // ...<br/>      };<br/>    };<br/>  };<br/>};<br/><br/>type TimelineAddEntries = {<br/>  type: 'TimelineAddEntries';<br/>  entries: (TimelineItem | TimelineCursor | TimelineModule)[]; // &lt;-- Here<br/>};<br/><br/>type TimelineItem = {<br/>  entryId: string;<br/>  sortIndex: string;<br/>  content: {<br/>    __typename: 'TimelineTimelineItem';<br/>    itemContent: TimelineTweet; // &lt;-- Here<br/>    // ...<br/>  };<br/>};<br/><br/>type TimelineTweet = {<br/>  __typename: 'TimelineTweet';<br/>  tweet_results: {<br/>    result: Tweet; // &lt;-- Here<br/>  };<br/>};<br/><br/>// A Tweet entity<br/>type Tweet = {<br/>  __typename: 'Tweet';<br/>  core: {<br/>    user_results: {<br/>      result: User; // &lt;-- Here (a dependent User entity)<br/>    };<br/>  };<br/>  legacy: {<br/>    full_text: string;<br/>    // ...<br/>    entities: { // &lt;-- Here (a dependent Media entities)<br/>      media: Media[];<br/>      hashtags: Hashtag[];<br/>      urls: Url[];<br/>      user_mentions: UserMention[];<br/>    };<br/>  };<br/>};<br/><br/>// A User entity<br/>type User = {<br/>  __typename: 'User';<br/>  id: string; // 'VXNlcjoxNDUxM4ADSG44MTA4NDc4OTc2'<br/>  // ...<br/>  legacy: {<br/>    location: string; // 'San Francisco'<br/>    name: string; //  'John Doe'<br/>    // ...<br/>  };<br/>};<br/><br/>// A Media entity<br/>type Media = {<br/>  // ...<br/>  source_user_id_str: string; // '1867041249938530657'  &lt;-- Here (the dependant user is being mentioned by its ID)<br/>  url: string; // 'https://t.co/X78dBgtrsNU'<br/>  features: {<br/>    large: { faces: FaceGeometry[] };<br/>    medium: { faces: FaceGeometry[] };<br/>    small: { faces: FaceGeometry[] };<br/>    orig: { faces: FaceGeometry[] };<br/>  };<br/>  sizes: {<br/>    large: MediaSize;<br/>    medium: MediaSize;<br/>    small: MediaSize;<br/>    thumb: MediaSize;<br/>  };<br/>  video_info: VideoInfo[];<br/>};</span></pre><p id="9aca" class="pw-post-body-paragraph mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk">What’s interesting here is that most of the dependent data like <code class="cx pm pn po pp b">tweet → media</code> and <code class="cx pm pn po pp b">tweet → author</code> is embedded into the response on the first call (no subsequent queries).</p><p id="516e" class="pw-post-body-paragraph mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk">Also, the <code class="cx pm pn po pp b">User</code> and <code class="cx pm pn po pp b">Media</code> connections with <code class="cx pm pn po pp b">Tweet</code> entities are not normalized (if two tweets have the same author, their data will be repeated in each tweet object). But it seems like it should be ok, since in the scope of the home timeline for a specific user the tweets will be authored by many authors and repetitions are possible but sparse.</p><p id="50b4" class="pw-post-body-paragraph mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk">My assumption was that the <code class="cx pm pn po pp b">UserTweets</code> API (that we don't cover here), which is responsible for fetching the tweets of <em class="ok">one particular user</em> will handle it differently, but, apparently, it is not the case. The <code class="cx pm pn po pp b">UserTweets</code> returns the list of tweets of the same user and embeds the same user data over and over again for each tweet. It's interesting. Maybe the simplicity of the approach beats some data size overhead (maybe user data is considered pretty small in size). I'm not sure.</p><p id="c1a5" class="pw-post-body-paragraph mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk">Another observation about the entities’ relationship is that the <code class="cx pm pn po pp b">Media</code> entity also has a link to the <code class="cx pm pn po pp b">User</code> (the author). But it does it not via direct entity embedding as the <code class="cx pm pn po pp b">Tweet</code> entity does, but rather it links via the <code class="cx pm pn po pp b">Media.source_user_id_str</code> property.</p><p id="ae94" class="pw-post-body-paragraph mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk">The “comments” (which are also the “tweets” by their nature) for each “tweet” in the home timeline are not fetched at all. To see the tweet thread the user must click on the tweet to see its detailed view. The tweet thread will be fetched by calling the <code class="cx pm pn po pp b">TweetDetail</code> endpoint (more about it in the "Tweet detail page" section below).</p><p id="1121" class="pw-post-body-paragraph mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk">Another entity that each <code class="cx pm pn po pp b">Tweet</code> has is <code class="cx pm pn po pp b">FeedbackActions</code> (i.e. "Recommend less often" or "See fewer"). The way the <code class="cx pm pn po pp b">FeedbackActions</code> are stored in the response object is different from the way the <code class="cx pm pn po pp b">User</code> and <code class="cx pm pn po pp b">Media</code> objects are stored. While the <code class="cx pm pn po pp b">User</code> and <code class="cx pm pn po pp b">Media</code> entities are part of the <code class="cx pm pn po pp b">Tweet</code>, the <code class="cx pm pn po pp b">FeedbackActions</code> are stored separately in <code class="cx pm pn po pp b">TimelineItem.content.feedbackInfo.feedbackKeys</code> array and are linked via the <code class="cx pm pn po pp b">ActionKey</code>. That was a slight surprise for me since it doesn't seem to be the case that any action is re-usable. It looks like one action is used for one particular tweet only. So it seems like the <code class="cx pm pn po pp b">FeedbackActions</code> could be embedded into each tweet in the same way as <code class="cx pm pn po pp b">Media</code> entities. But I might be missing some hidden complexity here (like the fact that each action can have children actions).</p><p id="92e4" class="pw-post-body-paragraph mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk">More details about the actions are in the “Tweet actions” section below.</p><h1 id="1226" class="ol om fq bf on oo op gq oq or os gt ot ou ov ow ox oy oz pa pb pc pd pe pf pg bk">Sorting</h1><p id="f4f6" class="pw-post-body-paragraph mw mx fq my b go ph na nb gr pi nd ne nf pj nh ni nj pk nl nm nn pl np nq nr fj bk">The sorting order of the timeline entries is defined by the backend via the <code class="cx pm pn po pp b">sortIndex</code> properties:</p><pre class="ml mm mn mo mp pq pp pr bp ps bb bk"><span id="407a" class="pt om fq pp b bg pu pv l pw px">type TimelineCursor = {<br/>  entryId: string;<br/>  sortIndex: string; // '1866961576813152212' &lt;-- Here<br/>  content: {<br/>    __typename: 'TimelineTimelineCursor';<br/>    value: string;<br/>    cursorType: 'Top' | 'Bottom';<br/>  };<br/>};<br/><br/>type TimelineItem = {<br/>  entryId: string;<br/>  sortIndex: string; // '1866561576636152411' &lt;-- Here<br/>  content: {<br/>    __typename: 'TimelineTimelineItem';<br/>    itemContent: TimelineTweet;<br/>    feedbackInfo: {<br/>      feedbackKeys: ActionKey[];<br/>    };<br/>  };<br/>};<br/><br/>type TimelineModule = {<br/>  entryId: string;<br/>  sortIndex: string; // '73343543020642838441' &lt;-- Here<br/>  content: {<br/>    __typename: 'TimelineTimelineModule';<br/>    items: {<br/>      entryId: string,<br/>      item: TimelineTweet,<br/>    }[],<br/>    displayType: 'VerticalConversation',<br/>  };<br/>};</span></pre><p id="6ab5" class="pw-post-body-paragraph mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk">The <code class="cx pm pn po pp b">sortIndex</code> itself might look something like this <code class="cx pm pn po pp b">'1867231621095096312'</code>. It likely corresponds directly to or is derived from a <a class="af ns" href="https://en.wikipedia.org/wiki/Snowflake_ID" rel="noopener ugc nofollow" target="_blank">Snowflake ID</a>.</p><blockquote class="oh oi oj"><p id="75b5" class="mw mx ok my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk"><em class="fq">Actually most of the IDs you see in the response (tweet IDs) follow the “Snowflake ID” convention and look like </em><code class="cx pm pn po pp b"><em class="fq">'1867231621095096312'</em></code><em class="fq">.</em></p></blockquote><p id="c224" class="pw-post-body-paragraph mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk">If this is used to sort entities like tweets, the system leverages the inherent chronological sorting of Snowflake IDs. Tweets or objects with a higher sortIndex value (a more recent timestamp) appear higher in the feed, while those with lower values (an older timestamp) appear lower in the feed.</p><p id="d263" class="pw-post-body-paragraph mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk">Here’s the step-by-step decoding of the Snowflake ID (in our case the <code class="cx pm pn po pp b">sortIndex</code>) <code class="cx pm pn po pp b">1867231621095096312</code>:</p><ul class=""><li id="54f3" class="mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr nt nu nv bk"><strong class="my fr">Extract the Timestamp:</strong></li><li id="8b7c" class="mw mx fq my b go nw na nb gr nx nd ne nf ny nh ni nj nz nl nm nn oa np nq nr nt nu nv bk">The timestamp is derived by right-shifting the Snowflake ID by 22 bits (to remove the lower 22 bits for data center, worker ID, and sequence): <code class="cx pm pn po pp b">1867231621095096312 → 445182709954</code></li><li id="4ae4" class="mw mx fq my b go nw na nb gr nx nd ne nf ny nh ni nj nz nl nm nn oa np nq nr nt nu nv bk"><strong class="my fr">Add Twitter’s Epoch:</strong></li><li id="5fed" class="mw mx fq my b go nw na nb gr nx nd ne nf ny nh ni nj nz nl nm nn oa np nq nr nt nu nv bk">Adding Twitter’s custom epoch (1288834974657) to this timestamp gives the UNIX timestamp in milliseconds: <code class="cx pm pn po pp b">445182709954 + 1288834974657 → 1734017684611ms</code></li><li id="bbe3" class="mw mx fq my b go nw na nb gr nx nd ne nf ny nh ni nj nz nl nm nn oa np nq nr nt nu nv bk"><strong class="my fr">Convert to a human-readable date:</strong></li><li id="c3db" class="mw mx fq my b go nw na nb gr nx nd ne nf ny nh ni nj nz nl nm nn oa np nq nr nt nu nv bk">Converting the UNIX timestamp to a UTC datetime gives: <code class="cx pm pn po pp b">1734017684611ms → 2024-12-12 15:34:44.611 (UTC)</code></li></ul><p id="9604" class="pw-post-body-paragraph mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk">So we can assume here that the tweets in the home timeline are sorted chronologically.</p><h1 id="05cb" class="ol om fq bf on oo op gq oq or os gt ot ou ov ow ox oy oz pa pb pc pd pe pf pg bk">Tweet actions</h1><p id="57f4" class="pw-post-body-paragraph mw mx fq my b go ph na nb gr pi nd ne nf pj nh ni nj pk nl nm nn pl np nq nr fj bk">Each tweet has an “Actions” menu.</p><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj ob"><img src="../Images/99e8c98d9b3e8ea09c2e5906f3a0ee5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*0VBHFdxETXH_mggz.jpg"/></div></div><figcaption class="oc od oe mi mj of og bf b bg z dx">Example of tweet actions</figcaption></figure><p id="c0c7" class="pw-post-body-paragraph mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk">The actions for each tweet are coming from the backend in a <code class="cx pm pn po pp b">TimelineItem.content.feedbackInfo.feedbackKeys</code> array and are linked with the tweets via the <code class="cx pm pn po pp b">ActionKey</code>:</p><pre class="ml mm mn mo mp pq pp pr bp ps bb bk"><span id="c90c" class="pt om fq pp b bg pu pv l pw px">type TimelineResponse = {<br/>  data: {<br/>    home: {<br/>      home_timeline_urt: {<br/>        instructions: (TimelineAddEntries | TimelineTerminateTimeline)[];<br/>        responseObjects: {<br/>          feedbackActions: TimelineAction[]; // &lt;-- Here<br/>        };<br/>      };<br/>    };<br/>  };<br/>};<br/><br/>type TimelineItem = {<br/>  entryId: string;<br/>  sortIndex: string;<br/>  content: {<br/>    __typename: 'TimelineTimelineItem';<br/>    itemContent: TimelineTweet;<br/>    feedbackInfo: {<br/>      feedbackKeys: ActionKey[]; // ['-1378668161'] &lt;-- Here<br/>    };<br/>  };<br/>};<br/><br/>type TimelineAction = {<br/>  key: ActionKey; // '-609233128'<br/>  value: {<br/>    feedbackType: 'NotRelevant' | 'DontLike' | 'SeeFewer'; // ...<br/>    prompt: string; // 'This post isn’t relevant' | 'Not interested in this post' | ...<br/>    confirmation: string; // 'Thanks. You’ll see fewer posts like this.'<br/>    childKeys: ActionKey[]; // ['1192182653', '-1427553257'], i.e. NotInterested -&gt; SeeFewer<br/>    feedbackUrl: string; // '/2/timeline/feedback.json?feedback_type=NotRelevant&amp;action_metadata=SRwW6oXZadPHiOczBBaAwPanEwE%3D'<br/>    hasUndoAction: boolean;<br/>    icon: string; // 'Frown'<br/>  };<br/>};</span></pre><p id="6213" class="pw-post-body-paragraph mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk">It is interesting here that this flat array of actions is actually a tree (or a graph? I didn’t check), since each action may have child actions (see the <code class="cx pm pn po pp b">TimelineAction.value.childKeys</code> array). This makes sense, for example, when after the user clicks on the "Don't Like" action, the follow-up might be to show the "This post isn’t relevant" action, as a way of explaining why the user doesn't like the tweet.</p><h1 id="1499" class="ol om fq bf on oo op gq oq or os gt ot ou ov ow ox oy oz pa pb pc pd pe pf pg bk">Tweet detail page</h1><p id="3c05" class="pw-post-body-paragraph mw mx fq my b go ph na nb gr pi nd ne nf pj nh ni nj pk nl nm nn pl np nq nr fj bk">Once the user would like to see the tweet detail page (i.e. to see the thread of comments/tweets), the user clicks on the tweet and the <code class="cx pm pn po pp b">GET</code> request to the following endpoint is performed:</p><pre class="ml mm mn mo mp pq pp pr bp ps bb bk"><span id="1f30" class="pt om fq pp b bg pu pv l pw px">GET https://x.com/i/api/graphql/{query-id}/TweetDetail?variables={"focalTweetId":"1867231621095096312","referrer":"home","controller_data":"DACABBSQ","rankingMode":"Relevance","includePromotedContent":true,"withCommunity":true}&amp;features={"articles_preview_enabled":true}</span></pre><p id="06f1" class="pw-post-body-paragraph mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk">I was curious here why the list of tweets is being fetched via the <code class="cx pm pn po pp b">POST</code> call, but each tweet detail is fetched via the <code class="cx pm pn po pp b">GET</code> call. Seems inconsistent. Especially keeping in mind that similar query parameters like <code class="cx pm pn po pp b">query-id</code>, <code class="cx pm pn po pp b">features</code>, and others this time are passed in the URL and not in the request body. The response format is also similar and is re-using the types from the list call. I'm not sure why is that. But again, I'm sure I might be might be missing some background complexity here.</p><p id="2bf4" class="pw-post-body-paragraph mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk">Here are the simplified response body types:</p><pre class="ml mm mn mo mp pq pp pr bp ps bb bk"><span id="9bb3" class="pt om fq pp b bg pu pv l pw px">type TweetDetailResponse = {<br/>  data: {<br/>    threaded_conversation_with_injections_v2: {<br/>      instructions: (TimelineAddEntries | TimelineTerminateTimeline)[],<br/>    },<br/>  },<br/>}<br/><br/>type TimelineAddEntries = {<br/>  type: 'TimelineAddEntries';<br/>  entries: (TimelineItem | TimelineCursor | TimelineModule)[];<br/>};<br/><br/>type TimelineTerminateTimeline = {<br/>  type: 'TimelineTerminateTimeline',<br/>  direction: 'Top',<br/>}<br/><br/>type TimelineModule = {<br/>  entryId: string; // 'conversationthread-58668734545929871193'<br/>  sortIndex: string; // '1867231621095096312'<br/>  content: {<br/>    __typename: 'TimelineTimelineModule';<br/>    items: {<br/>      entryId: string, // 'conversationthread-1866876425669871193-tweet-1866876038930951193'<br/>      item: TimelineTweet,<br/>    }[], // Comments to the tweets are also tweets<br/>    displayType: 'VerticalConversation',<br/>  };<br/>};</span></pre><p id="b198" class="pw-post-body-paragraph mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk">The response is pretty similar (in its types) to the list response, so we won’t for too long here.</p><p id="bf66" class="pw-post-body-paragraph mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk">One interesting nuance is that the “comments” (or conversations) of each tweet are actually other tweets (see the <code class="cx pm pn po pp b">TimelineModule</code> type). So the tweet thread looks very similar to the home timeline feed by showing the list of <code class="cx pm pn po pp b">TimelineTweet</code> entries. This looks elegant. A good example of a universal and re-usable approach to the API design.</p><h1 id="b8a2" class="ol om fq bf on oo op gq oq or os gt ot ou ov ow ox oy oz pa pb pc pd pe pf pg bk">Liking the tweet</h1><p id="a565" class="pw-post-body-paragraph mw mx fq my b go ph na nb gr pi nd ne nf pj nh ni nj pk nl nm nn pl np nq nr fj bk">When a user likes the tweet, the <code class="cx pm pn po pp b">POST</code> request to the following endpoint is being performed:</p><pre class="ml mm mn mo mp pq pp pr bp ps bb bk"><span id="d6b9" class="pt om fq pp b bg pu pv l pw px">POST https://x.com/i/api/graphql/{query-id}/FavoriteTweet</span></pre><p id="6b24" class="pw-post-body-paragraph mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk">Here is the request body types:</p><pre class="ml mm mn mo mp pq pp pr bp ps bb bk"><span id="dd05" class="pt om fq pp b bg pu pv l pw px">type FavoriteTweetRequest = {<br/>  variables: {<br/>    tweet_id: string; // '1867041249938530657'<br/>  };<br/>  queryId: string; // 'lI07N61twFgted2EgXILM7A'<br/>};</span></pre><p id="8a2b" class="pw-post-body-paragraph mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk">Here is the response body types:</p><pre class="ml mm mn mo mp pq pp pr bp ps bb bk"><span id="f4b4" class="pt om fq pp b bg pu pv l pw px">type FavoriteTweetResponse = {<br/>  data: {<br/>    favorite_tweet: 'Done',<br/>  }<br/>}</span></pre><p id="09fd" class="pw-post-body-paragraph mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk">Looks straightforward and also resembles the RPC-like approach to the API design.</p><h1 id="5b05" class="ol om fq bf on oo op gq oq or os gt ot ou ov ow ox oy oz pa pb pc pd pe pf pg bk">Conclusion</h1><p id="8c3d" class="pw-post-body-paragraph mw mx fq my b go ph na nb gr pi nd ne nf pj nh ni nj pk nl nm nn pl np nq nr fj bk">We have touched on some basic parts of the home timeline API design by looking at X’s API example. I made some assumptions along the way to the best of my knowledge. I believe some things I might have interpreted incorrectly and I might have missed some complex nuances. But even with that in mind, I hope you got some useful insights from this high-level overview, something that you could apply in your next API Design session.</p><p id="2b6c" class="pw-post-body-paragraph mw mx fq my b go mz na nb gr nc nd ne nf ng nh ni nj nk nl nm nn no np nq nr fj bk">Initially, I had a plan to go through similar top-tech websites to get some insights from Facebook, Reddit, YouTube, and others and to collect battle-tested best practices and solutions. I’m not sure if I’ll find the time to do that. Will see. But it could be an interesting exercise.</p><h1 id="0c99" class="ol om fq bf on oo op gq oq or os gt ot ou ov ow ox oy oz pa pb pc pd pe pf pg bk">Appendix: All types in one place</h1><p id="2c91" class="pw-post-body-paragraph mw mx fq my b go ph na nb gr pi nd ne nf pj nh ni nj pk nl nm nn pl np nq nr fj bk">For the reference, I’m adding all types in one go here. You may also find all types in <a class="af ns" href="https://github.com/trekhleb/trekhleb.github.io/blob/master/src/posts/2024/api-design-x-home-timeline/types/x.ts" rel="noopener ugc nofollow" target="_blank">types/x.ts</a> file.</p><pre class="ml mm mn mo mp pq pp pr bp ps bb bk"><span id="aa54" class="pt om fq pp b bg pu pv l pw px">/**<br/> * This file contains the simplified types for X's (Twitter's) home timeline API.<br/> *<br/> * These types are created for exploratory purposes, to see the current implementation<br/> * of the X's API, to see how they fetch Home Feed, how they do a pagination and sorting,<br/> * and how they pass the hierarchical entities (posts, media, user info, etc).<br/> *<br/> * Many properties and types are omitted for simplicity.<br/> */<br/><br/>// POST https://x.com/i/api/graphql/{query-id}/HomeTimeline<br/>export type TimelineRequest = {<br/>  queryId: string; // 's6ERr1UxkxxBx4YundNsXw'<br/>  variables: {<br/>    count: number; // 20<br/>    cursor?: string; // 'DAAACgGBGedb3Vx__9sKAAIZ5g4QENc99AcAAwAAIAIAAA'<br/>    seenTweetIds: string[]; // ['1867041249938530657', '1867041249938530658']<br/>  };<br/>  features: Features;<br/>};<br/><br/>// POST https://x.com/i/api/graphql/{query-id}/HomeTimeline<br/>export type TimelineResponse = {<br/>  data: {<br/>    home: {<br/>      home_timeline_urt: {<br/>        instructions: (TimelineAddEntries | TimelineTerminateTimeline)[];<br/>        responseObjects: {<br/>          feedbackActions: TimelineAction[];<br/>        };<br/>      };<br/>    };<br/>  };<br/>};<br/><br/>// POST https://x.com/i/api/graphql/{query-id}/FavoriteTweet<br/>export type FavoriteTweetRequest = {<br/>  variables: {<br/>    tweet_id: string; // '1867041249938530657'<br/>  };<br/>  queryId: string; // 'lI07N6OtwFgted2EgXILM7A'<br/>};<br/><br/>// POST https://x.com/i/api/graphql/{query-id}/FavoriteTweet<br/>export type FavoriteTweetResponse = {<br/>  data: {<br/>    favorite_tweet: 'Done',<br/>  }<br/>}<br/><br/>// GET https://x.com/i/api/graphql/{query-id}/TweetDetail?variables={"focalTweetId":"1867041249938530657","referrer":"home","controller_data":"DACABBSQ","rankingMode":"Relevance","includePromotedContent":true,"withCommunity":true}&amp;features={"articles_preview_enabled":true}<br/>export type TweetDetailResponse = {<br/>  data: {<br/>    threaded_conversation_with_injections_v2: {<br/>      instructions: (TimelineAddEntries | TimelineTerminateTimeline)[],<br/>    },<br/>  },<br/>}<br/><br/>type Features = {<br/>  articles_preview_enabled: boolean;<br/>  view_counts_everywhere_api_enabled: boolean;<br/>  // ...<br/>}<br/><br/>type TimelineAction = {<br/>  key: ActionKey; // '-609233128'<br/>  value: {<br/>    feedbackType: 'NotRelevant' | 'DontLike' | 'SeeFewer'; // ...<br/>    prompt: string; // 'This post isn’t relevant' | 'Not interested in this post' | ...<br/>    confirmation: string; // 'Thanks. You’ll see fewer posts like this.'<br/>    childKeys: ActionKey[]; // ['1192182653', '-1427553257'], i.e. NotInterested -&gt; SeeFewer<br/>    feedbackUrl: string; // '/2/timeline/feedback.json?feedback_type=NotRelevant&amp;action_metadata=SRwW6oXZadPHiOczBBaAwPanEwE%3D'<br/>    hasUndoAction: boolean;<br/>    icon: string; // 'Frown'<br/>  };<br/>};<br/><br/>type TimelineAddEntries = {<br/>  type: 'TimelineAddEntries';<br/>  entries: (TimelineItem | TimelineCursor | TimelineModule)[];<br/>};<br/><br/>type TimelineTerminateTimeline = {<br/>  type: 'TimelineTerminateTimeline',<br/>  direction: 'Top',<br/>}<br/><br/>type TimelineCursor = {<br/>  entryId: string; // 'cursor-top-1867041249938530657'<br/>  sortIndex: string; // '1867231621095096312'<br/>  content: {<br/>    __typename: 'TimelineTimelineCursor';<br/>    value: string; // 'DACBCgABGedb4VyaJwuKbIIZ40cX3dYwGgaAAwAEAEEAA'<br/>    cursorType: 'Top' | 'Bottom';<br/>  };<br/>};<br/><br/>type TimelineItem = {<br/>  entryId: string; // 'tweet-1867041249938530657'<br/>  sortIndex: string; // '1867231621095096312'<br/>  content: {<br/>    __typename: 'TimelineTimelineItem';<br/>    itemContent: TimelineTweet;<br/>    feedbackInfo: {<br/>      feedbackKeys: ActionKey[]; // ['-1378668161']<br/>    };<br/>  };<br/>};<br/><br/>type TimelineModule = {<br/>  entryId: string; // 'conversationthread-1867041249938530657'<br/>  sortIndex: string; // '1867231621095096312'<br/>  content: {<br/>    __typename: 'TimelineTimelineModule';<br/>    items: {<br/>      entryId: string, // 'conversationthread-1867041249938530657-tweet-1867041249938530657'<br/>      item: TimelineTweet,<br/>    }[], // Comments to the tweets are also tweets<br/>    displayType: 'VerticalConversation',<br/>  };<br/>};<br/><br/>type TimelineTweet = {<br/>  __typename: 'TimelineTweet';<br/>  tweet_results: {<br/>    result: Tweet;<br/>  };<br/>};<br/><br/>type Tweet = {<br/>  __typename: 'Tweet';<br/>  core: {<br/>    user_results: {<br/>      result: User;<br/>    };<br/>  };<br/>  views: {<br/>    count: string; // '13763'<br/>  };<br/>  legacy: {<br/>    bookmark_count: number; // 358<br/>    created_at: string; // 'Tue Dec 10 17:41:28 +0000 2024'<br/>    conversation_id_str: string; // '1867041249938530657'<br/>    display_text_range: number[]; // [0, 58]<br/>    favorite_count: number; // 151<br/>    full_text: string; //  "How I'd promote my startup, if I had 0 followers (Part 1)"<br/>    lang: string; // 'en'<br/>    quote_count: number;<br/>    reply_count: number;<br/>    retweet_count: number;<br/>    user_id_str: string; // '1867041249938530657'<br/>    id_str: string; // '1867041249938530657'<br/>    entities: {<br/>      media: Media[];<br/>      hashtags: Hashtag[];<br/>      urls: Url[];<br/>      user_mentions: UserMention[];<br/>    };<br/>  };<br/>};<br/><br/>type User = {<br/>  __typename: 'User';<br/>  id: string; // 'VXNlcjoxNDUxM4ADSG44MTA4NDc4OTc2'<br/>  rest_id: string; // '1867041249938530657'<br/>  is_blue_verified: boolean;<br/>  profile_image_shape: 'Circle'; // ...<br/>  legacy: {<br/>    following: boolean;<br/>    created_at: string; // 'Thu Oct 21 09:30:37 +0000 2021'<br/>    description: string; // 'I help startup founders double their MRR with outside-the-box marketing cheat sheets'<br/>    favourites_count: number; // 22195<br/>    followers_count: number; // 25658<br/>    friends_count: number;<br/>    location: string; // 'San Francisco'<br/>    media_count: number;<br/>    name: string; //  'John Doe'<br/>    profile_banner_url: string; // 'https://pbs.twimg.com/profile_banners/4863509452891265813/4863509'<br/>    profile_image_url_https: string; // 'https://pbs.twimg.com/profile_images/4863509452891265813/4863509_normal.jpg'<br/>    screen_name: string; // 'johndoe'<br/>    url: string; // 'https://t.co/dgTEddFGDd'<br/>    verified: boolean;<br/>  };<br/>};<br/><br/>type Media = {<br/>  display_url: string; // 'pic.x.com/X7823zS3sNU'<br/>  expanded_url: string; // 'https://x.com/johndoe/status/1867041249938530657/video/1'<br/>  ext_alt_text: string; // 'Image of two bridges.'<br/>  id_str: string; // '1867041249938530657'<br/>  indices: number[]; // [93, 116]<br/>  media_key: string; // '13_2866509231399826944'<br/>  media_url_https: string; // 'https://pbs.twimg.com/profile_images/1867041249938530657/4863509_normal.jpg'<br/>  source_status_id_str: string; // '1867041249938530657'<br/>  source_user_id_str: string; // '1867041249938530657'<br/>  type: string; // 'video'<br/>  url: string; // 'https://t.co/X78dBgtrsNU'<br/>  features: {<br/>    large: { faces: FaceGeometry[] };<br/>    medium: { faces: FaceGeometry[] };<br/>    small: { faces: FaceGeometry[] };<br/>    orig: { faces: FaceGeometry[] };<br/>  };<br/>  sizes: {<br/>    large: MediaSize;<br/>    medium: MediaSize;<br/>    small: MediaSize;<br/>    thumb: MediaSize;<br/>  };<br/>  video_info: VideoInfo[];<br/>};<br/><br/>type UserMention = {<br/>  id_str: string; // '98008038'<br/>  name: string; // 'Yann LeCun'<br/>  screen_name: string; // 'ylecun'<br/>  indices: number[]; // [115, 122]<br/>};<br/><br/>type Hashtag = {<br/>  indices: number[]; // [257, 263]<br/>  text: string;<br/>};<br/><br/>type Url = {<br/>  display_url: string; // 'google.com'<br/>  expanded_url: string; // 'http://google.com'<br/>  url: string; // 'https://t.co/nZh3aF0Aw6'<br/>  indices: number[]; // [102, 125]<br/>};<br/><br/>type VideoInfo = {<br/>  aspect_ratio: number[]; // [427, 240]<br/>  duration_millis: number; // 20000<br/>  variants: {<br/>    bitrate?: number; // 288000<br/>    content_type?: string; // 'application/x-mpegURL' | 'video/mp4' | ...<br/>    url: string; // 'https://video.twimg.com/amplify_video/18665094345456w6944/pl/-ItQau_LRWedR-W7.m3u8?tag=14'<br/>  };<br/>};<br/><br/>type FaceGeometry = { x: number; y: number; h: number; w: number };<br/><br/>type MediaSize = { h: number; w: number; resize: 'fit' | 'crop' };<br/><br/>type ActionKey = string;</span></pre></div></div></div></div>    
</body>
</html>