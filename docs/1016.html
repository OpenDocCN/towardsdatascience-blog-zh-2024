<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Supercharging Prompt Engineering via Symbolic Program Search</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Supercharging Prompt Engineering via Symbolic Program Search</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/supercharging-prompt-engineering-via-symbolic-program-search-c6c353bc80a4?source=collection_archive---------1-----------------------#2024-04-22">https://towardsdatascience.com/supercharging-prompt-engineering-via-symbolic-program-search-c6c353bc80a4?source=collection_archive---------1-----------------------#2024-04-22</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="5126" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx">Find better prompts by exploring a large set of prompt variants automatically</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hd he hf hg hh ab"><div><div class="ab hi"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@toschnab?source=post_page---byline--c6c353bc80a4--------------------------------" rel="noopener follow"><div class="l hj hk by hl hm"><div class="l ed"><img alt="Tobias Schnabel" class="l ep by dd de cx" src="../Images/92a6c1addc602dae8e8d54fec5116385.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/1*cdrpit4LAXviUojwj27bFg.jpeg"/><div class="hn by l dd de em n ho eo"/></div></div></a></div></div><div class="hp ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--c6c353bc80a4--------------------------------" rel="noopener follow"><div class="l hq hr by hl hs"><div class="l ed"><img alt="Towards Data Science" class="l ep by br ht cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hn by l br ht em n ho eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hu ab q"><div class="ab q hv"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hw hx bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hy" data-testid="authorName" href="https://medium.com/@toschnab?source=post_page---byline--c6c353bc80a4--------------------------------" rel="noopener follow">Tobias Schnabel</a></p></div></div></div><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hw hx dx"><button class="ib ic ah ai aj ak al am an ao ap aq ar id ie if" disabled="">Follow</button></p></div></div></span></div></div><div class="l ig"><span class="bf b bg z dx"><div class="ab cn ih ii ij"><div class="ik il ab"><div class="bf b bg z dx ab im"><span class="in l ig">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hy ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--c6c353bc80a4--------------------------------" rel="noopener follow"><p class="bf b bg z io ip iq ir is it iu iv bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">8 min read</span><div class="iw ix l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Apr 22, 2024</span></div></span></div></span></div></div></div><div class="ab cp iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn"><div class="h k w ea eb q"><div class="kd l"><div class="ab q ke kf"><div class="pw-multi-vote-icon ed in kg kh ki"><div class=""><div class="kj kk kl km kn ko kp am kq kr ks ki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kt ku kv kw kx ky kz"><p class="bf b dy z dx"><span class="kk">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kj lc ld ab q ee le lf" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="lb"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg><p class="bf b dy z dx"><span class="pw-responses-count la lb">1</span></p></button></div></div></div><div class="ab q jo jp jq jr js jt ju jv jw jx jy jz ka kb kc"><div class="lg k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lh an ao ap id li lj lk" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep ll cn"><div class="l ae"><div class="ab cb"><div class="lm ln lo lp lq lr ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk ml"><img src="../Images/bfbe607a7b9395877d23744afe241481.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*LHJ15BhOTpPHImnP"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Photo by <a class="af nc" href="https://unsplash.com/@icons8?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Icons8 Team</a> on <a class="af nc" href="https://unsplash.com/?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="d063" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">It’s no secret that much of the success of LLMs still depends on our ability to prompt them with the right instructions and examples. As newer generation LLMs become more and more powerful, prompts have become complex enough to be considered <a class="af nc" rel="noopener" target="_blank" href="/intro-to-dspy-goodbye-prompting-hello-programming-4ca1c6ce3eb9">programs themselves</a>. These prompt programs are a lot like recipes — both have a set of instructions to follow and transform raw materials, be it data or ingredients.</p><p id="d2b5" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Prompt engineering is thus similar to improving a recipe. Home chefs will often stick to the overall recipe but make some small changes — for example leaving out garlic or adding parsley in a pasta dish. Frameworks like <a class="af nc" href="https://github.com/stanfordnlp/dspy" rel="noopener ugc nofollow" target="_blank">DSPy</a> are following this overall paradigm when they optimize the in-context examples. Pro-level chefs, however, use the recipe as inspiration, and often re-interpret components of the dish completely. For example, they might see spaghetti in pasta dish as the starchy component and might swap it for freshly made gnocchi to achieve a similar composition.</p><p id="03ea" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">What is it that allows pro-level chefs to work so creatively? It’s that they think about recipes in an abstract way, like in the pasta example above. Manual prompt engineering is similar to pro-level cooking. It can get impressive results but requires <a class="af nc" href="https://medium.com/the-generator/the-perfect-prompt-prompt-engineering-cheat-sheet-d0b9c62a2bba" rel="noopener">a lot of time and knowledge</a>. What we really want is the creativity of manual prompt engineering but without the effort.</p></div></div></div><div class="ab cb nz oa ob oc" role="separator"><span class="od by bm oe of og"/><span class="od by bm oe of og"/><span class="od by bm oe of"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><h1 id="3ae7" class="oh oi fq bf oj ok ol gq om on oo gt op oq or os ot ou ov ow ox oy oz pa pb pc bk">The power of abstract prompts</h1><p id="a423" class="pw-post-body-paragraph nd ne fq nf b go pd nh ni gr pe nk nl nm pf no np nq pg ns nt nu ph nw nx ny fj bk">Let’s say we want to improve a prompt for labeling speaker responses. We’ll eventually run it with many different inputs, but plug in a concrete one for now:</p><pre class="mm mn mo mp mq pi pj pk bp pl bb bk"><span id="3af1" class="pm oi fq pj b bg pn po l pp pq">Instructions: Does Speaker 2's answer mean yes or no?<br/>Output labels: no, yes<br/>Input: Speaker 1: "You do this often?" Speaker 2: "It's my first time."<br/>Output:</span></pre><p id="e35e" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Assume, for a moment, that we had an abstract representation of this prompt that pulls out its separate components and is easy to manipulate. Maybe something like this:</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk pr"><img src="../Images/f419eb3d7a2cb20fc0c6a90b9918af6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1ShZ-yOM7SeUnUmxZnMpXQ.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">A simple prompt for a classification task represented as an abstract symbolic program. Image by author.</figcaption></figure><p id="d280" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">With this, you could automate a lot of the (semi)-manual tinkering you have to do during prompt prototyping. Making small edits such as paraphrasing would be just the start. Want to try out<a class="af nc" rel="noopener" target="_blank" href="/chain-of-thought-prompting-for-llms-33c963eead38"> Chain-of-Thought reasoning</a>? Add a paragraph that says “Let’s think step-by-step.” How about changing the data formatting to JSON? Simply change the <code class="cx ps pt pu pj b">format</code>attribute of the InputData parameters. You can also explore</p><ul class=""><li id="a704" class="nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny pv pw px bk">Going from single examples to batch annotation</li><li id="2cbf" class="nd ne fq nf b go py nh ni gr pz nk nl nm qa no np nq qb ns nt nu qc nw nx ny pv pw px bk">Changing your retriever and ranking function in a RAG scenario</li><li id="7162" class="nd ne fq nf b go py nh ni gr pz nk nl nm qa no np nq qb ns nt nu qc nw nx ny pv pw px bk">Re-ordering some of the paragraphs</li><li id="595d" class="nd ne fq nf b go py nh ni gr pz nk nl nm qa no np nq qb ns nt nu qc nw nx ny pv pw px bk">Compressing certain parts of the instructions</li><li id="4098" class="nd ne fq nf b go py nh ni gr pz nk nl nm qa no np nq qb ns nt nu qc nw nx ny pv pw px bk">Etc.</li></ul><p id="a99d" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Essentially, plug in your favorite prompt engineering heuristic. This abstract representation of prompts allows us to truly get creative and automatically explore a large space of possible prompts. But how can we represent prompts as abstract and modifiable programs in Python? Read on.</p><h2 id="068b" class="qd oi fq bf oj qe qf qg om qh qi qj op nm qk ql qm nq qn qo qp nu qq qr qs qt bk">Turning prompts into abstract programs</h2><blockquote class="qu qv qw"><p id="180d" class="nd ne qx nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">“Any problem in computer science can be solved by another layer of indirection.”</p><p id="2024" class="nd ne qx nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk"><a class="af nc" href="https://en.wikipedia.org/wiki/David_Wheeler_(computer_scientist)" rel="noopener ugc nofollow" target="_blank">David J. Wheeler</a></p></blockquote><p id="d4bf" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">To represent abstract prompts, let’s first convert it into a <em class="qx">non-symbolic prompt program</em> by breaking them into individual components, implemented as Python classes:</p><pre class="mm mn mo mp mq pi pj pk bp pl bb bk"><span id="8eaf" class="pm oi fq pj b bg pn po l pp pq">class Component:<br/>    def __init__(self, **kwargs): pass<br/>class Metaprompt(Component): pass<br/>class Paragraph(Component): pass<br/>class InputData(Component): pass<br/>    <br/>prompt = Metaprompt(<br/>    children=[<br/>        Paragraph(text="Instructions: "),<br/>        Paragraph(<br/>            id="instructions",<br/>            text="Does Speaker 2's answer mean yes or no?",<br/>        ),<br/>        Paragraph(id="labels", text="Output labels: yes, no"),<br/>        InputData(),<br/>        Paragraph(text="Output: "),<br/>    ]<br/>)</span></pre><p id="17ac" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">So far, so good. It’s similar to what DSpy does, albeit more general as we also represent the internal structure of a prompt.</p><p id="5aa6" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Next, we turn it into a <em class="qx">symbolic prompt program</em> so that we can<em class="qx"> </em>make arbitrary changes (this is also beyond static DSPy programs). This can be done with <a class="af nc" href="https://pyglove.readthedocs.io/en/latest/notebooks/intro/birdview.html" rel="noopener ugc nofollow" target="_blank">pyGlove</a>, a library for symbolic object-oriented programming (SOOP). pyGlove turns Python classes into manipulable, symbolic objects whose properties remain fully editable after instantiation.</p><p id="f815" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">With pyGlove, all we need to do is add the <code class="cx ps pt pu pj b">pg.symbolize</code> decorator:</p><pre class="mm mn mo mp mq pi pj pk bp pl bb bk"><span id="d2a5" class="pm oi fq pj b bg pn po l pp pq">import pyglove as pg<br/>@pg.symbolize<br/>class Component:<br/>    def __init__(self, **kwargs): pass</span></pre><p id="7eea" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">We can now query and modify prompt programs via a whole host of specifiers, similar to working with a DOM tree. Let’s say we’d like to transform our program above into the following:</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk qy"><img src="../Images/7df9a7710a1fb272046f66ae8c63ad21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JyrLwTkwyqtJHBUrU5lXfw.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">The target prompt program we want to achieve. Image by author.</figcaption></figure><p id="26d3" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Note that we’re now asking “Does the response mean yes?” and not providing output labels of yes and no. To get there, we need to (i) change the instruction text and (ii) delete the third node. With pyGlove, this is very easy:</p><pre class="mm mn mo mp mq pi pj pk bp pl bb bk"><span id="1b66" class="pm oi fq pj b bg pn po l pp pq">prompt.rebind({'children[1].text': 'Does the response mean yes?'})<br/>prompt.rebind({'children[2]': pg.MISSING_VALUE})<br/>print(prompt)</span></pre><p id="ac8b" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">The printout confirms that we’re successful:</p><pre class="mm mn mo mp mq pi pj pk bp pl bb bk"><span id="628c" class="pm oi fq pj b bg pn po l pp pq">Metaprompt(<br/>  children = [<br/>    0 : Paragraph(<br/>      text = 'Instructions: '<br/>    ),<br/>    1 : Paragraph(<br/>      id = 'instructions',<br/>      text = 'Does the response mean yes?'<br/>    ),<br/>    2 : InputData(),<br/>    3 : Paragraph(<br/>      text = 'Output: '<br/>    )<br/>  ]<br/>)</span></pre><p id="746b" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Voilà! Essentially, pyGlove gives us a way to work with Python classes (and functions) as if they were still source code with little overhead. Now that we have flexible and easily manipulable representations, let’s put them to use.</p></div></div></div><div class="ab cb nz oa ob oc" role="separator"><span class="od by bm oe of og"/><span class="od by bm oe of og"/><span class="od by bm oe of"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="8e22" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Wait a minute. We might have a way to represent and modify prompts now, but we’re still missing a process to optimize them automatically.</p><p id="ecf7" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Once chefs understand the abstraction and components of a recipe, they’ll try out many variants, refining the taste, cost, or presentation, until it feels right. To do the same with prompt abstractions, we need a search algorithm, an objective as well as set of labeled samples to know that we’re making progress.</p><p id="3e62" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Sounds like a lot to implement yourself? Meet <a class="af nc" href="https://github.com/microsoft/sammo" rel="noopener ugc nofollow" target="_blank">SAMMO</a>, a Python library for building and optimizing symbolic prompt programs.</p><h1 id="9117" class="oh oi fq bf oj ok qz gq om on ra gt op oq rb os ot ou rc ow ox oy rd pa pb pc bk">Warming up: Instruction tuning with SAMMO</h1><p id="c0a4" class="pw-post-body-paragraph nd ne fq nf b go pd nh ni gr pe nk nl nm pf no np nq pg ns nt nu ph nw nx ny fj bk">To illustrate SAMMO’s core workflow, we’ll now show how to tune the instructions part of our prompt example from above. Once we’ve worked through this toy example, we’ll be ready to discuss more advanced applications, like RAG optimization or compression.</p><p id="3d78" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">The key steps are</p><ol class=""><li id="2e32" class="nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny re pw px bk">Defining your starting prompt</li><li id="ac21" class="nd ne fq nf b go py nh ni gr pz nk nl nm qa no np nq qb ns nt nu qc nw nx ny re pw px bk">Getting the data ready — a few hundred labeled examples are enough.</li><li id="2ffd" class="nd ne fq nf b go py nh ni gr pz nk nl nm qa no np nq qb ns nt nu qc nw nx ny re pw px bk">Defining the objective</li><li id="65c4" class="nd ne fq nf b go py nh ni gr pz nk nl nm qa no np nq qb ns nt nu qc nw nx ny re pw px bk">Choosing a set of mutators</li><li id="73a7" class="nd ne fq nf b go py nh ni gr pz nk nl nm qa no np nq qb ns nt nu qc nw nx ny re pw px bk">Running the optimization</li></ol><h2 id="7385" class="qd oi fq bf oj qe qf qg om qh qi qj op nm qk ql qm nq qn qo qp nu qq qr qs qt bk">Step 1: Defining your starting prompt</h2><p id="0c84" class="pw-post-body-paragraph nd ne fq nf b go pd nh ni gr pe nk nl nm pf no np nq pg ns nt nu ph nw nx ny fj bk">We’ve pretty much already done this above. SAMMO expects a function, so we’ll have to wrap it in one. If you’d like to store extra information, wrap it in a <a class="af nc" rel="noopener" target="_blank" href="/python-callables-the-basics-and-the-secrets-ba88bf0729aa">Callable</a> instead. We’ll also wrap it in an Output component to run it.</p><pre class="mm mn mo mp mq pi pj pk bp pl bb bk"><span id="d589" class="pm oi fq pj b bg pn po l pp pq">def starting_prompt():<br/>    instructions = MetaPrompt(<br/>        Paragraph(text="Instructions: "),<br/>        Paragraph(<br/>            id="instructions",<br/>            text="Does Speaker 2's answer mean yes or no?",<br/>        ),<br/>        Paragraph(id="labels", text="Output labels: yes, no"),<br/>        InputData(),<br/>        Paragraph(text="Output: "),<br/>    )<br/>    return Output(instructions.with_extractor())</span></pre><h2 id="bcbb" class="qd oi fq bf oj qe qf qg om qh qi qj op nm qk ql qm nq qn qo qp nu qq qr qs qt bk">Step 2: Getting your data ready</h2><p id="1d23" class="pw-post-body-paragraph nd ne fq nf b go pd nh ni gr pe nk nl nm pf no np nq pg ns nt nu ph nw nx ny fj bk">SAMMO uses a simple data structure called DataTable to pair inputs with outputs (labels). This will help us with evaluation and bookkeeping.</p><pre class="mm mn mo mp mq pi pj pk bp pl bb bk"><span id="4f91" class="pm oi fq pj b bg pn po l pp pq">mydata = DataTable.from_records(<br/>    records, # list of {"input": &lt;&gt;, "output": &lt;&gt;}<br/>    constants={"instructions": default_instructions}, <br/>)</span></pre><h2 id="e08d" class="qd oi fq bf oj qe qf qg om qh qi qj op nm qk ql qm nq qn qo qp nu qq qr qs qt bk">Step 3: Defining the objective</h2><p id="6b74" class="pw-post-body-paragraph nd ne fq nf b go pd nh ni gr pe nk nl nm pf no np nq pg ns nt nu ph nw nx ny fj bk">We’re interested in optimizing the accuracy, so that’s what we’re implementing below:</p><pre class="mm mn mo mp mq pi pj pk bp pl bb bk"><span id="1877" class="pm oi fq pj b bg pn po l pp pq">def accuracy(y_true: DataTable, y_pred: DataTable) -&gt; EvaluationScore:<br/>    y_true = y_true.outputs.normalized_values()<br/>    y_pred = y_pred.outputs.normalized_values()<br/>    n_correct = sum([y_p == y_t for y_p, y_t in zip(y_pred, y_true)])<br/>    return EvaluationScore(n_correct / len(y_true))</span></pre><h2 id="53f9" class="qd oi fq bf oj qe qf qg om qh qi qj op nm qk ql qm nq qn qo qp nu qq qr qs qt bk">Step 4: Choosing a set of mutators</h2><p id="caf9" class="pw-post-body-paragraph nd ne fq nf b go pd nh ni gr pe nk nl nm pf no np nq pg ns nt nu ph nw nx ny fj bk">Here is where you can be as creative as you’d like. You can implement your own operators that generate new prompt variants, or simply rely on the pre-built mutation operators that SAMMO offers.</p><p id="c2cf" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Below, we do the latter and go for a mix of paraphrasing and inducing instructions from a few labeled examples, essentially implementing <a class="af nc" href="https://cobusgreyling.medium.com/automatic-prompt-engineering-907e230ece0" rel="noopener">Automatic Prompt Engineering (APE)</a>.</p><pre class="mm mn mo mp mq pi pj pk bp pl bb bk"><span id="5393" class="pm oi fq pj b bg pn po l pp pq">mutation_operators = BagOfMutators(<br/>    starting_prompt=StartingPrompt(d_train),<br/>    InduceInstructions({"id": "instructions"}, d_train),<br/>    Paraphrase({"id": "instructions"}),<br/>)</span></pre><h2 id="166f" class="qd oi fq bf oj qe qf qg om qh qi qj op nm qk ql qm nq qn qo qp nu qq qr qs qt bk">Step 5: Running the optimization</h2><pre class="mm mn mo mp mq pi pj pk bp pl bb bk"><span id="037f" class="pm oi fq pj b bg pn po l pp pq">runner = OpenAIChat(<br/>    model_id="gpt-3.5-turbo-16k",<br/>    api_config={"api_key": YOUR_KEY},<br/>    cache="cache.tsv",<br/>)<br/>prompt_optimizer = BeamSearch(runner, mutation_operators, accuracy, depth=6)<br/>transformed = prompt_optimizer.fit_transform(d_train)</span></pre><p id="b4a3" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">The introductory example prompt was actually taken from the <a class="af nc" href="https://github.com/google/BIG-bench/tree/main/bigbench/benchmark_tasks/implicatures" rel="noopener ugc nofollow" target="_blank">BigBench implicatures task</a> which we’ll use to run this experiment. If you run the optimization with 100 samples for training and testing and a budget of 48 candidates evaluations, you’ll see that SAMMO improves the starting prompt accuracy from <strong class="nf fr">0.56</strong> to <strong class="nf fr">0.77</strong> — a <strong class="nf fr">37.5%</strong> improvement. What instructions worked best?</p><pre class="mm mn mo mp mq pi pj pk bp pl bb bk"><span id="3563" class="pm oi fq pj b bg pn po l pp pq">...<br/>Paragraph(<br/>    "Consider the dialogue, context, and background "<br/>    "information provided to determine the most suitable output label",<br/>    id="instructions",<br/>)<br/>...</span></pre><p id="6124" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Interestingly, different LLMs prefer quite different instructions. GPT-3.5 liked generic instructions the best as seen above. Llama-2’s best prompt selected by SAMMO with the same training and budget setup used an empty string in the instructions part:</p><pre class="mm mn mo mp mq pi pj pk bp pl bb bk"><span id="80e3" class="pm oi fq pj b bg pn po l pp pq">...<br/>Paragraph(<br/>    "",<br/>    id="instructions",<br/>)<br/>...</span></pre><h1 id="1842" class="oh oi fq bf oj ok qz gq om on ra gt op oq rb os ot ou rc ow ox oy rd pa pb pc bk">Getting practical: RAG tuning</h1><p id="9040" class="pw-post-body-paragraph nd ne fq nf b go pd nh ni gr pe nk nl nm pf no np nq pg ns nt nu ph nw nx ny fj bk">We’ll now show how to convert a RAG pipeline into a symbolic program and tune it with SAMMO. We’ll use semantic parsing as our application task where we want to translate user queries into domain-specific language (DSL) constructs, for example, to query some database or call an external API.</p><p id="d9a5" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">To create the starting prompt, we include a list of all operators, use an embedding-based retriever to get five fewshot examples and then instruct the LLM to output its answer in the same format as the examples.</p><pre class="mm mn mo mp mq pi pj pk bp pl bb bk"><span id="c376" class="pm oi fq pj b bg pn po l pp pq">class RagStartingPrompt:<br/>    def __init__(self, dtrain, examples, embedding_runner):<br/>        self._examples = examples<br/>        self._dtrain = dtrain<br/>        self._embedding_runner = embedding_runner<br/><br/>    def __call__(self, return_raw=False):<br/>        structure = [<br/>            Section("Syntax", self._dtrain.constants["list_of_operators"]),<br/>            Section(<br/>                "Examples",<br/>                EmbeddingFewshotExamples(<br/>                    self._embedding_runner, self._examples, 5<br/>                ),<br/>            ),<br/>            Section(<br/>                "Complete and output in the same format as above",<br/>                InputData(),<br/>            ),<br/>        ]<br/>        instructions = MetaPrompt(<br/>            structure,<br/>            render_as="markdown",<br/>            data_formatter=JSONDataFormatter(),<br/>        )  <br/>        return Output(<br/>            instructions.with_extractor(),<br/>            on_error="empty_result",<br/>        )</span></pre><p id="969f" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Now that we have a symbolic program, let’s get creative. For the mutations, we explore</p><ul class=""><li id="f8d7" class="nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny pv pw px bk">varying numbers of fewshot examples</li><li id="29cc" class="nd ne fq nf b go py nh ni gr pz nk nl nm qa no np nq qb ns nt nu qc nw nx ny pv pw px bk">different formats (XML, JSON, line-by-line) for the fewshot examples</li><li id="fac3" class="nd ne fq nf b go py nh ni gr pz nk nl nm qa no np nq qb ns nt nu qc nw nx ny pv pw px bk">providing additional information about the DSL or not</li><li id="374f" class="nd ne fq nf b go py nh ni gr pz nk nl nm qa no np nq qb ns nt nu qc nw nx ny pv pw px bk">showing input-output pairs or groups of inputs and outputs</li></ul><p id="4a41" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Running SAMMO with these and a total budget of 24 candidates to try out, we can see a clear trend. Below are test set accuracies for three different datasets across four different LLMs. In the overwhelming majority of cases, we can see that SAMMO can lift performance substantially, even for the highest-performing LLMs.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk rf"><img src="../Images/b8b5eb0779ecd8d30ded3ab902eba027.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rpvlSPsaNVVUVnCXBCw7SA.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Even with a small budget of 24 candidates evaluations we can get major lifts in performance. Image by author.</figcaption></figure><h1 id="929b" class="oh oi fq bf oj ok qz gq om on ra gt op oq rb os ot ou rc ow ox oy rd pa pb pc bk">Conclusions</h1><p id="adf8" class="pw-post-body-paragraph nd ne fq nf b go pd nh ni gr pe nk nl nm pf no np nq pg ns nt nu ph nw nx ny fj bk">Converting your prompts into symbolic programs is a really powerful idea to explore a large design space of possible prompts and settings. Just as a pro-level chef deconstructs and reinterprets recipes to create culinary innovations, symbolic programming lets us apply the same level of creativity and experimentation to automatic prompt engineering.</p><p id="6e2a" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">SAMMO implements symbolic program search through a set of mutation operators and search routine. Empirically, this can translate into large improvements in accuracy for both instruction tuning and RAG tuning, independent of the backend LLM.</p><p id="942e" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">You can extend SAMMO with custom mutation operators to include your favorite prompt engineering techniques or implement objectives to go beyond accuracy (e.g., cost). Happy prompt cooking!</p><p id="b17a" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk"><em class="qx">Disclaimer:</em><strong class="nf fr"><em class="qx"> </em></strong><em class="qx">I am the author of SAMMO.</em></p><h2 id="6fa2" class="qd oi fq bf oj qe qf qg om qh qi qj op nm qk ql qm nq qn qo qp nu qq qr qs qt bk">Resources</h2><ul class=""><li id="fe2d" class="nd ne fq nf b go pd nh ni gr pe nk nl nm pf no np nq pg ns nt nu ph nw nx ny pv pw px bk"><strong class="nf fr">Code &amp; Jupyter Notebooks: </strong><a class="af nc" href="https://github.com/microsoft/sammo/blob/main/docs/tutorials/5_instruction_optimization.ipynb" rel="noopener ugc nofollow" target="_blank">Instruction tuning</a> and <a class="af nc" href="https://github.com/microsoft/sammo/blob/main/examples/rag_tuning.py" rel="noopener ugc nofollow" target="_blank">RAG tuning</a></li><li id="cb56" class="nd ne fq nf b go py nh ni gr pz nk nl nm qa no np nq qb ns nt nu qc nw nx ny pv pw px bk"><strong class="nf fr">Reading: </strong><a class="af nc" href="https://microsoft.github.io/sammo/tutorials/0_quickstart.html" rel="noopener ugc nofollow" target="_blank">SAMMO user guide</a> and <a class="af nc" href="https://arxiv.org/abs/2404.02319" rel="noopener ugc nofollow" target="_blank">paper on arXiv</a> with more details</li></ul></div></div></div></div>    
</body>
</html>