<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Custom pre-commit hooks for safer code changes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Custom pre-commit hooks for safer code changes</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/custom-pre-commit-hooks-for-safer-code-changes-d8b8aa1b2ebb?source=collection_archive---------5-----------------------#2024-03-14">https://towardsdatascience.com/custom-pre-commit-hooks-for-safer-code-changes-d8b8aa1b2ebb?source=collection_archive---------5-----------------------#2024-03-14</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="da33" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx">A step-by-step guide on writing your first pre-commit hook</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hd he hf hg hh ab"><div><div class="ab hi"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@thijean?source=post_page---byline--d8b8aa1b2ebb--------------------------------" rel="noopener follow"><div class="l hj hk by hl hm"><div class="l ed"><img alt="Thierry Jean" class="l ep by dd de cx" src="../Images/697a9c45220735ab2fcb0d9b57cd20f2.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/1*8pvyc4cUXt8Rj_GkAPVipw.jpeg"/><div class="hn by l dd de em n ho eo"/></div></div></a></div></div><div class="hp ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--d8b8aa1b2ebb--------------------------------" rel="noopener follow"><div class="l hq hr by hl hs"><div class="l ed"><img alt="Towards Data Science" class="l ep by br ht cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hn by l br ht em n ho eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hu ab q"><div class="ab q hv"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hw hx bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hy" data-testid="authorName" href="https://medium.com/@thijean?source=post_page---byline--d8b8aa1b2ebb--------------------------------" rel="noopener follow">Thierry Jean</a></p></div></div></div><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hw hx dx"><button class="ib ic ah ai aj ak al am an ao ap aq ar id ie if" disabled="">Follow</button></p></div></div></span></div></div><div class="l ig"><span class="bf b bg z dx"><div class="ab cn ih ii ij"><div class="ik il ab"><div class="bf b bg z dx ab im"><span class="in l ig">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hy ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--d8b8aa1b2ebb--------------------------------" rel="noopener follow"><p class="bf b bg z io ip iq ir is it iu iv bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">8 min read</span><div class="iw ix l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Mar 14, 2024</span></div></span></div></span></div></div></div><div class="ab cp iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn"><div class="h k w ea eb q"><div class="kd l"><div class="ab q ke kf"><div class="pw-multi-vote-icon ed in kg kh ki"><div class=""><div class="kj kk kl km kn ko kp am kq kr ks ki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kt ku kv kw kx ky kz"><p class="bf b dy z dx"><span class="kk">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kj lc ld ab q ee le lf" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="lb"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg><p class="bf b dy z dx"><span class="pw-responses-count la lb">3</span></p></button></div></div></div><div class="ab q jo jp jq jr js jt ju jv jw jx jy jz ka kb kc"><div class="lg k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lh an ao ap id li lj lk" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep ll cn"><div class="l ae"><div class="ab cb"><div class="lm ln lo lp lq lr ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk ml"><img src="../Images/e7c8a7d092e2b255b1a68b28a2abf755.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HzAJEG9sMVOzpvAWMUzNTw.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">pre-commit run results, including our Hamilton hook!</figcaption></figure><p id="1ec3" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Most software is developed using the <code class="cx ny nz oa ob b">git</code> version control system to update and distribute code. One challenge of writing code collaboratively is ensuring specific standards while each contributor has their style and opinion about what constitutes clean code.</p><p id="31da" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk"><a class="af oc" href="https://pre-commit.com/" rel="noopener ugc nofollow" target="_blank"><strong class="ne fr">pre-commit hooks</strong></a><strong class="ne fr"> </strong>are scripts or commands to execute automatically before committing code changes. They can enforce styling rules and catch errors before they’re committed and further distributed. Notable hooks include checking files for syntax errors, sorting imports, and normalizing quotation marks. They are an essential tool for any project, especially open-source ones with many contributors.</p><h1 id="f60c" class="od oe fq bf of og oh gq oi oj ok gt ol om on oo op oq or os ot ou ov ow ox oy bk">Why create custom pre-commit hooks?</h1><p id="19c0" class="pw-post-body-paragraph nc nd fq ne b go oz ng nh gr pa nj nk nl pb nn no np pc nr ns nt pd nv nw nx fj bk">I wanted to create pre-commit hooks to validate dataflow definitions for the Python library <a class="af oc" href="https://github.com/dagworks-inc/hamilton" rel="noopener ugc nofollow" target="_blank">Hamilton</a>, but I found most online resources scattered and limited to basic use.</p><p id="4ba7" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">In this post, you’ll find:</p><ol class=""><li id="dd29" class="nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx pe pf pg bk">How to start using pre-commit hooks in your project</li><li id="103a" class="nc nd fq ne b go ph ng nh gr pi nj nk nl pj nn no np pk nr ns nt pl nv nw nx pe pf pg bk">A step-by-step tutorial to develop custom pre-commit hooks</li></ol><p id="9cf7" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">To ground the discussion, I’ll go through <a class="af oc" href="https://github.com/DAGWorks-Inc/hamilton-pre-commit" rel="noopener ugc nofollow" target="_blank">this GitHub repository</a> containing the pre-commit hooks I developed for Hamilton.</p><h1 id="a3ca" class="od oe fq bf of og oh gq oi oj ok gt ol om on oo op oq or os ot ou ov ow ox oy bk">Start using pre-commit hooks</h1><p id="47f4" class="pw-post-body-paragraph nc nd fq ne b go oz ng nh gr pa nj nk nl pb nn no np pc nr ns nt pd nv nw nx fj bk">Hooks are a mechanism built directly into the <code class="cx ny nz oa ob b">git</code> version control system. You can find your project’s hooks under the <code class="cx ny nz oa ob b">.git/hooks</code> directory (it might be hidden by default). Although they are colloquially called “pre-commit hooks”, git hooks cover the whole <a class="af oc" href="https://pre-commit.com/#supported-git-hooks" rel="noopener ugc nofollow" target="_blank">git lifecycle</a>. For instance, you can have hooks trigger just after a commit or before a push. Also, hooks can be written in any programming language. Notably, the <a class="af oc" href="https://github.com/astral-sh/ruff" rel="noopener ugc nofollow" target="_blank">Ruff</a> library reimplemented many Python-based hooks in Rust for performance improvement.</p><p id="5869" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Compared to software testing, which focuses on code behavior, you can think of hooks as lightweight checks you would do on each file save. While you can expect tests to change and evolve with your codebase, your code-writing guidelines and pre-commit hooks will likely be constant.</p><h2 id="7b54" class="pm oe fq bf of pn po pp oi pq pr ps ol nl pt pu pv np pw px py nt pz qa qb qc bk">Project setup</h2><p id="6635" class="pw-post-body-paragraph nc nd fq ne b go oz ng nh gr pa nj nk nl pb nn no np pc nr ns nt pd nv nw nx fj bk">Let’s pretend we’re starting a new Python project (or using an existing one) in the directory <code class="cx ny nz oa ob b">/my-project</code>. The preferred way of working with pre-commit hooks is through the <a class="af oc" href="https://github.com/pre-commit/pre-commithttps://github.com/pre-commit/pre-commit" rel="noopener ugc nofollow" target="_blank">pre-commit</a> Python library. We can set it up with the following steps:</p><ol class=""><li id="2096" class="nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx pe pf pg bk">Create a git repository for your project with <code class="cx ny nz oa ob b">git init</code></li><li id="3123" class="nc nd fq ne b go ph ng nh gr pi nj nk nl pj nn no np pk nr ns nt pl nv nw nx pe pf pg bk">Install the pre-commit library with <code class="cx ny nz oa ob b">pip install pre-commit</code></li><li id="65c4" class="nc nd fq ne b go ph ng nh gr pi nj nk nl pj nn no np pk nr ns nt pl nv nw nx pe pf pg bk">Add a <code class="cx ny nz oa ob b">.pre-commit-config.yaml</code> to your repository. Here’s an example:</li></ol><pre class="mm mn mo mp mq qd ob qe bp qf bb bk"><span id="4630" class="qg oe fq ob b bg qh qi l qj qk"># .pre-commit-config.yaml<br/>repos:<br/>    # repository with hook definitions<br/>-   repo: https://github.com/pre-commit/pre-commit-hooks<br/>    rev: v2.3.0  # release version of the repo<br/>    hooks:  # list of hooks from the repo to include in this project<br/>    -   id: end-of-file-fixer<br/>    -   id: trailing-whitespace<br/>    -   id: check-yaml<br/>        args: ['--unsafe']  # add arguments to `check-yaml`<br/><br/>    # download another repository with hooks<br/>-   repo: https://github.com/psf/black<br/>    rev: 22.10.0<br/>    hooks:<br/>    -   id: black</span></pre><p id="1566" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">4. Install the hooks with <code class="cx ny nz oa ob b">pre-commit install</code>. It will read instructions from <code class="cx ny nz oa ob b">.pre-commit-config.yaml</code> and install hooks locally under <code class="cx ny nz oa ob b">.git/hooks/pre-commit</code></p><p id="c980" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">5. Make a commit or manually run hooks with <code class="cx ny nz oa ob b">pre-commit run --all-files</code> to trigger the hooks</p><h1 id="c5c7" class="od oe fq bf of og oh gq oi oj ok gt ol om on oo op oq or os ot ou ov ow ox oy bk">Create a custom pre-commit hook</h1><p id="7a65" class="pw-post-body-paragraph nc nd fq ne b go oz ng nh gr pa nj nk nl pb nn no np pc nr ns nt pd nv nw nx fj bk"><a class="af oc" href="https://pre-commit.com/hooks.html" rel="noopener ugc nofollow" target="_blank">Community-maintained hooks</a> provide flexibility and can be tailored to meet your preferred coding guidelines. They should meet your needs 98% of the time. However, off-the-shelf solutions don’t know about the specific tools you’re using or your team’s internal conventions. For example, you might want to validate internal configurations or enforce a directory structure for your projects.</p><p id="98e6" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">In our case, we want to create a hook to validate the Python code for their Hamilton dataflow definition. Our hook script will leverage the <code class="cx ny nz oa ob b"><a class="af oc" href="https://blog.dagworks.io/p/a-command-line-tool-to-improve-your" rel="noopener ugc nofollow" target="_blank">hamilton</a></code><a class="af oc" href="https://blog.dagworks.io/p/a-command-line-tool-to-improve-your" rel="noopener ugc nofollow" target="_blank"> CLI tool</a> to conduct the validation, leaving us with a simple code example to follow.</p><h2 id="b89a" class="pm oe fq bf of pn po pp oi pq pr ps ol nl pt pu pv np pw px py nt pz qa qb qc bk">1. Setting up your pre-commit hook repository</h2><p id="8627" class="pw-post-body-paragraph nc nd fq ne b go oz ng nh gr pa nj nk nl pb nn no np pc nr ns nt pd nv nw nx fj bk">As introduced in the <strong class="ne fr">Project setup</strong> section, pre-commit hooks need to exist in a public repository to allow projects to reference them in <code class="cx ny nz oa ob b">.pre-commit-config.yaml</code> and install them locally with <code class="cx ny nz oa ob b">pre-commit install</code>.</p><p id="a8d3" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Previously, we were in our project directory <code class="cx ny nz oa ob b">/my-project</code> where we defined a <code class="cx ny nz oa ob b">.pre-commit-config.yaml</code> and installed hooks. Now, we’ll create a <code class="cx ny nz oa ob b">/my-hooks</code> directory where we’ll define our custom hooks. You can refer to our <code class="cx ny nz oa ob b"><a class="af oc" href="https://github.com/DAGWorks-Inc/hamilton-pre-commit" rel="noopener ugc nofollow" target="_blank">hamilton-pre-commit</a></code><a class="af oc" href="https://github.com/DAGWorks-Inc/hamilton-pre-commit" rel="noopener ugc nofollow" target="_blank"> repository</a> to view the general structure.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk ql"><img src="../Images/166a5ca7285e66ff4c4dd89f6f0b0b6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lCGsPyWfLUBJILyJTUujPg.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Screenshot of the <a class="af oc" href="https://github.com/dagworks-inc/hamilton-pre-commit" rel="noopener ugc nofollow" target="_blank">hamilton-pre-commit repository</a></figcaption></figure><h2 id="a3e0" class="pm oe fq bf of pn po pp oi pq pr ps ol nl pt pu pv np pw px py nt pz qa qb qc bk">2. Writing the hook’s logic</h2><p id="3ffd" class="pw-post-body-paragraph nc nd fq ne b go oz ng nh gr pa nj nk nl pb nn no np pc nr ns nt pd nv nw nx fj bk">Under <code class="cx ny nz oa ob b">hooks/</code>, we have a file <code class="cx ny nz oa ob b">__init__.py</code> to <a class="af oc" href="https://docs.python.org/3/tutorial/modules.html" rel="noopener ugc nofollow" target="_blank">make the directory a discoverable Python module</a> and our script <code class="cx ny nz oa ob b">cli_command.py</code>. It contains a single function <code class="cx ny nz oa ob b">main()</code>, which reads a list of <code class="cx ny nz oa ob b">hamilton</code> CLI commands from <code class="cx ny nz oa ob b">sys.argv</code>. Then, it executes them one by one as a subprocess wrapped in a <code class="cx ny nz oa ob b">try/except</code> clause.</p><pre class="mm mn mo mp mq qd ob qe bp qf bb bk"><span id="4ebc" class="qg oe fq ob b bg qh qi l qj qk"># hooks/cli_command.py<br/>import sys<br/>import json<br/>import subprocess<br/><br/>PASS = 0<br/>FAIL = 1<br/><br/>def main() -&gt; int:<br/>    """Execute a list of commands using the Hamilton CLI"""    <br/>    commands = sys.argv[1:]<br/><br/>    if len(commands) == 0:<br/>        return PASS<br/>        <br/>    exit_code = PASS<br/>    for command in commands:<br/>        try:<br/>            args = command.split(" ")<br/>            # insert `--json-out` for proper stdout parsing<br/>            args.insert(1, "--json-out")<br/>            result = subprocess.run(args, stdout=subprocess.PIPE, text=True)<br/>            response = json.loads(result.stdout)<br/>            <br/>            if response["success"] is False:<br/>                raise ValueError<br/>                <br/>        except Exception:<br/>            exit_code |= FAIL<br/><br/>    return exit_code<br/><br/>if __name__ == "__main__":<br/>    raise SystemExit(main())</span></pre><p id="bac2" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">At the beginning, we set <code class="cx ny nz oa ob b">exit_code = PASS</code>, but any exception or unsuccessful commands will set <code class="cx ny nz oa ob b">exit_code = FAIL</code>. The <code class="cx ny nz oa ob b">main()</code> function returns the exit code to the <code class="cx ny nz oa ob b">SystemExit</code> exception. For the pre-commit hook to succeed, we need to return <code class="cx ny nz oa ob b">PASS</code> after all commands succeeded. It might be counterintuitive to have <code class="cx ny nz oa ob b">PASS=0</code> and <code class="cx ny nz oa ob b">FAIL=1</code> but these values refer to the standard <a class="af oc" href="https://stackoverflow.com/questions/9426045/difference-between-exit0-and-exit1-in-python/9426054#9426054" rel="noopener ugc nofollow" target="_blank">system’s exit code</a>.</p><p id="1964" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">We used Python for convenience, but this simple logic could be in a lighter scripting language like Bash. You can visit the <a class="af oc" href="https://github.com/pre-commit/pre-commit-hooks" rel="noopener ugc nofollow" target="_blank">hooks maintained by the pre-commit team</a> for more examples.</p><h2 id="5b77" class="pm oe fq bf of pn po pp oi pq pr ps ol nl pt pu pv np pw px py nt pz qa qb qc bk">3. Defining the hook entry point</h2><p id="dbfe" class="pw-post-body-paragraph nc nd fq ne b go oz ng nh gr pa nj nk nl pb nn no np pc nr ns nt pd nv nw nx fj bk">Now, your hooks repository (<code class="cx ny nz oa ob b">/my-hooks</code>) must include a <code class="cx ny nz oa ob b">.pre-commit-hooks.yaml</code> file that specifies the available hooks and how to execute them once installed.</p><pre class="mm mn mo mp mq qd ob qe bp qf bb bk"><span id="a3b6" class="qg oe fq ob b bg qh qi l qj qk">- id: cli-command<br/>  name: Execute `hamilton` CLI commands<br/>  description: This hook executes a command using the `hamilton` CLI.<br/>  entry: cli-command<br/>  language: python<br/>  types: [python]<br/>  stages: [pre-commit, pre-merge-commit, manual]<br/>  pass_filenames: false</span></pre><p id="1bce" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">In our case, we set <code class="cx ny nz oa ob b">id: cli-command </code>and <code class="cx ny nz oa ob b">entry: cli-command</code>, add some metadata, and specify the programming language as Python. Importantly, the <code class="cx ny nz oa ob b">files</code> attribute wasn’t set to have our hook run once per commit. In your case, you might want to set <code class="cx ny nz oa ob b">files: "*.py"</code> to run your hook on each edited Python file for example (learn about <a class="af oc" href="https://pre-commit.com/#new-hooks." rel="noopener ugc nofollow" target="_blank">available options</a>).</p><p id="844b" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">So far, we created a Python script under <code class="cx ny nz oa ob b">hooks/cli_command.py</code> and added to <code class="cx ny nz oa ob b">.pre-commit-hooks.yaml</code> a hook with the entry point <code class="cx ny nz oa ob b">cli-command</code>. However, you need to link the two explicitly in your Python project file <code class="cx ny nz oa ob b">pyproject.toml</code>.</p><pre class="mm mn mo mp mq qd ob qe bp qf bb bk"><span id="ea66" class="qg oe fq ob b bg qh qi l qj qk">[project.scripts]<br/>cli-command = "hooks.cli_command:main"</span></pre><p id="5b37" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">This line reads “the entry point <code class="cx ny nz oa ob b">cli-command</code> refers to the function <code class="cx ny nz oa ob b">main</code> in <code class="cx ny nz oa ob b">hooks.cli_command</code>”.</p><blockquote class="qm qn qo"><p id="1085" class="nc nd qp ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">see <a class="af oc" href="https://github.com/pre-commit/pre-commit-hooks/blob/main/setup.cfg" rel="noopener ugc nofollow" target="_blank">this example</a> if you’re using <code class="cx ny nz oa ob b">setup.cfg</code>for your Python project</p></blockquote><h2 id="b022" class="pm oe fq bf of pn po pp oi pq pr ps ol nl pt pu pv np pw px py nt pz qa qb qc bk">4. Testing your hook locally</h2><p id="e332" class="pw-post-body-paragraph nc nd fq ne b go oz ng nh gr pa nj nk nl pb nn no np pc nr ns nt pd nv nw nx fj bk">First, you should validate your hook’s logic with unit tests. However, we won’t dive into testing since it deserves its own post. Our <code class="cx ny nz oa ob b">hamilton-pre-commit</code> repository currently doesn’t have tests since the underlying CLI is tested under the main Hamilton repository. You can visit the <a class="af oc" href="https://github.com/pre-commit/pre-commit-hooks/tree/main/tests" rel="noopener ugc nofollow" target="_blank">officially maintained pre-commit hooks</a> for test examples.</p><p id="c040" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Second, you should verify that the <code class="cx ny nz oa ob b">.pre-commit-hooks.yaml</code> and entry points are properly configured by trying your pre-commit hook locally. Ideally, you’d want to avoid adding a commit to trigger the hook each time you want to test changes. The pre-commit library provides utilities to facilitate this process, but it requires a few manual steps detailed in <a class="af oc" href="https://github.com/pre-commit/pre-commit/issues/850" rel="noopener ugc nofollow" target="_blank">pre-commit GitHub issues</a>.</p><ol class=""><li id="d2dc" class="nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx pe pf pg bk">Go to your directory <code class="cx ny nz oa ob b">/my-project</code> where you’d like to test your hook.</li><li id="acbc" class="nc nd fq ne b go ph ng nh gr pi nj nk nl pj nn no np pk nr ns nt pl nv nw nx pe pf pg bk">Execute <code class="cx ny nz oa ob b">pre-commit try-repo ../LOCAL/PATH/TO/my-hooks</code> then, you should see a local initialization message.</li></ol><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk qq"><img src="../Images/3b0b7c51f01500026015f0abc28eae0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O--PJYp8FHrBPw86iPITLA.png"/></div></div></figure><p id="ef1f" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">One limitation is that you can’t directly pass <code class="cx ny nz oa ob b">args</code> to your hook via this command.</p><p id="fe59" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">3. Copy the configuration found under <code class="cx ny nz oa ob b">Using config:</code> to a local file and add the <code class="cx ny nz oa ob b">args</code> section. We created <code class="cx ny nz oa ob b">.local-pre-commit-config.yaml</code> but you can use any name.</p><pre class="mm mn mo mp mq qd ob qe bp qf bb bk"><span id="32e0" class="qg oe fq ob b bg qh qi l qj qk"># my-project/.local-pre-commit-config.yaml<br/>repos:<br/>  - repo: ../../dagworks/hamilton-pre-commit<br/>    rev: e4b77a499ba0ff3446a86ebbe4c2cbca82eb54f8<br/>    hooks:<br/>    - id: cli-command<br/>      args: [<br/>        hamilton build my_func2.py<br/>      ]</span></pre><p id="c9ed" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">4. Use your local hook via <code class="cx ny nz oa ob b">pre-commit run --config .local-pre-commit-config.yaml --all-files</code>. The <code class="cx ny nz oa ob b">--all-files</code> flag will apply the hook to all files in your repository instead of those currently staged.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk qr"><img src="../Images/7f26ca2ae6b9ab675d6ea632e3925a27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Apr36ZUN84RtL2xuwuOgMw.png"/></div></div></figure><blockquote class="qm qn qo"><p id="1bb7" class="nc nd qp ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">When adding a test, always start by making it fail. You wouldn’t want to add a test that always succeeds <code class="cx ny nz oa ob b">:^)</code></p></blockquote><h2 id="9f46" class="pm oe fq bf of pn po pp oi pq pr ps ol nl pt pu pv np pw px py nt pz qa qb qc bk">5. Publishing your pre-commit hook</h2><p id="3149" class="pw-post-body-paragraph nc nd fq ne b go oz ng nh gr pa nj nk nl pb nn no np pc nr ns nt pd nv nw nx fj bk">You’re almost there! You have a working hook script that’s tested and packaged in a git repository. Now, you just need to make it available online. We will show the steps for GitHub-hosted projects, but your pre-commit hook can live anywhere accessible via <code class="cx ny nz oa ob b">git clone</code>.</p><ol class=""><li id="9d08" class="nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx pe pf pg bk">From your GitHub repository, go to the <strong class="ne fr">Releases </strong>section</li></ol><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk qs"><img src="../Images/56f353c45e92f3b91e8680fa8826a653.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Du4r4SjxjOGwP58rMOJrgg.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Main page of a GitHub repository.</figcaption></figure><p id="5f15" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">2. Click <strong class="ne fr">Draft a new release</strong></p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk qt"><img src="../Images/74b19fc73cfe7dace94e8d01408d0cdf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3eNjkCTPWsmqVQWFpO2FOw.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx"><strong class="bf of">Releases </strong>section of a GitHub repository</figcaption></figure><p id="61c1" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">3. On the new release page, you need to add a version tag, a title, and a description. If it’s your first release, I suggest setting the tag as <code class="cx ny nz oa ob b">v0.1.0</code> to <a class="af oc" href="https://semver.org/" rel="noopener ugc nofollow" target="_blank">follow semantic versioning</a>, as recommended by GitHub.</p><p id="fa75" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">When you’re making changes and want to distribute experimental versions, you can set your version as <code class="cx ny nz oa ob b">v0.1.1-rc</code> (for “release candidate”) and mark it as a pre-release using the checkbox.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk qu"><img src="../Images/bbf212038a852dbff5ac65cc2800eb47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8QW0tsnmJ2NJQhCBlrEFBg.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx"><strong class="bf of">New release </strong>form on GitHub.</figcaption></figure><p id="6e04" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">The <code class="cx ny nz oa ob b">rev</code> value in your <code class="cx ny nz oa ob b">.pre-commit-config.yaml</code> file will need to match the <strong class="ne fr">version tag</strong> you set.</p><pre class="mm mn mo mp mq qd ob qe bp qf bb bk"><span id="c8ff" class="qg oe fq ob b bg qh qi l qj qk">repos:<br/>- repo: https://github.com/DAGWorks-Inc/hamilton-pre-commit<br/>  rev: v0.1.3rc<br/>  hooks:<br/>    - id: cli-command<br/>      # ...</span></pre><h1 id="598c" class="od oe fq bf of og oh gq oi oj ok gt ol om on oo op oq or os ot ou ov ow ox oy bk">Concluding remarks</h1><p id="1282" class="pw-post-body-paragraph nc nd fq ne b go oz ng nh gr pa nj nk nl pb nn no np pc nr ns nt pd nv nw nx fj bk">Congrats! You made it through this post! You are now able to use pre-commit hooks to improve code quality in your projects. Equipped with an understanding of their internals, you can start writing your own hooks!</p><p id="8397" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Don’t forget to take a look at the many hooks maintained by the community before reinventing the wheel: <a class="af oc" href="https://pre-commit.com/hooks.html" rel="noopener ugc nofollow" target="_blank">https://pre-commit.com/hooks.html</a></p></div></div></div><div class="ab cb qv qw qx qy" role="separator"><span class="qz by bm ra rb rc"/><span class="qz by bm ra rb rc"/><span class="qz by bm ra rb"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="732d" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Check out the <a class="af oc" href="https://github.com/DAGWorks-Inc/hamilton" rel="noopener ugc nofollow" target="_blank">Hamilton</a> library to write dataflows in Python!<br/>Find me on <a class="af oc" href="https://www.linkedin.com/in/thierry-jean/" rel="noopener ugc nofollow" target="_blank">LinkedIn</a> and more of my posts on the <a class="af oc" href="https://blog.dagworks.io/" rel="noopener ugc nofollow" target="_blank">DAGWorks blog</a></p></div></div></div></div>    
</body>
</html>