<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Callbacks and Pipeline structures in LangChain</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Callbacks and Pipeline structures in LangChain</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/callbacks-and-pipeline-structures-in-langchain-925aa077227e?source=collection_archive---------6-----------------------#2024-04-16">https://towardsdatascience.com/callbacks-and-pipeline-structures-in-langchain-925aa077227e?source=collection_archive---------6-----------------------#2024-04-16</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="3e6f" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx">Learn about the structure of LangChain pipelines, callbacks, how to create custom callbacks and integrate them into your pipelines for improved monitoring</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hd he hf hg hh ab"><div><div class="ab hi"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@RSK2327?source=post_page---byline--925aa077227e--------------------------------" rel="noopener follow"><div class="l hj hk by hl hm"><div class="l ed"><img alt="Roshan Santhosh" class="l ep by dd de cx" src="../Images/2509f38bf7d5a40c453fa54575293f06.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/2*WZ0oPku8QDRZpZp9zdfjnQ.png"/><div class="hn by l dd de em n ho eo"/></div></div></a></div></div><div class="hp ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--925aa077227e--------------------------------" rel="noopener follow"><div class="l hq hr by hl hs"><div class="l ed"><img alt="Towards Data Science" class="l ep by br ht cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hn by l br ht em n ho eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hu ab q"><div class="ab q hv"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hw hx bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hy" data-testid="authorName" href="https://medium.com/@RSK2327?source=post_page---byline--925aa077227e--------------------------------" rel="noopener follow">Roshan Santhosh</a></p></div></div></div><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hw hx dx"><button class="ib ic ah ai aj ak al am an ao ap aq ar id ie if" disabled="">Follow</button></p></div></div></span></div></div><div class="l ig"><span class="bf b bg z dx"><div class="ab cn ih ii ij"><div class="ik il ab"><div class="bf b bg z dx ab im"><span class="in l ig">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hy ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--925aa077227e--------------------------------" rel="noopener follow"><p class="bf b bg z io ip iq ir is it iu iv bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">11 min read</span><div class="iw ix l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Apr 16, 2024</span></div></span></div></span></div></div></div><div class="ab cp iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn"><div class="h k w ea eb q"><div class="kd l"><div class="ab q ke kf"><div class="pw-multi-vote-icon ed in kg kh ki"><div class=""><div class="kj kk kl km kn ko kp am kq kr ks ki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kt ku kv kw kx ky kz"><p class="bf b dy z dx"><span class="kk">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kj la lb ab q ee lc ld" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="le"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg></button></div></div></div><div class="ab q jo jp jq jr js jt ju jv jw jx jy jz ka kb kc"><div class="lf k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lg an ao ap id lh li lj" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep lk cn"><div class="l ae"><div class="ab cb"><div class="ll lm ln lo lp lq ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lg an ao ap id lr ls ld lt lu lv lw lx s ly lz ma mb mc md me u mf mg mh"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lg an ao ap id lr ls ld lt lu lv lw lx s ly lz ma mb mc md me u mf mg mh"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lg an ao ap id lr ls ld lt lu lv lw lx s ly lz ma mb mc md me u mf mg mh"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><p id="5d4d" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk">Callbacks are an important functionality that helps with monitoring/debugging your pipelines. In this note, we cover the basics of callbacks and how to create custom ones for your use cases. More importantly, through examples, we also develop an understanding of the structure/componentization of LangChain pipelines and how that plays into the design of custom callbacks.</p><p id="0ad4" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk">This note assumes basic familiarity with LangChain and how pipelines in LangChain work.</p><h1 id="2e0e" class="ne nf fq bf ng nh ni gq nj nk nl gt nm nn no np nq nr ns nt nu nv nw nx ny nz bk">Basic Structure of Callbacks</h1><p id="14cb" class="pw-post-body-paragraph mi mj fq mk b go oa mm mn gr ob mp mq mr oc mt mu mv od mx my mz oe nb nc nd fj bk">To learn about the basics of callbacks in LangChain, we start with the <a class="af of" href="https://python.langchain.com/docs/modules/callbacks/" rel="noopener ugc nofollow" target="_blank">official documentation</a> where we can find the definition of the <strong class="mk fr">BaseCallbackHandler</strong> class.</p><figure class="oj ok ol om on oo og oh paragraph-image"><div role="button" tabindex="0" class="op oq ed or bh os"><div class="og oh oi"><img src="../Images/09298f9767c694b691d4567ee5fed0e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Tncx8UKcUUdPn77-mqj8Bw.png"/></div></div><figcaption class="ou ov ow og oh ox oy bf b bg z dx">Image taken from official <a class="af of" href="https://python.langchain.com/docs/modules/callbacks/" rel="noopener ugc nofollow" target="_blank">langchain documentation</a></figcaption></figure><p id="2b71" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk"><a class="af of" href="https://github.com/langchain-ai/langchain/blob/master/libs/core/langchain_core/callbacks/base.py" rel="noopener ugc nofollow" target="_blank">BaseCallbackManager code</a></p><p id="82f8" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk">As you can see this is an abstract class that defines quite a few methods to cover various events in your LangChain pipeline. These methods can be grouped together into the following segments :</p><ol class=""><li id="6e01" class="mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd oz pa pb bk">LLM [start, end, error, new token]</li><li id="ffbb" class="mi mj fq mk b go pc mm mn gr pd mp mq mr pe mt mu mv pf mx my mz pg nb nc nd oz pa pb bk">Chain [start, end, error]</li><li id="1cab" class="mi mj fq mk b go pc mm mn gr pd mp mq mr pe mt mu mv pf mx my mz pg nb nc nd oz pa pb bk">Tool [start, end, error]</li><li id="31c8" class="mi mj fq mk b go pc mm mn gr pd mp mq mr pe mt mu mv pf mx my mz pg nb nc nd oz pa pb bk">Agent [action, finish]</li></ol><p id="f0da" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk">If you have worked with LangChain pipelines before, the methods along with their provided descriptions should be mostly self explanatory. For example, the <strong class="mk fr"><em class="ph">on_llm_start</em></strong> callback is the event that gets triggered when the LangChain pipeline passes input to the LLM. And that <strong class="mk fr"><em class="ph">on_llm_end</em></strong> is subsequently triggered when the LLM provides its final output.</p><blockquote class="pi pj pk"><p id="d2ec" class="mi mj ph mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk"><em class="fq">NOTE : There are events triggers that can be used in addition to whats shown above. These can be found </em><a class="af of" href="https://api.python.langchain.com/en/latest/runnables/langchain_core.runnables.base.RunnableSequence.html" rel="noopener ugc nofollow" target="_blank"><em class="fq">here</em></a><em class="fq">. These cover triggers relating to Retrievers, Prompts, ChatModel etc.</em></p></blockquote><h1 id="5f6f" class="ne nf fq bf ng nh ni gq nj nk nl gt nm nn no np nq nr ns nt nu nv nw nx ny nz bk">Understanding how Callbacks work</h1><p id="ac5f" class="pw-post-body-paragraph mi mj fq mk b go oa mm mn gr ob mp mq mr oc mt mu mv od mx my mz oe nb nc nd fj bk">Callbacks are a very common programming concept that have been widely used for a while now, so the high level concept of how callbacks work is well understood. So in this post, we focus on the specific nuances of how callbacks work in LangChain and how we could use it to satisfy our specific use cases.</p><p id="906b" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk">Keeping in the mind the base Callback class that we saw in the previous section, we explore Callbacks in LangChain through a series of increasingly complex examples and in the process gain a better understanding of the structure of pipelines in LangChain. This would be a top-down approach to learning where we start with examples first and actual definitions later as I found that to be more useful personally for this specific topic.</p></div></div></div><div class="ab cb pl pm pn po" role="separator"><span class="pp by bm pq pr ps"/><span class="pp by bm pq pr ps"/><span class="pp by bm pq pr"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><h1 id="cbc3" class="ne nf fq bf ng nh pt gq nj nk pu gt nm nn pv np nq nr pw nt nu nv px nx ny nz bk">Example 1</h1><p id="0221" class="pw-post-body-paragraph mi mj fq mk b go oa mm mn gr ob mp mq mr oc mt mu mv od mx my mz oe nb nc nd fj bk">We start with a simple dummy chain that has 3 components : 2 prompts and a custom function to join them. I refer to this as a dummy example because its very unlikely that you would need two separate prompts to interact with each other, but it makes for an easier example to start with for understanding callbacks and LangChain pipelines.</p><figure class="oj ok ol om on oo og oh paragraph-image"><div role="button" tabindex="0" class="op oq ed or bh os"><div class="og oh py"><img src="../Images/a85491d7b3e8d386730736be9216aac8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u5OexjZX9WhuOEdwhoTIiw.png"/></div></div><figcaption class="ou ov ow og oh ox oy bf b bg z dx">Example 1 : Basic structure of LangChain pipeline</figcaption></figure><p id="bfeb" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk">Implementing this in code would look like :</p><figure class="oj ok ol om on oo og oh paragraph-image"><div class="og oh pz"><img src="../Images/feb48b47658516acf9ea930c09acb98c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1252/format:webp/1*WpRuZD1WUyrNfJ4mq8QWZw.png"/></div><figcaption class="ou ov ow og oh ox oy bf b bg z dx">Pipeline implementation for Example 1</figcaption></figure><p id="4450" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk">The above code is pretty textbook stuff. The only possibly complex piece is the <strong class="mk fr"><em class="ph">retrieve_text</em></strong> and <strong class="mk fr"><em class="ph">RunnableLambda</em></strong> function thats being used here. The reason this is necessary is because the format of the output from <strong class="mk fr"><em class="ph">qa_prompt1</em></strong> is not compatible with the format of the output required by <strong class="mk fr"><em class="ph">qa_prompt2.</em></strong></p><p id="edfc" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk"><strong class="mk fr">Defining the custom Callback</strong></p><figure class="oj ok ol om on oo og oh paragraph-image"><div role="button" tabindex="0" class="op oq ed or bh os"><div class="og oh qa"><img src="../Images/ad6bc4c936d6251b991b066126236e51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lNpZ_kG7wlql6WSG59Z8hA.png"/></div></div></figure><p id="32cc" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk">For our custom callback, we define a new subclass of BaseCallbackHandler called CustomCallback1 which defines the <strong class="mk fr"><em class="ph">on_chain_start</em></strong> method. The method definition is straightforward as it simply takes the input values passed to it and saves it in 2 specific variables : <strong class="mk fr"><em class="ph">chain_input</em></strong> and <strong class="mk fr"><em class="ph">serialized_input</em></strong></p><p id="7fa7" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk"><strong class="mk fr">Invoking the custom callback</strong></p><figure class="oj ok ol om on oo og oh paragraph-image"><div role="button" tabindex="0" class="op oq ed or bh os"><div class="og oh qb"><img src="../Images/98c6c6878453f2bea6bfb157f45f84bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DGcvbMwycWmpAW-rAOhsUg.png"/></div></div><figcaption class="ou ov ow og oh ox oy bf b bg z dx">Example 1 : Invoking with pipeline with the custom callback</figcaption></figure><p id="25ab" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk">The above code shows one of the possible ways to pass your custom callback to your pipeline : As a list of callback objects as the value to a corresponding key of ‘callbacks’. This also makes it easy to guess that <em class="ph">you can pass multiple callbacks to your LangChain pipeline.</em></p><h2 id="2beb" class="qc nf fq bf ng qd qe qf nj qg qh qi nm mr qj qk ql mv qm qn qo mz qp qq qr qs bk">Decoding the Callback/Pipeline Structure</h2><p id="a16a" class="pw-post-body-paragraph mi mj fq mk b go oa mm mn gr ob mp mq mr oc mt mu mv od mx my mz oe nb nc nd fj bk">Now comes the interesting part. After we have defined the callbacks and passed it on to our pipeline, we now perform a deep dive into the callback outputs</p><p id="aa0e" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk">We first look at the values stored in <strong class="mk fr"><em class="ph">chain_input</em></strong></p><figure class="oj ok ol om on oo og oh paragraph-image"><div role="button" tabindex="0" class="op oq ed or bh os"><div class="og oh qt"><img src="../Images/86a11c5f570e3a85f96289a9b62f2698.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3yK2JH16prFcFUviz9TKww.png"/></div></div><figcaption class="ou ov ow og oh ox oy bf b bg z dx">Example 1 : Contents of chain_input variable of callback handler</figcaption></figure><p id="adcd" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk"><strong class="mk fr">Observations :</strong></p><ol class=""><li id="5750" class="mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd oz pa pb bk">Though <strong class="mk fr">there are 3 components in our chain, there are 4 values in <em class="ph">chain_input</em></strong>. Which corresponds to the <strong class="mk fr"><em class="ph">on_chain_start</em></strong> method being triggered 4 times instead of 3.</li><li id="f6dd" class="mi mj fq mk b go pc mm mn gr pd mp mq mr pe mt mu mv pf mx my mz pg nb nc nd oz pa pb bk">For the first two <strong class="mk fr"><em class="ph">chain_input</em></strong> values/ on_chain_start triggers, the input is the same as the user provided input.</li></ol><p id="ed9d" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk">We next look at the outputs of <strong class="mk fr"><em class="ph">serialized_input</em></strong></p><figure class="oj ok ol om on oo og oh paragraph-image"><div class="og oh qu"><img src="../Images/0d71d6c54bc40938b4099c2f89863fde.png" data-original-src="https://miro.medium.com/v2/resize:fit:1158/format:webp/1*RYjlBk8bpK1s45ATzYheRw.png"/></div></figure><p id="a02a" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk"><strong class="mk fr">Observations :</strong></p><ol class=""><li id="fd78" class="mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd oz pa pb bk">The first component is a <strong class="mk fr"><em class="ph">RunnableSequence </em></strong>which is a component that wasnt added by the user but was automatically added by LangChain. The rest of the components correspond directly to the user-defined components in the pipeline.</li><li id="e3b3" class="mi mj fq mk b go pc mm mn gr pd mp mq mr pe mt mu mv pf mx my mz pg nb nc nd oz pa pb bk">The full contents of serialized_input is extensive! While there is a definite structure to that content, its definitely out of scope for this post and possibly doesnt have much practical implications for an end user.</li></ol><h2 id="124f" class="qc nf fq bf ng qd qe qf nj qg qh qi nm mr qj qk ql mv qm qn qo mz qp qq qr qs bk">How do we interpret these results</h2><p id="ce69" class="pw-post-body-paragraph mi mj fq mk b go oa mm mn gr ob mp mq mr oc mt mu mv od mx my mz oe nb nc nd fj bk">For the most part, the outputs seen in the <strong class="mk fr"><em class="ph">chain_input</em></strong> and <strong class="mk fr"><em class="ph">serialized_input</em></strong> make sense. Whether its the input values or the names/IDs of the components. The only largely unknown part is the <strong class="mk fr"><em class="ph">RunnableSequence</em></strong> component, so we take a closer look at this.</p><p id="ce62" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk">As I mentioned previously, the full contents of <strong class="mk fr"><em class="ph">serialized_input </em></strong>is extensive and not easy to digest. So to make things easier, we look at only the high level attributes described in <strong class="mk fr"><em class="ph">serialized_input </em></strong>and try to intrepret the results through these attributes. For this, we make use of a custom debugging function called <strong class="mk fr"><em class="ph">getChainBreakdown </em></strong>(code in notebook).</p><p id="e0c5" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk">We call <strong class="mk fr"><em class="ph">getChainBreakdown</em></strong> on all values of <strong class="mk fr"><em class="ph">serialized_input</em></strong> and observe the output. Specifically for the first <strong class="mk fr"><em class="ph">RunnableSequence</em></strong> element, we look at the keys of the kwargs dict : first, midde, last, name.</p><figure class="oj ok ol om on oo og oh paragraph-image"><div class="og oh qv"><img src="../Images/a6ccf5a1ef4250daa084ec5cff56725a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1244/format:webp/1*IjlULunfkQI1U6uq04mAvQ.png"/></div></figure><p id="b617" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk">On closer inspection of the kwargs argument and their values, we see that they have the same structure as our previous pipeline components. In fact, <strong class="mk fr">the first, middle and last components correspond exactly to the user-defined components of the pipeline.</strong></p><figure class="oj ok ol om on oo og oh paragraph-image"><div class="og oh qw"><img src="../Images/3918083f2cf8c069ce8d73a234ec7894.png" data-original-src="https://miro.medium.com/v2/resize:fit:1262/format:webp/1*ry_xm1pY8u-LebXWzgSK3A.png"/></div><figcaption class="ou ov ow og oh ox oy bf b bg z dx">Closer inspection of RunnableSequence kwargs values</figcaption></figure><p id="68f4" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk">The above details form the basis of the final conclusion that we make here. That the structure of the pipeline is like shown below :</p><figure class="oj ok ol om on oo og oh paragraph-image"><div role="button" tabindex="0" class="op oq ed or bh os"><div class="og oh qx"><img src="../Images/733df8d01a5d1285fc7c71ed85d20ba1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CRDmfr5yQUVerRXQ09n3CA.png"/></div></div><figcaption class="ou ov ow og oh ox oy bf b bg z dx">Example 1 : Structure of LangChain pipeline</figcaption></figure><blockquote class="pi pj pk"><p id="6fa0" class="mi mj ph mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk">We do make a bit of a leap here as the above flowchart was confirmed after going through a bunch of examples and observing the format in which these components are created internally by LangChain. So bear with me as we go through these other examples which will solidify the conclusion that we make here.</p></blockquote><p id="10e5" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk">With the above defined structure, the other pieces of the puzzle fit together quite well. Focusing on the chain_input values, lets map them to the components (with their ordering) defined above.</p><figure class="oj ok ol om on oo og oh paragraph-image"><div role="button" tabindex="0" class="op oq ed or bh os"><div class="og oh qy"><img src="../Images/dd692e9be32631fa88cd061b0571b0c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_zBVCnrlA0tOAnM1XaOebQ.png"/></div></div><figcaption class="ou ov ow og oh ox oy bf b bg z dx">Example 1 : Mapping chain_input values to pipeline components</figcaption></figure><p id="21b4" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk"><strong class="mk fr">Observations :</strong></p><ol class=""><li id="ffc0" class="mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd oz pa pb bk">For RunnableSequence, as it acts like a wrapper for the whole pipeline, the input from the user acts as the input for the RunnableSequence component as well.</li><li id="ead2" class="mi mj fq mk b go pc mm mn gr pd mp mq mr pe mt mu mv pf mx my mz pg nb nc nd oz pa pb bk">For the first ChatPromptTemplate (qa_prompt1), as the first ‘true’ component of the pipeline, it receives the direct input from the user</li><li id="e970" class="mi mj fq mk b go pc mm mn gr pd mp mq mr pe mt mu mv pf mx my mz pg nb nc nd oz pa pb bk">For RunnableLambda (retrieve_text), it receives as input the output from qa_prompt1, which is a Message object</li><li id="2c51" class="mi mj fq mk b go pc mm mn gr pd mp mq mr pe mt mu mv pf mx my mz pg nb nc nd oz pa pb bk">For the last ChatPromptTemplate (qa_prompt2), it receives as input the output from retrieve_text, which is a dict with ‘prompt’ as its single key</li></ol><p id="c831" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk">The above breakdown shows how the structure of the pipeline described above fits perfectly with the data seen in <strong class="mk fr"><em class="ph">serialized_input</em></strong> and <strong class="mk fr"><em class="ph">chain_input</em></strong></p></div></div></div><div class="ab cb pl pm pn po" role="separator"><span class="pp by bm pq pr ps"/><span class="pp by bm pq pr ps"/><span class="pp by bm pq pr"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><h1 id="6cc3" class="ne nf fq bf ng nh pt gq nj nk pu gt nm nn pv np nq nr pw nt nu nv px nx ny nz bk"><strong class="al">Example 2</strong></h1><p id="61a6" class="pw-post-body-paragraph mi mj fq mk b go oa mm mn gr ob mp mq mr oc mt mu mv od mx my mz oe nb nc nd fj bk">For the next example, we extend Example 1 by adding a LLM as the final step.</p><figure class="oj ok ol om on oo og oh paragraph-image"><div class="og oh qz"><img src="../Images/fcd60f4feaecfe05f96f2afcaaf932af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1348/format:webp/1*uenqLsiVtGqYzX1CCFtxIg.png"/></div><figcaption class="ou ov ow og oh ox oy bf b bg z dx">Example 2 : Pipeline definition</figcaption></figure><p id="5f1e" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk">For the callback, since we have now added a LLM into the mix, we define a new custom callback that additionally defines the <strong class="mk fr"><em class="ph">on_llm_start</em></strong> method. It has the same functionality as on_chain_start where the input arguments are saved into the callback object variables : <strong class="mk fr"><em class="ph">chain_input</em></strong> and <strong class="mk fr"><em class="ph">serialized_input</em></strong></p><figure class="oj ok ol om on oo og oh paragraph-image"><div role="button" tabindex="0" class="op oq ed or bh os"><div class="og oh ra"><img src="../Images/afd7116322e83863c9057c4515c3d11c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TH2tYt3NmcZRLGMobsUJfA.png"/></div></div><figcaption class="ou ov ow og oh ox oy bf b bg z dx">Example 2 : New custom callback with added on_llm_start method</figcaption></figure><h2 id="34b6" class="qc nf fq bf ng qd qe qf nj qg qh qi nm mr qj qk ql mv qm qn qo mz qp qq qr qs bk">Proposing the Pipeline structure</h2><p id="a3c7" class="pw-post-body-paragraph mi mj fq mk b go oa mm mn gr ob mp mq mr oc mt mu mv od mx my mz oe nb nc nd fj bk">At this stage, instead of evaluating the callback variables, we switch things up and propose the potential structure of the pipeline. Given what we had learnt from the first example, the following should be the potential structure of the pipeline</p></div></div><div class="oo"><div class="ab cb"><div class="ll rb lm rc ln rd cf re cg rf ci bh"><figure class="oj ok ol om on oo rh ri paragraph-image"><div role="button" tabindex="0" class="op oq ed or bh os"><div class="og oh rg"><img src="../Images/25c4f818730b753f5f092f0f5f20adfc.png" data-original-src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*iXfJOLTK73OUWHWy357Y5A.png"/></div></div><figcaption class="ou ov ow og oh ox oy bf b bg z dx">Example 2 : Proposed structure of pipeline</figcaption></figure></div></div></div><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="3bce" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk">So we would have a <strong class="mk fr"><em class="ph">RunnableSequence</em></strong> component as a wrapper for the pipeline. And additionally include a new <strong class="mk fr"><em class="ph">ChatOpenAI</em></strong> object thats nested within the <strong class="mk fr"><em class="ph">RunnableSequence</em></strong> component.</p><h2 id="7c01" class="qc nf fq bf ng qd qe qf nj qg qh qi nm mr qj qk ql mv qm qn qo mz qp qq qr qs bk"><strong class="al">Validating proposed structure using data</strong></h2><p id="054d" class="pw-post-body-paragraph mi mj fq mk b go oa mm mn gr ob mp mq mr oc mt mu mv od mx my mz oe nb nc nd fj bk">We now look at the values of in the callback object to validate the above proposed structure.</p><p id="58e8" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk">We first look at the values stored in <strong class="mk fr"><em class="ph">chain_input</em></strong></p><figure class="oj ok ol om on oo og oh paragraph-image"><div role="button" tabindex="0" class="op oq ed or bh os"><div class="og oh rj"><img src="../Images/e5821967629f973e91c7862bca104b41.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8n_EBww1M1fxmEKUnt_EJg.png"/></div></div><figcaption class="ou ov ow og oh ox oy bf b bg z dx">Example 2 : chain_input values</figcaption></figure><p id="989a" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk">And then the <strong class="mk fr"><em class="ph">serialized_input</em></strong> values :</p><figure class="oj ok ol om on oo og oh paragraph-image"><div class="og oh rk"><img src="../Images/e9819f105451d2ee4d17284071f5bb1c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1166/format:webp/1*3aKV32KGJt7ytKCOs0iSEQ.png"/></div><figcaption class="ou ov ow og oh ox oy bf b bg z dx">Example 2 : serialized_input values</figcaption></figure><p id="6b03" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk">As well as a deeper inspection of the RunnableSequence components</p><figure class="oj ok ol om on oo og oh paragraph-image"><div class="og oh rl"><img src="../Images/39b910cc4e2d3d951bd01d0bcc4403e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1232/format:webp/1*6XfcHFHL_CCxB2cAHmzkEg.png"/></div><figcaption class="ou ov ow og oh ox oy bf b bg z dx">Example 2 : Closer inspection of RunnableSequence kwargs values</figcaption></figure><p id="1af9" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk"><strong class="mk fr">Observations :</strong></p><ol class=""><li id="a652" class="mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd oz pa pb bk">The values of <strong class="mk fr"><em class="ph">serialized_input</em></strong> validate the activation/trigger sequence that was proposed in the pipeline structure : RunnableSequence -&gt; ChatPromptTemplate(qa_prompt1) -&gt; RunnableLambda(retrieve_text) -&gt; ChatPromptTemplate(qa_prompt2) -&gt; ChatOpenAI</li><li id="70dd" class="mi mj fq mk b go pc mm mn gr pd mp mq mr pe mt mu mv pf mx my mz pg nb nc nd oz pa pb bk">The values of <strong class="mk fr"><em class="ph">chain_input</em></strong> also map correctly to the proposed structure. The only new addition is the fifth entry, which corresponds to the output from <strong class="mk fr"><em class="ph">qa_prompt2</em></strong>, which is fed as input to the ChatOpenAI object</li><li id="fb9c" class="mi mj fq mk b go pc mm mn gr pd mp mq mr pe mt mu mv pf mx my mz pg nb nc nd oz pa pb bk">The components of the RunnableSequence kwargs also verify the proposed structure as the new ‘last’ element is the ChatOpenAI object</li></ol><p id="92ee" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk">By this stage, you should have an intuitive understanding of how LangChain pipelines are structured and when/how different callback events are triggered.</p><blockquote class="pi pj pk"><p id="ab1f" class="mi mj ph mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk">Though we have only focused on Chain and LLM events so far, these translate well to the other Tool and Agent triggers as well</p></blockquote></div></div></div><div class="ab cb pl pm pn po" role="separator"><span class="pp by bm pq pr ps"/><span class="pp by bm pq pr ps"/><span class="pp by bm pq pr"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><h1 id="6468" class="ne nf fq bf ng nh pt gq nj nk pu gt nm nn pv np nq nr pw nt nu nv px nx ny nz bk">Example 3</h1><p id="2a01" class="pw-post-body-paragraph mi mj fq mk b go oa mm mn gr ob mp mq mr oc mt mu mv od mx my mz oe nb nc nd fj bk">For the next example, we progress to a more complex chain involving a parallel implementation (RunnableParallel)</p><h2 id="3de4" class="qc nf fq bf ng qd qe qf nj qg qh qi nm mr qj qk ql mv qm qn qo mz qp qq qr qs bk">Chain/Callback Implementation</h2><p id="5c62" class="pw-post-body-paragraph mi mj fq mk b go oa mm mn gr ob mp mq mr oc mt mu mv od mx my mz oe nb nc nd fj bk">The chain has a parallel implementation as its first block which computes two values : context and question, which are then passed on to a prompt template to create the final prompt. The parallel functionality is required because we need to pass both context and question to the prompt template at the same time, where the context is retrived from a different source while the question is provided by the user.</p><p id="2016" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk">For the context value, we use a static function <strong class="mk fr"><em class="ph">get_data</em></strong> that returns the same piece of text (this is a dummy version of an actual retriever used in RAG applications).</p><figure class="oj ok ol om on oo og oh paragraph-image"><div role="button" tabindex="0" class="op oq ed or bh os"><div class="og oh qt"><img src="../Images/41d8affecbf0cbcce12300f47c983acb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YY0vJVb0KKZqAnHRbQ6eKA.png"/></div></div><figcaption class="ou ov ow og oh ox oy bf b bg z dx">Example 3 : Chain implementation</figcaption></figure><p id="8499" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk">For the callback implementation, we use the same callback as the first example, CustomCallback1</p><h2 id="9e2c" class="qc nf fq bf ng qd qe qf nj qg qh qi nm mr qj qk ql mv qm qn qo mz qp qq qr qs bk">Decoding the Callback/Pipeline Structure</h2><p id="0962" class="pw-post-body-paragraph mi mj fq mk b go oa mm mn gr ob mp mq mr oc mt mu mv od mx my mz oe nb nc nd fj bk">Similar to previous examples, we start by looking at the outputs of <strong class="mk fr"><em class="ph">chain_input</em></strong> and <strong class="mk fr"><em class="ph">serialized_input</em></strong></p><figure class="oj ok ol om on oo og oh paragraph-image"><div role="button" tabindex="0" class="op oq ed or bh os"><div class="og oh rm"><img src="../Images/a92432cbeb40d6a15dac6a227e83d2ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n4XDhSXDU9P7LmyscZDgFw.png"/></div></div><figcaption class="ou ov ow og oh ox oy bf b bg z dx">Example 3 : chain_input values</figcaption></figure><figure class="oj ok ol om on oo og oh paragraph-image"><div class="og oh rn"><img src="../Images/9ff2607608a8df2e0a2f9bbfbae4aa7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1188/format:webp/1*jEQpH1P5jAuupJZm11h-Kg.png"/></div><figcaption class="ou ov ow og oh ox oy bf b bg z dx">Example 3 : serialized_input values</figcaption></figure><p id="b988" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk">We also look do a deep dive into the <strong class="mk fr"><em class="ph">RunnableSequence</em></strong> (index 0) and <strong class="mk fr"><em class="ph">RunnableParallel</em></strong> (index 1) components</p><figure class="oj ok ol om on oo og oh paragraph-image"><div class="og oh ro"><img src="../Images/6cd911544c6a75f852469b21689410bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1372/format:webp/1*ffPW2AUvAuxXPqVISy2LOQ.png"/></div></figure><p id="e0e1" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk"><strong class="mk fr">Observations :</strong></p><ol class=""><li id="b431" class="mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd oz pa pb bk">Consistent with previous examples, the RunnableSequence acts as a wrapper to the whole pipeline. Its first component is the <strong class="mk fr"><em class="ph">RunnableParallel</em></strong> component and its last component is the <strong class="mk fr"><em class="ph">ChatPromptTemplate</em></strong> component</li><li id="343a" class="mi mj fq mk b go pc mm mn gr pd mp mq mr pe mt mu mv pf mx my mz pg nb nc nd oz pa pb bk">The RunnableParallel in turn encompasses two components : the <strong class="mk fr"><em class="ph">RunnablePassthrough </em></strong>and the<strong class="mk fr"><em class="ph"> RunnableLambda</em></strong> (<strong class="mk fr"><em class="ph">get_data</em></strong>).</li><li id="43db" class="mi mj fq mk b go pc mm mn gr pd mp mq mr pe mt mu mv pf mx my mz pg nb nc nd oz pa pb bk">The inputs to the first 4 components : <strong class="mk fr"><em class="ph">RunnableSequence</em></strong>, <strong class="mk fr"><em class="ph">RunnableParallel</em></strong>, <strong class="mk fr"><em class="ph">RunnablePassthrough</em></strong> and <strong class="mk fr"><em class="ph">RunnableLambda</em></strong> (<strong class="mk fr"><em class="ph">get_data</em></strong>) are the same : the provided user input. Only for the final <strong class="mk fr"><em class="ph">ChatPromptTemplate</em></strong> component do we have a different input, which is a dict with question and context keys.</li></ol><p id="9617" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk">Based on these observations, we can infer the final structure of the pipeline as such :</p></div></div><div class="oo"><div class="ab cb"><div class="ll rb lm rc ln rd cf re cg rf ci bh"><figure class="oj ok ol om on oo rh ri paragraph-image"><div role="button" tabindex="0" class="op oq ed or bh os"><div class="og oh rp"><img src="../Images/dd8756214b5be8bafed7eec2f58d5bc1.png" data-original-src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*Hpb2bS23GdhrrZbhGG8gyQ.png"/></div></div><figcaption class="ou ov ow og oh ox oy bf b bg z dx">Example 3 : Structure of LangChain pipeline</figcaption></figure></div></div></div></div><div class="ab cb pl pm pn po" role="separator"><span class="pp by bm pq pr ps"/><span class="pp by bm pq pr ps"/><span class="pp by bm pq pr"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><h1 id="5a1c" class="ne nf fq bf ng nh pt gq nj nk pu gt nm nn pv np nq nr pw nt nu nv px nx ny nz bk">Example 4</h1><p id="90f9" class="pw-post-body-paragraph mi mj fq mk b go oa mm mn gr ob mp mq mr oc mt mu mv od mx my mz oe nb nc nd fj bk">Same as Example 3, but with an additional processing function for retrieving context</p><h2 id="bd72" class="qc nf fq bf ng qd qe qf nj qg qh qi nm mr qj qk ql mv qm qn qo mz qp qq qr qs bk">Chain/Callback Implementation</h2><figure class="oj ok ol om on oo og oh paragraph-image"><div role="button" tabindex="0" class="op oq ed or bh os"><div class="og oh rq"><img src="../Images/0ef17c0768f777f46bdc7111b72cb469.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XIIBBJD1imLl-8VCLVhqdA.png"/></div></div><figcaption class="ou ov ow og oh ox oy bf b bg z dx">Example 4 : Chain implementation</figcaption></figure><h2 id="b847" class="qc nf fq bf ng qd qe qf nj qg qh qi nm mr qj qk ql mv qm qn qo mz qp qq qr qs bk">Decoding the Callback/Pipeline Structure</h2><p id="a94e" class="pw-post-body-paragraph mi mj fq mk b go oa mm mn gr ob mp mq mr oc mt mu mv od mx my mz oe nb nc nd fj bk">Similar to previous examples, we again look at the usual data points</p><figure class="oj ok ol om on oo og oh paragraph-image"><div class="og oh rr"><img src="../Images/89b0a6509f53fd7a8e67ef3354784c60.png" data-original-src="https://miro.medium.com/v2/resize:fit:1152/format:webp/1*qAh4VPIIqGD94KhiXbUfJQ.png"/></div><figcaption class="ou ov ow og oh ox oy bf b bg z dx">Example 4 : chain_input values</figcaption></figure><figure class="oj ok ol om on oo og oh paragraph-image"><div role="button" tabindex="0" class="op oq ed or bh os"><div class="og oh rs"><img src="../Images/8798ce2d935710f97f481fac0a1eaeff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1164/format:webp/1*7jJWAsTSPHrR3XmAMLJMNg.png"/></div></div><figcaption class="ou ov ow og oh ox oy bf b bg z dx">Example 4 : serialized_input values</figcaption></figure><p id="d792" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk">We observe that there are now 2 RunnableSequence components in our pipeline. So for the next step, we deep dive into both of these RunnableSequence components to see its internal components</p><figure class="oj ok ol om on oo og oh paragraph-image"><div class="og oh rt"><img src="../Images/75d6cea7cc29c1a6cb021c70594d57aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1236/format:webp/1*uiInMmwb3TdRRmKCyn9O1Q.png"/></div></figure><p id="de7d" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk"><strong class="mk fr">Observations :</strong></p><ol class=""><li id="16a5" class="mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd oz pa pb bk">For the first <strong class="mk fr"><em class="ph">RunnableSequence</em></strong> components, its components are the same as the previous example. Starts with <strong class="mk fr"><em class="ph">RunnableParallel</em></strong> and ends with <strong class="mk fr"><em class="ph">ChatPromptTemplate</em></strong></li><li id="fbdf" class="mi mj fq mk b go pc mm mn gr pd mp mq mr pe mt mu mv pf mx my mz pg nb nc nd oz pa pb bk">For the second <strong class="mk fr"><em class="ph">RunnableSequence</em></strong>, its first component is the <strong class="mk fr"><em class="ph">RunnableLambda (get_data) </em></strong>component and the last component is the <strong class="mk fr"><em class="ph">RunnableLambda (format_docs)</em></strong> component. This is basically the part of the pipeline responsible for generating the ‘context’ value. So its possible for a LangChain pipeline to have multiple RunnableSequence components to it. Especially when you are creating ‘sub-pipelines’</li></ol><blockquote class="pi pj pk"><p id="5c8a" class="mi mj ph mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk">In this case, the creation of the ‘context’ value can be considered a pipeline by itself as it involves 2 different components chained together. So any such sub-pipelines in your primary pipeline will be wrapped up by a RunnableSequence component</p></blockquote><p id="661a" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk">3. The values from chain_input also match up well with the pipeline components and their ordering (Not going to breakdown each component’s input here as it should be self-explanatory by now)</p><p id="e841" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk">So based on the above observations, the following is the identified structure of this pipeline</p></div></div><div class="oo"><div class="ab cb"><div class="ll rb lm rc ln rd cf re cg rf ci bh"><figure class="oj ok ol om on oo rh ri paragraph-image"><div role="button" tabindex="0" class="op oq ed or bh os"><div class="og oh ru"><img src="../Images/6b5a3c01eed6ad1e1e32a0ab06a5196d.png" data-original-src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*efaYnIQr7KhDsC7PFznWsg.png"/></div></div><figcaption class="ou ov ow og oh ox oy bf b bg z dx">Example 4 : Structure of LangChain pipeline</figcaption></figure></div></div></div><div class="ab cb"><div class="ci bh ev ew ex ey"><h1 id="c5d9" class="ne nf fq bf ng nh ni gq nj nk nl gt nm nn no np nq nr ns nt nu nv nw nx ny nz bk">Conclusion</h1><p id="9038" class="pw-post-body-paragraph mi mj fq mk b go oa mm mn gr ob mp mq mr oc mt mu mv od mx my mz oe nb nc nd fj bk">The objective of this post was to help develop an (intuitive) understanding of how LangChain pipelines are structured and how callback triggers are associated with the pipeline.</p><p id="4f21" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk">By going through increasingly complex chain implementations, we were able to understand the general structure of LangChain pipelines and how a callback can be used for retrieving useful information. Developing an understanding of how LangChain pipelines are structured will also help facilitate the debugging process when errors are encountered.</p><p id="b601" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk">A very common use case for callbacks is retrieving intermediate steps and through these examples we saw how we can implement custom callbacks that track the input at each stage of the pipeline. Add to this our understanding of the structure of the LangChain pipelines, we can now easily pinpoint the input to each component of the pipeline and retrieve it accordingly.</p><h1 id="65a2" class="ne nf fq bf ng nh ni gq nj nk nl gt nm nn no np nq nr ns nt nu nv nw nx ny nz bk">Resources</h1><p id="15be" class="pw-post-body-paragraph mi mj fq mk b go oa mm mn gr ob mp mq mr oc mt mu mv od mx my mz oe nb nc nd fj bk"><a class="af of" href="https://github.com/rsk2327/AI-Workbook/blob/3c92744030b79f849867b15fc19ee1e738b83eab/LangChain/Callback%20Deep%20Dive.ipynb" rel="noopener ugc nofollow" target="_blank">Notebook with code/examples</a> : Contains few additional examples not covered in this note.</p><p id="9979" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk">Unless specified otherwise, all images are created by the author.</p></div></div></div><div class="ab cb pl pm pn po" role="separator"><span class="pp by bm pq pr ps"/><span class="pp by bm pq pr ps"/><span class="pp by bm pq pr"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="821a" class="pw-post-body-paragraph mi mj fq mk b go ml mm mn gr mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd fj bk"><em class="ph">In addition to Medium, I share my thoughts, ideas and other updates on </em><a class="af of" href="https://www.linkedin.com/in/roshan-santhosh/" rel="noopener ugc nofollow" target="_blank"><em class="ph">Linkedin</em></a><em class="ph">.</em></p></div></div></div></div>    
</body>
</html>