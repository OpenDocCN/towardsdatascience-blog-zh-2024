<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>SQLite in Modern Web Production: Dreams Becoming Reality</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>SQLite in Modern Web Production: Dreams Becoming Reality</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/sqlite-in-production-dreams-becoming-reality-94557bec095b?source=collection_archive---------0-----------------------#2024-12-12">https://towardsdatascience.com/sqlite-in-production-dreams-becoming-reality-94557bec095b?source=collection_archive---------0-----------------------#2024-12-12</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="015e" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx">On the virtues of radical simplicity</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hd he hf hg hh ab"><div><div class="ab hi"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@ed.izaguirre?source=post_page---byline--94557bec095b--------------------------------" rel="noopener follow"><div class="l hj hk by hl hm"><div class="l ed"><img alt="Ed Izaguirre" class="l ep by dd de cx" src="../Images/c9eded1f06c47571baa662107428483f.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/1*X9RggnIeuLK8p0PvTB4jNw.jpeg"/><div class="hn by l dd de em n ho eo"/></div></div></a></div></div><div class="hp ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--94557bec095b--------------------------------" rel="noopener follow"><div class="l hq hr by hl hs"><div class="l ed"><img alt="Towards Data Science" class="l ep by br ht cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hn by l br ht em n ho eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hu ab q"><div class="ab q hv"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hw hx bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hy" data-testid="authorName" href="https://medium.com/@ed.izaguirre?source=post_page---byline--94557bec095b--------------------------------" rel="noopener follow">Ed Izaguirre</a></p></div></div></div><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hw hx dx"><button class="ib ic ah ai aj ak al am an ao ap aq ar id ie if" disabled="">Follow</button></p></div></div></span></div></div><div class="l ig"><span class="bf b bg z dx"><div class="ab cn ih ii ij"><div class="ik il ab"><div class="bf b bg z dx ab im"><span class="in l ig">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hy ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--94557bec095b--------------------------------" rel="noopener follow"><p class="bf b bg z io ip iq ir is it iu iv bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">10 min read</span><div class="iw ix l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Dec 12, 2024</span></div></span></div></span></div></div></div><div class="ab cp iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn"><div class="h k w ea eb q"><div class="kd l"><div class="ab q ke kf"><div class="pw-multi-vote-icon ed in kg kh ki"><div class=""><div class="kj kk kl km kn ko kp am kq kr ks ki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kt ku kv kw kx ky kz"><p class="bf b dy z dx"><span class="kk">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kj lc ld ab q ee le lf" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="lb"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg><p class="bf b dy z dx"><span class="pw-responses-count la lb">2</span></p></button></div></div></div><div class="ab q jo jp jq jr js jt ju jv jw jx jy jz ka kb kc"><div class="lg k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lh an ao ap id li lj lk" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep ll cn"><div class="l ae"><div class="ab cb"><div class="lm ln lo lp lq lr ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk ml"><img src="../Images/2bc16ed3ce0f1cb1d7050f5368656ff2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tka1FfADJhSGtl-9tTRyvw.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">A simple landscape. From Unsplash.</figcaption></figure><p id="84ea" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk"><em class="ny">This</em><strong class="ne fr"><em class="ny"> </em></strong><em class="ny">is the first in a two-part series on using SQLite for web applications and machine learning. In this article, I dive into why SQLite is rapidly becoming a production-ready database for modern web apps. In the second article, I will discuss how to perform retrieval-augmented-generation using SQLite.</em></p><p id="c898" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk"><em class="ny">If you’d like a custom web application with generative AI integration, visit </em><a class="af nz" href="https://losangelesaiapps.com/" rel="noopener ugc nofollow" target="_blank"><em class="ny">losangelesaiapps.com</em></a></p></div></div></div><div class="ab cb oa ob oc od" role="separator"><span class="oe by bm of og oh"/><span class="oe by bm of og oh"/><span class="oe by bm of og"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><h1 id="b796" class="oi oj fq bf ok ol om gq on oo op gt oq or os ot ou ov ow ox oy oz pa pb pc pd bk">SQLite: Escape from the Cave of Complexity</h1><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk pe"><img src="../Images/3621646166a7c86da96ea5b1aaa9caf6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*gECWcbQAkNH9YGaa.jpg"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx"><a class="af nz" href="https://en.wikipedia.org/wiki/Allegory_of_the_cave" rel="noopener ugc nofollow" target="_blank">Plato’s Allegory of the Cave</a>, by Jan Saenredam, 1604.</figcaption></figure><blockquote class="pf pg ph"><p id="6e59" class="nc nd ny ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">“If you seek tranquility, do less.</p><p id="44f0" class="nc nd ny ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">— <em class="fq">Marcus Aurelius</em></p></blockquote><p id="b5db" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Most databases running modern web software today operate on a <strong class="ne fr">client-server architecture</strong>. In this architecture, the server is the central system that manages data. It processes requests from and sends responses to clients. Clients here refer to users or applications that interact with the database through the server.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk pi"><img src="../Images/079e71dc5d51a6101c4f07437aa23740.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*CjwmnUHKaHhm6Ehq.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">The client-server architecture. From pixabay.</figcaption></figure><p id="1c10" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">A simple way to understand this architecture is to use the analogy of libraries. The server is the <em class="ny">library</em>, each piece of data is a <em class="ny">book</em>, and the client is a <em class="ny">visitor</em>. In this world, visitors don’t pick books out directly from the shelves. They instead must go through the librarian, who has meticulously organized their library to make it easy to find a book. In this world, a visitor’s access to the library is mediated entirely through the library’s staff (server-side).</p><p id="8577" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">This is a pretty neat architecture. However, for smaller, lightweight applications it is engineering overkill. If you only have a few books, why do you need to build multiple shelves, let alone multiple rooms? The alternative to the client-server architecture is the <strong class="ne fr">single-file architecture </strong>used by the <strong class="ne fr">SQLite database</strong>.</p><p id="64a4" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">For the uninitiated, SQLite is the Platonic ideal of databases. As opposed to running an entire server to manage the access to data, this database is housed entirely within a single file. Your application is then able to create, read, update, and destroy data by simply modifying this one file. When you deploy a web application backed by a client-server database, you are deploying not one service but two services: one for your application and one for your database. With SQLite, you only have to deploy a single service: your application with the SQLite file included. This means less complexity and less cost.</p><p id="e8d0" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Returning to our analogy, using SQLite is like having a single notebook in which all of your data is stored. No shelves, no libraries, no librarians. You just open the book and add, delete, or update your data. Perhaps you can get fancy, and add an index in the back of your book to speed up search. You can imagine how much simpler this would be.</p><p id="e66a" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">However, as they say in economics: there are no solutions, there are only trade-offs. SQLite is not perfect, and there are valid reasons for why it has rarely seen usage in modern web applications. In this article, I will highlight some of the issues that have dogged SQLite and how recent advancements have removed these barriers.</p><h1 id="0e53" class="oi oj fq bf ok ol pj gq on oo pk gt oq or pl ot ou ov pm ox oy oz pn pb pc pd bk">Issue #1: Concurrency</h1><p id="c197" class="pw-post-body-paragraph nc nd fq ne b go po ng nh gr pp nj nk nl pq nn no np pr nr ns nt ps nv nw nx fj bk">The primary issue in SQLite has traditionally been <strong class="ne fr">concurrency related. </strong>SQLite uses a write lock to ensure that only one write operation occurs at a time. We don’t want transactions interfering with each other. If you attempt to send concurrent write requests, you will often get a <code class="cx pt pu pv pw b">SQLITE_BUSY</code> error, and one of the transactions will have been lost. In the case of concurrent requests, we want the transactions to queue up and play nice with each other.</p><p id="bccb" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Unfortunately, the default transaction mode in SQLite does not facilitate this. Some important background: a <strong class="ne fr">transaction</strong> typically involves a series of database <strong class="ne fr">statements</strong>, such as reads and writes, that are executed together.</p><pre class="mm mn mo mp mq px pw py bp pz bb bk"><span id="40aa" class="qa oj fq pw b bg qb qc l qd qe">-- An example transaction<br/>BEGIN DEFERRED TRANSACTION;<br/>SELECT * FROM inventory WHERE id = 1; -- Statement 1<br/>UPDATE inventory SET stock = stock + 1 WHERE id = 1; -- Statement 2</span></pre><p id="3fc1" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">The default transaction mode in SQLite is the <strong class="ne fr">deferred transaction mode. </strong>In this mode:</p><ul class=""><li id="294e" class="nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx qf qg qh bk">No lock is acquired at the start of the transaction.</li><li id="0b83" class="nc nd fq ne b go qi ng nh gr qj nj nk nl qk nn no np ql nr ns nt qm nv nw nx qf qg qh bk">A <strong class="ne fr">read-only statement</strong> doesn’t trigger a write lock; it only requires a shared read lock, which allows concurrent reads. Think <code class="cx pt pu pv pw b">SELECT</code> statements.</li><li id="b991" class="nc nd fq ne b go qi ng nh gr qj nj nk nl qk nn no np ql nr ns nt qm nv nw nx qf qg qh bk">A <strong class="ne fr">write statement</strong> requires an exclusive write lock, which blocks all other reads and writes until the transaction is complete. Think <code class="cx pt pu pv pw b">INSERT</code>, <code class="cx pt pu pv pw b">UPDATE</code>, or <code class="cx pt pu pv pw b">DELETE</code> statements.</li></ul><p id="89cb" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">As an example, take a look at the following two transactions. Suppose they were to run at the same time:</p><pre class="mm mn mo mp mq px pw py bp pz bb bk"><span id="fe0d" class="qa oj fq pw b bg qb qc l qd qe">-- Transaction 1<br/>BEGIN DEFERRED TRANSACTION;<br/>SELECT * FROM inventory WHERE id = 1; <br/>UPDATE inventory SET stock = stock + 1 WHERE id = 1; <br/><br/>-- Transcation 2<br/>BEGIN DEFERRED TRANSACTION;<br/>UPDATE inventory SET stock = stock - 1 WHERE id = 1; <br/><br/>-- Example sequence of events:<br/>  -- Transaction 1 begins<br/>    -- SELECT statement: No lock is acquired yet.<br/>  -- Transaction 2 begins<br/>    -- Acquires a write lock (UPDATE statement).<br/>  -- Transcation 1 continues<br/>    -- Tries to acquire a write lock (UPDATE statement).<br/>    -- Fails because Transaction 2 already committed and released the lock.<br/>    -- SQLite throws SQLITE_BUSY.<br/>  -- Transaction 2 commits successfully. Transaction 1 has failed.</span></pre><p id="da40" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">In this scenario, because <code class="cx pt pu pv pw b">Transaction 1</code> was mid-transaction when the <code class="cx pt pu pv pw b">SQLITE_BUSY</code> exception was thrown, it will not be re-queued after <code class="cx pt pu pv pw b">Transaction 2</code> is finished with the write lock; it will just be cancelled. SQLite doesn’t want to risk inconsistent results should another transaction modify overlapping data during the lock wait, so it just tells the interrupted transaction to buzz off.</p><p id="fc05" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Think of it this way: imagine you and your friend are sharing a notebook. You start reading a half-finished story in the notebook, planning to write the next part. But before you can pick up your pen, your friend snatches the notebook. “<em class="ny">You weren’t writing anything anyway!</em>” they exclaim. What if they change something crucial in your story? Frustrated and unable to continue, you give up in a huff, abandoning your attempt to finish the story. Turns out, your friend isn’t as nice as you thought!</p><p id="1550" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">How can we fix this issue? What if you establish the following rule: when one of you grabs the notebook, <strong class="ne fr">regardless of if you are reading or writing</strong>, that person gets to use the notebook until they are done? Issue solved!</p><p id="10d8" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">This transaction mode in SQLite is known as <strong class="ne fr">immediate</strong>. Now, when one transaction begins, regardless of whether it is writing or reading, it claims the write lock. If a concurrent transaction attempts to claim the write lock, it will now queue up nicely behind the current one instead of throwing the <code class="cx pt pu pv pw b">SQLITE_BUSY</code> .</p><p id="bfb9" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Using the immediate transaction mode goes a long way towards solving the concurrency issue in SQLite. To continue improving concurrency, we can also change the <strong class="ne fr">journal mode</strong>. The default here is a <strong class="ne fr">rollback journal</strong>. In this paradigm, the original content of a database page is copied <em class="ny">before</em> modification. This way, if the transaction fails or if you so desire, you can always go back to the journal to restore the database to its original state. This is great for reproducibility, but bad for concurrency. Copying an entire page in a database is slow and grabs the write lock, delaying any read operations.</p><p id="ce21" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">To fix this issue we can instead use <strong class="ne fr">write-ahead logging (WAL)</strong>. Rather than writing changes directly to the main database file, the changes are first recorded in a separate log file (the “write-ahead log”) before being applied to the database at regular intervals. Readers can still access the most recently committed write operations, as SQLite checks the WAL file in addition to the main database file on read. This separates write and read operations, easing concurrency issues that can come as a result of scaling.</p><p id="d599" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">To continue our analogy, write-ahead logging is like grabbing a post-it-note every time a change to the shared notebook needs to occur. If anyone wants to read a section of the notebook, they can check if there are any post-its attached to that section to get the latest updates. You can have many people simultaneously reading the notebook at the same time with this method. Once a lot of post-its start to accumulate, you can then edit the actual notebook itself, tossing the post-its once the edits have finished.</p><p id="4b10" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">These configuration options in SQLite have been around for decades (write-ahead-logging was introduced in 2010). Given this, why hasn’t SQLite been used in production for decades? That leads us to our next issue.</p><h1 id="ad3a" class="oi oj fq bf ok ol pj gq on oo pk gt oq or pl ot ou ov pm ox oy oz pn pb pc pd bk">Issue #2: Slow hardware</h1><p id="210c" class="pw-post-body-paragraph nc nd fq ne b go po ng nh gr pp nj nk nl pq nn no np pr nr ns nt ps nv nw nx fj bk">Hard disk drives (HDD) are notoriously slow compared to solid state drives (SSD) on a variety of operations that are important to database management. For example, SSDs are about 100 times faster than HDDs when it comes to latency (time it takes for a single I/O operation). In random I/O operations per second (IOPS), SSDs are about 50–1000 times faster than HDDs. SSDs are so much faster than HDDs because of the lack of moving parts. HDDs use spinning disks and moving parts to read and write data, much like an old turntable, whereas SDDs use only electronic components, much like a giant USB stick.</p><p id="c998" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Despite their inferiority, HDDs have historically dominated the storage market primarily due to low cost. However, SDDs have quickly been catching up. In 2011, SSDs were roughly 32 times more expensive per GB than HDDs (<a class="af nz" href="https://www.tomshardware.com/news/ssd-hdd-solid-state-drive-hard-disk-drive-prices%2C14336.html?utm_source=chatgpt.com" rel="noopener ugc nofollow" target="_blank">source</a>). By 2023, the price gap narrowed, with SSDs now being about 3 to 5 times more expensive per GB compared to HDDs (<a class="af nz" href="https://darwinsdata.com/how-much-does-ssd-cost-per-gb-vs-hdd/?utm_source=chatgpt.com" rel="noopener ugc nofollow" target="_blank">source</a>). In the past year, SSD prices have increased due to cuts from manufacturers like Samsung and increasing demand in data centers. In the long run however, we can expect SSDs to continue to decrease in price. Even if parity is never reached with HDDs, the low absolute price is enough to ensure widespread adoption. In 2020, SSDs outsold HDDs, with 333 million units shipped compared to 260 million HDDs, marking a turning point in the storage market (<a class="af nz" href="https://www.pcgamer.com/fun-fact-ssds-outsold-hdds-last-year-but-not-in-total-capacity/?utm_source=chatgpt.com" rel="noopener ugc nofollow" target="_blank">source</a>).</p><p id="1891" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">As of December 2024, you can rent a dedicated vCPU with 80 GB of SSD storage for about $16 USD per month on a service like <a class="af nz" href="https://www.hetzner.com/cloud" rel="noopener ugc nofollow" target="_blank">Hetzner</a>. 240 GB can be had for about $61. You can get even cheaper prices with a shared vCPU. For many smaller applications this storage is more than enough. The use of cheap SSDs has removed a significant bottleneck when using SQLite in production-grade web applications. But there is still one more important issue to deal with.</p><h1 id="01eb" class="oi oj fq bf ok ol pj gq on oo pk gt oq or pl ot ou ov pm ox oy oz pn pb pc pd bk">Issue #3: Backups</h1><p id="eb18" class="pw-post-body-paragraph nc nd fq ne b go po ng nh gr pp nj nk nl pq nn no np pr nr ns nt ps nv nw nx fj bk">It goes without saying that having a backup to your database is critical in production. The last thing any startup wants is to have their primary database get corrupted and all user data lost.</p><p id="ea05" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">The first option for creating a backup is the simplest. Since the SQLite database is just a file, you can essentially copy and paste your database into a folder on your computer, or upload it to a cloud service like AWS S3 buckets for more reliability. For small databases with infrequent writes this is a great option. As a simple example (taken from the <a class="af nz" href="https://litestream.io/alternatives/cron/" rel="noopener ugc nofollow" target="_blank">Litestream docs</a>), here is a bash script creating a backup:</p><pre class="mm mn mo mp mq px pw py bp pz bb bk"><span id="90de" class="qa oj fq pw b bg qb qc l qd qe">#!/bin/bash<br/><br/># Ensure script stops when commands fail.<br/>set -e<br/><br/># Backup our database to the temp directory.<br/>sqlite3 /path/to/db "VACUUM INTO '/path/to/backup'"<br/><br/># Compress the backup file for more efficient storage<br/>gzip /tmp/db<br/><br/># Upload backup to S3 using a rolling daily naming scheme.<br/>aws s3 cp /tmp/db.gz s3://mybucket/db-`date +%d`.gz</span></pre><p id="f2a7" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">A few notes:</p><ul class=""><li id="4f5f" class="nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx qf qg qh bk">The <code class="cx pt pu pv pw b">-e</code> option in<code class="cx pt pu pv pw b">set -e</code> stands for “exit immediately”. This makes sure that the script will be stopped if any command fails.</li><li id="bf2d" class="nc nd fq ne b go qi ng nh gr qj nj nk nl qk nn no np ql nr ns nt qm nv nw nx qf qg qh bk">SQLite’s <code class="cx pt pu pv pw b">VACUUM INTO</code> command creates a compact backup of the SQLite database. It reduces fragmentation in the database and the file size. Think of it as a neat and tidy version of your database. However you don’t have to use <code class="cx pt pu pv pw b">VACUUM INTO</code> ; you can replace it with <code class="cx pt pu pv pw b">.backup</code> . This copies the entire database file, including all its data and structure as-is to another file.</li><li id="5618" class="nc nd fq ne b go qi ng nh gr qj nj nk nl qk nn no np ql nr ns nt qm nv nw nx qf qg qh bk">SQLite databases compress well, and the <code class="cx pt pu pv pw b">gzip</code> command facilitates this.</li><li id="7a3f" class="nc nd fq ne b go qi ng nh gr qj nj nk nl qk nn no np ql nr ns nt qm nv nw nx qf qg qh bk">Finally, you can upload the copy of the file to your cloud storage provider of choice. Here we are uploading to S3.</li></ul><p id="d931" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">If you want to have your backups run automatically, you can configure <code class="cx pt pu pv pw b">crontab</code> to run this job on a regular basis. Here we are running the script daily at midnight:</p><pre class="mm mn mo mp mq px pw py bp pz bb bk"><span id="7430" class="qa oj fq pw b bg qb qc l qd qe"># Edit your cron jobs<br/>crontab -e<br/><br/># Add this to the end of the crontab<br/>0 0 * * * /path/to/my_backup_script.sh</span></pre><p id="9896" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">For write-heavy databases, where you would want to capture the state of the database at any given moment, you can use <a class="af nz" href="https://litestream.io/alternatives/cron/" rel="noopener ugc nofollow" target="_blank">Litestream</a>. This is an open-source tool designed to provide <em class="ny">real-time replication</em> for SQLite databases by streaming changes to a remote storage backend.</p><p id="f775" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Litestream is able to track changes to SQLite’s WAL file. Remember the post-it notes? Whenever a new transaction is recorded to the WAL file, Litestream is able to replicate these incrementally to your cloud storage provider of choice. This allows us to maintain a near real-time backup of the database without creating full copies each time.</p><p id="cca6" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">To get started with Litestream, you first have to install it. On MacOS this means using Homebrew. Then, you need to setup a <code class="cx pt pu pv pw b">litestream.yml</code> configuration file:</p><pre class="mm mn mo mp mq px pw py bp pz bb bk"><span id="b72e" class="qa oj fq pw b bg qb qc l qd qe"># /etc/litestream.yml<br/>dbs:<br/>  - path: /path/to/your.db<br/>    replicas:<br/>      - type: s3<br/>        bucket: your-s3-bucket-name<br/>        path: your-database-name<br/>        region: your-region</span></pre><p id="0a96" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Here, we are going to be streaming transactions to our database to an S3 bucket. Then we can run the following command to begin replication:</p><pre class="mm mn mo mp mq px pw py bp pz bb bk"><span id="a5e0" class="qa oj fq pw b bg qb qc l qd qe">litestream replicate -config /etc/litestream.yml</span></pre><p id="8486" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">In this case, we are setting any transactions in <code class="cx pt pu pv pw b">your.db</code> to be replicated in an S3 bucket. That’s it! You are then able to restore a SQLite database to any previous state by replaying WAL changes. As an example, if you want to create a copy of your db called <code class="cx pt pu pv pw b">restored.db</code> from a timestamp of 15:00 UTC dated 2024–12–10, you can run the following command:</p><pre class="mm mn mo mp mq px pw py bp pz bb bk"><span id="cc72" class="qa oj fq pw b bg qb qc l qd qe">litestream restore -o /path/to/restored.db \<br/>  -timestamp "2024-12-10T15:00:00Z" \<br/>  s3://your-s3-bucket-name/your-database-name</span></pre><p id="e92d" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">To get a backup of the latest version of your database, just omit the <code class="cx pt pu pv pw b">-timestamp flag</code> .</p><h1 id="c766" class="oi oj fq bf ok ol pj gq on oo pk gt oq or pl ot ou ov pm ox oy oz pn pb pc pd bk">Conclusion</h1><p id="61fb" class="pw-post-body-paragraph nc nd fq ne b go po ng nh gr pp nj nk nl pq nn no np pr nr ns nt ps nv nw nx fj bk">I encourage you to watch this recent <a class="af nz" href="https://www.youtube.com/watch?v=wFUy120Fts8" rel="noopener ugc nofollow" target="_blank">talk at Rails World 2024</a> to see how SQLite is rapidly becoming production-ready for modern web apps. They have implemented some of the changes we have discussed here to their SQLite adapter. I also recommend reading <a class="af nz" href="https://fractaledmind.github.io/2024/04/15/sqlite-on-rails-the-how-and-why-of-optimal-performance/" rel="noopener ugc nofollow" target="_blank">Stephen Margheim’s article</a> detailing his work on SQLite in Rails if you want to dive deeper. You better believe these sorts of improvement are coming soon to <a class="af nz" href="https://gcollazo.com/optimal-sqlite-settings-for-django/" rel="noopener ugc nofollow" target="_blank">Django</a>, <a class="af nz" href="https://laravel-news.com/optimize-db-for-laravel-sqlite" rel="noopener ugc nofollow" target="_blank">Laravel</a>, etc.</p><p id="c2d3" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">The improvements to SQLite for production are not finished. David Heinemeier Hansson, creator of Rails, wants to push SQLite to be able to run a mid-size SaaS company off of. Exciting times!</p><figure class="mm mn mo mp mq mr"><div class="qn io l ed"><div class="qo qp l"/></div></figure></div></div></div></div>    
</body>
</html>