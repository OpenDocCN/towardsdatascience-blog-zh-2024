<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>How to Tackle an Optimization Problem with Constraint Programming</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>How to Tackle an Optimization Problem with Constraint Programming</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/how-to-tackle-an-optimization-problem-with-constraint-programming-9ae77b4d803d?source=collection_archive---------2-----------------------#2024-12-23">https://towardsdatascience.com/how-to-tackle-an-optimization-problem-with-constraint-programming-9ae77b4d803d?source=collection_archive---------2-----------------------#2024-12-23</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="4758" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx">Case study: the travelling salesman problem</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hd he hf hg hh ab"><div><div class="ab hi"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@yangeorget?source=post_page---byline--9ae77b4d803d--------------------------------" rel="noopener follow"><div class="l hj hk by hl hm"><div class="l ed"><img alt="Yan Georget" class="l ep by dd de cx" src="../Images/4555bf99c8c71f6a3c905e828819c599.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/0*kFb70RVej7xc7IDa.JPG"/><div class="hn by l dd de em n ho eo"/></div></div></a></div></div><div class="hp ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--9ae77b4d803d--------------------------------" rel="noopener follow"><div class="l hq hr by hl hs"><div class="l ed"><img alt="Towards Data Science" class="l ep by br ht cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hn by l br ht em n ho eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hu ab q"><div class="ab q hv"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hw hx bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hy" data-testid="authorName" href="https://medium.com/@yangeorget?source=post_page---byline--9ae77b4d803d--------------------------------" rel="noopener follow">Yan Georget</a></p></div></div></div><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hw hx dx"><button class="ib ic ah ai aj ak al am an ao ap aq ar id ie if" disabled="">Follow</button></p></div></div></span></div></div><div class="l ig"><span class="bf b bg z dx"><div class="ab cn ih ii ij"><div class="ik il ab"><div class="bf b bg z dx ab im"><span class="in l ig">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hy ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--9ae77b4d803d--------------------------------" rel="noopener follow"><p class="bf b bg z io ip iq ir is it iu iv bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">8 min read</span><div class="iw ix l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Dec 23, 2024</span></div></span></div></span></div></div></div><div class="ab cp iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn"><div class="h k w ea eb q"><div class="kd l"><div class="ab q ke kf"><div class="pw-multi-vote-icon ed in kg kh ki"><div class=""><div class="kj kk kl km kn ko kp am kq kr ks ki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kt ku kv kw kx ky kz"><p class="bf b dy z dx"><span class="kk">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kj la lb ab q ee lc ld" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="le"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg></button></div></div></div><div class="ab q jo jp jq jr js jt ju jv jw jx jy jz ka kb kc"><div class="lf k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lg an ao ap id lh li lj" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep lk cn"><div class="l ae"><div class="ab cb"><div class="ll lm ln lo lp lq ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lg an ao ap id lr ls ld lt lu lv lw lx s ly lz ma mb mc md me u mf mg mh"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lg an ao ap id lr ls ld lt lu lv lw lx s ly lz ma mb mc md me u mf mg mh"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lg an ao ap id lr ls ld lt lu lv lw lx s ly lz ma mb mc md me u mf mg mh"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><h1 id="9344" class="mi mj fq bf mk ml mm gq mn mo mp gt mq mr ms mt mu mv mw mx my mz na nb nc nd bk">TLDR</h1><p id="e744" class="pw-post-body-paragraph ne nf fq ng b go nh ni nj gr nk nl nm nn no np nq nr ns nt nu nv nw nx ny nz fj bk">Constraint Programming is a technique of choice for solving a Constraint Satisfaction Problem. In this article, we will see that it is also well suited to small to medium optimization problems. Using the well-known <a class="af oa" href="https://en.wikipedia.org/wiki/Travelling_salesman_problem" rel="noopener ugc nofollow" target="_blank">travelling salesman problem</a> (TSP) as an example, we will detail all the steps leading to an efficient model.</p><p id="2006" class="pw-post-body-paragraph ne nf fq ng b go ob ni nj gr oc nl nm nn od np nq nr oe nt nu nv of nx ny nz fj bk">For the sake of simplicity, we will consider the symmetric case of the TSP (the distance between two cities is the same in each opposite direction).</p><p id="f78e" class="pw-post-body-paragraph ne nf fq ng b go ob ni nj gr oc nl nm nn od np nq nr oe nt nu nv of nx ny nz fj bk">All the code examples in this article use <a class="af oa" href="https://github.com/yangeorget/nucs" rel="noopener ugc nofollow" target="_blank">NuCS</a>, a fast constraint solver written 100% in Python that I am currently developing as a side project. NuCS is released under the <a class="af oa" href="https://github.com/yangeorget/nucs/blob/main/LICENSE.md" rel="noopener ugc nofollow" target="_blank">MIT license</a>.</p><h1 id="759b" class="mi mj fq bf mk ml mm gq mn mo mp gt mq mr ms mt mu mv mw mx my mz na nb nc nd bk">The symmetric travelling salesman problem</h1><p id="b217" class="pw-post-body-paragraph ne nf fq ng b go nh ni nj gr nk nl nm nn no np nq nr ns nt nu nv nw nx ny nz fj bk">Quoting Wikipedia :</p><blockquote class="og oh oi"><p id="e81f" class="ne nf oj ng b go ob ni nj gr oc nl nm nn od np nq nr oe nt nu nv of nx ny nz fj bk">Given a list of cities and the distances between each pair of cities, what is the shortest possible route that visits each city exactly once and returns to the origin city?</p></blockquote><figure class="on oo op oq or os ok ol paragraph-image"><div class="ok ol om"><img src="../Images/bba1920404a4386283a19f8b2e1fd05f.png" data-original-src="https://miro.medium.com/v2/resize:fit:652/format:webp/1*Pz7zPn1AQl5qp0iglo60DA.png"/></div><figcaption class="ou ov ow ok ol ox oy bf b bg z dx"><a class="af oa" href="https://fr.wikipedia.org/wiki/Probl%C3%A8me_du_voyageur_de_commerce#/media/Fichier:TSP_Deutschland_3.png" rel="noopener ugc nofollow" target="_blank">Source: Wikipedia</a></figcaption></figure><p id="a89e" class="pw-post-body-paragraph ne nf fq ng b go ob ni nj gr oc nl nm nn od np nq nr oe nt nu nv of nx ny nz fj bk">This is an NP-hard problem. From now on, let’s consider that there are <em class="oj">n</em> cities.</p><p id="3fe3" class="pw-post-body-paragraph ne nf fq ng b go ob ni nj gr oc nl nm nn od np nq nr oe nt nu nv of nx ny nz fj bk">The most naive formulation of this problem is to decide, for each possible edge between cities, whether it belongs to the optimal solution. The size of the search space is <strong class="ng fr"><em class="oj">2ⁿ⁽ⁿ⁻¹⁾</em>ᐟ²</strong> which is roughly <em class="oj">8.8e130 </em>for <em class="oj">n=30</em> (much greater than the number of atoms in the universe).</p><p id="dd18" class="pw-post-body-paragraph ne nf fq ng b go ob ni nj gr oc nl nm nn od np nq nr oe nt nu nv of nx ny nz fj bk">It is much better to find, for each city, its successor. The complexity becomes <strong class="ng fr"><em class="oj">n!</em></strong><em class="oj"> </em>which is roughly <em class="oj">2.6e32 </em>for <em class="oj">n=30</em> (much smaller but still very large).</p><p id="528d" class="pw-post-body-paragraph ne nf fq ng b go ob ni nj gr oc nl nm nn od np nq nr oe nt nu nv of nx ny nz fj bk">In the following, we will benchmark our models with the following small TSP instances: <a class="af oa" href="https://github.com/yangeorget/nucs/blob/main/nucs/examples/tsp/tsp_instances.py" rel="noopener ugc nofollow" target="_blank">GR17, GR21 and GR24</a>.</p><p id="fac8" class="pw-post-body-paragraph ne nf fq ng b go ob ni nj gr oc nl nm nn od np nq nr oe nt nu nv of nx ny nz fj bk">GR17 is a <em class="oj">17</em> nodes symmetrical TSP, its costs are defined by <em class="oj">17 x 17</em> symmetrical matrix of successor costs:</p><pre class="on oo op oq or oz pa pb bp pc bb bk"><span id="644c" class="pd mj fq pa b bg pe pf l pg ph">[<br/>    [0, 633, 257, 91, 412, 150, 80, 134, 259, 505, 353, 324, 70, 211, 268, 246, 121],<br/>    [633, 0, 390, 661, 227, 488, 572, 530, 555, 289, 282, 638, 567, 466, 420, 745, 518],<br/>    [257, 390, 0, 228, 169, 112, 196, 154, 372, 262, 110, 437, 191, 74, 53, 472, 142],<br/>    [91, 661, 228, 0, 383, 120, 77, 105, 175, 476, 324, 240, 27, 182, 239, 237, 84],<br/>    [412, 227, 169, 383, 0, 267, 351, 309, 338, 196, 61, 421, 346, 243, 199, 528, 297],<br/>    [150, 488, 112, 120, 267, 0, 63, 34, 264, 360, 208, 329, 83, 105, 123, 364, 35],<br/>    [80, 572, 196, 77, 351, 63, 0, 29, 232, 444, 292, 297, 47, 150, 207, 332, 29],<br/>    [134, 530, 154, 105, 309, 34, 29, 0, 249, 402, 250, 314, 68, 108, 165, 349, 36],<br/>    [259, 555, 372, 175, 338, 264, 232, 249, 0, 495, 352, 95, 189, 326, 383, 202, 236],<br/>    [505, 289, 262, 476, 196, 360, 444, 402, 495, 0, 154, 578, 439, 336, 240, 685, 390],<br/>    [353, 282, 110, 324, 61, 208, 292, 250, 352, 154, 0, 435, 287, 184, 140, 542, 238],<br/>    [324, 638, 437, 240, 421, 329, 297, 314, 95, 578, 435, 0, 254, 391, 448, 157, 301],<br/>    [70, 567, 191, 27, 346, 83, 47, 68, 189, 439, 287, 254, 0, 145, 202, 289, 55],<br/>    [211, 466, 74, 182, 243, 105, 150, 108, 326, 336, 184, 391, 145, 0, 57, 426, 96],<br/>    [268, 420, 53, 239, 199, 123, 207, 165, 383, 240, 140, 448, 202, 57, 0, 483, 153],<br/>    [246, 745, 472, 237, 528, 364, 332, 349, 202, 685, 542, 157, 289, 426, 483, 0, 336],<br/>    [121, 518, 142, 84, 297, 35, 29, 36, 236, 390, 238, 301, 55, 96, 153, 336, 0],<br/>]</span></pre><p id="cc61" class="pw-post-body-paragraph ne nf fq ng b go ob ni nj gr oc nl nm nn od np nq nr oe nt nu nv of nx ny nz fj bk">Let's have a look at the first row:</p><p id="47e8" class="pw-post-body-paragraph ne nf fq ng b go ob ni nj gr oc nl nm nn od np nq nr oe nt nu nv of nx ny nz fj bk"><em class="oj">[0, 633, 257, 91, 412, 150, 80, 134, 259, 505, 353, 324, 70, 211, 268, 246, 121]</em></p><p id="9d33" class="pw-post-body-paragraph ne nf fq ng b go ob ni nj gr oc nl nm nn od np nq nr oe nt nu nv of nx ny nz fj bk">These are the costs for the possible successors of node <em class="oj">0</em> in the circuit. If we except the first value <em class="oj">0</em> (we don't want the successor of node <em class="oj">0</em> to be node <em class="oj">0</em>) then the minimal value is <em class="oj">70</em> (when node <em class="oj">12</em> is the successor of node 0) and the maximal is <em class="oj">633</em> (when node <em class="oj">1</em> is the successor of node <em class="oj">0</em>). This means that the cost associated to the successor of node <em class="oj">0</em> in the circuit ranges between <em class="oj">70</em> and <em class="oj">633</em>.</p><h1 id="bcc0" class="mi mj fq bf mk ml mm gq mn mo mp gt mq mr ms mt mu mv mw mx my mz na nb nc nd bk">Modeling the TSP</h1><p id="6748" class="pw-post-body-paragraph ne nf fq ng b go nh ni nj gr nk nl nm nn no np nq nr ns nt nu nv nw nx ny nz fj bk">We are going to model our problem by reusing the <a class="af oa" href="https://github.com/yangeorget/nucs/blob/main/nucs/problems/circuit_problem.py" rel="noopener ugc nofollow" target="_blank"><strong class="ng fr">CircuitProblem</strong></a> provided off-the-shelf in NuCS. But let's first understand what happens behind the scene. The <strong class="ng fr">CircuitProblem </strong>is itself a subclass of the <a class="af oa" href="https://github.com/yangeorget/nucs/blob/main/nucs/problems/permutation_problem.py" rel="noopener ugc nofollow" target="_blank"><strong class="ng fr">Permutation</strong></a> problem, another off-the-shelf model offered by NuCS.</p><h2 id="90da" class="pi mj fq bf mk pj pk pl mn pm pn po mq nn pp pq pr nr ps pt pu nv pv pw px py bk">The permutation problem</h2><p id="7945" class="pw-post-body-paragraph ne nf fq ng b go nh ni nj gr nk nl nm nn no np nq nr ns nt nu nv nw nx ny nz fj bk">The permutation problem defines two redundant models: the successors and predecessors models.</p><pre class="on oo op oq or oz pa pb bp pc bb bk"><span id="c04a" class="pd mj fq pa b bg pe pf l pg ph">    def __init__(self, n: int):<br/>        """<br/>        Inits the permutation problem.<br/>        :param n: the number variables/values<br/>        """<br/>        self.n = n<br/>        shr_domains = [(0, n - 1)] * 2 * n<br/>        super().__init__(shr_domains)<br/>        self.add_propagator((list(range(n)), ALG_ALLDIFFERENT, []))<br/>        self.add_propagator((list(range(n, 2 * n)), ALG_ALLDIFFERENT, []))<br/>        for i in range(n):<br/>            self.add_propagator((list(range(n)) + [n + i], ALG_PERMUTATION_AUX, [i]))<br/>            self.add_propagator((list(range(n, 2 * n)) + [i], ALG_PERMUTATION_AUX, [i]))</span></pre><p id="3960" class="pw-post-body-paragraph ne nf fq ng b go ob ni nj gr oc nl nm nn od np nq nr oe nt nu nv of nx ny nz fj bk">The successors model (the first n variables) defines, for each node, its successor in the circuit. The successors have to be different. The predecessors model (the last n variables) defines, for each node, its predecessor in the circuit. The predecessors have to be different.</p><p id="791f" class="pw-post-body-paragraph ne nf fq ng b go ob ni nj gr oc nl nm nn od np nq nr oe nt nu nv of nx ny nz fj bk">Both models are connected with the rules (see the <em class="oj">ALG_PERMUTATION_AUX</em> constraints):</p><ul class=""><li id="633d" class="ne nf fq ng b go ob ni nj gr oc nl nm nn od np nq nr oe nt nu nv of nx ny nz pz qa qb bk">if <em class="oj">succ[i] = j</em> then <em class="oj">pred[j] = i</em></li><li id="78ee" class="ne nf fq ng b go qc ni nj gr qd nl nm nn qe np nq nr qf nt nu nv qg nx ny nz pz qa qb bk">if <em class="oj">pred[j] = i </em>then <em class="oj">succ[i] = j</em></li><li id="abc8" class="ne nf fq ng b go qc ni nj gr qd nl nm nn qe np nq nr qf nt nu nv qg nx ny nz pz qa qb bk">if <em class="oj">pred[j] ≠ i </em>then <em class="oj">succ[i] ≠ j</em></li><li id="435b" class="ne nf fq ng b go qc ni nj gr qd nl nm nn qe np nq nr qf nt nu nv qg nx ny nz pz qa qb bk">if <em class="oj">succ[i] ≠ j</em> then <em class="oj">pred[j] ≠ i</em></li></ul><h2 id="5ddf" class="pi mj fq bf mk pj pk pl mn pm pn po mq nn pp pq pr nr ps pt pu nv pv pw px py bk">The circuit problem</h2><p id="196c" class="pw-post-body-paragraph ne nf fq ng b go nh ni nj gr nk nl nm nn no np nq nr ns nt nu nv nw nx ny nz fj bk">The circuit problem refines the domains of the successors and predecessors and adds additional constraints for forbidding sub-cycles (we won't go into them here for the sake of brevity).</p><pre class="on oo op oq or oz pa pb bp pc bb bk"><span id="a101" class="pd mj fq pa b bg pe pf l pg ph">    def __init__(self, n: int):<br/>        """<br/>        Inits the circuit problem.<br/>        :param n: the number of vertices<br/>        """<br/>        self.n = n<br/>        super().__init__(n)<br/>        self.shr_domains_lst[0] = [1, n - 1]<br/>        self.shr_domains_lst[n - 1] = [0, n - 2]<br/>        self.shr_domains_lst[n] = [1, n - 1]<br/>        self.shr_domains_lst[2 * n - 1] = [0, n - 2]<br/>        self.add_propagator((list(range(n)), ALG_NO_SUB_CYCLE, []))<br/>        self.add_propagator((list(range(n, 2 * n)), ALG_NO_SUB_CYCLE, []))</span></pre><h2 id="97d2" class="pi mj fq bf mk pj pk pl mn pm pn po mq nn pp pq pr nr ps pt pu nv pv pw px py bk">The TSP model</h2><p id="26bd" class="pw-post-body-paragraph ne nf fq ng b go nh ni nj gr nk nl nm nn no np nq nr ns nt nu nv nw nx ny nz fj bk">With the help of the circuit problem, modelling the TSP is an easy task.</p><p id="d898" class="pw-post-body-paragraph ne nf fq ng b go ob ni nj gr oc nl nm nn od np nq nr oe nt nu nv of nx ny nz fj bk">Let's consider a node <em class="oj">i</em>, as seen before <em class="oj">costs[i]</em> is the list of possible costs for the successors of <em class="oj">i</em>. If j is the successor of <em class="oj">i</em> then the associated cost is <em class="oj">costs[i]ⱼ</em>. This is implemented by the following line where <em class="oj">succ_costs</em> if the starting index of the successors costs:</p><pre class="on oo op oq or oz pa pb bp pc bb bk"><span id="e190" class="pd mj fq pa b bg pe pf l pg ph">self.add_propagators([([i, self.succ_costs + i], ALG_ELEMENT_IV, costs[i]) for i in range(n)])</span></pre><p id="8c22" class="pw-post-body-paragraph ne nf fq ng b go ob ni nj gr oc nl nm nn od np nq nr oe nt nu nv of nx ny nz fj bk">Symmetrically, for the predecessors costs we get:</p><pre class="on oo op oq or oz pa pb bp pc bb bk"><span id="78ab" class="pd mj fq pa b bg pe pf l pg ph">self.add_propagators([([n + i, self.pred_costs + i], ALG_ELEMENT_IV, costs[i]) for i in range(n)])</span></pre><p id="db01" class="pw-post-body-paragraph ne nf fq ng b go ob ni nj gr oc nl nm nn od np nq nr oe nt nu nv of nx ny nz fj bk">Finally, we can define the total cost by summing the intermediate costs and we get:</p><pre class="on oo op oq or oz pa pb bp pc bb bk"><span id="caf8" class="pd mj fq pa b bg pe pf l pg ph">    def __init__(self, costs: List[List[int]]) -&gt; None:<br/>        """<br/>        Inits the problem.<br/>        :param costs: the costs between vertices as a list of lists of integers<br/>        """<br/>        n = len(costs)<br/>        super().__init__(n)<br/>        max_costs = [max(cost_row) for cost_row in costs]<br/>        min_costs = [min([cost for cost in cost_row if cost &gt; 0]) for cost_row in costs]<br/>        self.succ_costs = self.add_variables([(min_costs[i], max_costs[i]) for i in range(n)])<br/>        self.pred_costs = self.add_variables([(min_costs[i], max_costs[i]) for i in range(n)])<br/>        self.total_cost = self.add_variable((sum(min_costs), sum(max_costs)))  # the total cost<br/>        self.add_propagators([([i, self.succ_costs + i], ALG_ELEMENT_IV, costs[i]) for i in range(n)])<br/>        self.add_propagators([([n + i, self.pred_costs + i], ALG_ELEMENT_IV, costs[i]) for i in range(n)])<br/>        self.add_propagator(<br/>            (list(range(self.succ_costs, self.succ_costs + n)) + [self.total_cost], ALG_AFFINE_EQ, [1] * n + [-1, 0])<br/>        )<br/>        self.add_propagator(<br/>            (list(range(self.pred_costs, self.pred_costs + n)) + [self.total_cost], ALG_AFFINE_EQ, [1] * n + [-1, 0])<br/>        )</span></pre><p id="1b03" class="pw-post-body-paragraph ne nf fq ng b go ob ni nj gr oc nl nm nn od np nq nr oe nt nu nv of nx ny nz fj bk">Note that it is not necessary to have both successors and predecessors models (one would suffice) but it is more efficient.</p><h1 id="3075" class="mi mj fq bf mk ml mm gq mn mo mp gt mq mr ms mt mu mv mw mx my mz na nb nc nd bk">Branching</h1><p id="98a4" class="pw-post-body-paragraph ne nf fq ng b go nh ni nj gr nk nl nm nn no np nq nr ns nt nu nv nw nx ny nz fj bk">Let's use the default branching strategy of the <strong class="ng fr">BacktrackSolver</strong>, our decision variables will be the successors and predecessors.</p><pre class="on oo op oq or oz pa pb bp pc bb bk"><span id="5762" class="pd mj fq pa b bg pe pf l pg ph">solver = BacktrackSolver(problem, decision_domains=decision_domains)<br/>solution = solver.minimize(problem.total_cost)</span></pre><p id="5099" class="pw-post-body-paragraph ne nf fq ng b go ob ni nj gr oc nl nm nn od np nq nr oe nt nu nv of nx ny nz fj bk">The optimal solution is found in <strong class="ng fr">248s</strong> on a MacBook Pro M2 running Python 3.12, Numpy 2.0.1, Numba 0.60.0 and NuCS 4.2.0. The detailed statistics provided by NuCS are:</p><pre class="on oo op oq or oz pa pb bp pc bb bk"><span id="7f35" class="pd mj fq pa b bg pe pf l pg ph">{<br/>    'ALG_BC_NB': 16141979,<br/>    'ALG_BC_WITH_SHAVING_NB': 0,<br/>    'ALG_SHAVING_NB': 0,<br/>    'ALG_SHAVING_CHANGE_NB': 0,<br/>    'ALG_SHAVING_NO_CHANGE_NB': 0,<br/>    'PROPAGATOR_ENTAILMENT_NB': 136986225,<br/>    'PROPAGATOR_FILTER_NB': 913725313,<br/>    'PROPAGATOR_FILTER_NO_CHANGE_NB': 510038945,<br/>    'PROPAGATOR_INCONSISTENCY_NB': 8070394,<br/>    'SOLVER_BACKTRACK_NB': 8070393,<br/>    'SOLVER_CHOICE_NB': 8071487,<br/>    'SOLVER_CHOICE_DEPTH': 15,<br/>    'SOLVER_SOLUTION_NB': 98<br/>}</span></pre><p id="736f" class="pw-post-body-paragraph ne nf fq ng b go ob ni nj gr oc nl nm nn od np nq nr oe nt nu nv of nx ny nz fj bk">In particular, there are 8 070 393 backtracks. Let's try to improve on this.</p><p id="a10c" class="pw-post-body-paragraph ne nf fq ng b go ob ni nj gr oc nl nm nn od np nq nr oe nt nu nv of nx ny nz fj bk">NuCS offers a heuristic based on regret (difference between best and second best costs) for selecting the variable. We will then choose the value that minimizes the cost.</p><pre class="on oo op oq or oz pa pb bp pc bb bk"><span id="477e" class="pd mj fq pa b bg pe pf l pg ph">solver = BacktrackSolver(<br/>  problem, <br/>  decision_domains=decision_domains,<br/>  var_heuristic_idx=VAR_HEURISTIC_MAX_REGRET,<br/>  var_heuristic_params=costs,<br/>  dom_heuristic_idx=DOM_HEURISTIC_MIN_COST,<br/>  dom_heuristic_params=costs<br/>)<br/>solution = solver.minimize(problem.total_cost)</span></pre><p id="8a27" class="pw-post-body-paragraph ne nf fq ng b go ob ni nj gr oc nl nm nn od np nq nr oe nt nu nv of nx ny nz fj bk">With these new heuristics, the optimal solution is found in <strong class="ng fr">38s</strong> and the statistics are:</p><pre class="on oo op oq or oz pa pb bp pc bb bk"><span id="c0e6" class="pd mj fq pa b bg pe pf l pg ph">{<br/>    'ALG_BC_NB': 2673045,<br/>    'ALG_BC_WITH_SHAVING_NB': 0,<br/>    'ALG_SHAVING_NB': 0,<br/>    'ALG_SHAVING_CHANGE_NB': 0,<br/>    'ALG_SHAVING_NO_CHANGE_NB': 0,<br/>    'PROPAGATOR_ENTAILMENT_NB': 12295905,<br/>    'PROPAGATOR_FILTER_NB': 125363225,<br/>    'PROPAGATOR_FILTER_NO_CHANGE_NB': 69928021,<br/>    'PROPAGATOR_INCONSISTENCY_NB': 1647125,<br/>    'SOLVER_BACKTRACK_NB': 1647124,<br/>    'SOLVER_CHOICE_NB': 1025875,<br/>    'SOLVER_CHOICE_DEPTH': 36,<br/>    'SOLVER_SOLUTION_NB': 45<br/>}</span></pre><p id="bdf6" class="pw-post-body-paragraph ne nf fq ng b go ob ni nj gr oc nl nm nn od np nq nr oe nt nu nv of nx ny nz fj bk">In particular, there are 1 647 124 backtracks.</p><p id="7895" class="pw-post-body-paragraph ne nf fq ng b go ob ni nj gr oc nl nm nn od np nq nr oe nt nu nv of nx ny nz fj bk">We can keep improving by designing a <a class="af oa" href="https://github.com/yangeorget/nucs/blob/main/nucs/examples/tsp/tsp_var_heuristic.py" rel="noopener ugc nofollow" target="_blank">custom heuristic</a> which combines max regret and smallest domain for variable selection.</p><pre class="on oo op oq or oz pa pb bp pc bb bk"><span id="240b" class="pd mj fq pa b bg pe pf l pg ph">tsp_var_heuristic_idx = register_var_heuristic(tsp_var_heuristic)<br/>solver = BacktrackSolver(<br/>  problem, <br/>  decision_domains=decision_domains,<br/>  var_heuristic_idx=tsp_var_heuristic_idx,<br/>  var_heuristic_params=costs,<br/>  dom_heuristic_idx=DOM_HEURISTIC_MIN_COST,<br/>  dom_heuristic_params=costs<br/>)<br/>solution = solver.minimize(problem.total_cost)</span></pre><p id="6e84" class="pw-post-body-paragraph ne nf fq ng b go ob ni nj gr oc nl nm nn od np nq nr oe nt nu nv of nx ny nz fj bk">The optimal solution is now found in <strong class="ng fr">11s</strong> and the statistics are:</p><pre class="on oo op oq or oz pa pb bp pc bb bk"><span id="9115" class="pd mj fq pa b bg pe pf l pg ph">{<br/>    'ALG_BC_NB': 660718,<br/>    'ALG_BC_WITH_SHAVING_NB': 0,<br/>    'ALG_SHAVING_NB': 0,<br/>    'ALG_SHAVING_CHANGE_NB': 0,<br/>    'ALG_SHAVING_NO_CHANGE_NB': 0,<br/>    'PROPAGATOR_ENTAILMENT_NB': 3596146,<br/>    'PROPAGATOR_FILTER_NB': 36847171,<br/>    'PROPAGATOR_FILTER_NO_CHANGE_NB': 20776276,<br/>    'PROPAGATOR_INCONSISTENCY_NB': 403024,<br/>    'SOLVER_BACKTRACK_NB': 403023,<br/>    'SOLVER_CHOICE_NB': 257642,<br/>    'SOLVER_CHOICE_DEPTH': 33,<br/>    'SOLVER_SOLUTION_NB': 52<br/>}</span></pre><p id="e04d" class="pw-post-body-paragraph ne nf fq ng b go ob ni nj gr oc nl nm nn od np nq nr oe nt nu nv of nx ny nz fj bk">In particular, there are 403 023 backtracks.</p><h1 id="0602" class="mi mj fq bf mk ml mm gq mn mo mp gt mq mr ms mt mu mv mw mx my mz na nb nc nd bk">How does minimization work BTW?</h1><p id="7f18" class="pw-post-body-paragraph ne nf fq ng b go nh ni nj gr nk nl nm nn no np nq nr ns nt nu nv nw nx ny nz fj bk">Minimization (and more generally optimization) relies on a <a class="af oa" href="https://en.wikipedia.org/wiki/Branch_and_bound" rel="noopener ugc nofollow" target="_blank">branch-and-bound</a> algorithm. The backtracking mechanism allows to explore the search space by making choices (<strong class="ng fr">branching</strong>). Parts of the search space are pruned by <strong class="ng fr">bounding</strong> the objective variable.</p><blockquote class="og oh oi"><p id="d21e" class="ne nf oj ng b go ob ni nj gr oc nl nm nn od np nq nr oe nt nu nv of nx ny nz fj bk">When minimizing a variable <em class="fq">t</em>, one can add the additional constraint t &lt; s whenever an intermediate solution s is found.</p></blockquote><p id="4b2f" class="pw-post-body-paragraph ne nf fq ng b go ob ni nj gr oc nl nm nn od np nq nr oe nt nu nv of nx ny nz fj bk">NuCS offer two optimization modes corresponding to two ways to leverage <em class="oj">t &lt; s</em>:</p><ul class=""><li id="6c86" class="ne nf fq ng b go ob ni nj gr oc nl nm nn od np nq nr oe nt nu nv of nx ny nz pz qa qb bk">the <strong class="ng fr">RESET</strong> mode restarts the search from scratch and updates the bounds of the target variable</li><li id="dcdb" class="ne nf fq ng b go qc ni nj gr qd nl nm nn qe np nq nr qf nt nu nv qg nx ny nz pz qa qb bk">the <strong class="ng fr">PRUNE</strong> mode modifies the choice points to take into account the new bounds of the target variable</li></ul><p id="387f" class="pw-post-body-paragraph ne nf fq ng b go ob ni nj gr oc nl nm nn od np nq nr oe nt nu nv of nx ny nz fj bk">Let's now try the <strong class="ng fr">PRUNE</strong> mode:</p><pre class="on oo op oq or oz pa pb bp pc bb bk"><span id="5f4e" class="pd mj fq pa b bg pe pf l pg ph">    solution = solver.minimize(problem.total_cost, mode=PRUNE)</span></pre><p id="bd2d" class="pw-post-body-paragraph ne nf fq ng b go ob ni nj gr oc nl nm nn od np nq nr oe nt nu nv of nx ny nz fj bk">The optimal solution is found in <strong class="ng fr">5.4s</strong> and the statistics are:</p><pre class="on oo op oq or oz pa pb bp pc bb bk"><span id="bc30" class="pd mj fq pa b bg pe pf l pg ph">{<br/>    'ALG_BC_NB': 255824,<br/>    'ALG_BC_WITH_SHAVING_NB': 0,<br/>    'ALG_SHAVING_NB': 0,<br/>    'ALG_SHAVING_CHANGE_NB': 0,<br/>    'ALG_SHAVING_NO_CHANGE_NB': 0,<br/>    'PROPAGATOR_ENTAILMENT_NB': 1435607,<br/>    'PROPAGATOR_FILTER_NB': 14624422,<br/>    'PROPAGATOR_FILTER_NO_CHANGE_NB': 8236378,<br/>    'PROPAGATOR_INCONSISTENCY_NB': 156628,<br/>    'SOLVER_BACKTRACK_NB': 156627,<br/>    'SOLVER_CHOICE_NB': 99143,<br/>    'SOLVER_CHOICE_DEPTH': 34,<br/>    'SOLVER_SOLUTION_NB': 53<br/>}</span></pre><p id="f155" class="pw-post-body-paragraph ne nf fq ng b go ob ni nj gr oc nl nm nn od np nq nr oe nt nu nv of nx ny nz fj bk">In particular, there are only 156 627 backtracks.</p><h1 id="f0ca" class="mi mj fq bf mk ml mm gq mn mo mp gt mq mr ms mt mu mv mw mx my mz na nb nc nd bk">Conclusion</h1><p id="8a19" class="pw-post-body-paragraph ne nf fq ng b go nh ni nj gr nk nl nm nn no np nq nr ns nt nu nv nw nx ny nz fj bk">The table below summarizes our experiments:</p><figure class="on oo op oq or os ok ol paragraph-image"><div class="ok ol qh"><img src="../Images/969261fc6190fbaebdcbfb1b1bcda6a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1344/format:webp/1*qjDQ3dn4BTBSKMZl0_vXzQ.png"/></div><figcaption class="ou ov ow ok ol ox oy bf b bg z dx">TSP experiments with NuCS</figcaption></figure><p id="454a" class="pw-post-body-paragraph ne nf fq ng b go ob ni nj gr oc nl nm nn od np nq nr oe nt nu nv of nx ny nz fj bk">You can find all the corresponding code <a class="af oa" href="https://github.com/yangeorget/nucs/tree/main/nucs/examples/tsp" rel="noopener ugc nofollow" target="_blank">here</a>.</p><p id="3367" class="pw-post-body-paragraph ne nf fq ng b go ob ni nj gr oc nl nm nn od np nq nr oe nt nu nv of nx ny nz fj bk">There are of course many other tracks that we could explore to improve these results:</p><ul class=""><li id="56c1" class="ne nf fq ng b go ob ni nj gr oc nl nm nn od np nq nr oe nt nu nv of nx ny nz pz qa qb bk">design a <a class="af oa" href="https://github.com/yangeorget/nucs/blob/main/nucs/examples/tsp/total_cost_propagator.py" rel="noopener ugc nofollow" target="_blank">redundant constraint</a> for the total cost</li><li id="d620" class="ne nf fq ng b go qc ni nj gr qd nl nm nn qe np nq nr qf nt nu nv qg nx ny nz pz qa qb bk">improve the branching by exploring new heuristics</li><li id="0f89" class="ne nf fq ng b go qc ni nj gr qd nl nm nn qe np nq nr qf nt nu nv qg nx ny nz pz qa qb bk">use a different consistency algorithm (NuCS comes with <em class="oj">shaving</em>)</li><li id="23e4" class="ne nf fq ng b go qc ni nj gr qd nl nm nn qe np nq nr qf nt nu nv qg nx ny nz pz qa qb bk">compute lower and upper bounds using other techniques</li></ul><p id="9371" class="pw-post-body-paragraph ne nf fq ng b go ob ni nj gr oc nl nm nn od np nq nr oe nt nu nv of nx ny nz fj bk">The travelling salesman problem has been the subject of extensive study and an abundant literature. In this article, we hope to have convinced the reader that it is possible to find optimal solutions to medium-sized problems in a very short time, without having much knowledge of the travelling salesman problem.</p></div></div></div><div class="ab cb qi qj qk ql" role="separator"><span class="qm by bm qn qo qp"/><span class="qm by bm qn qo qp"/><span class="qm by bm qn qo"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="47aa" class="pw-post-body-paragraph ne nf fq ng b go ob ni nj gr oc nl nm nn od np nq nr oe nt nu nv of nx ny nz fj bk">Some useful links to go further with NuCS:</p><ul class=""><li id="51b6" class="ne nf fq ng b go ob ni nj gr oc nl nm nn od np nq nr oe nt nu nv of nx ny nz pz qa qb bk">the source code: <a class="af oa" href="https://github.com/yangeorget/nucs" rel="noopener ugc nofollow" target="_blank">https://github.com/yangeorget/nucs</a></li><li id="373b" class="ne nf fq ng b go qc ni nj gr qd nl nm nn qe np nq nr qf nt nu nv qg nx ny nz pz qa qb bk">the documentation: <a class="af oa" href="https://nucs.readthedocs.io/en/latest/index.html" rel="noopener ugc nofollow" target="_blank">https://nucs.readthedocs.io/en/latest/index.html</a></li><li id="31c2" class="ne nf fq ng b go qc ni nj gr qd nl nm nn qe np nq nr qf nt nu nv qg nx ny nz pz qa qb bk">the Pip package: <a class="af oa" href="https://pypi.org/project/NUCS/" rel="noopener ugc nofollow" target="_blank">https://pypi.org/project/NUCS/</a></li></ul><p id="9099" class="pw-post-body-paragraph ne nf fq ng b go ob ni nj gr oc nl nm nn od np nq nr oe nt nu nv of nx ny nz fj bk">If you enjoyed this article about NuCS, please clap <strong class="ng fr">50</strong> times !</p></div></div></div></div>    
</body>
</html>