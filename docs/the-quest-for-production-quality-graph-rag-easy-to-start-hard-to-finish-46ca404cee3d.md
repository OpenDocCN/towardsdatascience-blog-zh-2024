# 生产质量图谱 RAG 的探索：容易开始，难以完成

> 原文：[`towardsdatascience.com/the-quest-for-production-quality-graph-rag-easy-to-start-hard-to-finish-46ca404cee3d?source=collection_archive---------2-----------------------#2024-10-31`](https://towardsdatascience.com/the-quest-for-production-quality-graph-rag-easy-to-start-hard-to-finish-46ca404cee3d?source=collection_archive---------2-----------------------#2024-10-31)

## 克服生产化图谱 RAG 的挑战

[](https://medium.com/@briangodsey?source=post_page---byline--46ca404cee3d--------------------------------)![Brian Godsey](https://medium.com/@briangodsey?source=post_page---byline--46ca404cee3d--------------------------------)[](https://towardsdatascience.com/?source=post_page---byline--46ca404cee3d--------------------------------)![Towards Data Science](https://towardsdatascience.com/?source=post_page---byline--46ca404cee3d--------------------------------) [Brian Godsey](https://medium.com/@briangodsey?source=post_page---byline--46ca404cee3d--------------------------------)

·发表于[Towards Data Science](https://towardsdatascience.com/?source=post_page---byline--46ca404cee3d--------------------------------) ·阅读时长 15 分钟·2024 年 10 月 31 日

--

![](img/82716a81f804db31b3f48d2c856bb956.png)

知识图谱的冒险：知识图谱中有价值的东西。由 Brian Godsey 使用 DALL-E 生成。

当我阅读了 VentureBeat 最近的一篇文章，关于 Glean[刚刚在最新一轮融资中获得超过 2.6 亿美元](https://venturebeat.com/data-infrastructure/how-to-take-advantage-of-a-generative-tool-fueling-gleans-260m-raise-graph-rag/)，我有两个立刻的直觉。首先，看到这个非常公开的图谱 RAG 案例能够充分发挥其作为一种强大而有价值的技术的潜力，这让我感到非常满足，因为它比以往任何时候都更高效地将人们与知识连接。其次，看到以下内容虽然令我感到惊讶，但也让我感到验证：

> 世界上最大的共享出行公司之一亲身体验了其好处。在将一整个工程师团队投入开发类似的内部解决方案后，他们最终决定转向 Glean 的平台。
> 
> “在一个月内，他们在 Glean 平台上的使用量翻了一倍，因为结果显而易见，”Glean 的首席营销官 Matt Kixmoeller 说道。

尽管我对新闻文章中提到的失败感到惊讶，但根据我的经验，以及同事和客户的经历，我认为图谱 RAG 在生产环境中遇到困难是可以预见的。我并不是说我预期大科技公司会在构建自己的图谱 RAG 系统时失败。**我只是预期大多数人会在构建和生产化图谱 RAG 的过程中遇到困难——即使他们已经有了非常成功的概念验证。**

我曾在[The New Stack 上对 VentureBeat 文章做过一篇高水平的回应](https://bit.ly/4fjIlgJ)，在这篇文章中，我想更深入探讨为什么图 RAG 如此难以做到完美。首先，我会指出，借助最新工具，使用图 RAG 变得非常容易。接下来，我将深入探讨图 RAG 的一些具体挑战，这些挑战使得它从研发转向生产变得异常困难。最后，我会分享一些关于如何最大化成功机会的图 RAG 技巧。

# 开始使用图 RAG 很简单

那么，如果一个大型共享出行公司都无法有效构建自己的平台，为什么我会说实现图 RAG 是件容易的事呢？

![](img/d301165477a1ec382b28fdafd10ab6c5.png)

知识图谱的冒险：道路是明确的。由 Brian Godsey 使用 DALL-E 生成。

好吧，首先，支持 RAG 和图 RAG 的技术在过去一年中取得了很大的进展。十二个月前，大多数企业甚至没有听说过检索增强生成（RAG）。现在，不仅 RAG 支持已经成为[像 LangChain 这样的最佳 AI 构建工具的关键特性](https://python.langchain.com/docs/tutorials/rag/)，而且几乎每一个 AI 领域的主要参与者都有 RAG 教程，甚至[还有一门 Coursera 课程](https://www.coursera.org/projects/introduction-to-rag)。尝试 RAG 的快速入门方式不胜枚举。

微软可能不是最早做图 RAG 的公司，但他们通过[今年早些时候的研究博客文章](https://www.microsoft.com/en-us/research/blog/graphrag-unlocking-llm-discovery-on-narrative-private-data/)大力推动了这一概念，并且他们仍在继续研究相关技术。

在 Medium 上，也有一篇不错的概念性介绍，带有一些技术细节，由 Google 的生成型 AI 工程师撰写。此外，在 Towards Data Science 上，最近有一篇非常详尽的关于如何构建图 RAG 系统的教程文章，并在一个科学出版物数据集上进行测试。

在传统图数据库和分析领域中拥有稳固声誉的 Neo4j，为了应对近期的生成型人工智能革命，向其旗舰图数据库产品添加了向量能力，并且他们拥有一套出色的工具平台，适用于那些除了标准图 RAG 能力外，还需要复杂图分析和深度图算法的项目。他们还有一份[Graph RAG 入门指南](https://neo4j.com/developer-blog/graphrag-ecosystem-tools/)。

另一方面，[你甚至不需要图数据库来做图 RAG](https://bit.ly/3YD5NAd)。许多刚接触图 RAG 的人认为他们需要部署一个专门的图数据库，但其实并不需要，事实上这样做可能会让你的技术栈变得更复杂。

我的雇主 DataStax 也有一份[图 RAG 指南](https://bit.ly/4862Lrl)。

当然，两个最流行的生成 AI 应用组合框架，[LangChain](https://blog.langchain.dev/enhancing-rag-based-applications-accuracy-by-constructing-and-leveraging-knowledge-graphs/) 和 [LlamaIndex](https://docs.llamaindex.ai/en/stable/examples/cookbooks/GraphRAG_v1/)，各自都有自己的图形 RAG 介绍。而且还有一篇 [DataCamp 文章](https://www.datacamp.com/tutorial/knowledge-graph-rag) 使用了这两者。

尽管有许多工具和教程可供使用，开始使用图形 RAG 是容易的部分……

# …但是将图形 RAG 应用到生产环境中是困难的

这是数据科学中的一个非常古老的故事：一种新的软件方法论、技术或工具在研究背景中解决了一个棘手的问题，但在工业界很难将其构建成能够每天提供价值的产品。这不仅仅是软件开发中努力和熟练的问题——即使是最大的、最好的、最聪明的团队，也可能无法克服解决实际问题时，现实世界数据的不确定性、不可预测性和不可控性。

![](img/6f6cc247a26c40f08d8a8e8f197e52b4.png)

知识图谱中的冒险：难度等级 9。由 Brian Godsey 使用 DALL-E 生成。

不确定性是构建和使用以数据为中心的系统的固有部分，这些系统几乎总是具有某些随机性、概率或无界输入。而且，当输入和输出是非结构化的（如大语言模型和其他生成 AI 应用的自然语言输入和输出）时，不确定性可能会更大。

想要尝试图形 RAG 的人通常已经拥有一个在简单用例中表现良好的现有 RAG 应用，但在一些更复杂的用例和需要跨知识库获取多个信息的提示中失败，可能涉及不同的文档、上下文、格式，甚至数据存储。当回答问题所需的所有信息都在知识库中，但 RAG 系统找不到时，似乎就失败了。从用户体验（UX）的角度来看，确实是失败——没有给出正确的答案。

但这并不一定意味着 RAG 系统存在“问题”，它可能正如设计时所预期的那样工作。如果没有问题或错误，但我们仍然没有得到我们想要的响应，那就意味着我们期望 RAG 系统具备它根本不具备的能力。

在我们探讨为什么图形 RAG 很难投入生产之前，先来看一下我们试图解决的问题。

# 图形 RAG 所解决的主要挑战

由于普通的 RAG 系统（没有知识图谱）仅基于向量搜索来检索文档，因此只能检索与查询最语义相似的文档。那些完全不相似——或者相似度不够高的文档——将会被遗漏，并且通常不会提供给生成响应的 LLM。

当我们需要的文档与提示中的问题不完全语义相似时，一个或多个文档往往会被 RAG 系统遗漏。这种情况通常发生在回答问题时需要混合使用通用文档和专业化文档或术语时，或者当文档内容非常详细，某些与特定提示相关的关键细节被埋藏在不太相关的其他细节中时。请参阅[这篇文章，了解 RAG 系统遗漏文档的示例](https://bit.ly/3BKZAJv)，因为两个相关概念（此处是“太空针塔”和“下皇后安区”）在语义上不相似；[请参阅这篇文章，了解重要细节在详细密集的文档中被掩埋的示例](https://bit.ly/4ffhrqi)，因为向量嵌入是“有损的”。

当我们看到检索“未能”找到正确的文档时，我们可能会倾向于尝试改进向量搜索，使其更适合我们的使用场景。但这将需要调整嵌入，而嵌入是复杂的、杂乱的、计算成本高昂的，甚至微调的成本更高。而且，这甚至不是解决问题的最佳方式。

例如，看看上面链接的示例，我们真的希望使用一种将“太空针塔”和“下皇后安区”这两个词语在语义向量空间中放得很近的嵌入算法吗？不，微调或找到一种将这两个术语放得非常接近的嵌入算法，可能会产生一些意外且不希望出现的副作用。

最好不要强迫语义模型去做本可以由地理或旅游信息更好完成的任务。如果我是一家旅游公司，依赖于知道这些地标位于哪个社区，我宁愿建立一个能明确知道这些信息的数据库——这比让语义向量搜索完成相同任务更容易……而且没有完全的确定性。

所以，这里的主要问题是我们知道某些概念和信息在某种程度上是相关的，但它们在语义向量空间中并不相似。另一个（非向量的）信息来源告诉我们，在我们处理的各种概念之间存在某种联系。构建图谱 RAG 应用的任务是有效地将这些概念之间的联系捕捉到知识图谱中，并利用图谱中的连接来检索更多相关的文档，以便回答提示中的问题。

![](img/45919597c0582672c10389bfb507e1f0.png)

知识图谱探险：小心脚步。由 Brian Godsey 使用 DALL-E 生成。

总结我们尝试解决的图谱 RAG 问题：在我的非结构化文档中，存在许多概念之间的半结构化、非语义信息连接——我希望利用这些连接信息来补充语义向量搜索，从而检索出最适合回答提示和问题的文档。我们只是想让检索变得更好，我们希望通过使用一些外部信息或外部逻辑来实现这一点，而不是仅仅依赖语义向量搜索来将提示与文档连接起来。

# 集成图谱与 RAG 的指导原则

考虑到上述动机——使用“外部”信息来建立语义搜索遗漏的文档连接——在构建和测试图谱 RAG 应用时，我们可以牢记一些指导原则：

1.  图谱应包含高质量、有意义的概念和连接

1.  概念和连接应与用例集中的提示相关

1.  图谱连接应补充而非替代向量搜索

1.  应优先考虑一跳和两跳的图谱连接；依赖超过三步的连接应仅限于专门的用例。

也许在未来的文章中，我们将深入探讨遵循这些原则的细微差别和潜在影响，但目前，我仅仅提到，这个列表旨在共同提高可解释性、防止过度复杂化，并最大化构建和使用图谱 RAG 系统的效率。

遵循这些原则，以及软件工程和数据科学中的其他核心原则，可以增加成功构建一个有用且强大的图谱 RAG 应用的机会，但过程中肯定会有陷阱，我们将在下一节中概述这些陷阱。

![](img/190cbcbcada5af132174bd47d998019d.png)![](img/89ae15953420ee6733eea354e2df592b.png)

知识图谱探险：战略游戏。由 Brian Godsey 使用 DALL-E 生成。

# 你的图谱 RAG 应用可能无法投入生产的原因

任何在围绕数据、复杂算法、统计学和人类用户构建软件方面花费了大量时间的人，大概都理解在构建像图谱 RAG 这样的系统时存在大量不确定性。在数据准备和加载过程中、构建知识图谱时、查询和遍历图谱时、结果编译和提示构建时，几乎在工作流的任何其他点，都可能会发生意外的事情。

上面我们讨论了如何轻松实现图谱 RAG 以获得初步结果，但要获得良好的结果，更不用说生产级别的结果，可能会很难。接下来，我们将看看在构建和测试图谱 RAG 应用时可能遇到的一些潜在问题。

![](img/bc89b9656db36918ee27783e302a32a9.png)

知识图谱的冒险：未开发的原始价值。由 Brian Godsey 使用 DALL-E 生成。

## **图谱 RAG 的表现不比普通 RAG 好多少**

如果你的图谱 RAG 系统的表现与普通 RAG 差不多，可能有很多原因。一般来说，这意味着图谱没有为系统增加价值，但这可能是因为知识图谱质量较低、图谱未被充分利用、参数设置不理想等多种原因。或者，根本没有问题；向量搜索可能已经非常有效地找到了正确的文档，而图谱根本不需要。

需要关注的内容：

+   你是否有普通 RAG 处理不好，但你期望图谱 RAG 能够成功处理的示例提示？你能否在这些提示上“调试”并查看背后的处理过程？

+   知识图谱是否包含了语义搜索可能无法识别的有意义的连接？你能找到在图谱中连接的概念对，它们相关的文档在向量空间中相隔很远的例子吗？知识图谱应该在“远距离”文档之间建立有意义的连接。

## **你（仍然）看到了幻觉**

如果你在图谱 RAG 中看到了幻觉，而在普通 RAG 中没有遇到这种情况，我会怀疑在某个地方有 bug 或不当的参数设置。如果你看到的幻觉水平相似，那可能是一个超出了图谱方面的普遍问题。

需要关注的内容：

+   你的文档集是否包含了正确的响应，以应对那些引发幻觉的提示？向量搜索是否能够找到这些文档？

+   从检索的文档中提取的正确响应是否被恰当地插入到传递给 LLM 的提示上下文中？

## **图谱“太大”**

当你的知识图谱“太大”或太密集时，可能会发生两种主要问题。首先，可能会出现扩展性问题，我将在下面讨论。其次，图谱遍历可能会导致返回“太多”文档，这些文档必须重新排序和过滤。如果重新排序和过滤策略与检索和图谱遍历元素不兼容，可能会导致图谱刚刚发现的文档就被立即过滤掉。

需要关注的内容：

+   在图谱遍历后返回了多少文档，多少文档被重新排名或过滤掉了？看起来通过强连接找到的文档是否能够成功存活过过滤？

+   你是否构建了一个充满有意义连接、适合你使用案例的知识图谱？在图谱中，你能找到很多对于你的使用案例来说过于通用或不相关的概念或连接吗？你的知识图谱中有多少是由低质量的信息构成的？

## **图谱“太小”**

如上所述，如果图“太大”，可能充满了低质量的连接。而如果图“太小”，我希望其中的连接是有意义的，这很好，但缺失的连接有两种主要类型。第一种是由于图构建过程中的 bug 引起的。第二种是由于图构建没有针对特定情况设计。不同上下文或不同格式的数据可能会被不同的图构建方法处理。

需要关注的内容：

+   你是否使用 LLM（大语言模型）进行实体/关键词提取来构建你的知识图谱？你是否捕获了每个文档中的所有有意义的实体，还是 LLM 限制了它的输出？

+   在你的文档中，有哪些概念和连接是你期望出现在知识图谱中的，但似乎缺失了？你期望它们何时以及如何被添加到图中？为什么它们实际上没有被添加到图中？

## **你无法找到“中庸之道”图**

你是否觉得自己可以构建一个“太大”或“太小”的图，但无法构建一个适中的图？

需要关注的内容：

+   你在从小图到大图或反之转换时，正在改变哪些参数或方法？这些应该对图的质量产生这么大的影响吗？你能否研究一些图元素，这些元素会根据你使用的图构建设置意外地出现或消失？

+   也请查看上面“大”和“小”部分中的相关提示。

## **你的实现需要新的软件或增加的部署复杂性**

这是一个经典的数据科学问题：构建非常酷的前沿方法，但开发团队却拒绝或挣扎于将你笔记本中的代码带入生产堆栈。坚持使用最流行、最受支持且大多为开源的工具可以更容易地将代码投入生产，特别是当你的组织在其他地方已经在使用这些工具时。

需要关注的内容：

+   你的实现是否需要为图创建一个新的数据存储？你[可能不需要图数据库](https://www.datastax.com/blog/knowledge-graphs-for-rag-without-a-graphdb)，也许可以使用你的生产向量存储来处理图。

+   你是否在构建 AI 应用时使用了像 LangChain 这样的一些流行开源工具？这些工具可以减少代码复杂度，使应用更具可移植性，并扩展潜在的集成和进一步开发。

## **你的实现没有扩展性**

文章[通过消除边缘来扩展知识图谱](https://thenewstack.io/scaling-knowledge-graphs-by-eliminating-edges/)来自*The New Stack*，展示了一种使图 RAG 具有很强扩展性的方法。正如前面提到的，最流行、最受支持且大多为开源的工具通常是实现无痛扩展的最佳途径，但这并不总是容易的。

需要关注的内容：

+   哪个部分没有扩展性？是图遍历、重新排序、结果汇总，还是其他什么问题？请参阅上面的“图太大”部分，获取更多建议。

+   你是否有某个特定组件的扩展性不好？有时候，使用像‘networkx’这样的内存图形库，甚至是图数据库，来执行复杂的图形操作，可能会导致资源瓶颈。你可能想要[切换到一个更具扩展性的图形操作选项](https://bit.ly/3YD5NAd)。

+   你是否在使用并行 API 调用来处理大多数繁重的工作，还是试图在主应用逻辑中进行复杂或成本高昂的计算？

# 在生产环境中实现图形 RAG 的成功

创建成功的图形 RAG 系统的关键在于构建一个能够与语义向量检索相辅相成的知识图谱和遍历逻辑，而不是取而代之或与之竞争。图谱设计应旨在在适当的时间连接正确的节点、知识、实体和文档，从而实现合适文档的组合，生成最有帮助且可操作的查询响应。

![](img/3aab095f20acb4e42a985703a33ee2c4.png)

知识图谱的冒险：知识就是财富。由 Brian Godsey 使用 DALL-E 生成。

就 Glean 而言，需要注意的是，内部文档数据集是图形 RAG 的完美用例。知识图谱可以连接人员、项目、产品、客户、会议、地点等——这些在数量上受到组织规模和所从事工作类型的限制。构建和管理一个包含数千名员工的图谱，比起例如试图在维基百科或大型金融或法律文档数据库中处理所有提到的人来说，容易得多。因此，Glean 做出的第一个伟大决定可能就是找到一个适合图形 RAG 的伟大用例来解决问题。

图形 RAG 系统的一个常被低估的方面是输入数据的质量和可靠性，以及将数据传输到那里的数据管道。这更多与数据工程和传统软件开发相关，而非 AI。在以前的技术范式中，由于数据类型和访问方式的不兼容，连接不同的数据系统是一个挑战。如今，AI 和 LLM 使得集成来自不同来源的非结构化数据成为可能，从而将来自各个来源的数据整合到一个单一的 RAG 系统中。这种集成能力使得 LLM 能够处理和理解来自不同来源的非结构化数据，比如内部网页、维基、代码仓库、数据库、Google Docs 和聊天记录。仅仅将所有这些信息连接起来，并通过单一接口提供访问，可能就是一个巨大的突破。

# 前进的道路

构建适用于任何用例的图形 RAG 系统涉及利用基础组件，如向量和图形的数据存储、嵌入和 LLMs，并通过 LangChain 和 LlamaIndex 等开源编排工具增强功能。这些工具促进了强大、可扩展且高效的系统的开发，预示着一个未来，在这个未来中，公司通过自动化和简化流程优化知识工作，从而实现巨大的成功。

知识图谱和图形 RAG 系统的公共成功，特别是像 Glean 这样的公司，展示了这些技术在内部用例中的有效性，通过提高组织效率创造了价值。然而，面向外部、企业和消费者产品的更广泛应用潜力仍然 largely 未被挖掘，为其他公司探索提供了许多机会。

值得注意的是，我们至少已经处于所谓的“信息时代”超过 30 年，而直到过去一两年，我们才真正开始将这些信息从不同来源、不同思想、不同文档和不同概念之间连接起来，从而使我们的软件系统能够进行与人类在日常知识工作中使用的推理、逻辑和判断相同类型的思考。有些人称之为“智能时代”。

虽然最初专注于简单直接的决策，AI 的发展轨迹是朝着管理更复杂的场景前进，显著提高时间和成本效率。这一激动人心的进展使得许多 AI 应用——包括图形 RAG——成为转变知识在各种背景下如何互联和利用的关键。

如果现在开始使用图形 RAG，或者想了解更多，看看 [DataStax 关于图形 RAG 的指南](https://bit.ly/4862Lrl)。

*由 Brian Godsey 博士提供 (*[*LinkedIn*](https://bit.ly/4enqFRa)*) — 数学家、数据科学家和工程师 // AI 和 ML 产品在* [*DataStax*](https://bit.ly/3NpPujA) *// 编写了《*像数据科学家一样思考*》一书* [*Think Like a Data Scientist*](https://bit.ly/4f5uVES)

[](/check-your-assumptions-about-your-data-20be250c143?source=post_page-----46ca404cee3d--------------------------------) ## 检查你对数据的假设

### 在数据科学或其他任何领域，永远不会过时的建议。

towardsdatascience.com [](/vector-embeddings-are-lossy-heres-what-to-do-about-it-4f9a8ee58bb7?source=post_page-----46ca404cee3d--------------------------------) ## 向量嵌入是有损的。以下是解决方法。

### AI 系统并不完美（呜哦！），这些是其中一些原因。

towardsdatascience.com ![](img/eb167e1e183c41ba4fe00bcc6a47dcca.png)

知识图谱的冒险：我几乎能触及它。由 Brian Godsey 使用 DALL-E 生成。

![](img/202395a27df189abdcaf7f190404c20c.png)

知识图谱的冒险：没有图谱的黄金。由 Brian Godsey 使用 DALL-E 生成。
