<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>A Definitive Guide to Using BigQuery Efficiently</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>A Definitive Guide to Using BigQuery Efficiently</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/burn-data-rather-than-money-with-bigquery-the-definitive-guide-1b50a9fdf096?source=collection_archive---------2-----------------------#2024-03-03">https://towardsdatascience.com/burn-data-rather-than-money-with-bigquery-the-definitive-guide-1b50a9fdf096?source=collection_archive---------2-----------------------#2024-03-03</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="dd88" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx">Make the most out of your BigQuery usage, burn data rather than money to create real value with some practical techniques.</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hd he hf hg hh ab"><div><div class="ab hi"><div><div class="bm" aria-hidden="false"><a href="https://vojay.medium.com/?source=post_page---byline--1b50a9fdf096--------------------------------" rel="noopener follow"><div class="l hj hk by hl hm"><div class="l ed"><img alt="Volker Janz" class="l ep by dd de cx" src="../Images/0825160d6d521f4152948f0187cf354b.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/1*UKWFUrD3gzsvYC0QKsPT3g.jpeg"/><div class="hn by l dd de em n ho eo"/></div></div></a></div></div><div class="hp ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--1b50a9fdf096--------------------------------" rel="noopener follow"><div class="l hq hr by hl hs"><div class="l ed"><img alt="Towards Data Science" class="l ep by br ht cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hn by l br ht em n ho eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hu ab q"><div class="ab q hv"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hw hx bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hy" data-testid="authorName" href="https://vojay.medium.com/?source=post_page---byline--1b50a9fdf096--------------------------------" rel="noopener follow">Volker Janz</a></p></div></div></div><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hw hx dx"><button class="ib ic ah ai aj ak al am an ao ap aq ar id ie if" disabled="">Follow</button></p></div></div></span></div></div><div class="l ig"><span class="bf b bg z dx"><div class="ab cn ih ii ij"><div class="ik il ab"><div class="bf b bg z dx ab im"><span class="in l ig">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hy ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--1b50a9fdf096--------------------------------" rel="noopener follow"><p class="bf b bg z io ip iq ir is it iu iv bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">20 min read</span><div class="iw ix l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Mar 3, 2024</span></div></span></div></span></div></div></div><div class="ab cp iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn"><div class="h k w ea eb q"><div class="kd l"><div class="ab q ke kf"><div class="pw-multi-vote-icon ed in kg kh ki"><div class=""><div class="kj kk kl km kn ko kp am kq kr ks ki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kt ku kv kw kx ky kz"><p class="bf b dy z dx"><span class="kk">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kj lc ld ab q ee le lf" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="lb"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg><p class="bf b dy z dx"><span class="pw-responses-count la lb">7</span></p></button></div></div></div><div class="ab q jo jp jq jr js jt ju jv jw jx jy jz ka kb kc"><div class="lg k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lh an ao ap id li lj lk" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep ll cn"><div class="l ae"><div class="ab cb"><div class="lm ln lo lp lq lr ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><p id="705d" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">· <a class="af nf" href="#b5f1" rel="noopener ugc nofollow">📝 Introduction</a><br/>· <a class="af nf" href="#ecac" rel="noopener ugc nofollow">💎 BigQuery basics and understanding costs</a><br/> ∘ <a class="af nf" href="#2451" rel="noopener ugc nofollow">Storage</a><br/> ∘ <a class="af nf" href="#73e8" rel="noopener ugc nofollow">Compute</a><br/>· <a class="af nf" href="#c6f3" rel="noopener ugc nofollow">📐 Data modeling</a><br/> ∘ <a class="af nf" href="#5d43" rel="noopener ugc nofollow">Data types</a><br/> ∘ <a class="af nf" href="#20ab" rel="noopener ugc nofollow">The shift towards de-normalization</a><br/> ∘ <a class="af nf" href="#acf8" rel="noopener ugc nofollow">Partitioning</a><br/> ∘ <a class="af nf" href="#8d1d" rel="noopener ugc nofollow">Clustering</a><br/> ∘ <a class="af nf" href="#2c8a" rel="noopener ugc nofollow">Nested repeated columns</a><br/> ∘ <a class="af nf" href="#7ed9" rel="noopener ugc nofollow">Indexing</a><br/> ∘ <a class="af nf" href="#507a" rel="noopener ugc nofollow">Physical Bytes Storage Billing</a><br/> ∘ <a class="af nf" href="#258d" rel="noopener ugc nofollow">Join optimizations with primary keys and foreign keys</a><br/>· <a class="af nf" href="#6bae" rel="noopener ugc nofollow">⚙️ Data operations</a><br/> ∘ <a class="af nf" href="#28ad" rel="noopener ugc nofollow">Copy data / tables</a><br/> ∘ <a class="af nf" href="#da01" rel="noopener ugc nofollow">Load data</a><br/> ∘ <a class="af nf" href="#0ef6" rel="noopener ugc nofollow">Delete partitions</a><br/> ∘ <a class="af nf" href="#0c4d" rel="noopener ugc nofollow">Get distinct partitions for a table</a><br/> ∘ <a class="af nf" href="#3ae7" rel="noopener ugc nofollow">Do not persist calculated measures</a><br/>· <a class="af nf" href="#59d4" rel="noopener ugc nofollow">📚 Summary</a><br/> ∘ <a class="af nf" href="#165f" rel="noopener ugc nofollow">Embrace data modeling best practices</a><br/> ∘ <a class="af nf" href="#8018" rel="noopener ugc nofollow">Master data operations for cost-effectiveness</a><br/> ∘ <a class="af nf" href="#af6f" rel="noopener ugc nofollow">Design for efficiency and avoid unnecessary data persistence</a></p><p id="9113" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk"><strong class="ml fr">Disclaimer</strong>: BigQuery is a product which is constantly being developed, pricing might change at any time and this article is based on my own experience.</p></div></div><div class="ng"><div class="ab cb"><div class="lm nh ln ni lo nj cf nk cg nl ci bh"><figure class="np nq nr ns nt ng nu nv paragraph-image"><div role="button" tabindex="0" class="nw nx ed ny bh nz"><div class="nm nn no"><img src="../Images/ad3d101dc043e43fc1b8f1c82871e0d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:2000/format:webp/0*t2N5p5CKukayoLh6"/></div></div><figcaption class="ob oc od nm nn oe of bf b bg z dx">Photo by <a class="af nf" href="https://unsplash.com/@constantinevdokimov?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Konstantin Evdokimov</a> on <a class="af nf" href="https://unsplash.com/?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure></div></div></div><div class="ab cb"><div class="ci bh ev ew ex ey"><h1 id="b5f1" class="og oh fq bf oi oj ok gq ol om on gt oo op oq or os ot ou ov ow ox oy oz pa pb bk">📝 Introduction</h1><p id="026f" class="pw-post-body-paragraph mj mk fq ml b go pc mn mo gr pd mq mr ms pe mu mv mw pf my mz na pg nc nd ne fj bk">In the field of data warehousing, there’s a universal truth: managing data can be costly. Like a dragon guarding its treasure, each byte stored and each query executed demands its share of gold coins. But let me give you a magical spell to appease the dragon: burn data, not money!</p><p id="112f" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">In this article, we will unravel the arts of BigQuery sorcery, to reduce costs while increasing efficiency, and beyond. Join as we journey through the depths of cost optimization, where every byte is a precious coin.</p><figure class="np nq nr ns nt ng nm nn paragraph-image"><div role="button" tabindex="0" class="nw nx ed ny bh nz"><div class="nm nn ph"><img src="../Images/26edd2af9f5eda4849e2b289d311ab64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*eDexoTbcTalChaYb"/></div></div><figcaption class="ob oc od nm nn oe of bf b bg z dx">Photo by <a class="af nf" href="https://unsplash.com/@jupp?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Jonathan Kemper</a> on <a class="af nf" href="https://unsplash.com/?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure></div></div></div><div class="ab cb pi pj pk pl" role="separator"><span class="pm by bm pn po pp"/><span class="pm by bm pn po pp"/><span class="pm by bm pn po"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><h1 id="ecac" class="og oh fq bf oi oj pq gq ol om pr gt oo op ps or os ot pt ov ow ox pu oz pa pb bk">💎 BigQuery basics and understanding costs</h1><p id="6c5d" class="pw-post-body-paragraph mj mk fq ml b go pc mn mo gr pd mq mr ms pe mu mv mw pf my mz na pg nc nd ne fj bk">BigQuery is not just a tool but a package of scalable compute and storage technologies, with fast network, everything managed by Google. At its core, BigQuery is a serverless Data Warehouse for analytical purposes and built-in features like Machine Learning (<em class="pv">BigQuery ML</em>). BigQuery separates storage and compute with Google’s Jupiter network in-between to utilize 1 Petabit/sec of total bisection bandwidth. The storage system is using Capacitor, a proprietary columnar storage format by Google for semi-structured data and the file system underneath is Colossus, the distributed file system by Google. The compute engine is based on Dremel and it uses Borg for cluster management, running thousands of Dremel jobs across cluster(s).</p><blockquote class="pw px py"><p id="1a88" class="mj mk pv ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk"><strong class="ml fr"><em class="fq">BigQuery is not just a tool but a package of scalable compute and storage technologies, with fast network, everything managed by Google</em></strong></p></blockquote><p id="4d87" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">The following illustration shows the basic architecture of how BigQuery is structured:</p><figure class="np nq nr ns nt ng nm nn paragraph-image"><div role="button" tabindex="0" class="nw nx ed ny bh nz"><div class="nm nn pz"><img src="../Images/348b1c767b85af6fbb00e012327b8993.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3Ph--na4Lj4ngivS2L34aQ.png"/></div></div><figcaption class="ob oc od nm nn oe of bf b bg z dx">BigQuery architecture (by author)</figcaption></figure><p id="d4ab" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Data can be stored in Colossus, however, it is also possible to create BigQuery tables on top of data stored in Google Cloud Storage. In that case, queries are still processed using the BigQuery compute infrastructure but read data from GCS instead. Such <code class="cx qa qb qc qd b">external tables</code> come with some disadvantages but in some cases it can be more cost efficient to have the data stored in GCS. Also, sometimes it is not about Big Data but simply reading data from existing CSV files that are somehow ingested to GCS. For simplicity it can also be benificial to use these kind of tables.</p><figure class="np nq nr ns nt ng nm nn paragraph-image"><div role="button" tabindex="0" class="nw nx ed ny bh nz"><div class="nm nn pz"><img src="../Images/f263f69736f23df70761a9222df7e3b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B4QN2_zcKMbgC0M492nSHg.png"/></div></div><figcaption class="ob oc od nm nn oe of bf b bg z dx">BigQuery external tables (by author)</figcaption></figure><p id="e416" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">To utilize the full potential of BigQuery, the regular case is to store data in the BigQuery storage.</p><p id="5364" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">The main drivers for costs are storage and compute, Google is not charging you for other parts, like the network transfer in between storage and compute.</p><h2 id="2451" class="qe oh fq bf oi qf qg qh ol qi qj qk oo ms ql qm qn mw qo qp qq na qr qs qt qu bk">Storage</h2><p id="912c" class="pw-post-body-paragraph mj mk fq ml b go pc mn mo gr pd mq mr ms pe mu mv mw pf my mz na pg nc nd ne fj bk">Storage costs you $0.02 per GB — $0.04 per GB for active and $0.01 per GB — $0.02 per GB for inactive data (<em class="pv">which means not modified in the last 90 days</em>). If you have a table or partition that is not modified for 90 consecutive days, it is considered long term storage, and the price of storage automatically drops by 50%. Discount is applied on a per-table, per-partition basis. Modification resets the 90-day counter.</p><h2 id="73e8" class="qe oh fq bf oi qf qg qh ol qi qj qk oo ms ql qm qn mw qo qp qq na qr qs qt qu bk">Compute</h2><p id="069e" class="pw-post-body-paragraph mj mk fq ml b go pc mn mo gr pd mq mr ms pe mu mv mw pf my mz na pg nc nd ne fj bk">BigQuery charges for data scanned and not the runtime of the query, also transfer from storage to compute cluster is not charged. Compute costs depend on the location, the costs for <code class="cx qa qb qc qd b">europe-west3</code> are $8.13 per TB for example.</p><p id="40ec" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">This means:</p><blockquote class="pw px py"><p id="98b2" class="mj mk pv ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk"><strong class="ml fr"><em class="fq">We want to minimize the data to be scanned for each query!</em></strong></p></blockquote></div></div><div class="ng"><div class="ab cb"><div class="lm nh ln ni lo nj cf nk cg nl ci bh"><figure class="np nq nr ns nt ng nu nv paragraph-image"><div role="button" tabindex="0" class="nw nx ed ny bh nz"><div class="nm nn qv"><img src="../Images/fb555e76a253c89bb09904ccc83e1e24.png" data-original-src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*dee5L_H1eM36KXnG-sEE8w.png"/></div></div><figcaption class="ob oc od nm nn oe of bf b bg z dx">Left: <a class="af nf" href="https://unsplash.com/de/@jpvalery?utm_content=creditCopyText&amp;utm_medium=referral&amp;utm_source=unsplash" rel="noopener ugc nofollow" target="_blank">Jp Valery</a> on <a class="af nf" href="https://unsplash.com/de/fotos/zeitrafferfotografie-mehrerer-brennender-us-dollar-banknoten-blOLCO2K4M0?utm_content=creditCopyText&amp;utm_medium=referral&amp;utm_source=unsplash" rel="noopener ugc nofollow" target="_blank">Unsplash</a>, right: <a class="af nf" href="https://unsplash.com/de/@gabrielj_photography?utm_content=creditCopyText&amp;utm_medium=referral&amp;utm_source=unsplash" rel="noopener ugc nofollow" target="_blank">Gabriel Jimenez</a> on <a class="af nf" href="https://unsplash.com/de/fotos/bokeh-fotografie-einer-person-die-erde-tragt-jin4W1HqgL4?utm_content=creditCopyText&amp;utm_medium=referral&amp;utm_source=unsplash" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure></div></div></div><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="27e7" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">When executing a query, BigQuery is estimating the data to be processed. After entering your query in the BigQuery Studio query editor, you can see the estimate on the top right.</p><figure class="np nq nr ns nt ng nm nn paragraph-image"><div role="button" tabindex="0" class="nw nx ed ny bh nz"><div class="nm nn qw"><img src="../Images/51bf962d037887c304ce20cda8662211.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GXLrzfdMrGI3d-QjtW3hGw.png"/></div></div><figcaption class="ob oc od nm nn oe of bf b bg z dx">BigQuery Studio</figcaption></figure><p id="6df6" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">If it says 1.27 GB like in the screenshot above and the query is processed in the location <code class="cx qa qb qc qd b">europe-west3</code>, the costs can be calculated like this:</p><pre class="np nq nr ns nt qx qd qy bp qz bb bk"><span id="206a" class="ra oh fq qd b bg rb rc l rd re">1.27 GB / 1024 = 0.0010 TB * $8.13 = $0.0084 total costs</span></pre><p id="07d8" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">The estimate is mostly a pessimistic calculation, often the optimizer is able to use cached results, materialized views or other techniques, so that the actual bytes billed are lower than the estimate. It is still a good practice to check this estimate in order to get a rough feeling of the impact of your work.</p><p id="5633" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">It is also possible to set a maximum for the bytes billed for your query. If your query exceeds the limit it will fail and create no costs at all. The setting can be changed by navigating to More -&gt; Query settings -&gt; Advanced options -&gt; Maximum bytes billed.</p><figure class="np nq nr ns nt ng nm nn paragraph-image"><div role="button" tabindex="0" class="nw nx ed ny bh nz"><div class="nm nn rf"><img src="../Images/31c6507a2b70acf6778a6ef827a030bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*z3ooqNWaMIQQtz31LXuMQg.png"/></div></div><figcaption class="ob oc od nm nn oe of bf b bg z dx">BigQuery Query Settings</figcaption></figure><figure class="np nq nr ns nt ng nm nn paragraph-image"><div class="nm nn rg"><img src="../Images/cbe8c884ffa43f6cf07d42f442d90060.png" data-original-src="https://miro.medium.com/v2/resize:fit:1266/format:webp/1*BwmC33_wQfX7rBb-CirD4A.png"/></div><figcaption class="ob oc od nm nn oe of bf b bg z dx">BigQuery exceeded limit for bytes billed</figcaption></figure><p id="57fd" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Unfortunately up until now, it is not possible to set a default value per query. It is only possible to limit the bytes billed for each day per user per project or for all bytes billed combined per day for a project.</p><p id="8fc8" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">When you start using BigQuery for the first projects, you will most likely stick with the on-demand compute pricing model. With on-demand pricing, you will generally have access to up to 2000 concurrent slots, shared among all queries in a single project, which is more than enough in most cases. A slot is like a virtual CPU working on a unit of work of your query DAG.</p><p id="2066" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">When reaching a certain spending per month, it is worth looking into the capacity pricing model, which gives you more predictable costs.</p><h1 id="c6f3" class="og oh fq bf oi oj ok gq ol om on gt oo op oq or os ot ou ov ow ox oy oz pa pb bk">📐 Data modeling</h1><h2 id="5d43" class="qe oh fq bf oi qf qg qh ol qi qj qk oo ms ql qm qn mw qo qp qq na qr qs qt qu bk">Data types</h2><p id="7ea7" class="pw-post-body-paragraph mj mk fq ml b go pc mn mo gr pd mq mr ms pe mu mv mw pf my mz na pg nc nd ne fj bk">To reduce the costs for storage but also compute, it is very important to always use the smallest datatype possible for your columns. You can easily estimate the costs for a certain amount of rows following this overview:</p><pre class="np nq nr ns nt qx qd qy bp qz bb bk"><span id="e24c" class="ra oh fq qd b bg rb rc l rd re">Type       | Size<br/>-----------|---------------------------------------------------------------<br/>ARRAY      | Sum of the size of its elements <br/>BIGNUMERIC | 32 logical bytes<br/>BOOL       | 1 logical byte<br/>BYTES      | 2 logical bytes + logical bytes in the value<br/>DATE       | 8 logical bytes<br/>DATETIME   | 8 logical bytes<br/>FLOAT64    | 8 logical bytes<br/>GEOGRAPHY  | 16 logical bytes + 24 logical bytes * vertices in the geo type<br/>INT64      | 8 logical bytes<br/>INTERVAL   | 16 logical bytes<br/>JSON       | Logical bytes in UTF-8 encoding of the JSON string<br/>NUMERIC    | 16 logical bytes<br/>STRING     | 2 logical bytes + the UTF-8 encoded string size<br/>STRUCT     | 0 logical bytes + the size of the contained fields<br/>TIME       | 8 logical bytes<br/>TIMESTAMP  | 8 logical bytes</span></pre><p id="3195" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk"><code class="cx qa qb qc qd b"><em class="pv">NULL</em></code><em class="pv"> is calculated as 0 logical bytes</em></p><p id="f463" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk"><strong class="ml fr">Example</strong>:</p><pre class="np nq nr ns nt qx qd qy bp qz bb bk"><span id="1087" class="ra oh fq qd b bg rb rc l rd re">CREATE TABLE gold.some_table (<br/>  user_id INT64,<br/>  other_id INT64,<br/>  some_String STRING, -- max 10 chars<br/>  country_code STRING(2),<br/>  user_name STRING,   -- max 20 chars<br/>  day DATE<br/>);</span></pre><p id="9ac3" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">With this definition and the table of datatypes, it is possible to estimate the logical size of 100,000,000 rows:</p><pre class="np nq nr ns nt qx qd qy bp qz bb bk"><span id="df99" class="ra oh fq qd b bg rb rc l rd re">100.000.000 rows * (<br/>  8 bytes (INT64) +<br/>  8 bytes (INT64) +<br/>  2 bytes + 10 bytes (STRING) +<br/>  2 bytes + 2 bytes (STRING(2)) +<br/>  2 bytes + 20 bytes (STRING) +<br/>  8 bytes (DATE)<br/>) = 6200000000 bytes / 1024 / 1024 / 1024<br/>  = 5.78 GB</span></pre><p id="1941" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Assuming we are running a <code class="cx qa qb qc qd b">SELECT *</code> on this table, it would cost us 5.78 GB / 1024 = 0.0056 TB * $8.13 = $0.05 in <code class="cx qa qb qc qd b">europe-west3</code>.</p><p id="eba8" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">It is a good idea to make these calculations before designing your data model, not only to optimize the datatype usage but also to get an estimate of the costs for the project that you are working on.</p><h2 id="20ab" class="qe oh fq bf oi qf qg qh ol qi qj qk oo ms ql qm qn mw qo qp qq na qr qs qt qu bk">The shift towards de-normalization</h2><p id="023c" class="pw-post-body-paragraph mj mk fq ml b go pc mn mo gr pd mq mr ms pe mu mv mw pf my mz na pg nc nd ne fj bk">In the realm of database design and management, data normalization and de-normalization are fundamental concepts aimed at optimizing data structures for efficient storage, retrieval, and manipulation. Traditionally, normalization has been hailed as a best practice, emphasizing the reduction of redundancy and the preservation of data integrity. However, in the context of BigQuery and other modern data warehouses, the dynamics shift, and de-normalization often emerges as the preferred approach.</p><p id="b3ff" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">In normalized databases, data is structured into multiple tables, each representing a distinct entity or concept, and linked through relationships such as one-to-one, one-to-many, or many-to-many. This approach adheres to the principles laid out by database normalization forms, such as the First Normal Form (1NF), Second Normal Form (2NF), and Third Normal Form (3NF), among others.</p><p id="6b42" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">This comes with the advantages of reduction of redundancy, data integrity and consequently, less storage usage.</p><figure class="np nq nr ns nt ng nm nn paragraph-image"><div role="button" tabindex="0" class="nw nx ed ny bh nz"><div class="nm nn rh"><img src="../Images/da2e4c1933ff53547b874460d16bfabc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*dQ_Z1uqxFgVIQCNE"/></div></div><figcaption class="ob oc od nm nn oe of bf b bg z dx">Photo by <a class="af nf" href="https://unsplash.com/@theshubhamdhage?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Shubham Dhage</a> on <a class="af nf" href="https://unsplash.com/?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="f1e3" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">While data normalization holds merit in traditional relational databases, the paradigm shifts when dealing with modern analytics platforms like BigQuery. BigQuery is designed for handling massive volumes of data and performing complex analytical queries at scale. In this environment, the emphasis shifts from minimizing storage space to optimizing query performance.</p><p id="02d9" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">In BigQuery, de-normalization emerges as a preferred strategy for several reasons:</p><ul class=""><li id="9c03" class="mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne ri rj rk bk"><strong class="ml fr">Query Performance</strong>: BigQuery’s distributed architecture excels at scanning large volumes of data in parallel. De-normalized tables reduce the need for complex joins, resulting in faster query execution times.</li><li id="664b" class="mj mk fq ml b go rl mn mo gr rm mq mr ms rn mu mv mw ro my mz na rp nc nd ne ri rj rk bk"><strong class="ml fr">Cost Efficiency</strong>: By minimizing the computational resources required for query processing, de-normalization can lead to cost savings, as query costs in BigQuery are based on the amount of data processed.</li><li id="0d11" class="mj mk fq ml b go rl mn mo gr rm mq mr ms rn mu mv mw ro my mz na rp nc nd ne ri rj rk bk"><strong class="ml fr">Simplified Data Modeling</strong>: De-normalized tables simplify the data modeling process, making it easier to design and maintain schemas for analytical purposes.</li><li id="b4d2" class="mj mk fq ml b go rl mn mo gr rm mq mr ms rn mu mv mw ro my mz na rp nc nd ne ri rj rk bk"><strong class="ml fr">Optimized for Analytical Workloads</strong>: De-normalized structures are well-suited for analytical workloads, where aggregations, transformations, and complex queries are common.</li></ul><p id="95f9" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Also, storage is much cheaper than compute and that means:</p><blockquote class="pw px py"><p id="5054" class="mj mk pv ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk"><strong class="ml fr"><em class="fq">With pre-joined datasets, you exchange compute for storage resources!</em></strong></p></blockquote><figure class="np nq nr ns nt ng nm nn paragraph-image"><div role="button" tabindex="0" class="nw nx ed ny bh nz"><div class="nm nn rq"><img src="../Images/37e6cbd109fc824810306d381286db7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rM_w3APe0L6jUyEjwQ_PLQ.png"/></div></div><figcaption class="ob oc od nm nn oe of bf b bg z dx">De-normalization (by author)</figcaption></figure><p id="6513" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">While de-normalization is not a one-size-fits-all solution, it should be considered for cost and performance optimization. However, there are aspects that might lead to a different, cost-efficient design.</p><p id="461a" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Especially when having small tables on the <strong class="ml fr">right side</strong> of the <code class="cx qa qb qc qd b">JOIN</code>, BigQuery utilizes <strong class="ml fr">Broadcast Joins</strong> to broadcast the full dataset of the table to each slot which processes the larger table. That way, normalization has no negative impact on performance. Actually, the opposite is the case and due to reduced data redundancy.</p><p id="5c45" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">When BigQuery is not using the Broadcast Join, it uses the <strong class="ml fr">Hash Join</strong> approach. In this case, BigQuery uses hash and shuffle operations so that matching keys are processed in the same slot in order to perform a local join. However, compared to a Broadcast Join, this can be a an expensive operation as data needs to be moved.</p><p id="7781" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">If you find yourself in a situation where Hash Joins are being used, there are still ways to potentially improve performance. At least aim for defining the join columns as cluster columns. This colocates data in the same columnar file, reducing the impact of shuffling.</p><p id="f5f7" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Ultimately, the best approach depends on the specifics of your data model and the size of the normalized tables. If redundancy can be reduced with a normalized structure while keeping the size of the <code class="cx qa qb qc qd b">JOIN</code> tables small, so that Broadcast Joins are used, this is the better solution than enforcing a de-normalized approach. For tables bigger than 10G however, this should be evaluated with concrete benchmarks, which leads to the golden rule:</p><p id="1493" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk"><strong class="ml fr">Benchmarking is key!</strong> Don’t rely solely on theory. Test different approaches (normalized, denormalized, nested/repeated) to find the most efficient solution for your specific use case.</p><h2 id="acf8" class="qe oh fq bf oi qf qg qh ol qi qj qk oo ms ql qm qn mw qo qp qq na qr qs qt qu bk">Partitioning</h2><p id="ad35" class="pw-post-body-paragraph mj mk fq ml b go pc mn mo gr pd mq mr ms pe mu mv mw pf my mz na pg nc nd ne fj bk">Partitions divide a table into segments based on <strong class="ml fr">one</strong> specific column. The partition column can use one of 3 approaches:</p><p id="25c6" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">🗂️ <strong class="ml fr">Integer range partitioning</strong>: Partition by integer column based on range with start, end and interval</p><p id="f20c" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">⏰ <strong class="ml fr">Time-unit partitioning</strong>: Partition by date, timestamp or datetime column in table with hourly, daily, monthly or yearly granularity</p><p id="eebe" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">⏱️ <strong class="ml fr">Ingestion time partitioning</strong>: Automatically assign partition when inserting data based on current time with a pseudocolumn named <code class="cx qa qb qc qd b">_PARTITIONTIME</code></p><p id="e6f4" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">It is up to you to define the partition column but it is highly recommend to choose this wisely as it can eliminate a lot of bytes processed / billed.</p><figure class="np nq nr ns nt ng nm nn paragraph-image"><div role="button" tabindex="0" class="nw nx ed ny bh nz"><div class="nm nn rr"><img src="../Images/ab874087ba6efbc653ba93c0707b36c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9a3r4DAibUCMec0OJzCShQ.png"/></div></div><figcaption class="ob oc od nm nn oe of bf b bg z dx">Partitioning example (by author)</figcaption></figure><p id="06fe" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk"><strong class="ml fr">Example:</strong></p><pre class="np nq nr ns nt qx qd qy bp qz bb bk"><span id="de9f" class="ra oh fq qd b bg rb rc l rd re">CREATE TABLE IF NOT EXISTS silver.some_partitioned_table (<br/>  title STRING,<br/>  topic STRING,<br/>  day DATE<br/>)<br/>PARTITION BY day<br/>OPTIONS (<br/>  partition_expiration_days = 365<br/>);</span></pre><p id="9de1" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">In the above example you can also see how to set the <code class="cx qa qb qc qd b">partition_expiration_days</code> option, which will remove partitions older than X days.</p><h2 id="8d1d" class="qe oh fq bf oi qf qg qh ol qi qj qk oo ms ql qm qn mw qo qp qq na qr qs qt qu bk">Clustering</h2><p id="7906" class="pw-post-body-paragraph mj mk fq ml b go pc mn mo gr pd mq mr ms pe mu mv mw pf my mz na pg nc nd ne fj bk">Clusters sort the data within each partition based on one ore more columns. When using cluster columns in your query filter, this technique will speed up the execution since BigQuery can determine which blocks to scan. This is especially recommended to use with high cardinality columns such as the <code class="cx qa qb qc qd b">title</code> column in the following example.</p><p id="3b1f" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">You can define up to <strong class="ml fr">four</strong> cluster columns.</p><p id="b034" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk"><strong class="ml fr">Example:</strong></p><pre class="np nq nr ns nt qx qd qy bp qz bb bk"><span id="554d" class="ra oh fq qd b bg rb rc l rd re">CREATE TABLE IF NOT EXISTS silver.some_partitioned_table (<br/>  title STRING,<br/>  topic STRING,<br/>  day DATE<br/>)<br/>PARTITION BY day<br/>CLUSTER BY topic<br/>OPTIONS (<br/>  partition_expiration_days = 365<br/>);</span></pre><h2 id="2c8a" class="qe oh fq bf oi qf qg qh ol qi qj qk oo ms ql qm qn mw qo qp qq na qr qs qt qu bk">Nested repeated columns</h2><p id="6b10" class="pw-post-body-paragraph mj mk fq ml b go pc mn mo gr pd mq mr ms pe mu mv mw pf my mz na pg nc nd ne fj bk">With data de-normalization often also duplication of information is introduced. This data redundancy adds additional storage and bytes to be processed in our queries. However, there is a way to have a de-normalized table design without redundancy using nested repeated columns.</p><p id="5a40" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">A <strong class="ml fr">nested</strong> column uses the type <code class="cx qa qb qc qd b">struct</code> and combines certain attributes to one object. A nested <strong class="ml fr">repeated</strong> column is an array of <code class="cx qa qb qc qd b">struct</code>s stored for a single row in the table. For example: if you have a table storing one row per login of a user, together with the user ID and the registration country of that user, you would have redundancy in form of the ID and country per login for each user.</p><p id="8040" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Instead of storing one row per login, with a nested repeated column you can store one single row per user and in a column of type <code class="cx qa qb qc qd b">ARRAY&lt;STRUCT&lt;...&gt;&gt;</code> you store an array of all logins of that user. The struct holds all attributes attached to the login, like the date and device. The following illustration visualizes this example:</p><figure class="np nq nr ns nt ng nm nn paragraph-image"><div role="button" tabindex="0" class="nw nx ed ny bh nz"><div class="nm nn rs"><img src="../Images/f6562058c8182f92d6a5db94c78706eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NXgpvZWxv2Wx5ONZ8VYIqA.png"/></div></div><figcaption class="ob oc od nm nn oe of bf b bg z dx">Nested repeated column example (by author)</figcaption></figure><p id="336e" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk"><strong class="ml fr">Example:</strong></p><pre class="np nq nr ns nt qx qd qy bp qz bb bk"><span id="e901" class="ra oh fq qd b bg rb rc l rd re">CREATE TABLE silver.logins (<br/>    user_id INT64,<br/>    country STRING(2),<br/>    logins ARRAY&lt;STRUCT&lt;<br/>        login_date DATE,<br/>        login_device STRING<br/>    &gt;&gt;,<br/>    day DATE<br/>)<br/>PARTITION BY day<br/>CLUSTER BY country, user_id<br/>OPTIONS (<br/>    require_partition_filter=true<br/>);</span></pre><p id="37ee" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">The above example also shows the utilization of the <code class="cx qa qb qc qd b">require_partition_filter</code> which will prevent any queries without filtering on the partition column.</p><p id="997f" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">This data modelling technique can reduce the stored and processed bytes drastically. However, it is not the silver bullet for all de-normalization or data modeling cases. The major downside is: <strong class="ml fr">you can’t set cluster or partition columns on attributes of structs</strong>.</p><p id="1a33" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">That means: in the example above, if a user would filter by <code class="cx qa qb qc qd b">login_device</code> a full table scan is necessary and we do not have the option to optimize this with clustering. This can be an issue especially if your table is used as a data source for third party software like Excel or PowerBI. In such cases, you should carefully evaluate if the benefit of removing redundancy with nested repeated columns compensates the lack of optimizations via clustering.</p><h2 id="7ed9" class="qe oh fq bf oi qf qg qh ol qi qj qk oo ms ql qm qn mw qo qp qq na qr qs qt qu bk">Indexing</h2><p id="89f5" class="pw-post-body-paragraph mj mk fq ml b go pc mn mo gr pd mq mr ms pe mu mv mw pf my mz na pg nc nd ne fj bk">By defining a search index on one or multiple columns, BigQuery can use this to speed up queries using the <code class="cx qa qb qc qd b">SEARCH</code> function.</p><p id="df10" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">A search index can be created with the <code class="cx qa qb qc qd b">CREATE SEARCH INDEX</code> statement:</p><pre class="np nq nr ns nt qx qd qy bp qz bb bk"><span id="c53b" class="ra oh fq qd b bg rb rc l rd re">CREATE SEARCH INDEX example_index ON silver.some_table(ALL COLUMNS);</span></pre><p id="9561" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">With <code class="cx qa qb qc qd b">ALL COLUMNS</code> the index is automatically created for all <code class="cx qa qb qc qd b">STRING</code> and <code class="cx qa qb qc qd b">JSON</code> columns. It is also possible to be more selective and add a list of column names instead. With the <code class="cx qa qb qc qd b">SEARCH</code> function, the index can be utilized to search within all or specific columns:</p><pre class="np nq nr ns nt qx qd qy bp qz bb bk"><span id="3a70" class="ra oh fq qd b bg rb rc l rd re">SELECT * FROM silver.some_table WHERE SEARCH(some_table, 'needle');</span></pre><p id="506c" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">A new feature, which is in preview state by the time writing this article, is to also utilize the index for operators such as <code class="cx qa qb qc qd b">=</code>, <code class="cx qa qb qc qd b">IN</code>, <code class="cx qa qb qc qd b">LIKE</code>, and <code class="cx qa qb qc qd b">STARTS_WITH</code>. This can be very beneficial for data structures that are directly used by end users via third party tools like PowerBI or Excel to further increase speed and reduce costs for certain filter operations.</p><p id="1051" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">More information about this can be found in the <a class="af nf" href="https://cloud.google.com/bigquery/docs/search-index" rel="noopener ugc nofollow" target="_blank">official search index documentation</a>.</p><h2 id="507a" class="qe oh fq bf oi qf qg qh ol qi qj qk oo ms ql qm qn mw qo qp qq na qr qs qt qu bk">Physical Bytes Storage Billing</h2><p id="1925" class="pw-post-body-paragraph mj mk fq ml b go pc mn mo gr pd mq mr ms pe mu mv mw pf my mz na pg nc nd ne fj bk">BigQuery offers two billing models for storage: Standard and Physical Bytes Storage Billing. Choosing the right model depends on your data access patterns and compression capabilities.</p><p id="c265" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">The standard model is straightforward. You pay a set price per gigabyte of data, with a slight discount for data that hasn’t been modified in 90 days. This is simple to use and doesn’t require managing different storage categories. However, it can be more expensive if your data is highly compressed or if you don’t access it very often.</p><p id="99f1" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Physical Bytes Storage Billing takes a different approach. Instead of paying based on how much logical data you store, you pay based on the physical space it occupies on disk, regardless of how often you access it or how well it’s compressed. This model can be <strong class="ml fr">significantly cheaper</strong> for highly compressed data or data you don’t access frequently. However, it requires you to manage two separate storage classes: one for frequently accessed data and another for long-term storage, which can add complexity.</p><p id="87c2" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">So, which model should you choose? <strong class="ml fr">Here’s a quick guide</strong>:</p><p id="5074" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk"><strong class="ml fr">Choose the standard model if</strong>:</p><ul class=""><li id="bc4a" class="mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne ri rj rk bk">Your data isn’t highly compressed.</li><li id="60a6" class="mj mk fq ml b go rl mn mo gr rm mq mr ms rn mu mv mw ro my mz na rp nc nd ne ri rj rk bk">You prefer a simple and easy-to-manage approach.</li></ul><p id="67d5" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk"><strong class="ml fr">Choose PBSB if</strong>:</p><ul class=""><li id="cdfb" class="mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne ri rj rk bk">Your data is highly compressed.</li><li id="db5b" class="mj mk fq ml b go rl mn mo gr rm mq mr ms rn mu mv mw ro my mz na rp nc nd ne ri rj rk bk">You’re comfortable managing different storage classes to optimize costs.</li></ul><p id="3616" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">You can change the billing model in the advanced option for your datasets. You can also check the logical vs. physical bytes in the table details view, which makes it easier to decide for a model.</p><figure class="np nq nr ns nt ng nm nn paragraph-image"><div role="button" tabindex="0" class="nw nx ed ny bh nz"><div class="nm nn rt"><img src="../Images/4cb2180cfd099101aac3829db377d55c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XivyGXiPtIOUns3CnUCSUg.png"/></div></div><figcaption class="ob oc od nm nn oe of bf b bg z dx">Dataset advanced options for Storage Billing Model</figcaption></figure><h2 id="258d" class="qe oh fq bf oi qf qg qh ol qi qj qk oo ms ql qm qn mw qo qp qq na qr qs qt qu bk">Join optimizations with primary keys and foreign keys</h2><p id="7a5f" class="pw-post-body-paragraph mj mk fq ml b go pc mn mo gr pd mq mr ms pe mu mv mw pf my mz na pg nc nd ne fj bk">Since <a class="af nf" href="https://cloud.google.com/blog/products/data-analytics/join-optimizations-with-bigquery-primary-and-foreign-keys?hl=en" rel="noopener ugc nofollow" target="_blank">July 2023, BigQuery introduced unenforced Primary Key and Foreign Key constraints</a>. Keep in mind that BigQuery is not a classical RDBMS, even though defining a data model with this feature might give you the feeling that it is.</p><p id="722e" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">If the keys are not enforced and this is not a relational database as we know it, what is the point? The answer is: the query optimizer may use this information to better optimize queries, namely with the concepts of Inner Join Elimination, Outer Join Elimination and Join Reordering.</p><p id="5275" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Defining constraints is similar to other SQL dialects, just that you have to specify them as <code class="cx qa qb qc qd b">NOT ENFORCED</code>:</p><pre class="np nq nr ns nt qx qd qy bp qz bb bk"><span id="77d7" class="ra oh fq qd b bg rb rc l rd re">CREATE TABLE gold.inventory (<br/> date INT64 REFERENCES dim_date(id) NOT ENFORCED,<br/> item INT64 REFERENCES item(id) NOT ENFORCED,<br/> warehouse INT64 REFERENCES warehouse(id) NOT ENFORCED,<br/> quantity INT64,<br/> PRIMARY KEY(date, item, warehouse) NOT ENFORCED<br/>);</span></pre><h1 id="6bae" class="og oh fq bf oi oj ok gq ol om on gt oo op oq or os ot ou ov ow ox oy oz pa pb bk">⚙️ Data operations</h1><h2 id="28ad" class="qe oh fq bf oi qf qg qh ol qi qj qk oo ms ql qm qn mw qo qp qq na qr qs qt qu bk">Copy data / tables</h2><p id="bd6b" class="pw-post-body-paragraph mj mk fq ml b go pc mn mo gr pd mq mr ms pe mu mv mw pf my mz na pg nc nd ne fj bk">Copying data from one place to another is a typical part of our daily business as Data Engineers. Let’s assume the task is to copy data from a BigQuery dataset called <code class="cx qa qb qc qd b">bronze</code> to another dataset called <code class="cx qa qb qc qd b">silver</code> within a Google Cloud Platform project called <code class="cx qa qb qc qd b">project_x</code>. The naive approach would be a simple SQL query like:</p><pre class="np nq nr ns nt qx qd qy bp qz bb bk"><span id="ada7" class="ra oh fq qd b bg rb rc l rd re">CREATE OR REPLACE TABLE project_x.silver.login_count AS<br/>SELECT<br/>    user_id,<br/>    platform,<br/>    login_count,<br/>    day<br/>FROM project_x.bronze.login_count;</span></pre><p id="01a8" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Even though this allows for transformation, in many cases we simply want to copy data from one place to another. The bytes billed for the query above would essentially be the amount of data we have to read from the source. However, we can also get this <strong class="ml fr">for free</strong> with the following query:</p><pre class="np nq nr ns nt qx qd qy bp qz bb bk"><span id="9e66" class="ra oh fq qd b bg rb rc l rd re">CREATE TABLE project_x.silver.login_count<br/>COPY project_x.bronze.login_count;</span></pre><p id="6b7a" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Alternatively, the <code class="cx qa qb qc qd b">bq</code> CLI tool can be used to achieve the same result:</p><pre class="np nq nr ns nt qx qd qy bp qz bb bk"><span id="4460" class="ra oh fq qd b bg rb rc l rd re">bq cp project_x:bronze.login_count project_x:silver.login_count</span></pre><p id="6211" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">That way, you can copy data for <strong class="ml fr">0 costs</strong>.</p><h2 id="da01" class="qe oh fq bf oi qf qg qh ol qi qj qk oo ms ql qm qn mw qo qp qq na qr qs qt qu bk">Load data</h2><p id="3816" class="pw-post-body-paragraph mj mk fq ml b go pc mn mo gr pd mq mr ms pe mu mv mw pf my mz na pg nc nd ne fj bk">For data ingestion Google Cloud Storage is a pragmatic way to solve the task. No matter if it is a CSV file, ORC / Parquet files from a Hadoop ecosystem or any other source. Data can easily be uploaded and stored for low costs.</p><p id="e51f" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">It is also possible to create BigQuery tables on top of data stored in GCS. These <strong class="ml fr">external</strong> tables still utilize the compute infrastructure from BigQuery but do not offer some of the features and performance.</p><p id="ffae" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Let’s assume we upload data from a partitioned Hive table using the ORC storage format. Uploading the data can be achieved using <code class="cx qa qb qc qd b">distcp</code> or simply by getting the data from HDFS first and then uploading it to GCS using one of the available CLI tools to interact with Cloud Storage.</p><p id="e834" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Assuming we have a partition structure including one partition called month, the files might look like the following:</p><pre class="np nq nr ns nt qx qd qy bp qz bb bk"><span id="4ecd" class="ra oh fq qd b bg rb rc l rd re">/some_orc_table/month=2024-01/000000_0.orc<br/>/some_orc_table/month=2024-01/000000_1.orc<br/>/some_orc_table/month=2024-02/000000_0.orc</span></pre><p id="be16" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">When we uploaded this data to GCS, an external table definition can be created like this:</p><pre class="np nq nr ns nt qx qd qy bp qz bb bk"><span id="e1cc" class="ra oh fq qd b bg rb rc l rd re">CREATE EXTERNAL TABLE IF NOT EXISTS project_x.bronze.some_orc_table<br/>WITH PARTITION COLUMNS<br/>OPTIONS(<br/>  format="ORC",<br/>  hive_partition_uri_prefix="gs://project_x/ingest/some_orc_table",<br/>  uris=["gs://project_x/ingest/some_orc_table/*"]<br/>);</span></pre><p id="3d38" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">It will derive the schema from the ORC files and even detect the partition column. The naive approach to move this data from GCS to BigQuery storage might now be, to create a table in BigQuery and then follow the pragmatic <code class="cx qa qb qc qd b">INSERT INTO ... SELECT FROM</code> approach.</p><p id="24fb" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">However, similar to the previous example, the bytes billed would reflect the amount of data stored in <code class="cx qa qb qc qd b">gs://project_x/ingest/some_orc_table</code>. There is another way, which will achieve the same result but again for <strong class="ml fr">0 costs</strong> using the <code class="cx qa qb qc qd b">LOAD DATA</code> SQL statement.</p><pre class="np nq nr ns nt qx qd qy bp qz bb bk"><span id="5be8" class="ra oh fq qd b bg rb rc l rd re">LOAD DATA OVERWRITE project_x.silver.some_orc_table (<br/>  user_id INT64,<br/>  column_1 STRING,<br/>  column_2 STRING,<br/>  some_value INT64<br/>)<br/>CLUSTER BY column_1, column_2<br/>FROM FILES (<br/>  format="ORC",<br/>  hive_partition_uri_prefix="gs://project_x/ingest/some_orc_table",<br/>  uris=["gs://project_x/ingest/some_orc_table/*"]<br/>)<br/>WITH PARTITION COLUMNS (<br/>  month STRING<br/>);</span></pre><p id="6ada" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Using this statement, we directly get a BigQuery table with the data ingested, <strong class="ml fr">no need to create an external table first</strong>! Also this query comes at <strong class="ml fr">0 costs</strong>. The <code class="cx qa qb qc qd b">OVERWRITE</code> is optional, since data can also be appended instead of overwriting the table on every run.</p><p id="fb93" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">As you can see, also the partition columns can be specified. Even though no transformation can be applied, there is one major advantage: we can already define cluster columns. That way, we can create an efficient version of the target table for further downstream processing, for free!</p><h2 id="0ef6" class="qe oh fq bf oi qf qg qh ol qi qj qk oo ms ql qm qn mw qo qp qq na qr qs qt qu bk">Delete partitions</h2><p id="976f" class="pw-post-body-paragraph mj mk fq ml b go pc mn mo gr pd mq mr ms pe mu mv mw pf my mz na pg nc nd ne fj bk">In certain ETL or ELT scenarios, a typical workflow is to have a table partitioned by day and then replace specific partitions based on new data coming from a staging / ingestion table.</p><figure class="np nq nr ns nt ng nm nn paragraph-image"><div role="button" tabindex="0" class="nw nx ed ny bh nz"><div class="nm nn ru"><img src="../Images/c0c962a5f17c681e88a437f318b19468.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XjkzE9fS1uf9jaeEnMh6GQ.png"/></div></div><figcaption class="ob oc od nm nn oe of bf b bg z dx">Ingest partition example (by author)</figcaption></figure><p id="a98c" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">BigQuery offers the <code class="cx qa qb qc qd b">MERGE</code> statement but the naive approach is to first delete the affected partitions from the target table and then insert the data.</p><p id="c95b" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Deleting partitions in such a scenario can be achieved like this:</p><pre class="np nq nr ns nt qx qd qy bp qz bb bk"><span id="bedf" class="ra oh fq qd b bg rb rc l rd re">DELETE FROM silver.target WHERE day IN (<br/>  SELECT DISTINCT day<br/>  FROM bronze.ingest<br/>);</span></pre><p id="33ad" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Even if <code class="cx qa qb qc qd b">day</code> is a partition column in both cases, this operation is connected to several costs. However, again there is an alternative solution that comes at <strong class="ml fr">0 costs</strong> again:</p><pre class="np nq nr ns nt qx qd qy bp qz bb bk"><span id="61b0" class="ra oh fq qd b bg rb rc l rd re">DROP TABLE silver.target$20240101</span></pre><p id="d5e7" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">With <code class="cx qa qb qc qd b">DROP TABLE</code> you can actually also just drop one single partition by appending the suffix <code class="cx qa qb qc qd b">$&lt;partition_id&gt;</code>.</p><p id="56b1" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Of course the above example is just dropping one partition. However, with the procedual language from BigQuery, we can easily execute the statement in a loop.</p><pre class="np nq nr ns nt qx qd qy bp qz bb bk"><span id="1a93" class="ra oh fq qd b bg rb rc l rd re">FOR x IN (SELECT DISTINCT day FROM bronze.ingest)<br/>DO<br/>  SELECT x; -- replace with DROP TABLE<br/>END FOR;</span></pre><p id="4e1f" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Or alternatively use Airflow and/or dbt to first select the partitions and then run a certain templated query in a loop.</p><p id="eed6" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">However, getting the distinct partitions for a partitioned table can be done like the in the examples above, but this will still cause some costs even if we only read a single column. But yet again, there is a way to get this almost for free, which we will explore in the next chapter.</p><h2 id="0c4d" class="qe oh fq bf oi qf qg qh ol qi qj qk oo ms ql qm qn mw qo qp qq na qr qs qt qu bk">Get distinct partitions for a table</h2><p id="5b97" class="pw-post-body-paragraph mj mk fq ml b go pc mn mo gr pd mq mr ms pe mu mv mw pf my mz na pg nc nd ne fj bk">In the examples above, we used the following approach to get the distinct partitions of a partitioned BigQuery table:</p><pre class="np nq nr ns nt qx qd qy bp qz bb bk"><span id="4401" class="ra oh fq qd b bg rb rc l rd re">SELECT DISTINCT day<br/>FROM bronze.ingest</span></pre><p id="3334" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">This is how much the query cost me in an example use-case I worked on:</p><pre class="np nq nr ns nt qx qd qy bp qz bb bk"><span id="3cf3" class="ra oh fq qd b bg rb rc l rd re">Bytes billed: 149.14 GB (= $1.18 depending on location)</span></pre><p id="36df" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">BigQuery maintains a lot of valuable metadata about tables, columns and partitions. This can be accessed via the <code class="cx qa qb qc qd b">INFORMATION_SCHEMA</code>. We can achieve the very same result, by simply using this metadata:</p><pre class="np nq nr ns nt qx qd qy bp qz bb bk"><span id="49cc" class="ra oh fq qd b bg rb rc l rd re">SELECT PARSE_DATE('%Y%m%d', partition_id) AS day<br/>FROM bronze.INFORMATION_SCHEMA.PARTITIONS<br/>WHERE table_name = 'ingest'</span></pre><p id="14ad" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">And comparing it with the same use-case as I mentioned above, this is how much the query cost:</p><pre class="np nq nr ns nt qx qd qy bp qz bb bk"><span id="4755" class="ra oh fq qd b bg rb rc l rd re">Bytes billed: 10 MB (= $0.00008 depending on location)</span></pre><p id="539c" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">As you can see, 149GB vs 10MB is a huge difference. With this method, you can get the distinct partitions even for huge tables at <strong class="ml fr">almost 0 costs</strong>.</p><h2 id="3ae7" class="qe oh fq bf oi qf qg qh ol qi qj qk oo ms ql qm qn mw qo qp qq na qr qs qt qu bk">Do not persist calculated measures</h2><p id="d4b5" class="pw-post-body-paragraph mj mk fq ml b go pc mn mo gr pd mq mr ms pe mu mv mw pf my mz na pg nc nd ne fj bk">When you start using BigQuery for the first projects, you will most likely stick with the on-demand compute pricing model. With on-demand pricing, you will generally have access to up to 2000 concurrent slots, shared among all queries in a single project. But even with capacity pricing, you will have a minimum of 100 slots.</p><p id="ef9c" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">With a lot of the daily ETL / ELT workload, these slots are actually not the limitation of the performance. You can simply check this yourself by navigating to BigQuery -&gt; Administration -&gt; Monitoring, select the correct location and change the Chart to <em class="pv">Slot Usage</em> under <em class="pv">Chart Configuration</em>. In a lot of cases you will be surprised how little slots you are actually using.</p><figure class="np nq nr ns nt ng nm nn paragraph-image"><div role="button" tabindex="0" class="nw nx ed ny bh nz"><div class="nm nn rv"><img src="../Images/3b574cfdb6e528945373257885f71b59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wae3vmnXPTCWhY0oJPzuNQ.png"/></div></div><figcaption class="ob oc od nm nn oe of bf b bg z dx">BigQuery Monitoring for slots</figcaption></figure><p id="0677" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">How does that relate to saving costs? Let’s assume you have a classic fact table or some table in general, which delivers certain KPIs. This table is then used for analysis / reporting in Looker, Excel, PowerBI or other tools.</p><p id="f9a2" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Often these tools automatically generate queries to serve the report or dashboard with the necessary data. These generated queries might not be ideal, when it comes to applying BigQuery best practices. In other words, they might end up scanning more data than necessary which increases the bytes billed.</p><p id="9286" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">We can avoid this, by introducing a view layer on top of our fact tables. Serving tools with data from a view rather than the actual table is a very valuable best practice, as it gives you more flexibility when it comes to schema changes but it also gives the possibility to introduce calculated measures within the view without persisting the data.</p><p id="2b10" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Of course this might increase the CPU usage when these measures are used but on the other hand, it can drastically reduce the total size of the underlying table.</p><p id="aedc" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">To illustrate this principle, take the following fact table as a basis:</p><pre class="np nq nr ns nt qx qd qy bp qz bb bk"><span id="ccd2" class="ra oh fq qd b bg rb rc l rd re">CREATE TABLE IF NOT EXISTS gold.some_fact_table (<br/>  user_id INT64,<br/>  payment_count INT64,<br/>  value_1 INT64,<br/>  value_2 INT64,<br/>  day DATE<br/>)<br/>PARTITION BY day<br/>CLUSTER BY user_id<br/>OPTIONS (<br/>  partition_expiration_days = 365<br/>);</span></pre><p id="e15f" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">The basic idea is to introduce a view for stakeholders accessing this data and extend it with calculated measures:</p><pre class="np nq nr ns nt qx qd qy bp qz bb bk"><span id="bb2d" class="ra oh fq qd b bg rb rc l rd re">CREATE OR REPLACE VIEW gold.some_fact_view AS<br/>SELECT<br/>  user_id,<br/>  payment_count,<br/>  value_1,<br/>  value_2,<br/>  payment_count &gt; 0 AS is_paying_user,<br/>  value_1 + value_2 AS total_value,<br/>  day<br/>FROM gold.some_fact_table;</span></pre><p id="412e" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">In this example we were able to avoid persisting two <code class="cx qa qb qc qd b">INT64</code> values. One of these uses 8 logical bytes. If our fact table has 1,000,000,000 rows this would mean we save:</p><pre class="np nq nr ns nt qx qd qy bp qz bb bk"><span id="b193" class="ra oh fq qd b bg rb rc l rd re">1000000000 rows * 8 B * 2 columns / 1024 / 1024 / 1024 = 15 GB</span></pre><p id="c218" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">This is not a huge amount of data, but it can mean that BigQuery has to scan 15 GB less data in certain situations. In practice, there can be calculated measures that might save you much more data to be scanned.</p><h1 id="59d4" class="og oh fq bf oi oj ok gq ol om on gt oo op oq or os ot ou ov ow ox oy oz pa pb bk">📚 Summary</h1><p id="5749" class="pw-post-body-paragraph mj mk fq ml b go pc mn mo gr pd mq mr ms pe mu mv mw pf my mz na pg nc nd ne fj bk">Forget hoarding every byte like a dragon guarding its treasure. Instead, learn to burn data through smart management and optimization 🔥. By embracing this fiery approach, you’ll transform BigQuery from a cost center to a powerful engine for data exploration, allowing you to burn data, not money!</p><h2 id="165f" class="qe oh fq bf oi qf qg qh ol qi qj qk oo ms ql qm qn mw qo qp qq na qr qs qt qu bk">Embrace data modeling best practices</h2><ul class=""><li id="22c5" class="mj mk fq ml b go pc mn mo gr pd mq mr ms pe mu mv mw pf my mz na pg nc nd ne ri rj rk bk">Utilize the smallest data types possible to minimize storage and processing costs.</li><li id="2411" class="mj mk fq ml b go rl mn mo gr rm mq mr ms rn mu mv mw ro my mz na rp nc nd ne ri rj rk bk">Leverage de-normalization when appropriate to optimize query performance and reduce storage usage.</li><li id="09b2" class="mj mk fq ml b go rl mn mo gr rm mq mr ms rn mu mv mw ro my mz na rp nc nd ne ri rj rk bk">Implement partitioning and clustering to enable BigQuery to efficiently scan only the relevant data for your queries.</li><li id="c36c" class="mj mk fq ml b go rl mn mo gr rm mq mr ms rn mu mv mw ro my mz na rp nc nd ne ri rj rk bk">Explore nested repeated columns as a way to eliminate redundancy while maintaining data integrity, but be mindful of limitations regarding clustering.</li></ul><h2 id="8018" class="qe oh fq bf oi qf qg qh ol qi qj qk oo ms ql qm qn mw qo qp qq na qr qs qt qu bk">Master data operations for cost-effectiveness</h2><ul class=""><li id="fc14" class="mj mk fq ml b go pc mn mo gr pd mq mr ms pe mu mv mw pf my mz na pg nc nd ne ri rj rk bk">Employ <code class="cx qa qb qc qd b">CREATE TABLE ... COPY</code> or <code class="cx qa qb qc qd b">bq cp</code> commands to copy data between tables without incurring charges.</li><li id="ae56" class="mj mk fq ml b go rl mn mo gr rm mq mr ms rn mu mv mw ro my mz na rp nc nd ne ri rj rk bk">Utilize <code class="cx qa qb qc qd b">LOAD DATA</code> statements to directly load data from Cloud Storage into BigQuery tables, again at no cost.</li><li id="1902" class="mj mk fq ml b go rl mn mo gr rm mq mr ms rn mu mv mw ro my mz na rp nc nd ne ri rj rk bk">Leverage the power of <code class="cx qa qb qc qd b">DROP TABLE</code> with partition suffixes to efficiently remove specific partitions.</li><li id="4f7c" class="mj mk fq ml b go rl mn mo gr rm mq mr ms rn mu mv mw ro my mz na rp nc nd ne ri rj rk bk">Utilize <code class="cx qa qb qc qd b">INFORMATION_SCHEMA</code> to retrieve table metadata like distinct partition values, significantly reducing costs compared to traditional queries.</li></ul><h2 id="af6f" class="qe oh fq bf oi qf qg qh ol qi qj qk oo ms ql qm qn mw qo qp qq na qr qs qt qu bk">Design for efficiency and avoid unnecessary data persistence</h2><ul class=""><li id="c49d" class="mj mk fq ml b go pc mn mo gr pd mq mr ms pe mu mv mw pf my mz na pg nc nd ne ri rj rk bk">Implement a view layer to serve data with calculated measures, preventing the storage of redundant data.</li><li id="a98d" class="mj mk fq ml b go rl mn mo gr rm mq mr ms rn mu mv mw ro my mz na rp nc nd ne ri rj rk bk">Monitor your BigQuery slot usage to understand if slot limitations are a concern, allowing you to focus on optimizing query structures.</li></ul><blockquote class="pw px py"><p id="8801" class="mj mk pv ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk"><strong class="ml fr"><em class="fq">By adopting these strategies, you can unlock the true potential of BigQuery, transforming it into a cost-effective engine for data exploration and analysis. Remember, in the realm of BigQuery, it’s all about burning data, not money!</em></strong></p></blockquote><p id="8404" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk"><strong class="ml fr">Feel free to share your experiences in the comments!</strong></p></div></div></div></div>    
</body>
</html>