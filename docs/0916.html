<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Design an Easy-to-Use Deep Learning Framework</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Design an Easy-to-Use Deep Learning Framework</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/design-an-easy-to-use-deep-learning-framework-52d7c37e415f?source=collection_archive---------6-----------------------#2024-04-10">https://towardsdatascience.com/design-an-easy-to-use-deep-learning-framework-52d7c37e415f?source=collection_archive---------6-----------------------#2024-04-10</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="7e95" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx">The three software design principles I learned as an open-source contributor</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hd he hf hg hh ab"><div><div class="ab hi"><div><div class="bm" aria-hidden="false"><a href="https://haifeng-jin.medium.com/?source=post_page---byline--52d7c37e415f--------------------------------" rel="noopener follow"><div class="l hj hk by hl hm"><div class="l ed"><img alt="Haifeng Jin" class="l ep by dd de cx" src="../Images/705d6ecaed975b6376fac19087f2c02c.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/1*RMJMO_yegbLzax5fZyaPBw.png"/><div class="hn by l dd de em n ho eo"/></div></div></a></div></div><div class="hp ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--52d7c37e415f--------------------------------" rel="noopener follow"><div class="l hq hr by hl hs"><div class="l ed"><img alt="Towards Data Science" class="l ep by br ht cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hn by l br ht em n ho eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hu ab q"><div class="ab q hv"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hw hx bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hy" data-testid="authorName" href="https://haifeng-jin.medium.com/?source=post_page---byline--52d7c37e415f--------------------------------" rel="noopener follow">Haifeng Jin</a></p></div></div></div><div class="hz ia l"><div class="ab ib"><div class="ab"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewbox="0 0 16 16"><path fill="#437AFF" d="M15.163 8c0 .65-.459 1.144-.863 1.575-.232.244-.471.5-.563.719s-.086.543-.092.875c-.006.606-.018 1.3-.49 1.781-.47.481-1.15.494-1.744.5-.324.006-.655.013-.857.094s-.465.337-.704.575c-.422.412-.906.881-1.542.881-.637 0-1.12-.469-1.543-.881-.239-.238-.49-.482-.704-.575-.214-.094-.532-.088-.857-.094-.593-.006-1.273-.019-1.744-.5s-.484-1.175-.49-1.781c-.006-.332-.012-.669-.092-.875-.08-.207-.33-.475-.563-.719-.404-.431-.863-.925-.863-1.575s.46-1.144.863-1.575c.233-.244.472-.5.563-.719.092-.219.086-.544.092-.875.006-.606.019-1.3.49-1.781s1.15-.494 1.744-.5c.325-.006.655-.012.857-.094.202-.081.465-.337.704-.575C7.188 1.47 7.671 1 8.308 1s1.12.469 1.542.881c.239.238.49.481.704.575s.533.088.857.094c.594.006 1.273.019 1.745.5.47.481.483 1.175.49 1.781.005.331.011.669.091.875s.33.475.563.719c.404.431.863.925.863 1.575"/><path fill="#fff" d="M7.328 10.5c.195 0 .381.08.519.22.137.141.215.331.216.53 0 .066.026.13.072.177a.24.24 0 0 0 .346 0 .25.25 0 0 0 .071-.177c.001-.199.079-.389.216-.53a.73.73 0 0 1 .519-.22h1.959c.13 0 .254-.053.346-.146a.5.5 0 0 0 .143-.354V6a.5.5 0 0 0-.143-.354.49.49 0 0 0-.346-.146h-1.47c-.324 0-.635.132-.865.366-.23.235-.359.552-.359.884v2.5c0 .066-.025.13-.071.177a.24.24 0 0 1-.346 0 .25.25 0 0 1-.072-.177v-2.5c0-.332-.13-.65-.359-.884A1.21 1.21 0 0 0 6.84 5.5h-1.47a.49.49 0 0 0-.346.146A.5.5 0 0 0 4.88 6v4c0 .133.051.26.143.354a.49.49 0 0 0 .347.146z"/></svg></div></div></div><span class="ic id" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hw hx dx"><button class="ie if ah ai aj ak al am an ao ap aq ar ig ih ii" disabled="">Follow</button></p></div></div></span></div></div><div class="l ij"><span class="bf b bg z dx"><div class="ab cn ik il im"><div class="in io ab"><div class="bf b bg z dx ab ip"><span class="iq l ij">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hy ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--52d7c37e415f--------------------------------" rel="noopener follow"><p class="bf b bg z ir is it iu iv iw ix iy bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="ic id" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">9 min read</span><div class="iz ja l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Apr 10, 2024</span></div></span></div></span></div></div></div><div class="ab cp jb jc jd je jf jg jh ji jj jk jl jm jn jo jp jq"><div class="h k w ea eb q"><div class="kg l"><div class="ab q kh ki"><div class="pw-multi-vote-icon ed iq kj kk kl"><div class=""><div class="km kn ko kp kq kr ks am kt ku kv kl"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kw kx ky kz la lb lc"><p class="bf b dy z dx"><span class="kn">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao km lf lg ab q ee lh li" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="le"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg><p class="bf b dy z dx"><span class="pw-responses-count ld le">1</span></p></button></div></div></div><div class="ab q jr js jt ju jv jw jx jy jz ka kb kc kd ke kf"><div class="lj k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lk an ao ap ig ll lm ln" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep lo cn"><div class="l ae"><div class="ab cb"><div class="lp lq lr ls lt lu ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lk an ao ap ig lv lw li lx ly lz ma mb s mc md me mf mg mh mi u mj mk ml"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lk an ao ap ig lv lw li lx ly lz ma mb s mc md me mf mg mh mi u mj mk ml"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lk an ao ap ig lv lw li lx ly lz ma mb s mc md me mf mg mh mi u mj mk ml"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><figure class="mp mq mr ms mt mu mm mn paragraph-image"><div role="button" tabindex="0" class="mv mw ed mx bh my"><div class="mm mn mo"><img src="../Images/f0f2539047f9ad89bd753971d4f517d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*KI_sWjoAdwTBGKh2"/></div></div><figcaption class="na nb nc mm mn nd ne bf b bg z dx">Photo by <a class="af nf" href="https://unsplash.com/@hfestudio?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Sheldon</a> on <a class="af nf" href="https://unsplash.com/?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="26b0" class="pw-post-body-paragraph ng nh fq ni b go nj nk nl gr nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">Deep learning frameworks are extremely transitory. If you compare the deep learning frameworks people use today with what it was eight years ago, you will find the landscape is completely different. There were Theano, Caffe2, and MXNet, which all went obsolete. Today's most popular frameworks, like TensorFlow and PyTorch, were just released to the public.</p><p id="1714" class="pw-post-body-paragraph ng nh fq ni b go nj nk nl gr nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">Through all these years, Keras has survived as a high-level user-facing library supporting different backends, including TensorFlow, PyTorch, and JAX. As a contributor to Keras, I learned how much the team cares about user experience for the software and how they ensured a good user experience by following a few simple yet powerful principles in their design process.</p><p id="d517" class="pw-post-body-paragraph ng nh fq ni b go nj nk nl gr nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">In this article, I will share the 3 most important software design principles I learned by contributing to the Keras through the past few years, which may be generalizable to all types of software and help you make an impact in the open-source community with yours.</p><h2 id="cf1a" class="oc od fq bf oe of og oh oi oj ok ol om np on oo op nt oq or os nx ot ou ov ow bk">Why user experience is important for open-source software</h2><p id="1dee" class="pw-post-body-paragraph ng nh fq ni b go ox nk nl gr oy nn no np oz nr ns nt pa nv nw nx pb nz oa ob fj bk">Before we dive into the main content, let’s quickly discuss why user experience is so important. We can learn this through the PyTorch vs. TensorFlow case.</p><p id="91d1" class="pw-post-body-paragraph ng nh fq ni b go nj nk nl gr nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">They were developed by two tech giants, Meta and Google, and have quite different cultural strengths. Meta is good at product, while Google is good at engineering. As a result, Google’s frameworks like TensorFlow and JAX are the fastest to run and technically superior to PyTorch, as they support sparse tensors and distributed training well. However, PyTorch still took away half of the market share from TensorFlow because it prioritizes user experience over other aspects of the software.</p><p id="045d" class="pw-post-body-paragraph ng nh fq ni b go nj nk nl gr nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">Better user experience wins for the research scientists who build the models and propagate them to the engineers, who take models from them since they don’t always want to convert the models they receive from the research scientists to another framework. They will build new software around PyTorch to smooth their workflow, which will establish a software ecosystem around PyTorch.</p><p id="61a7" class="pw-post-body-paragraph ng nh fq ni b go nj nk nl gr nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">TensorFlow also made a few blunders that caused its users to lose. TensorFlow’s general user experience is good. However, its installation guide for GPU support was broken for years before it was fixed in 2022. TensorFlow 2 broke the backward compatibility, which cost its users millions of dollars to migrate.</p><p id="6f4d" class="pw-post-body-paragraph ng nh fq ni b go nj nk nl gr nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">So, the lesson we learned here is that despite technical superiority, user experience decides which software the open-source users would choose.</p><h2 id="5e78" class="oc od fq bf oe of og oh oi oj ok ol om np on oo op nt oq or os nx ot ou ov ow bk">All deep learning frameworks invest heavily in user experience</h2><p id="ee0d" class="pw-post-body-paragraph ng nh fq ni b go ox nk nl gr oy nn no np oz nr ns nt pa nv nw nx pb nz oa ob fj bk">All the deep learning frameworks—TensorFlow, PyTorch, and JAX—invest heavily in user experience. Good evidence is that they all have a relatively high Python percentage in their codebases.</p><p id="df4f" class="pw-post-body-paragraph ng nh fq ni b go nj nk nl gr nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">All the core logic of deep learning frameworks, including tensor operations, automatic differentiation, compilation, and distribution are implemented in C++. Why would they want to expose a set of Python APIs to the users? It is just because the users love Python and they want to polish their user experience.</p><h2 id="fd72" class="oc od fq bf oe of og oh oi oj ok ol om np on oo op nt oq or os nx ot ou ov ow bk">Investing in user experience is of high ROI</h2><p id="e699" class="pw-post-body-paragraph ng nh fq ni b go ox nk nl gr oy nn no np oz nr ns nt pa nv nw nx pb nz oa ob fj bk">Imagine how much engineering effort it requires to make your deep learning framework a little bit faster than others. A lot.</p><p id="87b2" class="pw-post-body-paragraph ng nh fq ni b go nj nk nl gr nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">However, for a better user experience, as long as you follow a certain design process and some principles, you can achieve it. For attracting more users, your user experience is as important as the computing efficiency of your framework. So, investing in user experience is of high return on investment (ROI).</p><h2 id="fd3b" class="oc od fq bf oe of og oh oi oj ok ol om np on oo op nt oq or os nx ot ou ov ow bk">The three principles</h2><p id="20a0" class="pw-post-body-paragraph ng nh fq ni b go ox nk nl gr oy nn no np oz nr ns nt pa nv nw nx pb nz oa ob fj bk">I will share the three important software design principles I learned by contributing to Keras, each with good and bad code examples from different frameworks.</p><h2 id="9a94" class="oc od fq bf oe of og oh oi oj ok ol om np on oo op nt oq or os nx ot ou ov ow bk">Principle 1: Design end-to-end workflows</h2><p id="02b1" class="pw-post-body-paragraph ng nh fq ni b go ox nk nl gr oy nn no np oz nr ns nt pa nv nw nx pb nz oa ob fj bk">When we think of designing the APIs of a piece of software, you may look like this.</p><pre class="mp mq mr ms mt pc pd pe bp pf bb bk"><span id="cb8a" class="pg od fq pd b bg ph pi l pj pk">class Model:<br/>    def __call__(self, input):<br/>        """The forward call of the model.<br/><br/>        Args:<br/>          input: A tensor. The input to the model.<br/>        """<br/>        pass</span></pre><p id="cfc5" class="pw-post-body-paragraph ng nh fq ni b go nj nk nl gr nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">Define the class and add the documentation. Now, we know all the class names, method names, and arguments. However, this would not help us understand much about the user experience.</p><p id="e939" class="pw-post-body-paragraph ng nh fq ni b go nj nk nl gr nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">What we should do is something like this.</p><pre class="mp mq mr ms mt pc pd pe bp pf bb bk"><span id="040d" class="pg od fq pd b bg ph pi l pj pk">input = keras.Input(shape=(10,))<br/>x = layers.Dense(32, activation='relu')(input)<br/>output = layers.Dense(10, activation='softmax')(x)<br/>model = keras.models.Model(inputs=input, outputs=output)<br/>model.compile(<br/>    optimizer='adam', loss='categorical_crossentropy'<br/>)</span></pre><p id="bc8d" class="pw-post-body-paragraph ng nh fq ni b go nj nk nl gr nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">We want to write out the entire user workflow of using the software. Ideally, it should be a tutorial on how to use the software. It provides much more information about the user experience. It may help us spot many more UX problems during the design phase compared with just writing out the class and methods.</p><p id="c12a" class="pw-post-body-paragraph ng nh fq ni b go nj nk nl gr nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">Let’s look at another example. This is how I discovered a user experience problem by following this principle when implementing KerasTuner.</p><p id="1fbe" class="pw-post-body-paragraph ng nh fq ni b go nj nk nl gr nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">When using KerasTuner, users can use this RandomSearch class to select the best model. We have the metrics, and objectives in the arguments. By default, objective equals validation loss. So, it helps us find the model with the smallest validation loss.</p><pre class="mp mq mr ms mt pc pd pe bp pf bb bk"><span id="8346" class="pg od fq pd b bg ph pi l pj pk">class RandomSearch:<br/>    def __init__(self, ..., metrics, objective="val_loss", ...):<br/>        """The initializer.<br/><br/>        Args:<br/>            metrics: A list of Keras metrics.<br/>            objective: String or a custom metric function. The<br/>                name of the metirc we want to minimize.<br/>        """<br/>        pass</span></pre><p id="9838" class="pw-post-body-paragraph ng nh fq ni b go nj nk nl gr nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">Again, it doesn’t provide much information about the user experience. So, everything looks OK for now.</p><p id="a4db" class="pw-post-body-paragraph ng nh fq ni b go nj nk nl gr nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">However, if we write an end-to-end workflow like the following. It exposes many more problems. The user is trying to define a custom metric function named custom_metric. The objective is not so straightforward to use anymore. What should we pass to the objective argument now?</p><pre class="mp mq mr ms mt pc pd pe bp pf bb bk"><span id="4f5c" class="pg od fq pd b bg ph pi l pj pk">tuner = RandomSearch(<br/>    ...,<br/>    metrics=[custom_metric],<br/>    objective="val_???",<br/>)</span></pre><p id="d78f" class="pw-post-body-paragraph ng nh fq ni b go nj nk nl gr nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">It should be just <code class="cx pl pm pn pd b">"val_custom_metric”</code>. Just use the prefix of <code class="cx pl pm pn pd b">"val_"</code> and the name of the metric function. It is not intuitive enough. We want to make it better instead of forcing the user to learn this. We easily spotted a user experience problem by writing this workflow.</p><p id="e236" class="pw-post-body-paragraph ng nh fq ni b go nj nk nl gr nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">If you wrote the design more comprehensively by including the implementation of the <code class="cx pl pm pn pd b">custom_metric</code> function, you will find you even need to learn how to write a Keras custom metric. You have to follow the function signature to make it work, as shown in the following code snippet.</p><pre class="mp mq mr ms mt pc pd pe bp pf bb bk"><span id="ecd1" class="pg od fq pd b bg ph pi l pj pk">def custom_metric(y_true, y_pred):<br/>    squared_diff = ops.square(y_true - y_pred)<br/>    return ops.mean(squared_diff, axis=-1)</span></pre><p id="8431" class="pw-post-body-paragraph ng nh fq ni b go nj nk nl gr nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">After discovering this problem. We specially designed a better workflow for custom metrics. You only need to override <code class="cx pl pm pn pd b">HyperModel.fit()</code> to compute your custom metric and return it. No strings to name the objective. No function signature to follow. Just a return value. The user experience is much better right now.</p><pre class="mp mq mr ms mt pc pd pe bp pf bb bk"><span id="d0f9" class="pg od fq pd b bg ph pi l pj pk">class MyHyperModel(HyperModel):<br/>    def fit(self, trial, model, validation_data):<br/>        x_val, y_true = validation_data<br/>        y_pred = model(x_val)<br/>        return custom_metric(y_true, y_pred)<br/><br/>tuner = RandomSearch(MyHyperModel(), max_trials=20)</span></pre><p id="ef5f" class="pw-post-body-paragraph ng nh fq ni b go nj nk nl gr nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">One more thing to remember is we should always start from the user experience. The designed workflows backpropagate to the implementation.</p><h2 id="e830" class="oc od fq bf oe of og oh oi oj ok ol om np on oo op nt oq or os nx ot ou ov ow bk">Principle 2: Minimize cognitive load</h2><p id="2ab0" class="pw-post-body-paragraph ng nh fq ni b go ox nk nl gr oy nn no np oz nr ns nt pa nv nw nx pb nz oa ob fj bk">Do not force the user to learn anything unless it is really necessary. Let’s see some good examples.</p><p id="6c8c" class="pw-post-body-paragraph ng nh fq ni b go nj nk nl gr nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">The Keras modeling API is a good example shown in the following code snippet. The model builders already have these concepts in mind, for example, a model is a stack of layers. It needs a loss function. We can fit it with data or make it predict on data.</p><pre class="mp mq mr ms mt pc pd pe bp pf bb bk"><span id="694f" class="pg od fq pd b bg ph pi l pj pk">model = keras.Sequential([<br/>    layers.Dense(10, activation="relu"),<br/>    layers.Dense(num_classes, activation="softmax"),<br/>])<br/>model.compile(loss='categorical_crossentropy')<br/>model.fit(...)<br/>model.predict(...)</span></pre><p id="88ca" class="pw-post-body-paragraph ng nh fq ni b go nj nk nl gr nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">So basically, no new concepts were learned to use Keras.</p><p id="f770" class="pw-post-body-paragraph ng nh fq ni b go nj nk nl gr nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">Another good example is the PyTorch modeling. The code is executed just like Python code. All tensors are just real tensors with real values. You can depend on the value of a tensor to decide your path with plain Python code.</p><pre class="mp mq mr ms mt pc pd pe bp pf bb bk"><span id="e5c2" class="pg od fq pd b bg ph pi l pj pk">class MyModel(nn.Module):<br/>    def forward(self, x):<br/>        if x.sum() &gt; 0:<br/>            return self.path_a(x)<br/>        return self.path_b(x)</span></pre><p id="ee1d" class="pw-post-body-paragraph ng nh fq ni b go nj nk nl gr nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">You can also do this with Keras with TensorFlow or JAX backend but needs to be written differently. All the <code class="cx pl pm pn pd b">if</code> conditions need to be written with this <code class="cx pl pm pn pd b">ops.cond</code> function as shown in the following code snippet.</p><pre class="mp mq mr ms mt pc pd pe bp pf bb bk"><span id="485a" class="pg od fq pd b bg ph pi l pj pk">class MyModel(keras.Model):<br/>    def call(self, inputs):<br/>        return ops.cond(<br/>            ops.sum(inputs) &gt; 0,<br/>            lambda : self.path_a(inputs),<br/>            lambda : self.path_b(inputs),<br/>        )</span></pre><p id="48b4" class="pw-post-body-paragraph ng nh fq ni b go nj nk nl gr nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">This is teaching the user to learn a new op instead of using the if-else clause they are familiar with, which is bad. In compensation, it brings significant improvement in training speed.</p><p id="4b37" class="pw-post-body-paragraph ng nh fq ni b go nj nk nl gr nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">Here is the catch of the flexibility of PyTorch. If you ever needed to optimize the memory and speed of your model, you would have to do it by yourself using the following APIs and new concepts to do so, including the inplace arguments for the ops, the parallel op APIs, and explicit device placement. It introduces a rather high learning curve for the users.</p><pre class="mp mq mr ms mt pc pd pe bp pf bb bk"><span id="3fea" class="pg od fq pd b bg ph pi l pj pk">torch.relu(x, inplace=True)<br/>x = torch._foreach_add(x, y)<br/>torch._foreach_add_(x, y)<br/>x = x.cuda()</span></pre><p id="5a84" class="pw-post-body-paragraph ng nh fq ni b go nj nk nl gr nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">Some other good examples are <code class="cx pl pm pn pd b">keras.ops</code>, <code class="cx pl pm pn pd b">tensorflow.numpy</code>, <code class="cx pl pm pn pd b">jax.numpy</code>. They are just a reimplementation of the numpy API. When introducing some cognitive load, just reuse what people already know. Every framework has to provide some low-level ops in these frameworks. Instead of letting people learn a new set of APIs, which may have a hundred functions, they just use the most popular existing API for it. The numpy APIs are well-documented and have tons of Stack Overflow questions and answers related to it.</p><p id="3b62" class="pw-post-body-paragraph ng nh fq ni b go nj nk nl gr nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">The worst thing you can do with user experience is to trick the users. Trick the user to believe your API is something they are familiar with but it is not. I will give two examples. One is on PyTorch. The other one is on TensorFlow.</p><p id="de9d" class="pw-post-body-paragraph ng nh fq ni b go nj nk nl gr nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">What should we pass as the pad argument in <code class="cx pl pm pn pd b">F.pad()</code> function if you want to pad the input tensor of the shape <code class="cx pl pm pn pd b">(100, 3, 32, 32)</code> to <code class="cx pl pm pn pd b">(100, 3, 1+32+1, 2+32+2)</code> or <code class="cx pl pm pn pd b">(100, 3, 34, 36)</code>?</p><pre class="mp mq mr ms mt pc pd pe bp pf bb bk"><span id="98e9" class="pg od fq pd b bg ph pi l pj pk">import torch.nn.functional as F<br/># pad the 32x32 images to (1+32+1)x(2+32+2)<br/># (100, 3, 32, 32) to (100, 3, 34, 36)<br/>out = F.pad(<br/>    torch.empty(100, 3, 32, 32),<br/>    pad=???,<br/>)</span></pre><p id="49c3" class="pw-post-body-paragraph ng nh fq ni b go nj nk nl gr nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">My first intuition is that it should be <code class="cx pl pm pn pd b">((0, 0), (0, 0), (1, 1), (2, 2))</code>, where each sub-tuple corresponds to one of the 4 dimensions, and the two numbers are the padding size before and after the existing values. My guess is originated from the numpy API.</p><p id="e23e" class="pw-post-body-paragraph ng nh fq ni b go nj nk nl gr nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">However, the correct answer is (2, 2, 1, 1). There is no sub-tuple, but one plain tuple. Moreover, the dimensions are reversed. The last dimension goes the first.</p><p id="2070" class="pw-post-body-paragraph ng nh fq ni b go nj nk nl gr nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">The following is a bad example from TensorFlow. Can you guess what is the output of the following code snippet?</p><pre class="mp mq mr ms mt pc pd pe bp pf bb bk"><span id="9913" class="pg od fq pd b bg ph pi l pj pk">value = True<br/><br/>@tf.function<br/>def get_value():<br/>    return value<br/><br/>value = False<br/>print(get_value())</span></pre><p id="6193" class="pw-post-body-paragraph ng nh fq ni b go nj nk nl gr nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">Without the <code class="cx pl pm pn pd b">tf.function</code> decorator, the output should be False, which is pretty simple. However, with the decorator, the output is True. This is because TensorFlow compiles the function and any Python variable is compiled into a new constant. Changing the old variable’s value would not affect the created constant.</p><p id="fe5d" class="pw-post-body-paragraph ng nh fq ni b go nj nk nl gr nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">It tricks the user into believing it is the Python code they are familiar with, but actually, it is not.</p><h2 id="1177" class="oc od fq bf oe of og oh oi oj ok ol om np on oo op nt oq or os nx ot ou ov ow bk">Principle 3: Interaction over documentation</h2><p id="e2cb" class="pw-post-body-paragraph ng nh fq ni b go ox nk nl gr oy nn no np oz nr ns nt pa nv nw nx pb nz oa ob fj bk">No one likes to read long documentation if they can figure it out just by running some example code and tweaking it by themselves. So, we try to make the user workflow of the software follow the same logic.</p><p id="ab72" class="pw-post-body-paragraph ng nh fq ni b go nj nk nl gr nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">Here is a good example shown in the following code snippet. In PyTorch, all methods with the underscore are inplace ops, while the ones without are not. From an interactive perspective, these are good, because they are easy to follow, and the users do not need to check the docs whenever they want the inplace version of a method. However, of course, they introduced some cognitive load. The users need to know what does inplace means and when to use them.</p><pre class="mp mq mr ms mt pc pd pe bp pf bb bk"><span id="1e45" class="pg od fq pd b bg ph pi l pj pk">x = x.add(y)<br/>x.add_(y)<br/>x = x.mul(y)<br/>x.mul_(y)</span></pre><p id="b699" class="pw-post-body-paragraph ng nh fq ni b go nj nk nl gr nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">Another good example is the Keras layers. They strictly follow the same naming convention as shown in the following code snippet. With a clear naming convention, the users can easily remember the layer names without checking the documentation.</p><pre class="mp mq mr ms mt pc pd pe bp pf bb bk"><span id="e73e" class="pg od fq pd b bg ph pi l pj pk">from keras import layers<br/><br/>layers.MaxPooling2D()<br/>layers.GlobalMaxPooling1D()<br/>layers.GlobalAveragePooling3D()</span></pre><p id="fddd" class="pw-post-body-paragraph ng nh fq ni b go nj nk nl gr nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">Another important part of the interaction between the user and the software is the error message. You cannot expect the user to write everything correctly the very first time. We should always do the necessary checks in the code and try to print helpful error messages.</p><p id="14aa" class="pw-post-body-paragraph ng nh fq ni b go nj nk nl gr nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">Let’s see the following two examples shown in the code snippet. The first one has not much information. It just says tensor shape mismatch. The<br/> second one contains much more useful information for the user to find the bug. It not only tells you the error is because of tensor shape mismatch, but it also shows what is the expected shape and what is the wrong shape it received. If you did not mean to pass that shape, you have a better idea<br/> of the bug now.</p><pre class="mp mq mr ms mt pc pd pe bp pf bb bk"><span id="ee8a" class="pg od fq pd b bg ph pi l pj pk"># Bad example:<br/>raise ValueError("Tensor shape mismatch.")<br/><br/># Good example:<br/>raise ValueError(<br/>    "Tensor shape mismatch. "<br/>    "Expected: (batch, num_features). "<br/>    f"Received: {x.shape}"<br/>)</span></pre><p id="f194" class="pw-post-body-paragraph ng nh fq ni b go nj nk nl gr nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">The best error message would be directly pointing the user to the fix. The following code snippet shows a general Python error message. It guessed what was wrong with the code and directly pointed the user to the fix.</p><pre class="mp mq mr ms mt pc pd pe bp pf bb bk"><span id="777c" class="pg od fq pd b bg ph pi l pj pk">import math<br/><br/>math.sqr(4)<br/>"AttributeError: module 'math' has no attribute 'sqr'. Did you mean: 'sqrt'?"</span></pre><h2 id="71a8" class="oc od fq bf oe of og oh oi oj ok ol om np on oo op nt oq or os nx ot ou ov ow bk">Final words</h2><p id="f7f3" class="pw-post-body-paragraph ng nh fq ni b go ox nk nl gr oy nn no np oz nr ns nt pa nv nw nx pb nz oa ob fj bk">So far we have introduced the three most valuable software design principles I have learned when contributing to the deep learning frameworks. First, write end-to-end workflows to discover more user experience problems. Second, reduce cognitive load and do not teach the user anything unless necessary. Third, follow the same logic in your API design and throw meaningful error messages so that the users can learn your software by interacting with it instead of constantly checking the documentation.</p><p id="40cf" class="pw-post-body-paragraph ng nh fq ni b go nj nk nl gr nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">However, there are many more principles to follow if you want to make your software even better. You can refer to the <a class="af nf" href="https://github.com/keras-team/governance/blob/24401c1addf521e522fd363f6eb40e7c4c4881d5/keras_api_design_guidelines.md" rel="noopener ugc nofollow" target="_blank">Keras API design guidelines</a> as a complete API design guide.</p></div></div></div></div>    
</body>
</html>