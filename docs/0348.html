<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Calculate the percentage of the total with RLS in place in Power BI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Calculate the percentage of the total with RLS in place in Power BI</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/calculate-the-percentage-of-the-total-with-rls-in-place-in-power-bi-1ea5c3ab1fac?source=collection_archive---------13-----------------------#2024-02-05">https://towardsdatascience.com/calculate-the-percentage-of-the-total-with-rls-in-place-in-power-bi-1ea5c3ab1fac?source=collection_archive---------13-----------------------#2024-02-05</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="11e3" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx"><em class="hd">Most data models have RLS in place, where some users can see only some aspects of the entire data set. But what happens when they must see their result compared to the overall result? This is not that easy.</em></h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="he hf hg hh hi ab"><div><div class="ab hj"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@salvatorecagliari?source=post_page---byline--1ea5c3ab1fac--------------------------------" rel="noopener follow"><div class="l hk hl by hm hn"><div class="l ed"><img alt="Salvatore Cagliari" class="l ep by dd de cx" src="../Images/a24b0cefab6e707cfee06cde9e857559.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/da:true/resize:fill:88:88/0*pOkUYGxmbbFyWocH"/><div class="ho by l dd de em n hp eo"/></div></div></a></div></div><div class="hq ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--1ea5c3ab1fac--------------------------------" rel="noopener follow"><div class="l hr hs by hm ht"><div class="l ed"><img alt="Towards Data Science" class="l ep by br hu cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="ho by l br hu em n hp eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hv ab q"><div class="ab q hw"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hx hy bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hz" data-testid="authorName" href="https://medium.com/@salvatorecagliari?source=post_page---byline--1ea5c3ab1fac--------------------------------" rel="noopener follow">Salvatore Cagliari</a></p></div></div></div><span class="ia ib" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hx hy dx"><button class="ic id ah ai aj ak al am an ao ap aq ar ie if ig" disabled="">Follow</button></p></div></div></span></div></div><div class="l ih"><span class="bf b bg z dx"><div class="ab cn ii ij ik"><div class="il im ab"><div class="bf b bg z dx ab in"><span class="io l ih">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hz ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--1ea5c3ab1fac--------------------------------" rel="noopener follow"><p class="bf b bg z ip iq ir is it iu iv iw bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="ia ib" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">11 min read</span><div class="ix iy l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Feb 5, 2024</span></div></span></div></span></div></div></div><div class="ab cp iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo"><div class="h k w ea eb q"><div class="ke l"><div class="ab q kf kg"><div class="pw-multi-vote-icon ed io kh ki kj"><div class=""><div class="kk kl km kn ko kp kq am kr ks kt kj"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l ku kv kw kx ky kz la"><p class="bf b dy z dx"><span class="kl">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kk lb lc ab q ee ld le" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="lf"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg></button></div></div></div><div class="ab q jp jq jr js jt ju jv jw jx jy jz ka kb kc kd"><div class="lg k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lh an ao ap ie li lj lk" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep ll cn"><div class="l ae"><div class="ab cb"><div class="lm ln lo lp lq lr ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lh an ao ap ie ls lt le lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lh an ao ap ie ls lt le lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lh an ao ap ie ls lt le lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk ml"><img src="../Images/a3c8d15eb058fbe11d3711d926e9fa1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Es-eCKAQk-Ypkz4Z"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Photo by <a class="af nc" href="https://unsplash.com/@wimvanteinde?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Wim van 't Einde</a> on <a class="af nc" href="https://unsplash.com/?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="7093" class="nd ne fq bf nf ng nh gq ni nj nk gt nl nm nn no np nq nr ns nt nu nv nw nx ny bk">Introduction</h1><p id="7658" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">Let’s look at the following scenario:</p><p id="a085" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">My Salespeople can see only the results for their assigned geographic regions.</p><p id="cea4" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">In this scenario, it’s the continent.</p><p id="7599" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">For benchmarking, they must be able to compare their results to the results of the other continents and the total.</p><p id="9b86" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">This is impossible when RLS (Row-Level-Security) is in place, as the users are not allowed to see the results for the other continents.</p><p id="cee8" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">A change to the data model is necessary to make this possible.</p><p id="4925" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">So, let’s look at how to implement such a change.</p><h1 id="1403" class="nd ne fq bf nf ng nh gq ni nj nk gt nl nm nn no np nq nr ns nt nu nv nw nx ny bk">Solution by SQLBI</h1><p id="78d0" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">SQLBI has already written an article and created a video on this topic:</p><div class="pa pb pc pd pe pf"><a href="https://www.sqlbi.com/articles/computing-accurate-percentages-with-row-level-security-in-power-bi/?source=post_page-----1ea5c3ab1fac--------------------------------" rel="noopener  ugc nofollow" target="_blank"><div class="pg ab ih"><div class="ph ab co cb pi pj"><h2 class="bf fr hx z ip pk ir is pl iu iw fp bk">Computing accurate percentages with row-level security in Power BI - SQLBI</h2><div class="pm l"><h3 class="bf b hx z ip pk ir is pl iu iw dx">This article shows how to compute ratios when row-level security hides some of the data. If the percentage also…</h3></div><div class="pn l"><p class="bf b dy z ip pk ir is pl iu iw dx">www.sqlbi.com</p></div></div><div class="po l"><div class="pp l pq pr ps po pt lr pf"/></div></div></a></div><p id="322e" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Theoretically, we can stop here: Read the article or watch the video. All OK, isn’t it?</p><p id="fa0e" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Not that fast, my young horse.</p><p id="d042" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">While Alberto has built a solution using DAX, I would like to create the additional tables for the data model earlier, preferably in the source (database) or Power Query.</p><p id="b1d2" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">As not everyone stores their data in a database, I don’t want to dig into SQL code to build the necessary tables, even though creating the solution in SQL would be pretty straightforward.</p><p id="b41f" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">So, I go to Power Query to create the solution.</p><p id="1cbc" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Just like my previous article:</p><div class="pa pb pc pd pe pf"><a rel="noopener follow" target="_blank" href="/converting-a-flat-table-to-a-good-data-model-in-power-query-46208215f17a?source=post_page-----1ea5c3ab1fac--------------------------------"><div class="pg ab ih"><div class="ph ab co cb pi pj"><h2 class="bf fr hx z ip pk ir is pl iu iw fp bk">Converting a Flat Table to a Good Data Model in Power Query</h2><div class="pm l"><h3 class="bf b hx z ip pk ir is pl iu iw dx">When loading a wide Excel table into Power BI, we end up with a suboptimal Data model. What can we do to create a good…</h3></div><div class="pn l"><p class="bf b dy z ip pk ir is pl iu iw dx">towardsdatascience.com</p></div></div><div class="po l"><div class="pu l pq pr ps po pt lr pf"/></div></div></a></div><p id="3e5b" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">OK, let’s start.</p><h1 id="58f8" class="nd ne fq bf nf ng nh gq ni nj nk gt nl nm nn no np nq nr ns nt nu nv nw nx ny bk">Step 1 — Create the Fact table without Customers</h1><p id="6779" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">I will take the same scenario and approach described in the SQLBI article above.</p><p id="3d67" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">As the RLS rules are set up on the Customer table, I created a copy of the Fact tale “Online Sales,” but without referencing the Customer table.</p><p id="10be" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Without this reference, the RLS rule on the Customer table doesn’t apply, and I can calculate the result as needed.</p><p id="fbd2" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">After opening Power Query, I create a Reference of the Online Sales table:</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk pv"><img src="../Images/10f54184f0be788adb2bd41b105c245b.png" data-original-src="https://miro.medium.com/v2/resize:fit:604/format:webp/1*FiNKOE5o2J-r1h72OUuMDA.png"/></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Figure 1 — Create a Reference from the Online Sales table (Figure by the Author)</figcaption></figure><p id="1ff2" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">By creating a Reference, I do not reread the data from the source in Power Query but reuse the result from the original Online Sales table.</p><p id="094e" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">I rename the table to “Online Sales (No Customers)”.</p><p id="c724" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">The second step is to analyze the data and decide by which columns I must group the data and which columns I can aggregate.</p><p id="5c23" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">This step is necessary as I’m changing the granularity of the data.</p><p id="97a3" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">By removing the Customer, I can reduce the size of the table, as I have fewer details.</p><p id="f7fc" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">I can group my data by all Dimension Keys on the table. But without the Customer Key. And as I must not be able to figure out which customer has placed which order, I must also remove the Order Number and the Order Line details.</p><p id="8ac3" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">But I must spend some time figuring out which column I can aggregate.</p><p id="a34f" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Let’s look at an example:</p><p id="3a68" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">When I take Sales Quantity, I can sum this column without problems, as the result can be reused.</p><p id="8d58" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">But when I look at Unit Price, the picture is not that easy anymore.<br/>I have to look at what I can do with this column.</p><p id="3968" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">What happens when I aggregate this column?</p><p id="0b04" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">This price is likely to change over time.</p><p id="e902" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">This poses a danger when calculating the Sales Amount by multiplying the Unit Price with the Sales Quantity. This can lead to wrong results.<br/>Therefore, I cannot aggregate the Unit Price.</p><p id="0f1c" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">In the end, I grouped the table by these columns:</p><ul class=""><li id="1af4" class="nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou pw px py bk">OrderDate</li><li id="c5c4" class="nz oa fq ob b go pz od oe gr qa og oh oi qb ok ol om qc oo op oq qd os ot ou pw px py bk">StoreKey</li><li id="683b" class="nz oa fq ob b go pz od oe gr qa og oh oi qb ok ol om qc oo op oq qd os ot ou pw px py bk">ProductKey</li><li id="71b5" class="nz oa fq ob b go pz od oe gr qa og oh oi qb ok ol om qc oo op oq qd os ot ou pw px py bk">PromotionKey</li><li id="e215" class="nz oa fq ob b go pz od oe gr qa og oh oi qb ok ol om qc oo op oq qd os ot ou pw px py bk">CurrencyKey</li><li id="e028" class="nz oa fq ob b go pz od oe gr qa og oh oi qb ok ol om qc oo op oq qd os ot ou pw px py bk">DateKeyYear</li><li id="e779" class="nz oa fq ob b go pz od oe gr qa og oh oi qb ok ol om qc oo op oq qd os ot ou pw px py bk">DueDate</li><li id="2ef4" class="nz oa fq ob b go pz od oe gr qa og oh oi qb ok ol om qc oo op oq qd os ot ou pw px py bk">ShipDate</li></ul><p id="afcc" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">And I aggregate (Sum) these columns:</p><ul class=""><li id="6668" class="nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou pw px py bk">SalesQuantity</li><li id="9f78" class="nz oa fq ob b go pz od oe gr qa og oh oi qb ok ol om qc oo op oq qd os ot ou pw px py bk">SalesAmount</li><li id="32e0" class="nz oa fq ob b go pz od oe gr qa og oh oi qb ok ol om qc oo op oq qd os ot ou pw px py bk">ReturnQuantity</li><li id="5fc8" class="nz oa fq ob b go pz od oe gr qa og oh oi qb ok ol om qc oo op oq qd os ot ou pw px py bk">ReturnAmount</li><li id="aed2" class="nz oa fq ob b go pz od oe gr qa og oh oi qb ok ol om qc oo op oq qd os ot ou pw px py bk">DiscountAmount</li><li id="a9f4" class="nz oa fq ob b go pz od oe gr qa og oh oi qb ok ol om qc oo op oq qd os ot ou pw px py bk">TotalCost</li><li id="defb" class="nz oa fq ob b go pz od oe gr qa og oh oi qb ok ol om qc oo op oq qd os ot ou pw px py bk">UnitCost</li></ul><p id="8248" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Additionally, I can add a distinct count by CustomerKey to count the Customers to analyze the data.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk qe"><img src="../Images/9a9c653c646619a796e7c5b2f8e743a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FPx9TBT201d7mtBttBFH3Q.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Figure 2 — Grouping and aggregating the new table (Figure by the Author)</figcaption></figure><p id="ddb4" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">I must click on “Add grouping” to add the column by which the data must be grouped.</p><p id="5b75" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Then, I must scroll down to click on “Add aggregation” to add the columns that must be aggregated.<br/>For each column, I must set the Operation (Aggregation function à e. g. Sum), and I can put a new name.</p><p id="b7ab" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">The next step is to add all relationships to the newly created table:</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk qf"><img src="../Images/1513d253cf98be2cbe4cf2226450171e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U5SSIERmvd7iV9psB2T59g.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Figure 3 — Data model for the new table (Figure by the Author)</figcaption></figure><p id="bb61" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Now, let’s look at the results without and with the additional table:</p><p id="f5f3" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">This is the starting point from the original data and without RLS:</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk qg"><img src="../Images/581efb487f85b21e7cf1de5b31ffde50.png" data-original-src="https://miro.medium.com/v2/resize:fit:1254/format:webp/1*hyn1t8PwPwBcBNECutMLSQ.png"/></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Figure 4 — Initial result without RLS (Figure by the Author)</figcaption></figure><p id="7264" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Now, let’s apply the RLS role for Asia and Australia:</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk qh"><img src="../Images/ea7b0c2b9b365072a3a4cf20aab1cfb9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CzFLdvM0an_uo77MTOI4Bg.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Figure 5 — Initial result with applied RLS role (Figure by the Author)</figcaption></figure><p id="c295" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">As you can see, the result is mathematically correct, but it doesn’t fulfill our requirements.</p><p id="203c" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">The percentage is calculated only over the remaining two Continents instead of all continents.</p><p id="24de" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Now, I can change the report by moving the Continent to a Slicer and adding the Product Brand to the Matrix:</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk qi"><img src="../Images/b6b8253ac062266f765d32b7556b2d73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1228/format:webp/1*zqEHap53dlZgOIl9Io6Y1g.png"/></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Figure 6 — Changed report with continent Slicer and Brand (Figure by the Author)</figcaption></figure><p id="3c97" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Due to this change, I can see that the values still change with and without RLS.</p><p id="50d6" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">The problem now is that the result with an active RLS role is wrong:</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk qj"><img src="../Images/ee731f09a32902f8c64588de1723aced.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sqPMyf1r2ITWa03rfR1aww.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Figure 7 — Wrong result by Brand with RLS applied (Figure by the Author)</figcaption></figure><p id="02c9" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">The reason is that the percentage of Sales over “all” Continents by Brand is calculated over the available Continents, Asia and Australia. Therefore, the result is wrong.</p><p id="e037" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">However, the result differs when I add a new Measure, which points to the new table.</p><p id="36ea" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">The Measure is the following:</p><pre class="mm mn mo mp mq qk ql qm bp qn bb bk"><span id="d92b" class="qo ne fq ql b bg qp qq l qr qs">% over All Continents (No Customers) =<br/>DIVIDE([Online Sales (By Order Date)]<br/>  ,SUM('Online Sales (No Customers)'[Sales Amount]))</span></pre><p id="8fe7" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">And the result (with RLS) is this:</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk qt"><img src="../Images/7b4f41e728dd213e4717ba1ad1b91c2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gy_jsZ7Vpd1hoFapAEqNyQ.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Figure 8 — Result with new Measure on the new table and RLS (Figure by the Author)</figcaption></figure><p id="76aa" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Take care: if you don’t select any continent and don’t have an active RLS role, the result of the new Measure looks wrong.<br/>You must take this into account while building and testing your solution.</p><p id="0fe2" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Depending on the report, you can use one of the two Measures, as both might deliver the correct result, depending on the situation.</p><p id="2fd7" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">For example, the Sales Director might have access to the Sales results of all Continents. For him, the result of the original Measure is correct, as it considers the Continent of the Customers.</p><p id="08cb" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">To simplify this, we can add a new table with Customer Attributes.</p><h1 id="df0f" class="nd ne fq bf nf ng nh gq ni nj nk gt nl nm nn no np nq nr ns nt nu nv nw nx ny bk">Step 2 — Reporting over Customer Attributes</h1><p id="515c" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">As described in the SQL article, there can be a situation where it is necessary to create a report based on some Customer attributes, like Gender, Education, or any other Attributes.</p><p id="f371" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">In this case, I must create a table for these Attributes and expand our Data model with this table.</p><p id="d2ff" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">To build such a table, I must first define the Requirements and then the process for creating the table.</p><p id="7b86" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">For example:</p><ol class=""><li id="aa6f" class="nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou qu px py bk">I must have a table without customers’ data (e.g., due to Data protection rules).</li><li id="9997" class="nz oa fq ob b go pz od oe gr qa og oh oi qb ok ol om qc oo op oq qd os ot ou qu px py bk">I must not be able to reconstruct customers’ data.</li><li id="b6da" class="nz oa fq ob b go pz od oe gr qa og oh oi qb ok ol om qc oo op oq qd os ot ou qu px py bk">I must be able to filter both the new and the original Online Sales tables.</li></ol><p id="2840" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Next, I define the necessary steps to fulfill the requirements:</p><ol class=""><li id="3cd5" class="nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou qu px py bk">Duplicate the Customer table (named Customer Attributes).</li><li id="beb2" class="nz oa fq ob b go pz od oe gr qa og oh oi qb ok ol om qc oo op oq qd os ot ou qu px py bk">Remove the unnecessary columns.</li><li id="e736" class="nz oa fq ob b go pz od oe gr qa og oh oi qb ok ol om qc oo op oq qd os ot ou qu px py bk">Remove all duplicates.</li><li id="4ad6" class="nz oa fq ob b go pz od oe gr qa og oh oi qb ok ol om qc oo op oq qd os ot ou qu px py bk">Add an Index (Key / ID) column.</li><li id="9aa0" class="nz oa fq ob b go pz od oe gr qa og oh oi qb ok ol om qc oo op oq qd os ot ou qu px py bk">Merge the new table with the original Customer table to add the newly created Key column.</li><li id="6aa9" class="nz oa fq ob b go pz od oe gr qa og oh oi qb ok ol om qc oo op oq qd os ot ou qu px py bk">Merge the Key column to the “Online Sales” table.</li><li id="f1d5" class="nz oa fq ob b go pz od oe gr qa og oh oi qb ok ol om qc oo op oq qd os ot ou qu px py bk">Add the new Key column to the “Online Sales (No Customers)” table.</li></ol><p id="d3df" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">This should work. Let’s start:</p><p id="06a9" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">One short note: As I must Merge the table without the unwanted Customer Attributes to the Original Customer table, I cannot create a Reference, as this would introduce a circular dependency. Therefore, I must Duplicate the Customer table:</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk qv"><img src="../Images/b45ed1d09fccb86be53e32c515712485.png" data-original-src="https://miro.medium.com/v2/resize:fit:584/format:webp/1*5AA7K3_OuUvhZghRCh-fQQ.png"/></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Figure 9 — Duplicate the Customer table (Figure by the Author)</figcaption></figure><p id="49af" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">I renamed the duplicated table to Customer Attributes.</p><p id="3cf3" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Now, I remove all columns that contain personal data (Except Gender, Education, and other statistically relevant columns). But I must make sure that I keep all the columns necessary to ensure that the Merge doesn’t result in a multiplication of rows in the following Merge Step.</p><p id="c240" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">For example, I got duplicates in the Result without the Birthdate. The reason is that there are a lot of customers sharing the same attributes without the Birthdate. But including the Birthdate ensures that the rows can be matched.</p><p id="b9c6" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">You need to check this step carefully, as this might change case-by-case.</p><p id="b934" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Next, I add the Index column:</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk qw"><img src="../Images/e3b648c321795449f0785ee4fe57f80d.png" data-original-src="https://miro.medium.com/v2/resize:fit:248/format:webp/1*FdC0RiMgk9dTSFhyWkJXYA.png"/></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Figure 10 — Add Index column (Figure by the Author)</figcaption></figure><p id="da14" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">The Index column is renamed to “CustomerAttributesKey”.</p><p id="d088" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">I use the Merge function to transport the new Key to the Original Customer table:</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk qx"><img src="../Images/17823dcb5738502dfee214d9d73d9a0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K3C2idEq2ImYTRBn3LqE_A.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Figure 11 — Merge the new Customer Attributes table to the original Customer table (Figure by the Author)</figcaption></figure><p id="df6f" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">I must select all matching columns while holding the Ctrl-Key pressed to ensure all columns are combined to merge the correct rows.</p><p id="b1e8" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">A problem exists with non-matching rows.</p><p id="7180" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">As you can see above, thirteen rows cannot be matched. Unfortunately, I wasn’t able to find the cause of this mismatch. Power Query doesn’t offer tools to find and solve such problems.</p><p id="c9f9" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">I created a CustomerAttributes_Dummy table in Excel with a CustomerAttributesKey = -1 to solve this. Then, I added a table with the Enter Data feature with this row and appended this row to the CustomerAttributes table.</p><p id="8143" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Another Note: I added the Dummy row to simplify the solution for this article. In the real world, I would try to find the cause, examine the data, and find the right solution instead of such a workaround.</p><p id="980a" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Now I can expand the merged table to extract the CustomerAttributesKey:</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk qy"><img src="../Images/c31f8568f440de8189fbde7fada04825.png" data-original-src="https://miro.medium.com/v2/resize:fit:720/format:webp/1*LJhWcTiSs_6ZR7sQEhxSXg.png"/></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Figure 12 — Expand the new Key column (Figure by the Author)</figcaption></figure><p id="880a" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">The non-matching values for the Key columns can be filled with the Dummy-Key -1 through the Replace Value feature:</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk qz"><img src="../Images/370de1eb79e764c9ff249e441abaf13f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GEXv5vD1OpxfIGk1-DHY1Q.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Figure 13 — Replace the non-matching Keys with the Dummy Key “-1” (Figure by the Author)</figcaption></figure><p id="4ea8" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">The next step is to add the CutomerAttributesKey to the “Online Sales” and, therefore, to the “Online Sales (No Customers)” tables.</p><p id="ecb1" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Again, I use the Merge and Expand Features to add the column to the “Online Sales” table:</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk ra"><img src="../Images/6d5ebc81f51364982dff127222852d60.png" data-original-src="https://miro.medium.com/v2/resize:fit:1338/format:webp/1*fMBGON22DebYlWNrfBNMcQ.png"/></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Figure 14 — Merge the Online Sales table with the Customer table (Figure by the Author)</figcaption></figure><p id="9111" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">The Expansion of the CustomerAttributeyKey column is done the same way as shown before.</p><p id="6aca" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Lastly, I have to add the new CustomerAttributeKey as a Grouping column to the “Online Sales (No Customers)” table:</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk rb"><img src="../Images/46ba5f5acc005f2be989f3804761712b.png" data-original-src="https://miro.medium.com/v2/resize:fit:568/format:webp/1*u6lJNYPry8SuFKsBrT0_zg.png"/></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Figure 15 — Add CustomerAttributeKey as a Grouping column (Figure by the Author)</figcaption></figure><p id="56ba" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">With this step, I have completed the data preparation tasks.</p><h1 id="16e1" class="nd ne fq bf nf ng nh gq ni nj nk gt nl nm nn no np nq nr ns nt nu nv nw nx ny bk">Modifying the Data model</h1><p id="fe09" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">At this point, I have two options for the data model.</p><p id="c4e7" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">In any case, I will add a Relationship to the “Online Sales (No Customer)” table, as this will fulfill a central requirement.</p><p id="80df" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">But I can add a Relationship to the Customer or the Online Sales table:</p><ol class=""><li id="c2e4" class="nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou qu px py bk">Linking the new CustomerAttributes table to the Customer table, which relates to the Original Online Sales table.</li><li id="74b6" class="nz oa fq ob b go pz od oe gr qa og oh oi qb ok ol om qc oo op oq qd os ot ou qu px py bk">Add a direct Relationship to the Online Sales table without adding a Relationship to the Customer table.</li></ol><p id="231e" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Here are the two options, side by side:</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk qt"><img src="../Images/785bb68292b2b140ca85a535e8c9e800.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IQyUCpqI6YxOqNLGs-IHdQ.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Figure 16 — Variants for Data model for the Customer Attributes table (Figure by the Author)</figcaption></figure><ol class=""><li id="7c36" class="nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou qu px py bk">Variant 1 uses the Customer table as an intermediary table.<br/> This has the following consequences:</li></ol><ul class=""><li id="9019" class="nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou pw px py bk">The duplicate attributes in the Customer table can be removed.</li><li id="05ed" class="nz oa fq ob b go pz od oe gr qa og oh oi qb ok ol om qc oo op oq qd os ot ou pw px py bk">Therefore, a unique distribution of Attributes.</li><li id="423d" class="nz oa fq ob b go pz od oe gr qa og oh oi qb ok ol om qc oo op oq qd os ot ou pw px py bk">The RLS on the Customer table is always applied.</li></ul><p id="241f" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">2. Variant 2 uses two relationships from the Online Sales table to each Customer table:</p><ul class=""><li id="eb1c" class="nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou pw px py bk">Duplicated Attributes.</li><li id="fe0a" class="nz oa fq ob b go pz od oe gr qa og oh oi qb ok ol om qc oo op oq qd os ot ou pw px py bk">Two possibilities to filter the data by the same attribute.</li><li id="ef26" class="nz oa fq ob b go pz od oe gr qa og oh oi qb ok ol om qc oo op oq qd os ot ou pw px py bk">The Customer Attributes table is not affected by RLS on the Customer table.</li><li id="0f51" class="nz oa fq ob b go pz od oe gr qa og oh oi qb ok ol om qc oo op oq qd os ot ou pw px py bk">A clear Star Schema.</li></ul><p id="128a" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">I will go with the Variant 2, as I want to eliminate the effects of the RLS rules in some specific calculations, which opens more possibilities.</p><p id="488e" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">But this is a decision for each situation.</p><h1 id="5235" class="nd ne fq bf nf ng nh gq ni nj nk gt nl nm nn no np nq nr ns nt nu nv nw nx ny bk">Results and Conclusion</h1><p id="50c4" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">The result will differ depending on the data model and how you use the attributes from each table.</p><p id="2863" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">For example, when I add the Gender from both tables to the Matrix shown at the beginning, the results are the following:</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk rc"><img src="../Images/be416d063c6be8e6c9db671680b59f68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LH0HX9Eo1ruHoWeFQeupkw.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Figure 17 — Comparison of the results with the Gender from each table (Figure by the Author)</figcaption></figure><p id="5cfc" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">While the result by Gender on the right can be summarized to the Brand above, the result on the left cannot.</p><p id="82f7" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">These results are Non-Visual-Totals, as described in the SQLBI article above, which can cause confusion and are hard to understand while being mathematically correct.</p><p id="80cf" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">I strongly encourage reading the article to better understand this complex topic.</p><p id="5631" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">The main question is: What is better, using DAX or Power Query to prepare the data?</p><p id="3921" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Strictly from the view of a data engineer, I would say Do it in the Source or Power Query to avoid data manipulation in Power BI using DAX.</p><p id="4d1b" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">This would follow <a class="af nc" href="https://ssbipolar.com/2021/05/31/roches-maxim/" rel="noopener ugc nofollow" target="_blank">Roche’s Maxim</a>:</p><p id="b5eb" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk"><em class="rd">Transform the data as early as possible and as late as necessary.</em></p><p id="44ae" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">One more reason to do it in Power Query is efficiency.</p><p id="6305" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Power BI will compress and optimize the data storage more efficiently when the data is prepared in the source or Power Query than when using DAX tables.</p><p id="ba8b" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">This very technical video explains this in great detail:</p><figure class="mm mn mo mp mq mr"><div class="re ip l ed"><div class="rf rg l"/></div></figure><p id="a8d1" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">However, the complexity of doing this transformation is greater than the approach shown in the SQLBI article.</p><p id="fbb7" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">When developing a solution for my clients, I ask the following questions:</p><ul class=""><li id="14ce" class="nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou pw px py bk">Who will maintain the solution?</li><li id="5df5" class="nz oa fq ob b go pz od oe gr qa og oh oi qb ok ol om qc oo op oq qd os ot ou pw px py bk">What are the skills of that person?</li><li id="397a" class="nz oa fq ob b go pz od oe gr qa og oh oi qb ok ol om qc oo op oq qd os ot ou pw px py bk">Is that person willing to learn more while maintaining the solution?</li></ul><p id="1a8c" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">The answers to these questions will drive the approach for the solution.</p><p id="0964" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">I already had situations when I had to rebuild a solution with a different approach, as the client wasn’t able or willing to learn the techniques used in my first approach.</p><p id="99b4" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">So, as usual, the answer to the question “Power Query or DAX” is: it depends …</p><p id="cb67" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">My aim for this article is to show you an alternative way of building the solution, which can give you more flexibility while deciding which approach is the right one for you.</p><p id="3f8c" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">I hope I could achieve this and you learned something new.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk rh"><img src="../Images/5c3c4eb830fdce30f0dd68f36dd39cef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*YY7Kp2fnvqO3Dv2C"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Photo by <a class="af nc" href="https://unsplash.com/@brett_jordan?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Brett Jordan</a> on <a class="af nc" href="https://unsplash.com/?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="44f4" class="nd ne fq bf nf ng nh gq ni nj nk gt nl nm nn no np nq nr ns nt nu nv nw nx ny bk">References</h1><p id="5616" class="pw-post-body-paragraph nz oa fq ob b go oc od oe gr of og oh oi oj ok ol om on oo op oq or os ot ou fj bk">I wrote an article about using Power Query to transform a flat table into a Star schema while using some techniques described here. You can find it here:</p><div class="pa pb pc pd pe pf"><a rel="noopener follow" target="_blank" href="/converting-a-flat-table-to-a-good-data-model-in-power-query-46208215f17a?source=post_page-----1ea5c3ab1fac--------------------------------"><div class="pg ab ih"><div class="ph ab co cb pi pj"><h2 class="bf fr hx z ip pk ir is pl iu iw fp bk">Converting a Flat Table to a Good Data Model in Power Query</h2><div class="pm l"><h3 class="bf b hx z ip pk ir is pl iu iw dx">When loading a wide Excel table into Power BI, we end up with a suboptimal Data model. What can we do to create a good…</h3></div><div class="pn l"><p class="bf b dy z ip pk ir is pl iu iw dx">towardsdatascience.com</p></div></div><div class="po l"><div class="pu l pq pr ps po pt lr pf"/></div></div></a></div><p id="8f2d" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">I use the Contoso sample dataset, like in my previous articles. You can download the ContosoRetailDW Dataset for free from Microsoft <a class="af nc" href="https://www.microsoft.com/en-us/download/details.aspx?id=18279" rel="noopener ugc nofollow" target="_blank">here</a>.</p><p id="6cf5" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">The Contoso Data can be freely used under the MIT License, as described <a class="af nc" href="https://github.com/microsoft/Power-BI-Embedded-Contoso-Sales-Demo" rel="noopener ugc nofollow" target="_blank">here</a>.</p><p id="81dc" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">You can support my work, which I do during my free time, through</p><p id="f27a" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk"><a class="af nc" href="https://buymeacoffee.com/salvatorecagliari" rel="noopener ugc nofollow" target="_blank">https://buymeacoffee.com/salvatorecagliari</a></p><p id="89b5" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Or scan this QR Code:</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk ri"><img src="../Images/e7ac062070dcd7a00dcf995ad7e95434.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*btH95UXO7gboS30eZMk6ug.png"/></div></figure><p id="d3b7" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Any support is greatly appreciated and helps me find more time to create more content for you.</p><p id="f6c8" class="pw-post-body-paragraph nz oa fq ob b go ov od oe gr ow og oh oi ox ok ol om oy oo op oq oz os ot ou fj bk">Thank you a lot.</p></div></div></div></div>    
</body>
</html>