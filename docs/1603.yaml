- en: Safeguarding Demand Forecasting with Causal Graphs
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 原文：[https://towardsdatascience.com/safeguarding-demand-forecasting-with-causal-graphs-591511fc8e0e?source=collection_archive---------6-----------------------#2024-06-28](https://towardsdatascience.com/safeguarding-demand-forecasting-with-causal-graphs-591511fc8e0e?source=collection_archive---------6-----------------------#2024-06-28)
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: Causal AI, exploring the integration of causal reasoning into machine learning
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: '[](https://medium.com/@raz1470?source=post_page---byline--591511fc8e0e--------------------------------)[![Ryan
    O''Sullivan](../Images/7cd161d38d67d2c0b7da2d8f3e7d33fe.png)](https://medium.com/@raz1470?source=post_page---byline--591511fc8e0e--------------------------------)[](https://towardsdatascience.com/?source=post_page---byline--591511fc8e0e--------------------------------)[![Towards
    Data Science](../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png)](https://towardsdatascience.com/?source=post_page---byline--591511fc8e0e--------------------------------)
    [Ryan O''Sullivan](https://medium.com/@raz1470?source=post_page---byline--591511fc8e0e--------------------------------)'
  prefs: []
  type: TYPE_NORMAL
- en: ·Published in [Towards Data Science](https://towardsdatascience.com/?source=post_page---byline--591511fc8e0e--------------------------------)
    ·11 min read·Jun 28, 2024
  prefs: []
  type: TYPE_NORMAL
- en: --
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/04ae3f78a67df7e275299b9801cf319b.png)'
  prefs: []
  type: TYPE_IMG
- en: Photo by [Boris Dunand](https://unsplash.com/@borisdunand?utm_source=medium&utm_medium=referral)
    on [Unsplash](https://unsplash.com/?utm_source=medium&utm_medium=referral)
  prefs: []
  type: TYPE_NORMAL
- en: What is this series of articles about?
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Welcome to my series on Causal AI, where we will explore the integration of
    causal reasoning into machine learning models. Expect to explore a number of practical
    applications across different business contexts.
  prefs: []
  type: TYPE_NORMAL
- en: In the last article we covered *enhancing marketing mix modelling with Causal
    AI*. In this article we will move onto *safeguarding demand forecasting with causal
    graphs*.
  prefs: []
  type: TYPE_NORMAL
- en: 'If you missed the last article on marketing mix modelling, check it out here:'
  prefs: []
  type: TYPE_NORMAL
- en: '[](/enhancing-marketing-mix-modelling-with-causal-ai-77f638bce3a9?source=post_page-----591511fc8e0e--------------------------------)
    [## Enhancing Marketing Mix Modelling with Causal AI'
  prefs: []
  type: TYPE_NORMAL
- en: Causal AI, exploring the integration of causal reasoning into machine learning
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: towardsdatascience.com](/enhancing-marketing-mix-modelling-with-causal-ai-77f638bce3a9?source=post_page-----591511fc8e0e--------------------------------)
  prefs: []
  type: TYPE_NORMAL
- en: Introduction
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: In this article we will delve into how you can safeguard demand forecasting
    (or any forecasting use case to be honest) with causal graphs.
  prefs: []
  type: TYPE_NORMAL
- en: '**The following areas will be explored:**'
  prefs: []
  type: TYPE_NORMAL
- en: A quick forecasting 101.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: What is demand forecasting?
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: A refresher on causal graphs.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: How can causal graphs safeguard demand forecasting?
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: A Python case study illustrating how causal graphs can safeguard your forecasts
    from spurious correlations.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'The full notebook can be found here:'
  prefs: []
  type: TYPE_NORMAL
- en: '[](https://github.com/raz1470/causal_ai/blob/main/notebooks/safeguarding%20demand%20forecasting%20with%20causal%20graphs.ipynb?source=post_page-----591511fc8e0e--------------------------------)
    [## causal_ai/notebooks/safeguarding demand forecasting with causal graphs.ipynb
    at main ·…'
  prefs: []
  type: TYPE_NORMAL
- en: This project introduces Causal AI and how it can drive business value. - causal_ai/notebooks/safeguarding
    demand…
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: github.com](https://github.com/raz1470/causal_ai/blob/main/notebooks/safeguarding%20demand%20forecasting%20with%20causal%20graphs.ipynb?source=post_page-----591511fc8e0e--------------------------------)
  prefs: []
  type: TYPE_NORMAL
- en: Forecasting
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Forecasting 101
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Time series forecasting involves predicting future values based on historical
    observations.
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/1b694d850081befe34ef0aec17da8522.png)'
  prefs: []
  type: TYPE_IMG
- en: User generated image
  prefs: []
  type: TYPE_NORMAL
- en: 'To start us off, there are a number of terms which it is worth getting familiar
    with:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Auto-correlation** — The correlation of a series with it’s previous values
    at different time lags. Helps identify if there is a trend present.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Stationary** — This is when the statistical properties of a series are constant
    over time (e.g. mean, variance). Some forecasting methods assume stationarity.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Differencing** — This is when we subtract the previous observation from the
    current observation to transform a non-stationary series into a stationary one.
    An important step for models which assume stationarity.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Seasonality** — A regular repeating cycle which occurs at a fixed interval
    (e.g. daily, weekly, yearly).'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Trend** — The long term movement in a series.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Lag** — The number of time steps between an observation and a previous value.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Residuals** — The difference between predicted and actual values.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Moving average** — Used to smooth out short term fluctuations by averaging
    a fixed number of past observations.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Exponential smoothing** — Weights are applied to past observations, with
    more emphasis placed on recent values.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '**Seasonal decomposition** — This is when we separate a time series into seasonal,
    trend and residual components.'
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](../Images/5a2ceb597aa90c76f0b68ab324cab690.png)'
  prefs: []
  type: TYPE_IMG
- en: User generated image
  prefs: []
  type: TYPE_NORMAL
- en: 'There a a number of different methods which can be used for forecasting:'
  prefs: []
  type: TYPE_NORMAL
- en: '**ETS (Error, Trend, Seasonal)** — An exponential smoothing method that models
    error, trend and seasonality components.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Autoregressive models (AR models)** — Models the current value of the series
    as a linear combination of it’s previous values.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Moving average models (MA models)** — Models the current value of the series
    as a linear combination of past forecast errors.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Autoregressive integrated moving average (ARIMA models)** — Combines AR and
    MA models with the incorporation of differencing to make the series stationary.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**State space models** — Deconstructs the timeseries into individual components
    such as trend and seasonality.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Hierarchical models** — A method which handles data structured in a hierarchy
    such as regions.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Linear regression** — Uses one or more independent variable (feature) to
    predict the dependent variable (target).'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: '**Machine learning (ML)** — Uses more flexible algorithms like boosting to
    capture complex relationships.'
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: 'If you want to dive further into this topic, I highly recommend the following
    resource which is well known as the go-to guide for forecasting (the version below
    is free 😀):'
  prefs: []
  type: TYPE_NORMAL
- en: '[](https://otexts.com/fpp3/?source=post_page-----591511fc8e0e--------------------------------)
    [## Forecasting: Principles and Practice (3rd ed)'
  prefs: []
  type: TYPE_NORMAL
- en: 3rd edition
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: otexts.com](https://otexts.com/fpp3/?source=post_page-----591511fc8e0e--------------------------------)
  prefs: []
  type: TYPE_NORMAL
- en: 'In terms of applying some of the forecasting models using Python, I’d recommend
    exploring Nixtla which has an extensive list of models implemented and an easy
    to use API:'
  prefs: []
  type: TYPE_NORMAL
- en: '[](https://github.com/Nixtla?source=post_page-----591511fc8e0e--------------------------------)
    [## Nixtla'
  prefs: []
  type: TYPE_NORMAL
- en: Open Source Time Series Ecosystem. Nixtla has 35 repositories available. Follow
    their code on GitHub.
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: github.com](https://github.com/Nixtla?source=post_page-----591511fc8e0e--------------------------------)
  prefs: []
  type: TYPE_NORMAL
- en: Demand forecasting
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Predicting the demand for your product is important.
  prefs: []
  type: TYPE_NORMAL
- en: It can help manage your inventory, avoiding over or understocking.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: It can keep your customers satisfied, ensuring products are available when they
    want them.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Reducing holding costs and minimising waste is cost efficient.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Essential for strategic planning.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Keeping demand forecasts accurate is essential — In the next section let’s start
    to think about how causal graphs could safeguard our forecasts…
  prefs: []
  type: TYPE_NORMAL
- en: Causal graphs
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Causal graph refresher
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'I’ve covered causal graphs a few times in my series, but just in case you need
    a refresher check out my first article where I cover it in detail:'
  prefs: []
  type: TYPE_NORMAL
- en: '[](/using-causal-graphs-to-answer-causal-questions-5fd1dd82fa90?source=post_page-----591511fc8e0e--------------------------------)
    [## Using Causal Graphs to answer causal questions'
  prefs: []
  type: TYPE_NORMAL
- en: Causal AI, exploring the integration of causal reasoning into machine learning
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: towardsdatascience.com](/using-causal-graphs-to-answer-causal-questions-5fd1dd82fa90?source=post_page-----591511fc8e0e--------------------------------)
  prefs: []
  type: TYPE_NORMAL
- en: How can causal graphs safeguard demand forecasting?
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Taking the graph below as an example, let’s say we want to forecast our target
    variable. We find we have 3 variables which are correlated with it, so we use
    them as features. Why would including the spurious correlation be a problem? The
    more features we include the better our forecast right?
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/66b864fdc1fb8642ba0489ffac247f8a.png)'
  prefs: []
  type: TYPE_IMG
- en: User generated image
  prefs: []
  type: TYPE_NORMAL
- en: Well, not really….
  prefs: []
  type: TYPE_NORMAL
- en: When it comes to demand forecasting one of the major problems is data drift.
    Data drift in itself isn’t a problem if the relationship between the feature of
    interest and target remain constant. But when the relationship doesn’t remain
    constant, our forecasting accuracy will deteriorate.
  prefs: []
  type: TYPE_NORMAL
- en: But how is a causal graph going to help us… The idea is that spurious correlations
    are much more likely to drift, and much more likely to cause problems when they
    do.
  prefs: []
  type: TYPE_NORMAL
- en: Not convinced? OK it’s time to jump into the case study then!
  prefs: []
  type: TYPE_NORMAL
- en: Case study
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: Background
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: Your friend has bought an ice cream van. They paid a consultant a lot of money
    to build them a demand forecast model. It worked really well for the first few
    months, but in the last couple of months your friend has been understocking ice
    cream! They remember that your job title was “data something or other” and come
    to you for advice.
  prefs: []
  type: TYPE_NORMAL
- en: Creating the case study data
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Let me start by explaining how I created the data for this case study. I created
    a simple causal graph with the following characteristics:'
  prefs: []
  type: TYPE_NORMAL
- en: Ice cream sales is the target node (X0)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Coastal visits is a direct cause of ice cream sales (X1)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Temperature is an indirect cause of ice cream sales (X2)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Sharks attacks is a spurious correlation (X3)
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: '![](../Images/8038224febe818d6a49a2d0980df047f.png)'
  prefs: []
  type: TYPE_IMG
- en: User generated image
  prefs: []
  type: TYPE_NORMAL
- en: 'I then used the following data generating process:'
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/087d0da8feedce2a5c4b85776f7c2157.png)'
  prefs: []
  type: TYPE_IMG
- en: User generated image
  prefs: []
  type: TYPE_NORMAL
- en: 'You can see that each node is influenced by past values of itself and a noise
    term as well as it’s direct parents. To create the data I use a handy module from
    the time series causal analysis python package Tigramite:'
  prefs: []
  type: TYPE_NORMAL
- en: '[](https://github.com/jakobrunge/tigramite/tree/master?source=post_page-----591511fc8e0e--------------------------------)
    [## GitHub - jakobrunge/tigramite: Tigramite is a python package for causal inference
    with a focus on…'
  prefs: []
  type: TYPE_NORMAL
- en: Tigramite is a python package for causal inference with a focus on time series
    data. The Tigramite documentation is at…
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: github.com](https://github.com/jakobrunge/tigramite/tree/master?source=post_page-----591511fc8e0e--------------------------------)
  prefs: []
  type: TYPE_NORMAL
- en: 'Tigramite is a great package but I am not going to cover it in detail this
    time around as is deserves it own article! Below we use the structural_causal_process
    module following the data generating process above:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: 'We can then visualise our time series:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: '![](../Images/176957d122740457eda755b7ea92f421.png)'
  prefs: []
  type: TYPE_IMG
- en: User generated image
  prefs: []
  type: TYPE_NORMAL
- en: Now you understand how I have created the data, lets get back to the case study
    in the next section!
  prefs: []
  type: TYPE_NORMAL
- en: Understanding the data generating process
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'You start by trying to understand the data generating process by taking the
    data used in the model. There are 3 features included in the model:'
  prefs: []
  type: TYPE_NORMAL
- en: Coastal visits
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Temperature
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Shark attacks
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: 'To get an understanding of the causal graph, you use PCMCI (which is has a
    great implementation in Tigramite), a method which is suitable for causal time
    series discovery. I am not going to cover PCMCI this time round as it needs it’s
    own dedicated article. However, if you are unfamiliar with causal discovery in
    general, use my previous article to get a good introduction:'
  prefs: []
  type: TYPE_NORMAL
- en: '[](/making-causal-discovery-work-in-real-world-business-settings-80e80c5f66b8?source=post_page-----591511fc8e0e--------------------------------)
    [## Making Causal Discovery work in real-world business settings'
  prefs: []
  type: TYPE_NORMAL
- en: Causal AI, exploring the integration of causal reasoning into machine learning
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: towardsdatascience.com](/making-causal-discovery-work-in-real-world-business-settings-80e80c5f66b8?source=post_page-----591511fc8e0e--------------------------------)
    ![](../Images/ef72754fb775f028a38e302643adcd49.png)
  prefs: []
  type: TYPE_NORMAL
- en: User generated image
  prefs: []
  type: TYPE_NORMAL
- en: 'The causal graph output from PCMCI can be seen above. The following things
    jump out:'
  prefs: []
  type: TYPE_NORMAL
- en: Coastal visits is a direct cause of ice cream sales
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Temperature is an in-direct cause of ice cream sales
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: Sharks attacks is a spurious correlation
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
- en: You question why anyone with any common sense would include shark attacks as
    a feature! Looking at the documentation it seems that the consultant used ChatGPT
    to get a list of features to consider for the model and then used autoML to train
    the model.
  prefs: []
  type: TYPE_NORMAL
- en: So if ChatGPT and autoML think shark attacks should be in the model, surely
    it can’t be doing any harm?
  prefs: []
  type: TYPE_NORMAL
- en: Pre-processing the case study data
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'Next let’s visit how I pre-processed the data to make it suitable for this
    case study. To create our features we need to pick up the lagged values for each
    column (look back at the data generating process to understand why the features
    need to be the lagged values):'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: '![](../Images/298d7e072e0a8fa2f6989842e6bd4ce1.png)'
  prefs: []
  type: TYPE_IMG
- en: User generated image
  prefs: []
  type: TYPE_NORMAL
- en: 'We could use these lagged features to predict ice cream sales, but before we
    do let’s introduce some data drift to the spurious correlation:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE3]'
  prefs: []
  type: TYPE_PRE
- en: '![](../Images/979c0b072e146bec980c912f27650c7d.png)'
  prefs: []
  type: TYPE_IMG
- en: User generated image
  prefs: []
  type: TYPE_NORMAL
- en: Let’s go back to the case study and understand what we are seeing. Why has the
    number of shark attacks drifted? You do some research and find out that one of
    the causes of shark attacks is the number of people surfing. In recent months
    there has been a huge rise in the popularity of surfing, causing an increase in
    shark attacks. So how did this effect the ice cream sales forecasting?
  prefs: []
  type: TYPE_NORMAL
- en: Model training
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
- en: 'You decide to recreate the model using the same features as the consultant
    and then using just the direct causes:'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE4]'
  prefs: []
  type: TYPE_PRE
- en: The model trained on just the direct causes looks good on both the train and
    test set.
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE5]'
  prefs: []
  type: TYPE_PRE
- en: '![](../Images/a99b661eb27182a3109420cb80d4d844.png)'
  prefs: []
  type: TYPE_IMG
- en: User generated image
  prefs: []
  type: TYPE_NORMAL
- en: However, when you train the model using all of the features you see that the
    model performs well on the train set but not the test set. Seem’s like you identified
    the problem!
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE6]'
  prefs: []
  type: TYPE_PRE
- en: '![](../Images/34b3554125a3463125a1508807f62962.png)'
  prefs: []
  type: TYPE_IMG
- en: User generated image
  prefs: []
  type: TYPE_NORMAL
- en: When we compare the predictions from both models of the test set we can see
    why your friend has been understocking on ice cream!
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE7]'
  prefs: []
  type: TYPE_PRE
- en: '![](../Images/4c4b584d2faa4298eb39573a56423033.png)'
  prefs: []
  type: TYPE_IMG
- en: User generated image
  prefs: []
  type: TYPE_NORMAL
- en: Closing thoughts
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 'Today we explored how harmful including spurious correlations in your forecasting
    models can be. Let’s finish off with some closing thoughts:'
  prefs: []
  type: TYPE_NORMAL
- en: The aim of this article was to start you thinking about how understanding the
    causal graph can improve your forecasts.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: I know the example was a little over-exaggerated (I would hope common sense
    would have helped in this scenario!) but it hopefully illustrates the point.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Another interesting point to mention is that the coefficient for shark attacks
    was negative. This is another pitfall as logically we would have expected this
    spurious correlation to be positive.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Medium-long term demand forecasting it very hard — You often need a forecasting
    model for each feature to be able to forecast multiple timesteps ahead. Interesting,
    causal graphs (specifically structural causal models) lend themselves well to
    this problem.
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
- en: Follow me if you want to continue this journey into Causal AI — In the next
    article we see how we move onto comparing how CUPED and double machine learning
    can help power your experiments.
  prefs: []
  type: TYPE_NORMAL
