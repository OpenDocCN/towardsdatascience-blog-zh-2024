<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Exploring LLMs for ICD Coding — Part 1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Exploring LLMs for ICD Coding — Part 1</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/exploring-llms-for-icd-coding-part-1-959e48b58b9e?source=collection_archive---------1-----------------------#2024-05-16">https://towardsdatascience.com/exploring-llms-for-icd-coding-part-1-959e48b58b9e?source=collection_archive---------1-----------------------#2024-05-16</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="a3f5" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx">Building automated clinical coding systems with LLMs</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hd he hf hg hh ab"><div><div class="ab hi"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@anand.subu10?source=post_page---byline--959e48b58b9e--------------------------------" rel="noopener follow"><div class="l hj hk by hl hm"><div class="l ed"><img alt="Anand Subramanian" class="l ep by dd de cx" src="../Images/096dc5504d6ada2493e0ac26959e60f0.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/1*IfxBBsal-XaXfAXh_c9g1A.jpeg"/><div class="hn by l dd de em n ho eo"/></div></div></a></div></div><div class="hp ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--959e48b58b9e--------------------------------" rel="noopener follow"><div class="l hq hr by hl hs"><div class="l ed"><img alt="Towards Data Science" class="l ep by br ht cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hn by l br ht em n ho eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hu ab q"><div class="ab q hv"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hw hx bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hy" data-testid="authorName" href="https://medium.com/@anand.subu10?source=post_page---byline--959e48b58b9e--------------------------------" rel="noopener follow">Anand Subramanian</a></p></div></div></div><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hw hx dx"><button class="ib ic ah ai aj ak al am an ao ap aq ar id ie if" disabled="">Follow</button></p></div></div></span></div></div><div class="l ig"><span class="bf b bg z dx"><div class="ab cn ih ii ij"><div class="ik il ab"><div class="bf b bg z dx ab im"><span class="in l ig">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hy ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--959e48b58b9e--------------------------------" rel="noopener follow"><p class="bf b bg z io ip iq ir is it iu iv bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">16 min read</span><div class="iw ix l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">May 16, 2024</span></div></span></div></span></div></div></div><div class="ab cp iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn"><div class="h k w ea eb q"><div class="kd l"><div class="ab q ke kf"><div class="pw-multi-vote-icon ed in kg kh ki"><div class=""><div class="kj kk kl km kn ko kp am kq kr ks ki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kt ku kv kw kx ky kz"><p class="bf b dy z dx"><span class="kk">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kj lc ld ab q ee le lf" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="lb"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg><p class="bf b dy z dx"><span class="pw-responses-count la lb">7</span></p></button></div></div></div><div class="ab q jo jp jq jr js jt ju jv jw jx jy jz ka kb kc"><div class="lg k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lh an ao ap id li lj lk" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep ll cn"><div class="l ae"><div class="ab cb"><div class="lm ln lo lp lq lr ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><p id="fe98" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Clinical coding isn’t common parlance, but it significantly impacts everyone who interacts with the healthcare system in most countries. Clinical coding involves translating and mapping medical information from patient health records, such as diagnoses and procedures, into standardized numeric or alphanumeric codes. These codes are crucial for billing, healthcare analytics, and ensuring that patients receive appropriate care.</p><figure class="ni nj nk nl nm nn nf ng paragraph-image"><div class="nf ng nh"><img src="../Images/d56b7d4ee7bac168b0d1961b3e2c6378.png" data-original-src="https://miro.medium.com/v2/resize:fit:1310/format:webp/1*7o3xeyqskLBnQLrw5bBJ-w.png"/></div><figcaption class="np nq nr nf ng ns nt bf b bg z dx">A representative workflow of automated ICD coding (Image by Author)</figcaption></figure><p id="363f" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Clinical coding is typically performed by human coders with medical expertise. These coders navigate complex and often hierarchical coding terminologies with specific codes for a vast range of diagnoses and procedures. As such, coders must have a deep familiarity with and experience in the coding terminology used. However, manually coding documents can be slow, error-prone, and bottlenecked by the requirement for significant human expertise.</p><p id="d800" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Deep learning can play a significant role in automating clinical coding. By automating the extraction and translation of complex medical information into codes, deep learning systems can function as a valuable tool within a human-in-the-loop system. They can support coders by processing large volumes of data quickly, potentially improving speed and accuracy. This can help streamline administrative operations, reduce billing errors and enhance patient care outcomes.</p><p id="fc37" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">In this first part, I describe what ICD coding is, characterize the various challenges that an automated coding system must overcome in order to be effective. I also analyze how Large Language Models (LLMs) can be effectively used for overcoming these problems, and illustrate that by implementing an algorithm from a recent paper that leveraged LLMs effectively for ICD coding.</p><h1 id="d352" class="nu nv fq bf nw nx ny gq nz oa ob gt oc od oe of og oh oi oj ok ol om on oo op bk">Table of Contents:</h1><ol class=""><li id="cdce" class="mj mk fq ml b go oq mn mo gr or mq mr ms os mu mv mw ot my mz na ou nc nd ne ov ow ox bk"><a class="af oy" href="#bfdf" rel="noopener ugc nofollow"><strong class="ml fr">What is ICD Coding?</strong></a></li><li id="246e" class="mj mk fq ml b go oz mn mo gr pa mq mr ms pb mu mv mw pc my mz na pd nc nd ne ov ow ox bk"><a class="af oy" href="#76c7" rel="noopener ugc nofollow"><strong class="ml fr">What are the challenges in automated ICD coding</strong></a><strong class="ml fr">?</strong></li><li id="f747" class="mj mk fq ml b go oz mn mo gr pa mq mr ms pb mu mv mw pc my mz na pd nc nd ne ov ow ox bk"><a class="af oy" href="#46fd" rel="noopener ugc nofollow"><strong class="ml fr">How can LLMs help in automated ICD coding?</strong></a></li><li id="4eb6" class="mj mk fq ml b go oz mn mo gr pa mq mr ms pb mu mv mw pc my mz na pd nc nd ne ov ow ox bk"><a class="af oy" href="#2949" rel="noopener ugc nofollow"><strong class="ml fr">Exploring the paper “Automated clinical coding using off-the-shelf large language models”</strong></a></li><li id="c660" class="mj mk fq ml b go oz mn mo gr pa mq mr ms pb mu mv mw pc my mz na pd nc nd ne ov ow ox bk"><a class="af oy" href="#ddc6" rel="noopener ugc nofollow"><strong class="ml fr">Implementing the technique described in the paper</strong></a></li><li id="b54d" class="mj mk fq ml b go oz mn mo gr pa mq mr ms pb mu mv mw pc my mz na pd nc nd ne ov ow ox bk"><a class="af oy" href="#0356" rel="noopener ugc nofollow"><strong class="ml fr">Conclusion</strong></a></li><li id="8e14" class="mj mk fq ml b go oz mn mo gr pa mq mr ms pb mu mv mw pc my mz na pd nc nd ne ov ow ox bk"><a class="af oy" href="#f82e" rel="noopener ugc nofollow"><strong class="ml fr">References</strong></a></li></ol><h1 id="bfdf" class="nu nv fq bf nw nx ny gq nz oa ob gt oc od oe of og oh oi oj ok ol om on oo op bk">What is ICD Coding?</h1><p id="4d73" class="pw-post-body-paragraph mj mk fq ml b go oq mn mo gr or mq mr ms os mu mv mw ot my mz na ou nc nd ne fj bk">The International Classification of Diseases (ICD) coding is a clinical terminology system developed and maintained by the World Health Organization [1]. It is used in most countries to categorize and code all diagnoses, symptoms, and procedures recorded for a patient.</p><p id="5aa6" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Medical notes, which document the diagnoses and medical procedures for a patient, are crucial for ICD coding . The ICD terminology features a hierarchical, tree-like structure to efficiently organize extensive information, with approximately 75,000 different assignable codes available for various medical conditions and diagnoses. Coding these documents precisely is vital; accurate coding ensures appropriate billing and influences the quality of healthcare analysis, directly impacting patient care outcomes, reimbursement and healthcare efficiency.</p><h1 id="76c7" class="nu nv fq bf nw nx ny gq nz oa ob gt oc od oe of og oh oi oj ok ol om on oo op bk"><strong class="al">What are the challenges in automated ICD coding?</strong></h1><p id="a60a" class="pw-post-body-paragraph mj mk fq ml b go oq mn mo gr or mq mr ms os mu mv mw ot my mz na ou nc nd ne fj bk">ICD coding poses multiple challenges that an automated system must overcome in order to be effective.</p><h2 id="90b9" class="pe nv fq bf nw pf pg ph nz pi pj pk oc ms pl pm pn mw po pp pq na pr ps pt pu bk">Label Diversity in ICD Coding:</h2><p id="df1b" class="pw-post-body-paragraph mj mk fq ml b go oq mn mo gr or mq mr ms os mu mv mw ot my mz na ou nc nd ne fj bk">One significant challenge is the extensive output space of labels. ICD codes are numerous, and each code can differ in minute details — for instance, a condition affecting the right hand versus the left hand will have different codes. Additionally, there exists a long tail of rare codes that appear infrequently in medical records, making it difficult for deep learning models to learn and accurately predict these codes due to the scarcity of examples.</p><h2 id="305c" class="pe nv fq bf nw pf pg ph nz pi pj pk oc ms pl pm pn mw po pp pq na pr ps pt pu bk">Adapting to New ICD Codes:</h2><p id="8dec" class="pw-post-body-paragraph mj mk fq ml b go oq mn mo gr or mq mr ms os mu mv mw ot my mz na ou nc nd ne fj bk">Traditional datasets used for training, such as MIMIC-III [2] , while comprehensive, often limit the scope of ICD codes to those included in the training corpus. This restriction means that deep-learning models treating ICD coding as a multi-label classification problem from medical notes to ICD codes have difficulty handling new codes introduced into the ICD system after the model’s training. This makes retraining necessary and potentially challenging.</p><h2 id="2339" class="pe nv fq bf nw pf pg ph nz pi pj pk oc ms pl pm pn mw po pp pq na pr ps pt pu bk">Extracting and Contextualizing Information:</h2><p id="fd57" class="pw-post-body-paragraph mj mk fq ml b go oq mn mo gr or mq mr ms os mu mv mw ot my mz na ou nc nd ne fj bk">Another major challenge is the accurate extraction and contextualization of information from medical notes. ICD coding is fundamentally an Information Retrieval problem that requires not only identifying the diagnoses in the medical records but also capturing all supplementary information necessary for correctly mapping these diagnoses to their respective ICD codes. Therefore, it is crucial for an automated system to extract the various medical diagnoses in the medical note and contextualize them appropriately to ensure accurate mapping to the ICD codes.</p><figure class="ni nj nk nl nm nn nf ng paragraph-image"><div class="nf ng pv"><img src="../Images/e8fc0ee85ce38370994cb37a6e4dc546.png" data-original-src="https://miro.medium.com/v2/resize:fit:1322/format:webp/1*1ICxDLoiiAjkmGrzTS4gfQ.png"/></div><figcaption class="np nq nr nf ng ns nt bf b bg z dx">An example of the coarse-to-fine grained nature of ICD Coding — The final code that is to be assigned to a diagnosis is a function of how contextualized and precise the final query is. (Image by Author)</figcaption></figure><p id="d2ea" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">What does contextualization mean here? When dealing with medical notes, to contextualize a diagnosis means to link it with all pertinent details — such as the bodypart affected and the symptoms of the condition — to fully characterize the diagnosis. Generally this task is referred to as <strong class="ml fr">relation extraction</strong>.</p></div></div><div class="nn"><div class="ab cb"><div class="lm pw ln px lo py cf pz cg qa ci bh"><figure class="ni nj nk nl nm nn qc qd paragraph-image"><div role="button" tabindex="0" class="qe qf ed qg bh qh"><div class="nf ng qb"><img src="../Images/3bcf3cb6b8074705379fc555c62cf3c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*IS7vPR0_YumfWzWV3EmITw.png"/></div></div><figcaption class="np nq nr nf ng ns nt bf b bg z dx">A representative example of the Relation Extraction process. Relation Extraction can help associate all relevant information for the main diagnosis in the medical note. (Image by Author)</figcaption></figure></div></div></div><div class="ab cb"><div class="ci bh ev ew ex ey"><h1 id="46fd" class="nu nv fq bf nw nx ny gq nz oa ob gt oc od oe of og oh oi oj ok ol om on oo op bk">How can LLMs help in automated ICD coding?</h1><p id="26dd" class="pw-post-body-paragraph mj mk fq ml b go oq mn mo gr or mq mr ms os mu mv mw ot my mz na ou nc nd ne fj bk">When addressing the challenges of automated ICD coding, Large Language Models (LLMs) are well-positioned to address these problems, particularly due to their adaptability to new labels and their ability to manage complex information extraction tasks. However the point here is not to argue that LLMs are the best solution for automated ICD coding, or that these are problems that only LLMs can solve. Rather, by establishing some of the main challenges than an automated ICD coding system must overcome, I analyze how best the abilities of LLMs can be leveraged to solve them.</p><h2 id="0f89" class="pe nv fq bf nw pf pg ph nz pi pj pk oc ms pl pm pn mw po pp pq na pr ps pt pu bk">Adapting to New and Rare ICD Codes:</h2><p id="cc72" class="pw-post-body-paragraph mj mk fq ml b go oq mn mo gr or mq mr ms os mu mv mw ot my mz na ou nc nd ne fj bk">LLMs demonstrate robust zero-shot and few-shot learning capabilities, allowing them to adapt to new tasks with minimal examples and instructions provided in the prompt. Retrieval-Augmented Generation (RAG) is another paradigm that enables LLMs to access more contextual information to adapt to new tasks without fine-tuning. This is particularly useful for adapting LLMs to new and/or rare ICD codes, which may not be frequently represented in training datasets, from just a few descriptions or examples of usage.</p><h2 id="c36f" class="pe nv fq bf nw pf pg ph nz pi pj pk oc ms pl pm pn mw po pp pq na pr ps pt pu bk">Contextualizing Information:</h2><p id="e705" class="pw-post-body-paragraph mj mk fq ml b go oq mn mo gr or mq mr ms os mu mv mw ot my mz na ou nc nd ne fj bk">LLMs are found to be effective at zero-shot relation extraction in the clinical domain [3] [4]. Zero-shot relation extraction allows LLMs to identify and categorize relationships in text without prior specific training on those relationships. This allows for better contextualization of the diagnosis in the medical coding to fetch more precise ICD codes.</p><h1 id="2949" class="nu nv fq bf nw nx ny gq nz oa ob gt oc od oe of og oh oi oj ok ol om on oo op bk">Exploring the paper “Automated clinical coding using off-the-shelf large language models”:</h1><p id="7842" class="pw-post-body-paragraph mj mk fq ml b go oq mn mo gr or mq mr ms os mu mv mw ot my mz na ou nc nd ne fj bk">While exploring recent works that applied LLMs towards ICD coding, I came across a very interesting paper that leveraged LLMs for ICD coding without any specific fine-tuning. The authors came up with a method which they termed <strong class="ml fr">LLM-guided tree-search </strong>[5].</p><h2 id="d4c7" class="pe nv fq bf nw pf pg ph nz pi pj pk oc ms pl pm pn mw po pp pq na pr ps pt pu bk">How does it work?</h2><p id="20f6" class="pw-post-body-paragraph mj mk fq ml b go oq mn mo gr or mq mr ms os mu mv mw ot my mz na ou nc nd ne fj bk">The ICD terminology is a hierarchical, tree-like structure. Each ICD code exists within this hierarchical structure where parent codes cover more general conditions, and child codes detail specific diseases. Traversing the ICD tree leads to more specific and fine-grained diagnosis codes.</p><p id="50ad" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">In LLM-guided tree search, the search begins at the root and uses the LLM to select branches for exploration, continuing iteratively until all paths are exhausted. Practically, this process is implemented by providing the descriptions of all codes at any given level of the tree, along with the medical note, as a prompt to the LLM and asking it to identify the relevant codes for the medical note. The codes selected by the LLM in each instance are then further traversed and explored. This method identifies the most pertinent ICD codes, which are subsequently assigned as predicted labels for the clinical note.</p></div></div><div class="nn"><div class="ab cb"><div class="lm pw ln px lo py cf pz cg qa ci bh"><figure class="ni nj nk nl nm nn qc qd paragraph-image"><div role="button" tabindex="0" class="qe qf ed qg bh qh"><div class="nf ng qi"><img src="../Images/0a2b99ac2336be8186f28fa9601522cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*CdrTHPg3hc_dCcU0_lOwgQ.png"/></div></div><figcaption class="np nq nr nf ng ns nt bf b bg z dx">The Tree-Search algorithm starts at the first level of the ICD tree. The descriptions of all the nodes in the first level along with the Medical Note are provided to the LLM, which is prompted to identify all relevant codes for the provided note. The output of the LLM is resolved as a set of Yes/No answers for each ICD code description. (Image by Author)</figcaption></figure></div></div></div><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="73ce" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Let’s clarify this with an example. Imagine a tree with two root nodes: ICD Code 1 and ICD Code 2. Each node has a plain-text description characterizing the code. In the initial stage, the LLM is given the medical note along with the descriptions of the codes and asked to identify the codes pertinent to the medical note.</p></div></div><div class="nn"><div class="ab cb"><div class="lm pw ln px lo py cf pz cg qa ci bh"><figure class="ni nj nk nl nm nn qc qd paragraph-image"><div role="button" tabindex="0" class="qe qf ed qg bh qh"><div class="nf ng qj"><img src="../Images/76ca69660ab14dc3e1c47bfdc5a52415.png" data-original-src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*sON4iTYL1HcYQkfkmXpq0Q.png"/></div></div><figcaption class="np nq nr nf ng ns nt bf b bg z dx">Given that the LLM predicted both ICD Code 1 and 2 as relevant to the medical note, the algorithm traverses the children of each of these nodes. Each node has 2 children codes, and the LLM is again invoked for each node’s children individually to identify if the child nodes are relevant to the medical note. (Image by Author)</figcaption></figure></div></div></div><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="51de" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">In this scenario, the LLM identifies both ICD Code 1 and ICD Code 2 as relevant to the medical note. The algorithm then examines the child nodes of each code. Each parent code has two child nodes representing more specific ICD codes. Starting with ICD Code 1, the LLM uses the descriptions of ICD Code 1.1 and ICD Code 1.2 along with the medical note to determine the relevant codes. The LLM concludes that ICD Code 1.1 is relevant, while ICD Code 1.2 is not. Since ICD Code 1.1 has no further child nodes, the algorithm checks if it is an assignable code and assigns it to the document. Next, the algorithm evaluates the child nodes of ICD Code 2. Invoking the LLM again, it determines that only ICD Code 2.1 is relevant. This is a simplified example; in reality, the ICD tree is extensive and deeper, meaning the algorithm will continue to traverse the children of each relevant node until it reaches the end of the tree or exhausts valid traversals.</p><h2 id="7da2" class="pe nv fq bf nw pf pg ph nz pi pj pk oc ms pl pm pn mw po pp pq na pr ps pt pu bk"><strong class="al">Highlights</strong></h2><ol class=""><li id="75e1" class="mj mk fq ml b go oq mn mo gr or mq mr ms os mu mv mw ot my mz na ou nc nd ne ov ow ox bk">This method does not require any fine-tuning of the LLM; it leverages the LLM’s ability to contextually understand the medical note and dynamically identify the relevant ICD codes based on the provided descriptions.</li><li id="62f2" class="mj mk fq ml b go oz mn mo gr pa mq mr ms pb mu mv mw pc my mz na pd nc nd ne ov ow ox bk">Furthermore, this paper shows that LLMs can effectively adapt to a large output space when given relevant information in the prompt, outperforming PLM-ICD [6] on rare codes in terms of macro-average metrics.</li><li id="84ed" class="mj mk fq ml b go oz mn mo gr pa mq mr ms pb mu mv mw pc my mz na pd nc nd ne ov ow ox bk">This technique also outperforms the baseline of directly asking the LLM to predict the ICD codes for a medical note based on its parametric knowledge. This highlights the potential in integrating LLMs with tools or external knowledge for solving clinical coding tasks.</li></ol><h2 id="950b" class="pe nv fq bf nw pf pg ph nz pi pj pk oc ms pl pm pn mw po pp pq na pr ps pt pu bk">Drawbacks</h2><ol class=""><li id="8eeb" class="mj mk fq ml b go oq mn mo gr or mq mr ms os mu mv mw ot my mz na ou nc nd ne ov ow ox bk">The algorithm invokes the LLM at every level in the tree. That leads to a high number of LLM invocations as you traverse the tree, compounded by the vastness of the ICD tree. This leads to high latency and costs in processing a single document.</li><li id="a32c" class="mj mk fq ml b go oz mn mo gr pa mq mr ms pb mu mv mw pc my mz na pd nc nd ne ov ow ox bk">As the authors also note in the paper, in order to correctly predict a relevant code, the LLM must correctly identify its parent nodes at all levels. Even if a mistake is made at one level, the LLM will be unable to reach the final relevant code.</li><li id="a028" class="mj mk fq ml b go oz mn mo gr pa mq mr ms pb mu mv mw pc my mz na pd nc nd ne ov ow ox bk">The authors were unable to evaluate their method using datasets like MIMIC-III due to limitations that prohibit the transfer of data to external services such as OpenAI’s GPT endpoints. Instead, they evaluated the method using the test set of the CodiEsp dataset [7,8], which includes 250 medical notes. The small size of this dataset suggests that the method’s effectiveness on larger clinical datasets is yet to be established.</li></ol><h1 id="ddc6" class="nu nv fq bf nw nx ny gq nz oa ob gt oc od oe of og oh oi oj ok ol om on oo op bk"><strong class="al">Implementing the technique described in the paper</strong></h1><blockquote class="qk ql qm"><p id="3b4a" class="mj mk qn ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">All code and resources related to this article are made available at <a class="af oy" href="https://github.com/anand-subu/automated-clinical-coding-llm" rel="noopener ugc nofollow" target="_blank">this link</a> with a mirror of the repo available in my original <a class="af oy" href="https://github.com/anand-subu/blog_resources" rel="noopener ugc nofollow" target="_blank">blog-related repository</a>. I wish to stress that my reimplementation is not exactly identical to the paper and differs in subtle ways that I’ve documented in the original repository. I’ve tried to replicate the prompts used for invoking GPT-3.5 and Llama-70B based on the details in the original paper. For translating the datasets from Spanish to English, I created my own prompt for doing that, as the details were not accessible in the paper.</p></blockquote><p id="a5a7" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Let’s implement the technique to better understand how it works. As mentioned, the paper uses the CodiEsp test set for its evaluation. This dataset consists of Spanish medical notes along with their ICD codes. Although the dataset includes an English translated version, the authors note that they translated the Spanish medical notes into English using GPT-3.5, which they claim provided a modest performance improvement over using the pre-translated version. We replicate this functionality and translate the notes into English.</p><pre class="ni nj nk nl nm qo qp qq bp qr bb bk"><span id="b2a6" class="qs nv fq qp b bg qt qu l qv qw">def construct_translation_prompt(medical_note):<br/>    """<br/>    Construct a prompt template for translating spanish medical notes to english.<br/>    <br/>    Args:<br/>        medical_note (str): The medical case note.<br/>        <br/>    Returns:<br/>        str: A structured template ready to be used as input for a language model.<br/>    """    <br/>    translation_prompt = """You are an expert Spanish-to-English translator. You are provided with a clinical note written in Spanish.<br/>You must translate the note into English. You must ensure that you properly translate the medical and technical terms from Spanish to English without any mistakes.<br/>Spanish Medical Note:<br/>{medical_note}"""<br/>    <br/>    return translation_prompt.format(medical_note = medical_note)</span></pre><p id="deb0" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Now that we have the evaluation corpus ready, let’s implement the core logic for the tree-search algorithm. We define the functionality in <strong class="ml fr">get_icd_codes</strong>, which accepts the medical note to process, the model name, and the temperature setting. The model name must be either <strong class="ml fr">“gpt-3.5-turbo-0613”</strong> for GPT-3.5 or <strong class="ml fr">“meta-llama/Llama-2–70b-chat-hf”</strong> for Llama-2 70B Chat. This specification determines the LLM that the tree-search algorithm will invoke during its processing.</p><p id="ff46" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Evaluating GPT-4 is possible using the same code-base by providing the appropriate model name, but we choose to skip it as it is quite time-consuming.</p><pre class="ni nj nk nl nm qo qp qq bp qr bb bk"><span id="f81e" class="qs nv fq qp b bg qt qu l qv qw">def get_icd_codes(medical_note, model_name="gpt-3.5-turbo-0613", temperature=0.0):<br/>    """<br/>    Identifies relevant ICD-10 codes for a given medical note by querying a language model.<br/><br/>    This function implements the tree-search algorithm for ICD coding described in https://openreview.net/forum?id=mqnR8rGWkn.<br/><br/>    Args:<br/>        medical_note (str): The medical note for which ICD-10 codes are to be identified.<br/>        model_name (str): The identifier for the language model used in the API (default is 'gpt-3.5-turbo-0613').<br/><br/>    Returns:<br/>        list of str: A list of confirmed ICD-10 codes that are relevant to the medical note.<br/>    """<br/>    assigned_codes = []<br/>    candidate_codes = [x.name for x in CHAPTER_LIST]<br/>    parent_codes = []<br/>    prompt_count = 0<br/><br/>    while prompt_count &lt; 50:<br/>        code_descriptions = {}<br/>        for x in candidate_codes:<br/>            description, code = get_name_and_description(x, model_name)<br/>            code_descriptions[description] = code<br/><br/>        prompt = build_zero_shot_prompt(medical_note, list(code_descriptions.keys()), model_name=model_name)<br/>        lm_response = get_response(prompt, model_name, temperature=temperature, max_tokens=500)<br/>        predicted_codes = parse_outputs(lm_response, code_descriptions, model_name=model_name)<br/><br/>        for code in predicted_codes:<br/>            if cm.is_leaf(code["code"]):<br/>                assigned_codes.append(code["code"])<br/>            else:<br/>                parent_codes.append(code)<br/><br/>        if len(parent_codes) &gt; 0:<br/>            parent_code = parent_codes.pop(0)<br/>            candidate_codes = cm.get_children(parent_code["code"])<br/>        else:<br/>            break<br/><br/>        prompt_count += 1<br/><br/>    return assigned_codes</span></pre><p id="cb02" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Similar to the paper, we use the <a class="af oy" href="https://github.com/StefanoTrv/simple_icd_10_CM" rel="noopener ugc nofollow" target="_blank"><strong class="ml fr">simple_icd_10_cm</strong></a><strong class="ml fr"> </strong>library, which provides access to the ICD-10 tree. This allows us to traverse the tree, access the descriptions for each code, and identify valid codes. First, we get the nodes at the first level of the tree.</p><pre class="ni nj nk nl nm qo qp qq bp qr bb bk"><span id="9b25" class="qs nv fq qp b bg qt qu l qv qw">import simple_icd_10_cm as cm<br/><br/>def get_name_and_description(code, model_name):<br/>    """<br/>    Retrieve the name and description of an ICD-10 code.<br/>    <br/>    Args:<br/>        code (str): The ICD-10 code.<br/>        <br/>    Returns:<br/>        tuple: A tuple containing the formatted description and the name of the code.<br/>    """<br/>    full_data = cm.get_full_data(code).split("\n")<br/>    return format_code_descriptions(full_data[3], model_name), full_data[1]</span></pre><p id="1d9a" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Inside the loop, we obtain the descriptions corresponding to each of the nodes. Now, we need to construct the prompt for the LLM based on the medical note and the code descriptions. We create the prompts for GPT-3.5 and Llama-2 based on the details provided in the paper.</p><pre class="ni nj nk nl nm qo qp qq bp qr bb bk"><span id="5d7a" class="qs nv fq qp b bg qt qu l qv qw">prompt_template_dict = {"gpt-3.5-turbo-0613" : """[Case note]:<br/>{note}<br/>[Example]:<br/>&lt;example prompt&gt;<br/>Gastro-esophageal reflux disease<br/>Enteropotosis<br/><br/>&lt;response&gt;<br/>Gastro-esophageal reflux disease: Yes, Patient was prescribed omeprazole.<br/>Enteropotosis: No.<br/><br/>[Task]:<br/>Consider each of the following ICD-10 code descriptions and evaluate if there are any related mentions in the case note.<br/>Follow the format in the example precisely.<br/><br/>{code_descriptions}""",<br/><br/>"meta-llama/Llama-2-70b-chat-hf": """[Case note]:<br/>{note}<br/><br/>[Example]:<br/>&lt;code descriptions&gt;<br/>* Gastro-esophageal reflux disease<br/>* Enteroptosis<br/>* Acute Nasopharyngitis [Common Cold]<br/>&lt;/code descriptions&gt;<br/><br/>&lt;response&gt;<br/>* Gastro-esophageal reflux disease: Yes, Patient was prescribed omeprazole.<br/>* Enteroptosis: No.<br/>* Acute Nasopharyngitis [Common Cold]: No.<br/>&lt;/response&gt;<br/><br/>[Task]:<br/>Follow the format in the example response exactly, including the entire description before your (Yes|No) judgement, followed by a newline. <br/>Consider each of the following ICD-10 code descriptions and evaluate if there are any related mentions in the Case note.<br/><br/>{code_descriptions}"""<br/>}</span></pre><p id="969f" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">We now construct the prompt based on the medical note and code descriptions. An advantage for us, in terms of prompting and coding, is that we can use the same <strong class="ml fr">openai</strong> library to interact with both GPT-3.5 and Llama 2, provided that Llama-2 is deployed using <a class="af oy" href="https://deepinfra.com/" rel="noopener ugc nofollow" target="_blank">deepinfra</a>, which also supports the <strong class="ml fr">openai</strong> format for sending requests to the LLM.</p><pre class="ni nj nk nl nm qo qp qq bp qr bb bk"><span id="0d73" class="qs nv fq qp b bg qt qu l qv qw">def construct_prompt_template(case_note, code_descriptions, model_name):<br/>    """<br/>    Construct a prompt template for evaluating ICD-10 code descriptions against a given case note.<br/>    <br/>    Args:<br/>        case_note (str): The medical case note.<br/>        code_descriptions (str): The ICD-10 code descriptions formatted as a single string.<br/>        <br/>    Returns:<br/>        str: A structured template ready to be used as input for a language model.<br/>    """<br/>    template = prompt_template_dict[model_name]<br/><br/>    return template.format(note=case_note, code_descriptions=code_descriptions)<br/><br/>def build_zero_shot_prompt(input_note, descriptions, model_name, system_prompt=""):<br/>    """<br/>    Build a zero-shot classification prompt with system and user roles for a language model.<br/>    <br/>    Args:<br/>        input_note (str): The input note or query.<br/>        descriptions (list of str): List of ICD-10 code descriptions.<br/>        system_prompt (str): Optional initial system prompt or instruction.<br/>        <br/>    Returns:<br/>        list of dict: A structured list of dictionaries defining the role and content of each message.<br/>    """<br/>    if model_name == "meta-llama/Llama-2-70b-chat-hf":<br/>        code_descriptions = "\n".join(["* " + x for x in descriptions])<br/>    else:<br/>        code_descriptions = "\n".join(descriptions)<br/><br/>    input_prompt = construct_prompt_template(input_note, code_descriptions, model_name)<br/>    return [{"role": "system", "content": system_prompt}, {"role": "user", "content": input_prompt}]</span></pre><p id="1b1a" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Having constructed the prompts, we now invoke the LLM to obtain the response:</p><pre class="ni nj nk nl nm qo qp qq bp qr bb bk"><span id="49a5" class="qs nv fq qp b bg qt qu l qv qw">def get_response(messages, model_name, temperature=0.0, max_tokens=500):<br/>    """<br/>    Obtain responses from a specified model via the chat-completions API.<br/>    <br/>    Args:<br/>        messages (list of dict): List of messages structured for API input.<br/>        model_name (str): Identifier for the model to query.<br/>        temperature (float): Controls randomness of response, where 0 is deterministic.<br/>        max_tokens (int): Limit on the number of tokens in the response.<br/>        <br/>    Returns:<br/>        str: The content of the response message from the model.<br/>    """<br/>    response = client.chat.completions.create(<br/>        model=model_name,<br/>        messages=messages,<br/>        temperature=temperature,<br/>        max_tokens=max_tokens<br/>    )<br/>    return response.choices[0].message.content</span></pre><p id="3d3f" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Great, we’ve obtained the output! From the response, we now parse each code description to identify the nodes that the LLM has deemed relevant for further traversal, as well as those nodes the LLM has rejected. We break the output response into new lines and split each response to identify the prediction of the LLM for each code description.</p><pre class="ni nj nk nl nm qo qp qq bp qr bb bk"><span id="0765" class="qs nv fq qp b bg qt qu l qv qw">def remove_noisy_prefix(text):<br/>    # Removing numbers or letters followed by a dot and optional space at the beginning of the string<br/>    cleaned_text = text.replace("* ", "").strip()<br/>    cleaned_text = re.sub(r"^\s*\w+\.\s*", "", cleaned_text)<br/>    return cleaned_text.strip()<br/><br/>def parse_outputs(output, code_description_map, model_name):<br/>    """<br/>    Parse model outputs to confirm ICD-10 codes based on a given description map.<br/>    <br/>    Args:<br/>        output (str): The model output containing confirmations.<br/>        code_description_map (dict): Mapping of descriptions to ICD-10 codes.<br/>        <br/>    Returns:<br/>        list of dict: A list of confirmed codes and their descriptions.<br/>    """<br/>    confirmed_codes = []<br/>    split_outputs = [x for x in output.split("\n") if x]<br/>    for item in split_outputs:<br/>        try:                <br/>            code_description, confirmation = item.split(":", 1)<br/>            if model_name == "meta-llama/Llama-2-70b-chat-hf":<br/>                code_description = remove_noisy_prefix(code_description)<br/><br/>            if confirmation.lower().strip().startswith("yes"):<br/>                try:<br/>                    code = code_description_map[code_description]<br/>                    confirmed_codes.append({"code": code, "description": code_description})<br/>                except Exception as e:<br/>                    print(str(e) + " Here")<br/>                    continue<br/>        except:<br/>            continue<br/>    return confirmed_codes</span></pre><p id="2a40" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Let’s look at the remainder of the loop now. So far, we have constructed the prompt, obtained the response from the LLM, and parsed the output to identify the codes deemed relevant by the LLM.</p><pre class="ni nj nk nl nm qo qp qq bp qr bb bk"><span id="612c" class="qs nv fq qp b bg qt qu l qv qw">while prompt_count &lt; 50:<br/>    code_descriptions = {}<br/>    for x in candidate_codes:<br/>        description, code = get_name_and_description(x, model_name)<br/>        code_descriptions[description] = code<br/><br/>    prompt = build_zero_shot_prompt(medical_note, list(code_descriptions.keys()), model_name=model_name)<br/>    lm_response = get_response(prompt, model_name, temperature=temperature, max_tokens=500)<br/>    predicted_codes = parse_outputs(lm_response, code_descriptions, model_name=model_name)<br/><br/>    for code in predicted_codes:<br/>        if cm.is_leaf(code["code"]):<br/>            assigned_codes.append(code["code"])<br/>        else:<br/>            parent_codes.append(code)<br/><br/>    if len(parent_codes) &gt; 0:<br/>        parent_code = parent_codes.pop(0)<br/>        candidate_codes = cm.get_children(parent_code["code"])<br/>    else:<br/>        break<br/><br/>    prompt_count += 1</span></pre><p id="6190" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Now we iterate through the predicted codes and check if each code is a <strong class="ml fr">“leaf”</strong> code, which essentially ensures that the code is a valid and assignable ICD code. If the predicted code is valid, we consider it as a prediction by the LLM for that medical note. If not, we add it to our parent codes and obtain the children nodes to further traverse the ICD tree. We break out of the loop if there are no more parent codes to further traverse.</p><p id="6ba5" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">In theory, the number of LLM invocations per medical note can be arbitrarily high, leading to increased latency if the algorithm traverses many nodes. The authors enforce a maximum of 50 prompts/LLM invocations per medical note to terminate the processing, a limit we also adopt in our implementation.</p><h2 id="5494" class="pe nv fq bf nw pf pg ph nz pi pj pk oc ms pl pm pn mw po pp pq na pr ps pt pu bk">Results</h2><p id="d446" class="pw-post-body-paragraph mj mk fq ml b go oq mn mo gr or mq mr ms os mu mv mw ot my mz na ou nc nd ne fj bk">We can now evaluate the results of the tree-search algorithm using GPT-3.5 and Llama-2 as the LLMs. We assess the performance of the algorithm in terms of micro-average and macro-average precision, recall, and F1-score.</p><figure class="ni nj nk nl nm nn nf ng paragraph-image"><div role="button" tabindex="0" class="qe qf ed qg bh qh"><div class="nf ng qx"><img src="../Images/a5e30b996754e8cab45988d7e2ce23e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XMQWMMdgyyVWIcr8XT3hHA.png"/></div></div><figcaption class="np nq nr nf ng ns nt bf b bg z dx">Results of our implementation for GPT-3.5 and Llama-2 70B Chat</figcaption></figure><p id="9be7" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">While the implementation’s results are roughly in the ball-park of the reported scores in the paper, there are some note-worthy differences.</p><ol class=""><li id="8259" class="mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne ov ow ox bk">In this implementation, GPT-3.5’s micro-average metrics slightly exceed the reported figures, while the macro-average metrics fall a bit short of the reported values.</li><li id="089b" class="mj mk fq ml b go oz mn mo gr pa mq mr ms pb mu mv mw pc my mz na pd nc nd ne ov ow ox bk">Similarly, Llama-70B’s micro-average metrics either match or slightly exceed the reported figures, but the macro-average metrics are lower than the reported values.</li></ol><p id="a774" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">As mentioned earlier, this implementation differs from the paper in a few minor ways, all of which impact the final performance. Please refer to the <a class="af oy" href="https://github.com/anand-subu/automated-clinical-coding-llm" rel="noopener ugc nofollow" target="_blank">linked repository</a> for a more detailed discussion of how this implementation differs from the original paper.</p><h1 id="c7a0" class="nu nv fq bf nw nx ny gq nz oa ob gt oc od oe of og oh oi oj ok ol om on oo op bk">Conclusion</h1><p id="56b8" class="pw-post-body-paragraph mj mk fq ml b go oq mn mo gr or mq mr ms os mu mv mw ot my mz na ou nc nd ne fj bk">Understanding and implementing this method was quite insightful for me in many ways. It allowed me to develop a more nuanced understanding of the strengths and weaknesses of Large Language Models (LLMs) in the clinical coding case. Specifically, it became evident that providing LLMs dynamic access to pertinent information about codes can help improve their performance.</p><p id="388c" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">It would be interesting to explore whether utilizing LLMs as agents for clinical coding could further improve performance. Given the abundance of external knowledge sources for biomedical and clinical texts in the form of papers or knowledge graphs, LLM agents could potentially be used in workflows that analyze medical documents at a finer granularity. They could also invoke tools that allow them to refer to external knowledge on the fly if required, to arrive at the final code.</p><h2 id="4a02" class="pe nv fq bf nw pf pg ph nz pi pj pk oc ms pl pm pn mw po pp pq na pr ps pt pu bk">Limitations</h2><p id="1fb4" class="pw-post-body-paragraph mj mk fq ml b go oq mn mo gr or mq mr ms os mu mv mw ot my mz na ou nc nd ne fj bk">In this article, while I tried to analyze how LLMs can help with respect to ICD coding, there are also some practical limitations to consider in general:</p><ol class=""><li id="6948" class="mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne ov ow ox bk">LLMs require significant computational resources for deployment. This leads to considerations such as the need for powerful GPUs without which applications may suffer from high latency, which can constrain their adoption.</li><li id="7e09" class="mj mk fq ml b go oz mn mo gr pa mq mr ms pb mu mv mw pc my mz na pd nc nd ne ov ow ox bk">Furthermore, healthcare data processing may often require strict data security and privacy safeguards. Online LLM services may not necessarily comply with the security and privacy standards required for healthcare data processing.</li></ol><h2 id="d151" class="pe nv fq bf nw pf pg ph nz pi pj pk oc ms pl pm pn mw po pp pq na pr ps pt pu bk">Acknowledgement</h2><p id="cddf" class="pw-post-body-paragraph mj mk fq ml b go oq mn mo gr or mq mr ms os mu mv mw ot my mz na ou nc nd ne fj bk">Huge thanks to Joseph, the lead author of this paper, for clarifying my doubts regarding the evaluation of this method!</p><h1 id="f82e" class="nu nv fq bf nw nx ny gq nz oa ob gt oc od oe of og oh oi oj ok ol om on oo op bk">References:</h1><p id="5bf3" class="pw-post-body-paragraph mj mk fq ml b go oq mn mo gr or mq mr ms os mu mv mw ot my mz na ou nc nd ne fj bk">[1] <a class="af oy" href="https://www.who.int/standards/classifications/classification-of-diseases" rel="noopener ugc nofollow" target="_blank">https://www.who.int/standards/classifications/classification-of-diseases</a></p><p id="386c" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">[2] Johnson, A. E., Pollard, T. J., Shen, L., Lehman, L. W. H., Feng, M., Ghassemi, M., … &amp; Mark, R. G. (2016). MIMIC-III, a freely accessible critical care database Sci. <em class="qn">Data</em>, <em class="qn">3</em>(1), 1.</p><p id="a6e1" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">[3] Agrawal, M., Hegselmann, S., Lang, H., Kim, Y., &amp; Sontag, D. (2022). Large language models are few-shot clinical information extractors. <em class="qn">arXiv preprint arXiv:2205.12689</em>.</p><p id="d0e7" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">[4] Zhou, H., Li, M., Xiao, Y., Yang, H., &amp; Zhang, R. (2023). LLM Instruction-Example Adaptive Prompting (LEAP) Framework for Clinical Relation Extraction. <em class="qn">medRxiv : the preprint server for health sciences</em>, 2023.12.15.23300059. <a class="af oy" href="https://doi.org/10.1101/2023.12.15.23300059" rel="noopener ugc nofollow" target="_blank">https://doi.org/10.1101/2023.12.15.23300059</a></p><p id="d1ce" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">[5] Boyle, J. S., Kascenas, A., Lok, P., Liakata, M., &amp; O’Neil, A. Q. (2023, October). Automated clinical coding using off-the-shelf large language models. In <em class="qn">Deep Generative Models for Health Workshop NeurIPS 2023</em>.</p><p id="c3a2" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">[6] Huang, C. W., Tsai, S. C., &amp; Chen, Y. N. (2022). PLM-ICD: automatic ICD coding with pretrained language models. <em class="qn">arXiv preprint arXiv:2207.05289</em>.</p><p id="de14" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">[7] Miranda-Escalada, A., Gonzalez-Agirre, A., Armengol-Estapé, J., &amp; Krallinger, M. (2020). Overview of Automatic Clinical Coding: Annotations, Guidelines, and Solutions for non-English Clinical Cases at CodiEsp Track of CLEF eHealth 2020. <em class="qn">CLEF (Working Notes)</em>, <em class="qn">2020</em>.</p><p id="5393" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">[8] Miranda-Escalada, A., Gonzalez-Agirre, A., &amp; Krallinger, M. (2020). CodiEsp corpus: gold standard Spanish clinical cases coded in ICD10 (CIE10) — eHealth CLEF2020 (1.4) [Data set]. Zenodo. <a class="af oy" href="https://doi.org/10.5281/zenodo.3837305" rel="noopener ugc nofollow" target="_blank">https://doi.org/10.5281/zenodo.3837305</a> (CC BY 4.0)</p></div></div></div></div>    
</body>
</html>