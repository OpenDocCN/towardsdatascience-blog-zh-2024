<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Build Your Own ChatGPT-like Chatbot with Java and Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Build Your Own ChatGPT-like Chatbot with Java and Python</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/build-your-own-chatgpt-like-chatbot-with-java-and-python-5def2c4852c3?source=collection_archive---------1-----------------------#2024-05-30">https://towardsdatascience.com/build-your-own-chatgpt-like-chatbot-with-java-and-python-5def2c4852c3?source=collection_archive---------1-----------------------#2024-05-30</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="7ff9" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx">Creating a custom LLM inference infrastructure from scratch</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hd he hf hg hh ab"><div><div class="ab hi"><div><div class="bm" aria-hidden="false"><a href="https://cardstdani.medium.com/?source=post_page---byline--5def2c4852c3--------------------------------" rel="noopener follow"><div class="l hj hk by hl hm"><div class="l ed"><img alt="Daniel García Solla" class="l ep by dd de cx" src="../Images/b6e7bc9fdfdfcda7875215b1e0264d9e.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/da:true/resize:fill:88:88/0*ySYZ9y6FyJnXPoaQ"/><div class="hn by l dd de em n ho eo"/></div></div></a></div></div><div class="hp ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--5def2c4852c3--------------------------------" rel="noopener follow"><div class="l hq hr by hl hs"><div class="l ed"><img alt="Towards Data Science" class="l ep by br ht cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hn by l br ht em n ho eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hu ab q"><div class="ab q hv"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hw hx bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hy" data-testid="authorName" href="https://cardstdani.medium.com/?source=post_page---byline--5def2c4852c3--------------------------------" rel="noopener follow">Daniel García Solla</a></p></div></div></div><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hw hx dx"><button class="ib ic ah ai aj ak al am an ao ap aq ar id ie if" disabled="">Follow</button></p></div></div></span></div></div><div class="l ig"><span class="bf b bg z dx"><div class="ab cn ih ii ij"><div class="ik il ab"><div class="bf b bg z dx ab im"><span class="in l ig">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hy ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--5def2c4852c3--------------------------------" rel="noopener follow"><p class="bf b bg z io ip iq ir is it iu iv bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">25 min read</span><div class="iw ix l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">May 30, 2024</span></div></span></div></span></div></div></div><div class="ab cp iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn"><div class="h k w ea eb q"><div class="kd l"><div class="ab q ke kf"><div class="pw-multi-vote-icon ed in kg kh ki"><div class=""><div class="kj kk kl km kn ko kp am kq kr ks ki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kt ku kv kw kx ky kz"><p class="bf b dy z dx"><span class="kk">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kj lc ld ab q ee le lf" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="lb"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg><p class="bf b dy z dx"><span class="pw-responses-count la lb">1</span></p></button></div></div></div><div class="ab q jo jp jq jr js jt ju jv jw jx jy jz ka kb kc"><div class="lg k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lh an ao ap id li lj lk" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep ll cn"><div class="l ae"><div class="ab cb"><div class="lm ln lo lp lq lr ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk ml"><img src="../Images/04f5c0784845e51a157b80a2649323bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_DvhhEajaSg70xzAUOuMng@2x.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Image by author</figcaption></figure><h2 id="461f" class="nc nd fq bf ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny nz bk">Introduction</h2><p id="f179" class="pw-post-body-paragraph oa ob fq oc b go od oe of gr og oh oi nn oj ok ol nr om on oo nv op oq or os fj bk">In recent years, <a class="af ot" href="https://aws.amazon.com/what-is/large-language-model/" rel="noopener ugc nofollow" target="_blank"><strong class="oc fr">Large Language Models (LLMs)</strong></a> have emerged as a game-changing technology that has revolutionized the way we interact with machines. These models, represented by OpenAI’s GPT series with examples such as GPT-3.5 or GPT-4, can take a sequence of input text and generate coherent, contextually relevant, and human-sounding text in reply. Thus, its applications are wide-ranging and cover a variety of fields, such as customer service, content creation, language translation, or code generation. However, at the core of these capabilities are advanced machine-learning/statistical techniques, including attention mechanisms for improving the natural language understanding process, transfer learning to provide foundational models at scale, data augmentation, or even <a class="af ot" href="https://huggingface.co/blog/rlhf" rel="noopener ugc nofollow" target="_blank"><strong class="oc fr">Reinforcement Learning From Human Feedback</strong></a>, which enable these systems to extend their training process and improve their performance continuously along inference.</p><p id="b06b" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">As a subset of artificial intelligence, machine learning is responsible for processing datasets to identify patterns and develop models that accurately represent the data’s nature. This approach generates valuable knowledge and unlocks a variety of tasks, for example, content generation, underlying the field of <a class="af ot" href="https://en.wikipedia.org/wiki/Generative_artificial_intelligence" rel="noopener ugc nofollow" target="_blank"><strong class="oc fr">Generative AI</strong> </a>that drives large language models. It is worth highlighting that this field is not solely focused on natural language, but also on any type of content susceptible to being generated. From audio, with models capable of generating sounds, voices, or music; videos through the latest models like OpenAI’s <a class="af ot" href="https://openai.com/index/sora/" rel="noopener ugc nofollow" target="_blank"><strong class="oc fr">SORA</strong></a>; or images, as well as editing and style transfer from text sequences. The latter data format is especially valuable, since by using multimodal integration and the help of image/text embedding technologies, it is possible to effectively illustrate the potential of knowledge representation through natural language.</p><p id="687e" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">Nevertheless, creating and maintaining models to perform this kind of operation, particularly at a large scale, is not an easy job. One of the main reasons is data, as it represents the major contribution to a well-functioning model. That is, training a model with a structurally optimal architecture and high-quality data will produce valuable results. Conversely, if the provided data is poor, the model will produce misleading outputs. Therefore, when creating a dataset, it should contain an appropriate volume of data for the particular model architecture. This requirement complicates data treatment and quality verification, in addition to the potential legal and privacy issues that must be considered if the data is collected by automation or scraping.</p><p id="14ee" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">Another reason lies in hardware. Modern deployed models, which need to process vast amounts of data from many users simultaneously, are not only large in size but also require substantial computing resources for performing inference tasks and providing quality service to their clients. That is reflected in equally significant costs in economic terms. On the one hand, setting up servers and data centers with the right hardware, considering that to provide a reliable service you need GPUs, <a class="af ot" href="https://cloud.google.com/tpu/docs/intro-to-tpu" rel="noopener ugc nofollow" target="_blank"><strong class="oc fr">TPUs</strong></a>, <a class="af ot" href="https://blogs.nvidia.com/blog/whats-a-dpu-data-processing-unit/" rel="noopener ugc nofollow" target="_blank"><strong class="oc fr">DPUs</strong></a>, and carefully selected components to maximize efficiency, is incredibly expensive. On the other hand, its maintenance requires skilled human resources — qualified people to solve potential issues and perform system upgrades as needed.</p><h2 id="0e4c" class="nc nd fq bf ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny nz bk">Objective</h2><p id="4c42" class="pw-post-body-paragraph oa ob fq oc b go od oe of gr og oh oi nn oj ok ol nr om on oo nv op oq or os fj bk">There are many other issues surrounding the construction of this kind of model and its large-scale deployment. Altogether, it is difficult to build a system with a supporting infrastructure robust enough to match leading services on the market like <a class="af ot" href="https://openai.com/chatgpt/" rel="noopener ugc nofollow" target="_blank"><strong class="oc fr">ChatGPT</strong></a>. Still, we can achieve rather acceptable and reasonable approximations to the reference service due to the wide range of open-source content and technologies available in the public domain. Moreover, given the high degree of progress presented in some of them, they prove to be remarkably simple to use, allowing us to benefit from their abstraction, modularity, ease of integration, and other valuable qualities that enhance the development process.</p><p id="8819" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">Therefore, the purpose of this article is to show how we can design, implement, and deploy a computing system for supporting a ChatGPT-like service. Although the eventual result may not have the expected service capabilities, using high-quality dependencies and development tools, as well as a good architectural design, guarantees the system to be easily scalable up to the desired computing power according to the user's needs. That is, the system will be prepared to run on very few machines, possibly as few as one, with very limited resources, delivering a throughput consistent with those resources, or on larger computer networks with the appropriate hardware, offering an extended service.</p><h1 id="4565" class="oz nd fq bf ne pa pb gq ni pc pd gt nm pe pf pg ph pi pj pk pl pm pn po pp pq bk">Architecture</h1><p id="7983" class="pw-post-body-paragraph oa ob fq oc b go od oe of gr og oh oi nn oj ok ol nr om on oo nv op oq or os fj bk">Initially, the primary system functionality will be to allow a client to submit a text query, which is processed by an LLM model and then returned to the source client, all within a reasonable timeframe and offering a fair quality of service. This is the highest level description of our system, specifically, of the application functionality provided by this system, since all the implementation details like communication protocols between components, data structures involved, etc. are being intentionally omitted. But, now that we have a clear objective to reach, we can begin a decomposition that gradually increases the detail involved in solving the problem, often referred to as <a class="af ot" href="https://stackoverflow.com/questions/947874/what-is-functional-decomposition" rel="noopener ugc nofollow" target="_blank"><strong class="oc fr">Functional Decomposition</strong></a>. Thus, starting from a black-box system <a class="af ot" href="https://en.wikipedia.org/wiki/Black_box" rel="noopener ugc nofollow" target="_blank"><em class="pr">(abstraction)</em></a> that receives and returns queries, we can begin to comprehensively define how a client interacts with the system, together with the technologies that will enable this interaction.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk ps"><img src="../Images/c4a11ecb1f9470fd5e8601f5d500cba8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1224/format:webp/1*0jHDs7HLpQKg-3mWlq3R4Q.png"/></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Image by author</figcaption></figure><p id="b59f" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">At first, we must determine what constitutes a client, in particular, what tools or interfaces the user will require to interact with the system. As illustrated above, we assume that the system is currently a fully implemented and operational functional unit; allowing us to focus on clients and client-system connections. In the client instance, the interface will be available via a website, designed for versatility, but primarily aimed at desktop devices. A mobile app could also be developed and integrated to use the same system services and with a specific interface, but from an abstract point of view, it is desirable to unify all types of clients into one, namely the web client.</p><p id="6543" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">Subsequently, it is necessary to find a way to connect a client with the system so that an exchange of information, in this case, queries, can occur between them. At this point, it is worth being aware that the web client will rely on a specific technology such as JavaScript, with all the communication implications it entails. For other types of platforms, that technology will likely change, for example to Java in mobile clients or C/C++ in IoT devices, and compatibility requirements may demand the system to adapt accordingly.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk pt"><img src="../Images/1ae51d8c94d610afad19d5df59daf004.png" data-original-src="https://miro.medium.com/v2/resize:fit:1068/format:webp/1*c7wLnv3NPHedSLnyURbrnQ.png"/></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Image by author</figcaption></figure><p id="3501" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">One way to establish communication would be to use <a class="af ot" href="https://www.geeksforgeeks.org/socket-in-computer-network/" rel="noopener ugc nofollow" target="_blank"><strong class="oc fr">Sockets</strong></a><strong class="oc fr"> </strong>and similar tools at a lower level, allowing exhaustive control of the whole protocol. However, this option would require meeting the compatibility constraints described above with all client technologies, as the system will need to be able to collect queries from all available client types. Additionally, having exhaustive control implies a lengthier and potentially far more complex development, since many extra details must be taken into account, which significantly increases the number of lines of code and complicates both its maintainability and extensibility.</p><p id="30fd" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">As you can see above, the most optimal alternative is to build an <a class="af ot" href="https://www.ibm.com/topics/api" rel="noopener ugc nofollow" target="_blank"><strong class="oc fr">Application Programming Interface (API)</strong></a> that intermediates between the clients and the system part in charge of the computing, i.e. the one that solves queries. The main advantage of using an API is that all the internal connection handling, such as opening and closing sockets, thread pooling, and other important details <em class="pr">(data serialization)</em>, is performed by the framework from which the API is built. In this way, we ensure that the client will only have to send its query to the server where the API is executed and wait for its response, all of this relying on dependencies that simplify the management of these API requests. Another benefit derived from the previous point is the ease of service extension by modifying the API <a class="af ot" href="https://www.baeldung.com/cs/api-endpoints" rel="noopener ugc nofollow" target="_blank"><strong class="oc fr">endpoints</strong></a>. For example, if we want to add a new model to the system or any other functionality, it is enough to add and implement a new endpoint, without having to change the communication protocol itself or the way a client interacts with the system.</p><h2 id="bc7a" class="nc nd fq bf ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny nz bk">Compute Service</h2><p id="a458" class="pw-post-body-paragraph oa ob fq oc b go od oe of gr og oh oi nn oj ok ol nr om on oo nv op oq or os fj bk">Once we set up a mechanism for clients to communicate elegantly with the system, we must address the problem of how to process incoming queries and return them to their corresponding clients in a reasonable amount of time. But first, it is relevant to point out that when a query arrives at the system, it must be redirected to a machine with an LLM loaded in memory with its respective inference pipeline and traverse the query through that pipeline, obtaining the result text <em class="pr">(LLM answer)</em> that will be later returned. Consequently, the inference process cannot be distributed among several machines for a query resolution. With that in mind, we can begin the design of the infrastructure that will support the inference process.</p><p id="5109" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">In the previous image, the compute service was represented as a single unit. If we consider it as a machine connected, this time, through a single channel using Sockets with the API server, we will be able to redirect all the API queries to that machine, concentrating all the system load in a single place. As you can imagine, this would be a good choice for a home system that only a few people will use. However, in this case, we need a way to make this approach scalable, so that with an increase in computing resources we can serve as many additional users as possible. But first, we must segment the previously mentioned computational resources into units. In this way, we will have a global vision of their interconnection and will be able to optimize our project throughput by changing their structure or how they are composed.</p><p id="f098" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">A computational unit, which from now on we will call node for the convenience of its implementation, will be integrated by a physical machine that receives requests <em class="pr">(not all of them)</em> needing to be solved. Additionally, we can consider a node as virtualization of a <em class="pr">(possibly reduced)</em> amount of machines, with the purpose of increasing the total throughput per node by introducing parallelism locally. Regarding the hardware employed, it will depend to a large extent on how the service is oriented and how far we want to go. Nevertheless, for the version presented in this case, we will assume a standard CPU, a generous amount of RAM to avoid problems when loading the model or forwarding queries, and dedicated processors as GPUs, with the possibility of including TPUs in some specific cases.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk pu"><img src="../Images/438dae7ba400296bda5f07129e1e5d9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1394/format:webp/1*R7hrsdDjML_qrvFozN4JYw.png"/></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Image by author</figcaption></figure><p id="f74e" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">Now, we can establish a network that links multiple nodes in such a way that via one of them, connected to the API server, queries can be distributed throughout the network, leveraging optimally all the system’s resources. Above, we can notice how all the nodes are structurally connected in a tree-like shape, with its root being responsible for collecting API queries and forwarding them accordingly. The decision of how they should be interconnected depends considerably on the exact system’s purpose. In this case, a tree is chosen for simplicity of the distribution primitives. For example, if we wanted to maximize the number of queries transmitted between the API and nodes, there would have to be several connections from the API to the root of several trees, or another distinct data structure if desired.</p><p id="fe43" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">Lastly, we need to define how a query is forwarded and processed when it reaches the root node. As before, there are many available and equally valid alternatives. However, the algorithm we will follow will also serve to understand why a tree structure is chosen to connect the system nodes.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk pv"><img src="../Images/56ace988d96c7a69a2176147578c375b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*c8uiFZfYhI-Z3UPF-VZsuw.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Image by author</figcaption></figure><p id="e2a5" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">Since a query must be solved on a single node, the goal of the distribution algorithm will be to find an idle node in the system and assign it the input query for its resolution. As can be seen above, if we consider an ordered sequence of queries numbered in natural order <em class="pr">(1 indexed)</em>, each number corresponds to the edge connected with the node assigned to solve that query. To understand the numbering in this concrete example, we can assume that the queries arriving at a node take an infinite time to be solved, therefore ensuring that each node is progressively busy facilitates the understanding of the algorithm heuristic.</p><p id="177b" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">In short, we will let the root not to perform any resolution processing, reserving all its capacity for the forwarding of requests with the API. For any other node, when it receives a query from a hierarchically superior node, the first step is to check if it is performing any computation for a previous query; if it is idle, it will resolve the query, and in the other case it will forward it by <a class="af ot" href="https://en.wikipedia.org/wiki/Round-robin_scheduling" rel="noopener ugc nofollow" target="_blank"><strong class="oc fr">Round Robin </strong></a>to one of its descendant nodes. With Round Robin, each query is redirected to a different descendant for each query, traversing the entire descendant list as if it were a circular buffer. This implies that the local load of a node can be evenly distributed downwards, while efficiently leveraging the resources of each node and our ability to scale the system by adding more descendants.</p><p id="8051" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">Finally, if the system is currently serving many users, and a query arrives at a leaf node that is also busy, it will not have any descendants for redirecting it to. Therefore, all nodes will have a query queuing mechanism in which they will wait in these situations, being able to apply batch operations between queued queries to accelerate LLM inference. Additionally, when a query is completed, to avoid overloading the system by forwarding it upwards until it arrives at the tree top, it is sent directly to the root, subsequently reaching the API and client. We could connect all nodes to the API, or implement other alternatives, however, to keep the code as simple and the system as performant as possible, they will all be sent to the root.</p><h1 id="a653" class="oz nd fq bf ne pa pb gq ni pc pd gt nm pe pf pg ph pi pj pk pl pm pn po pp pq bk">Web Client</h1><p id="d790" class="pw-post-body-paragraph oa ob fq oc b go od oe of gr og oh oi nn oj ok ol nr om on oo nv op oq or os fj bk">After having defined the complete system architecture and how it will perform its task, we can begin to build the web client that users will need when interacting with our solution.</p><figure class="mm mn mo mp mq mr"><div class="pw io l ed"><div class="px py l"/></div></figure><p id="16fe" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">As expected, the web client is implemented in basic HTML, CSS and JavaScript, everything embedded in a single .html file for convenience. This file will be provided by the API each time the client makes a request corresponding to the application startup, that is, when the client enters the browser and inputs the address where the API has hosted the entry point, it will return the .html file to be rendered in the browser.</p><p id="d7f9" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">Subsequently, when the user wishes to send a text query to the system, JavaScript internally submits an HTTP request to the API with the corresponding details such as the data type, endpoint, or <a class="af ot" href="https://en.wikipedia.org/wiki/Cross-site_request_forgery" rel="noopener ugc nofollow" target="_blank"><strong class="oc fr">CSRF </strong></a>security token. By using <a class="af ot" href="https://www.w3schools.com/js/js_ajax_intro.asp" rel="noopener ugc nofollow" target="_blank"><strong class="oc fr">AJAX </strong></a>within this process, it becomes very simple to define a primitive that executes when the API returns some value to the request made, in charge of displaying the result on the screen. Additionally, it is worth mentioning that the messages sent are not directly the written or returned text, but are wrapped in a <a class="af ot" href="https://en.wikipedia.org/wiki/JSONç" rel="noopener ugc nofollow" target="_blank"><strong class="oc fr">JSON</strong></a><strong class="oc fr"> </strong>with other important parameters, like the timestamp, offering the possibility to add extra fields on the fly to manage the synchronization of some system components.</p><h1 id="9752" class="oz nd fq bf ne pa pb gq ni pc pd gt nm pe pf pg ph pi pj pk pl pm pn po pp pq bk">Django API</h1><p id="18c3" class="pw-post-body-paragraph oa ob fq oc b go od oe of gr og oh oi nn oj ok ol nr om on oo nv op oq or os fj bk">When the web client is ready, we can proceed to implement the API which will provide the necessary service.</p><p id="86e1" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">There are many technologies available to build an API, but in this project we will specifically use <a class="af ot" href="https://developer.mozilla.org/en-US/docs/Learn/Server-side/Django/Introduction" rel="noopener ugc nofollow" target="_blank"><strong class="oc fr">Django</strong></a><strong class="oc fr"> </strong>through Python on a dedicated server. This decision is motivated by the high scalability and ease of integration with other Python dependencies offered by this framework, in addition to other useful properties such as security or the default administration panel.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk pz"><img src="../Images/622d9f5b9d5667ffb824103b9612709a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OBRYCD5eTyZLznEcSrM0aw.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Image by author</figcaption></figure><p id="0df8" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">One of the endpoints to configure is the entry point for the web client, represented by the default URL slash /. Thus, when a user accesses the server through a default HTTP request like the one shown above, the API will return the HTML code required to display the interface and start making requests to the LLM service.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk qa"><img src="../Images/58ad783edf8b7866cec09b9f4a188446.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DWD4EwpV-W4w-uZ3SxlgpQ.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Image by author</figcaption></figure><p id="cc85" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">At the same time, it will have to support the client’s requests once it has accessed the interface. These, as they have to be managed in a special way, will have their own endpoint called “/arranca” to where the query data will be sent in the corresponding JSON format, and the API returns the solved query after processing it with the node tree. In this endpoint, the server uses a previously established Socket channel with the root node in the hierarchy to forward the query, waiting for its response through a synchronization mechanism.</p><figure class="mm mn mo mp mq mr"><div class="pw io l ed"><div class="px py l"/></div></figure><p id="04aa" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">Concerning the code, in the <strong class="oc fr">urls.py</strong> file we will store the associations between URLs and endpoints, so that the default empty URL is assigned to its corresponding function that reads the .html from the templates folder and sends it back, or the URL /arranca that executes the function which solves a query. In addition, a views function will be executed to launch the main server thread. Meanwhile, in <strong class="oc fr">settings.py</strong>, the only thing to change is the DEBUG parameter to False and enter the necessary permissions of the hosts allowed to connect to the server.</p><p id="134b" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">Finally, there is the <strong class="oc fr">views.py</strong> script, where all the API functionality is implemented. First, we have a main thread in charge of receiving and handling incoming connections (from the root node). Initially, this connection will be permanent for the whole system's lifetime. However, it is placed inside an infinite loop in case it is interrupted and has to be reestablished. Secondly, the default endpoint is implemented with the <strong class="oc fr">index()</strong> function, which returns the .html content to the client if it performs a GET request. Additionally, the queries the user submits in the application are transferred to the API through the <strong class="oc fr"><em class="pr">/arranca</em></strong> endpoint, implemented in the function with the same name. There, the input query is forwarded to the root node, blocking until a response is received from it and returned to the client.</p><p id="1ef5" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">This blocking is achieved through <a class="af ot" href="https://docs.python.org/3/library/threading.html#condition-objects" rel="noopener ugc nofollow" target="_blank"><strong class="oc fr">locks</strong></a> and a synchronization mechanism where each query has a unique identifier, inserted by the <strong class="oc fr"><em class="pr">arranca()</em></strong> function as a field in the JSON message, named <strong class="oc fr">request_id</strong>. Essentially, it is a natural number that corresponds to the query arrival order. Therefore, when the root node sends a solved query to the API, it is possible to know which of its blocked executions was the one that generated the query, unblocking, returning, and re-blocking the rest.</p><h1 id="a917" class="oz nd fq bf ne pa pb gq ni pc pd gt nm pe pf pg ph pi pj pk pl pm pn po pp pq bk">Java Compute Nodes</h1><p id="2108" class="pw-post-body-paragraph oa ob fq oc b go od oe of gr og oh oi nn oj ok ol nr om on oo nv op oq or os fj bk">With the API operational, we will proceed to implement the node system in Java. The main reason for choosing this language is motivated by the technology that enables us to communicate between nodes. To obtain the simplest possible communication semantics at this level, we will discard the use of sockets and manually serialized messages and replace them with <a class="af ot" href="https://www.javatpoint.com/RMI" rel="noopener ugc nofollow" target="_blank"><strong class="oc fr">RMI</strong></a>, which in other platforms would be somewhat more complicated, although they also offer solutions such as <a class="af ot" href="https://pyro4.readthedocs.io/en/stable/" rel="noopener ugc nofollow" target="_blank"><strong class="oc fr">Pyro4 </strong></a>in Python.</p><p id="5db8" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk"><a class="af ot" href="https://en.wikipedia.org/wiki/Java_remote_method_invocation" rel="noopener ugc nofollow" target="_blank"><strong class="oc fr">Remote Method Invocation (RMI)</strong></a> is a communication paradigm that enables the creation of distributed systems composed of remote objects hosted on separate machines, with the ability to obtain remote references to each other and to invoke remote methods within their service interface. Hence, due to the high degree of abstraction in Java, the query transfer between nodes will be implemented with a remote call to an object referenced by the sender node, leaving the complex process of API connection to be handled manually, as it was previously done in Python.</p><figure class="mm mn mo mp mq mr"><div class="pw io l ed"><div class="px py l"/></div></figure><p id="d890" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">At the outset, we should define the remote interface that determines the remote invocable methods for each node. On the one hand, we have methods that return relevant information for debugging purposes <strong class="oc fr"><em class="pr">(log() or getIP())</em></strong>. On the other hand, there are those in charge of obtaining remote references to other nodes and registering them into the local hierarchy as an ascending or descending node, using a name that we will assume unique for each node. Additionally, it has two other primitives intended to receive an incoming query from another node <strong class="oc fr"><em class="pr">(receiveMessage())</em></strong> and to send a solved query to the API <strong class="oc fr"><em class="pr">(sendMessagePython())</em></strong>, only executed in the root node.</p><figure class="mm mn mo mp mq mr"><div class="pw io l ed"><div class="px py l"/></div></figure><p id="bf3d" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">From the interface, we can implement its operations inside the node class, instantiated every time we start up the system and decide to add a new machine to the node tree. Among the major features included in the node class is the <strong class="oc fr">getRemoteNode()</strong> method, which obtains a remote reference to another node from its name. For this purpose, it accesses the name registry and executes the lookup() primitive, returning the remote reference in the form of an interface, if it is registered, or null otherwise.</p><p id="4496" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">Obtaining remote references is essential in the construction of the tree, in particular for other methods that connect a parent node to a descendant or obtain a reference to the root to send solved queries. One of them is connectParent(), invoked when a descendant node needs to connect with a parent node. As you can see, it first uses getRemoteNode() to retrieve the parent node, and once it has the reference, assigns it to a local variable for each node instance. Afterwards it calls on the <strong class="oc fr">connectChild()</strong>, which appends to the descendant list the remote node from which it was invoked. In case the parent node does not exist, it will try to call a function on a null object, raising an exception. Next, it should be noted that the methods to receive queries from the API <strong class="oc fr">receiveMessagePython()</strong> and from other nodes <strong class="oc fr">receiveMessage() </strong>are protected with the synchronized clause to avoid race conditions that may interfere with the system’s correct operation. These methods are also responsible for implementing the query distribution heuristic, which uses a local variable to determine the corresponding node to which an incoming query should be sent.</p><p id="543d" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">At last, the node class has a thread pool used to manage the query resolution within the <strong class="oc fr">consultLLM()</strong> method. In this way, its calls will be immediately terminated within the Java code, since the pool will assign a thread to the execution of the required computation and will return the control to the program so it can accept additional queries. This is also an advantage when detecting whether a node is performing any computation or not, since it is enough to check if the number of active threads is greater than 0. On the other hand, the other use of threads in the node class, this time outside the pool, is in the <strong class="oc fr">connectServer()</strong> method in charge of connecting the root node with the API for query exchange.</p><figure class="mm mn mo mp mq mr"><div class="pw io l ed"><div class="px py l"/></div></figure><p id="48ed" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">In the <strong class="oc fr">Utilities </strong>class, we only have the method to create an LDAP usage context, with which we can register and look up remote references to nodes from their names. This method could be placed in the node class directly, but in case we need more methods like this, we leave it in the Utilities class to take advantage of the design pattern.</p><figure class="mm mn mo mp mq mr"><div class="pw io l ed"><div class="px py l"/></div></figure><p id="8715" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">The creation of node instances, as well as their management, which is performed manually for each of them, is implemented in the Launcher class. It uses a command line interface for instructing the respective node, which is created at startup with a specific name registered in the designated LDAP server. Some of the commands are:</p><ul class=""><li id="b46c" class="oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os qb qc qd bk"><strong class="oc fr">log: </strong>Prints useful information to know the node status.</li><li id="6bbd" class="oa ob fq oc b go qe oe of gr qf oh oi nn qg ok ol nr qh on oo nv qi oq or os qb qc qd bk"><strong class="oc fr">parent: </strong>Connects the node to a specified parent from its name.</li><li id="b9c4" class="oa ob fq oc b go qe oe of gr qf oh oi nn qg ok ol nr qh on oo nv qi oq or os qb qc qd bk"><strong class="oc fr">registry:</strong> Lists all nodes currently registered in the LDAP directory under the organizational unit <strong class="oc fr">ou=Nodes</strong>. This could be useful for monitoring the registry server or creating new nodes.</li><li id="e62d" class="oa ob fq oc b go qe oe of gr qf oh oi nn qg ok ol nr qh on oo nv qi oq or os qb qc qd bk"><strong class="oc fr">server: </strong>Connects the node to a server specified by its address and port number. Primarily, the server will be the Python API, although it could also serve other functionalities.</li></ul><h1 id="436d" class="oz nd fq bf ne pa pb gq ni pc pd gt nm pe pf pg ph pi pj pk pl pm pn po pp pq bk">LDAP Server</h1><p id="3d89" class="pw-post-body-paragraph oa ob fq oc b go od oe of gr og oh oi nn oj ok ol nr om on oo nv op oq or os fj bk">Since nodes are remote objects, they must have access to a registry that enables them to obtain remote references to other nodes from their name. The solution provided by Java is to use <strong class="oc fr">rmiregistry </strong>to initialize a registry service on a machine. However, when protected operations such as rebind() are executed from another host, it throws a security exception, preventing a new node from registering on a machine other than the one containing the registry. For this reason, and in addition to its simplicity, this project will use an Apache server as a registry using the <a class="af ot" href="https://learn.microsoft.com/en-us/previous-versions/windows/desktop/ldap/lightweight-directory-access-protocol-ldap-api" rel="noopener ugc nofollow" target="_blank"><strong class="oc fr">Lightweight Directory Access Protocol (LDAP)</strong></a>. This protocol allows to manage the storage of <em class="pr">Name-&gt;Remote_Node </em>pairs in a directory system, with other additional functionalities that significantly improve the registry service with respect to the one offered by the Java registry.</p><p id="b2d5" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">The advantages of using LDAP begin with its complexity of operation, which at first glance might seem the opposite, but in reality, is what enables the system to be adapted to various security and configuration needs at a much higher level of detail. On the one hand, the authentication and security features it offers allow any host to perform a protected operation such as registering a new node, as long as the host is identified by the LDAP server. For example, when a context object is created to access the server and be able to perform operations, there is the option of adding parameters to the HashMap of its constructor with authentication data. If the context is created, it means that the data matches what the server expects, otherwise, it could be assumed that the connection is being made by an unauthenticated <em class="pr">(“malicious”)</em> host, ensuring that only system nodes can manipulate the server information. On the other hand, LDAP allows for much more efficient centralization of node registration, and much more advanced interoperability, as well as easy integration of additional services like <a class="af ot" href="https://www.ibm.com/docs/en/aix/7.3?topic=network-kerberos" rel="noopener ugc nofollow" target="_blank"><strong class="oc fr">Kerberos</strong></a>.</p><p id="79fa" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">To ensure a server can operate as a node registry, we have to apply a specific configuration to it. First, since the project will not be deployed in an environment with real (and potentially malicious) users, all authentication options are omitted to keep things simple and clean. Next, a <a class="af ot" href="https://www.ibm.com/docs/en/i/7.5?topic=eim-distinguished-name" rel="noopener ugc nofollow" target="_blank"><strong class="oc fr">Distinguished Name</strong></a> must be defined so that a node name can be associated with its corresponding remote object. In this case, assuming that we prevent the registration of several nodes with the same name, we simply have to store the node name in an attribute such as cn= (Common Name) within a given organizational unit, ou=Nodes. Therefore, the distinguished name will be of the form: <strong class="oc fr">cn=Node_Name,ou=Nodes</strong></p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk qj"><img src="../Images/bb0053eddbdfba4f5fd216e06c3bdb0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:514/format:webp/1*hMqF-BxHT41SEn8EJJMwuA.png"/></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Image by author</figcaption></figure><p id="0151" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">Whenever a new node is created, it is registered in the LDAP server using its distinguished name and Node instance as a new entry in the form of a directory. Likewise, deleting a node or getting its remote reference from the registry requires using the distinguished name as well. Performing these operations on the registry implies having an open connection to the LDAP server. But, since the nodes are made with Java, we can use services that allow us to abstract the whole connection process and focus only on invoking the operations. The service to be used by nodes will be a directory context, commonly defined by the <a class="af ot" href="https://docs.oracle.com/javase/8/docs/api/javax/naming/directory/DirContext.html" rel="noopener ugc nofollow" target="_blank"><strong class="oc fr">DirContext</strong></a><strong class="oc fr"> </strong>interface. Thus, the process of accessing the server and performing some management is as simple as creating an object that implements the DirContext interface, in this case, InitialDirContext, assigning it the appropriate parameters to identify the server, including a URL of the form <strong class="oc fr">ldap://IP:port/</strong>, an identification of the protocol to be used, and even authentication parameters, which in this project will not be used.</p><h2 id="e310" class="nc nd fq bf ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny nz bk">Lookup, Bind, and Unbind</h2><p id="891b" class="pw-post-body-paragraph oa ob fq oc b go od oe of gr og oh oi nn oj ok ol nr om on oo nv op oq or os fj bk">For simplicity, Launcher will have its own context object, while each node will also have its own one. This allows Launcher to create entries and perform deletions, while each node will be able to perform lookup operations to obtain remote references from node names. Deletion operations are the simplest since they only require the distinguished name of the server entry corresponding to the node to be deleted. If it exists, it is deleted and the call to <strong class="oc fr">unbind()</strong> ends successfully, otherwise, it throws an exception. On the other hand, the lookup and register operations require following <a class="af ot" href="https://www.rfc-editor.org/rfc/rfc2713.html" rel="noopener ugc nofollow" target="_blank"><strong class="oc fr">RFC-2713</strong></a>. In the case of appending a node to the server, the <strong class="oc fr">bind()</strong> primitive is used, whose arguments are the distinguished name of the entry in which that node will be hosted, and its remote object. However, the bind function is not given the node object as is, nor its interface, since the object is not serializable and bind() cannot obtain an interface <em class="pr">“instance”</em> directly. As a workaround, the above RFC forces the node instance to be masked by a <a class="af ot" href="https://docs.oracle.com/javase/8/docs/api/java/rmi/MarshalledObject.html" rel="noopener ugc nofollow" target="_blank"><strong class="oc fr">MarshalledObjec</strong></a>t. Consequently, bind will receive a MarshalledObject composed of the node being registered within the server, instead of the original node instance.</p><p id="b83b" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">Finally, the lookup operation is performed from the <strong class="oc fr">lookup()</strong> primitive over a context. If the name and node have not been previously registered or an unexpected error occurs in the process, an exception is thrown. Conversely, if the operation succeeds, it returns the MarshalledObject associated with the distinguished name of the query. However, the remote reference returned by lookup() is contained in the MarshalledObject wrapper with which it was stored in the registry. Therefore, the <strong class="oc fr">get()</strong> operation of the MarshalledObject must be used to obtain the usable remote reference. Additionally, with this functionality it is possible to prevent the registration of a node with the same name as another already registered, as before executing bind() it would be checked with a lookup() if there is any exception related to the existence of the distinguished name.</p><h1 id="e008" class="oz nd fq bf ne pa pb gq ni pc pd gt nm pe pf pg ph pi pj pk pl pm pn po pp pq bk">LLM Inference</h1><p id="5c5e" class="pw-post-body-paragraph oa ob fq oc b go od oe of gr og oh oi nn oj ok ol nr om on oo nv op oq or os fj bk">Concerning the inference process at each node, the node tree has an LLMProcess class in charge of instantiating a process implemented in Python where the queries will be transferred before they are returned solved, since in Python we can easily manage the LLM and its inference pipeline.</p><figure class="mm mn mo mp mq mr"><div class="pw io l ed"><div class="px py l"/></div></figure><p id="0524" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">When a new LLMProcess is instantiated, it is necessary to find an available port on the machine to communicate the Java and Python processes. For simplicity, this data exchange will be accomplished with Sockets, so after finding an available port by opening and closing a ServerSocket, the<strong class="oc fr"> llm.py</strong> process is launched with the port number as an argument. Its main functions are <strong class="oc fr">destroyProcess()</strong>, to kill the process when the system is stopped, and <strong class="oc fr">sendQuery()</strong>, which sends a query to llm.py and waits for its response, using a new connection for each query.</p><figure class="mm mn mo mp mq mr"><div class="pw io l ed"><div class="px py l"/></div></figure><p id="35bf" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">Inside llm.py, there is a loop that continuously waits to accept an incoming connection from the Java process. When such a connection is established, it is handled by a <a class="af ot" href="https://docs.python.org/3/library/concurrent.futures.html#threadpoolexecutor" rel="noopener ugc nofollow" target="_blank"><strong class="oc fr">ThreadPoolExecutor()</strong></a> thread via the <strong class="oc fr">handle_connection()</strong> function, which reads the input data from the channel, interprets it in JSON format and forwards the “text” field to the inference pipeline. Once the data is returned, it is sent back to the Java process <em class="pr">(on the other side of the connection) </em>and the functions are returned, also releasing their corresponding threads.</p><h2 id="6a5d" class="nc nd fq bf ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny nz bk">Model Performance</h2><p id="ede3" class="pw-post-body-paragraph oa ob fq oc b go od oe of gr og oh oi nn oj ok ol nr om on oo nv op oq or os fj bk">As can be seen in the script, the pipeline instance allows us to select the LLM model that will be executed at the hosted node. This provides us with access to all those uploaded to the <a class="af ot" href="https://huggingface.co/models?pipeline_tag=text-generation&amp;sort=trending" rel="noopener ugc nofollow" target="_blank"><strong class="oc fr">Huggingface</strong></a><strong class="oc fr"> </strong>website, with very diverse options such as code generation models, chat, general response generation, etc.</p><p id="99f9" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">By default, we use the <strong class="oc fr">gpt2 </strong>model, which with about <a class="af ot" href="https://huggingface.co/transformers/v2.2.0/pretrained_models.html" rel="noopener ugc nofollow" target="_blank"><strong class="oc fr">117M parameters</strong></a> and about 500MB of weight, is the lightest and easiest option to integrate. As it is such a small model, its answers are rather basic, noting that a query resolution closely matches the prediction of the following text to the input one, as for example:</p><blockquote class="qk ql qm"><p id="2b21" class="oa ob pr oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">User: Hello.</p><p id="a30a" class="oa ob pr oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">GPT: Hello in that the first thing I’d like to mention is that there…</p></blockquote><p id="fc30" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">There are other versions of gpt2 such as <strong class="oc fr">gpt2-large </strong>or <strong class="oc fr">gpt2-xl</strong>, all available from Huggingface, the most powerful is XL, with 1.5B of parameters and 6GB of weight, significantly more powerful hardware is needed to run it, producing coherent responses like:</p><blockquote class="qk ql qm"><p id="fab8" class="oa ob pr oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">User: Hello.</p><p id="fdde" class="oa ob pr oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">GPT: Hello everyone — thanks for bearing with me all these months! In the past year I’ve put together…..</p></blockquote><p id="a586" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">Apart from the OpenAI GPT series, you can choose from many other available models, although most of them require an <a class="af ot" href="https://huggingface.co/docs/hub/en/security-tokens" rel="noopener ugc nofollow" target="_blank"><strong class="oc fr">authentication token</strong></a><strong class="oc fr"> </strong>to be inserted in the script. For example, recently modern models have been released, optimized in terms of occupied space and time required for a query to go through the entire inference pipeline. Llama3 is one of them, with small versions of <a class="af ot" href="https://huggingface.co/nvidia/Llama3-ChatQA-1.5-8B" rel="noopener ugc nofollow" target="_blank"><strong class="oc fr">8B parameters</strong></a>, and large-scale versions of <a class="af ot" href="https://huggingface.co/nvidia/Llama3-ChatQA-1.5-70B" rel="noopener ugc nofollow" target="_blank"><strong class="oc fr">70B</strong></a>.</p><p id="d690" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">However, choosing a model for a system should not be based solely on the number of parameters it has, since its architecture denotes the amount of knowledge it can model. For this reason, small models can be found with very similar performance to large-scale models, i.e., they produce answers with a very similar language understanding level, while optimizing the necessary computing resources to generate them. As a guide, you can use <a class="af ot" href="https://huggingface.co/collections/open-llm-leaderboard/the-big-benchmarks-collection-64faca6335a7fc7d4ffe974a" rel="noopener ugc nofollow" target="_blank"><strong class="oc fr">benchmarks</strong></a>, also provided by Huggingface itself, or <a class="af ot" href="https://github.com/leobeeson/llm_benchmarks" rel="noopener ugc nofollow" target="_blank"><strong class="oc fr">specialized tests</strong></a> to measure the above parameters for any LLM.</p><p id="f5e6" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">The results in the above tests, along with the average time it takes to respond on a given hardware is a fairly complete indicator for selecting a model. Although, always keep in mind that the LLM must fit in the chip memory on which it is running. Thus, if we use GPU inference, with CUDA as in the llm.py script, the graphical memory must be larger than the model size. If it is not, you must distribute the computation over <a class="af ot" href="https://huggingface.co/docs/diffusers/training/distributed_inference" rel="noopener ugc nofollow" target="_blank"><strong class="oc fr">several GPUs</strong></a>, on the same machine, or on more than one, depending on the complexity you want to achieve.</p><h2 id="c8e2" class="nc nd fq bf ne nf ng nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny nz bk">Kotlin Mobile Client</h2><p id="a775" class="pw-post-body-paragraph oa ob fq oc b go od oe of gr og oh oi nn oj ok ol nr om on oo nv op oq or os fj bk">Before we finish, we can see how a new type of client could be included in the system, thus demonstrating the extensibility offered by everything we have built so far. This project is of course an attempt at a <a class="af ot" href="https://www.geeksforgeeks.org/what-is-a-distributed-system/" rel="noopener ugc nofollow" target="_blank"><strong class="oc fr">Distributing System</strong></a> so of course you would expect it to be compatible with mobile devices just like the regular ChatGPT app is compatible with Android and iOS. In our case, we can develop an app for native Android, although a much better option would be to adapt the system to a multi-platform jetpack compose project. This option remains a possibility for a future update.</p><p id="44e1" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">The initial idea is to connect the mobile client to the API and use the same requests as the web one, with dependencies like <a class="af ot" href="https://developer.android.com/reference/kotlin/java/net/HttpURLConnection" rel="noopener ugc nofollow" target="_blank"><strong class="oc fr">HttpURLConnection</strong></a>. The code implementation isn't difficult and the documentation Android provides on the official page is also useful for this purpose. However, we can also emulate the functionality of the API with a custom Kotlin intermediate component, using ordinary TCP Android sockets for communication. Sockets are relatively easy to use, require a bit of effort to manage, ensure everything works correctly, and provide a decent level of control over the code. To address the lack of a regulatory API, we can place a Kotlin node between the mobile client and the Java node tree, which would manage the connection between the root node and only the mobile client as long as the web clients and the API are separate.</p><p id="ba50" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">Regarding the interface, the application we are imitating, ChatGPT, has a very clean and modern look, and since the HTTP version is already finished, we can try to copy it as closely as possible in the Android Studio editor.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk qn"><img src="../Images/330bb76614059e14df78a0e575d37464.png" data-original-src="https://miro.medium.com/v2/resize:fit:1010/format:webp/0*Hr0pq--vnHrTXPih"/></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Image by author</figcaption></figure><p id="ced3" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">When working with sockets, we have to make sure that the user is connected to the correct IP address and port of the server which will solve his queries. We can achieve this with a new initial interface that appears every time you open the application. It's a simple View with a button, a text view to enter the IP address and a small text label to give live information of what was happening to the user, as you can see above.</p><p id="bc29" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">Then, we need the interface to resemble a real chat, where new messages appear at the bottom and older ones move up. To achieve this, we can insert a RecyclerView, which will take up about 80% of the screen. The plan is to have a predefined message view that could be dynamically added to the view, and it would change based on whether the message was from the user or the system.</p><p id="76da" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">Finally, the problem with Android connections is that you can’t do any Network related operation in the main thread as it would give the <a class="af ot" href="https://developer.android.com/reference/android/os/NetworkOnMainThreadException" rel="noopener ugc nofollow" target="_blank"><strong class="oc fr">NetworkOnMainThreadException</strong></a>. But at the same time, you can’t manage the components if you aren’t in the main thread, as it will throw the <a class="af ot" href="https://stackoverflow.com/questions/44483224/how-can-i-fix-this-calledfromwrongthreadexception" rel="noopener ugc nofollow" target="_blank"><strong class="oc fr">CalledFromWrongThreadException</strong></a>. We can deal with it by moving the connection view into the main one, and most importantly making good use of coroutines, enabling you to perform network-related tasks from them.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk qo"><img src="../Images/7ce7122e49603c9bd56764e9a97a5fc8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bPnjhULZgOsCOEnm98UeGg.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Image by author</figcaption></figure><p id="f782" class="pw-post-body-paragraph oa ob fq oc b go ou oe of gr ov oh oi nn ow ok ol nr ox on oo nv oy oq or os fj bk">Now, if you run the system and enter a text query, the answer should appear a few seconds after sending it, just like in larger applications such as ChatGPT.</p><h1 id="f967" class="oz nd fq bf ne pa pb gq ni pc pd gt nm pe pf pg ph pi pj pk pl pm pn po pp pq bk">Conclusion</h1><p id="076b" class="pw-post-body-paragraph oa ob fq oc b go od oe of gr og oh oi nn oj ok ol nr om on oo nv op oq or os fj bk">Despite having a functional system, you can make significant improvements depending on the technology used to implement it, both software and hardware. However, it can provide a decent service to a limited number of users, ranging largely depending on the available resources. Finally, it should be noted that achieving the performance of real systems like ChatGPT is complicated, since the model size and hardware required to support it is particularly expensive. The system shown in this article is highly scalable for a small, even an intermediate solution, but achieving a large-scale solution requires far more complex technology, and possibly leveraging some of the structure of this system.</p><h1 id="36b9" class="oz nd fq bf ne pa pb gq ni pc pd gt nm pe pf pg ph pi pj pk pl pm pn po pp pq bk">Acknowledgments</h1><p id="36e4" class="pw-post-body-paragraph oa ob fq oc b go od oe of gr og oh oi nn oj ok ol nr om on oo nv op oq or os fj bk">Thanks to <a class="af ot" href="https://medium.com/@forexsencillo" rel="noopener"><strong class="oc fr">deivih84</strong></a><strong class="oc fr"> </strong>for the collaboration in the <strong class="oc fr">Kotlin </strong>Mobile Client section, <a class="af ot" href="https://medium.com/@carolinaherasc" rel="noopener"><strong class="oc fr">carolinaherasc</strong></a><strong class="oc fr"> </strong>in the RMI and Distributed System implementation, and <a class="af ot" href="https://medium.com/@hugodiezrubio" rel="noopener"><strong class="oc fr">hugodiezrubio</strong></a><strong class="oc fr"> </strong>in developing some of the system’s management components.</p></div></div></div></div>    
</body>
</html>