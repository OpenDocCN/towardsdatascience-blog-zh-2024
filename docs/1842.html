<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Stable and fast randomization using hash spaces</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Stable and fast randomization using hash spaces</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/stable-and-fast-randomization-using-hash-spaces-19000b9f27d3?source=collection_archive---------14-----------------------#2024-07-29">https://towardsdatascience.com/stable-and-fast-randomization-using-hash-spaces-19000b9f27d3?source=collection_archive---------14-----------------------#2024-07-29</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="ab4e" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx">Generate consistent assignments on the fly across different implementation environments</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hd he hf hg hh ab"><div><div class="ab hi"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@davidclarance?source=post_page---byline--19000b9f27d3--------------------------------" rel="noopener follow"><div class="l hj hk by hl hm"><div class="l ed"><img alt="David Clarance" class="l ep by dd de cx" src="../Images/02cf7cdde9576cdf3af30a79da4db747.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/1*tYE-QVQgfH_K8DbyvfGw1w.png"/><div class="hn by l dd de em n ho eo"/></div></div></a></div></div><div class="hp ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--19000b9f27d3--------------------------------" rel="noopener follow"><div class="l hq hr by hl hs"><div class="l ed"><img alt="Towards Data Science" class="l ep by br ht cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hn by l br ht em n ho eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hu ab q"><div class="ab q hv"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hw hx bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hy" data-testid="authorName" href="https://medium.com/@davidclarance?source=post_page---byline--19000b9f27d3--------------------------------" rel="noopener follow">David Clarance</a></p></div></div></div><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hw hx dx"><button class="ib ic ah ai aj ak al am an ao ap aq ar id ie if" disabled="">Follow</button></p></div></div></span></div></div><div class="l ig"><span class="bf b bg z dx"><div class="ab cn ih ii ij"><div class="ik il ab"><div class="bf b bg z dx ab im"><span class="in l ig">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hy ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--19000b9f27d3--------------------------------" rel="noopener follow"><p class="bf b bg z io ip iq ir is it iu iv bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">8 min read</span><div class="iw ix l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Jul 29, 2024</span></div></span></div></span></div></div></div><div class="ab cp iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn"><div class="h k w ea eb q"><div class="kd l"><div class="ab q ke kf"><div class="pw-multi-vote-icon ed in kg kh ki"><div class=""><div class="kj kk kl km kn ko kp am kq kr ks ki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kt ku kv kw kx ky kz"><p class="bf b dy z dx"><span class="kk">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kj lc ld ab q ee le lf" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="lb"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg><p class="bf b dy z dx"><span class="pw-responses-count la lb">1</span></p></button></div></div></div><div class="ab q jo jp jq jr js jt ju jv jw jx jy jz ka kb kc"><div class="lg k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lh an ao ap id li lj lk" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep ll cn"><div class="l ae"><div class="ab cb"><div class="lm ln lo lp lq lr ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk ml"><img src="../Images/fb459aab4c75749b21394c14a2ecbd26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YDR_lAG-1AqnuBxsGuX0aA.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">A bird’s eye view</figcaption></figure><p id="19e6" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">A core part of running an experiment is to assign an experimental unit (for instance a customer) to a specific treatment (payment button variant, marketing push notification framing). Often this assignment needs to meet the following conditions:</p><ol class=""><li id="2f77" class="nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa bk">It needs to be random.</li><li id="9d06" class="nc nd fq ne b go ob ng nh gr oc nj nk nl od nn no np oe nr ns nt of nv nw nx ny nz oa bk">It needs to be stable. If the customer comes back to the screen, they need to be exposed to the same payment button variant.</li><li id="2d71" class="nc nd fq ne b go ob ng nh gr oc nj nk nl od nn no np oe nr ns nt of nv nw nx ny nz oa bk">It needs to be retrieved or generated very quickly.</li><li id="d5e9" class="nc nd fq ne b go ob ng nh gr oc nj nk nl od nn no np oe nr ns nt of nv nw nx ny nz oa bk">It needs to be available after the actual assignment so it can be used in downstream analysis.</li></ol><p id="35d0" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">When organizations first start their experimentation journey, a common pattern is to pre-generate assignments, store it in a database and then retrieve it at the time of assignment. This is a perfectly valid method to use and works great when you’re starting off. However, as you start to scale in customer and experiment volumes, this method becomes harder and harder to maintain and use reliably. You’ve got to (a) manage the complexity of storage, (b) ensure that assignments are actually random <em class="og">within </em>and <em class="og">across </em>experiments, and (c) retrieve the assignment reliably. All of these are hard at scale.</p><p id="73b4" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Using <em class="og">hash spaces</em> helps solve some of these problems. It’s a simple solution but isn’t as widely known as it probably should be. This blog is an attempt to explain the technique. There are links to code in different languages at the end. However, if you’d like, you can also directly <a class="af oh" href="https://gist.github.com/davidclarance/daeafad5fc3e28e019950a12b0da01f5" rel="noopener ugc nofollow" target="_blank">jump to code here</a>.</p><h1 id="5fc3" class="oi oj fq bf ok ol om gq on oo op gt oq or os ot ou ov ow ox oy oz pa pb pc pd bk">Setting up</h1><p id="7cf5" class="pw-post-body-paragraph nc nd fq ne b go pe ng nh gr pf nj nk nl pg nn no np ph nr ns nt pi nv nw nx fj bk">We’re running an experiment to test which variant of a progress bar on our customer app drives the most engagement. There are three variants: Control (the default experience), Variant A and Variant B.</p><p id="0c8e" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">We have 10 million customers that use our app every week and we want to ensure that these 10 million customers get randomly assigned to one of the three variants. Each time the customer comes back to the app they should see the same variant. We want control to be assigned with a 50% probability, Variant 1 to be assigned with a 30% probability and Variant 2 to be assigned with a 20% probability.</p><pre class="mm mn mo mp mq pj pk pl bp pm bb bk"><span id="edcc" class="pn oj fq pk b bg po pp l pq pr">probability_assignments = {"Control": 50, "Variant 1": 30, "Variant 2": 20}</span></pre><p id="1b46" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">To make things simpler, we’ll start with 4 customers. These customers have IDs that we use to refer to them. These IDs are generally either GUIDs (something like <code class="cx ps pt pu pk b">"b7be65e3-c616-4a56-b90a-e546728a6640"</code>) or integers (like 1019222, 1028333). Any of these ID types would work but to make things easier to follow we’ll simply assume that these IDs are: “Customer1”, “Customer2”, “Customer3”, “Customer4”.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div class="mj mk pv"><img src="../Images/2c3e1b8d1a9749e82665f0b85b625077.png" data-original-src="https://miro.medium.com/v2/resize:fit:1110/format:webp/1*EOccNxbmyG7rQhMAdVK4ew.png"/></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">Our goal is to map these 4 customers to the three possible variants.</figcaption></figure><h1 id="d672" class="oi oj fq bf ok ol om gq on oo op gt oq or os ot ou ov ow ox oy oz pa pb pc pd bk">Hashing customer IDs</h1><p id="d904" class="pw-post-body-paragraph nc nd fq ne b go pe ng nh gr pf nj nk nl pg nn no np ph nr ns nt pi nv nw nx fj bk">This method primarily relies on using hash algorithms that come with some very desirable properties. Hashing algorithms take a string of arbitrary length and map it to a ‘hash’ of a fixed length. The easiest way to understand this is through some examples.</p><p id="a145" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">A hash function, takes a string and maps it to a constant hash space. In the example below, a hash function (in this case <a class="af oh" href="https://en.wikipedia.org/wiki/MD5" rel="noopener ugc nofollow" target="_blank">md5</a>) takes the words: “Hello”, “World”, “Hello World” and “Hello WorLd” (note the capital L) and maps it to an alphanumeric string of 32 characters.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk pw"><img src="../Images/00d92d992fb4fc78be549a1e6584b213.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oWfok2tu59q9c81nBnjacQ.png"/></div></div></figure><p id="aa38" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">A few important things to note:</p><ul class=""><li id="8378" class="nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx px nz oa bk">The hashes are all of the same length.</li><li id="aeb5" class="nc nd fq ne b go ob ng nh gr oc nj nk nl od nn no np oe nr ns nt of nv nw nx px nz oa bk">A minor difference in the input (capital L instead of small L) changes the hash.</li><li id="5d98" class="nc nd fq ne b go ob ng nh gr oc nj nk nl od nn no np oe nr ns nt of nv nw nx px nz oa bk">Hashes are a hexadecimal string. That is, they comprise of the numbers 0 to 9 and the first six alphabets (a, b, c, d, e and f).</li></ul><p id="8828" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">We can use this same logic and get hashes for our four customers:</p><pre class="mm mn mo mp mq pj pk pl bp pm bb bk"><span id="8761" class="pn oj fq pk b bg po pp l pq pr">import hashlib<br/><br/>representative_customers = ["Customer1", "Customer2", "Customer3", "Customer4"]<br/><br/>def get_hash(customer_id):<br/>    hash_object = hashlib.md5(customer_id.encode())<br/>    return hash_object.hexdigest()<br/>    <br/>{customer: get_hash(customer) for customer in representative_customers}<br/><br/># {'Customer1': 'becfb907888c8d48f8328dba7edf6969',<br/>#  'Customer2': '0b0216b290922f789dd3efd0926d898e',<br/>#  'Customer3': '2c988de9d49d47c78f9f1588a1f99934',<br/>#  'Customer4': 'b7ca9bb43a9387d6f16cd7b93a7e5fb0'}</span></pre><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk pw"><img src="../Images/ef410f40b4ade02a5f145ea2809b19e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DxrSEfpMOZT4kEOHE2hp5Q.png"/></div></div></figure><p id="5d47" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Hexadecimal strings are just representations of numbers in base 16. We can <a class="af oh" href="https://g.co/gemini/share/83e1757e48f9" rel="noopener ugc nofollow" target="_blank">convert them to integers in base 10</a>.</p><blockquote class="py pz qa"><p id="a786" class="nc nd og ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">⚠️ One important note here: We rarely need to use the full hash. In practice (for instance in the linked code) we use a much smaller part of the hash (first 10 characters). Here we use the full hash to make explanations a bit easier.</p></blockquote><pre class="mm mn mo mp mq pj pk pl bp pm bb bk"><span id="a52b" class="pn oj fq pk b bg po pp l pq pr">def get_integer_representation_of_hash(customer_id):<br/>    hash_value = get_hash(customer_id)<br/>    return int(hash_value, 16)<br/><br/>{<br/>    customer: get_integer_representation_of_hash(customer)<br/>    for customer in representative_customers<br/>}<br/><br/># {'Customer1': 253631877491484416479881095850175195497,<br/>#  'Customer2': 14632352907717920893144463783570016654,<br/>#  'Customer3': 59278139282750535321500601860939684148,<br/>#  'Customer4': 244300725246749942648452631253508579248}</span></pre><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk pw"><img src="../Images/0cb07f18fec04b5226a7cda3b7113521.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vzlIxc05qRDDMWqZrx6fbw.png"/></div></div></figure><p id="d2dc" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">There are two important properties of these integers:</p><ol class=""><li id="aca0" class="nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa bk">These integers are <strong class="ne fr">stable</strong>: Given a fixed input (“Customer1”), the hashing algorithm will always give the same output.</li><li id="2770" class="nc nd fq ne b go ob ng nh gr oc nj nk nl od nn no np oe nr ns nt of nv nw nx ny nz oa bk">These integers are <strong class="ne fr">uniformly distributed</strong>: This one hasn’t been explained yet and mostly applies to cryptographic hash functions (such as md5). Uniformity is a design requirement for these hash functions. If they were not uniformly distributed, the chances of collisions (getting the same output for different inputs) would be higher and weaken the security of the hash. There are some <a class="af oh" href="https://www.rolando.cl/blog/2018/12/how_uniform_is_md5.html" rel="noopener ugc nofollow" target="_blank">explorations </a>of the <a class="af oh" href="https://stackoverflow.com/a/9346575/4583536" rel="noopener ugc nofollow" target="_blank">uniformity </a>property.</li></ol><p id="1af9" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Now that we have an integer representation of each ID that’s stable (always has the same value) and <a class="af oh" href="https://en.wikipedia.org/wiki/Hash_function#Uniformity" rel="noopener ugc nofollow" target="_blank">uniformly distributed</a>, we can use it to get to an assignment.</p><h1 id="e1cd" class="oi oj fq bf ok ol om gq on oo op gt oq or os ot ou ov ow ox oy oz pa pb pc pd bk">From integer representations to assignment</h1><p id="450f" class="pw-post-body-paragraph nc nd fq ne b go pe ng nh gr pf nj nk nl pg nn no np ph nr ns nt pi nv nw nx fj bk">Going back to our probability assignments, we want to assign customers to variants with the following distribution:</p><pre class="mm mn mo mp mq pj pk pl bp pm bb bk"><span id="0594" class="pn oj fq pk b bg po pp l pq pr">{"Control": 50, "Variant 1": 30, "Variant 2": 20}</span></pre><p id="4b18" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">If we had 100 slots, we can divide them into 3 buckets where the number of slots represents the probability we want to assign to that bucket. For instance, in our example, we divide the integer range 0–99 (100 units), into 0–49 (50 units), 50–79 (30 units) and 80–99 (20 units).</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk pw"><img src="../Images/47916521fbf40c2ba86ba2655962d4b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UrtIDwG5ks4U9w6pJxvo1w.png"/></div></div></figure><pre class="mm mn mo mp mq pj pk pl bp pm bb bk"><span id="d694" class="pn oj fq pk b bg po pp l pq pr">def divide_space_into_partitions(prob_distribution):<br/>    partition_ranges = []<br/>    start = 0<br/>    for partition in prob_distribution:<br/>        partition_ranges.append((start, start + partition))<br/>        start += partition<br/>    return partition_ranges<br/><br/>divide_space_into_partitions(prob_distribution=probability_assignments.values())<br/><br/># note that this is zero indexed, lower bound inclusive and upper bound exclusive<br/># [(0, 50), (50, 80), (80, 100)]</span></pre><p id="9a0f" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Now, if we assign a customer to one of the 100 slots randomly, the resultant distribution should then be equal to our intended distribution. Another way to think about this is, if we choose a number randomly between 0 and 99, there’s a 50% chance it’ll be between 0 and 49, 30% chance it’ll be between 50 and 79 and 20% chance it’ll be between 80 and 99.</p><p id="5f9e" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">The only remaining step is to map the customer integers we generated to one of these hundred slots. We do this by extracting the last two digits of the integer generated and using that as the assignment. For instance, the last two digits for customer 1 are 97 (you can check the diagram below). This falls in the third bucket (Variant 2) and hence the customer is assigned to Variant 2.</p><p id="9ac5" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">We repeat this process iteratively for each customer. When we’re done with all our customers, we should find that the end distribution will be what we’d expect: 50% of customers are in control, 30% in variant 1, 20% in variant 2.</p><pre class="mm mn mo mp mq pj pk pl bp pm bb bk"><span id="1e45" class="pn oj fq pk b bg po pp l pq pr">def assign_groups(customer_id, partitions):<br/>    hash_value = get_relevant_place_value(customer_id, 100)<br/>    for idx, (start, end) in enumerate(partitions):<br/>        if start &lt;= hash_value &lt; end:<br/>            return idx<br/>    return None<br/><br/><br/>partitions = divide_space_into_partitions(<br/>    prob_distribution=probability_assignments.values()<br/>)<br/><br/>groups = {<br/>    customer: list(probability_assignments.keys())[assign_groups(customer, partitions)]<br/>    for customer in representative_customers<br/>}<br/><br/># output<br/># {'Customer1': 'Variant 2',<br/>#  'Customer2': 'Variant 1',<br/>#  'Customer3': 'Control',<br/>#  'Customer4': 'Control'}</span></pre><p id="860d" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">The <a class="af oh" href="https://gist.github.com/davidclarance/daeafad5fc3e28e019950a12b0da01f5?permalink_comment_id=5136729#gistcomment-5136729" rel="noopener ugc nofollow" target="_blank">linked gist</a> has a replication of the above for 1,000,000 customers where we can observe that customers are distributed in the expected proportions.</p><pre class="mm mn mo mp mq pj pk pl bp pm bb bk"><span id="28e5" class="pn oj fq pk b bg po pp l pq pr"># resulting proportions from a simulation on 1 million customers.<br/>{'Variant 1': 0.299799, 'Variant 2': 0.199512, 'Control': 0.500689</span></pre></div></div></div><div class="ab cb qb qc qd qe" role="separator"><span class="qf by bm qg qh qi"/><span class="qf by bm qg qh qi"/><span class="qf by bm qg qh"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><h1 id="cf9d" class="oi oj fq bf ok ol qj gq on oo qk gt oq or ql ot ou ov qm ox oy oz qn pb pc pd bk">Practical considerations</h1><h1 id="c048" class="oi oj fq bf ok ol om gq on oo op gt oq or os ot ou ov ow ox oy oz pa pb pc pd bk">Adding ‘salt’ to an experiment</h1><p id="55e0" class="pw-post-body-paragraph nc nd fq ne b go pe ng nh gr pf nj nk nl pg nn no np ph nr ns nt pi nv nw nx fj bk">In practice, when you’re running multiple experiments across different parts of your product, it’s common practice to add in a “salt” to the IDs before you hash them. This salt can be anything: the experiment name, an experiment id, the name of the feature etc. This ensures that the customer to bucket mapping is always different across experiments given that the salt is different. This is really helpful to ensure that customer aren’t always falling in the same buckets. For instance, you don’t want specific customers to always fall into the control treatment if it just happens that the control is allocated the first 50 buckets in all your experiments. This is straightforward to implement.</p><pre class="mm mn mo mp mq pj pk pl bp pm bb bk"><span id="06d8" class="pn oj fq pk b bg po pp l pq pr">salt_id = "f7d1b7e4-3f1d-4b7b-8f3d-3f1d4b7b8f3d"<br/>customer_with_salt_id = [<br/>    f"{customer}{salt_id}" for customer in representative_customers<br/>]<br/><br/># ['Customer1f7d1b7e4-3f1d-4b7b-8f3d-3f1d4b7b8f3d',<br/>#  'Customer2f7d1b7e4-3f1d-4b7b-8f3d-3f1d4b7b8f3d',<br/>#  'Customer3f7d1b7e4-3f1d-4b7b-8f3d-3f1d4b7b8f3d',<br/>#  'Customer4f7d1b7e4-3f1d-4b7b-8f3d-3f1d4b7b8f3d']</span></pre><h1 id="12ab" class="oi oj fq bf ok ol om gq on oo op gt oq or os ot ou ov ow ox oy oz pa pb pc pd bk">Increasing the partitioned space</h1><p id="b58a" class="pw-post-body-paragraph nc nd fq ne b go pe ng nh gr pf nj nk nl pg nn no np ph nr ns nt pi nv nw nx fj bk">In this example, we used a space that consisted of 100 possible slots (or partitions). If you wanted to assign probabilities that were one or more decimal places, you’d just take the last n digits of the integer generated.</p><p id="4a30" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">So for instance if you wanted to assign probabilities that were up to two decimal places, you could take the last 4 digits of the integer generated. That is, the value of <code class="cx ps pt pu pk b">place_value</code> below would be 10000.</p><pre class="mm mn mo mp mq pj pk pl bp pm bb bk"><span id="aa33" class="pn oj fq pk b bg po pp l pq pr">def get_relevant_place_value(customer_id, place_value):<br/>    hash_value = get_integer_representation_of_hash(customer_id)<br/>    return hash_value % place_value</span></pre><h1 id="2a8f" class="oi oj fq bf ok ol om gq on oo op gt oq or os ot ou ov ow ox oy oz pa pb pc pd bk">Cross environment availability</h1><p id="79bb" class="pw-post-body-paragraph nc nd fq ne b go pe ng nh gr pf nj nk nl pg nn no np ph nr ns nt pi nv nw nx fj bk">Finally, one reason this method is so powerful and attractive in practice is that you can replicate the process identically across different implementation environments. The core hashing algorithm will always give you the same hash in any environment as long as the input is the same. All you need is the <code class="cx ps pt pu pk b">CustomerId</code>, <code class="cx ps pt pu pk b">SaltId</code>and the intended probability distribution. You can find different implementations here:</p><ul class=""><li id="d724" class="nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx px nz oa bk"><a class="af oh" href="https://gist.github.com/davidclarance/daeafad5fc3e28e019950a12b0da01f5" rel="noopener ugc nofollow" target="_blank">Python</a></li><li id="2695" class="nc nd fq ne b go ob ng nh gr oc nj nk nl od nn no np oe nr ns nt of nv nw nx px nz oa bk"><a class="af oh" href="https://gist.github.com/davidclarance/b69559191e6628d32d8f2adf271e067f" rel="noopener ugc nofollow" target="_blank">DuckDB</a></li><li id="2490" class="nc nd fq ne b go ob ng nh gr oc nj nk nl od nn no np oe nr ns nt of nv nw nx px nz oa bk"><a class="af oh" href="https://gist.github.com/davidclarance/99a22cc90bd7172fc2a2d00745b62c0e" rel="noopener ugc nofollow" target="_blank">TSQL</a></li></ul></div></div></div><div class="ab cb qb qc qd qe" role="separator"><span class="qf by bm qg qh qi"/><span class="qf by bm qg qh qi"/><span class="qf by bm qg qh"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><h1 id="d364" class="oi oj fq bf ok ol qj gq on oo qk gt oq or ql ot ou ov qm ox oy oz qn pb pc pd bk">Wrapping up</h1><p id="992a" class="pw-post-body-paragraph nc nd fq ne b go pe ng nh gr pf nj nk nl pg nn no np ph nr ns nt pi nv nw nx fj bk">If you want to generate random, fast and stable assignments across different implementation environments, you can use the following:</p><ul class=""><li id="e800" class="nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx px nz oa bk">Use a cryptographic hashing function (such as md5) to generate a hash from a unique ID + some ‘salt’.</li><li id="ca0f" class="nc nd fq ne b go ob ng nh gr oc nj nk nl od nn no np oe nr ns nt of nv nw nx px nz oa bk">Convert this into an integer in base 10.</li><li id="ee05" class="nc nd fq ne b go ob ng nh gr oc nj nk nl od nn no np oe nr ns nt of nv nw nx px nz oa bk">Extract the last two digits. You can extract more if you have more fine grained requirements.</li><li id="6fa6" class="nc nd fq ne b go ob ng nh gr oc nj nk nl od nn no np oe nr ns nt of nv nw nx px nz oa bk">Use these digits to assign the ID to one of a set of pre-defined experimental buckets.</li></ul><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk ml"><img src="../Images/fb459aab4c75749b21394c14a2ecbd26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YDR_lAG-1AqnuBxsGuX0aA.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">An overview of mapping a customer to a bucket</figcaption></figure><p id="fc39" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Thanks for following along and hope you’ve found this useful. All images in the article are mine. Feel free to use them!</p><p id="c982" class="pw-post-body-paragraph nc nd fq ne b go nf ng nh gr ni nj nk nl nm nn no np nq nr ns nt nu nv nw nx fj bk">Massive thanks to <em class="og">Deniss Zenkovs </em>for introducing me to the idea and suggesting interesting extensions.</p></div></div></div></div>    
</body>
</html>