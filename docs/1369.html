<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Terraforming Dataform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Terraforming Dataform</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/terraforming-dataform-fa7a80990596?source=collection_archive---------7-----------------------#2024-05-31">https://towardsdatascience.com/terraforming-dataform-fa7a80990596?source=collection_archive---------7-----------------------#2024-05-31</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><h2 id="5299" class="fo fp fq bf b dy fr fs ft fu fv fw dx fx" aria-label="kicker paragraph">MLOps: Datapipeline Orchestration</h2><div/><div><h2 id="d7a2" class="pw-subtitle-paragraph gs fz fq bf b gt gu gv gw gx gy gz ha hb hc hd he hf hg hh cq dx">Dataform 101, Part 2: Provisioning with Least Privilege Access Control</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hi hj hk hl hm ab"><div><div class="ab hn"><div><div class="bm" aria-hidden="false"><a href="https://koakande.medium.com/?source=post_page---byline--fa7a80990596--------------------------------" rel="noopener follow"><div class="l ho hp by hq hr"><div class="l ed"><img alt="Kabeer Akande" class="l ep by dd de cx" src="../Images/5e1f083e75741690ae27b00d1e5f1dd3.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/1*VASNsgoTLvkV3t2UBDA02Q.png"/><div class="hs by l dd de em n ht eo"/></div></div></a></div></div><div class="hu ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--fa7a80990596--------------------------------" rel="noopener follow"><div class="l hv hw by hq hx"><div class="l ed"><img alt="Towards Data Science" class="l ep by br hy cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hs by l br hy em n ht eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hz ab q"><div class="ab q ia"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b ib ic bk"><a class="af ag ah ai aj ak al am an ao ap aq ar id" data-testid="authorName" href="https://koakande.medium.com/?source=post_page---byline--fa7a80990596--------------------------------" rel="noopener follow">Kabeer Akande</a></p></div></div></div><span class="ie if" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b ib ic dx"><button class="ig ih ah ai aj ak al am an ao ap aq ar ii ij ik" disabled="">Follow</button></p></div></div></span></div></div><div class="l il"><span class="bf b bg z dx"><div class="ab cn im in io"><div class="ip iq ab"><div class="bf b bg z dx ab ir"><span class="is l il">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar id ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--fa7a80990596--------------------------------" rel="noopener follow"><p class="bf b bg z it iu iv iw ix iy iz ja bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="ie if" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">7 min read</span><div class="jb jc l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">May 31, 2024</span></div></span></div></span></div></div></div><div class="ab cp jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js"><div class="h k w ea eb q"><div class="ki l"><div class="ab q kj kk"><div class="pw-multi-vote-icon ed is kl km kn"><div class=""><div class="ko kp kq kr ks kt ku am kv kw kx kn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l ky kz la lb lc ld le"><p class="bf b dy z dx"><span class="kp">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao ko lf lg ab q ee lh li" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="lj"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg></button></div></div></div><div class="ab q jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh"><div class="lk k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al ll an ao ap ii lm ln lo" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep lp cn"><div class="l ae"><div class="ab cb"><div class="lq lr ls lt lu lv ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al ll an ao ap ii lw lx li ly lz ma mb mc s md me mf mg mh mi mj u mk ml mm"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al ll an ao ap ii lw lx li ly lz ma mb mc s md me mf mg mh mi mj u mk ml mm"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al ll an ao ap ii lw lx li ly lz ma mb mc s md me mf mg mh mi mj u mk ml mm"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><figure class="mq mr ms mt mu mv mn mo paragraph-image"><div role="button" tabindex="0" class="mw mx ed my bh mz"><div class="mn mo mp"><img src="../Images/b3afbfd5e7ff061d52a5ae68268fab7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*aDFGRpR36mY-Q96d.png"/></div></div><figcaption class="nb nc nd mn mo ne nf bf b bg z dx">A typical positioning of Dataform in a data pipeline [Image by author]</figcaption></figure><p id="ab13" class="pw-post-body-paragraph ng nh fq ni b gt nj nk nl gw nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">This is the concluding part of Dataform 101 showing the fundamentals of setting up Dataform with a focus on its authentication flow. This second part focussed on terraform implementation of the flow explained in <a class="af oc" href="https://medium.com/towards-data-science/understanding-dataform-terminologies-and-authentication-flow-aa98c2fbcdfb" rel="noopener">part 1</a>.</p><h2 id="28cf" class="od oe fq bf of og oh oi oj ok ol om on np oo op oq nt or os ot nx ou ov ow fw bk">Dataform Provisioning</h2><p id="6cb0" class="pw-post-body-paragraph ng nh fq ni b gt ox nk nl gw oy nn no np oz nr ns nt pa nv nw nx pb nz oa ob fj bk">Dataform can be set up via the GCP console, but Terraform provides an elegant approach to provisioning and managing infrastructure such as Dataform. The use of Terraform offers portability, reusability and infrastructure versioning along with many other benefits. As a result, Terraform knowledge is required to follow along in this section. If you are familiar with Terraform, head over to the <a class="af oc" href="https://github.com/kbakande/dataform-001" rel="noopener ugc nofollow" target="_blank">GitHub repo</a> and download all the code. If not, Google cloud skills boost has good <a class="af oc" href="https://www.cloudskillsboost.google/course_templates/443" rel="noopener ugc nofollow" target="_blank">resources</a> to get started.</p><figure class="mq mr ms mt mu mv mn mo paragraph-image"><div role="button" tabindex="0" class="mw mx ed my bh mz"><div class="mn mo mp"><img src="../Images/a6e0ddfc9883b7c5ae7423967a91a66b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*PFl7uKl5gVuqu9gy.png"/></div></div><figcaption class="nb nc nd mn mo ne nf bf b bg z dx">An architecture flow for a single repo, multi-environment Dataform</figcaption></figure><h2 id="a3cd" class="od oe fq bf of og oh oi oj ok ol om on np oo op oq nt or os ot nx ou ov ow fw bk">Environments setup</h2><p id="4f03" class="pw-post-body-paragraph ng nh fq ni b gt ox nk nl gw oy nn no np oz nr ns nt pa nv nw nx pb nz oa ob fj bk">We start by setting up the two environments, <code class="cx pc pd pe pf b">prod</code> and <code class="cx pc pd pe pf b">staging</code> , as reflected in the architecture flow diagram above. It should be noted that the code development is done on macOS system, and as such, a window system user might need some adjustments to follow along.</p><pre class="mq mr ms mt mu pg pf ph bp pi bb bk"><span id="dc52" class="pj oe fq pf b bg pk pl l pm pn">mkdir prod<br/>mkdir staging</span></pre><h2 id="7243" class="od oe fq bf of og oh oi oj ok ol om on np oo op oq nt or os ot nx ou ov ow fw bk"><strong class="al">Set up staging files</strong></h2><p id="11d0" class="pw-post-body-paragraph ng nh fq ni b gt ox nk nl gw oy nn no np oz nr ns nt pa nv nw nx pb nz oa ob fj bk">All the initial codes are written within the <code class="cx pc pd pe pf b">staging</code> directory. This is because the proposed architecture provisions Dataform within the staging environment and only few resources are provisioned in the production environment.</p><p id="20e5" class="pw-post-body-paragraph ng nh fq ni b gt nj nk nl gw nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">Let’s start by provisioning a remote bucket to store the Terraform state in remote backend. This bit would be done manually and we wouldnt bring the bucket under terraform management. It is a bit of a chicken-and-egg case whether the bucket in which the Terraform state is stored should be managed by the same Terraform. What you call a catch-22. So we manually create a bucket named <em class="po">dataform-staging-terraform-state</em> within the staging environment by adding the following in the <code class="cx pc pd pe pf b">staging</code> directory:</p><pre class="mq mr ms mt mu pg pf ph bp pi bb bk"><span id="bc23" class="pj oe fq pf b bg pk pl l pm pn">#staging/backend.tf<br/>terraform {<br/>  backend "gcs" {<br/>    bucket = "dataform-staging-terraform-state"<br/>    prefix = "terraform/state"<br/>  }</span></pre><p id="da6e" class="pw-post-body-paragraph ng nh fq ni b gt nj nk nl gw nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">Next, add resource providers to the code base.</p><pre class="mq mr ms mt mu pg pf ph bp pi bb bk"><span id="4c1c" class="pj oe fq pf b bg pk pl l pm pn">#staging/providers.tf<br/>terraform {<br/>  required_providers {<br/>    google = {<br/>      source  = "hashicorp/google"<br/>      version = "&gt;=5.14.0"<br/>    }<br/>    google-beta = {<br/>      source  = "hashicorp/google-beta"<br/>      version = "&gt;=5.14.0"<br/>    }<br/>  }<br/><br/>  required_version = "&gt;= 1.7.3"<br/>}<br/><br/>provider "google" {<br/>  project = var.project_id<br/>}</span></pre><p id="cd2e" class="pw-post-body-paragraph ng nh fq ni b gt nj nk nl gw nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">We then create a variable file to define all the variables used for the infrastructure provisioning.</p><pre class="mq mr ms mt mu pg pf ph bp pi bb bk"><span id="13ba" class="pj oe fq pf b bg pk pl l pm pn">#staging/variables.tf<br/>variable "project_id" {<br/>  type        = string<br/>  description = "Name of the GCP Project."<br/>}<br/><br/>variable "region" {<br/>  type        = string<br/>  description = "The google cloud region to use"<br/>  default     = "europe-west2"<br/>}<br/><br/>variable "project_number" {<br/>  type        = string<br/>  description = "Number of the GCP Project."<br/>}<br/><br/>variable "location" {<br/>  type        = string<br/>  description = "The google cloud location in which to create resources"<br/>  default     = "EU"<br/>}<br/><br/>variable "dataform_staging_service_account" {<br/>  type        = string<br/>  description = "Email of the service account Dataform uses to execute queries in staging env"<br/>}<br/><br/>variable "dataform_prod_service_account" {<br/>  type        = string<br/>  description = "Email of the service account Dataform uses to execute queries in production"<br/>}<br/><br/>variable "dataform_github_token" {<br/>  description = "Dataform GitHub Token"<br/>  type        = string<br/>  sensitive   = true<br/>}</span></pre><p id="f3e0" class="pw-post-body-paragraph ng nh fq ni b gt nj nk nl gw nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">The <code class="cx pc pd pe pf b">auto.tfvars</code> file is added to ensure the variables are auto-discoverable. Ensure to substitute appropriately for the variable placeholders in the file.</p><pre class="mq mr ms mt mu pg pf ph bp pi bb bk"><span id="f03e" class="pj oe fq pf b bg pk pl l pm pn">#staging/staging.auto.tfvars<br/>project_id                       = "{staging-project-id}"<br/>region                           = "{staging-project--region}"<br/>project_number                   = "{staging-project-number}"<br/>dataform_staging_service_account = "dataform-staging"<br/>dataform_prod_service_account    = "{dataform-prod-service-account-email}"<br/>dataform_github_token            = "dataform_github_token"</span></pre><p id="2bad" class="pw-post-body-paragraph ng nh fq ni b gt nj nk nl gw nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">This is followed by secret provisioning where the machine user token is stored.</p><pre class="mq mr ms mt mu pg pf ph bp pi bb bk"><span id="b25e" class="pj oe fq pf b bg pk pl l pm pn">#staging/secrets.tf<br/>resource "google_secret_manager_secret" "dataform_github_token" {<br/>  project = var.project_id<br/>  secret_id = var.dataform_github_token<br/>  replication {<br/>    user_managed {<br/>      replicas {<br/>        location = var.region<br/>      }<br/>    }<br/>  }<br/>}</span></pre><p id="2734" class="pw-post-body-paragraph ng nh fq ni b gt nj nk nl gw nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">After provisioning the secret, a <code class="cx pc pd pe pf b">data</code> resource is added to the terraform codebase for dynamically reading the stored secret value so Dataform has access to the machine user GitHub credentials when provisioned. The <code class="cx pc pd pe pf b">data </code>resource is conditioned on the secret resource to ensure that it only runs when the secret has already been provisioned.</p><pre class="mq mr ms mt mu pg pf ph bp pi bb bk"><span id="57ec" class="pj oe fq pf b bg pk pl l pm pn">#staging/data.tf<br/>data "google_secret_manager_secret_version" "dataform_github_token" {<br/>  project = var.project_id<br/>  secret  = var.dataform_github_token<br/><br/>  depends_on = [<br/>    google_secret_manager_secret.dataform_github_token<br/>  ]<br/>}</span></pre><p id="ba10" class="pw-post-body-paragraph ng nh fq ni b gt nj nk nl gw nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">We proceed to provision the required service account for the staging environment along with granting the required permissions for manifesting data to BigQuery.</p><pre class="mq mr ms mt mu pg pf ph bp pi bb bk"><span id="d868" class="pj oe fq pf b bg pk pl l pm pn">#staging/service_accounts.tf<br/>resource "google_service_account" "dataform_staging" {<br/>  account_id   = var.dataform_staging_service_account<br/>  display_name = "Dataform Service Account"<br/>  project      = var.project_id<br/>}</span></pre><p id="8535" class="pw-post-body-paragraph ng nh fq ni b gt nj nk nl gw nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">And the BQ permissions</p><pre class="mq mr ms mt mu pg pf ph bp pi bb bk"><span id="4c5c" class="pj oe fq pf b bg pk pl l pm pn">#staging/iam.tf<br/>resource "google_project_iam_member" "dataform_staging_roles" {<br/>  for_each = toset([<br/>    "roles/bigquery.dataEditor",<br/>    "roles/bigquery.dataViewer",<br/>    "roles/bigquery.user",<br/>    "roles/bigquery.dataOwner",<br/>  ])<br/><br/>  project = var.project_id<br/>  role    = each.value<br/>  member  = "serviceAccount:${google_service_account.dataform_staging.email}"<br/><br/>  depends_on = [<br/>    google_service_account.dataform_staging<br/>  ]<br/>}</span></pre><p id="f8e5" class="pw-post-body-paragraph ng nh fq ni b gt nj nk nl gw nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">It is crunch time, as we have all the required infrastructure to provision Dataform in the staging environment.</p><pre class="mq mr ms mt mu pg pf ph bp pi bb bk"><span id="f36b" class="pj oe fq pf b bg pk pl l pm pn">#staging/dataform.tf<br/>resource "google_dataform_repository" "dataform_demo" {<br/>  provider        = google-beta<br/>  name            = "dataform_demo"<br/>  project         = var.project_id<br/>  region          = var.region<br/>  service_account = "${var.dataform_staging_service_account}@${var.project_id}.iam.gserviceaccount.com"<br/><br/>  git_remote_settings {<br/>    url                                 = "https://github.com/kbakande/terraforming-dataform"<br/>    default_branch                      = "main"<br/>    authentication_token_secret_version = data.google_secret_manager_secret_version.dataform_github_token.id<br/>  }<br/><br/>  workspace_compilation_overrides {<br/>    default_database = var.project_id<br/>  }<br/><br/>}<br/><br/>resource "google_dataform_repository_release_config" "prod_release" {<br/>  provider   = google-beta<br/>  project    = var.project_id<br/>  region     = var.region<br/>  repository = google_dataform_repository.dataform_demo.name<br/><br/>  name          = "prod"<br/>  git_commitish = "main"<br/>  cron_schedule = "30 6 * * *"<br/><br/>  code_compilation_config {<br/>    default_database = var.project_id<br/>    default_location = var.location<br/>    default_schema   = "dataform"<br/>    assertion_schema = "dataform_assertions"<br/>  }<br/><br/>  depends_on = [<br/>    google_dataform_repository.dataform_demo<br/>  ]<br/>}<br/><br/>resource "google_dataform_repository_workflow_config" "prod_schedule" {<br/>  provider = google-beta<br/>  project  = var.project_id<br/>  region   = var.region<br/><br/>  name           = "prod_daily_schedule"<br/>  repository     = google_dataform_repository.dataform_demo.name<br/>  release_config = google_dataform_repository_release_config.prod_release.id<br/>  cron_schedule  = "45 6 * * *"<br/><br/>  invocation_config {<br/>    included_tags                            = []<br/>    transitive_dependencies_included         = false<br/>    transitive_dependents_included           = false<br/>    fully_refresh_incremental_tables_enabled = false<br/><br/>    service_account = var.dataform_prod_service_account<br/>  }<br/><br/>  depends_on = [<br/>    google_dataform_repository.dataform_demo<br/>  ]<br/>}</span></pre><p id="e090" class="pw-post-body-paragraph ng nh fq ni b gt nj nk nl gw nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">The <em class="po">google_dataform_repository</em> resource provisions a dataform repository where the target remote repo is specified along with the token to access the repo. Then we provision the release configuration stating which remote repo branch to generate the compilation from and configuring the time with cron schedule.</p><p id="4562" class="pw-post-body-paragraph ng nh fq ni b gt nj nk nl gw nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">Finally, workflow configuration is provisioned with a schedule slightly staggered ahead of the release configuration to ensure that the latest compilation is available when workflow configuration runs.</p><p id="5788" class="pw-post-body-paragraph ng nh fq ni b gt nj nk nl gw nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">Once the Dataform is provisioned, a default service account is created along with it in the format<em class="po"> service-{project_number}@gcp-sa-dataform.iam.gserviceaccount.com</em>. This default service account would need to impersonate both the staging and prod service accounts to materialise data in those environments.</p><p id="9ff3" class="pw-post-body-paragraph ng nh fq ni b gt nj nk nl gw nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">We modify the <code class="cx pc pd pe pf b">iam.tf</code> file in the staging environment to grant the required roles for Dataform default service account to impersonate the service account in the staging environment and access the provisioned secret.</p><pre class="mq mr ms mt mu pg pf ph bp pi bb bk"><span id="6a1e" class="pj oe fq pf b bg pk pl l pm pn">#staging/iam.tf<br/>resource "google_project_iam_member" "dataform_staging_roles" {<br/>  for_each = toset([<br/>    "roles/bigquery.dataEditor",<br/>    "roles/bigquery.dataViewer",<br/>    "roles/bigquery.user",<br/>    "roles/bigquery.dataOwner",<br/>  ])<br/><br/>  project = var.project_id<br/>  role    = each.value<br/>  member  = "serviceAccount:${google_service_account.dataform_staging.email}"<br/><br/>  depends_on = [<br/>    google_service_account.dataform_staging<br/>  ]<br/>}<br/><br/>resource "google_service_account_iam_binding" "custom_service_account_token_creator" {<br/>  service_account_id = "projects/${var.project_id}/serviceAccounts/${var.dataform_staging_service_account}@${var.project_id}.iam.gserviceaccount.com"<br/><br/>  role = "roles/iam.serviceAccountTokenCreator"<br/><br/>  members = [<br/>    "serviceAccount:@gcp-sa-dataform.iam.gserviceaccount.com"&gt;service-${var.project_number}@gcp-sa-dataform.iam.gserviceaccount.com"<br/>  ]<br/>  depends_on = [<br/>    module.service-accounts<br/>  ]<br/>}<br/><br/>resource "google_secret_manager_secret_iam_binding" "github_secret_accessor" {<br/>  secret_id = google_secret_manager_secret.dataform_github_token.secret_id<br/><br/>  role = "roles/secretmanager.secretAccessor"<br/><br/>  members = [<br/>    "serviceAccount:@gcp-sa-dataform.iam.gserviceaccount.com"&gt;service-${var.project_number}@gcp-sa-dataform.iam.gserviceaccount.com"<br/>  ]<br/><br/>  depends_on = [<br/>    google_secret_manager_secret.dataform_github_token,<br/>    module.service-accounts,<br/>  ]<br/>}</span></pre><p id="91b9" class="pw-post-body-paragraph ng nh fq ni b gt nj nk nl gw nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">Based on the principle of <strong class="ni ga">least privilege access control</strong>, the IAM binding for targeted resource is used to grant fine-grained access to the default service account.</p><p id="7fb0" class="pw-post-body-paragraph ng nh fq ni b gt nj nk nl gw nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">In order not to prolong this post more than necessary, the terraform code for provisioning resources in prod environment is available in <a class="af oc" href="https://github.com/kbakande/dataform-001" rel="noopener ugc nofollow" target="_blank">GitHub repo</a>. We only need to provision remote backend bucket and the service account (along with fine grained permissions for default service account) in production environment. If the provisioning is successful, the dataform status in the staging environment should look similar to the image below.</p><figure class="mq mr ms mt mu mv mn mo paragraph-image"><div role="button" tabindex="0" class="mw mx ed my bh mz"><div class="mn mo pp"><img src="../Images/4ee94aeb09f5d4904218684464d849ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WfTxk1YP2npsFSq1H3OSGg.png"/></div></div><figcaption class="nb nc nd mn mo ne nf bf b bg z dx">Dataform status after successful provisioning in GCP</figcaption></figure><p id="7758" class="pw-post-body-paragraph ng nh fq ni b gt nj nk nl gw nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">Some pros and cons of the proposed architecture are highlighted as follows:</p><h2 id="24fe" class="od oe fq bf of og oh oi oj ok ol om on np oo op oq nt or os ot nx ou ov ow fw bk">Pros</h2><ul class=""><li id="a606" class="ng nh fq ni b gt ox nk nl gw oy nn no np oz nr ns nt pa nv nw nx pb nz oa ob pq pr ps bk">Follows the principle of version control. The proposed architecture has only one version but the code can be materialised in multiple environments.</li><li id="3326" class="ng nh fq ni b gt pt nk nl gw pu nn no np pv nr ns nt pw nv nw nx px nz oa ob pq pr ps bk">Experimentation is confined within the staging environment which mitigate the chance of an unintended modification of production data.</li></ul><h2 id="3d5a" class="od oe fq bf of og oh oi oj ok ol om on np oo op oq nt or os ot nx ou ov ow fw bk">Cons</h2><ul class=""><li id="27ab" class="ng nh fq ni b gt ox nk nl gw oy nn no np oz nr ns nt pa nv nw nx pb nz oa ob pq pr ps bk">Concern that default service account might make unintended change in the production environment but this is mitigated with the least privilege access control.</li><li id="65a3" class="ng nh fq ni b gt pt nk nl gw pu nn no np pv nr ns nt pw nv nw nx px nz oa ob pq pr ps bk">Multiple developers working concurrently within the staging environment might override data. Though not shown in this post, the scenario can be mitigated with <a class="af oc" href="https://cloud.google.com/dataform/docs/workspace-compilation-overrides" rel="noopener ugc nofollow" target="_blank">workspace compilation override</a> and <a class="af oc" href="https://cloud.google.com/dataform/docs/workspace-compilation-overrides#:~:text=When%20you%20set%20%24%7BworkspaceName%7D%20as%20the%20schema%20suffix%2C%20Dataform,workspace%20in%20the%20dedicated%20schema." rel="noopener ugc nofollow" target="_blank">schema suffix features</a> of Dataform.</li></ul><p id="e5ed" class="pw-post-body-paragraph ng nh fq ni b gt nj nk nl gw nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">As with any architecture, there are pros and cons. The ultimate decision should be based on circumstances within the organisation. Hopefully, this post contributes towards making that decision.</p><h1 id="c312" class="py oe fq bf of pz qa gv oj qb qc gy on qd qe qf qg qh qi qj qk ql qm qn qo qp bk">Summary</h1><p id="1c91" class="pw-post-body-paragraph ng nh fq ni b gt ox nk nl gw oy nn no np oz nr ns nt pa nv nw nx pb nz oa ob fj bk">In <a class="af oc" href="https://medium.com/towards-data-science/understanding-dataform-terminologies-and-authentication-flow-aa98c2fbcdfb" rel="noopener">part 1</a>, We have gone over some terminologies used within GCP Dataform and a walkthrough of the authentication flow for a single repo, multi environment Dataform set up. Terraform code is then provided in this part 2 along with the approach to implement least privilege access control for the service accounts.</p><p id="f6a2" class="pw-post-body-paragraph ng nh fq ni b gt nj nk nl gw nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk">I hope you find the post helpful in your understanding of Dataform. Lets connect on <a class="af oc" href="https://www.linkedin.com/in/koakande/" rel="noopener ugc nofollow" target="_blank">Linkedln</a></p><p id="95cc" class="pw-post-body-paragraph ng nh fq ni b gt nj nk nl gw nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk"><em class="po">Image credit</em>: All images in this post have been created by the Author</p><p id="e8d9" class="pw-post-body-paragraph ng nh fq ni b gt nj nk nl gw nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob fj bk"><strong class="ni ga">References</strong></p><ol class=""><li id="6fd9" class="ng nh fq ni b gt nj nk nl gw nm nn no np nq nr ns nt nu nv nw nx ny nz oa ob qq pr ps bk"><a class="af oc" href="https://medium.com/towards-data-science/understanding-dataform-terminologies-and-authentication-flow-aa98c2fbcdfb" rel="noopener">https://medium.com/towards-data-science/understanding-dataform-terminologies-and-authentication-flow-aa98c2fbcdfb</a></li><li id="30b3" class="ng nh fq ni b gt pt nk nl gw pu nn no np pv nr ns nt pw nv nw nx px nz oa ob qq pr ps bk"><a class="af oc" href="https://github.com/kbakande/terraforming-dataform" rel="noopener ugc nofollow" target="_blank">https://github.com/kbakande/terraforming-dataform</a></li><li id="2c8a" class="ng nh fq ni b gt pt nk nl gw pu nn no np pv nr ns nt pw nv nw nx px nz oa ob qq pr ps bk"><a class="af oc" href="https://www.cloudskillsboost.google/course_templates/443" rel="noopener ugc nofollow" target="_blank">https://www.cloudskillsboost.google/course_templates/443</a></li><li id="6f0c" class="ng nh fq ni b gt pt nk nl gw pu nn no np pv nr ns nt pw nv nw nx px nz oa ob qq pr ps bk"><a class="af oc" href="https://cloud.google.com/dataform/docs/workspace-compilation-overrides" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/dataform/docs/workspace-compilation-overrides</a></li></ol></div></div></div></div>    
</body>
</html>