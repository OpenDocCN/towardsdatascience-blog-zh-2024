# å¦‚ä½•ä½¿ç”¨ DuckDB è¯»å– OSM æ•°æ®

> åŸæ–‡ï¼š[https://towardsdatascience.com/how-to-read-osm-data-with-duckdb-ffeb15197390?source=collection_archive---------0-----------------------#2024-03-02](https://towardsdatascience.com/how-to-read-osm-data-with-duckdb-ffeb15197390?source=collection_archive---------0-----------------------#2024-03-02)

## æ·±å…¥æ¢ç´¢ OpenStreetMap æ•°æ®ç»“æ„åŠå…¶å¦‚ä½•ä»¥å¯æ‰©å±•çš„æ–¹å¼ä½¿ç”¨

[](https://raczeq.medium.com/?source=post_page---byline--ffeb15197390--------------------------------)[![Kamil Raczycki](../Images/2c45075e217e60660ad3b4475530333d.png)](https://raczeq.medium.com/?source=post_page---byline--ffeb15197390--------------------------------)[](https://towardsdatascience.com/?source=post_page---byline--ffeb15197390--------------------------------)[![Towards Data Science](../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png)](https://towardsdatascience.com/?source=post_page---byline--ffeb15197390--------------------------------) [Kamil Raczycki](https://raczeq.medium.com/?source=post_page---byline--ffeb15197390--------------------------------)

Â·å‘è¡¨äº [Towards Data Science](https://towardsdatascience.com/?source=post_page---byline--ffeb15197390--------------------------------) Â·29 åˆ†é’Ÿé˜…è¯»Â·2024å¹´3æœˆ2æ—¥

--

![](../Images/1b9c4439391aa4851cbe3131de09a318.png)

Dall-E 3 å›¾åƒï¼šä¸€åªå¯çˆ±ä¸”è¿·äººçš„ 3D æ¸²æŸ“é¸­å­æ­£åœ¨ç ”ç©¶çº¸è´¨åœ°å›¾ï¼Œæ˜äº®çš„å¤©ç©ºï¼Œæ¨¡ç³Šçš„èƒŒæ™¯ï¼Œé«˜è´¨é‡ï¼Œ8k

æœ¬æ–‡å°†æ·±å…¥æ¢è®¨å¦‚ä½•ä½¿ç”¨ DuckDB æ•°æ®åº“è¯»å– OpenStreetMap æ•°æ®ã€‚

æœ¬æŒ‡å—ä¸­æè¿°çš„æ­¥éª¤å°†å…è®¸è¯»è€…ä½¿ç”¨ Monaco ç¤ºä¾‹åŠ è½½ OSM æ•°æ®ï¼Œå¹¶å°†æ•°æ®åˆ†ä¸ºèŠ‚ç‚¹ã€è·¯å¾„å’Œå…³ç³»ã€‚

![](../Images/d0ebfd971420ab909f885f939cc1ca64.png)![](../Images/0ff4cf3693bfcbf785e16967120a527e.png)![](../Images/05b73197def9157df492056b089d8d72.png)

ä½¿ç”¨ DuckDB å¼•æ“è¯»å– OSM å…ƒç´ çš„æœ€ç»ˆç»“æœã€‚ä»å·¦è‡³å³ï¼šèŠ‚ç‚¹ã€è·¯å¾„å’Œå…³ç³»ã€‚ç”±ä½œè€…ä½¿ç”¨ GeoPandas åº“ç”Ÿæˆã€‚

ä¸ºäº†å®Œå…¨ç†è§£æœ¬æ•™ç¨‹ä¸­æè¿°çš„æ­¥éª¤ï¼Œé¢„æœŸå…·å¤‡ SQL è¯­è¨€çš„åŸºæœ¬çŸ¥è¯†ã€‚å¤§å¤šæ•°ä¸ GIS ç›¸å…³çš„æ“ä½œå’Œç‰¹æ®Šè¿æ¥å°†åœ¨æ–‡ç« ä¸­è¿›ä¸€æ­¥æè¿°ã€‚

## æ–‡ç« å¤§çº²

+   ä»€ä¹ˆæ˜¯ OSMï¼Ÿâ€”â€”OpenStreetMap æœåŠ¡ç®€ä»‹ã€‚

+   OpenStreetMap æ•°æ®æ¨¡å‹â€”â€”å®šä¹‰äº†åœ¨ OSM ä¸­ä½¿ç”¨çš„å¯¹è±¡ã€‚

+   è¯»å– OSM æ•°æ®â€”â€”ä½¿ç”¨ DuckDB å¯¹æ•°æ®è¿›è¡ŒåŸºæœ¬æ“ä½œã€‚

+   ä»**èŠ‚ç‚¹**ä¸­æ„å»ºç‚¹å‡ ä½•ä½“

+   ä»**è·¯å¾„**ä¸­æ„å»ºçº¿æ®µå’Œå¤šè¾¹å½¢å‡ ä½•ä½“

+   ä»**å…³ç³»**ä¸­æ„å»ºå¤šè¾¹å½¢å’Œå¤šé‡å¤šè¾¹å½¢å‡ ä½•ä½“

+   å®šä¹‰ä¸è§„èŒƒçš„å…³ç³»å¯¹è±¡ç¤ºä¾‹

+   QuackOSM â€”â€” ä¸€æ¬¾è½»æ¾è¯»å– OSM æ•°æ®çš„å·¥å…·

# ä»€ä¹ˆæ˜¯ OSMï¼Ÿ

OpenStreetMapï¼ˆ[OSM](https://openstreetmap.org/)ï¼‰æ˜¯å…¨çƒæœ€å—æ¬¢è¿çš„å…è´¹åœ°å›¾ï¼Œå¹¶ç”±æ—¥ç›Šå¢é•¿çš„å¿—æ„¿è€…å’Œè´¡çŒ®è€…ç¾¤ä½“æŒç»­ç»´æŠ¤ã€‚

ç¤¾åŒºæ”¶é›†å¹¶æ„å»ºçš„æ•°æ®å¯ä»¥å…¬å¼€å…è´¹ç”¨äºå•†ä¸šç›®çš„ï¼Œå› æ­¤è®¸å¤šå…¬å¸ã€å­¦æœ¯ç ”ç©¶äººå‘˜å’Œä¸ªäººå¼€å‘è€…éƒ½åœ¨ä»–ä»¬çš„é¡¹ç›®ä¸­ä½¿ç”¨è¿™äº›èµ„æºã€‚æ‰€æœ‰æ•°æ®éƒ½éµå¾ª[å¼€æ”¾æ•°æ®å…¬å…±å¼€æºæ•°æ®åº“è®¸å¯è¯](https://opendatacommons.org/licenses/odbl/1.0/)ï¼ˆODbLï¼‰ã€‚

æ•°æ®å¯ä»¥é€šè¿‡å¤šç§æ–¹å¼è®¿é—®ï¼š

+   ä½¿ç”¨Overpass APIï¼ˆé€šè¿‡[Overpass Turbo](https://overpass-turbo.eu/)çš„Web GUIï¼‰

+   ä¸‹è½½å®Œæ•´æ•°æ®ä½œä¸º[Planet OSM](https://planet.openstreetmap.org/)ï¼ˆ2024å¹´å½“å‰è¶…è¿‡70GBï¼‰

+   è¾ƒå°çš„ä¸‹è½½æå–ï¼š [Geofabrik](https://download.geofabrik.de/), [BBBike](https://extract.bbbike.org/), [OpenStreetMap.fr](https://download.openstreetmap.fr/), [Protomaps](https://app.protomaps.com/)

æ•°æ®å­˜å‚¨çš„æœ€èŠ‚çœç©ºé—´çš„æ–‡ä»¶ç±»å‹æ˜¯ProtocolbufferäºŒè¿›åˆ¶æ ¼å¼ï¼Œæ‰©å±•åä¸º`*.osm.pbf`ã€‚ä½ å¯ä»¥[åœ¨è¿™é‡Œ](https://wiki.openstreetmap.org/wiki/PBF_Format)äº†è§£æ›´å¤šä¿¡æ¯ã€‚

ä½ è¿˜å¯ä»¥é˜…è¯»[Eugenia Anello](https://medium.com/u/86fdc517c278?source=post_page---user_mention--ffeb15197390--------------------------------)å…³äºOpenStreetMapçš„ç®€çŸ­æ–‡ç« ï¼š

[](/a-comprehensive-guide-for-getting-started-with-openstreetmap-e92dff95fc80?source=post_page-----ffeb15197390--------------------------------) [## OpenStreetMapå…¥é—¨æŒ‡å—

### åœ¨ä½¿ç”¨ç½‘ç«™æ—¶å­¦ä¹ OpenStreetMapçš„åŸºæœ¬æ¦‚å¿µ

towardsdatascience.com](/a-comprehensive-guide-for-getting-started-with-openstreetmap-e92dff95fc80?source=post_page-----ffeb15197390--------------------------------)

# OpenStreetMapæ•°æ®æ¨¡å‹

> æœ¬èŠ‚å†…å®¹åŸºäºå…³äºå…ƒç´ çš„[OSM Wikié¡µé¢](https://wiki.openstreetmap.org/wiki/Elements)

ä»æ¦‚å¿µä¸Šè®²ï¼ŒOpenStreetMapä¸­çš„æ•°æ®åˆ†ä¸º3ä¸ªç»„ä»¶ï¼š

èŠ‚ç‚¹è¡¨ç¤ºç©ºé—´ä¸­çš„ç‚¹ã€‚å®ƒä»¬é€šè¿‡WGS84åæ ‡å‚è€ƒç³»ç»Ÿä¸­çš„ä¸€å¯¹åæ ‡è¡¨ç¤ºâ€”â€”ç»åº¦å’Œçº¬åº¦ã€‚èŠ‚ç‚¹å¯ä»¥ç”¨æ¥å®šä¹‰åœ°å›¾ä¸Šçš„å•ä¸€ç‰¹å¾ï¼ˆä¾‹å¦‚ï¼šé•¿æ¤…ã€è·¯ç¯ã€æ ‘æœ¨ï¼‰ï¼Œæˆ–è€…ä¸å…¶ä»–èŠ‚ç‚¹ä¸€èµ·ç”¨æ¥è¡¨ç¤ºè·¯å¾„çš„å½¢çŠ¶ã€‚

![](../Images/d1b8a31585dcda83fce64f09a495b165.png)

ä¸€ä¸ªèŠ‚ç‚¹çš„ç¤ºä¾‹â€”â€”å…¬å›­é‡Œçš„æ ‘ã€‚æ¥è‡ªOpenStreetMapçš„æˆªå›¾ï¼Œä½œè€…æä¾›ã€‚

è·¯å¾„æ˜¯é€šè¿‡ä½¿ç”¨**æœ‰åº**èŠ‚ç‚¹åˆ—è¡¨è¡¨ç¤ºçš„æŠ˜çº¿å½¢çŠ¶ã€‚è¿™äº›æŠ˜çº¿å¯ä»¥æ˜¯å¼€æ”¾çš„ï¼Œè¡¨ç¤ºé“è·¯ã€è¿æ²³å’Œå¢™å£ï¼Œæˆ–è€…å®ƒä»¬å¯ä»¥é—­åˆå½¢æˆå¤šè¾¹å½¢ï¼Œè¡¨ç¤ºå»ºç­‘ç‰©ã€æ£®æ—ã€æ¹–æ³Šæˆ–å…¶ä»–ç®€å•å½¢çŠ¶ã€‚

![](../Images/66e199dab95b9bcb14552b0375443a37.png)

ä¸€ä¸ªè·¯å¾„çš„ç¤ºä¾‹â€”â€”ä¸€éƒ¨åˆ†é«˜é€Ÿå…¬è·¯ã€‚æ¥è‡ªOpenStreetMapçš„æˆªå›¾ï¼Œä½œè€…æä¾›ã€‚

å…³ç³»è¡¨ç¤ºOSMä¸­å¤šä¸ªå¯¹è±¡å’Œæ•°æ®å…ƒç´ ä¹‹é—´çš„å…³ç³»ã€‚ä¾‹å¦‚ï¼Œè¿™å¯ä»¥æ˜¯ä¸€ä¸ªå…¬äº¤è·¯çº¿ï¼Œå…¶ä¸­è·¯çº¿è¡¨ç¤ºå…¬äº¤è¡Œé©¶çš„é“è·¯ï¼ŒèŠ‚ç‚¹è¡¨ç¤ºè·¯çº¿çš„ç«™ç‚¹ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªç”±è‡³å°‘2ä¸ªè·¯å¾„è¡¨ç¤ºçš„å¸¦å­”çš„å¤šè¾¹å½¢ï¼šè¿™äº›å¯ä»¥æ˜¯*å¤–éƒ¨*å¤šè¾¹å½¢å’Œ*å†…éƒ¨*å¤šè¾¹å½¢ã€‚

![](../Images/638f80e316ca63427f0d70bd3f89cf98.png)

ä¸€ä¸ªå…³ç³»çš„ç¤ºä¾‹â€”â€”ä¸€ä¸ªå¸¦æœ‰å­”æ´çš„é…’åº—å»ºç­‘è½®å»“ã€‚æˆªå›¾æ¥è‡ªä½œè€…çš„OpenStreetMapã€‚

æ¯ä¸ªå…ƒç´ å¯ä»¥ï¼Œä¹Ÿä¸ä¸€å®šï¼Œé™„å¸¦**æ ‡ç­¾**ã€‚æ ‡ç­¾æè¿°å…ƒç´ çš„å«ä¹‰ã€‚æ ‡ç­¾ç”±é”®å’Œå€¼ç»„æˆã€‚æ²¡æœ‰å›ºå®šçš„å€¼å­—å…¸ï¼Œä½†ç”¨æˆ·åº”éµå¾ªOSM Wikiä¸­è®°å½•çš„çº¦å®šã€‚

æ­¤å¤–ï¼Œæ¯ä¸ªå…ƒç´ éƒ½æœ‰ä¸€ä¸ªåœ¨ç‰¹å®šå…ƒç´ ç±»å‹ç©ºé—´ä¸­å”¯ä¸€çš„IDï¼ˆå› æ­¤å¯èƒ½å­˜åœ¨ä¸€ä¸ªIDä¸º100çš„èŠ‚ç‚¹ã€IDä¸º100çš„è·¯å¾„å’ŒIDä¸º100çš„å…³ç³»ï¼‰ã€‚

# è¯»å–OSMæ•°æ®

è®¸å¤šå·¥å…·å…è®¸ç”¨æˆ·å°†OSMæ•°æ®æ¨¡å‹è½¬æ¢ä¸ºåœ¨GISé¢†åŸŸå¸¸ç”¨çš„æ–‡ä»¶æ ¼å¼ï¼Œä¾‹å¦‚[GDAL](https://gdal.org/drivers/vector/osm.html)ã€‚è¿™äº›å·¥å…·ä¼šè‡ªåŠ¨ä»åŸå§‹æ•°æ®ä¸­é‡å»ºå‡ ä½•å½¢çŠ¶ã€‚æˆ‘ä»¬å°†å°è¯•æ‰‹åŠ¨è¯»å–å¹¶é‡å»ºå‡ ä½•å½¢çŠ¶ã€‚

> ä»¥ä¸‹ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•è®¿é—®åŸå§‹æ•°æ®ï¼Œå¹¶ä½¿ç”¨[DuckDB](https://duckdb.org/)å¼•æ“å’Œ[Spatial](https://duckdb.org/docs/extensions/spatial.html)æ‰©å±•ä»¥SQLç¼–å†™ã€‚å¸¦æœ‰å®Œæ•´Jupyterç¬”è®°æœ¬çš„æ‰€æœ‰æŸ¥è¯¢å¯ä»¥åœ¨GitHubä»£ç åº“ä¸­è®¿é—®ã€‚
> 
> ä½ å¯ä»¥åœ¨å¹¶è¡Œç¯å¢ƒä¸­è¿è¡Œæ­¤ç¬”è®°æœ¬ï¼Œæˆ–è€…ä½ å¯ä»¥[å®‰è£…DuckDBå¼•æ“](https://duckdb.org/#quickinstall)ï¼Œå¹¶æ‰“å¼€CLIåœ¨å…¶ä¸­æ‰§è¡ŒæŸ¥è¯¢ã€‚

[](https://github.com/RaczeQ/medium-articles/blob/main/articles/osm-duckdb/code.ipynb?source=post_page-----ffeb15197390--------------------------------) [## medium-articles/articles/osm-duckdb/code.ipynb at main Â· RaczeQ/medium-articles

### ç”¨äºMediumæ–‡ç« ä¸­ä»£ç å’Œæ•°æ®çš„ä»£ç åº“ - medium-articles/articles/osm-duckdb/code.ipynb at main Â·â€¦

github.com](https://github.com/RaczeQ/medium-articles/blob/main/articles/osm-duckdb/code.ipynb?source=post_page-----ffeb15197390--------------------------------)

## è·å–æ•°æ®

ä¸ºäº†ç®€ä¾¿å¹¶ä¾¿äºè®¿é—®ï¼Œç¤ºä¾‹å®Œå…¨èšç„¦äºæ‘©çº³å“¥åœ°åŒºã€‚ä½ å¯ä»¥ä»Geofabrikä¸‹è½½æœåŠ¡å™¨ä¸‹è½½å½“å‰çš„æå–æ•°æ®ï¼š[https://download.geofabrik.de/europe/monaco.html](https://download.geofabrik.de/europe/monaco.html)ï¼ˆç‚¹å‡»`monaco-latest.osm.pbf`ä¸‹è½½é“¾æ¥ï¼‰

## ç†Ÿæ‚‰æ•°æ®ç»“æ„

é¦–å…ˆï¼Œæˆ‘ä»¬å°†ä½¿ç”¨`DESCRIBE`å‡½æ•°è·å–æœ‰å…³åˆ—çš„ä¿¡æ¯ï¼š

```py
DESCRIBE SELECT * FROM ST_READOSM('monaco-latest.osm.pbf');

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ column_name â”‚                 column_type                  â”‚  null   â”‚   key   â”‚ default â”‚  extra  â”‚
â”‚   varchar   â”‚                   varchar                    â”‚ varchar â”‚ varchar â”‚ varchar â”‚ varchar â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ kind        â”‚ ENUM('node', 'way', 'relation', 'changeset') â”‚ YES     â”‚ NULL    â”‚ NULL    â”‚ NULL    â”‚
â”‚ id          â”‚ BIGINT                                       â”‚ YES     â”‚ NULL    â”‚ NULL    â”‚ NULL    â”‚
â”‚ tags        â”‚ MAP(VARCHAR, VARCHAR)                        â”‚ YES     â”‚ NULL    â”‚ NULL    â”‚ NULL    â”‚
â”‚ refs        â”‚ BIGINT[]                                     â”‚ YES     â”‚ NULL    â”‚ NULL    â”‚ NULL    â”‚
â”‚ lat         â”‚ DOUBLE                                       â”‚ YES     â”‚ NULL    â”‚ NULL    â”‚ NULL    â”‚
â”‚ lon         â”‚ DOUBLE                                       â”‚ YES     â”‚ NULL    â”‚ NULL    â”‚ NULL    â”‚
â”‚ ref_roles   â”‚ VARCHAR[]                                    â”‚ YES     â”‚ NULL    â”‚ NULL    â”‚ NULL    â”‚
â”‚ ref_types   â”‚ ENUM('node', 'way', 'relation')[]            â”‚ YES     â”‚ NULL    â”‚ NULL    â”‚ NULL    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

`ST_READOSM`å‡½æ•°è¿”å›8ä¸ªåˆ—ï¼š

+   kind â€”â€” è¿™æ˜¯å…ƒç´ çš„ç±»å‹ã€‚å®ƒä¹Ÿå¯ä»¥å…·æœ‰ `changeset` çš„å€¼ï¼Œè¡¨ç¤ºåœ¨ç¼–è¾‘ç°æœ‰å…ƒç´ åæ‰€åšçš„æ›´æ”¹ã€‚Geofabrikä¸‹è½½æœåŠ¡å™¨çš„æå–æ•°æ®ä¸åŒ…å«changesetï¼Œå› æ­¤æˆ‘ä»¬ä¸éœ€è¦è€ƒè™‘å®ƒä»¬ã€‚

+   id â€”â€” å…ƒç´ çš„æ ‡è¯†ç¬¦ã€‚

+   tags â€”â€” ä¸€ä¸ªç”±ä¸¤ä¸ªå­—ç¬¦ä¸²ç»„æˆçš„æ˜ å°„ï¼ˆæˆ–å­—å…¸ï¼‰ï¼šä¸€ä¸ªæ ‡ç­¾é”®å’Œä¸€ä¸ªæ ‡ç­¾å€¼ã€‚

+   refs â€”â€” ä¸å…ƒç´ ç›¸å…³çš„æˆå‘˜IDåˆ—è¡¨ã€‚èŠ‚ç‚¹åº”å°†æ­¤åˆ—è¡¨ç•™ç©ºï¼Œè·¯å¾„å’Œå…³ç³»ä¸èƒ½ä¸ºç©ºã€‚

+   lat å’Œ lon â€”â€” èŠ‚ç‚¹çš„çº¬åº¦å’Œç»åº¦ã€‚è·¯å¾„å’Œå…³ç³»åº”è¯¥å°†è¿™äº›å­—æ®µç•™ç©ºï¼Œå› ä¸ºåœ¨OSMä¸­åªæœ‰èŠ‚ç‚¹å¯ä»¥æ‹¥æœ‰åæ ‡ã€‚

+   ref_roles å’Œ ref_types â€” å…³äºæˆå‘˜çš„é™„åŠ ä¿¡æ¯åˆ—è¡¨ï¼šæˆå‘˜è¢«åˆ†é…çš„è§’è‰²æ˜¯ä»€ä¹ˆï¼Œå®ƒå±äºä»€ä¹ˆç±»å‹ï¼ˆèŠ‚ç‚¹ã€é“è·¯æˆ–å…³ç³»ï¼‰ã€‚

## è®¡æ•°å…ƒç´ æ•°é‡ã€‚

è®©æˆ‘ä»¬æ¥çœ‹çœ‹æ€»å…±æœ‰å¤šå°‘å…ƒç´ ï¼Œä»¥åŠæ¯ç§å…ƒç´ ç±»å‹çš„æ•°é‡ã€‚

```py
SELECT COUNT(*) as total_elements
FROM ST_READOSM('monaco-latest.osm.pbf');

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ total_elements â”‚
â”‚     int64      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          35782 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

SELECT kind, COUNT(*) as total_elements
FROM ST_READOSM('monaco-latest.osm.pbf')
GROUP BY 1;

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     kind                     â”‚ total_features â”‚
â”‚ enum('node', 'way', 'relation', 'changeset') â”‚     int64      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ node                                         â”‚          30643 â”‚
â”‚ way                                          â”‚           4849 â”‚
â”‚ relation                                     â”‚            290 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æŸ¥çœ‹å…ƒç´ ã€‚

è®©æˆ‘ä»¬æ£€æŸ¥æ¯ç§å…ƒç´ ç±»å‹çš„æ•°æ®ç¤ºä¾‹ã€‚

```py
SELECT *
FROM ST_READOSM('monaco-latest.osm.pbf')
WHERE kind = 'node'
LIMIT 5;

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         kind         â”‚    id    â”‚            tags             â”‚  refs   â”‚        lat         â”‚        lon         â”‚ ref_roles â”‚             ref_types             â”‚
â”‚ enum('node', 'way'â€¦  â”‚  int64   â”‚    map(varchar, varchar)    â”‚ int64[] â”‚       double       â”‚       double       â”‚ varchar[] â”‚ enum('node', 'way', 'relation')[] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ node                 â”‚ 21911883 â”‚                             â”‚         â”‚ 43.737117500000004 â”‚  7.422909300000001 â”‚           â”‚                                   â”‚
â”‚ node                 â”‚ 21911886 â”‚ {crossing=zebra, crossingâ€¦  â”‚         â”‚ 43.737239900000006 â”‚  7.423498500000001 â”‚           â”‚                                   â”‚
â”‚ node                 â”‚ 21911894 â”‚                             â”‚         â”‚ 43.737773100000005 â”‚          7.4259193 â”‚           â”‚                                   â”‚
â”‚ node                 â”‚ 21911901 â”‚                             â”‚         â”‚ 43.737762100000005 â”‚ 7.4267099000000005 â”‚           â”‚                                   â”‚
â”‚ node                 â”‚ 21911908 â”‚                             â”‚         â”‚         43.7381906 â”‚           7.426961 â”‚           â”‚                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

SELECT *
FROM ST_READOSM('monaco-latest.osm.pbf')
WHERE kind = 'way'
LIMIT 5;

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         kind         â”‚   id    â”‚         tags         â”‚                  refs                   â”‚  lat   â”‚  lon   â”‚ ref_roles â”‚             ref_types             â”‚
â”‚ enum('node', 'way'â€¦  â”‚  int64  â”‚ map(varchar, varchâ€¦  â”‚                 int64[]                 â”‚ double â”‚ double â”‚ varchar[] â”‚ enum('node', 'way', 'relation')[] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ way                  â”‚ 4097656 â”‚ {highway=secondaryâ€¦  â”‚ [21912089, 7265761724, 1079750744, 21â€¦  â”‚        â”‚        â”‚           â”‚                                   â”‚
â”‚ way                  â”‚ 4098197 â”‚ {highway=tertiary,â€¦  â”‚ [21918500, 10723812919, 1204288480, 2â€¦  â”‚        â”‚        â”‚           â”‚                                   â”‚
â”‚ way                  â”‚ 4224972 â”‚ {highway=residentiâ€¦  â”‚ [25177418, 4939779378, 4939779381, 49â€¦  â”‚        â”‚        â”‚           â”‚                                   â”‚
â”‚ way                  â”‚ 4224978 â”‚ {access=no, addr:câ€¦  â”‚ [25178088, 25178091, 25178045, 251780â€¦  â”‚        â”‚        â”‚           â”‚                                   â”‚
â”‚ way                  â”‚ 4226740 â”‚ {highway=secondaryâ€¦  â”‚ [25192130, 6444966483, 1737389127, 64â€¦  â”‚        â”‚        â”‚           â”‚                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

SELECT *
FROM ST_READOSM('monaco-latest.osm.pbf')
WHERE kind = 'relation'
LIMIT 5;

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         kind         â”‚  id   â”‚         tags         â”‚         refs         â”‚  lat   â”‚  lon   â”‚      ref_roles       â”‚                  ref_types                  â”‚
â”‚ enum('node', 'way'â€¦  â”‚ int64 â”‚ map(varchar, varchâ€¦  â”‚       int64[]        â”‚ double â”‚ double â”‚      varchar[]       â”‚      enum('node', 'way', 'relation')[]      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ relation             â”‚  7385 â”‚ {ISO3166-2=FR-06, â€¦  â”‚ [1701090139, 32665â€¦  â”‚        â”‚        â”‚ [admin_centre, labâ€¦  â”‚ [node, node, way, way, way, way, way, wayâ€¦  â”‚
â”‚ relation             â”‚  8654 â”‚ {ISO3166-2=FR-PAC,â€¦  â”‚ [26761400, 1251610â€¦  â”‚        â”‚        â”‚ [admin_centre, labâ€¦  â”‚ [node, node, way, way, way, way, way, wayâ€¦  â”‚
â”‚ relation             â”‚ 11980 â”‚ {ISO3166-1=FR, ISOâ€¦  â”‚ [17807753, 1363947â€¦  â”‚        â”‚        â”‚ [admin_centre, labâ€¦  â”‚ [node, node, relation, relation, relationâ€¦  â”‚
â”‚ relation             â”‚ 36990 â”‚ {ISO3166-1=MC, ISOâ€¦  â”‚ [1790048269, 77077â€¦  â”‚        â”‚        â”‚ [admin_centre, outâ€¦  â”‚ [node, way, way, way, way, way, way, way,â€¦  â”‚
â”‚ relation             â”‚ 90352 â”‚ {admin_level=2, boâ€¦  â”‚ [770774507, 377944â€¦  â”‚        â”‚        â”‚ [outer, outer, outâ€¦  â”‚ [way, way, way, way, way, way, way, way, â€¦  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ç°åœ¨æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å…ƒç´ çš„å®šä¹‰ï¼šèŠ‚ç‚¹æœ‰åæ ‡ï¼Œé“è·¯æœ‰å¡«å……äº†èŠ‚ç‚¹IDçš„*refs*åˆ—è¡¨ï¼Œå…³ç³»æœ‰æœ€å¤æ‚çš„ç»“æ„ï¼Œ*refs*åˆ—è¡¨å¡«å……äº†IDï¼Œ*ref_types*åˆ—è¡¨æ˜¾ç¤ºå“ªä¸ªIDå¯¹åº”å“ªä¸ªå…ƒç´ ç±»å‹ã€‚æ­¤å¤–ï¼Œ*ref_roles*åŒ…å«å…³äºæˆå‘˜è§’è‰²çš„ä¿¡æ¯ï¼ˆadmin_centreï¼Œlabelï¼Œinnerï¼Œouterï¼‰ã€‚

# ä»èŠ‚ç‚¹ä¸­æ„å»ºç‚¹å‡ ä½•å½¢çŠ¶ã€‚

ç°åœ¨æˆ‘ä»¬çŸ¥é“ç»“æ„æ˜¯ä»€ä¹ˆæ ·çš„ï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹æ„å»ºä¸€äº›å‡ ä½•å½¢çŠ¶äº†ã€‚ä»èŠ‚ç‚¹å¼€å§‹åº”è¯¥æ˜¯æœ€ç®€å•çš„ï¼Œå› ä¸ºå®ƒä»…ä»…æ˜¯WGS84åæ ‡å‚è€ƒç³»ç»Ÿä¸­çš„ä¸€å¯¹çº¬åº¦å’Œç»åº¦ã€‚

æˆ‘ä»¬åº”è¯¥åªæå–è‡³å°‘é™„å¸¦ä¸€ä¸ªæ ‡ç­¾çš„èŠ‚ç‚¹ï¼Œå› ä¸ºè¿™äº›èŠ‚ç‚¹åœ¨åˆ†æä¸­æœ‰è¯­ä¹‰æ„ä¹‰ã€‚æ²¡æœ‰ä»»ä½•æ ‡ç­¾çš„èŠ‚ç‚¹å¯èƒ½ä¼šåœ¨åç»­é˜¶æ®µç”¨äºæ„å»ºé“è·¯ã€‚

```py
SELECT
    id,
    tags,
    ST_POINT(lon, lat) geometry
FROM ST_READOSM('monaco-latest.osm.pbf')
WHERE kind = 'node'
    AND tags IS NOT NULL
    AND cardinality(tags) > 0;

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     id      â”‚                          tags                           â”‚                   geometry                   â”‚
â”‚    int64    â”‚                  map(varchar, varchar)                  â”‚                   geometry                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    21911886 â”‚ {crossing=zebra, crossing:island=no, crossing_ref=zebâ€¦  â”‚ POINT (7.423498500000001 43.737239900000006) â”‚
â”‚    21912962 â”‚ {crossing=zebra, crossing_ref=zebra, highway=crossing}  â”‚ POINT (7.426912100000001 43.737912800000004) â”‚
â”‚    21914341 â”‚ {crossing=uncontrolled, crossing_ref=zebra, highway=câ€¦  â”‚ POINT (7.4233732 43.737010000000005)         â”‚
â”‚    21915639 â”‚ {highway=traffic_signals}                               â”‚ POINT (7.4256003 43.7404449)                 â”‚
â”‚    21917308 â”‚ {bus=yes, name=Monte-Carlo (Casino), public_transportâ€¦  â”‚ POINT (7.4259854 43.740984700000006)         â”‚
â”‚    21918329 â”‚ {crossing=marked, crossing:markings=yes, highway=crosâ€¦  â”‚ POINT (7.427889100000001 43.7423616)         â”‚
â”‚    21918589 â”‚ {crossing=marked, crossing:island=yes, crossing:markiâ€¦  â”‚ POINT (7.4317478 43.7472774)                 â”‚
â”‚    21918697 â”‚ {crossing=marked, crossing:island=no, crossing:markinâ€¦  â”‚ POINT (7.432645000000001 43.747892900000004) â”‚
â”‚    21918939 â”‚ {bus=yes, name=Portier, public_transport=stop_position} â”‚ POINT (7.430429800000001 43.741472800000004) â”‚
â”‚    21919093 â”‚ {crossing=marked, crossing:markings=yes, crossing_refâ€¦  â”‚ POINT (7.4352171 43.748160000000006)         â”‚
â”‚        Â·    â”‚                   Â·                                     â”‚                  Â·                           â”‚
â”‚        Â·    â”‚                   Â·                                     â”‚                  Â·                           â”‚
â”‚        Â·    â”‚                   Â·                                     â”‚                  Â·                           â”‚
â”‚ 11450012980 â”‚ {direction=forward, highway=give_way}                   â”‚ POINT (7.416853100000001 43.735809700000004) â”‚
â”‚ 11450012981 â”‚ {direction=forward, highway=give_way}                   â”‚ POINT (7.416783000000001 43.735872900000004) â”‚
â”‚ 11450012982 â”‚ {direction=forward, highway=give_way}                   â”‚ POINT (7.416664900000001 43.735887000000005) â”‚
â”‚ 11450012983 â”‚ {direction=forward, highway=give_way}                   â”‚ POINT (7.4166968 43.7356945)                 â”‚
â”‚ 11451922579 â”‚ {bus=yes, highway=bus_stop, name=Larvotto, public_traâ€¦  â”‚ POINT (7.435032400000001 43.7481639)         â”‚
â”‚ 11451922580 â”‚ {bus=yes, highway=bus_stop, name=Grimaldi Forum, publâ€¦  â”‚ POINT (7.4311343 43.7442067)                 â”‚
â”‚ 11451922581 â”‚ {bench=yes, bus=yes, highway=bus_stop, name=Portier, â€¦  â”‚ POINT (7.430357300000001 43.742209100000004) â”‚
â”‚ 11451922582 â”‚ {bench=no, bin=no, bus=yes, highway=bus_stop, lit=yesâ€¦  â”‚ POINT (7.4107674 43.7296193)                 â”‚
â”‚ 11451922600 â”‚ {direction=backward, highway=give_way}                  â”‚ POINT (7.4105622 43.7291648)                 â”‚
â”‚ 11452057060 â”‚ {direction=backward, highway=give_way}                  â”‚ POINT (7.419164 43.737116)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3167 rows (20 shown)                                                                                       3 columns â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

![](../Images/c940d87cb6db1a98fff59db98498049a.png)

èŠ‚ç‚¹åœ¨åœ°å›¾ä¸Šçš„åˆ†å¸ƒã€‚ç”±ä½œè€…ä½¿ç”¨GeoPandasåº“ç”Ÿæˆã€‚

åœ¨æ ¹æ®æ ‡ç­¾è¿‡æ»¤èŠ‚ç‚¹åï¼Œæˆ‘ä»¬å‰©ä¸‹3167ä¸ªç‚¹ã€‚

è¿™å¤§çº¦å æºæ–‡ä»¶ä¸­èŠ‚ç‚¹æ€»æ•°çš„10%ã€‚

# ä»é“è·¯ä¸­æ„å»ºçº¿å­—ç¬¦ä¸²å’Œå¤šè¾¹å½¢å‡ ä½•å½¢çŠ¶ã€‚

è®©èŠ‚ç‚¹â€œå‡ºå±€â€ ğŸ˜‰ï¼Œç°åœ¨æˆ‘ä»¬ä¸“æ³¨äºé“è·¯ã€‚é“è·¯å¯ä»¥æ˜¯çº¿å­—ç¬¦ä¸²æˆ–å¤šè¾¹å½¢ã€‚æˆ‘ä»¬é¦–å…ˆå…³æ³¨çº¿å­—ç¬¦ä¸²ï¼Œç„¶åå†åˆ†é…åˆé€‚çš„å‡ ä½•ç±»å‹ã€‚

ä¸ºäº†æ„å»ºé“è·¯ï¼Œæˆ‘ä»¬éœ€è¦æ‰§è¡Œå¤šä¸ªæ“ä½œï¼š

+   é€‰æ‹©å¸¦æœ‰æ ‡ç­¾çš„åŒ¹é…é“è·¯ã€‚

+   ä¸ºæ¯ä¸ªé“è·¯å…ƒç´ å±•å¼€æ‰€æœ‰èŠ‚ç‚¹å¼•ç”¨ï¼Œå¹¶ä¿æŒå®ƒä»¬çš„æ­£ç¡®é¡ºåºï¼ˆè®°ä½â€”â€”èŠ‚ç‚¹å¼•ç”¨çš„é¡ºåºå¾ˆé‡è¦ï¼ï¼‰ã€‚

+   é€‰æ‹©å¸¦æœ‰å‡ ä½•å½¢çŠ¶çš„æ‰€éœ€èŠ‚ç‚¹ã€‚

+   æŒ‰é“è·¯IDåˆ†ç»„èŠ‚ç‚¹ï¼Œå¹¶ä½¿ç”¨`ST_MakeLine`å‡½æ•°æ„å»ºçº¿å­—ç¬¦ä¸²å‡ ä½•å½¢çŠ¶ã€‚

+   ä½¿ç”¨æ ‡ç­¾æ„å»ºçš„å‡ ä½•å½¢çŠ¶è¿æ¥ã€‚

æˆ‘ä»¬ä»é€‰æ‹©å¸¦æœ‰æ ‡ç­¾çš„é“è·¯å¼€å§‹ã€‚

```py
CREATE TEMP TABLE matching_ways AS 
SELECT id, tags
FROM ST_READOSM('monaco-latest.osm.pbf')
WHERE kind = 'way' AND tags IS NOT NULL AND cardinality(tags) > 0;

SELECT * FROM matching_ways;

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     id     â”‚                              tags                               â”‚
â”‚   int64    â”‚                      map(varchar, varchar)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    4097656 â”‚ {highway=secondary, lanes=2, lit=yes, maxspeed=30, name=Avenuâ€¦  â”‚
â”‚    4098197 â”‚ {highway=tertiary, lanes=2, lit=yes, name=Boulevard d`Italie,â€¦  â”‚
â”‚    4224972 â”‚ {highway=residential, lit=yes, name=Avenue des Papalins, onewâ€¦  â”‚
â”‚    4224978 â”‚ {access=no, addr:country=MC, leisure=pitch, lit=yes, sport=soâ€¦  â”‚
â”‚    4226740 â”‚ {highway=secondary, lanes=2, lit=yes, maxspeed=50, name=Bouleâ€¦  â”‚
â”‚    4227155 â”‚ {area=yes, highway=pedestrian, lit=yes, name=Place du Palais,â€¦  â”‚
â”‚    4227156 â”‚ {access=no, bus=yes, demolished:highway=service, oneway=yes, â€¦  â”‚
â”‚    4227157 â”‚ {highway=residential, name=Rue des Remparts, oneway=yes, surfâ€¦  â”‚
â”‚    4227158 â”‚ {highway=residential, name=Rue Philibert Florence, oneway=yesâ€¦  â”‚
â”‚    4227164 â”‚ {highway=secondary, lanes=2, lit=yes, name=Virage Antony Noguâ€¦  â”‚
â”‚       Â·    â”‚                                Â·                                â”‚
â”‚       Â·    â”‚                                Â·                                â”‚
â”‚       Â·    â”‚                                Â·                                â”‚
â”‚ 1230247124 â”‚ {bench=no, bin=yes, bus=yes, check_date=2023-12-10, covered=yâ€¦  â”‚
â”‚ 1230273018 â”‚ {access=yes, leisure=playground, wheelchair=yes}                â”‚
â”‚ 1230273019 â”‚ {highway=footway, surface=paving_stones}                        â”‚
â”‚ 1230398878 â”‚ {abandoned:railway=rail, highway=primary, lanes=2, lit=yes, mâ€¦  â”‚
â”‚ 1233828725 â”‚ {highway=service, lit=yes, name=Place Moulins, oneway=yes}      â”‚
â”‚ 1233828726 â”‚ {highway=tertiary, junction=roundabout, lanes=2, lit=yes, nonâ€¦  â”‚
â”‚ 1233853668 â”‚ {highway=secondary, lanes=2, lit=yes, maxspeed=50, name=Bouleâ€¦  â”‚
â”‚ 1238339144 â”‚ {cycleway:left=lane, highway=tertiary, lanes=2, lit=yes, maxsâ€¦  â”‚
â”‚ 1238339145 â”‚ {cycleway:left=lane, highway=tertiary, lanes=2, lit=yes, maxsâ€¦  â”‚
â”‚ 1239415633 â”‚ {footway=sidewalk, highway=footway}                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 4786 rows (20 shown)                                               2 columns â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ç°åœ¨æˆ‘ä»¬å°†å±•å¼€å¼•ç”¨åˆ—è¡¨ï¼Œå¹¶å°†å®ƒä»¬æ‹†åˆ†æˆå•ç‹¬çš„è¡Œã€‚æˆ‘ä»¬è¿˜å°†åˆ©ç”¨DuckDBçš„ç´¢å¼•åŠŸèƒ½æ¥è®°ä½åŸå§‹åˆ—è¡¨ä¸­å…ƒç´ çš„é¡ºåºã€‚

```py
CREATE TEMP TABLE matching_ways_with_nodes_refs AS
SELECT id, UNNEST(refs) as ref, UNNEST(range(length(refs))) as ref_idx
FROM ST_READOSM('monaco-latest.osm.pbf')
SEMI JOIN matching_ways USING (id)
WHERE kind = 'way';

SELECT * FROM matching_ways_with_nodes_refs;

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    id     â”‚    ref     â”‚ ref_idx â”‚
â”‚   int64   â”‚   int64    â”‚  int64  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   4097656 â”‚   21912089 â”‚       0 â”‚
â”‚   4097656 â”‚ 7265761724 â”‚       1 â”‚
â”‚   4097656 â”‚ 1079750744 â”‚       2 â”‚
â”‚   4097656 â”‚ 2104793864 â”‚       3 â”‚
â”‚   4097656 â”‚ 6340961560 â”‚       4 â”‚
â”‚   4097656 â”‚ 1110560507 â”‚       5 â”‚
â”‚   4097656 â”‚   21912093 â”‚       6 â”‚
â”‚   4097656 â”‚ 6340961559 â”‚       7 â”‚
â”‚   4097656 â”‚   21912095 â”‚       8 â”‚
â”‚   4097656 â”‚ 7265762803 â”‚       9 â”‚
â”‚      Â·    â”‚      Â·     â”‚       Â· â”‚
â”‚      Â·    â”‚      Â·     â”‚       Â· â”‚
â”‚      Â·    â”‚      Â·     â”‚       Â· â”‚
â”‚ 151154357 â”‚ 7927855820 â”‚       2 â”‚
â”‚ 151154358 â”‚ 1868015912 â”‚       0 â”‚
â”‚ 151154358 â”‚ 1868015910 â”‚       1 â”‚
â”‚ 151154358 â”‚ 1868015900 â”‚       2 â”‚
â”‚ 151154358 â”‚ 4437858221 â”‚       3 â”‚
â”‚ 151154358 â”‚ 1868015889 â”‚       4 â”‚
â”‚ 151154358 â”‚ 1790048390 â”‚       5 â”‚
â”‚ 151154358 â”‚ 1868015881 â”‚       6 â”‚
â”‚ 151154358 â”‚ 1868015894 â”‚       7 â”‚
â”‚ 151154358 â”‚ 1868015896 â”‚       8 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ? rows (>9999 rows, 20 shown)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

å¦‚ä½ æ‰€è§ï¼Œç°åœ¨æ¯ä¸ªé“è·¯å…ƒç´ éƒ½æœ‰å¤šè¡Œæ•°æ®ï¼Œä¸”æœ‰å¤šä¸ªå¼•ç”¨å€¼ã€‚Ref_idxè¡¨ç¤º*refs*åˆ—è¡¨ä¸­åŸå§‹é¡ºåºã€‚

ä½ è¿˜å¯ä»¥çœ‹åˆ°æŸ¥è¯¢ä¸­çš„`SEMI JOIN`å­å¥ã€‚è¿™æ˜¯DuckDBä¸­ç‰¹æœ‰çš„è¿æ¥æ–¹å¼ï¼Œå®ƒä»…é€šè¿‡è¿‡æ»¤è¡Œæ¥ä»£æ›¿å®é™…çš„ç¬¬äºŒå¼ è¡¨è¿æ¥ã€‚ä½ å¯ä»¥åœ¨å®˜æ–¹æ–‡æ¡£ä¸­é˜…è¯»æ›´å¤šä¿¡æ¯ï¼š

[](https://duckdb.org/docs/sql/query_syntax/from?source=post_page-----ffeb15197390--------------------------------#semi-and-anti-joins) [## FROM & JOIN å­å¥

### FROMå­å¥æŒ‡å®šæ•°æ®æºï¼ŒæŸ¥è¯¢çš„å…¶ä½™éƒ¨åˆ†å°†åœ¨è¯¥æ•°æ®æºä¸Šæ“ä½œã€‚ä»é€»è¾‘ä¸Šçœ‹ï¼Œ...

[duckdb.org](https://duckdb.org/docs/sql/query_syntax/from?source=post_page-----ffeb15197390--------------------------------#semi-and-anti-joins)

ç°åœ¨æˆ‘ä»¬å¯ä»¥æ ¹æ®ä¸Šä¸€é˜¶æ®µçš„ refs é€‰æ‹©æ‰€éœ€çš„èŠ‚ç‚¹ï¼š

```py
CREATE TEMP TABLE required_nodes_with_geometries AS
SELECT id, ST_POINT(lon, lat) geometry
FROM ST_READOSM('monaco-latest.osm.pbf') nodes
SEMI JOIN matching_ways_with_nodes_refs
ON nodes.id = matching_ways_with_nodes_refs.ref
WHERE kind = 'node';

SELECT * FROM required_nodes_with_geometries;

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     id     â”‚                   geometry                   â”‚
â”‚   int64    â”‚                   geometry                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 4547239708 â”‚ POINT (7.4219302 43.7307441)                 â”‚
â”‚ 4547239709 â”‚ POINT (7.421943700000001 43.730763)          â”‚
â”‚ 4547239710 â”‚ POINT (7.421885100000001 43.7308797)         â”‚
â”‚ 4547239711 â”‚ POINT (7.421869 43.730828200000005)          â”‚
â”‚ 4547239712 â”‚ POINT (7.4218596 43.7307865)                 â”‚
â”‚ 4547239713 â”‚ POINT (7.4219166 43.7307701)                 â”‚
â”‚ 4547239714 â”‚ POINT (7.4220242 43.730742)                  â”‚
â”‚ 4547239715 â”‚ POINT (7.4220765 43.730725500000005)         â”‚
â”‚ 4547239716 â”‚ POINT (7.4220677 43.730680400000004)         â”‚
â”‚ 4547239717 â”‚ POINT (7.422105200000001 43.730662)          â”‚
â”‚      Â·     â”‚                  Â·                           â”‚
â”‚      Â·     â”‚                  Â·                           â”‚
â”‚      Â·     â”‚                  Â·                           â”‚
â”‚ 9983243582 â”‚ POINT (7.427689600000001 43.732439400000004) â”‚
â”‚ 9983243583 â”‚ POINT (7.4238021 43.7298837)                 â”‚
â”‚ 9983243584 â”‚ POINT (7.4272774 43.7321503)                 â”‚
â”‚ 9983243585 â”‚ POINT (7.4287133 43.7403807)                 â”‚
â”‚ 9983243586 â”‚ POINT (7.429299500000001 43.740351100000005) â”‚
â”‚ 9983243587 â”‚ POINT (7.4265819 43.7399094)                 â”‚
â”‚ 9983243588 â”‚ POINT (7.4275342 43.7323072)                 â”‚
â”‚ 9983243589 â”‚ POINT (7.427783700000001 43.732368)          â”‚
â”‚ 9983243590 â”‚ POINT (7.428839600000001 43.7402718)         â”‚
â”‚ 9983243591 â”‚ POINT (7.4269439 43.739707700000004)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ? rows (>9999 rows, 20 shown)                   2 columns â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ç°åœ¨æˆ‘ä»¬å¯ä»¥æ„å»ºå®Œæ•´çš„çº¿å­—ç¬¦ä¸²ï¼ˆlinestringï¼‰ï¼š

```py
CREATE TEMP TABLE matching_ways_linestrings AS
SELECT
    matching_ways.id,
    matching_ways.tags,
    ST_MakeLine(list(nodes.geometry ORDER BY ref_idx ASC)) linestring
FROM matching_ways
JOIN matching_ways_with_nodes_refs
ON matching_ways.id = matching_ways_with_nodes_refs.id
JOIN required_nodes_with_geometries nodes
ON matching_ways_with_nodes_refs.ref = nodes.id
GROUP BY 1, 2;

SELECT * FROM matching_ways_linestrings;

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     id     â”‚         tags         â”‚                linestring                â”‚
â”‚   int64    â”‚ map(varchar, varchâ€¦  â”‚                 geometry                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    4227212 â”‚ {highway=residentiâ€¦  â”‚ LINESTRING (7.424979 43.73150620000000â€¦  â”‚
â”‚    4227230 â”‚ {access=yes, adminâ€¦  â”‚ LINESTRING (7.4220576 43.7321018, 7.42â€¦  â”‚
â”‚    4227273 â”‚ {highway=secondaryâ€¦  â”‚ LINESTRING (7.4214168 43.7365583000000â€¦  â”‚
â”‚    4229325 â”‚ {highway=secondaryâ€¦  â”‚ LINESTRING (7.4201113 43.7373194000000â€¦  â”‚
â”‚    4229900 â”‚ {highway=secondaryâ€¦  â”‚ LINESTRING (7.4167819 43.7299324, 7.41â€¦  â”‚
â”‚    4230116 â”‚ {highway=footway, â€¦  â”‚ LINESTRING (7.4302666 43.7467818, 7.43â€¦  â”‚
â”‚   24672725 â”‚ {highway=residentiâ€¦  â”‚ LINESTRING (7.4356746 43.7516752, 7.43â€¦  â”‚
â”‚   25082701 â”‚ {area=yes, highwayâ€¦  â”‚ LINESTRING (7.421602 43.7370201, 7.421â€¦  â”‚
â”‚   31900562 â”‚ {area=yes, floatinâ€¦  â”‚ LINESTRING (7.422541900000001 43.73529â€¦  â”‚
â”‚   37794470 â”‚ {admin_level=2, boâ€¦  â”‚ LINESTRING (7.438411400000001 43.74942â€¦  â”‚
â”‚       Â·    â”‚        Â·             â”‚                    Â·                     â”‚
â”‚       Â·    â”‚        Â·             â”‚                    Â·                     â”‚
â”‚       Â·    â”‚        Â·             â”‚                    Â·                     â”‚
â”‚ 1203859766 â”‚ {landuse=grass}      â”‚ LINESTRING (7.4172849 43.7324023000000â€¦  â”‚
â”‚ 1203859775 â”‚ {landuse=grass}      â”‚ LINESTRING (7.417039300000001 43.73209â€¦  â”‚
â”‚ 1218054879 â”‚ {highway=footway, â€¦  â”‚ LINESTRING (7.4257143 43.7307631000000â€¦  â”‚
â”‚ 1229465608 â”‚ {amenity=shelter, â€¦  â”‚ LINESTRING (7.417716100000001 43.73075â€¦  â”‚
â”‚ 1230102086 â”‚ {footway=crossing,â€¦  â”‚ LINESTRING (7.414346 43.72708160000000â€¦  â”‚
â”‚ 1230123519 â”‚ {footway=link, higâ€¦  â”‚ LINESTRING (7.4238967 43.7370229, 7.42â€¦  â”‚
â”‚ 1202747620 â”‚ {crossing=unmarkedâ€¦  â”‚ LINESTRING (7.420526100000001 43.72671â€¦  â”‚
â”‚ 1203858289 â”‚ {crossing=uncontroâ€¦  â”‚ LINESTRING (7.4179021 43.7344211000000â€¦  â”‚
â”‚ 1203861575 â”‚ {amenity=parking}    â”‚ LINESTRING (7.430036100000001 43.74015â€¦  â”‚
â”‚ 1203861579 â”‚ {landuse=constructâ€¦  â”‚ LINESTRING (7.4323636 43.7423150000000â€¦  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 4786 rows (20 shown)                                               3 columns â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

![](../Images/4ac75ad2615c915d36bbd5d22d94dbf3.png)

åœ¨åœ°å›¾ä¸Šç»˜åˆ¶çš„è·¯çº¿çº¿å­—ç¬¦ä¸²ï¼ˆlinestringï¼‰ã€‚ç”±ä½œè€…ä½¿ç”¨ GeoPandas åº“ç”Ÿæˆã€‚

å®Œæˆæ‰€æœ‰è¿™äº›æ“ä½œåï¼Œæˆ‘ä»¬å¾—åˆ°çš„æ˜¯çº¿å­—ç¬¦ä¸²å½¢å¼çš„è·¯å¾„ã€‚ç°åœ¨æˆ‘ä»¬éœ€è¦é€‰æ‹©åº”è¯¥æ˜¯å¤šè¾¹å½¢çš„è·¯å¾„ã€‚æˆ‘ä»¬å¯ä»¥æ ¹æ®æ ‡ç­¾å€¼æ¥å®Œæˆè¿™é¡¹å·¥ä½œã€‚ä¸å¹¸çš„æ˜¯ï¼Œå¯¹äºæ­¤æ“ä½œï¼Œå¹¶æ²¡æœ‰å•ä¸€çš„æƒå¨æ¥æºã€‚æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹ OSM ç»´åŸºé¡µé¢ï¼Œäº†è§£ç¤¾åŒºåˆ›å»ºçš„å…¶ä¸­ä¸€ç§å®šä¹‰ã€‚

[](https://wiki.openstreetmap.org/wiki/Overpass_turbo/Polygon_Features?source=post_page-----ffeb15197390--------------------------------) [## Overpass turbo/Polygon Features

### ç”±äº OpenStreetMap æ²¡æœ‰å›ºæœ‰çš„åŒºåŸŸæ•°æ®ç±»å‹ï¼Œå› æ­¤å¿…é¡»åº”ç”¨å¯å‘å¼æ–¹æ³•æ¥ç¡®å®šä¸€æ¡è·¯å¾„æ˜¯å¦æ˜¯â€¦â€¦

[wiki.openstreetmap.org](https://wiki.openstreetmap.org/wiki/Overpass_turbo/Polygon_Features?source=post_page-----ffeb15197390--------------------------------) ![](../Images/78cf5e001831f9276d433c6b61d252da.png)

æ¥è‡ª Overpass turbo/Polygon Features ç»´åŸºé¡µé¢çš„æˆªå›¾ã€‚æ‹æ‘„äº 2024-01-17ã€‚

å¦‚ä½ æ‰€è§ï¼Œè¿™ä¸ªåˆ—è¡¨ç›¸å½“é•¿ï¼Œå› æ­¤ä¸ºäº†ç®€æ´èµ·è§ï¼Œæˆ‘ä»¬å°†ä»…æ£€æŸ¥çº¿å­—ç¬¦ä¸²æ˜¯å¦å½¢æˆé—­åˆç¯è·¯ï¼Œä»¥åŠåŒºåŸŸæ ‡ç­¾å€¼æ˜¯å¦ä¸æ˜¯ 'no'ã€‚

```py
WITH way_polygon_feature AS (
    SELECT
        id,
        (
            -- if first and last nodes are the same
            ST_Equals(ST_StartPoint(linestring), ST_EndPoint(linestring))
            -- if the element doesn't have any tags leave it as a Linestring
            AND tags IS NOT NULL
            -- if the element is specifically tagged 'area':'no' -> LineString
            AND NOT (
                list_contains(map_keys(tags), 'area')
                AND list_extract(map_extract(tags, 'area'), 1) = 'no'
            )
        ) AS is_polygon
    FROM matching_ways_linestrings
)
SELECT
    matching_ways_linestrings.id,
    matching_ways_linestrings.tags,
    (CASE
        WHEN is_polygon
        THEN ST_MakePolygon(linestring)
        ELSE linestring
    END)::GEOMETRY AS geometry
FROM matching_ways_linestrings
JOIN way_polygon_feature
ON matching_ways_linestrings.id = way_polygon_feature.id;

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     id     â”‚         tags         â”‚                 geometry                 â”‚
â”‚   int64    â”‚ map(varchar, varchâ€¦  â”‚                 geometry                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    4226740 â”‚ {highway=secondaryâ€¦  â”‚ LINESTRING (7.422170500000001 43.73286â€¦  â”‚
â”‚    4227198 â”‚ {highway=residentiâ€¦  â”‚ LINESTRING (7.420338900000001 43.73223â€¦  â”‚
â”‚    4227216 â”‚ {highway=service, â€¦  â”‚ LINESTRING (7.423448400000001 43.73268â€¦  â”‚
â”‚    4227242 â”‚ {highway=secondaryâ€¦  â”‚ LINESTRING (7.4221786 43.7322418000000â€¦  â”‚
â”‚    4227272 â”‚ {highway=secondaryâ€¦  â”‚ LINESTRING (7.422117500000001 43.73702â€¦  â”‚
â”‚    4229292 â”‚ {foot=no, highway=â€¦  â”‚ LINESTRING (7.41643 43.7311373, 7.4168â€¦  â”‚
â”‚    4229577 â”‚ {highway=residentiâ€¦  â”‚ LINESTRING (7.4251499 43.7397216, 7.42â€¦  â”‚
â”‚    4230122 â”‚ {alt_name=rue R. Pâ€¦  â”‚ LINESTRING (7.428823400000001 43.74602â€¦  â”‚
â”‚   25082741 â”‚ {highway=secondaryâ€¦  â”‚ LINESTRING (7.4231414 43.7369886000000â€¦  â”‚
â”‚   25722909 â”‚ {highway=footway, â€¦  â”‚ LINESTRING (7.423659300000001 43.73134â€¦  â”‚
â”‚       Â·    â”‚          Â·           â”‚                    Â·                     â”‚
â”‚       Â·    â”‚          Â·           â”‚                    Â·                     â”‚
â”‚       Â·    â”‚          Â·           â”‚                    Â·                     â”‚
â”‚ 1089844256 â”‚ {handrail=no, highâ€¦  â”‚ LINESTRING (7.4229453 43.7326080000000â€¦  â”‚
â”‚ 1089844296 â”‚ {highway=footway}    â”‚ LINESTRING (7.427017200000001 43.74044â€¦  â”‚
â”‚ 1202570722 â”‚ {access=private, lâ€¦  â”‚ POLYGON ((7.4263241 43.7390763, 7.4263â€¦  â”‚
â”‚  946167565 â”‚ {disused:leisure=pâ€¦  â”‚ POLYGON ((7.4276993 43.739335100000005â€¦  â”‚
â”‚ 1089844271 â”‚ {highway=footway}    â”‚ LINESTRING (7.4277667 43.732816, 7.427â€¦  â”‚
â”‚  335731716 â”‚ {highway=footway}    â”‚ LINESTRING (7.417764200000001 43.73439â€¦  â”‚
â”‚  779454018 â”‚ {building=residentâ€¦  â”‚ POLYGON ((7.4217522 43.7277202, 7.4218â€¦  â”‚
â”‚  943330855 â”‚ {landuse=grass}      â”‚ POLYGON ((7.4151844 43.7332252, 7.4152â€¦  â”‚
â”‚ 1089844229 â”‚ {highway=steps, inâ€¦  â”‚ LINESTRING (7.4274525 43.7328052, 7.42â€¦  â”‚
â”‚   49209608 â”‚ {addr:city=Monaco,â€¦  â”‚ POLYGON ((7.4223448 43.7304076, 7.4221â€¦  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 4786 rows (20 shown)                                               3 columns â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ç°åœ¨æˆ‘ä»¬å¯ä»¥åœ¨æœ€ç»ˆç»“æœä¸­çœ‹åˆ°çº¿å­—ç¬¦ä¸²ï¼ˆlinestringï¼‰å’Œå¤šè¾¹å½¢ï¼ˆpolygonï¼‰å‡ ä½•ä½“çš„æ··åˆã€‚ å½“ç„¶ï¼Œ*is_polygon*åˆ—çš„è°“è¯å¯ä»¥ï¼ˆç”šè‡³*åº”è¯¥*ï¼‰é€šè¿‡ä¸Šè¿°æåˆ°çš„å…³äºæ ‡ç­¾å€¼çš„é€»è¾‘æ¥æ‰©å±•ã€‚

ä¸ä¸Šé¢çš„å›¾ç‰‡ç›¸æ¯”ï¼Œç°åœ¨åœ°å›¾ä¸Šå¯è§æ›´å¤šå¡«å……çš„å¤šè¾¹å½¢ã€‚

![](../Images/15582954eacc19644cb8eff1f018f0cb.png)

åœ¨åœ°å›¾ä¸Šç»˜åˆ¶çš„è·¯çº¿å‡ ä½•ä½“ã€‚ç”±ä½œè€…ä½¿ç”¨ GeoPandas åº“ç”Ÿæˆã€‚

# ä»å…³ç³»ä¸­æ„å»ºå¤šè¾¹å½¢å’Œå¤šå¤šè¾¹å½¢å‡ ä½•ä½“

åœ¨ OSM ä¸­ï¼Œå…³ç³»è¢«ç”¨æ¥å°†å¤šä¸ªå…¶ä»–å…ƒç´ ç»„åˆæˆä¸€ä¸ªå•ä¸€çš„å¯¹è±¡ã€‚è¿™é‡Œæˆ‘ä»¬å°†ä»…å…³æ³¨ï¼ˆå¤šï¼‰å¤šè¾¹å½¢ã€‚è¿™äº›ç‰¹å®šçš„å…ƒç´ æœ‰ä¸€ä¸ª `type` æ ‡ç­¾ï¼Œå…¶å€¼ä¸ºä¸¤è€…ä¹‹ä¸€ï¼š`boundary` å’Œ `multipolygon`ã€‚

è¿™ç§å¯¹è±¡æ˜¯æœ€å¤æ‚çš„ï¼Œéœ€è¦é‡å»ºå‡ ä½•ä½“ã€‚ä»¥ä¸‹æ˜¯æˆ‘ä»¬éœ€è¦æ‰§è¡Œçš„æ­¥éª¤åˆ—è¡¨ï¼š

+   é€‰æ‹©å…·æœ‰é€‚å½“ `type` å€¼çš„å…³ç³»ã€‚

+   å°†ä¸å…³ç³»ç›¸å…³çš„æ‰€æœ‰ refs å±•å¼€ï¼Œå¹¶ä»…ä¿ç•™è·¯å¾„ refs â€”â€” æˆ‘ä»¬åªéœ€è¦ç›¸å…³çš„è·¯å¾„ refs æ¥é‡å»ºå¤šè¾¹å½¢ã€‚

+   é€‰æ‹©å…·æœ‰çº¿å­—ç¬¦ä¸²å‡ ä½•ä½“çš„æ‰€éœ€è·¯å¾„ â€”â€” åœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨æ„å»ºè·¯å¾„çš„æ­¥éª¤ã€‚

+   å¦‚æœè·¯å¾„çš„ ref ä¸º `null`ï¼Œåˆ™å°†å…¶åˆ†é…ä¸º â€˜outerâ€™ è§’è‰²ï¼Œå¹¶æ£€æŸ¥å…³ç³»ä¸­çš„ä»»ä½• ref æ˜¯å¦å…·æœ‰ â€˜outerâ€™ è§’è‰² â€”â€” å¦‚æœä¸€ä¸ªå…³ç³»æ²¡æœ‰ â€˜outerâ€™ refsï¼Œåˆ™å°†å®ƒä»¬å…¨éƒ¨è§†ä¸º â€˜outerâ€™ã€‚

+   æŒ‰â€œå¤–éƒ¨â€å’Œâ€œå†…éƒ¨â€è§’è‰²å¯¹æ‰€æœ‰çº¿å­—ç¬¦ä¸²è¿›è¡Œåˆ†ç»„ï¼Œå¹¶å°†å®ƒä»¬åˆå¹¶ä¸ºä¸€ä¸ªå•ä¸€çš„å¤šçº¿å­—ç¬¦ä¸²â€”â€”è®¸å¤šå…³ç³»æ˜¯ç”±å¤šä¸ªå•ä¸€çº¿å­—ç¬¦ä¸²å®šä¹‰çš„ï¼Œåªæœ‰å°†å®ƒä»¬ç»„åˆèµ·æ¥æ‰èƒ½å½¢æˆä¸€ä¸ªé—­åˆçš„å¤šè¾¹å½¢ã€‚

+   å°†å¤šçº¿å­—ç¬¦ä¸²æ‹†åˆ†ä¸ºå•ä¸€é—­ç¯çº¿å­—ç¬¦ä¸²ï¼Œå¹¶å°†å…¶ä¿å­˜ä¸ºå¤šè¾¹å½¢ã€‚

+   å°†å‡ ä½•ä½“æ‹†åˆ†ä¸ºâ€œå¤–éƒ¨â€å’Œâ€œå†…éƒ¨â€å¤šè¾¹å½¢ã€‚è¿™äº›å¯ä»¥ä»å…³ç³»å¯¹è±¡çš„`ref_role`åˆ—ä¸­æå–ã€‚

+   å¯¹äºæ¯ä¸ªâ€œå¤–éƒ¨â€å¤šè¾¹å½¢ï¼Œé€‰æ‹©æ‰€æœ‰å®Œå…¨åŒ…å«åœ¨å…¶ä¸­çš„â€œå†…éƒ¨â€å¤šè¾¹å½¢ï¼Œå¹¶åœ¨è¯¥å¤šè¾¹å½¢ä¸­åˆ›å»ºå­”ã€‚

+   å¯¹æ‰€æœ‰å¸¦å­”çš„â€œå¤–éƒ¨â€å¤šè¾¹å½¢è¿›è¡Œè”åˆã€‚

è®©æˆ‘ä»¬ä»é€‰æ‹©å…·æœ‰åŒ¹é…æ ‡ç­¾å€¼çš„å…³ç³»å¼€å§‹ã€‚

```py
CREATE TEMP TABLE matching_relations AS 
SELECT id, tags
FROM ST_READOSM('monaco-latest.osm.pbf')
WHERE kind = 'relation' AND len(refs) > 0
    AND tags IS NOT NULL AND cardinality(tags) > 0
    AND list_contains(map_keys(tags), 'type')
    AND list_has_any(map_extract(tags, 'type'), ['boundary', 'multipolygon']);

SELECT * FROM matching_relations;

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    id    â”‚                               tags                                â”‚
â”‚  int64   â”‚                       map(varchar, varchar)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     7385 â”‚ {ISO3166-2=FR-06, admin_level=6, alt_name:de=Meeralpen, border_â€¦  â”‚
â”‚     8654 â”‚ {ISO3166-2=FR-PAC, admin_level=4, border_type=region, boundary=â€¦  â”‚
â”‚    36990 â”‚ {ISO3166-1=MC, ISO3166-1:alpha2=MC, ISO3166-1:alpha3=MCO, adminâ€¦  â”‚
â”‚   174558 â”‚ {admin_level=8, boundary=administrative, name=Roquebrune-Cap-Maâ€¦  â”‚
â”‚   174562 â”‚ {admin_level=8, boundary=administrative, name=Beausoleil, name:â€¦  â”‚
â”‚   174956 â”‚ {admin_level=8, alt_name:it=Capo d`Aglio, boundary=administratiâ€¦  â”‚
â”‚   174958 â”‚ {admin_level=8, boundary=administrative, name=La Turbie, name:iâ€¦  â”‚
â”‚   393226 â”‚ {building=castle, castle_type=palace, charge=10â‚¬, email=visitesâ€¦  â”‚
â”‚   393481 â”‚ {building=school, name=Pensionnat des Dames de Saint-Maur, typeâ€¦  â”‚
â”‚  1124039 â”‚ {ISO3166-1=MC, ISO3166-1:alpha2=MC, ISO3166-1:alpha3=MCO, ISO31â€¦  â”‚
â”‚     Â·    â”‚                             Â·                                     â”‚
â”‚     Â·    â”‚                             Â·                                     â”‚
â”‚     Â·    â”‚                             Â·                                     â”‚
â”‚ 14399505 â”‚ {area=yes, floating=yes, man_made=pier, type=multipolygon}        â”‚
â”‚ 16248281 â”‚ {building=apartments, name=F, type=multipolygon}                  â”‚
â”‚ 16248282 â”‚ {building=apartments, name=E, type=multipolygon}                  â”‚
â”‚ 16248283 â”‚ {building=apartments, name=D, type=multipolygon}                  â”‚
â”‚ 16248284 â”‚ {building=apartments, name=C, type=multipolygon}                  â”‚
â”‚ 16248285 â”‚ {building=apartments, name=B, type=multipolygon}                  â”‚
â”‚ 16248286 â”‚ {building=apartments, name=A, type=multipolygon}                  â”‚
â”‚ 16250182 â”‚ {addr:country=MC, alt_name=Parc de la Roseraie, leisure=park, nâ€¦  â”‚
â”‚ 16261416 â”‚ {natural=water, type=multipolygon, water=pond}                    â”‚
â”‚ 16467322 â”‚ {admin_level=2, boundary=land_area, land_area=administrative, nâ€¦  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 78 rows (20 shown)                                                 2 columns â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ç°åœ¨æˆ‘ä»¬å°†å±•å¼€å¼•ç”¨åˆ—è¡¨ï¼Œå¹¶å°†å…¶æ‹†åˆ†ä¸ºå•ç‹¬çš„è¡Œã€‚ä¸è·¯å¾„ç›¸ä¼¼ï¼Œæˆ‘ä»¬ä¹Ÿå°†åˆ©ç”¨DuckDBçš„ç´¢å¼•åŠŸèƒ½æ¥è®°ä½åŸå§‹åˆ—è¡¨ä¸­å…ƒç´ çš„é¡ºåºã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬åªä¼šä¿ç•™`way`å¼•ç”¨ã€‚

```py
CREATE TEMP TABLE matching_relations_with_ways_refs AS
WITH unnested_relation_refs AS (
    SELECT
        r.id,
        UNNEST(refs) as ref,
        UNNEST(ref_types) as ref_type,
        UNNEST(ref_roles) as ref_role,
        UNNEST(range(length(refs))) as ref_idx
    FROM ST_READOSM('monaco-latest.osm.pbf') r
    SEMI JOIN matching_relations USING (id)
    WHERE kind = 'relation'
)
SELECT id, ref, ref_role, ref_idx
FROM unnested_relation_refs
WHERE ref_type = 'way';

SELECT * FROM matching_relations_with_ways_refs;

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    id    â”‚    ref    â”‚ ref_role â”‚ ref_idx â”‚
â”‚  int64   â”‚   int64   â”‚ varchar  â”‚  int64  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     7385 â”‚  30836152 â”‚ outer    â”‚       2 â”‚
â”‚     7385 â”‚ 889278953 â”‚ outer    â”‚       3 â”‚
â”‚     7385 â”‚ 889278956 â”‚ outer    â”‚       4 â”‚
â”‚     7385 â”‚ 889278957 â”‚ outer    â”‚       5 â”‚
â”‚     7385 â”‚ 889278958 â”‚ outer    â”‚       6 â”‚
â”‚     7385 â”‚ 889278962 â”‚ outer    â”‚       7 â”‚
â”‚     7385 â”‚ 960087656 â”‚ outer    â”‚       8 â”‚
â”‚     7385 â”‚  30836155 â”‚ outer    â”‚       9 â”‚
â”‚     7385 â”‚ 889278965 â”‚ outer    â”‚      10 â”‚
â”‚     7385 â”‚ 889278963 â”‚ outer    â”‚      11 â”‚
â”‚       Â·  â”‚      Â·    â”‚   Â·      â”‚       Â· â”‚
â”‚       Â·  â”‚      Â·    â”‚   Â·      â”‚       Â· â”‚
â”‚       Â·  â”‚      Â·    â”‚   Â·      â”‚       Â· â”‚
â”‚ 11278320 â”‚  35150936 â”‚ outer    â”‚     197 â”‚
â”‚ 11278320 â”‚ 466647567 â”‚ outer    â”‚     198 â”‚
â”‚ 11278320 â”‚ 214008684 â”‚ outer    â”‚     199 â”‚
â”‚ 11278320 â”‚ 466647569 â”‚ outer    â”‚     200 â”‚
â”‚ 11278320 â”‚ 466647568 â”‚ outer    â”‚     201 â”‚
â”‚ 11278320 â”‚ 214008689 â”‚ outer    â”‚     202 â”‚
â”‚ 11278320 â”‚ 263776194 â”‚ outer    â”‚     203 â”‚
â”‚ 11278320 â”‚  31124893 â”‚ outer    â”‚     204 â”‚
â”‚ 11278320 â”‚  31124895 â”‚ outer    â”‚     205 â”‚
â”‚ 11278320 â”‚  31124899 â”‚ outer    â”‚     206 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ? rows (>9999 rows, 20 shown)   4 columns â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

åœ¨ä¸‹ä¸€æ­¥ä¸­ï¼Œæˆ‘ä»¬å°†ä¸ºå…³ç³»æ‰€éœ€çš„è·¯å¾„æ„å»ºçº¿å­—ç¬¦ä¸²ã€‚ä¸‹é¢çš„æŸ¥è¯¢å‡ ä¹å®Œæ•´åœ°å‹ç¼©äº†è¯»å–è·¯å¾„çš„é€»è¾‘ï¼ˆè·å–æ‰€éœ€çš„èŠ‚ç‚¹ï¼Œæ„å»ºç‚¹å¹¶å°†å…¶åˆ†ç»„ä¸ºçº¿å­—ç¬¦ä¸²ï¼‰ï¼š

```py
CREATE TEMP TABLE required_ways_linestrings AS
WITH ways_required_by_relations_with_nodes_refs AS (
    SELECT id, UNNEST(refs) as ref, UNNEST(range(length(refs))) as ref_idx
    FROM ST_READOSM('monaco-latest.osm.pbf') ways
    SEMI JOIN matching_relations_with_ways_refs
    ON ways.id = matching_relations_with_ways_refs.ref
    WHERE kind = 'way'
),
nodes_required_by_relations_with_geometries AS (
    SELECT id, ST_POINT(lon, lat) geometry
    FROM ST_READOSM('monaco-latest.osm.pbf') nodes
    SEMI JOIN ways_required_by_relations_with_nodes_refs
    ON nodes.id = ways_required_by_relations_with_nodes_refs.ref
    WHERE kind = 'node'
)
SELECT
    ways.id,
    ST_MakeLine(list(nodes.geometry ORDER BY ref_idx ASC)) linestring
FROM ways_required_by_relations_with_nodes_refs ways
JOIN nodes_required_by_relations_with_geometries nodes
ON ways.ref = nodes.id
GROUP BY 1;

SELECT * FROM required_ways_linestrings;

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     id     â”‚                           linestring                            â”‚
â”‚   int64    â”‚                            geometry                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   37794470 â”‚ LINESTRING (7.438411400000001 43.749422300000006, 7.4384056 4â€¦  â”‚
â”‚   87878917 â”‚ LINESTRING (7.418041100000001 43.7256933, 7.4181547 43.725613â€¦  â”‚
â”‚   94252430 â”‚ LINESTRING (7.4141873 43.729494100000004, 7.414203400000001 4â€¦  â”‚
â”‚   94399618 â”‚ LINESTRING (7.4239717 43.740543100000004, 7.4238252 43.740372â€¦  â”‚
â”‚   94399736 â”‚ LINESTRING (7.423881400000001 43.7402971, 7.4239411 43.740265â€¦  â”‚
â”‚  104863462 â”‚ LINESTRING (7.424840000000001 43.731281800000005, 7.424917000â€¦  â”‚
â”‚  120114110 â”‚ LINESTRING (7.420872 43.7370979, 7.4207787 43.7370534, 7.4206â€¦  â”‚
â”‚  156242249 â”‚ LINESTRING (7.4294728 43.739895600000004, 7.429579500000001 4â€¦  â”‚
â”‚  165636038 â”‚ LINESTRING (7.419717100000001 43.732398700000005, 7.419772900â€¦  â”‚
â”‚  169297863 â”‚ LINESTRING (7.422815300000001 43.7321967, 7.4234109 43.732263â€¦  â”‚
â”‚       Â·    â”‚                                Â·                                â”‚
â”‚       Â·    â”‚                                Â·                                â”‚
â”‚       Â·    â”‚                                Â·                                â”‚
â”‚   24874398 â”‚ LINESTRING (7.418523400000001 43.7247599, 7.419012800000001 4â€¦  â”‚
â”‚   92627424 â”‚ LINESTRING (7.4166521 43.7322122, 7.4162303 43.73173910000000â€¦  â”‚
â”‚   94452829 â”‚ LINESTRING (7.4317066 43.7469647, 7.4317998 43.7470371, 7.431â€¦  â”‚
â”‚  335740502 â”‚ LINESTRING (7.4185151 43.7353633, 7.418442000000001 43.735298â€¦  â”‚
â”‚  398377193 â”‚ LINESTRING (7.420872 43.7370979, 7.420939000000001 43.7371298â€¦  â”‚
â”‚  405529436 â”‚ LINESTRING (7.417534900000001 43.7258914, 7.4175347 43.725833â€¦  â”‚
â”‚  423632259 â”‚ LINESTRING (7.4212208 43.7320944, 7.421461300000001 43.732057â€¦  â”‚
â”‚  572935479 â”‚ LINESTRING (7.427508100000001 43.7394168, 7.427496700000001 4â€¦  â”‚
â”‚  586494707 â”‚ LINESTRING (7.4270357 43.739109000000006, 7.4269512 43.739155â€¦  â”‚
â”‚ 1202570715 â”‚ LINESTRING (7.426448400000001 43.739491400000006, 7.4264682 4â€¦  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 141 rows (20 shown)                                                2 columns â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

åœ¨åˆ›å»ºæ‰€éœ€çš„çº¿å­—ç¬¦ä¸²åï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥å°†å®ƒä»¬ä¸å…³ç³»æ•°æ®è¿æ¥èµ·æ¥ã€‚æˆ‘ä»¬è¿˜ä¼šç¡®ä¿æ­£ç¡®è§£ææ‰€éœ€çš„`ref_role` â€” å¡«å……ç©ºå€¼æˆ–æ›¿æ¢å®ƒä»¬ï¼Œå¦‚æœå…³ç³»åœ¨OSMæ•°æ®åº“ä¸­é”™è¯¯åœ°å®šä¹‰äº†`ref_roles`ã€‚

```py
CREATE TEMP TABLE matching_relations_with_ways_linestrings AS
WITH unnested_relations_with_way_linestrings AS (
    SELECT
        r.id,
        COALESCE(r.ref_role, 'outer') as ref_role,
        r.ref,
        w.linestring::GEOMETRY as geometry
    FROM matching_relations_with_ways_refs r
    JOIN required_ways_linestrings w
    ON w.id = r.ref
    ORDER BY r.id, r.ref_idx
),
any_outer_refs AS (
    -- check if any way attached to the relation has the `outer` role
    SELECT id, bool_or(ref_role == 'outer') has_any_outer_refs
    FROM unnested_relations_with_way_linestrings
    GROUP BY id
)
SELECT
    unnested_relations_with_way_linestrings.* EXCLUDE (ref_role),
    -- if none of the way refs has `outer` role - treat each ref as `outer`
    CASE WHEN any_outer_refs.has_any_outer_refs
        THEN unnested_relations_with_way_linestrings.ref_role
        ELSE 'outer'
    END as ref_role
FROM unnested_relations_with_way_linestrings
JOIN any_outer_refs
ON any_outer_refs.id = unnested_relations_with_way_linestrings.id;

SELECT * FROM matching_relations_with_ways_linestrings;

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    id    â”‚    ref    â”‚                  geometry                  â”‚ ref_role â”‚
â”‚  int64   â”‚   int64   â”‚                  geometry                  â”‚ varchar  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     7385 â”‚ 772081595 â”‚ LINESTRING (7.415291600000001 43.7234393â€¦  â”‚ outer    â”‚
â”‚     7385 â”‚ 212810311 â”‚ LINESTRING (7.4120416 43.7280955, 7.4123â€¦  â”‚ outer    â”‚
â”‚     7385 â”‚ 176533407 â”‚ LINESTRING (7.412670800000001 43.7316348â€¦  â”‚ outer    â”‚
â”‚     7385 â”‚  37811853 â”‚ LINESTRING (7.4127007 43.7346954, 7.4126â€¦  â”‚ outer    â”‚
â”‚     7385 â”‚  37794471 â”‚ LINESTRING (7.428754700000001 43.7460174â€¦  â”‚ outer    â”‚
â”‚     7385 â”‚ 398372186 â”‚ LINESTRING (7.436885 43.7519173, 7.43677â€¦  â”‚ outer    â”‚
â”‚     7385 â”‚  37794470 â”‚ LINESTRING (7.438411400000001 43.7494223â€¦  â”‚ outer    â”‚
â”‚     7385 â”‚ 770774507 â”‚ LINESTRING (7.439171000000001 43.7490109â€¦  â”‚ outer    â”‚
â”‚     8654 â”‚ 772081595 â”‚ LINESTRING (7.415291600000001 43.7234393â€¦  â”‚ outer    â”‚
â”‚     8654 â”‚ 212810311 â”‚ LINESTRING (7.4120416 43.7280955, 7.4123â€¦  â”‚ outer    â”‚
â”‚       Â·  â”‚     Â·     â”‚                     Â·                      â”‚   Â·      â”‚
â”‚       Â·  â”‚     Â·     â”‚                     Â·                      â”‚   Â·      â”‚
â”‚       Â·  â”‚     Â·     â”‚                     Â·                      â”‚   Â·      â”‚
â”‚ 11546878 â”‚ 840890844 â”‚ LINESTRING (7.420754 43.735872900000004,â€¦  â”‚ outer    â”‚
â”‚ 11546878 â”‚ 840890848 â”‚ LINESTRING (7.4207413 43.7356673, 7.4207â€¦  â”‚ outer    â”‚
â”‚ 16467322 â”‚ 772081595 â”‚ LINESTRING (7.415291600000001 43.7234393â€¦  â”‚ outer    â”‚
â”‚ 16467322 â”‚ 212810311 â”‚ LINESTRING (7.4120416 43.7280955, 7.4123â€¦  â”‚ outer    â”‚
â”‚ 16467322 â”‚ 176533407 â”‚ LINESTRING (7.412670800000001 43.7316348â€¦  â”‚ outer    â”‚
â”‚ 16467322 â”‚  37811853 â”‚ LINESTRING (7.4127007 43.7346954, 7.4126â€¦  â”‚ outer    â”‚
â”‚ 16467322 â”‚  37794471 â”‚ LINESTRING (7.428754700000001 43.7460174â€¦  â”‚ outer    â”‚
â”‚ 16467322 â”‚ 398372186 â”‚ LINESTRING (7.436885 43.7519173, 7.43677â€¦  â”‚ outer    â”‚
â”‚ 16467322 â”‚  37794470 â”‚ LINESTRING (7.438411400000001 43.7494223â€¦  â”‚ outer    â”‚
â”‚ 16467322 â”‚ 770774507 â”‚ LINESTRING (7.439171000000001 43.7490109â€¦  â”‚ outer    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 410 rows (20 shown)                                                4 columns â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

å¦‚æ‚¨æ‰€è§ï¼Œæ¯ä¸ªå…³ç³»éƒ½åˆ†é…äº†å¤šä¸ªè·¯å¾„å’Œçº¿å­—ç¬¦ä¸²ã€‚è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç¤ºä¾‹æ¥çœ‹å®ƒä»¬åœ¨åœ°å›¾ä¸Šçš„è¡¨ç°ï¼š

![](../Images/a34fe385da26c62cce2dd5d832df57a9.png)

ä¸€ä¸ªå•ä¸€çš„å…³ç³»ï¼ˆ[5986437](https://www.openstreetmap.org/relation/5986437)ï¼‰ï¼Œå…¶ä¸­åŒ…å«æŒ‰é¢œè‰²ç¼–ç çš„è·¯å¾„ã€‚ç”±ä½œè€…ä½¿ç”¨GeoPandasåº“ç”Ÿæˆã€‚

è¦åˆ›å»ºå®Œæ•´çš„å¤šè¾¹å½¢ï¼Œæˆ‘ä»¬å¿…é¡»åˆ©ç”¨`ST_LineMerge`å‡½æ•°ï¼Œå®ƒå°†ç»„åˆä¸€ç³»åˆ—çº¿å­—ç¬¦ä¸²ï¼ˆä½ å¯ä»¥å°†å…¶æ¯”ä½œå°†ä¸€æ®µæ®µç»³å­ç»‘åœ¨ä¸€èµ·ï¼‰ã€‚ä½ å¯ä»¥åœ¨è¿™é‡Œé˜…è¯»æ›´å¤šå…³äºæ­¤æ“ä½œçš„ä¿¡æ¯ï¼š

[](https://postgis.net/docs/ST_LineMerge.html?source=post_page-----ffeb15197390--------------------------------) [## ST_LineMerge

### ST_LineMerge - è¿”å›é€šè¿‡ç¼åˆå¤šä¸ªçº¿å­—ç¬¦ä¸²å½¢æˆçš„çº¿ã€‚

[postgis.net](https://postgis.net/docs/ST_LineMerge.html?source=post_page-----ffeb15197390--------------------------------)

ä½œä¸ºé¢å¤–çš„éªŒè¯æ­¥éª¤ï¼Œæˆ‘ä»¬å°†æ£€æŸ¥ç”Ÿæˆçš„çº¿å­—ç¬¦ä¸²æ˜¯å¦è‡³å°‘åŒ…å«4ä¸ªç‚¹ï¼Œå¹¶ä¸”ç¬¬ä¸€ä¸ªç‚¹æ˜¯å¦ç­‰äºæœ€åä¸€ä¸ªç‚¹ï¼Œç„¶åå†å°†å®ƒä»¬è½¬æ¢ä¸ºå¤šè¾¹å½¢ï¼š

```py
CREATE TEMP TABLE matching_relations_with_merged_polygons AS
WITH merged_linestrings AS (
    SELECT
        id,
        ref_role,
        UNNEST(
            ST_Dump(ST_LineMerge(ST_Collect(list(geometry)))),
            recursive := true
        ),
    FROM matching_relations_with_ways_linestrings
    GROUP BY id, ref_role
),
relations_with_linestrings AS (
    SELECT
        id,
        ref_role,
        -- ST_Dump returns column named `geom`
        geom AS geometry,
        row_number() OVER (PARTITION BY id) as geometry_id
    FROM
        merged_linestrings
    -- discard linestrings with less than 4 points
    WHERE ST_NPoints(geom) >= 4
),
valid_relations AS (
    SELECT id, is_valid
    FROM (
        SELECT
            id,
            bool_and(
                -- Check if start point equals the end point
                ST_Equals(ST_StartPoint(geometry), ST_EndPoint(geometry))
            ) is_valid
        FROM relations_with_linestrings
        GROUP BY id
    )
    WHERE is_valid = true
)
SELECT 
    id,
    ref_role,
    ST_MakePolygon(geometry) geometry,
    geometry_id
FROM relations_with_linestrings
SEMI JOIN valid_relations
ON relations_with_linestrings.id = valid_relations.id;

SELECT * FROM matching_relations_with_merged_polygons;

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    id    â”‚ ref_role â”‚                 geometry                 â”‚ geometry_id â”‚
â”‚  int64   â”‚ varchar  â”‚                 geometry                 â”‚    int64    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1369631 â”‚ inner    â”‚ POLYGON ((7.438232200000001 43.7511057â€¦  â”‚           1 â”‚
â”‚  1369631 â”‚ outer    â”‚ POLYGON ((7.438008600000001 43.7502850â€¦  â”‚           2 â”‚
â”‚  1484217 â”‚ outer    â”‚ POLYGON ((7.423010700000001 43.7307028â€¦  â”‚           1 â”‚
â”‚  1484217 â”‚ inner    â”‚ POLYGON ((7.423114600000001 43.7305994â€¦  â”‚           2 â”‚
â”‚  5986436 â”‚ outer    â”‚ POLYGON ((7.428754700000001 43.7460174â€¦  â”‚           1 â”‚
â”‚  8269572 â”‚ outer    â”‚ POLYGON ((7.4287048 43.737701400000006â€¦  â”‚           1 â”‚
â”‚  8269572 â”‚ inner    â”‚ POLYGON ((7.4284492 43.7375604, 7.4286â€¦  â”‚           2 â”‚
â”‚ 16248286 â”‚ outer    â”‚ POLYGON ((7.426306200000001 43.7391565â€¦  â”‚           1 â”‚
â”‚ 16248286 â”‚ inner    â”‚ POLYGON ((7.4263241 43.7390763, 7.4263â€¦  â”‚           2 â”‚
â”‚ 16261416 â”‚ inner    â”‚ POLYGON ((7.417829200000001 43.731382,â€¦  â”‚           1 â”‚
â”‚     Â·    â”‚   Â·      â”‚                    Â·                     â”‚           Â· â”‚
â”‚     Â·    â”‚   Â·      â”‚                    Â·                     â”‚           Â· â”‚
â”‚     Â·    â”‚   Â·      â”‚                    Â·                     â”‚           Â· â”‚
â”‚  8280869 â”‚ inner    â”‚ POLYGON ((7.426753300000001 43.7388868â€¦  â”‚           2 â”‚
â”‚  8280869 â”‚ inner    â”‚ POLYGON ((7.4270357 43.739109000000006â€¦  â”‚           3 â”‚
â”‚  8280869 â”‚ inner    â”‚ POLYGON ((7.4271374 43.739011500000004â€¦  â”‚           4 â”‚
â”‚  8280869 â”‚ inner    â”‚ POLYGON ((7.4272666 43.7389165, 7.4273â€¦  â”‚           5 â”‚
â”‚ 11384697 â”‚ outer    â”‚ POLYGON ((7.427075 43.7315167, 7.42749â€¦  â”‚           1 â”‚
â”‚ 11384697 â”‚ inner    â”‚ POLYGON ((7.426917700000001 43.7313266â€¦  â”‚           2 â”‚
â”‚ 11384697 â”‚ inner    â”‚ POLYGON ((7.427001400000001 43.7313937â€¦  â”‚           3 â”‚
â”‚ 11546878 â”‚ outer    â”‚ POLYGON ((7.4207413 43.7356673, 7.4207â€¦  â”‚           1 â”‚
â”‚ 11538023 â”‚ inner    â”‚ POLYGON ((7.426528200000001 43.7329359â€¦  â”‚           1 â”‚
â”‚ 11538023 â”‚ outer    â”‚ POLYGON ((7.426554 43.7328276, 7.42654â€¦  â”‚           2 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 88 rows (20 shown)                                                 4 columns â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

è®©æˆ‘ä»¬çœ‹çœ‹æ‰§è¡Œæ­¤æ“ä½œåçš„å‰ä¸€ä¸ªç¤ºä¾‹ã€‚æˆ‘ä»¬åº”è¯¥å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªç‹¬ç«‹çš„å¤šè¾¹å½¢ï¼š

![](../Images/d72c2b5c71b7e6a1349da547f29bb068.png)

ä¸€ä¸ªå•ä¸€çš„å…³ç³»ï¼ˆ[5986437](https://www.openstreetmap.org/relation/5986437)ï¼‰ï¼Œå…¶ä¸­åˆå¹¶çš„è·¯å¾„ä½œä¸ºä¸¤ä¸ªç‹¬ç«‹çš„å¤šè¾¹å½¢ã€‚ç”±ä½œè€…ä½¿ç”¨GeoPandasåº“ç”Ÿæˆã€‚

æˆ‘ä¹‹å‰æåˆ°è¿‡ï¼Œåˆ›å»ºå…³ç³»çš„è·¯å¾„å…·æœ‰`outer`å’Œ`inner`çš„`ref_types`ã€‚è¿™é‡Œä½ å¯ä»¥çœ‹åˆ°å®ƒä»¬çš„æ ·å­ï¼š

![](../Images/4bf65f217dccd5aedeea10bf2b511cde.png)

ä¸€ä¸ªå•ä¸€å…³ç³»ï¼ˆ[8280869](https://www.openstreetmap.org/relation/828086)ï¼‰ä¸åˆå¹¶çš„è·¯å¾„åˆ†ç»„ä¸ºå¤–éƒ¨å’Œå†…éƒ¨å¤šè¾¹å½¢ã€‚ç”±ä½œè€…ä½¿ç”¨ GeoPandas åº“ç”Ÿæˆã€‚

è¿™äº›è§’è‰²æ„å‘³ç€ `inner` è·¯å¾„æ˜¯ `outer` å¤šè¾¹å½¢ä¸­çš„â€œå­”æ´â€ï¼Œæˆ‘ä»¬å¿…é¡»é‡ç°è¿™ä¸€æ­¥éª¤ä»¥ç¡®ä¿å‡ ä½•ä½“çš„æ­£ç¡®æ€§ã€‚

ç°åœ¨è®©æˆ‘ä»¬ä¸“æ³¨äºå°†å¤šè¾¹å½¢åˆ†ä¸ºæœ‰å­”å’Œæ²¡æœ‰å­”çš„ä¸¤ç»„ï¼Œä½¿ç”¨ `ST_Within` è°“è¯ï¼Œå®ƒæ£€æŸ¥ä¸€ä¸ªå‡ ä½•ä½“æ˜¯å¦å®Œå…¨ä½äºå¦ä¸€ä¸ªå‡ ä½•ä½“å†…ã€‚

```py
CREATE TEMP TABLE matching_relations_with_outer_polygons_with_holes AS
WITH outer_polygons AS (
    SELECT id, geometry_id, geometry
    FROM matching_relations_with_merged_polygons
    WHERE ref_role = 'outer'
), inner_polygons AS (
    SELECT id, geometry_id, geometry
    FROM matching_relations_with_merged_polygons
    WHERE ref_role = 'inner'
)
SELECT
    op.id,
    op.geometry_id,
    ST_Difference(any_value(op.geometry), ST_Union_Agg(ip.geometry)) geometry
FROM outer_polygons op
JOIN inner_polygons ip
ON op.id = ip.id AND ST_WITHIN(ip.geometry, op.geometry)
GROUP BY op.id, op.geometry_id;

CREATE TEMP TABLE matching_relations_with_outer_polygons_without_holes AS
WITH outer_polygons AS (
    SELECT id, geometry_id, geometry
    FROM matching_relations_with_merged_polygons
    WHERE ref_role = 'outer'
)
SELECT
    op.id,
    op.geometry_id,
    op.geometry
FROM outer_polygons op
ANTI JOIN matching_relations_with_outer_polygons_with_holes opwh
ON op.id = opwh.id AND op.geometry_id = opwh.geometry_id;

SELECT * FROM matching_relations_with_outer_polygons_with_holes
UNION ALL
SELECT * FROM matching_relations_with_outer_polygons_without_holes;

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    id    â”‚ geometry_id â”‚                      geometry                       â”‚
â”‚  int64   â”‚    int64    â”‚                      geometry                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 16248286 â”‚           1 â”‚ POLYGON ((7.4263139 43.7391602, 7.426324900000001â€¦  â”‚
â”‚  1369192 â”‚           1 â”‚ POLYGON ((7.4226247 43.7402251, 7.4227848 43.7396â€¦  â”‚
â”‚  8147763 â”‚           1 â”‚ POLYGON ((7.438223000000001 43.7477296, 7.4382403â€¦  â”‚
â”‚   393226 â”‚           1 â”‚ POLYGON ((7.4204802 43.731016700000005, 7.4203979â€¦  â”‚
â”‚ 11484092 â”‚           4 â”‚ POLYGON ((7.417896900000001 43.724827000000005, 7â€¦  â”‚
â”‚ 11384697 â”‚           1 â”‚ POLYGON ((7.4274934 43.731250700000004, 7.4267196â€¦  â”‚
â”‚  8269572 â”‚           1 â”‚ POLYGON ((7.4287166 43.7376724, 7.4287948 43.7376â€¦  â”‚
â”‚ 16261416 â”‚           3 â”‚ POLYGON ((7.4178309 43.731391, 7.417877000000001 â€¦  â”‚
â”‚ 16248284 â”‚           1 â”‚ POLYGON ((7.426637500000001 43.7394678, 7.4266485â€¦  â”‚
â”‚ 16248285 â”‚           1 â”‚ POLYGON ((7.426114600000001 43.739267600000005, 7â€¦  â”‚
â”‚     Â·    â”‚           Â· â”‚                          Â·                          â”‚
â”‚     Â·    â”‚           Â· â”‚                          Â·                          â”‚
â”‚     Â·    â”‚           Â· â”‚                          Â·                          â”‚
â”‚ 11546879 â”‚           1 â”‚ POLYGON ((7.4209316 43.7356234, 7.421037 43.73562â€¦  â”‚
â”‚  2220206 â”‚           1 â”‚ POLYGON ((7.4120416 43.7280955, 7.412103900000001â€¦  â”‚
â”‚  5986438 â”‚           1 â”‚ POLYGON ((7.4191482 43.738887500000004, 7.4199833â€¦  â”‚
â”‚  2221178 â”‚           1 â”‚ POLYGON ((7.415860400000001 43.7313885, 7.416195 â€¦  â”‚
â”‚  2221179 â”‚           1 â”‚ POLYGON ((7.422280000000001 43.7367186, 7.4227584â€¦  â”‚
â”‚  2220208 â”‚           1 â”‚ POLYGON ((7.41849 43.730922400000004, 7.4185156 4â€¦  â”‚
â”‚  2254506 â”‚           1 â”‚ POLYGON ((7.432995900000001 43.7447102, 7.4329125â€¦  â”‚
â”‚  5986437 â”‚           1 â”‚ POLYGON ((7.4307593 43.745595, 7.4306621 43.74541â€¦  â”‚
â”‚  5986437 â”‚           2 â”‚ POLYGON ((7.4343358 43.7457085, 7.4341337 43.7455â€¦  â”‚
â”‚ 11546878 â”‚           1 â”‚ POLYGON ((7.4207413 43.7356673, 7.4207413 43.7357â€¦  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 47 rows (20 shown)                                                 3 columns â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

åœ¨è¿™ä¸ªæŸ¥è¯¢ä¸­ï¼Œä½¿ç”¨äº†å¦ä¸€ç§ç‰¹æ®Šçš„è¿æ¥â€”â€”`ANTI JOIN`ã€‚è¿™ä¸ªè¿æ¥ä¼šè¿‡æ»¤æ‰æ‰€æœ‰å·¦ä¾§è¡¨ä¸­ä¸å³ä¾§è¡¨è¿æ¥çš„è¡Œã€‚

æœ€åä¸€æ­¥æ˜¯ä½¿ç”¨ `ST_Union_Agg` æ“ä½œå°†ä¸€ä¸ªå…³ç³»çš„æ‰€æœ‰å¤šè¾¹å½¢åˆå¹¶ã€‚å®ƒå°†æŠŠæ‰€æœ‰å¤šè¾¹å½¢åˆå¹¶ä¸ºå¤šå¤šè¾¹å½¢ï¼ˆå¦‚æœæœ‰å¤šä¸ªï¼‰ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªå•ä¸€çš„å‡ ä½•ä½“ã€‚

```py
WITH unioned_outer_geometries AS (
    SELECT id, geometry
    FROM matching_relations_with_outer_polygons_with_holes
    UNION ALL
    SELECT id, geometry
    FROM matching_relations_with_outer_polygons_without_holes
),
final_geometries AS (
    SELECT id, ST_Union_Agg(geometry) geometry
    FROM unioned_outer_geometries
    GROUP BY id
)
SELECT r_g.id, r.tags, r_g.geometry
FROM final_geometries r_g
JOIN matching_relations r
ON r.id = r_g.id;

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    id    â”‚         tags         â”‚                  geometry                  â”‚
â”‚  int64   â”‚ map(varchar, varchâ€¦  â”‚                  geometry                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   393226 â”‚ {building=castle, â€¦  â”‚ POLYGON ((7.4204802 43.731016700000005, â€¦  â”‚
â”‚   393481 â”‚ {building=school, â€¦  â”‚ POLYGON ((7.423992800000001 43.731841800â€¦  â”‚
â”‚  1369191 â”‚ {building=apartmenâ€¦  â”‚ POLYGON ((7.4231004 43.7412894, 7.423314â€¦  â”‚
â”‚  1369192 â”‚ {building=apartmenâ€¦  â”‚ POLYGON ((7.4226247 43.7402251, 7.422784â€¦  â”‚
â”‚  1369193 â”‚ {building=apartmenâ€¦  â”‚ POLYGON ((7.424 43.7405491, 7.4240401 43â€¦  â”‚
â”‚  1369195 â”‚ {building=apartmenâ€¦  â”‚ POLYGON ((7.418679900000001 43.738187100â€¦  â”‚
â”‚  1369631 â”‚ {addr:housenumber=â€¦  â”‚ POLYGON ((7.4379729 43.7502505, 7.437937â€¦  â”‚
â”‚  1369632 â”‚ {addr:city=Monaco,â€¦  â”‚ POLYGON ((7.4317121 43.74709, 7.4318277 â€¦  â”‚
â”‚  1484190 â”‚ {addr:city=Monaco,â€¦  â”‚ POLYGON ((7.425469 43.731494000000005, 7â€¦  â”‚
â”‚  1484217 â”‚ {building=retail, â€¦  â”‚ POLYGON ((7.423202300000001 43.7307117, â€¦  â”‚
â”‚     Â·    â”‚          Â·           â”‚                     Â·                      â”‚
â”‚     Â·    â”‚          Â·           â”‚                     Â·                      â”‚
â”‚     Â·    â”‚          Â·           â”‚                     Â·                      â”‚
â”‚ 14399505 â”‚ {area=yes, floatinâ€¦  â”‚ POLYGON ((7.4195986 43.7265293, 7.419595â€¦  â”‚
â”‚ 16248281 â”‚ {building=apartmenâ€¦  â”‚ POLYGON ((7.4260438 43.739789800000004, â€¦  â”‚
â”‚ 16248282 â”‚ {building=apartmenâ€¦  â”‚ POLYGON ((7.426243100000001 43.7396824, â€¦  â”‚
â”‚ 16248283 â”‚ {building=apartmenâ€¦  â”‚ POLYGON ((7.426438200000001 43.739575200â€¦  â”‚
â”‚ 16248284 â”‚ {building=apartmenâ€¦  â”‚ POLYGON ((7.426637500000001 43.7394678, â€¦  â”‚
â”‚ 16248285 â”‚ {building=apartmenâ€¦  â”‚ POLYGON ((7.426114600000001 43.739267600â€¦  â”‚
â”‚ 16248286 â”‚ {building=apartmenâ€¦  â”‚ POLYGON ((7.4263139 43.7391602, 7.426324â€¦  â”‚
â”‚ 16250182 â”‚ {addr:country=MC, â€¦  â”‚ POLYGON ((7.418348300000001 43.7256979, â€¦  â”‚
â”‚ 16261416 â”‚ {natural=water, tyâ€¦  â”‚ POLYGON ((7.4178309 43.731391, 7.4178770â€¦  â”‚
â”‚ 11546878 â”‚ {addr:city=Monaco,â€¦  â”‚ POLYGON ((7.4207413 43.7356673, 7.420741â€¦  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 46 rows (20 shown)                                                 3 columns â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

è¿™æ˜¯ä¹‹å‰çš„å…³ç³»ç¤ºä¾‹ï¼Œç°åœ¨å¸¦æœ‰å­”æ´ï¼š

![](../Images/217a6f093c325a233d93a5d152a284d4.png)

ä¸€ä¸ªå•ä¸€å…³ç³»ï¼ˆ[8280869](https://www.openstreetmap.org/relation/828086)ï¼‰â€”â€”ä¸€ä¸ªå¸¦å­”çš„å¤šè¾¹å½¢ã€‚ç”±ä½œè€…ä½¿ç”¨ GeoPandas åº“ç”Ÿæˆã€‚

![](../Images/206d0d2c26863920fd791636813f0d85.png)

ç»˜åˆ¶åœ¨åœ°å›¾ä¸Šçš„å…³ç³»å‡ ä½•ä½“ã€‚ç”±ä½œè€…ä½¿ç”¨ GeoPandas åº“ç”Ÿæˆã€‚

# é”™è¯¯å®šä¹‰çš„å…³ç³»å¯¹è±¡ç¤ºä¾‹

ç”±äº OpenStreetMap æ•°æ®ä¸»è¦ç”±ç¤¾åŒºæ·»åŠ ï¼Œå› æ­¤æœ‰äº›å‡ ä½•ä½“æ²¡æœ‰æ­£ç¡®å®šä¹‰ã€‚OSM ç»´åŸºæè¿°äº†åœ°å›¾åˆ¶ä½œäººå‘˜å¦‚ä½•å°†å‡ ä½•ä½“æ·»åŠ åˆ°åœ°å›¾ä¸­çš„è§„åˆ™ã€‚

[](https://wiki.openstreetmap.org/wiki/Relation:multipolygon/validity?source=post_page-----ffeb15197390--------------------------------) [## Relation:multipolygon/validity

### æœ¬é¡µé¢ä»…ä¸ºæè®®ï¼Œæœªä»£è¡¨å…³äºä»€ä¹ˆæœ‰æ•ˆæˆ–æ— æ•ˆçš„å…±è¯†ï¼Œåªæ˜¯æå‡ºäº†å¯èƒ½çš„â€¦

wiki.openstreetmap.org](https://wiki.openstreetmap.org/wiki/Relation:multipolygon/validity?source=post_page-----ffeb15197390--------------------------------)

æœ¬èŠ‚å°†æ¦‚è¿°ä¸€äº›å¸¸è§çš„é”™è¯¯ï¼Œå¹¶é™„å¸¦ç¤ºä¾‹ã€‚

## å…³ç³»ä¸­æœ‰ä¸¤ä¸ªé‡å çš„â€œouterâ€è·¯å¾„

è¿™åº§å»ºç­‘ç”±ä¸¤ä¸ªå½¢çŠ¶å®šä¹‰ï¼šä¸€ä¸ªçŸ©å½¢å’Œä¸€ä¸ªå‡ ä¹æ˜¯åœ†å½¢çš„å½¢çŠ¶ã€‚ç”±äºè¿™ä¸¤è€…é‡å ï¼Œå¯ä»¥çœ‹åˆ°æ¸²æŸ“å¼•æ“åœ¨æœ¬ä¸åº”è¯¥æœ‰ç©ºéš™çš„åœ°æ–¹äº§ç”Ÿäº†ä¸€ä¸ªé—´éš™ã€‚

![](../Images/671b8dd3fbcd20c09c06f10a11affd08.png)

ä½œè€…æä¾›çš„ OpenStreetMap æˆªå›¾ã€‚

## å…³ç³»ä¸­æ²¡æœ‰â€œouterâ€è·¯å¾„

è¿™é‡Œä½ å¯ä»¥çœ‹åˆ°ä¸€ä¸ªå¸¦æœ‰ `way` æˆå‘˜çš„å½©å¼¹åœºï¼Œæˆå‘˜è¢«å®šä¹‰ä¸ºâ€œä¸»å»ºç­‘â€å’Œ 4 ä¸ªâ€œç«æŠ€åœºâ€ã€‚è¿™äº›éƒ½åº”è¯¥å®šä¹‰ä¸º `outer` è·¯å¾„ã€‚

![](../Images/927a31510d513e7214b9c5a477933ade.png)

ä½œè€…æä¾›çš„ OpenStreetMap æˆªå›¾ã€‚

## ä¸¤ä¸ªé‡å æˆ–æ¥è§¦çš„â€œinnerâ€è·¯å¾„

![](../Images/2dd6cb3b3ac6ea1ed1b73d63d44823ed.png)

ä½œè€…æä¾›çš„ OpenStreetMap æˆªå›¾ã€‚

å¦‚æœä½ æœ‰å…´è¶£äº†è§£æ›´å¤šå…³äºå¦‚ä½•ä¿®å¤è¿™äº›é—®é¢˜çš„ä¿¡æ¯ï¼Œå¯ä»¥æŸ¥é˜…è¿™ä¸ªä»£ç åº“ï¼š

[](https://github.com/osmlab/fixing-polygons-in-osm/blob/master/doc/background.md?source=post_page-----ffeb15197390--------------------------------) [## fixing-polygons-in-osm/doc/background.md at master Â· osmlab/fixing-polygons-in-osm

### ä¿®å¤ OpenStreetMap ä¸­çš„ï¼ˆå¤šé‡ï¼‰å¤šè¾¹å½¢ã€‚é€šè¿‡åˆ›å»ºè´¦æˆ·ï¼Œè´¡çŒ®äº osmlab/fixing-polygons-in-osm çš„å¼€å‘â€¦

github.com](https://github.com/osmlab/fixing-polygons-in-osm/blob/master/doc/background.md?source=post_page-----ffeb15197390--------------------------------)

# QuackOSM â€” ä¸€ä¸ªä¾¿æ·çš„å·¥å…·ï¼Œç”¨äºè¯»å– OSM æ•°æ®

ä¸ºäº†ç»“æŸè¿™ç¯‡æ–‡ç« ï¼Œæˆ‘æƒ³å¼ºè°ƒä¸€ä¸ªå¯ä»¥è‡ªåŠ¨ä¸‹è½½ OSM æ•°æ®çš„åº“ï¼Œå®ƒå¯ä»¥é€šè¿‡å‡ ä½•æˆ–ä½¿ç”¨ OSM æ ‡ç­¾è¿‡æ»¤æ•°æ®ï¼Œå¹¶å°†å…¶ä¿å­˜ä¸º GeoParquet æ–‡ä»¶ï¼Œä¾¿äºé›†æˆåˆ°æ›´å¯æ‰©å±•çš„è§£å†³æ–¹æ¡ˆä¸­ã€‚è¿™ä¸ªåº“æ˜¯ç”¨ Python ç¼–å†™çš„ï¼Œå¹¶ä¸”æ˜¯å¼€æºçš„ã€‚

ä½ å¯ä»¥é€šè¿‡ä¸€æ¡å‘½ä»¤å®‰è£…å®ƒï¼š`pip install quackosm[cli]`ã€‚

æœ¬æ•™ç¨‹åŒ…å«äº† QuackOSM ğŸ¦† ä½¿ç”¨çš„æŸ¥è¯¢çš„ç®€åŒ–ç‰ˆæœ¬ï¼Œä½†è¿™äº›æŸ¥è¯¢åœ¨æ›´å¤§åŒºåŸŸä¸­å¹¶ä¸é€‚ç”¨ã€‚è¯¥åº“å¯ä»¥è½»æ¾è§£æåƒæ³•å›½è¿™æ ·çš„æ•´ä¸ªå›½å®¶æ•°æ®ï¼Œå³ä¾¿åœ¨æ¶ˆè´¹è€…çº§çš„ PC ä¸Šä¹Ÿèƒ½è¿è¡Œã€‚å¦‚æœéœ€è¦ï¼Œä½ å½“ç„¶å¯ä»¥ä½¿ç”¨ `SPATIAL` æ‰©å±•åœ¨å¤„ç†åçš„ GeoParquet æ–‡ä»¶ä¸Šåˆ©ç”¨ DuckDB å¼•æ“ã€‚

è¿™é‡Œå®šä¹‰çš„æ‰€æœ‰æ­¥éª¤éƒ½å¯ä»¥é€šè¿‡ä¸€è¡Œä»£ç æ¥æ›¿ä»£ï¼š

```py
>>> import quackosm as qosm
>>> qosm.get_features_gdf('monaco-latest.osm.pbf')
                                                              tags                                           geometry
feature_id                                                                                                           
way/834616137                               {'highway': 'footway'}  LINESTRING (7.42133 43.72711, 7.42134 43.72710...
way/408817108    {'addr:country': 'MC', 'building': 'yes', 'nam...  POLYGON ((7.43533 43.74965, 7.43534 43.74955, ...
way/686435440                               {'highway': 'footway'}  LINESTRING (7.41381 43.73258, 7.41388 43.73266...
node/7799514898              {'name': 'Cino Bar', 'shop': 'kiosk'}                           POINT (7.42702 43.73118)
way/143214794                                  {'building': 'yes'}  POLYGON ((7.42788 43.74437, 7.42786 43.74437, ...
...                                                            ...                                                ...
way/161882794    {'highway': 'secondary', 'lanes': '2', 'lit': ...  LINESTRING (7.42142 43.73656, 7.42147 43.73662...
way/1082330089             {'highway': 'steps', 'incline': 'down'}  LINESTRING (7.42438 43.72990, 7.42440 43.72988...
way/834313093    {'highway': 'service', 'smoothness': 'intermed...  LINESTRING (7.42709 43.73256, 7.42708 43.73262...
way/94399451             {'addr:country': 'MC', 'building': 'yes'}  POLYGON ((7.41678 43.73699, 7.41661 43.73689, ...
node/2462515787  {'crossing': 'uncontrolled', 'highway': 'cross...                           POINT (7.41656 43.73208)

[7940 rows x 2 columns]
>>> qosm.convert_pbf_to_gpq('monaco-latest.osm.pbf')
PosixPath('files/monaco-latest_nofilter_noclip_compact.geoparquet')
```

[](https://github.com/kraina-ai/quackosm?source=post_page-----ffeb15197390--------------------------------) [## GitHub - kraina-ai/quackosm: QuackOSM: an open-source Python and CLI tool for reading OpenStreetMapâ€¦

### QuackOSMï¼šä¸€ä¸ªä½¿ç”¨ DuckDB è¯»å– OpenStreetMap PBF æ–‡ä»¶çš„å¼€æº Python å’Œ CLI å·¥å…· - kraina-ai/quackosm

github.com](https://github.com/kraina-ai/quackosm?source=post_page-----ffeb15197390--------------------------------)

## å…è´£å£°æ˜

æˆ‘æ˜¯`QuackOSM`åº“çš„ä½œè€…ã€‚

> ä½ å¯ä»¥é€šè¿‡è¿™é‡Œè”ç³»æˆ‘ï¼š
> 
> [https://www.linkedin.com/in/raczyckikamil/](https://www.linkedin.com/in/raczyckikamil/)
> 
> [https://github.com/raczeq](https://github.com/raczeq)
