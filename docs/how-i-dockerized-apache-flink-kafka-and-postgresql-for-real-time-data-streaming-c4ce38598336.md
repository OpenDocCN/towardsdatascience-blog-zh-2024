# å¦‚ä½•å°† Apache Flinkã€Kafka å’Œ PostgreSQL Docker åŒ–ï¼Œå®ç°å®æ—¶æ•°æ®æµå¤„ç†

> åŸæ–‡ï¼š[https://towardsdatascience.com/how-i-dockerized-apache-flink-kafka-and-postgresql-for-real-time-data-streaming-c4ce38598336?source=collection_archive---------1-----------------------#2024-06-19](https://towardsdatascience.com/how-i-dockerized-apache-flink-kafka-and-postgresql-for-real-time-data-streaming-c4ce38598336?source=collection_archive---------1-----------------------#2024-06-19)

## ä½¿ç”¨ Docker é›†æˆ pyFlinkã€Kafka å’Œ PostgreSQL

[](https://adenevreze.medium.com/?source=post_page---byline--c4ce38598336--------------------------------)[![Augusto de NevrezÃ©](../Images/bd7d6509149ddb447dd7e5af9f09e4b1.png)](https://adenevreze.medium.com/?source=post_page---byline--c4ce38598336--------------------------------)[](https://towardsdatascience.com/?source=post_page---byline--c4ce38598336--------------------------------)[![Towards Data Science](../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png)](https://towardsdatascience.com/?source=post_page---byline--c4ce38598336--------------------------------) [Augusto de NevrezÃ©](https://adenevreze.medium.com/?source=post_page---byline--c4ce38598336--------------------------------)

Â·å‘è¡¨äº [Towards Data Science](https://towardsdatascience.com/?source=post_page---byline--c4ce38598336--------------------------------) Â·é˜…è¯»æ—¶é—´ï¼š10åˆ†é’ŸÂ·2024å¹´6æœˆ19æ—¥

--

![](../Images/11d218990f84e7153933c512352bd704.png)

ä½¿ç”¨ Docker å‡†å¤‡ä½ çš„ pyFlink åº”ç”¨ç¨‹åº â€” ä½œè€…ä½¿ç”¨ [https://www.dall-efree.com/](https://www.dall-efree.com/) ç”Ÿæˆçš„å›¾ç‰‡

# ä¸ºä»€ä¹ˆè¦é˜…è¯»è¿™ç¯‡æ–‡ç« ï¼Ÿ

+   **çœŸå®ä¸–ç•Œçš„æ´å¯Ÿ**ï¼šä»æˆ‘ä¸ªäººå…‹æœé›†æˆéš¾é¢˜çš„ç»å†ä¸­è·å–å®ç”¨çš„å»ºè®®ã€‚

+   **å®Œæ•´è®¾ç½®**ï¼šå­¦ä¹ å¦‚ä½•ä½¿ç”¨ Docker-Compose æ— ç¼é›†æˆ Flinkã€Kafka å’Œ PostgreSQLã€‚

+   **é€æ­¥æŒ‡å—**ï¼šéå¸¸é€‚åˆåˆå­¦è€…å’Œæœ‰ç»éªŒçš„å¼€å‘è€…ï¼Œå¸®åŠ©ä½ ç®€åŒ–æ•°æ®æµå¤„ç†æ¶æ„ã€‚

# è®¾ç½®åœºæ™¯

æˆ‘å¼€å§‹äº†ä¸€ä¸ªä»»åŠ¡ï¼Œæ—¨åœ¨ä½¿ç”¨ Docker é›†æˆ Apache Flinkã€Kafka å’Œ PostgreSQLã€‚è¿™é¡¹å·¥ä½œå°¤å…¶ä»¤äººå…´å¥‹ï¼Œå› ä¸ºæˆ‘ä½¿ç”¨äº† pyFlink â€”â€” Flink çš„ Python ç‰ˆæœ¬ â€”â€” å®ƒæ—¢å¼ºå¤§åˆç›¸å¯¹ç½•è§ã€‚è¿™ä¸ªè®¾ç½®çš„ç›®æ ‡æ˜¯é«˜æ•ˆåœ°å¤„ç†å’Œå­˜å‚¨å®æ—¶æ•°æ®ã€‚åœ¨æ¥ä¸‹æ¥çš„éƒ¨åˆ†ï¼Œæˆ‘å°†å±•ç¤ºæˆ‘æ˜¯å¦‚ä½•å®ç°è¿™ä¸€ç›®æ ‡çš„ï¼Œè®¨è®ºæˆ‘é‡åˆ°çš„æŒ‘æˆ˜ä»¥åŠå¦‚ä½•å…‹æœå®ƒä»¬ã€‚æœ€åï¼Œæˆ‘å°†æä¾›ä¸€ä¸ªé€æ­¥æŒ‡å—ï¼Œå¸®åŠ©ä½ è‡ªå·±æ­å»ºå¹¶å®éªŒè¿™ä¸ªæ•°æ®æµç®¡é“ã€‚  

æˆ‘ä»¬å°†è¦æ„å»ºçš„åŸºç¡€è®¾æ–½å¦‚ä¸‹æ‰€ç¤ºã€‚ä»å¤–éƒ¨æ¥çœ‹ï¼Œæœ‰ä¸€ä¸ªå‘å¸ƒè€…æ¨¡å—ï¼Œç”¨äºæ¨¡æ‹Ÿç‰©è”ç½‘ä¼ æ„Ÿå™¨æ¶ˆæ¯ï¼Œç±»ä¼¼äº[ä¹‹å‰çš„æ–‡ç« ](https://medium.com/dev-genius/detecting-iot-alerts-with-apache-flink-7a2be19ad9dd)ä¸­è®¨è®ºçš„å†…å®¹ã€‚åœ¨ Docker å®¹å™¨å†…éƒ¨ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸¤ä¸ª Kafka ä¸»é¢˜ã€‚ç¬¬ä¸€ä¸ªä¸»é¢˜ *sensors* ç”¨äºå®æ—¶å­˜å‚¨æ¥è‡ªç‰©è”ç½‘è®¾å¤‡çš„æ¶ˆæ¯ã€‚Flink åº”ç”¨ç¨‹åºå°†ä»è¯¥ä¸»é¢˜æ¶ˆè´¹æ¶ˆæ¯ï¼Œè¿‡æ»¤å‡ºæ¸©åº¦é«˜äº30Â°Cçš„æ¶ˆæ¯ï¼Œå¹¶å°†å…¶å‘å¸ƒåˆ°ç¬¬äºŒä¸ªä¸»é¢˜ *alerts*ã€‚æ­¤å¤–ï¼ŒFlink åº”ç”¨ç¨‹åºè¿˜å°†æŠŠæ¶ˆè´¹çš„æ¶ˆæ¯æ’å…¥åˆ°ä¸“é—¨ä¸ºæ­¤ç›®çš„åˆ›å»ºçš„ PostgreSQL è¡¨ä¸­ã€‚è¿™ä¸ªè®¾ç½®ä½¿æˆ‘ä»¬èƒ½å¤Ÿä»¥ç»“æ„åŒ–çš„è¡¨æ ¼æ ¼å¼æŒä¹…åŒ–ä¼ æ„Ÿå™¨æ•°æ®ï¼Œæä¾›è¿›ä¸€æ­¥è½¬åŒ–å’Œåˆ†æçš„æœºä¼šã€‚åƒ Tableau æˆ– Power BI è¿™æ ·çš„å¯è§†åŒ–å·¥å…·å¯ä»¥è¿æ¥åˆ°è¿™äº›æ•°æ®ï¼Œç”¨äºå®æ—¶ç»˜å›¾å’Œä»ªè¡¨ç›˜å±•ç¤ºã€‚

æ­¤å¤–ï¼Œalerts ä¸»é¢˜å¯ä»¥è¢«å…¶ä»–å®¢æˆ·ç«¯æ¶ˆè´¹ï¼Œä»¥æ ¹æ®å…¶åŒ…å«çš„æ¶ˆæ¯å¯åŠ¨ç›¸åº”çš„åŠ¨ä½œï¼Œä¾‹å¦‚å¯ç”¨ç©ºè°ƒç³»ç»Ÿæˆ–è§¦å‘æ¶ˆé˜²å®‰å…¨åè®®ã€‚

![](../Images/a1ad055bc5105bf1c170c1d526b9702c.png)

docker å®¹å™¨ä¸­åŒ…å«çš„æœåŠ¡ â€”â€” å›¾ç‰‡ç”±ä½œè€…æä¾›

ä¸ºäº†è·Ÿéšæœ¬æ•™ç¨‹ï¼Œä½ å¯ä»¥å…‹éš†ä»¥ä¸‹[ä»“åº“](https://github.com/augustodn/pyflink-docker)ã€‚é¡¹ç›®æ ¹ç›®å½•ä¸­åŒ…å«ä¸€ä¸ª docker-compose.yml æ–‡ä»¶ï¼Œä¾¿äºä½ åˆå§‹åŒ–å¤šå®¹å™¨åº”ç”¨ç¨‹åºã€‚æ­¤å¤–ï¼Œä½ å¯ä»¥åœ¨ README æ–‡ä»¶ä¸­æ‰¾åˆ°è¯¦ç»†çš„è¯´æ˜ã€‚

## docker-compose.yml ä¸­ Kafka ç«¯å£çš„é—®é¢˜

æœ€åˆï¼Œåœ¨ä½¿ç”¨ confluentinc Kafka Docker é•œåƒæ—¶ï¼Œæˆ‘é‡åˆ°äº† Kafka ç«¯å£é…ç½®çš„é—®é¢˜ï¼Œè¿™æ˜¯è¿™ç§è®¾ç½®çš„å¸¸è§é€‰æ‹©ã€‚é€šè¿‡æ—¥å¿—å¯ä»¥æ˜æ˜¾çœ‹åˆ°è¿™ä¸ªé—®é¢˜ï¼Œçªæ˜¾å‡ºåœ¨åˆå§‹è®¾ç½®å’Œæ•…éšœæ’é™¤é˜¶æ®µï¼Œä¸åº”è¯¥ä»¥åˆ†ç¦»æ¨¡å¼ï¼ˆ-dï¼‰è¿è¡Œ docker-compose up çš„é‡è¦æ€§ã€‚

å¤±è´¥çš„åŸå› æ˜¯å†…éƒ¨å’Œå¤–éƒ¨ä¸»æœºä½¿ç”¨äº†ç›¸åŒçš„ç«¯å£ï¼Œå¯¼è‡´äº†è¿æ¥é—®é¢˜ã€‚æˆ‘é€šè¿‡å°†å†…éƒ¨ç«¯å£æ›´æ”¹ä¸º19092æ¥è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚æˆ‘å‘ç°[è¿™ç¯‡](https://www.confluent.io/blog/kafka-client-cannot-connect-to-broker-on-aws-on-docker-etc/)åšå®¢æ–‡ç« å¯¹é—®é¢˜çš„è§£é‡Šç›¸å½“æ¸…æ™°ã€‚

```py
KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:19092,PLAINTEXT_HOST://localhost:9092
```

## é…ç½® Flink ä¼šè¯æ¨¡å¼

è¦åœ¨[ä¼šè¯æ¨¡å¼](https://nightlies.apache.org/flink/flink-docs-master/docs/deployment/overview/#session-mode)ä¸‹è¿è¡Œ Flinkï¼ˆå…è®¸åœ¨ä¸€ä¸ªé›†ç¾¤ä¸­è¿è¡Œå¤šä¸ªä½œä¸šï¼‰ï¼Œæˆ‘åœ¨ docker-compose.yml æ–‡ä»¶ä¸­ä½¿ç”¨äº†ä»¥ä¸‹æŒ‡ä»¤ã€‚

## PyFlink çš„è‡ªå®šä¹‰ Docker é•œåƒ

é‰´äºé»˜è®¤çš„ Apache Flink Docker é•œåƒä¸åŒ…æ‹¬ Python æ”¯æŒï¼Œæˆ‘ä¸º pyFlink åˆ›å»ºäº†ä¸€ä¸ª[è‡ªå®šä¹‰ Docker é•œåƒ](https://nightlies.apache.org/flink/flink-docs-master/docs/deployment/resource-providers/standalone/docker/#using-flink-python-on-docker)ã€‚è¿™ä¸ªè‡ªå®šä¹‰é•œåƒç¡®ä¿ Flink å¯ä»¥è¿è¡Œ Python ä½œä¸šï¼Œå¹¶åŒ…å«ä¸ Kafka å’Œ PostgreSQL é›†æˆæ‰€éœ€çš„ä¾èµ–é¡¹ã€‚ç”¨äºåˆ›å»ºæ­¤é•œåƒçš„ Dockerfile ä½äº pyflink å­ç›®å½•ä¸­ã€‚

1.  **åŸºç¡€é•œåƒ**ï¼šæˆ‘ä»¬ä»å®˜æ–¹ Flink é•œåƒå¼€å§‹ã€‚

1.  **Python å®‰è£…**ï¼šå®‰è£…äº† Python å’Œ pipï¼Œå¹¶å°† pip å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬ã€‚

1.  **ä¾èµ–ç®¡ç†**ï¼šé€šè¿‡ requirements.txt å®‰è£…ä¾èµ–é¡¹ã€‚æˆ–è€…ï¼Œå¯ä»¥å°†æŸäº›è¡Œæ³¨é‡Šæ‰ï¼Œæ¼”ç¤ºå¦‚ä½•ä»æœ¬åœ°æ–‡ä»¶æ‰‹åŠ¨å®‰è£…ä¾èµ–é¡¹ï¼Œè¿™å¯¹äºåœ¨æ²¡æœ‰äº’è”ç½‘è®¿é—®çš„ç¯å¢ƒä¸­éƒ¨ç½²å¾ˆæœ‰ç”¨ã€‚

1.  **è¿æ¥å™¨åº“**ï¼šKafka å’Œ PostgreSQL çš„è¿æ¥å™¨ä¼šç›´æ¥ä¸‹è½½åˆ° Flink çš„ lib ç›®å½•ä¸­ã€‚è¿™ä½¿å¾— Flink åœ¨ä½œä¸šæ‰§è¡Œè¿‡ç¨‹ä¸­èƒ½å¤Ÿä¸ Kafka å’Œ PostgreSQL è¿›è¡Œäº¤äº’ã€‚

1.  **è„šæœ¬å¤åˆ¶**ï¼šä»ä»£ç åº“ä¸­çš„è„šæœ¬ä¼šå¤åˆ¶åˆ° /opt/flink ç›®å½•ï¼Œç”± Flink ä»»åŠ¡ç®¡ç†å™¨æ‰§è¡Œã€‚

ä½¿ç”¨è¿™ä¸ªè‡ªå®šä¹‰ Docker é•œåƒï¼Œæˆ‘ä»¬ç¡®ä¿ pyFlink å¯ä»¥åœ¨ Docker å®¹å™¨ä¸­æ­£å¸¸è¿è¡Œï¼Œå¹¶é…å¤‡äº†ä¸ Kafka å’Œ PostgreSQL æ— ç¼äº¤äº’æ‰€éœ€çš„åº“ã€‚è¿™ç§æ–¹æ³•æä¾›äº†çµæ´»æ€§ï¼Œé€‚ç”¨äºå¼€å‘å’Œç”Ÿäº§ç¯å¢ƒã€‚

**æ³¨æ„ï¼š** è¯·ç¡®ä¿æ ¹æ®æ‚¨çš„éƒ¨ç½²ç¯å¢ƒçš„æ”¿ç­–ï¼Œå¤„ç†ä¸‹è½½è¿æ¥å™¨å’Œå…¶ä»–ä¾èµ–é¡¹æ—¶çš„ç½‘ç»œæˆ–å®‰å…¨æ€§é—®é¢˜ã€‚

## é›†æˆ PostgreSQL

è¦å°† Apache Flink è¿æ¥åˆ° PostgreSQL æ•°æ®åº“ï¼Œå¿…é¡»ä½¿ç”¨é€‚å½“çš„ JDBC è¿æ¥å™¨ã€‚pyFlink çš„è‡ªå®šä¹‰ Docker é•œåƒä¼šä¸‹è½½ä¸ PostgreSQL 16 å…¼å®¹çš„ PostgreSQL JDBC è¿æ¥å™¨ã€‚

ä¸ºäº†ç®€åŒ–è¿™ä¸€è¿‡ç¨‹ï¼Œä»£ç åº“ä¸­åŒ…å«ä¸€ä¸ª download_libs.sh è„šæœ¬ï¼Œæ¨¡æ‹Ÿäº†åœ¨ Flink Docker å®¹å™¨ä¸­æ‰§è¡Œçš„æ“ä½œã€‚è¯¥è„šæœ¬è‡ªåŠ¨ä¸‹è½½æ‰€éœ€çš„åº“ï¼Œç¡®ä¿ Docker å’Œæœ¬åœ°ç¯å¢ƒä¹‹é—´çš„ä¸€è‡´æ€§ã€‚

**æ³¨æ„ï¼š** è¿æ¥å™¨é€šå¸¸æœ‰ä¸¤ä¸ªç‰ˆæœ¬ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç”±äºæˆ‘ä½¿ç”¨çš„æ˜¯æœ€æ–°çš„ç¨³å®šç‰ˆæœ¬ Flink 1.18ï¼Œæˆ‘ä¸‹è½½äº† 3.1.2â€“1.18 ç‰ˆæœ¬ã€‚æˆ‘çš„çŒœæµ‹æ˜¯ï¼Œç¬¬ä¸€ä¸ªç‰ˆæœ¬è·Ÿè¸ªäº†å¤šä¸ªæ•°æ®åº“çš„ JDBC å®ç°ã€‚å®ƒä»¬å¯ä»¥åœ¨ [maven ç›®å½•](https://mvnrepository.com/artifact/org.apache.flink/flink-connector-jdbc/3.1.2-1.18)ä¸­æ‰¾åˆ°ã€‚

```py
env.add_jars(
  f"file://{current_dir}/flink-connector-jdbc-3.1.2â€“1.18.jar",
  f"file://{current_dir}/postgresql-42.7.3.jar"
)
```

**å®šä¹‰ JDBC Sink**

åœ¨æˆ‘ä»¬çš„ Flink ä»»åŠ¡ä¸­ï¼Œæœ‰ä¸€ä¸ªè‡³å…³é‡è¦çš„å‡½æ•°ï¼Œåä¸º `configure_postgre_sink`ï¼Œä½äº `usr_jobs/postgres_sink.py` æ–‡ä»¶ä¸­ã€‚è¿™ä¸ªå‡½æ•°è´Ÿè´£é…ç½®ä¸€ä¸ªé€šç”¨çš„ PostgreSQL æ¥æ”¶å™¨ã€‚ä¸ºäº†æœ‰æ•ˆä½¿ç”¨å®ƒï¼Œä½ éœ€è¦æä¾› SQL æ•°æ®æ“ä½œè¯­è¨€ï¼ˆDMLï¼‰è¯­å¥å’Œç›¸åº”çš„å€¼ç±»å‹ã€‚ç”¨äºæµæ•°æ®çš„ç±»å‹å®šä¹‰ä¸º `TYPE_INFO`... æˆ‘èŠ±äº†äº›æ—¶é—´æ‰æ‰¾å‡ºæ­£ç¡®çš„å£°æ˜æ–¹å¼ ğŸ˜…ã€‚

è¿˜éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒJdbcSink æœ‰ä¸€ä¸ªå¯é€‰å‚æ•°ï¼Œç”¨äºå®šä¹‰ `ExecutionOptions`ã€‚åœ¨è¿™ä¸ªç‰¹å®šçš„ä¾‹å­ä¸­ï¼Œæˆ‘å°†ä½¿ç”¨ 1 ç§’çš„æ›´æ–°é—´éš”ï¼Œå¹¶å°†è¡Œæ•°é™åˆ¶ä¸º 200ã€‚ä½ å¯ä»¥åœ¨[å®˜æ–¹æ–‡æ¡£](https://nightlies.apache.org/flink/flink-docs-master/docs/connectors/datastream/jdbc/#jdbc-execution-options)ä¸­æ‰¾åˆ°æ›´å¤šä¿¡æ¯ã€‚æ˜¯çš„ï¼Œä½ çŒœå¯¹äº†ï¼Œç”±äºæˆ‘å®šä¹‰äº†ä¸€ä¸ªé—´éš”ï¼Œè¿™å¯ä»¥è§†ä¸ºä¸€ä¸ªå¾®æ‰¹æ¬¡ ETLã€‚ç„¶è€Œï¼Œç”±äº Flink çš„å¹¶è¡Œæ€§ï¼Œä½ å¯ä»¥åœ¨ä¸€ä¸ªç®€å•çš„è„šæœ¬ä¸­åŒæ—¶å¤„ç†å¤šä¸ªæ•°æ®æµï¼Œè€Œä¸”å®ƒéå¸¸æ˜“äºç†è§£ã€‚

**æ³¨æ„ï¼š** åˆ«å¿˜äº†åœ¨ Postgres ä¸­åˆ›å»º `raw_sensors_data` è¡¨ï¼Œè¿™æ˜¯æ¥æ”¶æ¥è‡ª IoT ä¼ æ„Ÿå™¨çš„åŸå§‹æ•°æ®çš„åœ°æ–¹ã€‚è¿™ä¸ªæ­¥éª¤åœ¨ä¸‹é¢çš„é€æ­¥æŒ‡å—ä¸­å·²ç»æ¶µç›–ã€‚

## å°†æ•°æ®ä¼ è¾“åˆ° Kafka

æˆ‘åœ¨[ä¹‹å‰çš„è®¨è®º](https://medium.com/dev-genius/detecting-iot-alerts-with-apache-flink-7a2be19ad9dd)ä¸­ä»‹ç»äº†å¦‚ä½•ä» Kafka ä¸»é¢˜æ¶ˆè´¹æ•°æ®ã€‚ç„¶è€Œï¼Œæˆ‘è¿˜æ²¡æœ‰é…ç½®æ¥æ”¶å™¨ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±ä¼šé…ç½®ã€‚è¿™ä¸ªé…ç½®æœ‰ä¸€äº›å¤æ‚ä¹‹å¤„ï¼Œå®ƒæ˜¯å®šä¹‰åœ¨ä¸€ä¸ªå‡½æ•°ä¸­çš„ï¼Œç±»ä¼¼äº Postgres æ¥æ”¶å™¨ã€‚æ­¤å¤–ï¼Œåœ¨å°†æ•°æ®æµä¼ è¾“åˆ° Kafka ä¹‹å‰ï¼Œä½ å¿…é¡»å®šä¹‰æ•°æ®æµçš„ç±»å‹ã€‚è¯·æ³¨æ„ï¼Œ`alarms_data` æµåœ¨ä¼ è¾“åˆ° Kafka ä¹‹å‰å·²ç»æ­£ç¡®åœ°è½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œ`output_type=Types.STRING()`ï¼Œå› ä¸ºæˆ‘å·²ç»å°†åºåˆ—åŒ–å™¨å£°æ˜ä¸º `SimpleStringSchema()`ã€‚

æ¥ä¸‹æ¥çš„æ­¥éª¤æˆ‘å°†å±•ç¤ºå¦‚ä½•ä» `alerts` ä¸»é¢˜è·å–æ•°æ®ã€‚

## æœ¬åœ°æˆ–å®¹å™¨åŒ–é…ç½®

è¿™ä¸ª Docker é…ç½®çš„ä¸€ä¸ªæœ€å¤§ä¼˜ç‚¹æ˜¯ï¼Œä½ å¯ä»¥åœ¨æœ¬åœ°æˆ–å®¹å™¨å†…éƒ¨ä»¥æ‰˜ç®¡ä»»åŠ¡çš„æ–¹å¼è¿è¡Œ Flinkã€‚ä¸‹å›¾å±•ç¤ºäº†æœ¬åœ° Flink è®¾ç½®ï¼Œä½ å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„ Flink åº”ç”¨ç¨‹åºä¸ Docker å®¹å™¨æ˜¯åˆ†ç¦»çš„ã€‚è¿™æœ‰åŠ©äºæ’æŸ¥ Flink çš„é—®é¢˜ï¼Œå› ä¸º Flink æœ¬èº«å¹¶æ²¡æœ‰å¾ˆå¥½çš„æœ¬åœ°å¯è§‚å¯Ÿå·¥å…·ã€‚å®é™…ä¸Šï¼Œæˆ‘ä»¬æƒ³å°è¯•ä¸€ä¸‹[datorios](https://datorios.com/)æä¾›çš„ Flink å·¥å…·ï¼Œå®ƒä»¬åœ¨ç›‘æ§æ–¹é¢éå¸¸æœ‰å‰æ™¯ã€‚

![](../Images/6d8993906980fe9862badc9ecdcad799.png)

åœ¨æœ¬åœ°è¿è¡Œ Flink åº”ç”¨ç¨‹åºï¼Œå¹¶ä¸”å®¹å™¨å†…éƒ¨è¿˜è¿è¡Œç€å…¶ä»–æœåŠ¡ â€” å›¾åƒæ¥è‡ªä½œè€…

å¦‚æœä½ æƒ³åœ¨æœ¬åœ°å°è¯• Flink åº”ç”¨ç¨‹åºï¼Œä½ éœ€è¦æ­£ç¡®åœ°å®šä¹‰è„šæœ¬æ‰€ä½¿ç”¨çš„ä¸»æœºå’Œç«¯å£ï¼Œè¿™å®é™…ä¸Šæ˜¯ `usr_jobs/postgres_sink.py` æ–‡ä»¶ä¸­çš„ä¸¤ä¸ªå¸¸é‡ï¼š

å®¹å™¨è¿è¡Œæ—¶ï¼Œä½¿ç”¨ï¼š

```py
KAFKA_HOST = "kafka:19092"
POSTGRES_HOST = "postgres:5432"
```

æœ¬åœ°è¿è¡Œæ—¶ï¼Œä½¿ç”¨ï¼š

```py
KAFKA_HOST = "localhost:9092"
POSTGRES_HOST = "localhost:5432"
```

é»˜è®¤æƒ…å†µä¸‹ï¼Œä»“åº“è®¾ç½®Flinkåº”ç”¨ç¨‹åºåœ¨å®¹å™¨å†…è¿è¡Œã€‚ä½ å¯ä»¥é€šè¿‡Web UIç›‘æ§æ­£åœ¨è¿è¡Œçš„ä½œä¸šï¼Œè®¿é—®[http://localhost:8081](http://localhost:8081)ã€‚å¦‚æœä½ é€‰æ‹©åœ¨æœ¬åœ°è¿è¡Œä½œä¸šï¼Œåˆ™æ— æ³•æŸ¥çœ‹ã€‚

![](../Images/add4733c451e9d50906584d638693caf.png)

æ˜¾ç¤ºFlink Web UIä¸­è¿è¡Œä½œä¸šçš„æˆªå›¾â€”â€”ä½œè€…æä¾›çš„å›¾ç‰‡

**æ³¨æ„**ï¼šå¦‚æœåœ¨æœ¬åœ°è¿è¡Œä½œä¸šï¼Œåˆ™éœ€è¦å®‰è£…ä½äºrequirements.txtä¸­çš„Flinkä¾èµ–é¡¹ã€‚å¦‚æœä½ æƒ³ä½¿ç”¨poetryè®¾ç½®ç¯å¢ƒï¼Œè¿˜æä¾›äº†ä¸€ä¸ªpyproject.tomlæ–‡ä»¶ã€‚

# åˆ†æ­¥æŒ‡å—ï¼šè¿è¡Œæµå¤„ç†ç®¡é“

## ç¬¬1æ­¥ï¼šå¯åŠ¨å¤šå®¹å™¨åº”ç”¨ç¨‹åº

é€šè¿‡è¿è¡Œdocker-composeå¯åŠ¨å®¹å™¨ã€‚æˆ‘æ›´å€¾å‘äºä¸ä½¿ç”¨åˆ†ç¦»æ¨¡å¼ï¼Œä»¥ä¾¿åœ¨å®¹å™¨å¯åŠ¨å¹¶è¿è¡Œæ—¶æŸ¥çœ‹æ—¥å¿—ã€‚

```py
docker-compose up
```

æ£€æŸ¥æ—¥å¿—ä»¥æŸ¥çœ‹æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œã€‚

## ç¬¬2æ­¥ï¼šåˆ›å»ºKafkaä¸»é¢˜

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸»é¢˜ä»¥æ¥æ”¶æ¥è‡ªIoTä¼ æ„Ÿå™¨çš„æ•°æ®ï¼Œå¹¶å­˜å‚¨Flinkåº”ç”¨ç¨‹åºè¿‡æ»¤åçš„è­¦æŠ¥ã€‚

```py
docker-compose exec kafka kafka-topics \
 -- create - topic sensors \
 -- bootstrap-server localhost:9092 \
 -- partitions 1 \
 -- replication-factor 1

docker-compose exec kafka kafka-topics \
 -- create - topic alerts \
 -- bootstrap-server localhost:9092 \
 -- partitions 1 \
 -- replication-factor 1
```

è¦æ£€æŸ¥ä¸»é¢˜æ˜¯å¦æ­£ç¡®åˆ›å»ºï¼Œå¯ä»¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤

```py
docker-compose exec kafka kafka-topics \
 -- bootstrap-server localhost:9092 \
 -- list
```

## ç¬¬3æ­¥ï¼šåˆ›å»ºPostgresè¡¨

ç™»å½•åˆ°Postgresæ§åˆ¶å°

```py
psql -h localhost -U flinkuser -d flinkdb
```

è¾“å…¥å¯†ç flinkpasswordç™»å½•åˆ°Postgresæ§åˆ¶å°ï¼Œè¯·è®°ä½è¿™æ˜¯æœ¬åœ°é…ç½®ï¼Œå› æ­¤é»˜è®¤è®¿é—®æƒé™å·²åœ¨docker-compose.ymlä¸­é…ç½®ã€‚ç„¶ååˆ›å»ºè¡¨æ ¼

```py
CREATE TABLE raw_sensors_data (
message_id VARCHAR(255) PRIMARY KEY,
sensor_id INT NOT NULL,
message TEXT NOT NULL,
timestamp TIMESTAMPTZ NOT NULL
);
```

ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ£€æŸ¥è¡¨æ˜¯å¦æ­£ç¡®åˆ›å»º

```py
flinkdb=# \d raw_sensors_data
```

è¿™å°†æ˜¾ç¤ºç±»ä¼¼ä»¥ä¸‹çš„ç»“æœï¼š

![](../Images/d60419e34e6e3d6595fb7dabb57d16ff.png)

## ç¬¬4æ­¥ï¼šå¯åŠ¨Kafkaç”Ÿäº§è€…

ä½¿ç”¨condaæˆ–poetryåˆ›å»ºä¸€ä¸ªæœ¬åœ°ç¯å¢ƒå¹¶å®‰è£…python kafkaåŒ…ï¼š

```py
pip install kafka-python
```

ç„¶åæ‰§è¡ŒKafkaç”Ÿäº§è€…ï¼Œå®ƒæ¨¡æ‹ŸIoTä¼ æ„Ÿå™¨æ¶ˆæ¯å¹¶å°†æ¶ˆæ¯å‘å¸ƒåˆ°ä¼ æ„Ÿå™¨ä¸»é¢˜ã€‚

```py
python pyflink/usr_jobs/kafka_producer.py
```

è®©å®ƒåœ¨æ¥ä¸‹æ¥çš„æ•™ç¨‹ä¸­ä¸€ç›´è¿è¡Œã€‚

## ç¬¬5æ­¥ï¼šåˆå§‹åŒ–Flinkä»»åŠ¡

æˆ‘ä»¬å°†ä»å®¹å™¨å†…å¯åŠ¨Flinkåº”ç”¨ç¨‹åºï¼Œå› æ­¤ä½ å¯ä»¥é€šè¿‡Web UIé€šè¿‡localhost:8081ç›‘æ§å®ƒã€‚ä»ä»“åº“æ ¹ç›®å½•è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```py
docker-compose exec flink-jobmanager flink run \
  -py /opt/flink/usr_jobs/postgres_sink.py
```

ä½ å°†çœ‹åˆ°ä¸€äº›æ—¥å¿—ä¿¡æ¯ï¼Œæ­¤å¤–ï¼Œè­¦æŠ¥ä¹Ÿä¼šæ˜¾ç¤ºåœ¨flink-jobmanagerå®¹å™¨çš„æ—¥å¿—ä¸­ã€‚åŒæ—¶ï¼Œä½ å¯ä»¥ä»Flink Web UI [http://localhost:8081/#/job/running](http://localhost:8081/#/job/running)æ£€æŸ¥ä½œä¸šæ˜¯å¦æ­£åœ¨è¿è¡Œã€‚

![](../Images/61e46067d510dfa78e078de834b3ad0a.png)

è¿è¡Œä½œä¸šçš„è¯¦ç»†ä¿¡æ¯â€”â€”ä½œè€…æä¾›çš„å›¾ç‰‡

æ˜¾ç„¶ï¼Œç›‘æ§æ˜¾ç¤ºFlinkä½œä¸šä¸­æ²¡æœ‰æ¶ˆæ¯æµåŠ¨ï¼Œä½†è¿™ä¸æ˜¯çœŸçš„ï¼Œå› ä¸ºå¯ä»¥åœ¨dockeræ—¥å¿—ä¸­çœ‹åˆ°è­¦æŠ¥ã€‚

![](../Images/a76525be2f6b2ec01ef7e1d6d89b2518.png)

æˆ‘ä»¬å°†é€šè¿‡Postgresè¡¨æ£€æŸ¥æ¶ˆæ¯ï¼Œå¹¶è¯»å–ä¸ºæ­¤ç›®çš„åˆ›å»ºçš„è­¦æŠ¥ä¸»é¢˜ã€‚

## ç¬¬6æ­¥ï¼šè¯»å–Kafkaä¸»é¢˜ä¸­çš„è­¦æŠ¥

è¦è¯»å–è­¦æŠ¥ä¸»é¢˜ä¸­çš„æ•°æ®ï¼Œå¯ä»¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```py
docker-compose exec kafka kafka-console-consumer \
  -- bootstrap-server localhost:9092 \
  -- topic alerts \
  -- from-beginning
```

è¿™å°†å±•ç¤ºåˆ°ç›®å‰ä¸ºæ­¢è¯¥ä¸»é¢˜æ¥æ”¶åˆ°çš„æ‰€æœ‰æ¶ˆæ¯ã€‚

## ç¬¬7æ­¥ï¼šä»Postgresè¡¨è¯»å–åŸå§‹æ•°æ®

æ­¤å¤–ï¼Œä½ è¿˜å¯ä»¥æŸ¥è¯¢ IoT ä¼ æ„Ÿå™¨çš„åŸå§‹æ¶ˆæ¯ï¼Œç”šè‡³åœ¨ PostgreSQL ä¸­è§£æ JSON æ•°æ®ï¼š

```py
SELECT
  *,
  (message::json->>'temperature')::numeric as temperature
FROM raw_sensors_data
LIMIT 10;
```

## ç¬¬ 8 æ­¥ï¼šåœæ­¢æœåŠ¡

ä½ å¯ä»¥é€šè¿‡åœ¨ Docker ç»ˆç«¯æŒ‰ Ctrl-c æ¥è½»æ¾åœæ­¢æ‰€æœ‰æœåŠ¡ã€‚å¦‚æœä½ æ›´å€¾å‘äºæ­£ç¡®åœ°å…³é—­æœåŠ¡ï¼Œå¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è¿›è¡Œæ“ä½œï¼š

1.  åœ¨ Web UI çš„ä½œä¸šè¯¦æƒ…é¡µå³ä¸Šè§’ç‚¹å‡»ä»¥å–æ¶ˆ Flink ä½œä¸šã€‚

1.  åœæ­¢æœ¬åœ°è¿è¡Œçš„ kafka_producer.py è„šæœ¬ã€‚

1.  åœ¨ Docker ç»ˆç«¯æŒ‰ Ctrl-c åœæ­¢æœåŠ¡

ä¼šè¯ä¸­äº¤æ¢çš„ä¿¡æ¯ï¼Œåœ¨æœåŠ¡è¿è¡ŒæœŸé—´ä¼šè¢«æ°¸ä¹…å­˜å‚¨ã€‚å› æ­¤ï¼Œå¦‚æœä½ æƒ³æŸ¥è¯¢ Postgres è¡¨æˆ– Kafka ä¸»é¢˜ï¼Œæ•°æ®å°†ä¼šåœ¨å…¶ä¸­ã€‚

# ä½¿ç”¨å¤šä¸ª Sink åœ¨ PyFlink ä½œä¸šä¸­çš„è§è§£

åœ¨ç”¨äºæ¼”ç¤ºçš„ Flink ä½œä¸šä¸­ï¼Œæˆ‘åŒæ—¶ç®¡ç† 2 ä¸ªæ•°æ®æµï¼Œå®ƒä»¬åœ¨åŒä¸€ä¸ªä»»åŠ¡ä¸­è¿è¡Œã€‚ä¸€ä¸ªæ˜¯å†™å…¥æ¥è‡ªä¼ æ„Ÿå™¨ä¸»é¢˜ï¼ˆIoT è®¾å¤‡ï¼‰çš„åŸå§‹æ•°æ®ï¼Œå¦ä¸€ä¸ªæ˜¯è¿‡æ»¤åçš„è­¦æŠ¥æ•°æ®ï¼Œå†™å…¥å¦ä¸€ä¸ªä¸»é¢˜ã€‚è¿™ç§æ–¹å¼æœ‰ä¸€äº›ä¼˜ç‚¹å’Œç¼ºç‚¹ï¼Œç®€å•æ€»ç»“å¦‚ä¸‹ï¼š

**å•ä¸€ä½œä¸šä½¿ç”¨å¤šä¸ª Sink çš„ä¼˜ç‚¹ï¼š**

- èµ„æºç®¡ç†çš„ç®€ä¾¿æ€§ã€‚

- æ•°æ®æµçš„ä¸€è‡´æ€§ã€‚

**å•ä¸€ä½œä¸šçš„ç¼ºç‚¹ï¼š**

- éšç€é€»è¾‘çš„å¢é•¿ï¼Œå¯èƒ½å˜å¾—å¤æ‚ã€‚

- å¯æ‰©å±•æ€§å¯èƒ½æ˜¯ä¸ªé—®é¢˜ã€‚

**å¤šä¸ªä½œä¸šçš„ä¼˜ç‚¹ï¼š**

- æ›´å¥½çš„æ•…éšœéš”ç¦»ã€‚

- èšç„¦ä¼˜åŒ–ã€‚

**å¤šä¸ªä½œä¸šçš„ç¼ºç‚¹ï¼š**

- èµ„æºå¼€é”€ã€‚

- åè°ƒå¤æ‚æ€§ã€‚

# ç»“è®º

è¯¥è®¾ç½®ä¸ºå®æ—¶æ•°æ®æµå’Œå¤„ç†æä¾›äº†ä¸€ä¸ªå¼ºå¤§çš„è§£å†³æ–¹æ¡ˆï¼Œæœ‰æ•ˆåœ°é›†æˆäº† Flinkã€Kafka å’Œ PostgreSQLã€‚ä½¿ç”¨ Postgres çš„ä¸»è¦ç›®çš„æ˜¯æ£€æŸ¥æ¥è‡ª IoT è®¾å¤‡çš„åŸå§‹æ¶ˆæ¯ï¼Œè€Œä¸æ˜¯ä¾èµ–äºç›´æ¥æŸ¥è¯¢ä¸»é¢˜æœ¬èº«ã€‚å®ƒè¿˜å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ JDBC è¿æ¥å™¨è¿›è¡Œæ•°æ®è¾“å‡ºï¼Œè¿™å¯èƒ½æ˜¯ä¸€ä¸ªç›¸å¯¹æ ‡å‡†çš„åšæ³•ã€‚æ¶ˆæ¯è½¬æ¢é€šè¿‡ DataStream API å®Œæˆã€‚æˆ‘å¸Œæœ›è¿›ä¸€æ­¥æ·±å…¥å­¦ä¹  SQL APIï¼Œå®ƒæä¾›äº†ä¸€ä¸ªæ›´åŠ å‹å¥½çš„æ¥å£ã€‚æœ€åï¼Œå…³äºå¦‚ä½•ç®¡ç†æ•°æ®æµï¼Œå»ºè®®æ ¹æ®å…·ä½“éœ€æ±‚é€‰æ‹©å•ä¸€ä½œä¸šæˆ–å¤šä¸ªä½œä¸šï¼Œç¡®ä¿å¯æ‰©å±•æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

# ä¸‹ä¸€æ­¥

1\. ä½¿ç”¨ SQL API è¿›è¡Œæ•°æ®è½¬æ¢ã€‚

2\. æ ¹æ®ä½œä¸šå¤æ‚æ€§ä¼˜åŒ–èµ„æºä½¿ç”¨ã€‚

3\. æ¢ç´¢ Flink çš„é«˜çº§åŠŸèƒ½ä»¥åº”å¯¹å¤æ‚çš„æ•°æ®å¤„ç†ä»»åŠ¡ã€‚

å¿«ä¹æµå¼å¤„ç†ï¼ğŸš€

**æ•¬è¯·æœŸå¾…æ›´å¤šå…³äºå¦‚ä½•é€šè¿‡ Docker é›†æˆå’Œæ‰©å±•æ•°æ®å·¥ç¨‹è§£å†³æ–¹æ¡ˆçš„æ•™ç¨‹ï¼**

*å¦‚æœ‰ä»»ä½•é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·éšæ—¶åœ¨ä¸‹æ–¹è¯„è®ºåŒºä¸æˆ‘ä»¬è”ç³»ï¼*

# å‡†å¤‡å¥½ä¼˜åŒ–ä½ çš„æµæ•°æ®åº”ç”¨äº†å—ï¼Ÿ

è§£é”æ•°æ®çš„å…¨éƒ¨æ½œåŠ›ï¼Œä½¿ç”¨æˆ‘ä»¬çš„[ä¸“å®¶å’¨è¯¢æœåŠ¡](https://www.squadralabs.com)ï¼Œä¸ºæµæ•°æ®åº”ç”¨é‡èº«å®šåˆ¶ã€‚æ— è®ºä½ æ˜¯æƒ³å¢å¼ºå®æ—¶åˆ†æã€ä¼˜åŒ–æ•°æ®ç®¡é“ï¼Œè¿˜æ˜¯æå‡æ€§èƒ½ï¼Œæˆ‘ä»¬éƒ½èƒ½ä¸ºä½ æä¾›å¸®åŠ©ã€‚

# å‚è€ƒèµ„æ–™

[https://www.confluent.io/blog/kafka-client-cannot-connect-to-broker-on-aws-on-docker-etc/](https://www.confluent.io/blog/kafka-client-cannot-connect-to-broker-on-aws-on-docker-etc/)

[https://mvnrepository.com/](https://mvnrepository.com/)

[https://nightlies.apache.org/flink/flink-docs-master/docs/connectors/datastream/jdbc/](https://nightlies.apache.org/flink/flink-docs-master/docs/connectors/datastream/jdbc/)

[https://nightlies.apache.org/flink/flink-docs-master/docs/deployment/overview/#session-mode](https://nightlies.apache.org/flink/flink-docs-master/docs/deployment/overview/#session-mode)

[https://nightlies.apache.org/flink/flink-docs-master/docs/deployment/resource-providers/standalone/docker/#using-flink-python-on-docker](https://nightlies.apache.org/flink/flink-docs-master/docs/deployment/resource-providers/standalone/docker/#using-flink-python-on-docker)

[https://medium.com/@sant1/flink-docker-kafka-faee9c0f1580](https://medium.com/@sant1/flink-docker-kafka-faee9c0f1580)
