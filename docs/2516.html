<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Dataflow architecture</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Dataflow architecture</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/dataflow-architecture-derived-data-views-and-eventual-consistency-e3bc25176cf8?source=collection_archive---------1-----------------------#2024-10-15">https://towardsdatascience.com/dataflow-architecture-derived-data-views-and-eventual-consistency-e3bc25176cf8?source=collection_archive---------1-----------------------#2024-10-15</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><h2 id="c804" class="fo fp fq bf b dy fr fs ft fu fv fw dx fx" aria-label="kicker paragraph">a (not-so) brief history of a health &amp; fitness data pipeline: part ii</h2><div/><div><h2 id="245b" class="pw-subtitle-paragraph gs fz fq bf b gt gu gv gw gx gy gz ha hb hc hd he hf hg hh cq dx">on derived data views and eventual consistency</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hi hj hk hl hm ab"><div><div class="ab hn"><div><div class="bm" aria-hidden="false"><a href="https://caleb-llh.medium.com/?source=post_page---byline--e3bc25176cf8--------------------------------" rel="noopener follow"><div class="l ho hp by hq hr"><div class="l ed"><img alt="CALEB" class="l ep by dd de cx" src="../Images/c0f24b30f8dd69352f59b1f7b8124a8c.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/1*sqr3ZbOyQU2ZCvvbuY08ew@2x.jpeg"/><div class="hs by l dd de em n ht eo"/></div></div></a></div></div><div class="hu ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--e3bc25176cf8--------------------------------" rel="noopener follow"><div class="l hv hw by hq hx"><div class="l ed"><img alt="Towards Data Science" class="l ep by br hy cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hs by l br hy em n ht eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hz ab q"><div class="ab q ia"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b ib ic bk"><a class="af ag ah ai aj ak al am an ao ap aq ar id" data-testid="authorName" href="https://caleb-llh.medium.com/?source=post_page---byline--e3bc25176cf8--------------------------------" rel="noopener follow">CALEB</a></p></div></div></div><span class="ie if" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b ib ic dx"><button class="ig ih ah ai aj ak al am an ao ap aq ar ii ij ik" disabled="">Follow</button></p></div></div></span></div></div><div class="l il"><span class="bf b bg z dx"><div class="ab cn im in io"><div class="ip iq ab"><div class="bf b bg z dx ab ir"><span class="is l il">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar id ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--e3bc25176cf8--------------------------------" rel="noopener follow"><p class="bf b bg z it iu iv iw ix iy iz ja bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="ie if" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">19 min read</span><div class="jb jc l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Oct 15, 2024</span></div></span></div></span></div></div></div><div class="ab cp jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js"><div class="h k w ea eb q"><div class="ki l"><div class="ab q kj kk"><div class="pw-multi-vote-icon ed is kl km kn"><div class=""><div class="ko kp kq kr ks kt ku am kv kw kx kn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l ky kz la lb lc ld le"><p class="bf b dy z dx"><span class="kp">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao ko lh li ab q ee lj lk" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="lg"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg><p class="bf b dy z dx"><span class="pw-responses-count lf lg">1</span></p></button></div></div></div><div class="ab q jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh"><div class="ll k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lm an ao ap ii ln lo lp" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep lq cn"><div class="l ae"><div class="ab cb"><div class="lr ls lt lu lv lw ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lm an ao ap ii lx ly lk lz ma mb mc md s me mf mg mh mi mj mk u ml mm mn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lm an ao ap ii lx ly lk lz ma mb mc md s me mf mg mh mi mj mk u ml mm mn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lm an ao ap ii lx ly lk lz ma mb mc md s me mf mg mh mi mj mk u ml mm mn"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><p id="b71b" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk"><em class="nk">Welcome to </em><strong class="mq ga"><em class="nk">part ii</em></strong><em class="nk"> of our coming-of-age trilogy on a public health and fitness data pipeline.</em></p><p id="5c24" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk"><em class="nk">In this chapter, we reimagine the backend system as a distributed state machine and explore the art of achieving consistency — with a functional flavour.</em></p></div></div></div><div class="ab cb nl nm nn no" role="separator"><span class="np by bm nq nr ns"/><span class="np by bm nq nr ns"/><span class="np by bm nq nr"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><h1 id="bb1d" class="nt nu fq bf nv nw nx gv ny nz oa gy ob oc od oe of og oh oi oj ok ol om on oo bk">A quick recap of part i</h1><div class="op oq or os ot ou"><a href="https://medium.com/siot-govtech/a-not-so-brief-history-of-a-health-fitness-data-pipeline-part-i-event-driven-architecture-79d2fa8ce189?source=post_page-----e3bc25176cf8--------------------------------" rel="noopener follow" target="_blank"><div class="ov ab il"><div class="ow ab co cb ox oy"><h2 class="bf ga ib z it oz iv iw pa iy ja fz bk">Event-driven Architecture — Evolution from Servers to Brokers to Queues</h2><div class="pb l"><h3 class="bf b ib z it oz iv iw pa iy ja dx">a (not-so) brief history of a health &amp; fitness data pipeline: part i</h3></div><div class="gq l"><p class="bf b dy z it oz iv iw pa iy ja dx">medium.com</p></div></div><div class="pc l"><div class="pd l pe pf pg pc ph lw ou"/></div></div></a></div><h2 id="205f" class="pi nu fq bf nv pj pk pl ny pm pn po ob mx pp pq pr nb ps pt pu nf pv pw px fw bk"><em class="py">The evolution of a data pipeline</em></h2><p id="fead" class="pw-post-body-paragraph mo mp fq mq b gt pz ms mt gw qa mv mw mx qb mz na nb qc nd ne nf qd nh ni nj fj bk">In <a class="af qe" href="https://medium.com/siot-govtech/a-not-so-brief-history-of-a-health-fitness-data-pipeline-part-i-event-driven-architecture-79d2fa8ce189" rel="noopener">part I</a>, we watched<em class="nk"> </em><a class="af qe" href="https://youtu.be/nVVD97pMRiI" rel="noopener ugc nofollow" target="_blank"><em class="nk">SmartGym</em></a> grow into (version 2.1), an integrated health and fitness platform that <strong class="mq ga">streams</strong>, <strong class="mq ga">processes</strong>, and <strong class="mq ga">saves</strong> data from a range of gym equipment sensors and medical devices. These data provided insights that empowered users to take more active ownership of their personal health and fitness.</p><figure class="qi qj qk ql qm qn qf qg paragraph-image"><div class="qf qg qh"><img src="../Images/8d5ff76a69924bde9c62e30669808c3b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1248/format:webp/1*JCp25aVUGfFizX2POvHuJA.gif"/></div><figcaption class="qp qq qr qf qg qs qt bf b bg z dx">SmartGym shoulder press</figcaption></figure><p id="499b" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">As our system evolved from merely saving and retrieving data to responding to a real-world events, our architecture had to reflect this paradigm shift — from a <em class="nk">request-driven</em> to an <em class="nk">event-driven</em> one.</p><h2 id="25cb" class="pi nu fq bf nv pj pk pl ny pm pn po ob mx pp pq pr nb ps pt pu nf pv pw px fw bk">An event-driven ingestion pipeline</h2><p id="5a7c" class="pw-post-body-paragraph mo mp fq mq b gt pz ms mt gw qa mv mw mx qb mz na nb qc nd ne nf qd nh ni nj fj bk">There were two pipelines that kept the lights on:</p><ol class=""><li id="f108" class="mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj qu qv qw bk"><strong class="mq ga">Streaming </strong>pipeline: data is continuously streamed from sensors, processed, and stored in a buffer.</li><li id="abe6" class="mo mp fq mq b gt qx ms mt gw qy mv mw mx qz mz na nb ra nd ne nf rb nh ni nj qu qv qw bk"><strong class="mq ga">Saving </strong>pipeline: when the user ends a session, the buffered data is processed and saved in the database, as a record that represents the user session (a single workout).</li></ol><figure class="qi qj qk ql qm qn qf qg paragraph-image"><div role="button" tabindex="0" class="rd re ed rf bh rg"><div class="qf qg rc"><img src="../Images/43d0ee7433e3a9ed7952ee7c358cc8a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3PMH69zrVsO7Ib7-VIdmog.png"/></div></div><figcaption class="qp qq qr qf qg qs qt bf b bg z dx"><strong class="bf nv">Streaming</strong> and <strong class="bf nv">Saving</strong> pipelines</figcaption></figure><p id="8e88" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">The event-driven architecture was a double-edged sword, introducing both order and chaos. Ultimately, we watched it evolve into a well-oiled machine capable of taming its complexities.</p><h1 id="c75a" class="nt nu fq bf nv nw rh gv ny nz ri gy ob oc rj oe of og rk oi oj ok rl om on oo bk">Part ii: the evolution goes on</h1><p id="72b6" class="pw-post-body-paragraph mo mp fq mq b gt pz ms mt gw qa mv mw mx qb mz na nb qc nd ne nf qd nh ni nj fj bk">In this installment, we’ll explore the next three versions of the system, each enhancing a user’s workout experience in a different way:</p><ul class=""><li id="7d9e" class="mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj rm qv qw bk">v3.0: fitness as a <em class="nk">personalised</em> experience</li><li id="5cd1" class="mo mp fq mq b gt qx ms mt gw qy mv mw mx qz mz na nb ra nd ne nf rb nh ni nj rm qv qw bk">v4.0: fitness as a <em class="nk">collective</em> experience</li><li id="0cb9" class="mo mp fq mq b gt qx ms mt gw qy mv mw mx qz mz na nb ra nd ne nf rb nh ni nj rm qv qw bk">v5.0: fitness as a <em class="nk">personalised-collective</em> experience</li></ul><p id="36d3" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">But first, meet the main character of this article!</p><figure class="qi qj qk ql qm qn qf qg paragraph-image"><div role="button" tabindex="0" class="rd re ed rf bh rg"><div class="qf qg rn"><img src="../Images/518463b2e778a51c2dac5646d7a7a4ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*S_ucAoRxU_sLkbh3NVflMQ.png"/></div></div></figure><h1 id="5d79" class="nt nu fq bf nv nw rh gv ny nz ri gy ob oc rj oe of og rk oi oj ok rl om on oo bk">The Magic Black Box</h1><p id="1521" class="pw-post-body-paragraph mo mp fq mq b gt pz ms mt gw qa mv mw mx qb mz na nb qc nd ne nf qd nh ni nj fj bk">Be it distributed, event-driven, or not, we can think of the SmartGym/SENSEI backend system as a magic black box.</p><figure class="qi qj qk ql qm qn qf qg paragraph-image"><div role="button" tabindex="0" class="rd re ed rf bh rg"><div class="qf qg ro"><img src="../Images/37271edc55adb14a0bacaa0ba254d924.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*492GLV56s54HKM9SbgsQhw.png"/></div></div></figure><p id="146c" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk"><strong class="mq ga">Input</strong>: We feed this black box new information — e.g. users info, sensor data</p><p id="2197" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk"><strong class="mq ga">State Transition</strong>: This new information interacts with its existing state based on a certain logic, resulting in a new internal state.</p><p id="c6b2" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk"><strong class="mq ga">Output</strong>: At any time, we can query its internal state to retrieve relevant information — e.g. user workout information</p><p id="2b60" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">The Magic Black Box is <em class="nk">deterministic:</em> if you take two identical black boxes with the same state and logic, feed them with the same inputs in the same order, both will end up with <a class="af qe" href="https://en.wikipedia.org/wiki/State_machine_replication" rel="noopener ugc nofollow" target="_blank">identical internal states</a>.</p><h2 id="e14a" class="pi nu fq bf nv pj pk pl ny pm pn po ob mx pp pq pr nb ps pt pu nf pv pw px fw bk">Inside the black box</h2><p id="395f" class="pw-post-body-paragraph mo mp fq mq b gt pz ms mt gw qa mv mw mx qb mz na nb qc nd ne nf qd nh ni nj fj bk">If we tear it apart, we’ll find there’s nothing truly magical — just a <strong class="mq ga">dataflow architecture</strong> comprising a bunch of data views and ingestion pipelines.</p><figure class="qi qj qk ql qm qn qf qg paragraph-image"><div role="button" tabindex="0" class="rd re ed rf bh rg"><div class="qf qg rp"><img src="../Images/34d0c185157512fd546cef19251ba500.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0B_janz_AQ1o1f3XdjyOyQ.png"/></div></div><figcaption class="qp qq qr qf qg qs qt bf b bg z dx"><strong class="bf nv">Sources of truth</strong> (solid), <strong class="bf nv">derived data views</strong> (dotted) and <strong class="bf nv">stream/save pipeline</strong> logic (arrows)</figcaption></figure><p id="41c0" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">There are two main types of data views:</p><p id="9202" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk"><strong class="mq ga">1. Source of truth</strong> (solid line) — e.g. users, sensor stream</p><ul class=""><li id="45a0" class="mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj rm qv qw bk">New data is first written here. These are original, authoritative data — typically represented exactly once in a normalised way.</li><li id="5572" class="mo mp fq mq b gt qx ms mt gw qy mv mw mx qz mz na nb ra nd ne nf rb nh ni nj rm qv qw bk">The system’s state is a function of these sources of truth and the state transition logic — a reflection of the sequence of events that have transformed it over time.</li></ul><p id="eb27" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk"><strong class="mq ga">2. Derived data</strong> (dotted line) — e.g. workouts</p><ul class=""><li id="9aae" class="mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj rm qv qw bk">This data is processed from existing data in other views, usually involving denormalization, aggregation, or transformation. It is precomputed for efficient future queries.</li><li id="c72e" class="mo mp fq mq b gt qx ms mt gw qy mv mw mx qz mz na nb ra nd ne nf rb nh ni nj rm qv qw bk">Derived data is redundant, effectively “duplicating” existing information; if it is lost, it can always be re-derived from the original source.</li></ul><blockquote class="rq"><p id="16a2" class="rr rs fq bf rt ru rv rw rx ry rz nj dx">The process of deriving data views from sources of truth is known as <strong class="al">materialisation</strong>, a deterministic task handled by workers in the ingestion pipeline.</p></blockquote><p id="ff6a" class="pw-post-body-paragraph mo mp fq mq b gt sa ms mt gw sb mv mw mx sc mz na nb sd nd ne nf se nh ni nj fj bk">All internal <strong class="mq ga">state</strong> of the magic box are encapsulated within these <em class="nk">data views</em>, while the <em class="nk">ingestion pipeline </em>— the machinery behind the materialisation process — remains <strong class="mq ga">stateless</strong>.</p><p id="a501" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">Note that whenever the source of truth changes, the derived data has to be re-derived. Else, the state transition is incomplete and the magic black box is left in an <strong class="mq ga">inconsistent</strong> state.</p><figure class="qi qj qk ql qm qn qf qg paragraph-image"><div role="button" tabindex="0" class="rd re ed rf bh rg"><div class="qf qg rp"><img src="../Images/34d0c185157512fd546cef19251ba500.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0B_janz_AQ1o1f3XdjyOyQ.png"/></div></div><figcaption class="qp qq qr qf qg qs qt bf b bg z dx">v2.1 dataflow architecture</figcaption></figure><p id="e3be" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">In the previous example, we feed the magic black box:</p><ul class=""><li id="ab43" class="mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj rm qv qw bk"><em class="nk">user details</em> through our CRUD API</li><li id="5cc3" class="mo mp fq mq b gt qx ms mt gw qy mv mw mx qz mz na nb ra nd ne nf rb nh ni nj rm qv qw bk"><em class="nk">sensor telemetry</em> through an event stream (<strong class="mq ga">streaming pipeline</strong>)</li></ul><p id="edc2" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">These inputs serve as sources of truth, reflecting real-world entities or events.</p><p id="4d2c" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">From these two pieces of information, we derive a single <em class="nk">workout</em> session record in the <strong class="mq ga">saving pipeline</strong>.</p></div></div></div><div class="ab cb nl nm nn no" role="separator"><span class="np by bm nq nr ns"/><span class="np by bm nq nr ns"/><span class="np by bm nq nr"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="020d" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">Now, you might be offended by Mr. Magic Black Box mansplaining what appears to be common sense to you. But bear with him because he would prove to be a useful abstraction throughout this article.</p><h1 id="cefd" class="nt nu fq bf nv nw rh gv ny nz ri gy ob oc rj oe of og rk oi oj ok rl om on oo bk">v3.0 — Metrics, dashboards, insights: fitness as a personalised experience</h1><p id="6813" class="pw-post-body-paragraph mo mp fq mq b gt pz ms mt gw qa mv mw mx qb mz na nb qc nd ne nf qd nh ni nj fj bk">With the streaming and saving pipelines working tirelessly to ingest data into the system, our database now houses a wealth of user and workout records. We are empowered to provide meaningful macro insights by analysing trends, groups, averages, and totals for our users and stakeholders.</p><figure class="qi qj qk ql qm qn qf qg paragraph-image"><div role="button" tabindex="0" class="rd re ed rf bh rg"><div class="qf qg sf"><img src="../Images/a8e123fecb7a3beee177273a884dad12.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Bj-oNukjaoY_x_VAofKQiw.jpeg"/></div></div><figcaption class="qp qq qr qf qg qs qt bf b bg z dx">SmartGym product metrics dashboard prototype</figcaption></figure><h2 id="eba3" class="pi nu fq bf nv pj pk pl ny pm pn po ob mx pp pq pr nb ps pt pu nf pv pw px fw bk">User insights and fitness metrics</h2><p id="cf37" class="pw-post-body-paragraph mo mp fq mq b gt pz ms mt gw qa mv mw mx qb mz na nb qc nd ne nf qd nh ni nj fj bk">This is where <em class="nk">SmartGym’s</em> vision of becoming <em class="nk">“every citizen’s #1 fitness companion”</em> begins to take shape. Beyond giving real-time feedback during my workout, recalling my historical performance, and telling me what a great job I’ve done — a diligent fitness companion provides tangible metrics to measure my improvement in performance over time.</p><figure class="qi qj qk ql qm qn qf qg paragraph-image"><div role="button" tabindex="0" class="rd re ed rf bh rg"><div class="qf qg sg"><img src="../Images/8c5d150cd740ad5414c53c9ef5013371.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3_figk4nA2qYNZ3cEK4Inw.png"/></div></div><figcaption class="qp qq qr qf qg qs qt bf b bg z dx">SmartGym user workout insights page</figcaption></figure><p id="1c5d" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">By leveraging recent workouts and user information — such as body metrics captured by the SmartGym weighing scale — we can estimate various performance metrics, including:</p><ul class=""><li id="e9c4" class="mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj rm qv qw bk"><strong class="mq ga">1RM (1 Rep Max)</strong> for weight-based workouts (e.g. leg press)</li><li id="7c50" class="mo mp fq mq b gt qx ms mt gw qy mv mw mx qz mz na nb ra nd ne nf rb nh ni nj rm qv qw bk"><strong class="mq ga">Max reps per minute</strong> for bodyweight workouts (e.g. push-ups)</li><li id="ebcb" class="mo mp fq mq b gt qx ms mt gw qy mv mw mx qz mz na nb ra nd ne nf rb nh ni nj rm qv qw bk"><strong class="mq ga">VO2 max</strong> or <strong class="mq ga">MET (Metabolic Equivalent)</strong> for cardio workouts (e.g. treadmill)</li></ul><p id="47b5" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">Deriving both product and fitness metrics typically involves denormalization and aggregation across records, which can be resource-intensive in terms of memory usage, database reads, and network throughput.</p><p id="8c21" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">Since it doesn’t make sense to run these operations every time a user loads the dashboard, we need a precomputed intermediate data representation, ready for query and visualisation — another <strong class="mq ga">derived data view</strong> for <em class="nk">user fitness metrics</em>!</p><h2 id="b37b" class="pi nu fq bf nv pj pk pl ny pm pn po ob mx pp pq pr nb ps pt pu nf pv pw px fw bk">The periodic processing pipeline</h2><p id="3c15" class="pw-post-body-paragraph mo mp fq mq b gt pz ms mt gw qa mv mw mx qb mz na nb qc nd ne nf qd nh ni nj fj bk">Let’s return to our magic black box.</p><figure class="qi qj qk ql qm qn qf qg paragraph-image"><div role="button" tabindex="0" class="rd re ed rf bh rg"><div class="qf qg sh"><img src="../Images/4f31648d06e0a552483038b9458011bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P4ypetRYTf0i_lSKvnmqwg.png"/></div></div><figcaption class="qp qq qr qf qg qs qt bf b bg z dx">v3.0 dataflow architecture</figcaption></figure><p id="c63c" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">As new users and workout records continuously flow in, <em class="nk">user fitness metrics</em> — a derived data view — require continuous updates in response to changes in the upstream data views they rely on.</p><p id="f2bc" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">To address this, we decided to recompute <em class="nk">user fitness metrics</em> periodically, accepting that these metrics may be a few hours stale.</p><p id="8684" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">Our ingestion pipeline now includes a cronjob service that schedules batch processing jobs within the <strong class="mq ga">periodic pipeline </strong>based on a preconfigured schedule, ensuring timely updates without overloading the system.</p><figure class="qi qj qk ql qm qn qf qg paragraph-image"><div role="button" tabindex="0" class="rd re ed rf bh rg"><div class="qf qg si"><img src="../Images/e2eb655a80ae13a1c4ad109df1097701.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_jWCQa4M_oFa8EQQpD9wYA.png"/></div></div><figcaption class="qp qq qr qf qg qs qt bf b bg z dx"><strong class="bf nv">Streaming</strong>, <strong class="bf nv">Saving</strong>, and <strong class="bf nv">Periodic</strong> pipelines</figcaption></figure><h1 id="808a" class="nt nu fq bf nv nw rh gv ny nz ri gy ob oc rj oe of og rk oi oj ok rl om on oo bk">v4.0 — Gamification: fitness as a collective experience</h1><h2 id="e67b" class="pi nu fq bf nv pj pk pl ny pm pn po ob mx pp pq pr nb ps pt pu nf pv pw px fw bk">Moving from individuals to community</h2><p id="ce3e" class="pw-post-body-paragraph mo mp fq mq b gt pz ms mt gw qa mv mw mx qb mz na nb qc nd ne nf qd nh ni nj fj bk">Staying fit is difficult work. But with a healthy dose of competition and collective suffering, it can be an experience that feels larger than life. Imagine if every rep, every set, and every workout session contributed to something greater.</p><p id="06e2" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">Introducing <strong class="mq ga">exercise leaderboard</strong> and <strong class="mq ga">fitness challenges</strong>.</p><h2 id="f8a5" class="pi nu fq bf nv pj pk pl ny pm pn po ob mx pp pq pr nb ps pt pu nf pv pw px fw bk">Exercise leaderboard</h2><p id="ac24" class="pw-post-body-paragraph mo mp fq mq b gt pz ms mt gw qa mv mw mx qb mz na nb qc nd ne nf qd nh ni nj fj bk">The leaderboard showcases users who have logged the most effort over the month — measured by distance run, weights lifted, and more.</p><p id="40a7" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">Boy, did this feature stroke some egos! Some of the gym regulars started renaming their randomly-generated username with titles like “Beefy” or “Armstrong”. For many others, surveying the leaderboard became the first order of business upon entering the gym, and the same post-workout ritual before strutting out with newfound swagger.</p><figure class="qi qj qk ql qm qn qf qg paragraph-image"><div role="button" tabindex="0" class="rd re ed rf bh rg"><div class="qf qg sj"><img src="../Images/9e990cda9ce8378a362aa12c87db72d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y8KXfafI4C2HfMja1Jdagg.jpeg"/></div></div><figcaption class="qp qq qr qf qg qs qt bf b bg z dx">SmartGym leaderboard</figcaption></figure><p id="e77d" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">Similar to how we compute product and user fitness metrics, the leaderboard data is updated periodically in batches, derived from user profiles and their historical workout data.</p><figure class="qi qj qk ql qm qn qf qg paragraph-image"><div role="button" tabindex="0" class="rd re ed rf bh rg"><div class="qf qg sh"><img src="../Images/f126b45336d44df423ebb94fd7af8d9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KO-_H7_Izc6VrumgHRY4wA.png"/></div></div></figure><h2 id="99e3" class="pi nu fq bf nv pj pk pl ny pm pn po ob mx pp pq pr nb ps pt pu nf pv pw px fw bk">Fitness challenge system</h2><p id="9f25" class="pw-post-body-paragraph mo mp fq mq b gt pz ms mt gw qa mv mw mx qb mz na nb qc nd ne nf qd nh ni nj fj bk">In collaboration with the gym management team, we launched a fitness challenge to coincide with periods such as Singapore’s National Day.</p><figure class="qi qj qk ql qm qn qf qg paragraph-image"><div role="button" tabindex="0" class="rd re ed rf bh rg"><div class="qf qg sk"><img src="../Images/3145c2c83809e7629852a2640ae7fc38.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IOe8IiA4sJyWfiPY64tvQg.png"/></div></div><figcaption class="qp qq qr qf qg qs qt bf b bg z dx">SmartGym fitness challenge at Our Tampines Hub</figcaption></figure><p id="d439" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">Each day, users received a challenge requiring them to complete a specific number of reps on a weighted machine or spend a certain number of minutes on a cardio machine, earning rewards for their hard work.</p><p id="4f2f" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">This kickstarted a series of diverse fitness challenges, each featuring unique gameplay variations in terms of duration, workout types, intensity, streaks, and more.</p><figure class="qi qj qk ql qm qn qf qg paragraph-image"><div role="button" tabindex="0" class="rd re ed rf bh rg"><div class="qf qg sl"><img src="../Images/b35769de095912a05451c392513c86d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*krFlu1A7esPikNpumVh6Ww.png"/></div></div><figcaption class="qp qq qr qf qg qs qt bf b bg z dx">SmartGym fitness challenge UI</figcaption></figure><h2 id="987d" class="pi nu fq bf nv pj pk pl ny pm pn po ob mx pp pq pr nb ps pt pu nf pv pw px fw bk">Configurable rules: rule engines and syntax trees</h2><p id="56ba" class="pw-post-body-paragraph mo mp fq mq b gt pz ms mt gw qa mv mw mx qb mz na nb qc nd ne nf qd nh ni nj fj bk">At its core, a fitness challenge is a unique set of workout requirements, specified by an administrator. By comparing a user’s workout history to these requirements, we can assess their progress and completion status for the challenge.</p></div></div><div class="qn"><div class="ab cb"><div class="lr sm ls sn lt so cf sp cg sq ci bh"><figure class="qi qj qk ql qm qn ss st paragraph-image"><div role="button" tabindex="0" class="rd re ed rf bh rg"><div class="qf qg sr"><img src="../Images/c5fdce652a422d11a5348edcc9a5f771.png" data-original-src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*DdX4KxU_c44ahpU771Xz4Q.png"/></div></div><figcaption class="qp qq qr qf qg qs qt bf b bg z dx"><strong class="bf nv">Rules syntax tree</strong>: representing one set of chest-press/leg-press/treadmill workout</figcaption></figure></div></div></div><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="e44f" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">Instead of cluttering our codebase with a new bunch of if-else statements for each variation of the fitness challenge, we externalised the business logic by representing these logical rules in a syntax tree. During runtime, the rule engine parses this tree and evaluates it against users’ actual workout histories to track their challenge progress.</p></div></div><div class="qn"><div class="ab cb"><div class="lr sm ls sn lt so cf sp cg sq ci bh"><figure class="qi qj qk ql qm qn ss st paragraph-image"><div role="button" tabindex="0" class="rd re ed rf bh rg"><div class="qf qg su"><img src="../Images/5c0ec01c775f100e0abaf8b325f48274.png" data-original-src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*rjnBGBwxxoO6gZd0Sagm9w.png"/></div></div><figcaption class="qp qq qr qf qg qs qt bf b bg z dx">Runtime evaluation of syntax tree</figcaption></figure></div></div></div><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="d86d" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">When the program admin modifies the parameters of a fitness challenge, they are directly updating the underlying rules syntax tree. This same data structure is shared between the backend rules engine and the frontend rules configuration page, ensuring consistency and ease of management.</p><figure class="qi qj qk ql qm qn qf qg paragraph-image"><div role="button" tabindex="0" class="rd re ed rf bh rg"><div class="qf qg sv"><img src="../Images/8161add68c5de2d49d97e12dd5881b9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6AKwkvIqO3if2dP_otc3ZQ.jpeg"/></div></div><figcaption class="qp qq qr qf qg qs qt bf b bg z dx">SmartGym fitness challenge configuration page</figcaption></figure><h2 id="8123" class="pi nu fq bf nv pj pk pl ny pm pn po ob mx pp pq pr nb ps pt pu nf pv pw px fw bk">The on-demand processing pipeline</h2><p id="4d74" class="pw-post-body-paragraph mo mp fq mq b gt pz ms mt gw qa mv mw mx qb mz na nb qc nd ne nf qd nh ni nj fj bk">Lets revisit our magic black box.</p></div></div><div class="qn"><div class="ab cb"><div class="lr sm ls sn lt so cf sp cg sq ci bh"><figure class="qi qj qk ql qm qn ss st paragraph-image"><div role="button" tabindex="0" class="rd re ed rf bh rg"><div class="qf qg sw"><img src="../Images/91bc947764698241e8f7201ebfac08fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*Ic6QtFFXJBloGivwXFvIAQ.png"/></div></div><figcaption class="qp qq qr qf qg qs qt bf b bg z dx">v4.0 dataflow architecture</figcaption></figure></div></div></div><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="b102" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk"><em class="nk">User fitness challenge results</em>, derived from the <em class="nk">workouts</em> and <em class="nk">user fitness challenge</em> data through the rules engine, need to be recalculated whenever changes occur in the upstream data views they depend on — such as each time a user completes a workout set.</p><p id="2ec8" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">Among our enthusiastic users, these fitness challenges are a matter of honour and glory. If they don’t see updated challenge results immediately after finishing a set, they get confused and frustrated. Therefore, we can’t afford to reprocess <em class="nk">user fitness challenge results</em> in periodic batches; every change in the <em class="nk">workouts</em> data view must be propagated instantly.</p><p id="aff9" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">To achieve that, we extend our ingestion pipeline with a Change Data Capture mechanism, introducing a service that continuously listens for changes in relevant data views, using built-in database triggers or change streams. This <strong class="mq ga">on-demand pipeline</strong> triggers a cascade of updates to the downstream derived data views.</p><p id="1659" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">In this case, an <em class="nk">on-demand worker</em> implements the logic of the rules engine to evaluate <em class="nk">user fitness challenges results</em> on the fly.</p><figure class="qi qj qk ql qm qn qf qg paragraph-image"><div role="button" tabindex="0" class="rd re ed rf bh rg"><div class="qf qg sx"><img src="../Images/41e693713abf38051a93dc5749e06afc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*caSI18sRNfkow370sE9Now.png"/></div></div><figcaption class="qp qq qr qf qg qs qt bf b bg z dx">Unveiling our latest inline-four <em class="py">engine</em> with <strong class="bf nv">Streaming</strong>, <strong class="bf nv">Saving</strong>, <strong class="bf nv">Periodic</strong>, and <strong class="bf nv">On-demand</strong> pipelines</figcaption></figure><p id="1da2" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">A recap of the different stages of our ingestion pipeline:</p><ul class=""><li id="d56a" class="mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj rm qv qw bk"><strong class="mq ga"><em class="nk">Stream processing</em></strong>: Responsible for ingesting, processing, and storing a stream of live sensor data into a buffer</li><li id="b90b" class="mo mp fq mq b gt qx ms mt gw qy mv mw mx qz mz na nb ra nd ne nf rb nh ni nj rm qv qw bk"><strong class="mq ga"><em class="nk">Save processing</em></strong>: Responsible for consolidating data from the stream buffer, processing, and saving it into the database as a record that represents a single workout or a user session.</li><li id="034f" class="mo mp fq mq b gt qx ms mt gw qy mv mw mx qz mz na nb ra nd ne nf rb nh ni nj rm qv qw bk"><strong class="mq ga"><em class="nk">Periodic processing</em></strong>: Responsible for precomputing derived data views periodically</li><li id="97ac" class="mo mp fq mq b gt qx ms mt gw qy mv mw mx qz mz na nb ra nd ne nf rb nh ni nj rm qv qw bk"><strong class="mq ga"><em class="nk">On-demand processing</em></strong>: Responsible for propagating updates from upstream data views to derived data views immediately</li></ul><h1 id="6455" class="nt nu fq bf nv nw rh gv ny nz ri gy ob oc rj oe of og rk oi oj ok rl om on oo bk">v5.0 — Recommendation: fitness as a personalised-collective experience</h1><p id="114d" class="pw-post-body-paragraph mo mp fq mq b gt pz ms mt gw qa mv mw mx qb mz na nb qc nd ne nf qd nh ni nj fj bk">What if we could give the fitness challenges a personal touch?</p><h2 id="762e" class="pi nu fq bf nv pj pk pl ny pm pn po ob mx pp pq pr nb ps pt pu nf pv pw px fw bk">NSFIT x SmartGym</h2><p id="7255" class="pw-post-body-paragraph mo mp fq mq b gt pz ms mt gw qa mv mw mx qb mz na nb qc nd ne nf qd nh ni nj fj bk">In late 2021, a team from the Singapore Army described their predicament: each year, servicemen must meet specific fitness benchmarks. If they fall short, they are enrolled in a structured training program, known as NSFIT. However, these sessions were limited to specific times, required sign-ups, and needed staff to facilitate and monitor progress. With the ongoing pandemic and social distancing measures then, gathering servicemen for group sessions wasn’t feasible.</p><p id="c6a7" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">Using the SmartGym fitness challenge system, servicemen could carry out their training on their own schedule — no need for staff to hover over every session. All that’s required is for the staff to verify that the training was completed and the standards were met.</p><figure class="qi qj qk ql qm qn qf qg paragraph-image"><div role="button" tabindex="0" class="rd re ed rf bh rg"><div class="qf qg sy"><img src="../Images/cb17d66f7e2f2c54b2a2e8e8e406435b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YLG0rbMciMe9R9HU3o6rGg.gif"/></div></div><figcaption class="qp qq qr qf qg qs qt bf b bg z dx">Real-time recommendation for treadmill intensity based on fitness profile</figcaption></figure><p id="41ce" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">But here’s the twist: servicemen come in all shapes, sizes, and fitness levels. A one-size-fits-all fitness challenge just wouldn’t cut it. They need something that meets them where they are, in order to push their fitness to new heights.</p><p id="8c9f" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">So, why not add a recommendation step before curating a user fitness challenge? By leveraging the fitness metrics we already compute (like in v3.0), we could tailor the intensity of their subsequent training sessions.</p><p id="d425" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">Our personalized fitness challenge now follows three key steps:</p></div></div><div class="qn"><div class="ab cb"><div class="lr sm ls sn lt so cf sp cg sq ci bh"><figure class="qi qj qk ql qm qn ss st paragraph-image"><div role="button" tabindex="0" class="rd re ed rf bh rg"><div class="qf qg sz"><img src="../Images/ad035cc1deb027a042f3c748c1d07d54.png" data-original-src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*M-9TAQbXtcPbsu5xdoS0Vw.png"/></div></div></figure></div></div></div><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="726d" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk"><strong class="mq ga">Step 1 — Profiling<br/></strong>Using historical workout data, we profile each user’s fitness level.</p><p id="cecc" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">To further optimise this process, we could expand our profiling methods beyond simple heuristics, incorporating machine learning methods to extract more sophisticated features — resulting in new derived data views.</p><p id="ad1a" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk"><strong class="mq ga">Step 2 — Recommendation<br/></strong>Starting with a generic challenge template (including general information like location, total workouts, participant groups, start/end dates, etc), the recommendation engine fleshes out this skeletal template into a rules syntax tree tailored to each user’s fitness profile.</p><p id="3600" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">For even greater personalization, a domain expert could manually fine-tune the challenge requirements, offering a professional perspective beyond algorithmic deduction.</p><p id="2556" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk"><strong class="mq ga">Step 3 — Evaluation<br/></strong>Once personalized parameters are embedded into the rules syntax tree, evaluations can be triggered on-demand after the workout is saved, or even performed in real-time against the sensor stream and displayed on the frontend console.</p><figure class="qi qj qk ql qm qn qf qg paragraph-image"><div class="qf qg ta"><img src="../Images/9a98ce9b3165cccbb3e3815c6cfbac80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1112/format:webp/1*Gr6YGrVTC_pfka7712KDaQ.gif"/></div><figcaption class="qp qq qr qf qg qs qt bf b bg z dx">Real-time personalised fitness challenge evaluation</figcaption></figure></div></div><div class="qn"><div class="ab cb"><div class="lr sm ls sn lt so cf sp cg sq ci bh"><figure class="qi qj qk ql qm qn ss st paragraph-image"><div role="button" tabindex="0" class="rd re ed rf bh rg"><div class="qf qg tb"><img src="../Images/8e7cd01b789fcce738caffe680c133aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*CsB67LGqVjEBTY9UPWFTJA.png"/></div></div><figcaption class="qp qq qr qf qg qs qt bf b bg z dx">v5.0 dataflow architecture</figcaption></figure></div></div></div></div><div class="ab cb nl nm nn no" role="separator"><span class="np by bm nq nr ns"/><span class="np by bm nq nr ns"/><span class="np by bm nq nr"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><h1 id="5504" class="nt nu fq bf nv nw nx gv ny nz oa gy ob oc od oe of og oh oi oj ok ol om on oo bk">The dataflow paradigm</h1><h2 id="63de" class="pi nu fq bf nv pj pk pl ny pm pn po ob mx pp pq pr nb ps pt pu nf pv pw px fw bk">The Magic Black Box revisited</h2><p id="37e7" class="pw-post-body-paragraph mo mp fq mq b gt pz ms mt gw qa mv mw mx qb mz na nb qc nd ne nf qd nh ni nj fj bk">Earlier in the article, we mentioned that the magic black box is composed of data views, where the <strong class="mq ga">state</strong> lives, and a <strong class="mq ga">stateless</strong> ingestion pipeline.</p><blockquote class="tc td te"><p id="a619" class="mo mp nk mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">To get <strong class="mq ga">reliable</strong> outputs from the magic black box, these data views must be <strong class="mq ga">consistent</strong>, achieved through a <strong class="mq ga">deterministic</strong> series of materialisation in the ingestion pipeline.</p></blockquote><p id="138e" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">Buckle up and brace yourself, because we will be diving deep into <em class="nk">consistency</em> and <em class="nk">determinism — </em>the undercurrents of dataflow.</p><h1 id="ce8c" class="nt nu fq bf nv nw rh gv ny nz ri gy ob oc rj oe of og rk oi oj ok rl om on oo bk">The challenge of consistency: a necessary evil</h1><p id="7f5f" class="pw-post-body-paragraph mo mp fq mq b gt pz ms mt gw qa mv mw mx qb mz na nb qc nd ne nf qd nh ni nj fj bk">At first glance, it might seem simpler to create one massive data view containing every bit of detail from the raw data. With only one data source, consistency is implied. However, there are several reasons why we need derived data views despite the complexity of maintaining consistency:</p><h2 id="6779" class="pi nu fq bf nv pj pk pl ny pm pn po ob mx pp pq pr nb ps pt pu nf pv pw px fw bk"><strong class="al">Data polymorphism</strong></h2><p id="272c" class="pw-post-body-paragraph mo mp fq mq b gt pz ms mt gw qa mv mw mx qb mz na nb qc nd ne nf qd nh ni nj fj bk">Data can be represented in a myriad of forms — in different combinations and at multiple levels of granularity — each serving their own unique purpose.</p><p id="79c3" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">For example, it turns out that a user is not interested in knowing if the 3rd rep of his 2nd set of chest press on September 2020 was fully extended or not — after that real-time window of immediacy, low-level raw details become increasingly irrelevant, while higher-level derived insights become much more valuable.</p><blockquote class="rq"><p id="5282" class="rr rs fq bf rt ru tf tg th ti tj nj dx">To avoid having to assume how data will be used and represented in future — <em class="py">raw is better</em>, a.k.a the Sushi Principle.</p></blockquote><h2 id="9f30" class="pi nu fq bf nv pj tk pl ny pm tl po ob mx tm pq pr nb tn pt pu nf to pw px fw bk"><strong class="al">Read-write performance</strong></h2><p id="9de3" class="pw-post-body-paragraph mo mp fq mq b gt pz ms mt gw qa mv mw mx qb mz na nb qc nd ne nf qd nh ni nj fj bk">With that, we decouple the write model from the range of potential read models, and bridge the gap with a series of materialisation stages. This separation is commonly known as Command and Query Responsibility Segregation (CQRS).</p><figure class="qi qj qk ql qm qn qf qg paragraph-image"><div role="button" tabindex="0" class="rd re ed rf bh rg"><div class="qf qg tp"><img src="../Images/f59125e22652d9f40f27a2f8289ab5a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PJext38vm1U7wLQMKUPg_g.png"/></div></div></figure><p id="7596" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">Having a materialisation path gives a piece of data the space and time — to morph and discover its different personalities, enabling:</p><ul class=""><li id="5147" class="mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj rm qv qw bk"><strong class="mq ga">Faster &amp; simpler <em class="nk">writes</em></strong>: a shortened write path by deferring data processing and complex data models to a later stage</li><li id="f42d" class="mo mp fq mq b gt qx ms mt gw qy mv mw mx qz mz na nb ra nd ne nf rb nh ni nj rm qv qw bk"><strong class="mq ga">Efficient &amp; flexible <em class="nk">reads</em></strong>: a shortened read path by computing different derived views in advance</li></ul><h2 id="8e61" class="pi nu fq bf nv pj pk pl ny pm pn po ob mx pp pq pr nb ps pt pu nf pv pw px fw bk"><strong class="al">Basis of consistency</strong></h2><p id="3048" class="pw-post-body-paragraph mo mp fq mq b gt pz ms mt gw qa mv mw mx qb mz na nb qc nd ne nf qd nh ni nj fj bk">By designating the write model as the authoritative source of truth to reason from, it is easier to achieve consistency — without the complexities of having multiple authoritative systems trying to reach a consensus.</p><p id="a384" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">There are instances when the raw data grows too rapidly. E.g. with 1 message/sec per treadmill sensor, with multiple gyms, you end up with millions of messages in the <em class="nk">sensor stream</em> in just one day.</p><figure class="qi qj qk ql qm qn qf qg paragraph-image"><div role="button" tabindex="0" class="rd re ed rf bh rg"><div class="qf qg sh"><img src="../Images/f94a46f7c2a5c9cfd1aa80e791ed99fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*48_2fcjg60fBpmN0qw4OgA.png"/></div></div><figcaption class="qp qq qr qf qg qs qt bf b bg z dx"><strong class="bf nv">workouts</strong> replacing <strong class="bf nv">sensor stream </strong>as the new authoritative data view</figcaption></figure><p id="1d33" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">When the <em class="nk">sensor stream</em> grows prohibitively large, we can treat <em class="nk">workouts</em> records as a “lossy compression” of the <em class="nk">sensor stream</em>, purge the processed <em class="nk">sensor stream</em>, and promote the derived <em class="nk">workouts</em> records as a new authoritative source of truth.</p><p id="a32e" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">Since the one-way chain of materialisation still starts from a single source of truth, we retain our basis of consistency.</p><h2 id="569c" class="pi nu fq bf nv pj pk pl ny pm pn po ob mx pp pq pr nb ps pt pu nf pv pw px fw bk"><strong class="al">Anti-fragility: fault recovery and application evolution</strong></h2><p id="5900" class="pw-post-body-paragraph mo mp fq mq b gt pz ms mt gw qa mv mw mx qb mz na nb qc nd ne nf qd nh ni nj fj bk">Derived views offers resilience. If a bug corrupts the output, we can roll back to previous versions and rerun the materialisation process, ensuring accurate data again.</p><p id="ba9c" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">Derived views also enable gradual evolution of application. You can introduce new data views without deleting or restructuring the old ones, keeping both as independent views of the same data, with the option of falling back if something goes wrong.</p><figure class="qi qj qk ql qm qn qf qg paragraph-image"><div role="button" tabindex="0" class="rd re ed rf bh rg"><div class="qf qg sh"><img src="../Images/af047d09835a13db2b6ade70fbb53d88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pfZMqCiOWwMDLF7Ij6Ow7A.png"/></div></div><figcaption class="qp qq qr qf qg qs qt bf b bg z dx"><em class="py">Non-breaking</em> evolution of derivation logic</figcaption></figure><p id="e97a" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">In <a class="af qe" href="https://medium.com/siot-govtech/a-not-so-brief-history-of-a-health-fitness-data-pipeline-part-i-event-driven-architecture-79d2fa8ce189#7072" rel="noopener">part one</a> of the series, we’ve seen how the publisher-subscriber (pub/sub) pattern (via a fanout exchange) of the ingestion pipeline makes it easy to extend system functionality in a plug-and-play manner, without disrupting existing pipelines or requiring upstream modifications.</p><blockquote class="rq"><p id="f47b" class="rr rs fq bf rt ru tf tg th ti tj nj dx">A key to agile development and building anti-fragile systems — those that improve with each bug fix or new feature — is the ease of recovery and evolution. The decoupling enabled by the pub/sub pattern and derived views makes this possible.</p></blockquote><h1 id="e81e" class="nt nu fq bf nv nw rh gv ny nz ri gy ob oc tq oe of og tr oi oj ok ts om on oo bk">The art of consistency and control</h1><p id="5cbe" class="pw-post-body-paragraph mo mp fq mq b gt pz ms mt gw qa mv mw mx qb mz na nb qc nd ne nf qd nh ni nj fj bk">Next, let’s dissect the nature of consistency and control flow of the dataflow architecture.</p><p id="6903" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">Broadly speaking, distributed systems can be categorised by two consistency levels — <strong class="mq ga">strong</strong> or <strong class="mq ga">eventual</strong>;<strong class="mq ga"> </strong>and two types of control flow — <strong class="mq ga">orchestration</strong> (centralised) or <strong class="mq ga">choreography</strong> (decentralised).</p></div></div><div class="qn bh"><figure class="qi qj qk ql qm qn bh paragraph-image"><img src="../Images/5c9ced666ed1acddd4624c3a85c35ea1.png" data-original-src="https://miro.medium.com/v2/resize:fit:4800/format:webp/1*EdCjuTQwmCxEOXLMhAjZag.png"/><figcaption class="qp qq qr qf qg qs qt bf b bg z dx">Relationship between consistency levels and control flow</figcaption></figure></div><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="56fd" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk"><strong class="mq ga">Strong consistency </strong>guarantees that every read reflects the most recent write. It ensures that all data views are updated immediately and accurately after a change. Strong consistency is typically associated with <strong class="mq ga">orchestration</strong>, since it often relies on a central coordinator to manage atomic updates across multiple data views — either updating all at once, or none at all. Such “over-engineering” may be required for systems where minor discrepancies can be disastrous, e.g. financial transactions, but not in our case.</p><p id="f82f" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk"><strong class="mq ga">Eventual consistency</strong> allows for temporary discrepancies between data views, but given enough time, all views will converge to the same state. This approach typically pairs with <strong class="mq ga">choreography</strong>, where each worker reacts to events independently and asynchronously, without needing a central coordinator.</p><blockquote class="tc td te"><p id="8bb2" class="mo mp nk mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">The <strong class="mq ga">asynchronous</strong> and <strong class="mq ga">loosely-coupled</strong> design of the dataflow architecture is characterised by <strong class="mq ga">eventual consistency</strong> of data views, achieved through a <strong class="mq ga">choreography</strong> of materialisation logic.</p></blockquote><p id="65f9" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">And there are perks to that.</p><h2 id="8ddb" class="pi nu fq bf nv pj pk pl ny pm pn po ob mx pp pq pr nb ps pt pu nf pv pw px fw bk"><strong class="al">Perks: at the system level</strong></h2><p id="9fd0" class="pw-post-body-paragraph mo mp fq mq b gt pz ms mt gw qa mv mw mx qb mz na nb qc nd ne nf qd nh ni nj fj bk"><strong class="mq ga">Resilience to partial failures</strong>: The asynchrony of choreography is more robust against component failures or performance bottlenecks, as disruptions are contained locally. In contrast, orchestration can propagate failures across the system, amplifying the issue through tight coupling.</p><p id="018f" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk"><strong class="mq ga">Simplified write path</strong>: Choreography also reduces the responsibility of the write path, which reduces the code surface area for bugs to corrupt the source of truth. Conversely, orchestration makes the write path more complex, and increasingly harder to maintain as the number of different data representations grows.</p><h2 id="361b" class="pi nu fq bf nv pj pk pl ny pm pn po ob mx pp pq pr nb ps pt pu nf pv pw px fw bk"><strong class="al">Perks: at the <em class="py">human</em> level</strong></h2><p id="7266" class="pw-post-body-paragraph mo mp fq mq b gt pz ms mt gw qa mv mw mx qb mz na nb qc nd ne nf qd nh ni nj fj bk">The decentralised control logic of choreography allows different materialisation stages to be developed, specialised, and maintained independently and concurrently.</p><h1 id="59dc" class="nt nu fq bf nv nw rh gv ny nz ri gy ob oc rj oe of og rk oi oj ok rl om on oo bk">Determinism: the event-driven work ethic (revisited)</h1><h2 id="edbf" class="pi nu fq bf nv pj pk pl ny pm pn po ob mx pp pq pr nb ps pt pu nf pv pw px fw bk">The spreadsheet ideal</h2><p id="2c0c" class="pw-post-body-paragraph mo mp fq mq b gt pz ms mt gw qa mv mw mx qb mz na nb qc nd ne nf qd nh ni nj fj bk">A reliable dataflow system is akin to a spreadsheet: when one cell changes, all related cells update instantly — no manual effort required.</p><p id="2499" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">In an ideal dataflow system, we want the same effect: when an upstream data view changes, all dependent views update seamlessly. Like in a spreadsheet, we shouldn’t have to worry about how it works; it just should.</p><p id="d689" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">But ensuring this level of reliability in distributed systems is far from simple. Network partitions, service outages, and machine failures are the norm rather than the exception, and the concurrency in the ingestion pipeline only adds complexity.</p><p id="179c" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">Since message queues in the ingestion pipeline provide <a class="af qe" href="https://medium.com/siot-govtech/a-not-so-brief-history-of-a-health-fitness-data-pipeline-part-i-event-driven-architecture-79d2fa8ce189#037c" rel="noopener">reliability guarantees</a>, <strong class="mq ga">deterministic retries</strong> can make transient faults seem like they never happened. To achieve that, our ingestion workers need to adopt the <a class="af qe" href="https://medium.com/siot-govtech/a-not-so-brief-history-of-a-health-fitness-data-pipeline-part-i-event-driven-architecture-79d2fa8ce189#f36e" rel="noopener">event-driven work ethic</a>:</p><h2 id="8bb7" class="pi nu fq bf nv pj pk pl ny pm pn po ob mx pp pq pr nb ps pt pu nf pv pw px fw bk">Pure functions have no free will</h2><blockquote class="rq"><p id="6e06" class="rr rs fq bf rt ru tf tg th ti tj nj dx">In computer science, <em class="py">pure functions</em> exhibit determinism, meaning their behaviour is entirely predictable and repeatable.</p></blockquote><p id="6f08" class="pw-post-body-paragraph mo mp fq mq b gt sa ms mt gw sb mv mw mx sc mz na nb sd nd ne nf se nh ni nj fj bk">They are ephemeral — here for a moment and gone the next, retaining no state beyond their lifespan. Naked they come, and naked they shall go. And from the immutable message inscribed into their birth, their legacy is determined. They <em class="nk">always</em> return the same output for the same input — everything unfolds exactly as predestined.</p><p id="e894" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">And that is exactly what we want our ingestion workers to be.</p><p id="ff70" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk"><strong class="mq ga">Immutable inputs (statelessness)<br/></strong>This immutable message encapsulates all necessary information, removing any dependency on external, changeable data. Essentially we are passing data to the workers by value rather than by reference, such that processing a message tomorrow would yield the same result as it would today.</p><p id="bac3" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk"><strong class="mq ga">Task isolation</strong></p><blockquote class="rq"><p id="3c3f" class="rr rs fq bf rt ru tf tg th ti tj nj dx">To avoid concurrency issues, workers should not share mutable state.</p></blockquote><p id="a34b" class="pw-post-body-paragraph mo mp fq mq b gt sa ms mt gw sb mv mw mx sc mz na nb sd nd ne nf se nh ni nj fj bk">Transitional states within the workers should be isolated, like local variables in pure functions — without reliance on shared caches for intermediate computation.</p><p id="7369" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">It’s also crucial to scope tasks independently, ensuring that each worker handles tasks without sharing input or output spaces, allowing parallel execution without race conditions. E.g. scoping the user fitness profiling task by a particular user_id, since inputs (<em class="nk">workouts</em>) are outputs (<em class="nk">user fitness metrics) </em>are tied to a unique user.</p><p id="2672" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk"><strong class="mq ga">Deterministic execution<br/></strong>Non-determinism can sneak in easily: using system clocks, depending on external data sources, probabilistic/statistical algorithms relying on random numbers, can all lead to unpredictable results. To prevent this, we embed all “moving parts” (e.g. random seeds or timestamp) directly in the immutable message.</p><p id="ac00" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk"><strong class="mq ga">Deterministic ordering<br/></strong>Load balancing with message queues (multiple workers per queue) can result in out-of-order message processing when a message is retried after the next one is already processed. E.g. Out-of-order evaluation of <em class="nk">user fitness challenge results</em> appearing as 50% completion to 70% and back to 60%, when it should increase monotonically. For operations that require sequential execution, like inserting a record followed by notifying a third-party service, out-of-order processing could break such causal dependencies.</p><p id="fdc8" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">At the application level, these sequential operations should either run synchronously on a single worker or be split into separate sequential stages of materialisation.</p><p id="14c5" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">At the ingestion pipeline level, we could assign only one worker per queue to ensure serialised processing that “blocks” until retry is successful. To maintain load balancing, you can use multiple queues with a consistent hash exchange that routes messages based on the hash of the routing key. This achieves a similar effect to Kafka’s hashed partition key approach.</p><p id="aecb" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk"><strong class="mq ga">Idempotent outputs</strong></p><blockquote class="rq"><p id="40c6" class="rr rs fq bf rt ru tf tg th ti tj nj dx">Idempotence is a property where multiple executions of a piece of code should always yield the same result, no matter how many times it got executed.</p></blockquote><p id="a6a1" class="pw-post-body-paragraph mo mp fq mq b gt sa ms mt gw sb mv mw mx sc mz na nb sd nd ne nf se nh ni nj fj bk">For example, a trivial database “insert” operation is not idempotent while an “insert if does not exist” operation is.</p><p id="de5a" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">This ensures that you get the same outcome as if the worker only executed once, regardless of how many retries it actually took.</p><p id="92a1" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk"><strong class="mq ga"><em class="nk">Caveat</em></strong><em class="nk">: Note that unlike pure functions, the worker does not “return” an object in the programming sense. Instead, they overwrite a portion of the database. While this may look like a side-effect, you can think of this overwrite as similar to the immutable output of a pure function: once the worker commits the result, it reflects a final, unchangeable state.</em></p><h1 id="9218" class="nt nu fq bf nv nw rh gv ny nz ri gy ob oc rj oe of og rk oi oj ok rl om on oo bk">Dataflow-ception</h1><h2 id="e103" class="pi nu fq bf nv pj pk pl ny pm pn po ob mx pp pq pr nb ps pt pu nf pv pw px fw bk">Dataflow in client-side applications</h2><p id="cc38" class="pw-post-body-paragraph mo mp fq mq b gt pz ms mt gw qa mv mw mx qb mz na nb qc nd ne nf qd nh ni nj fj bk">Traditionally, we think of web/mobile apps as stateless clients talking to a central database. However, modern “single-page” frameworks have changed the game, offering “stateful” client-side interaction and persistent local storage.</p><p id="e6aa" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">This extends our dataflow architecture beyond the confines of a backend system into a multitude of client devices. Think of the on-device state (the “model” in model-view-controller) as derived view of server state — the screen displays a materialised view of local on-device state, which mirrors the central backend’s state.</p><p id="a0bb" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">Push-based protocols like server-sent events and WebSockets take this analogy further, enabling servers to actively push updates to the client without relying on polling — delivering eventual consistency from end to end.</p></div></div><div class="qn"><div class="ab cb"><div class="lr sm ls sn lt so cf sp cg sq ci bh"><figure class="qi qj qk ql qm qn ss st paragraph-image"><div role="button" tabindex="0" class="rd re ed rf bh rg"><div class="qf qg tt"><img src="../Images/d166c2825d528fbcabfc9999fc3f7123.png" data-original-src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*-0xmZGOWmUY2BH3Q8UfNJQ.png"/></div></div><figcaption class="qp qq qr qf qg qs qt bf b bg z dx">v5.0 dataflow architecture (extended)</figcaption></figure></div></div></div><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="424e" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">In fact, this real-time synchronization is exactly how we evaluated personalized fitness challenges in the frontend console — as a derived data view residing in a client device.</p><figure class="qi qj qk ql qm qn qf qg paragraph-image"><div class="qf qg ta"><img src="../Images/9a98ce9b3165cccbb3e3815c6cfbac80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1112/format:webp/1*Gr6YGrVTC_pfka7712KDaQ.gif"/></div><figcaption class="qp qq qr qf qg qs qt bf b bg z dx">Real-time personalised fitness challenge evaluation</figcaption></figure><h2 id="2421" class="pi nu fq bf nv pj pk pl ny pm pn po ob mx pp pq pr nb ps pt pu nf pv pw px fw bk">Dataflow in databases</h2><p id="48cc" class="pw-post-body-paragraph mo mp fq mq b gt pz ms mt gw qa mv mw mx qb mz na nb qc nd ne nf qd nh ni nj fj bk">Even down the stack, we see a semblance of dataflow in databases. Database triggers, stored procedures, and materialized view maintenance routines are not very different from the on-demand and periodic processing pipelines; B-tree indexes and materialised views of a relational database are essentially derived data views— talk about dataflows within dataflows!</p><h2 id="918d" class="pi nu fq bf nv pj pk pl ny pm pn po ob mx pp pq pr nb ps pt pu nf pv pw px fw bk">Dataflows, dataflows everywhere</h2><blockquote class="tc td te"><p id="facb" class="mo mp nk mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk"><strong class="mq ga">“The goal of data integration is to make sure that data ends up in the right form, in all the right places.”</strong></p><p id="daab" class="mo mp nk mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">— Designing Data-Intensive Applications (Martin Kleppmann)</p></blockquote><p id="bdb3" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">As data systems scale, we should progress beyond seeing them as passive databases manipulated by applications like global variables.</p><p id="6c6a" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">Instead, it is useful to reimagine data systems in an organisation as an interplay of data views, one derived from another, with state changes rippling out from a central source of truth, propagated through functional application code. Dataflows, built upon dataflows.</p><p id="a90a" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">It’s magic black boxes — <em class="nk">all the way down.</em></p><h1 id="5175" class="nt nu fq bf nv nw rh gv ny nz ri gy ob oc rj oe of og rk oi oj ok rl om on oo bk">Wrapping up</h1><p id="b24e" class="pw-post-body-paragraph mo mp fq mq b gt pz ms mt gw qa mv mw mx qb mz na nb qc nd ne nf qd nh ni nj fj bk">Congratulations on making it this far!</p><p id="d6e0" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">In part I, we evolved from a trivial request-response system into an event-driven system that <strong class="mq ga">streams</strong>, <strong class="mq ga">processes</strong>, and <strong class="mq ga">saves</strong> data from a range of gym equipment sensors and medical devices.</p><p id="9941" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">In this second instalment, we expanded upon those saved records and processed them <strong class="mq ga">periodically</strong> and <strong class="mq ga">on-demand</strong>. This enabled new features that enhance a user’s workout experience into a more <em class="nk">collective</em> yet <em class="nk">personalised</em> one. As our ingestion pipeline evolved, so did our dataflow architecture, scaling to meet new demands.</p></div></div><div class="qn"><div class="ab cb"><div class="lr sm ls sn lt so cf sp cg sq ci bh"><figure class="qi qj qk ql qm qn ss st paragraph-image"><div role="button" tabindex="0" class="rd re ed rf bh rg"><div class="qf qg tu"><img src="../Images/c844159ae4f7bbe6792c6ba9772df96a.png" data-original-src="https://miro.medium.com/v2/resize:fit:2000/format:webp/1*bZwZpslISmhAn9UEAddc1w.png"/></div></div><figcaption class="qp qq qr qf qg qs qt bf b bg z dx">Summary of SmartGym features built upon the ingestion pipeline</figcaption></figure></div></div></div><div class="ab cb"><div class="ci bh ev ew ex ey"><blockquote class="rq"><p id="cde2" class="rr rs fq bf rt ru rv rw rx ry rz nj dx">The story of our evolution doesn’t end here.</p></blockquote><p id="46e4" class="pw-post-body-paragraph mo mp fq mq b gt sa ms mt gw sb mv mw mx sc mz na nb sd nd ne nf se nh ni nj fj bk">In the next and final part, we explore adding and removing functionality in a plug-and-play manner, paving the way for an ecosystem to emerge from our platform.</p><p id="f4f5" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk">Stay tuned…</p></div></div></div><div class="ab cb nl nm nn no" role="separator"><span class="np by bm nq nr ns"/><span class="np by bm nq nr ns"/><span class="np by bm nq nr"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="c9ed" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk"><em class="nk">All images and gifs featured in this article are original works created and captured by the author.</em></p></div></div></div><div class="ab cb nl nm nn no" role="separator"><span class="np by bm nq nr ns"/><span class="np by bm nq nr ns"/><span class="np by bm nq nr"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="9404" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk"><em class="nk">Shoutout to the data engineering bible, a.k.a Designing Data-Intensive Applications — by Martin Kleppmann, for giving me the vocabulary to think about these distributed systems with clarity.</em></p></div></div></div><div class="ab cb nl nm nn no" role="separator"><span class="np by bm nq nr ns"/><span class="np by bm nq nr ns"/><span class="np by bm nq nr"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><h2 id="7a79" class="pi nu fq bf nv pj pk pl ny pm pn po ob mx pp pq pr nb ps pt pu nf pv pw px fw bk">A(not-so) brief history of a health &amp; fitness data pipeline — series</h2><div class="op oq or os ot ou"><a href="https://medium.com/siot-govtech/a-not-so-brief-history-of-a-health-fitness-data-pipeline-part-i-event-driven-architecture-79d2fa8ce189?source=post_page-----e3bc25176cf8--------------------------------" rel="noopener follow" target="_blank"><div class="ov ab il"><div class="ow ab co cb ox oy"><h2 class="bf ga ib z it oz iv iw pa iy ja fz bk">Event-driven Architecture — Evolution from Servers to Brokers to Queues</h2><div class="pb l"><h3 class="bf b ib z it oz iv iw pa iy ja dx">a (not-so) brief history of a health &amp; fitness data pipeline: part i</h3></div><div class="gq l"><p class="bf b dy z it oz iv iw pa iy ja dx">medium.com</p></div></div><div class="pc l"><div class="pd l pe pf pg pc ph lw ou"/></div></div></a></div><div class="op oq or os ot ou"><a rel="noopener follow" target="_blank" href="/dataflow-architecture-derived-data-views-and-eventual-consistency-e3bc25176cf8?source=post_page-----e3bc25176cf8--------------------------------"><div class="ov ab il"><div class="ow ab co cb ox oy"><h2 class="bf ga ib z it oz iv iw pa iy ja fz bk">Dataflow Architecture-Derived Data Views and Eventual Consistency</h2><div class="pb l"><h3 class="bf b ib z it oz iv iw pa iy ja dx">a (not-so) brief history of a health &amp; fitness data pipeline: part ii</h3></div><div class="gq l"><p class="bf b dy z it oz iv iw pa iy ja dx">towardsdatascience.com</p></div></div><div class="pc l"><div class="tv l pe pf pg pc ph lw ou"/></div></div></a></div><h2 id="dadd" class="pi nu fq bf nv pj pk pl ny pm pn po ob mx pp pq pr nb ps pt pu nf pv pw px fw bk">Find out more on the feature development from my teammates</h2><p id="786d" class="pw-post-body-paragraph mo mp fq mq b gt pz ms mt gw qa mv mw mx qb mz na nb qc nd ne nf qd nh ni nj fj bk"><strong class="mq ga">User insights dashboard</strong></p><div class="op oq or os ot ou"><a href="https://medium.com/siot-govtech/fitness-lover-to-developer-building-a-smartgym-vision-592d92989905?source=post_page-----e3bc25176cf8--------------------------------" rel="noopener follow" target="_blank"><div class="ov ab il"><div class="ow ab co cb ox oy"><h2 class="bf ga ib z it oz iv iw pa iy ja fz bk">Fitness Lover to Developer: Building a SmartGym Vision</h2><div class="pb l"><h3 class="bf b ib z it oz iv iw pa iy ja dx">This is an account of my short yet meaningful internship journey with GovTech’s SmartGym team!</h3></div><div class="gq l"><p class="bf b dy z it oz iv iw pa iy ja dx">medium.com</p></div></div><div class="pc l"><div class="tw l pe pf pg pc ph lw ou"/></div></div></a></div><p id="233d" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk"><strong class="mq ga">Product metrics dashboard</strong></p><div class="op oq or os ot ou"><a href="https://medium.com/siot-govtech/web-development-with-python-really-87e2e39644c8?source=post_page-----e3bc25176cf8--------------------------------" rel="noopener follow" target="_blank"><div class="ov ab il"><div class="ow ab co cb ox oy"><h2 class="bf ga ib z it oz iv iw pa iy ja fz bk">Web development with Python, really?</h2><div class="pb l"><h3 class="bf b ib z it oz iv iw pa iy ja dx">My experience working with an unconventional web development framework: Plotly Dash</h3></div><div class="gq l"><p class="bf b dy z it oz iv iw pa iy ja dx">medium.com</p></div></div><div class="pc l"><div class="tx l pe pf pg pc ph lw ou"/></div></div></a></div><div class="op oq or os ot ou"><a href="https://medium.com/siot-govtech/internship-experience-dont-dash-through-data-analysis-9219e0e15860?source=post_page-----e3bc25176cf8--------------------------------" rel="noopener follow" target="_blank"><div class="ov ab il"><div class="ow ab co cb ox oy"><h2 class="bf ga ib z it oz iv iw pa iy ja fz bk">Internship Experience — Don’t DASH through data analysis</h2><div class="pb l"><h3 class="bf b ib z it oz iv iw pa iy ja dx">An enriching internship journey with the SmartGym team as a data analyst</h3></div><div class="gq l"><p class="bf b dy z it oz iv iw pa iy ja dx">medium.com</p></div></div><div class="pc l"><div class="ty l pe pf pg pc ph lw ou"/></div></div></a></div><p id="c0a7" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk"><strong class="mq ga">Leaderboard and fitness challenge analytics dashboard</strong></p><div class="op oq or os ot ou"><a href="https://medium.com/ytpo-govtech/internship-blog-7b021006e020?source=post_page-----e3bc25176cf8--------------------------------" rel="noopener follow" target="_blank"><div class="ov ab il"><div class="ow ab co cb ox oy"><h2 class="bf ga ib z it oz iv iw pa iy ja fz bk">My Internship in the SmartGym team</h2><div class="pb l"><h3 class="bf b ib z it oz iv iw pa iy ja dx">Introduction</h3></div><div class="gq l"><p class="bf b dy z it oz iv iw pa iy ja dx">medium.com</p></div></div><div class="pc l"><div class="tz l pe pf pg pc ph lw ou"/></div></div></a></div><div class="op oq or os ot ou"><a href="https://medium.com/siot-govtech/dont-throw-darts-in-the-dark-11e3404f8436?source=post_page-----e3bc25176cf8--------------------------------" rel="noopener follow" target="_blank"><div class="ov ab il"><div class="ow ab co cb ox oy"><h2 class="bf ga ib z it oz iv iw pa iy ja fz bk">Don’t throw darts in the dark</h2><div class="pb l"><h3 class="bf b ib z it oz iv iw pa iy ja dx">Introduction</h3></div><div class="gq l"><p class="bf b dy z it oz iv iw pa iy ja dx">medium.com</p></div></div><div class="pc l"><div class="ua l pe pf pg pc ph lw ou"/></div></div></a></div><div class="op oq or os ot ou"><a href="https://medium.com/siot-govtech/my-most-fulfilling-moment-at-smartgym-843819c77432?source=post_page-----e3bc25176cf8--------------------------------" rel="noopener follow" target="_blank"><div class="ov ab il"><div class="ow ab co cb ox oy"><h2 class="bf ga ib z it oz iv iw pa iy ja fz bk">My Most Fulfilling Moment at SmartGym</h2><div class="pb l"><h3 class="bf b ib z it oz iv iw pa iy ja dx">Author: https://medium.com/@dharmil.shah_35509</h3></div><div class="gq l"><p class="bf b dy z it oz iv iw pa iy ja dx">medium.com</p></div></div><div class="pc l"><div class="ub l pe pf pg pc ph lw ou"/></div></div></a></div><p id="d1f1" class="pw-post-body-paragraph mo mp fq mq b gt mr ms mt gw mu mv mw mx my mz na nb nc nd ne nf ng nh ni nj fj bk"><strong class="mq ga">Personalised workout for physiotherapy</strong></p><div class="op oq or os ot ou"><a href="https://medium.com/siot-govtech/designing-an-end-to-end-experience-for-physiotherapist-and-patients-910991042f46?source=post_page-----e3bc25176cf8--------------------------------" rel="noopener follow" target="_blank"><div class="ov ab il"><div class="ow ab co cb ox oy"><h2 class="bf ga ib z it oz iv iw pa iy ja fz bk">Designing an end to end experience for Physiotherapist and Patients</h2><div class="pb l"><h3 class="bf b ib z it oz iv iw pa iy ja dx">Introduction</h3></div><div class="gq l"><p class="bf b dy z it oz iv iw pa iy ja dx">medium.com</p></div></div><div class="pc l"><div class="uc l pe pf pg pc ph lw ou"/></div></div></a></div></div></div></div></div>    
</body>
</html>