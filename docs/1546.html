<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Optimizing Sigma Rules in Spark with the Aho-Corasick Algorithm</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Optimizing Sigma Rules in Spark with the Aho-Corasick Algorithm</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/optimizing-sigma-rules-in-spark-with-the-aho-corasick-algorithm-52ebd5d8105e?source=collection_archive---------9-----------------------#2024-06-20">https://towardsdatascience.com/optimizing-sigma-rules-in-spark-with-the-aho-corasick-algorithm-52ebd5d8105e?source=collection_archive---------9-----------------------#2024-06-20</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="cef2" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx">Extending Spark for improved performance in handling multiple search terms</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hd he hf hg hh ab"><div><div class="ab hi"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@jean-claude.cote?source=post_page---byline--52ebd5d8105e--------------------------------" rel="noopener follow"><div class="l hj hk by hl hm"><div class="l ed"><img alt="Jean-Claude Cote" class="l ep by dd de cx" src="../Images/aea2df9c7b95fc85cc336f64d64b0a76.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/1*ZDeTO2JYRo3sVd9Y_iIQ-w.jpeg"/><div class="hn by l dd de em n ho eo"/></div></div></a></div></div><div class="hp ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--52ebd5d8105e--------------------------------" rel="noopener follow"><div class="l hq hr by hl hs"><div class="l ed"><img alt="Towards Data Science" class="l ep by br ht cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hn by l br ht em n ho eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hu ab q"><div class="ab q hv"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hw hx bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hy" data-testid="authorName" href="https://medium.com/@jean-claude.cote?source=post_page---byline--52ebd5d8105e--------------------------------" rel="noopener follow">Jean-Claude Cote</a></p></div></div></div><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hw hx dx"><button class="ib ic ah ai aj ak al am an ao ap aq ar id ie if" disabled="">Follow</button></p></div></div></span></div></div><div class="l ig"><span class="bf b bg z dx"><div class="ab cn ih ii ij"><div class="ik il ab"><div class="bf b bg z dx ab im"><span class="in l ig">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hy ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--52ebd5d8105e--------------------------------" rel="noopener follow"><p class="bf b bg z io ip iq ir is it iu iv bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">8 min read</span><div class="iw ix l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Jun 20, 2024</span></div></span></div></span></div></div></div><div class="ab cp iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn"><div class="h k w ea eb q"><div class="kd l"><div class="ab q ke kf"><div class="pw-multi-vote-icon ed in kg kh ki"><div class=""><div class="kj kk kl km kn ko kp am kq kr ks ki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kt ku kv kw kx ky kz"><p class="bf b dy z dx"><span class="kk">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kj la lb ab q ee lc ld" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="le"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg></button></div></div></div><div class="ab q jo jp jq jr js jt ju jv jw jx jy jz ka kb kc"><div class="lf k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lg an ao ap id lh li lj" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep lk cn"><div class="l ae"><div class="ab cb"><div class="ll lm ln lo lp lq ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lg an ao ap id lr ls ld lt lu lv lw lx s ly lz ma mb mc md me u mf mg mh"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lg an ao ap id lr ls ld lt lu lv lw lx s ly lz ma mb mc md me u mf mg mh"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lg an ao ap id lr ls ld lt lu lv lw lx s ly lz ma mb mc md me u mf mg mh"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj mk"><img src="../Images/98074b60c52576606b11663ca7212313.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*My8XAM3Pyno9UJrPSThXuA.jpeg"/></div></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">Photo by Aditya Chinchure on Unsplash</figcaption></figure><p id="06e2" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">During the process of deploying our intrusion detection system into production at <a class="af nx" href="https://www.cyber.gc.ca/en" rel="noopener ugc nofollow" target="_blank">CCCS</a>, we observed that many of the SigmaHQ rules use very sizable lists of search patterns. These lists are used to test if a <code class="cx ny nz oa ob b">CommandLine</code>contains a given string or if the <code class="cx ny nz oa ob b">CommandLine</code>starts-with or ends-with a given substring.</p><p id="cd51" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">We were particularly interested in investigating the rules involving “contains” conditions, as we suspected that these conditions might be time-consuming for Spark to evaluate. Here is an example of a typical Sigma rule:</p><pre class="ml mm mn mo mp oc ob od bp oe bb bk"><span id="d041" class="of og fq ob b bg oh oi l oj ok">detection:<br/>    selection_image:<br/>        - Image|contains:<br/>              - '\CVE-202'<br/>              - '\CVE202'<br/>        - Image|endswith:<br/>              - '\poc.exe'<br/>              - '\artifact.exe'<br/>              - '\artifact64.exe'<br/>              - '\artifact_protected.exe'<br/>              - '\artifact32.exe'<br/>              - '\artifact32big.exe'<br/>              - 'obfuscated.exe'<br/>              - 'obfusc.exe'<br/>              - '\meterpreter'<br/>    selection_commandline:<br/>        CommandLine|contains:<br/>            - 'inject.ps1'<br/>            - 'Invoke-CVE'<br/>            - 'pupy.ps1'<br/>            - 'payload.ps1'<br/>            - 'beacon.ps1'<br/>            - 'PowerView.ps1'<br/>            - 'bypass.ps1'<br/>            - 'obfuscated.ps1'</span></pre><p id="41ad" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">The complete Suspicious Program Names rule can be found here<br/><a class="af nx" href="https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_susp_progname.yml" rel="noopener ugc nofollow" target="_blank">https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_susp_progname.yml</a></p><p id="936f" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">The rule illustrates the use of <code class="cx ny nz oa ob b">CommandLine|contains</code> and of <code class="cx ny nz oa ob b">Image|endswith</code>. Some Sigma rules have hundreds of search terms under a <code class="cx ny nz oa ob b">&lt;field&gt;|contains</code>condition.</p><h2 id="e1ee" class="ol og fq bf om on oo op oq or os ot ou nk ov ow ox no oy oz pa ns pb pc pd pe bk">Applying Sigma Rules with Spark SQL</h2><p id="d3d9" class="pw-post-body-paragraph nb nc fq nd b go pf nf ng gr pg ni nj nk ph nm nn no pi nq nr ns pj nu nv nw fj bk">At <a class="af nx" href="https://www.cyber.gc.ca/en" rel="noopener ugc nofollow" target="_blank">CCCS</a>, we translate Sigma rules into executable Spark SQL statements. To do so we have extended the SQL Sigma compiler with a custom backend. It translates the above rule into a statement like this:</p><pre class="ml mm mn mo mp oc ob od bp oe bb bk"><span id="b63c" class="of og fq ob b bg oh oi l oj ok">select<br/>map(<br/>   'Suspicious Program Names',<br/>   (<br/>     (<br/>            (<br/>                Imagepath LIKE '%\\cve-202%'<br/>                OR Imagepath LIKE '%\\cve202%'<br/>            )<br/>            OR (<br/>                Imagepath LIKE '%\\poc.exe'<br/>                OR Imagepath LIKE '%\\artifact.exe'<br/>                ...<br/>                OR Imagepath LIKE '%obfusc.exe'<br/>                OR Imagepath LIKE '%\\meterpreter'<br/>            )<br/>        )<br/>        OR (<br/>            CommandLine LIKE '%inject.ps1%'<br/>            OR CommandLine LIKE '%invoke-cve%'<br/>            OR CommandLine LIKE '%pupy.ps1%'<br/>            ...<br/>            OR CommandLine LIKE '%encode.ps1%'<br/>            OR CommandLine LIKE '%powercat.ps1%'<br/>        )<br/>    )<br/>) as sigma_rules_map</span></pre><p id="298c" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">We run the above statement in a Spark Structured streaming job. In a single pass over the events Spark evaluates multiple (hundreds) of Sigma rules. The <code class="cx ny nz oa ob b">sigma_rules_map</code> column holds the evaluation results of all these rules. Using this map we can determine which rule is a hit and which one is not.</p><p id="3b69" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">As we can see, the rules often involve comparing event’s attribute, such as <code class="cx ny nz oa ob b">CommandLine</code>, to multiple string patterns.</p><p id="7bb5" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">Some of these tests are exact matches, such as <code class="cx ny nz oa ob b">CommandLine = ‘something’</code>. Others use <code class="cx ny nz oa ob b">startswith</code>and are rendered as <code class="cx ny nz oa ob b">Imagepath LIKE ‘%\\poc.exe’</code>.</p><p id="e7da" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk"><code class="cx ny nz oa ob b">Equals</code>, <code class="cx ny nz oa ob b">startswith</code>, and <code class="cx ny nz oa ob b">endswith</code> are executed very rapidly since these conditions are all anchored at a particular position in the event’s attribute.</p><p id="6a92" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">However, tests like <code class="cx ny nz oa ob b">contains</code> are rendered as <code class="cx ny nz oa ob b">CommandLine LIKE ‘%hound.ps1%’</code> which requires Spark to scan the entire attribute to find a possible starting position for the letter ‘h’ and then check if it is followed by the letter ‘o’, ‘u’ etc.</p><p id="1829" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">Internally, Spark uses a <code class="cx ny nz oa ob b">UTF8String</code> which grabs the first character, scans the buffer, and if it finds a match, goes on to compare the remaining bytes using the <code class="cx ny nz oa ob b">matchAt</code> function. Here is the implementation of the <code class="cx ny nz oa ob b">UTF8String.contains</code> function.</p><pre class="ml mm mn mo mp oc ob od bp oe bb bk"><span id="ba25" class="of og fq ob b bg oh oi l oj ok">  public boolean contains(final UTF8String substring) {<br/>    if (substring.numBytes == 0) {<br/>      return true;<br/>    }<br/><br/>    byte first = substring.getByte(0);<br/>    for (int i = 0; i &lt;= numBytes - substring.numBytes; i++) {<br/>      if (getByte(i) == first &amp;&amp; matchAt(substring, i)) {<br/>        return true;<br/>      }<br/>    }<br/>    return false;<br/>  }</span></pre><p id="1c9c" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">The <code class="cx ny nz oa ob b">equals</code>, <code class="cx ny nz oa ob b">startswith</code>, and <code class="cx ny nz oa ob b">endswith</code> conditions also use the <code class="cx ny nz oa ob b">matchAt</code> function but contrary to <code class="cx ny nz oa ob b">contains</code> these conditions know where to start the comparison and thus execute very rapidly.</p><p id="5138" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">To validate our assumption that <code class="cx ny nz oa ob b">contains</code> condition is costly to execute we conducted a quick and simple experiment. We removed all the <code class="cx ny nz oa ob b">contains</code> conditions for the Sigma rules to see how it would impact the overall execution time. The difference was significant and encouraged us to pursue the idea of implementing a custom Spark Catalyst function to handle <code class="cx ny nz oa ob b">contains</code> operations involving large number of search terms.</p><h2 id="d547" class="ol og fq bf om on oo op oq or os ot ou nk ov ow ox no oy oz pa ns pb pc pd pe bk">The Aho-Corasick Algorithm</h2><p id="7671" class="pw-post-body-paragraph nb nc fq nd b go pf nf ng gr pg ni nj nk ph nm nn no pi nq nr ns pj nu nv nw fj bk">A bit of research led us to the <a class="af nx" href="https://en.wikipedia.org/wiki/Aho%E2%80%93Corasick_algorithm" rel="noopener ugc nofollow" target="_blank">Aho-Corasick algorithm</a> which seemed to be a good fit for this use case. The Aho-Corasick algorithm builds a prefix tree (a trie) and can evaluate many <code class="cx ny nz oa ob b">contains</code> expressions in a single pass over the text to be tested.</p><p id="854b" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">Here is how to use the Aho-Corasick Java implementation from Robert Bor available on github here <a class="af nx" href="https://github.com/robert-bor/aho-corasick" rel="noopener ugc nofollow" target="_blank">https://github.com/robert-bor/aho-corasick</a></p><pre class="ml mm mn mo mp oc ob od bp oe bb bk"><span id="ddb4" class="of og fq ob b bg oh oi l oj ok">// create the trie<br/>val triBuilder = Trie.builder()<br/>triBuilder.addKeyword("test1")<br/>triBuilder.addKeyword("test2")<br/>trie = triBuilder.build()<br/><br/>// apply the trie to some text<br/>aTextColumn = "some text to scan for either test1 or test2"<br/>found = trie.containsMatch(aTextColumn)</span></pre><h2 id="1cec" class="ol og fq bf om on oo op oq or os ot ou nk ov ow ox no oy oz pa ns pb pc pd pe bk">Designing a <code class="cx ny nz oa ob b">aho_corasick_in</code> Spark Function</h2><p id="dc84" class="pw-post-body-paragraph nb nc fq nd b go pf nf ng gr pg ni nj nk ph nm nn no pi nq nr ns pj nu nv nw fj bk">Our function will need two things: the column to be tested and the search patterns to look for. We will implement a function with the following signature:</p><pre class="ml mm mn mo mp oc ob od bp oe bb bk"><span id="85ab" class="of og fq ob b bg oh oi l oj ok">boolean aho_corasick_in(string text, array&lt;string&gt; searches)</span></pre><p id="095c" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">We modified our CCCS Sigma compiler to produce SQL statements which use the <code class="cx ny nz oa ob b">aho_corasick_in</code>function rather than producing multiple ORed LIKE predicates. In the output below, you will notice the use of the <code class="cx ny nz oa ob b">aho_corasick_in</code> function. We pass in the field to be tested and an array of strings to search for. Here is the output of our custom compiler handling multiple <code class="cx ny nz oa ob b">contains</code> conditions:</p><pre class="ml mm mn mo mp oc ob od bp oe bb bk"><span id="013c" class="of og fq ob b bg oh oi l oj ok">select <br/>map(<br/>'Suspicious Program Names',<br/>(<br/>    (<br/>        (<br/>            Imagepath LIKE '%\\cve-202%'<br/>            OR Imagepath LIKE '%\\cve202%'<br/>        )<br/>        OR (<br/>            Imagepath LIKE '%\\poc.exe'<br/>            OR Imagepath LIKE '%\\artifact.exe'<br/>            ...<br/>            OR Imagepath LIKE '%\\meterpreter'<br/>        )<br/>    )<br/>    OR (<br/>        aho_corasick_in(<br/>            CommandLine,<br/>            ARRAY(<br/>                'inject.ps1',<br/>                'invoke-cve',<br/>                ...<br/>                'hound.ps1',<br/>                'encode.ps1',<br/>                'powercat.ps1'<br/>            )<br/>        )<br/>    )<br/>)<br/>) as sigma_rules_map</span></pre><p id="9ec4" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">Notice how the <code class="cx ny nz oa ob b">aho_corasick_in </code>function receives two arguments: the first is a column, and the second is a string array. Let’s now actually implement the <code class="cx ny nz oa ob b">aho_corasick_in</code>function.</p><h2 id="9f4f" class="ol og fq bf om on oo op oq or os ot ou nk ov ow ox no oy oz pa ns pb pc pd pe bk">Implementing the Catalyst Function</h2><p id="02b3" class="pw-post-body-paragraph nb nc fq nd b go pf nf ng gr pg ni nj nk ph nm nn no pi nq nr ns pj nu nv nw fj bk">We did not find much documentation on how to implement Catalyst functions, so instead, we used the source code of existing functions as a reference. We took the <a class="af nx" href="https://spark.apache.org/docs/3.3.1/api/sql/index.html#regexp" rel="noopener ugc nofollow" target="_blank">regexp(str, regexp)</a> function as an example because it pre-compiles it’s regexp pattern and then uses it when processing rows. This is similar to pre-building a Aho-Corasick trie and then applying it to every row.</p><p id="8cb5" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">Our custom catalyst expression takes two arguments. It’s thus a <code class="cx ny nz oa ob b">BinaryExpression</code> which has two fields which Spark named <code class="cx ny nz oa ob b">left</code> and <code class="cx ny nz oa ob b">right</code>. Our AhoCorasickIn constructor assigns the <code class="cx ny nz oa ob b">text</code> column argument to <code class="cx ny nz oa ob b">left</code> field and the <code class="cx ny nz oa ob b">searches</code> string array to <code class="cx ny nz oa ob b">right</code> field.</p><p id="461e" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">The other thing we do during the initialization of AhoCorasickIn is to evaluate the <code class="cx ny nz oa ob b">cacheTrie</code> field. The evaluation tests if the <code class="cx ny nz oa ob b">searches</code> argument is a foldable expression, i.e., a constant expression. If so, it evaluates it and expects it to be a string array, which it uses to call <code class="cx ny nz oa ob b">createTrie(searches)</code>.</p><p id="1858" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">The <code class="cx ny nz oa ob b">createTrie</code> function iterates over the searches and adds them to the <code class="cx ny nz oa ob b">trieBuilder</code> and finally builds an Aho-Corasick Trie.</p><pre class="ml mm mn mo mp oc ob od bp oe bb bk"><span id="3660" class="of og fq ob b bg oh oi l oj ok">case class AhoCorasickIn(text: Expression, searches: Expression) <br/>extends BinaryExpression <br/>with CodegenFallback <br/>with ImplicitCastInputTypes <br/>with NullIntolerant <br/>with Predicate {<br/><br/>  override def prettyName: String = "aho_corasick_in"<br/>  // Assign text to left field <br/>  override def left: Expression = text<br/>  // Assign searches to right field <br/>  override def right: Expression = searches<br/><br/>  override def inputTypes: Seq[DataType] = Seq(StringType, ArrayType(StringType))<br/><br/>  // Cache foldable searches expression when AhoCorasickIn is constructed<br/>  private lazy val cacheTrie: Trie = right match {<br/>    case p: Expression if p.foldable =&gt; {<br/>      val searches = p.eval().asInstanceOf[ArrayData]<br/>      createTrie(searches)<br/>    }<br/>    case _ =&gt; null<br/>  }<br/><br/>  protected def createTrie(searches: ArrayData): Trie = {<br/>      val triBuilder = Trie.builder()<br/>      searches.foreach(StringType, (i, s) =&gt; triBuilder.addKeyword(s.toString()))<br/>      triBuilder.build()<br/>  }<br/>  <br/>  protected def getTrie(searches: ArrayData) = if (cacheTrie == null) createTrie(searches) else cacheTrie<br/><br/>  override protected def nullSafeEval(text: Any, searches: Any): Any = {<br/>    val trie = getTrie(searches.asInstanceOf[ArrayData])<br/>    trie.containsMatch(text.asInstanceOf[UTF8String].toString())<br/>  }<br/><br/>  override protected def withNewChildrenInternal(<br/>      newLeft: Expression, newRight: Expression): AhoCorasickIn =<br/>    copy(text = newLeft, searches = newRight)<br/>}</span></pre><p id="2b30" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">The <code class="cx ny nz oa ob b">nullSafeEval</code> method is the heart of the AhoCorasickIn. Spark calls the eval function for every row in the dataset. In <code class="cx ny nz oa ob b">nullSafeEval</code>, we retrieve the <code class="cx ny nz oa ob b">cacheTrie </code>and use it to test the <code class="cx ny nz oa ob b">text</code> string argument.</p><h2 id="5a47" class="ol og fq bf om on oo op oq or os ot ou nk ov ow ox no oy oz pa ns pb pc pd pe bk">Evaluating the Performance</h2><p id="f3e6" class="pw-post-body-paragraph nb nc fq nd b go pf nf ng gr pg ni nj nk ph nm nn no pi nq nr ns pj nu nv nw fj bk">To compare the performance of the <code class="cx ny nz oa ob b">aho_corasick_in </code>function we wrote a small benchmarking script. We compared the performance of doing multiple <code class="cx ny nz oa ob b">LIKE</code> operations versus a single <code class="cx ny nz oa ob b">aho_corasick_in</code> call.</p><pre class="ml mm mn mo mp oc ob od bp oe bb bk"><span id="ade2" class="of og fq ob b bg oh oi l oj ok">select<br/>  *<br/>from (<br/>  select<br/>      text like '%' || uuid() || '%' OR<br/>      text like '%' || uuid() || '%' OR<br/>      text like '%' || uuid() || '%' OR<br/>      ...<br/>      as result<br/>  from (<br/>      select<br/>          uuid()||uuid()||uuid()... as text<br/>      from<br/>          range(0, 1000000, 1, 32)<br/>  )<br/>)<br/>where<br/>    result = TRUE</span></pre><p id="79eb" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">Same experiment using <code class="cx ny nz oa ob b">aho_corasick_in</code>:</p><pre class="ml mm mn mo mp oc ob od bp oe bb bk"><span id="7b7a" class="of og fq ob b bg oh oi l oj ok">select<br/>  *<br/>from (<br/>  select<br/>      aho_corasick_in(text, array(uuid(), uuid(),...) as result<br/>  from (<br/>      select<br/>          uuid()||uuid()||uuid()... as text<br/>      from<br/>          range(0, 1000000, 1, 32)<br/>  )<br/>)<br/>where<br/>    result = TRUE</span></pre><p id="28f5" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">We ran these two experiments (like vs aho_corasick_in) with a <code class="cx ny nz oa ob b">text</code> column of 200 characters and varied the number of search terms. Here is a logarithmic plot comparing both queries.</p><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj pk"><img src="../Images/94880875e041e434766c3b0228141742.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OTIuPIiGiGrcKhYtwHxKNA.png"/></div></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">Image by author</figcaption></figure><p id="bf8b" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">This plot shows how performance degrades as we add more search terms to the “LIKE” query, while the query using <code class="cx ny nz oa ob b">aho_corasick_in</code> function remains relatively constant as the number of search terms increases. At 100 search terms, the <code class="cx ny nz oa ob b">aho_corasick_in</code> function runs five times faster than multiple LIKE statements.</p><p id="9827" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">We find that using Aho-Corasick is only beneficial past 20 searches. This can be explained by the initial cost of building the trie. However, as the number of search terms increases, that up-front cost pays off. This contrasts with the LIKE expressions, where the more LIKE expressions we add, the more costly the query becomes.</p><p id="ac84" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">Next, we set the number of search terms to 20 and varied the length of the <code class="cx ny nz oa ob b">text </code>string. We observed that both the LIKE and <code class="cx ny nz oa ob b">aho_corasick_in</code> function take about the same time across various string lengths. In both experiments the execution time is dependent on the length of the <code class="cx ny nz oa ob b">text </code>string.</p><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj pl"><img src="../Images/0b7c3144a9b0768d338cb65b0bdfaf48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*krkY1gk2yfCcQOZQDmTw6w.png"/></div></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">Image by author</figcaption></figure><p id="7e20" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">It’s important to note that the cost incurred to build the trie will depend on the number of Spark tasks in the query execution plan. Spark instantiates expressions (i.e.: instantiates new AhoCorasickIn objects) for every task in the execution plan. In other words, if your query uses 200 tasks, the AhoCorasickIn constructor will be called 200 times.</p><p id="01f1" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">To summarize, the strategy to use will depend on the number of terms. We built this optimization into our Sigma compiler. Under a given threshold (say 20 terms) it renders LIKE statements and above this threshold it renders a query that uses the <code class="cx ny nz oa ob b">aho_corasick_in</code> function.</p><p id="a600" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">Of course this threshold will be dependent on your actual data and on the number of tasks in your Spark execution plan.</p><p id="e86f" class="pw-post-body-paragraph nb nc fq nd b go ne nf ng gr nh ni nj nk nl nm nn no np nq nr ns nt nu nv nw fj bk">Our initial results, conducted on production data and real SigmaHQ rules, show that applying the <code class="cx ny nz oa ob b">aho_corasick_in</code> function increases our processing rate (events per second) by a factor of 1.4x.</p><figure class="ml mm mn mo mp mq mi mj paragraph-image"><div role="button" tabindex="0" class="mr ms ed mt bh mu"><div class="mi mj pm"><img src="../Images/1a337aa4c3759b640b8597dfd7a047af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A1zqGbP_JLavdt339X85BQ.png"/></div></div><figcaption class="mw mx my mi mj mz na bf b bg z dx">Image by author</figcaption></figure><h2 id="0647" class="ol og fq bf om on oo op oq or os ot ou nk ov ow ox no oy oz pa ns pb pc pd pe bk">Conclusion</h2><p id="108d" class="pw-post-body-paragraph nb nc fq nd b go pf nf ng gr pg ni nj nk ph nm nn no pi nq nr ns pj nu nv nw fj bk">In this article, we demonstrated how to implement a native Spark function. This Catalyst expression leverages the Aho-Corasick algorithm, which can test many search terms simultaneously. However, as with any approach, there are trade-offs. Using Aho-Corasick requires building a trie (prefix tree), which can degrade performance when only a few search terms are used. Our compiler uses a threshold (number of search terms) to choose the optimal strategy, ensuring the most efficient query execution.</p></div></div></div></div>    
</body>
</html>