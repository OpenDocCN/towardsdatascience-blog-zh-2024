<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Ensemble Learning for Anomaly Detection</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Ensemble Learning for Anomaly Detection</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/ensemble-learning-for-anomaly-detection-955efb1b2fac?source=collection_archive---------5-----------------------#2024-10-30">https://towardsdatascience.com/ensemble-learning-for-anomaly-detection-955efb1b2fac?source=collection_archive---------5-----------------------#2024-10-30</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="8de2" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx"><em class="hd">A dive into the isolation forest model to detect anomalies in time-series data</em></h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="he hf hg hh hi ab"><div><div class="ab hj"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@adavis08?source=post_page---byline--955efb1b2fac--------------------------------" rel="noopener follow"><div class="l hk hl by hm hn"><div class="l ed"><img alt="Alex Davis" class="l ep by dd de cx" src="../Images/f773cce9438a68856cb8ba486ac8b051.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/1*T0N-gqDlACyH39JH8hcOdQ@2x.jpeg"/><div class="ho by l dd de em n hp eo"/></div></div></a></div></div><div class="hq ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--955efb1b2fac--------------------------------" rel="noopener follow"><div class="l hr hs by hm ht"><div class="l ed"><img alt="Towards Data Science" class="l ep by br hu cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="ho by l br hu em n hp eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hv ab q"><div class="ab q hw"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hx hy bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hz" data-testid="authorName" href="https://medium.com/@adavis08?source=post_page---byline--955efb1b2fac--------------------------------" rel="noopener follow">Alex Davis</a></p></div></div></div><span class="ia ib" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hx hy dx"><button class="ic id ah ai aj ak al am an ao ap aq ar ie if ig" disabled="">Follow</button></p></div></div></span></div></div><div class="l ih"><span class="bf b bg z dx"><div class="ab cn ii ij ik"><div class="il im ab"><div class="bf b bg z dx ab in"><span class="io l ih">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hz ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--955efb1b2fac--------------------------------" rel="noopener follow"><p class="bf b bg z ip iq ir is it iu iv iw bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="ia ib" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">7 min read</span><div class="ix iy l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Oct 30, 2024</span></div></span></div></span></div></div></div><div class="ab cp iz ja jb jc jd je jf jg jh ji jj jk jl jm jn jo"><div class="h k w ea eb q"><div class="ke l"><div class="ab q kf kg"><div class="pw-multi-vote-icon ed io kh ki kj"><div class=""><div class="kk kl km kn ko kp kq am kr ks kt kj"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l ku kv kw kx ky kz la"><p class="bf b dy z dx"><span class="kl">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kk lb lc ab q ee ld le" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="lf"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg></button></div></div></div><div class="ab q jp jq jr js jt ju jv jw jx jy jz ka kb kc kd"><div class="lg k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lh an ao ap ie li lj lk" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep ll cn"><div class="l ae"><div class="ab cb"><div class="lm ln lo lp lq lr ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lh an ao ap ie ls lt le lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lh an ao ap ie ls lt le lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lh an ao ap ie ls lt le lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><p id="3156" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Anomaly detection is a must-have capability for any organization. By detecting anomalies and outliers, we not only identify data that seems suspicious (or possibly wrong), but can also establish what ‘normal’ data looks like. Anomaly detection can prove to be a vital capability for a strong data governance system by identifying data errors. And for analysis, outliers can be a point of interest in certain cases such as fraud detection and predictive maintenance.</p><p id="df27" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">However, as data grows, anomaly detection can prove more and more difficult. High-dimensional data comes with noise and makes it difficult to use for analysis and insights. Large datasets are also likely to have errors and/or special cases. Thankfully, ensemble learning brings speed and efficiency to help us wrangle high-dimensional data and detect anomalies.</p></div></div></div><div class="ab cb nf ng nh ni" role="separator"><span class="nj by bm nk nl nm"/><span class="nj by bm nk nl nm"/><span class="nj by bm nk nl"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><h1 id="1fef" class="nn no fq bf np nq nr gq ns nt nu gt nv nw nx ny nz oa ob oc od oe of og oh oi bk">What is ensemble learning?</h1><p id="7cdd" class="pw-post-body-paragraph mj mk fq ml b go oj mn mo gr ok mq mr ms ol mu mv mw om my mz na on nc nd ne fj bk">Ensemble learning is a machine learning technique that combines the predictions from multiple individual models to obtain a better predictive performance than any single model. Each model is considered a “weak learner” and is trained on a small subset of the data to make a prediction. Then it goes to a vote. Each weak learner is surveyed and the majority vote wins for the final prediction.</p><figure class="or os ot ou ov ow oo op paragraph-image"><div class="oo op oq"><img src="../Images/68ea0c492fe208b9a5695a9c1515eda7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*gO6DnaAtVWb67Q_w1GKScA.png"/></div><figcaption class="oy oz pa oo op pb pc bf b bg z dx">Image by Wikimedia Commons (<a class="af pd" href="https://commons.wikimedia.org/wiki/File:Random_forest_explain.png" rel="noopener ugc nofollow" target="_blank">https://commons.wikimedia.org/wiki/File:Random_forest_explain.png</a>)</figcaption></figure><p id="4845" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Ensemble models (trained on high-quality data) are robust, accurate, efficient, and are good at avoiding overfitting. They have many use cases such as classification, optimization, and in our case, anomaly detection.</p><h1 id="80fc" class="nn no fq bf np nq pe gq ns nt pf gt nv nw pg ny nz oa ph oc od oe pi og oh oi bk">The Isolation Forest Model</h1><p id="48e3" class="pw-post-body-paragraph mj mk fq ml b go oj mn mo gr ok mq mr ms ol mu mv mw om my mz na on nc nd ne fj bk">The isolation forest model is an ensemble of trees that isolates observations that are few and far between. It is very similar to the popular ‘Random Forest’ model, but instead of a forest of decision trees, the isolation forest produces a forest of ‘isolation trees’.</p><p id="507d" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">So how does it work? Let’s look at one isolation tree.</p><figure class="or os ot ou ov ow oo op paragraph-image"><div role="button" tabindex="0" class="pk pl ed pm bh pn"><div class="oo op pj"><img src="../Images/673e94aca10cdd4218bd7d158965e237.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D7bOp9gBS2h0tn59UxY9xw.png"/></div></div><figcaption class="oy oz pa oo op pb pc bf b bg z dx">Image by the author</figcaption></figure><p id="8054" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Consider the data above. We can see that one data point is farther away from the rest of the data (our suspected anomaly). <strong class="ml fr">Each isolation tree randomly chooses a ‘split value’ to begin to isolate observations. </strong>In this case, the suspected outlier is immediately isolated. This would be the case for most of the isolation trees due to its distance from the rest of the data.</p><figure class="or os ot ou ov ow oo op paragraph-image"><div role="button" tabindex="0" class="pk pl ed pm bh pn"><div class="oo op po"><img src="../Images/6aca0034350e7247a47cbe55fb66a21e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qikQQzqT4JW39uuIKcRCFQ.png"/></div></div><figcaption class="oy oz pa oo op pb pc bf b bg z dx">Image by the author</figcaption></figure><p id="ca3e" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Next, it chooses another split. This time, the suspected ‘normal’ data begins to get cut up. <strong class="ml fr">This process repeats until each observation is isolated.</strong> Ultimately, the model ‘isolates’ observations by randomly selecting a feature and then randomly selecting a split value between the maximum and minimum values of the selected feature.</p><figure class="or os ot ou ov ow oo op paragraph-image"><div role="button" tabindex="0" class="pk pl ed pm bh pn"><div class="oo op pp"><img src="../Images/0ffa29702aebb86c93866eec8b90d6e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-YOGYUFcnxWG-kWUAXQ4HQ.png"/></div></div><figcaption class="oy oz pa oo op pb pc bf b bg z dx">Image by the author</figcaption></figure><p id="7c7f" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Now that each observation is isolated, we need to ask: <strong class="ml fr">How many splits did it take for each observation to be isolated?</strong> In other words, how long is the partition path for each data point? Let’s say the results are the following:</p><figure class="or os ot ou ov ow oo op paragraph-image"><div class="oo op pq"><img src="../Images/e6f94e6695942edff26916a20c5fd124.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/1*RrW32t0-trZG2BziEuHnyw.png"/></div><figcaption class="oy oz pa oo op pb pc bf b bg z dx">Image by the author</figcaption></figure><p id="ffde" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Now that we know how many splits it took to isolate each observation, we calculate the mean number of splits. In our example, on average, it takes 2.6 splits to isolate an observation. <strong class="ml fr">Observations that have a noticeably shorter partition path, or took noticeably less splits to be isolated, are highly likely to be anomalies or outliers. </strong>The degree to which they differ from the mean number of splits is a parameter in the model. Finally, the isolation tree determines the observation G is an anomaly.</p><p id="7128" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk"><strong class="ml fr">The last step of the isolation forest model is for each isolation tree to ‘vote’ on which observations are anomalies.</strong> If a majority of them think that observation G is an anomaly, then the model determines that it is.</p></div></div></div><div class="ab cb nf ng nh ni" role="separator"><span class="nj by bm nk nl nm"/><span class="nj by bm nk nl nm"/><span class="nj by bm nk nl"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><h1 id="4306" class="nn no fq bf np nq nr gq ns nt nu gt nv nw nx ny nz oa ob oc od oe of og oh oi bk">Detecting Anomalies in Time Series Data</h1><p id="8b20" class="pw-post-body-paragraph mj mk fq ml b go oj mn mo gr ok mq mr ms ol mu mv mw om my mz na on nc nd ne fj bk">Lets see a simple example using the isolation forest model to detect anomalies in time-series data. Below, we have imported a sales data set that contains the day of an order, information about the product, geographical information about the customer, and the amount of the sale. To keep this example simple, lets just look at one feature (sales) over time.</p><p id="3e66" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk"><em class="pr">See data here: </em><a class="af pd" href="https://www.kaggle.com/datasets/rohitsahoo/sales-forecasting" rel="noopener ugc nofollow" target="_blank"><em class="pr">https://www.kaggle.com/datasets/rohitsahoo/sales-forecasting</em></a><em class="pr"> (GPL 2.0)</em></p><pre class="or os ot ou ov ps pt pu bp pv bb bk"><span id="62ba" class="pw no fq pt b bg px py l pz qa">#packages for data manipulation<br/>import pandas as pd<br/>from datetime import datetime<br/><br/>#packages for modeling<br/>from sklearn.ensemble import IsolationForest<br/><br/>#packages for data visualization<br/>import matplotlib.pyplot as plt</span></pre><pre class="qb ps pt pu bp pv bb bk"><span id="b0f9" class="pw no fq pt b bg px py l pz qa">#import sales data<br/>sales = pd.read_excel("Data/Sales Data.xlsx")<br/><br/>#subset to date and sales<br/>revenue = sales[['Order Date', 'Sales']]<br/>revenue.head()</span></pre><figure class="or os ot ou ov ow oo op paragraph-image"><div class="oo op qc"><img src="../Images/78621fd24438dc0ad35003bbcd78ff71.png" data-original-src="https://miro.medium.com/v2/resize:fit:404/format:webp/1*YC0cLfPNdi8vMly2DBankg.png"/></div><figcaption class="oy oz pa oo op pb pc bf b bg z dx">Image by the author</figcaption></figure><p id="a069" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">As you can see above, we have the total sale amount for every order on a particular day. Since we have a sufficient amount of data (4 years worth), let’s try to detect months where the total sales is either noticeably higher or lower than the expected total sales.</p><p id="2e4e" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">First, we need to conduct some preprocessing, and sum the sales for every month. Then, visualize monthly sales.</p><pre class="or os ot ou ov ps pt pu bp pv bb bk"><span id="84cd" class="pw no fq pt b bg px py l pz qa">#format the order date to datetime month and year<br/>revenue['Order Date'] = pd.to_datetime(revenue['Order Date'],format='%Y-%m').dt.to_period('M')<br/><br/>#sum sales by month and year<br/>revenue = revenue.groupby(revenue['Order Date']).sum()<br/><br/>#set date as index<br/>revenue.index = revenue.index.strftime('%m-%Y')</span></pre><pre class="qb ps pt pu bp pv bb bk"><span id="cb79" class="pw no fq pt b bg px py l pz qa">#set the fig size<br/>plt.figure(figsize=(8, 5))<br/><br/>#create the line chart<br/>plt.plot(revenue['Order Date'],<br/>         revenue['Sales'])<br/><br/>#add labels and a title<br/>plt.xlabel('Moth')<br/>plt.ylabel('Total Sales')<br/>plt.title('Monthly Sales')<br/><br/>#rotate x-axis labels by 45 degrees for better visibility<br/>plt.xticks(rotation = 90)<br/><br/>#display the chart<br/>plt.show()</span></pre><figure class="or os ot ou ov ow oo op paragraph-image"><div role="button" tabindex="0" class="pk pl ed pm bh pn"><div class="oo op qd"><img src="../Images/af77b3a53519ce3fe0cc456da4e61675.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*doYdoY8pvmKzLbog8kwuSg.png"/></div></div><figcaption class="oy oz pa oo op pb pc bf b bg z dx">Image by the author</figcaption></figure><p id="7ba7" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Using the line chart above, we can see that while sales fluctuates from month-to-month, total sales trends upward over time. Ideally, our model will identify months where total sales fluctuates more that expected and is highly influential to our overall trend.</p><p id="1929" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Now we need to initialize and fit our model. The model below uses the default parameters. I have highlighted these parameters as they are the most important to the model’s performance.</p><ul class=""><li id="897b" class="mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne qe qf qg bk"><strong class="ml fr">n_estimators</strong>: The number of base estimators in the ensemble.</li><li id="827a" class="mj mk fq ml b go qh mn mo gr qi mq mr ms qj mu mv mw qk my mz na ql nc nd ne qe qf qg bk"><strong class="ml fr">max_samples</strong>: The number of samples to draw from X to train each base estimator (if “auto”, then <code class="cx qm qn qo pt b">max_samples = min(256, n_samples)).</code></li><li id="9bd0" class="mj mk fq ml b go qh mn mo gr qi mq mr ms qj mu mv mw qk my mz na ql nc nd ne qe qf qg bk"><strong class="ml fr">contamination</strong>: The amount of contamination of the data set, i.e. the proportion of outliers in the data set. Used when fitting to define the threshold on the scores of the samples.</li><li id="5a55" class="mj mk fq ml b go qh mn mo gr qi mq mr ms qj mu mv mw qk my mz na ql nc nd ne qe qf qg bk"><strong class="ml fr">max_features</strong>: The number of features to draw from X to train each base estimator.</li></ul><pre class="or os ot ou ov ps pt pu bp pv bb bk"><span id="34dd" class="pw no fq pt b bg px py l pz qa">#set isolation forest model and fit to the sales<br/>model = IsolationForest(n_estimators = 100, max_samples = 'auto', contamination = float(0.1), max_features = 1.0)<br/>model.fit(revenue[['Sales']])</span></pre><p id="832f" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Next, lets use the model to display the anomalies and their anomaly score. The anomaly score is the mean measure of normality of an observation among the base estimators. The lower the score, the more abnormal the observation. Negative scores represent outliers, positive scores represent inliers.</p><pre class="or os ot ou ov ps pt pu bp pv bb bk"><span id="c31e" class="pw no fq pt b bg px py l pz qa">#add anomaly scores and prediction<br/>revenue['scores'] = model.decision_function(revenue[['Sales']])<br/>revenue['anomaly'] = model.predict(revenue[['Sales']])</span></pre><figure class="or os ot ou ov ow oo op paragraph-image"><div class="oo op qp"><img src="../Images/ca56501e9d6e920ba5ccf90664793ca8.png" data-original-src="https://miro.medium.com/v2/resize:fit:784/format:webp/1*Lm97yrPNG1NMBOZp2Qs-TA.png"/></div><figcaption class="oy oz pa oo op pb pc bf b bg z dx">Image by the author</figcaption></figure><p id="ee93" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Lastly, lets bring up the same line chart from before, but highlighting the anomalies with plt.scatter.</p><figure class="or os ot ou ov ow oo op paragraph-image"><div role="button" tabindex="0" class="pk pl ed pm bh pn"><div class="oo op qq"><img src="../Images/4f5c5e6e39a801c2abed486f849e43b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qYiDpKPsZbVqyCe49MaD_g.png"/></div></div><figcaption class="oy oz pa oo op pb pc bf b bg z dx">Image by the author</figcaption></figure><p id="3e2a" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">The model appears to do well. Since the data fluctuates so much month-to-month, a worry could be that inliers would get marked as anomalies, but this is not the case due to the <strong class="ml fr">bootstrap sampling of the model</strong>. The anomalies appear to be the larger fluctuations where sales deviated from the trend a ‘significant’ amount.</p><p id="386a" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">However, knowing the data is important here as some of the anomalies should come with a caveat. Let’s look at the first (February 2015) and last (November 2018) anomaly detected. At first, we see that they both are large fluctuations from the mean.</p><p id="d986" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">However, the first anomaly (February 2015) is only our second month of recording sales and the business may have just started operating. Sales are definitely low, and we see a large spike the next month. But is it fair to mark the second month of business an anomaly because sales were low? Or is this the norm for a new business?</p><p id="855f" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">For our last anomaly (November 2018), we see a huge spike in sales that appears to deviate from the overall trend. However, we have run out of data. As data continues to be recorded, it may not have been an anomaly, but perhaps an identifier of a steeper upwards trend.</p></div></div></div><div class="ab cb nf ng nh ni" role="separator"><span class="nj by bm nk nl nm"/><span class="nj by bm nk nl nm"/><span class="nj by bm nk nl"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><h2 id="81ec" class="qr no fq bf np qs qt qu ns qv qw qx nv ms qy qz ra mw rb rc rd na re rf rg rh bk">Conclusion</h2><p id="cf12" class="pw-post-body-paragraph mj mk fq ml b go oj mn mo gr ok mq mr ms ol mu mv mw om my mz na on nc nd ne fj bk">In conclusion, anomaly detection is a must-have capability for both strong data governance and rigorous analysis. While detecting outliers and anomalies in large data can be difficult, ensemble learning methods can help as they are robust and efficient with large, tabular data.</p><p id="a40e" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">The isolation forest model detects these anomalies by for using a forest of ‘weak learners’ to isolate observations that are few and far between.</p></div></div></div><div class="ab cb nf ng nh ni" role="separator"><span class="nj by bm nk nl nm"/><span class="nj by bm nk nl nm"/><span class="nj by bm nk nl"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="4938" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk"><em class="pr">I hope you have enjoyed my article! Please feel free to comment, ask questions, or request other topics.</em></p></div></div></div></div>    
</body>
</html>