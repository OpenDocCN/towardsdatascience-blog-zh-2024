<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Using Poetry and Docker to Package Your Model for AWS Lambda</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Using Poetry and Docker to Package Your Model for AWS Lambda</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/using-poetry-and-docker-to-package-your-model-for-aws-lambda-cd6d448eb88f?source=collection_archive---------1-----------------------#2024-01-29">https://towardsdatascience.com/using-poetry-and-docker-to-package-your-model-for-aws-lambda-cd6d448eb88f?source=collection_archive---------1-----------------------#2024-01-29</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="170d" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx">An accessible tutorial for one way to put a model into production, with special focus on troubleshooting and hiccups you might encounter along the way</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hd he hf hg hh ab"><div><div class="ab hi"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@s.kirmer?source=post_page---byline--cd6d448eb88f--------------------------------" rel="noopener follow"><div class="l hj hk by hl hm"><div class="l ed"><img alt="Stephanie Kirmer" class="l ep by dd de cx" src="../Images/f9d9ef9167febde974c223dd4d8d6293.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/1*XfYW5J2d0piz2Ydzna6rnQ.jpeg"/><div class="hn by l dd de em n ho eo"/></div></div></a></div></div><div class="hp ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--cd6d448eb88f--------------------------------" rel="noopener follow"><div class="l hq hr by hl hs"><div class="l ed"><img alt="Towards Data Science" class="l ep by br ht cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hn by l br ht em n ho eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hu ab q"><div class="ab q hv"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hw hx bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hy" data-testid="authorName" href="https://medium.com/@s.kirmer?source=post_page---byline--cd6d448eb88f--------------------------------" rel="noopener follow">Stephanie Kirmer</a></p></div></div></div><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hw hx dx"><button class="ib ic ah ai aj ak al am an ao ap aq ar id ie if" disabled="">Follow</button></p></div></div></span></div></div><div class="l ig"><span class="bf b bg z dx"><div class="ab cn ih ii ij"><div class="ik il ab"><div class="bf b bg z dx ab im"><span class="in l ig">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hy ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--cd6d448eb88f--------------------------------" rel="noopener follow"><p class="bf b bg z io ip iq ir is it iu iv bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">10 min read</span><div class="iw ix l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Jan 29, 2024</span></div></span></div></span></div></div></div><div class="ab cp iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn"><div class="h k w ea eb q"><div class="kd l"><div class="ab q ke kf"><div class="pw-multi-vote-icon ed in kg kh ki"><div class=""><div class="kj kk kl km kn ko kp am kq kr ks ki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kt ku kv kw kx ky kz"><p class="bf b dy z dx"><span class="kk">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kj lc ld ab q ee le lf" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="lb"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg><p class="bf b dy z dx"><span class="pw-responses-count la lb">1</span></p></button></div></div></div><div class="ab q jo jp jq jr js jt ju jv jw jx jy jz ka kb kc"><div class="lg k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lh an ao ap id li lj lk" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep ll cn"><div class="l ae"><div class="ab cb"><div class="lm ln lo lp lq lr ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk ml"><img src="../Images/b8ca1c71ddc8ebed25afbc74ed0a12b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*wXiqXtIm8_yR-41m"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">I like to think of models as little critters. Photo by <a class="af nc" href="https://unsplash.com/@jiaweizhao?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Jiawei Zhao</a> on <a class="af nc" href="https://unsplash.com/?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><p id="fa24" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">As promised, this week I’m coming with a more technical topic and taking a little break from all the discussions of business. I recently had an opportunity to deploy a new model using AWS Lambda, and I learned a few things when combining my usual development tooling (Poetry) with the infrastructure of Lambda. (Big hat tip to my teammate Aaron for teaching me new stuff!) I’m going to walk through the less obvious steps to getting a locally trained model deployed to Lambda successfully.</p><blockquote class="nz oa ob"><p id="1de8" class="nd ne oc nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">For my regular readers who are not interested in the nuts and bolts of model development, fear not, I’ll be back to commenting on social issues and machine learning next time!</p></blockquote><h1 id="7a72" class="od oe fq bf of og oh gq oi oj ok gt ol om on oo op oq or os ot ou ov ow ox oy bk">Setting up your model architecture</h1><p id="f8e0" class="pw-post-body-paragraph nd ne fq nf b go oz nh ni gr pa nk nl nm pb no np nq pc ns nt nu pd nw nx ny fj bk">If you don’t already have a preferred package manager/environment manager tool in Python, let me make a case for Poetry. It took me a while to get started and get the hang of it, but I’ve been using it for a couple of years now and have become a real fan. Some folks prefer venv or other more bare bones tooling, which is fine, but Poetry has some nice extra features that I think are worth it. (If you don’t have any experience with Poetry, please visit the official docs at <a class="af nc" href="https://python-poetry.org/" rel="noopener ugc nofollow" target="_blank">https://python-poetry.org/</a> and they can get you set up.)</p><p id="171d" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">One of the selling points I’d like to emphasize is that Poetry makes it quite easy to package your project so that internal modules you create are callable without a lot of fuss. This means that you don’t have to fight the “Python says that module doesn’t exist” battle that I’m sure many of us are familiar with.</p><p id="2685" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">The example embedded here is just the head of the pyproject.toml file for a project like this one — notice the line starting with <code class="cx pe pf pg ph b">packages</code> telling this env to include the package I’m creating in its imports. This is what lets me call things like <code class="cx pe pf pg ph b">from new_package.tools import stuff</code> anywhere inside this project, even if those things are not in the immediate parent directory or whatever.</p><pre class="mm mn mo mp mq pi ph pj bp pk bb bk"><span id="792f" class="pl oe fq ph b bg pm pn l po pp">[tool.poetry]<br/>name = "new_package"<br/>version = "0.1.0"<br/>description = "What this package is gonna do"<br/>authors = [<br/>    "Stephanie Kirmer &lt;stephanie@stephaniekirmer.com&gt;",<br/>]<br/><br/>packages = [{ include = "new_package"}]<br/>include = [{ path = "tests", format = "sdist" }]<br/><br/>[build-system]<br/>requires = ["poetry-core&gt;=1.0.0"]<br/>build-backend = "poetry.core.masonry.api"<br/><br/># Requirements<br/>[tool.poetry.dependencies]<br/>python = "&gt;=3.9, &lt;4.0"</span></pre><p id="e4d9" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Assuming you’re sold on Poetry, then you can use this to define your environment and manage all your dependencies, and you’ll be developing your model and its pipelines inside that project. Go ahead and build and train your model, and come back when that bit is done. I’ll wait.</p></div></div></div><div class="ab cb pq pr ps pt" role="separator"><span class="pu by bm pv pw px"/><span class="pu by bm pv pw px"/><span class="pu by bm pv pw"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="3f33" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Ok, welcome back! Because you know you’re going to be deploying this model through Docker in Lambda, that dictates how your inference pipeline should be structured.</p><p id="d029" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">You need to construct a “handler”. What is that, exactly? It’s just a function that accepts the JSON object that is passed to the Lambda, and it returns whatever your model’s results are, again in a JSON payload. So, everything your inference pipeline is going to do needs to be called inside this function.</p><p id="f8f5" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">In the case of my project, I’ve got a whole codebase of feature engineering functions: mountains of stuff involving semantic embeddings, a bunch of aggregations, regexes, and more. I’ve consolidated them into a <code class="cx pe pf pg ph b">FeatureEngineering</code> class, which has a bunch of private methods but just one public one, <code class="cx pe pf pg ph b">feature_eng</code>. So starting from the JSON that is being passed to the model, that method can run all the steps required to get the data from “raw” to “features”. I like setting up this way because it abstracts away a lot of complexity from the handler function itself. I can literally just call:</p><pre class="mm mn mo mp mq pi ph pj bp pk bb bk"><span id="c4f8" class="pl oe fq ph b bg pm pn l po pp">fe = FeatureEngineering(input=json_object)<br/>processed_features = fe.feature_eng()</span></pre><p id="325f" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">And I’m off to the races, my features come out clean and ready to go.</p><blockquote class="nz oa ob"><p id="42e0" class="nd ne oc nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Be advised: I have written exhaustive unit tests on all the inner guts of this class because while it is neat to write it this way, I still need to be extremely conscious of any changes that might occur under the hood. Write your unit tests! If you make one small change, you may not be able to immediately tell you’ve broken something in the pipeline until it’s already causing problems.</p></blockquote><p id="089e" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">The second half is the inference work, and this is a separate class in my case. I’ve gone for a very similar approach, which just takes in a few arguments.</p><pre class="mm mn mo mp mq pi ph pj bp pk bb bk"><span id="98a3" class="pl oe fq ph b bg pm pn l po pp">ps = PredictionStage(features=processed_features)<br/>predictions = ps.predict(<br/>    feature_file="feature_set.json",<br/>    model_file="classifier",<br/>)</span></pre><p id="fbc4" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">The class initialization accepts the result of the feature engineering class’s method, so that handshake is clearly defined. Then the prediction method takes two items: the feature set (a JSON file listing all the feature names) and the model object, in my case a CatBoost classifier I’ve already trained and saved. I’m using the native CatBoost save method, but whatever you use and whatever model algorithm you use is fine. The point is that this method abstracts away a bunch of underlying stuff, and neatly returns the <code class="cx pe pf pg ph b">predictions</code> object, which is what my Lambda is going to give you when it runs.</p><p id="2a47" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">So, to recap, my “handler” function is essentially just this:</p><pre class="mm mn mo mp mq pi ph pj bp pk bb bk"><span id="840c" class="pl oe fq ph b bg pm pn l po pp">def lambda_handler(json_object, _context):<br/><br/>  fe = FeatureEngineering(input=json_object)<br/>  processed_features = fe.feature_eng()<br/><br/>  ps = PredictionStage(features=processed_features)<br/>  predictions = ps.predict(<br/>      feature_file="feature_set.json",<br/>      model_file="classifier",<br/>  )<br/><br/>  return predictions.to_dict("records")</span></pre><p id="a004" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Nothing more to it! You might want to add some controls for malformed inputs, so that if your Lambda gets an empty JSON, or a list, or some other weird stuff it’s ready, but that’s not required. Do make sure your output is in JSON or similar format, however (here I’m giving back a dict).</p><h1 id="181d" class="od oe fq bf of og oh gq oi oj ok gt ol om on oo op oq or os ot ou ov ow ox oy bk">Building your Docker image</h1><p id="a1e6" class="pw-post-body-paragraph nd ne fq nf b go oz nh ni gr pa nk nl nm pb no np nq pc ns nt nu pd nw nx ny fj bk">This is all great, we have a Poetry project with a fully defined environment and all the dependencies, as well as the ability to load the modules we create, etc. Good stuff. But now we need to translate that into a Docker image that we can put on AWS.</p><p id="9cf1" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Here I’m showing you a skeleton of the dockerfile for this situation. First, we’re pulling from AWS to get the right base image for Lambda. Next, we need to set up the file structure that will be used inside the Docker image. This may or may not be exactly like what you’ve got in your Poetry project — mine is not, because I’ve got a bunch of extra junk here and there that isn’t necessary for the prod inference pipeline, including my training code. I just need to put the inference stuff in this image, that’s all.</p><p id="88c4" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk"><em class="oc">The beginning of the dockerfile</em></p><pre class="mm mn mo mp mq pi ph pj bp pk bb bk"><span id="f0db" class="pl oe fq ph b bg pm pn l po pp">FROM public.ecr.aws/lambda/python:3.9<br/><br/>ARG YOUR_ENV<br/>ENV NLTK_DATA=/tmp<br/>ENV HF_HOME=/tmp<br/></span></pre><p id="33bb" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">In this project, anything you copy over is going to live in a <code class="cx pe pf pg ph b">/tmp</code> folder, so if you have packages in your project that are going to try and save data at any point, you need to direct them to the right place.</p><p id="134e" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">You also need to make sure that Poetry gets installed right in your Docker image- that’s what will make all your carefully curated dependencies work right. Here I’m setting the version and telling <code class="cx pe pf pg ph b">pip</code> to install Poetry before we go any further.</p><pre class="mm mn mo mp mq pi ph pj bp pk bb bk"><span id="dcc4" class="pl oe fq ph b bg pm pn l po pp">ENV YOUR_ENV=${YOUR_ENV} \<br/>  POETRY_VERSION=1.7.1<br/>ENV SKIP_HACK=true<br/><br/>RUN pip install "poetry==$POETRY_VERSION"<br/></span></pre><p id="376a" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">The next issue is making sure all the files and folders your project uses locally get added to this new image correctly — Docker copy will irritatingly flatten directories sometimes, so if you get this built and start seeing “module not found” issues, check to make sure that isn’t happening to you. Hint: add <code class="cx pe pf pg ph b">RUN ls -R</code> to the dockerfile once it’s all copied to see what the directory is looking like. You’ll be able to view those logs in Docker and it might reveal any issues.</p><p id="622f" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Also, make sure you copy everything you need! That includes the Lambda file, your Poetry files, your feature list file, and your model. All of this is going to be needed unless you store these elsewhere, like on S3, and make the Lambda download them on the fly. (That’s a perfectly reasonable strategy for developing something like this, but not what we’re doing today.)</p><pre class="mm mn mo mp mq pi ph pj bp pk bb bk"><span id="5540" class="pl oe fq ph b bg pm pn l po pp">WORKDIR ${LAMBDA_TASK_ROOT}<br/><br/>COPY /poetry.lock ${LAMBDA_TASK_ROOT}<br/>COPY /pyproject.toml ${LAMBDA_TASK_ROOT}<br/>COPY /new_package/lambda_dir/lambda_function.py ${LAMBDA_TASK_ROOT}<br/>COPY /new_package/preprocessing ${LAMBDA_TASK_ROOT}/new_package/preprocessing<br/>COPY /new_package/tools ${LAMBDA_TASK_ROOT}/new_package/tools<br/>COPY /new_package/modeling/feature_set.json ${LAMBDA_TASK_ROOT}/new_package<br/>COPY /data/models/classifier ${LAMBDA_TASK_ROOT}/new_package</span></pre><p id="ac25" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">We’re almost done! The last thing you should do is actually install your Poetry environment and then set up your handler to run. There are a couple of important flags here, including <code class="cx pe pf pg ph b">--no-dev</code> , which tells Poetry not to add any developer tools you have in your environment, perhaps like pytest or black.</p><p id="3515" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk"><em class="oc">The end of the dockerfile</em></p><pre class="mm mn mo mp mq pi ph pj bp pk bb bk"><span id="2c27" class="pl oe fq ph b bg pm pn l po pp">RUN poetry config virtualenvs.create false<br/>RUN poetry install --no-dev<br/><br/>CMD [ "lambda_function.lambda_handler" ]</span></pre><p id="a219" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">That’s it, you’ve got your dockerfile! Now it’s time to build it.</p><ol class=""><li id="8cc9" class="nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny py pz qa bk">Make sure Docker is installed and running on your computer. This may take a second but it won’t be too difficult.</li><li id="82ef" class="nd ne fq nf b go qb nh ni gr qc nk nl nm qd no np nq qe ns nt nu qf nw nx ny py pz qa bk">Go to the directory where your dockerfile is, which should be the the top level of your project, and run <code class="cx pe pf pg ph b">docker build .</code> Let Docker do its thing and then when it’s completed the build, it will stop returning messages. You can see in the Docker application console if it’s built successfully.</li><li id="7856" class="nd ne fq nf b go qb nh ni gr qc nk nl nm qd no np nq qe ns nt nu qf nw nx ny py pz qa bk">Go back to the terminal and run <code class="cx pe pf pg ph b">docker image ls</code> and you’ll see the new image you’ve just built, and it’ll have an ID number attached.</li><li id="fa9c" class="nd ne fq nf b go qb nh ni gr qc nk nl nm qd no np nq qe ns nt nu qf nw nx ny py pz qa bk">From the terminal once again, run <code class="cx pe pf pg ph b">docker run -p 9000:8080 IMAGE ID NUMBER</code> with your ID number from step 3 filled in. Now your Docker image will start to run!</li><li id="9a39" class="nd ne fq nf b go qb nh ni gr qc nk nl nm qd no np nq qe ns nt nu qf nw nx ny py pz qa bk">Open a new terminal (Docker is attached to your old window, just leave it there), and you can pass something to your Lambda, now running via Docker. I personally like to put my inputs into a JSON file, such as <code class="cx pe pf pg ph b">lambda_cases.json</code> , and run them like so:</li></ol><pre class="mm mn mo mp mq pi ph pj bp pk bb bk"><span id="8727" class="pl oe fq ph b bg pm pn l po pp">curl -d @lambda_cases.json http://localhost:9000/2015-03-31/functions/function/invocations</span></pre><p id="62c6" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">If the result at the terminal is the model’s predictions, then you’re ready to rock. If not, check out the errors and see what might be amiss. Odds are, you’ll have to debug a little and work out some kinks before this is all running smoothly, but that’s all part of the process.</p><h1 id="4a02" class="od oe fq bf of og oh gq oi oj ok gt ol om on oo op oq or os ot ou ov ow ox oy bk">Deploying to AWS and testing</h1><p id="28d3" class="pw-post-body-paragraph nd ne fq nf b go oz nh ni gr pa nk nl nm pb no np nq pc ns nt nu pd nw nx ny fj bk">The next stage will depend a lot on your organization’s setup, and I’m not a devops expert, so I’ll have to be a little bit vague. Our system uses the AWS Elastic Container Registry (ECR) to store the built Docker image and Lambda accesses it from there.</p><p id="7c61" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">When you are fully satisfied with the Docker image from the previous step, you’ll need to build one more time, using the format below. The first flag indicates the platform you’re using for Lambda. (Put a pin in that, it’s going to come up again later.) The item after the -t flag is the path to where your AWS ECR images go- fill in your correct account number, region, and project name.</p><pre class="mm mn mo mp mq pi ph pj bp pk bb bk"><span id="4eaa" class="pl oe fq ph b bg pm pn l po pp">docker build . --platform=linux/arm64 -t accountnumber.dkr.ecr.us-east-1.amazonaws.com/your_lambda_project:latest</span></pre><p id="a37a" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">After this, you should authenticate to an Amazon ECR registry in your terminal, probably using the command <code class="cx pe pf pg ph b">aws ecr get-login-password</code> and using the appropriate flags.</p><p id="3351" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Finally, you can push your new Docker image up to ECR:</p><pre class="mm mn mo mp mq pi ph pj bp pk bb bk"><span id="ade3" class="pl oe fq ph b bg pm pn l po pp">docker push accountnumber.dkr.ecr.us-east-1.amazonaws.com/your_lambda_project:latest</span></pre><p id="cf04" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">If you’ve authenticated correctly, this should only take a moment.</p><p id="52af" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">There’s one more step before you’re ready to go, and that is setting up the Lambda in the AWS UI. Go log in to your AWS account, and find the “Lambda” product.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk qg"><img src="../Images/a8aceb40567bd62e48f5f1e4c3ead919.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uT8h8_80IyQyRyF_4Hg-Sw.png"/></div></div><figcaption class="mx my mz mj mk na nb bf b bg z dx">This is what the header will look like, more or less.</figcaption></figure><p id="a6aa" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Pop open the lefthand menu, and find “Functions”.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk qh"><img src="../Images/0c7f02a7e00298f337b81be7f5f4231e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1ZHE1gtfQfyJym1x3jiCgQ.png"/></div></div></figure><p id="96ea" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">This is where you’ll go to find your specific project. If you have not set up a Lambda yet, hit “Create Function” and follow the instructions to create a new function based on your container image.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk qi"><img src="../Images/453e48f74497877e8ccac974650a246a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0_-Xjj0ysqTgOROVvv7mJQ.png"/></div></div></figure><p id="2a72" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">If you’ve already created a function, go find that one. From there, all you need to do is hit “Deploy New Image”. Regardless of whether it’s a whole new function or just a new image, make sure you select the platform that matches what you did in your Docker build! (Remember that pin?)</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk qj"><img src="../Images/d2f098b237ed6bda29063376158629d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4Y9AA-WMs3mTtjvHvLsC0w.png"/></div></div></figure><p id="0188" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">The last task, and the reason I’ve carried on explaining up to this stage, is to test your image in the actual Lambda environment. This can turn up bugs you didn’t encounter in your local tests! Flip to the Test tab and create a new test by inputting a JSON body that reflects what your model is going to be seeing in production. Run the test, and make sure your model does what is intended.</p><figure class="mm mn mo mp mq mr mj mk paragraph-image"><div role="button" tabindex="0" class="ms mt ed mu bh mv"><div class="mj mk qk"><img src="../Images/8b58fe5e55653bc190ed6c0194b318d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HV6XTkGbmNI-ku7wz6QWAg.png"/></div></div></figure><p id="d35f" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">If it works, then you did it! You’ve deployed your model. Congratulations!</p><h1 id="8982" class="od oe fq bf of og oh gq oi oj ok gt ol om on oo op oq or os ot ou ov ow ox oy bk">Troubleshooting</h1><p id="5152" class="pw-post-body-paragraph nd ne fq nf b go oz nh ni gr pa nk nl nm pb no np nq pc ns nt nu pd nw nx ny fj bk">There are a number of possible hiccups that may show up here, however. But don’t panic, if you have an error! There are solutions.</p><ul class=""><li id="58a3" class="nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny ql pz qa bk">If your Lambda runs out of memory, go to the Configurations tab and increase the memory.</li><li id="cf5f" class="nd ne fq nf b go qb nh ni gr qc nk nl nm qd no np nq qe ns nt nu qf nw nx ny ql pz qa bk">If the image didn’t work because it’s too large (10GB is the max), go back to the Docker building stage and try to cut down the size of the contents. Don’t package up extremely large files if the model can do without them. At worst, you may need to save your model to S3 and have the function load it.</li><li id="1919" class="nd ne fq nf b go qb nh ni gr qc nk nl nm qd no np nq qe ns nt nu qf nw nx ny ql pz qa bk">If you have trouble navigating AWS, you’re not the first. Consult with your IT or Devops team to get help. Don’t make a mistake that will cost your company lots of money!</li><li id="ce69" class="nd ne fq nf b go qb nh ni gr qc nk nl nm qd no np nq qe ns nt nu qf nw nx ny ql pz qa bk">If you have another issue not mentioned, please post a comment and I’ll do my best to advise.</li></ul><p id="1f70" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Good luck, happy modeling!</p></div></div></div><div class="ab cb pq pr ps pt" role="separator"><span class="pu by bm pv pw px"/><span class="pu by bm pv pw px"/><span class="pu by bm pv pw"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="acd6" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">Upcoming talks: I will be speaking remotely about data science career trajectories to the <a class="af nc" href="https://ocair.org/" rel="noopener ugc nofollow" target="_blank">Overseas Chinese Association for Institutional Research (OCAIR)</a> on Friday, April 12, at 1 pm US Central Time. Check with OCAIR about how to join if you’d like to tune in.</p></div></div></div><div class="ab cb pq pr ps pt" role="separator"><span class="pu by bm pv pw px"/><span class="pu by bm pv pw px"/><span class="pu by bm pv pw"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="c1b0" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">(All images in this post except the header photo are created by the author.)</p><p id="8f45" class="pw-post-body-paragraph nd ne fq nf b go ng nh ni gr nj nk nl nm nn no np nq nr ns nt nu nv nw nx ny fj bk">See more of my work at <a class="af nc" href="http://www.stephaniekirmer.com/" rel="noopener ugc nofollow" target="_blank">www.stephaniekirmer.com</a>.</p></div></div></div></div>    
</body>
</html>