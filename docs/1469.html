<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Simplifying the Python Code for Data Engineering Projects</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Simplifying the Python Code for Data Engineering Projects</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/simplifying-the-python-code-for-data-engineering-projects-95f0c41dc58a?source=collection_archive---------1-----------------------#2024-06-12">https://towardsdatascience.com/simplifying-the-python-code-for-data-engineering-projects-95f0c41dc58a?source=collection_archive---------1-----------------------#2024-06-12</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="3d9f" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx">Python tricks and techniques for data ingestion, validation, processing, and testing: a practical walkthrough</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hd he hf hg hh ab"><div><div class="ab hi"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@johnleungTJ?source=post_page---byline--95f0c41dc58a--------------------------------" rel="noopener follow"><div class="l hj hk by hl hm"><div class="l ed"><img alt="John Leung" class="l ep by dd de cx" src="../Images/ef45063e759e3450fa7f3c32b2f292c3.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/1*-zL9bLkxy32p8chXW888zQ.jpeg"/><div class="hn by l dd de em n ho eo"/></div></div></a></div></div><div class="hp ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--95f0c41dc58a--------------------------------" rel="noopener follow"><div class="l hq hr by hl hs"><div class="l ed"><img alt="Towards Data Science" class="l ep by br ht cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hn by l br ht em n ho eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hu ab q"><div class="ab q hv"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hw hx bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hy" data-testid="authorName" href="https://medium.com/@johnleungTJ?source=post_page---byline--95f0c41dc58a--------------------------------" rel="noopener follow">John Leung</a></p></div></div></div><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hw hx dx"><button class="ib ic ah ai aj ak al am an ao ap aq ar id ie if" disabled="">Follow</button></p></div></div></span></div></div><div class="l ig"><span class="bf b bg z dx"><div class="ab cn ih ii ij"><div class="ik il ab"><div class="bf b bg z dx ab im"><span class="in l ig">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hy ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--95f0c41dc58a--------------------------------" rel="noopener follow"><p class="bf b bg z io ip iq ir is it iu iv bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">10 min read</span><div class="iw ix l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">Jun 12, 2024</span></div></span></div></span></div></div></div><div class="ab cp iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn"><div class="h k w ea eb q"><div class="kd l"><div class="ab q ke kf"><div class="pw-multi-vote-icon ed in kg kh ki"><div class=""><div class="kj kk kl km kn ko kp am kq kr ks ki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kt ku kv kw kx ky kz"><p class="bf b dy z dx"><span class="kk">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kj lc ld ab q ee le lf" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="lb"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg><p class="bf b dy z dx"><span class="pw-responses-count la lb">4</span></p></button></div></div></div><div class="ab q jo jp jq jr js jt ju jv jw jx jy jz ka kb kc"><div class="lg k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lh an ao ap id li lj lk" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep ll cn"><div class="l ae"><div class="ab cb"><div class="lm ln lo lp lq lr ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><p id="0cfc" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Raw data comes from various sources and formats. Before the data can be available to answer critical business questions, substantial effort and time are required to perform data engineering. While the underlying data infrastructure can vary based on the data volume, velocity, and analytics requirements, some fundamental code design techniques are still relevant to simplify and streamline various tasks across time.</p><p id="ad8e" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">This article will explore different critical parts of general data engineering projects, from data ingestion to pipeline testing. Python is the most widely used programming language for data engineering, and we will learn how to deal with these use cases using built-in functionalities and efficient libraries in Python.</p><figure class="ni nj nk nl nm nn nf ng paragraph-image"><div role="button" tabindex="0" class="no np ed nq bh nr"><div class="nf ng nh"><img src="../Images/128d4c278ec7ce5302584afdc96ee3f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ZSZ-ePC8ZKm0IVY3"/></div></div><figcaption class="nt nu nv nf ng nw nx bf b bg z dx">Photo by <a class="af ny" href="https://unsplash.com/@kat_katerina?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Katerina Pavlyuchkova</a> on <a class="af ny" href="https://unsplash.com/?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure></div></div></div><div class="ab cb nz oa ob oc" role="separator"><span class="od by bm oe of og"/><span class="od by bm oe of og"/><span class="od by bm oe of"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="f3b4" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Imagine you have an online retail shop that sells unique, all-occasion gifts. The online shop is so popular that it has a high volume of transactions every minute and second. You have the ambition to satisfy more current customers’ needs and serve more new customers through analyzing buying habits about the current transactions, so this motivates you to dive into the data processing of the transaction records as the preparation.</p><h2 id="c266" class="oh oi fq bf oj ok ol om on oo op oq or ms os ot ou mw ov ow ox na oy oz pa pb bk">#0 Mock data</h2><p id="252f" class="pw-post-body-paragraph mj mk fq ml b go pc mn mo gr pd mq mr ms pe mu mv mw pf my mz na pg nc nd ne fj bk">We first mock some transaction data into a file using the <a class="af ny" href="https://jsonlines.org/" rel="noopener ugc nofollow" target="_blank">JSON Lines</a> (JSONL) text format, where each line is a separate JSON object. This format is appealing for data streaming in areas, such as web/ app analytics and log management.</p><p id="d6c6" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">In our file, the data fields belong to various data types. They include the customer and product identifiers (in integer/ array format), the payment method (in string format), and the total transaction amount (in float number).</p><pre class="ni nj nk nl nm ph pi pj bp pk bb bk"><span id="6ef3" class="pl oi fq pi b bg pm pn l po pp">import json<br/>import random<br/>import numpy as np<br/>import datetime<br/><br/># Remove existing 'retail_transactions.jsonl' file, if any<br/>! rm -f /p/a/t/h retail_transactions.jsonl<br/><br/># Set the no of transactions<br/>no_of_iteration = 500000<br/><br/># Open a file in write mode<br/>with open('retail_transactions.jsonl', 'w') as f:<br/>  for num in range(no_of_iteration):<br/>    if (random.randint(1, 10000) != 5000):<br/>      # Create a valid transaction<br/>      new_txn = {<br/>        'orderID': num,<br/>        'customerID': random.randint(1, 100000),<br/>        'productID': np.random.randint(10000, size=random.randint(1, 5)).tolist(),<br/>        'paymentMthd': random.choice(['Credit card', 'Debit card', 'Digital wallet', 'Cash on delivery', 'Cryptocurrency']),<br/>        'totalAmt': round(random.random() * 5000, 2),<br/>        'invoiceTime': datetime.datetime.now().isoformat()<br/>      }<br/>    else:<br/>      # Create an invalid transaction<br/>      new_txn = {<br/>        'orderID': "",<br/>        'customerID': "",<br/>        'productID': "",<br/>        'paymentMthd': "",<br/>        'totalAmt': "",<br/>        'invoiceTime': ""<br/>       }<br/>     <br/>     # Write the transaciton as a JSON line to the file<br/>     f.write(json.dumps(new_txn) + "\n")</span></pre><p id="d093" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">You may discover several single transactions with blank data fields written to the file. This mimics the missing data issue, as one of the data quality issues often encountered in the real world.</p><h2 id="93dd" class="oh oi fq bf oj ok ol om on oo op oq or ms os ot ou mw ov ow ox na oy oz pa pb bk">#1 Data ingestion — Yield</h2><p id="ff26" class="pw-post-body-paragraph mj mk fq ml b go pc mn mo gr pd mq mr ms pe mu mv mw pf my mz na pg nc nd ne fj bk">To read the transaction records from the file, one of the simplest approaches is to loop through the dataset into a list and then convert it into a Pandas DataFrame.</p><p id="c90c" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">This method will work like a charm for the 500,000 transactions in our demo dataset. But what if the real-world datasets range from millions to even billions of rows? We may sit still for long to wait until the whole computation completes, if not leading to memory issues.</p><p id="f154" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Sometimes we don’t care about the entire results and want to process the initial results instead before the last record is loaded. In such cases, we can alternatively use <code class="cx pq pr ps pi b">yield</code> to control the flow of a <a class="af ny" href="https://wiki.python.org/moin/Generators" rel="noopener ugc nofollow" target="_blank">generator</a>.</p><blockquote class="pt pu pv"><p id="a947" class="mj mk pw ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">The generator does not store the entire records in memory. Instead, it gives a value one at a time and pauses the function execution until the next value is requested.</p></blockquote><p id="910d" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">There are routines of interleaving user codes with library codes. It also enforces sequencing, which means you cannot access the second record before reaching the first. You can learn more about this concept in the <a class="af ny" href="https://www.youtube.com/watch?v=7lmCu8wz8ro" rel="noopener ugc nofollow" target="_blank">Pydata talk video</a>, which provides a detailed explanation.</p><p id="7af7" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">The yield statement has different practical usages. For example, we can go through each line of the file and yield only the non-blank records. Below shows how we can execute real-time data filtering:</p><pre class="ni nj nk nl nm ph pi pj bp pk bb bk"><span id="0447" class="pl oi fq pi b bg pm pn l po pp">import json<br/><br/>def read_json_file(file_name):<br/>  # Read the JSONL file<br/>  with open(file_name) as f:<br/>    for line in f:<br/>      txn = json.loads(line)<br/>      # Yield valid transactions only<br/>      if (txn['orderID'] != ""):<br/>        yield(txn)<br/><br/>txn_generator = read_json_file('retail_transactions.jsonl')</span></pre><p id="20bf" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">The output of these codes gives a Python generator, a special type of iterator. You can use the <code class="cx pq pr ps pi b">next</code> function in a loop to return the subsequent items one by one. Apart from real-time data filtering, another idea is to design a generator function that pre-processes data and yields it in a pre-defined batch size, which can be parsed straightforwardly to feed a machine-learning model for training. And more, we can use it to asynchronously handle web requests and responses, when crawling web pages.</p><h2 id="e3e3" class="oh oi fq bf oj ok ol om on oo op oq or ms os ot ou mw ov ow ox na oy oz pa pb bk">#2 Data validation — Pydantic</h2><p id="84d1" class="pw-post-body-paragraph mj mk fq ml b go pc mn mo gr pd mq mr ms pe mu mv mw pf my mz na pg nc nd ne fj bk">Assume you have a list of JSON data that covers the information of transaction records after data ingestion. Here is a sample transaction:</p><pre class="ni nj nk nl nm ph pi pj bp pk bb bk"><span id="a84b" class="pl oi fq pi b bg pm pn l po pp">{<br/> 'orderID': 10000,<br/> 'customerID': 48316,<br/> 'productID': [5620],<br/> 'paymentMthd': 'Cash on delivery',<br/> 'totalAmt': 9301.2,<br/> 'invoiceTime': '2024-06-10T23:30:29.608443',<br/> 'price': -1<br/>}</span></pre><p id="61ab" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">For each incoming data, we want to ensure it is being validated, otherwise, we will easily hit different types of errors when running the subsequent data processing functions. This can be achieved using <code class="cx pq pr ps pi b">pydantic</code> library.</p><blockquote class="pt pu pv"><p id="fdf2" class="mj mk pw ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">We first define the schema of our data fields using the <a class="af ny" href="https://docs.pydantic.dev/latest/api/base_model/" rel="noopener ugc nofollow" target="_blank">Pydantic model</a>, then validate our JSON data using <code class="cx pq pr ps pi b">model_validate()</code> function.</p></blockquote><pre class="ni nj nk nl nm ph pi pj bp pk bb bk"><span id="c9d8" class="pl oi fq pi b bg pm pn l po pp">from datetime import datetime<br/>from pydantic import BaseModel, ValidationError<br/><br/># Define the data model for a transaction record<br/>class TxnModel(BaseModel):<br/>  orderID: int<br/>  customerID: int<br/>  productID: list[int]<br/>  paymentMthd: str<br/>  totalAmt: float<br/>  invoiceTime: datetime<br/><br/>try:<br/>  # Validate the sample case against the schema<br/>  TxnModel.model_validate(sample_txn)<br/>  print("Validated successfully!")<br/>except ValidationError as exc:<br/>  # Print error messages for any validation error<br/>  print("Validation Error:")<br/>  print(exc.errors())<br/><br/># Output:<br/># Validated successfully</span></pre><p id="1eee" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Sometimes, we find the necessity to apply stricter validation rules. For example, the Pydantic base model attempts to coerce string data to an integer if possible. To avoid this, you can set <code class="cx pq pr ps pi b">strict=True</code> at the model level or field level.</p><p id="9c3f" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Besides, we can apply custom validation rules to data fields. For example, we may want to check if the payment method value is within our expectations. To facilitate testing, we manually set the payment method of the sample case to ‘Bitcoin’, which is a non-existent option in the online shop, and then use <code class="cx pq pr ps pi b">AfterValidator</code> to embed a function for further checking.</p><pre class="ni nj nk nl nm ph pi pj bp pk bb bk"><span id="c549" class="pl oi fq pi b bg pm pn l po pp">from typing import Annotated<br/>from pydantic.functional_validators import AfterValidator<br/><br/># Customize the validation rule<br/>def validate_payment_mthd(paymentMthd: str):<br/>  possible_values = ['Credit card', 'Debit card', 'Digital wallet', 'Cash on delivery', 'Cryptocurrency']<br/>  if paymentMthd not in possible_values:<br/>    raise ValueError(f"Invalid paymentMthd, payment type must be one of {possible_values}")<br/>  return storage<br/><br/># Define the data model for a transaction record<br/>class TxnModel(BaseModel):<br/>  orderID: int = Field(strict=True)<br/>  customerID: int<br/>  productID: list[int]<br/>  paymentMthd: Annotated[str, AfterValidator(validate_payment_mthd)]<br/>  totalAmt: Annotated[float, Field(strict=True, gt=0)]<br/>  invoiceTime: datetime<br/><br/># Manually define a non-existent payment method<br/>sample_txn['paymentMthd'] = 'Bitcoin'<br/><br/>try:<br/>  # Validate the sample case against the schema<br/>  TxnModel.model_validate(sample_txn)<br/>  print("Validated successfully!")<br/>except ValidationError as exc:<br/>  # Print error messages for any validation error<br/>  print("Validation Error:")<br/>  print(exc.errors()[0]['ctx'])<br/><br/># Output<br/># Validation Error:<br/># {'error': ValueError("Invalid paymentMthd, payment type must be one of ['Credit card', 'Debit card', 'Digital wallet', 'Cash on delivery', 'Cryptocurrency']")}</span></pre><p id="01a0" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">The validator successfully identifies that the payment method is not within the list of possible values. This is done by applying Pydantic’s inner validation logic, followed by custom validation functions. The code raises a <code class="cx pq pr ps pi b">ValueError</code>, which populates <code class="cx pq pr ps pi b">ValidationError</code>.</p><p id="ca65" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">When the error is triggered, we can have follow-up actions for rectification. These features help eliminate data errors, thus ensuring the accuracy and completeness of our data.</p><h2 id="43f2" class="oh oi fq bf oj ok ol om on oo op oq or ms os ot ou mw ov ow ox na oy oz pa pb bk">#3 Data processing</h2><p id="f9fe" class="pw-post-body-paragraph mj mk fq ml b go pc mn mo gr pd mq mr ms pe mu mv mw pf my mz na pg nc nd ne fj bk">(1) Python decorator</p><p id="e947" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">After data validation, we start working with data-intensive functions. There is a high chance of encountering lengthy execution times as the data pipeline becomes complex. We wish to identify the root cause and optimize the time performance of functions. One simple method is to collect two timestamps at the beginning and end of every function, and then calculate the time differences one by one.</p><p id="fc66" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">To ensure the code is less cluttered throughout the data pipeline, we can leverage the <a class="af ny" href="https://book.pythontips.com/en/latest/decorators.html" rel="noopener ugc nofollow" target="_blank">Python decorator</a>.</p><blockquote class="pt pu pv"><p id="c8c8" class="mj mk pw ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">We first design a Python decorator that measures the execution time. Afterward, we annotate any function that requires this feature.</p></blockquote><p id="d560" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">For example, you can measure the time taken to categorize prices for all transactions.</p><pre class="ni nj nk nl nm ph pi pj bp pk bb bk"><span id="4fef" class="pl oi fq pi b bg pm pn l po pp">import time<br/><br/># Measure the excution time of a given function<br/>def time_decorator(func):<br/>  def wrapper(*args, **kwargs):<br/>    begin_time = time.time()<br/>    output = func(*args, **kwargs)<br/>    end_time = time.time()<br/>    print(f"Execution time of function {func.__name__}: {round(end_time - begin_time, 2)} seconds.")<br/>    return output<br/>  return wrapper<br/><br/># Categorize the total amount of each transaction<br/>@time_decorator<br/>def group_txn_price(data):<br/>  for txn in data:<br/>    price = txn['totalAmt']<br/>    if 0 &lt;= price &lt;= 1500:<br/>      txn['totalAmtCat'] = 'Low'<br/>    elif 1500 &lt; price &lt;= 3500:<br/>      txn['totalAmtCat'] = 'Moderate'<br/>    elif 3500 &lt; price:<br/>      txn['totalAmtCat'] = 'High'<br/>    return data<br/><br/>txn_list = group_txn_price(txn_list)<br/><br/># Output<br/># Execution time of function group_txn_price: 0.26 seconds.</span></pre><p id="6804" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">The decorator approach makes the code reusable without changing the source code of our original functions. Similarly, we can apply decorator ideas for logging function completion or email alerting when jobs encounter failure.</p><p id="4406" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">(2) Map, reduce, filter</p><p id="0f63" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">These are commonly used Python array methods that many developers may be familiar with. But I still think they are worth mentioning due to several reasons: (1) immutable — the functions do not modify values of the original lists; (2) the chain flexibility — can apply a combination of functions simultaneously; and (3) concise and readable — with only one line of code.</p><p id="6f88" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Assume we have a list of JSON objects with only two keys: payment method and total amount. Let’s explore some examples of how these functions work.</p><p id="fb87" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk"><strong class="ml fr">Map:</strong> Perform the same operation on all elements in the list (e.g. adding a suffix to the values of the payment method).</p><pre class="ni nj nk nl nm ph pi pj bp pk bb bk"><span id="a6a2" class="pl oi fq pi b bg pm pn l po pp">updated_txn_list = list(map(lambda x: {<br/>                      'paymentMthd': f"{x['paymentMthd']}_2024",<br/>                      "totalAmt": x["totalAmt"]<br/>                   }, txn_list))<br/><br/>print(updated_txn_list)<br/><br/># Output<br/># [{'paymentMthd': 'Cryptocurrency_2024', 'totalAmt': 3339.85},<br/># {'paymentMthd': 'Cash on delivery_2024', 'totalAmt': 872.52},<br/># ...]</span></pre><p id="9419" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk"><strong class="ml fr">Filter</strong>: Obtain a subset of elements that meet a certain condition(s) (e.g. only records with cryptocurrency as the payment method).</p><pre class="ni nj nk nl nm ph pi pj bp pk bb bk"><span id="ab07" class="pl oi fq pi b bg pm pn l po pp">updated_txn_list = list(map(lambda x: x, filter(lambda y: y["paymentMthd"] == "Cryptocurrency", txn_list)))<br/><br/>print(updated_txn_list)<br/><br/># Output<br/># [{'paymentMthd': 'Cryptocurrency', 'totalAmt': 3339.85},<br/># {'paymentMthd': 'Cryptocurrency', 'totalAmt': 576.15},<br/># ...]</span></pre><p id="4882" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk"><strong class="ml fr">Reduce</strong>: Get a single-valued outcome (e.g. summing or multiplying all elements).</p><pre class="ni nj nk nl nm ph pi pj bp pk bb bk"><span id="122f" class="pl oi fq pi b bg pm pn l po pp">from functools import reduce<br/><br/>total_amt_crypto = reduce(lambda acc, x: acc + x["totalAmt"], updated_txn_list, 0)<br/><br/>print(total_amt_crypto)<br/><br/># Output<br/># 250353984.67000002</span></pre><p id="a07e" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">We can leverage these functions during the transformation steps in data science projects. For example, use <code class="cx pq pr ps pi b">map()</code> to scale or normalize the data, use <code class="cx pq pr ps pi b">filter()</code> to remove outliers and irrelevant data points, and <code class="cx pq pr ps pi b">reduce()</code> to generate summary statistics.</p><h2 id="f677" class="oh oi fq bf oj ok ol om on oo op oq or ms os ot ou mw ov ow ox na oy oz pa pb bk">#4 Data pipeline testing — Pytest</h2><p id="3f06" class="pw-post-body-paragraph mj mk fq ml b go pc mn mo gr pd mq mr ms pe mu mv mw pf my mz na pg nc nd ne fj bk">Data pipelines often involve data ingestion, data cleansing, and Extract-Transform-Load (ETL) operations. The scope of potential errors can be broad and easily overlooked, especially as the model flow and result are hard for users to interpret. This leads to a heavier reliance on testing efforts by the development team.</p><blockquote class="pt pu pv"><p id="f945" class="mj mk pw ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">It is common to conduct unit testing to ascertain each component of the machine learning system performs as expected.</p></blockquote><p id="f77d" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">One of the most popular Python testing frameworks is <code class="cx pq pr ps pi b"><a class="af ny" href="https://docs.pytest.org/en/stable/contents.html" rel="noopener ugc nofollow" target="_blank">Pytest</a></code>. Imagine we want to ensure the high-quality of transformed data that both technical teams and decision-makers can trust. We can test for the function that we have gone through about categorizing transaction prices. To achieve this, we need to prepare two Python files:</p><ul class=""><li id="29f6" class="mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne px py pz bk"><strong class="ml fr">feature_engineering.py</strong>: The file containing the previously built function</li></ul><pre class="ni nj nk nl nm ph pi pj bp pk bb bk"><span id="6112" class="pl oi fq pi b bg pm pn l po pp"># Categorize the total amount of each transaction<br/>def add_features(sample_cases):<br/>  for txn in sample_cases:<br/>    price = txn[‘totalAmt’]<br/>  if 0 &lt;= price &lt;= 1500:<br/>    txn[‘totalAmtCat’] = ‘Low’<br/>  elif 1500 &lt; price &lt;= 3500:<br/>    txn[‘totalAmtCat’] = ‘Moderate’<br/>  elif 3500 &lt; price:<br/>    txn[‘totalAmtCat’] = ‘High’<br/><br/>return sample_cases</span></pre><ul class=""><li id="15e4" class="mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne px py pz bk"><strong class="ml fr">test_feature_engineering.py</strong>: The file with the “test_” prefix, which Pytest will recognize for testing purposes only.</li></ul><pre class="ni nj nk nl nm ph pi pj bp pk bb bk"><span id="b44e" class="pl oi fq pi b bg pm pn l po pp">from feature_engineering import add_features<br/><br/>def test_add_features():<br/>  sample_cases = [{<br/>      'orderID': 1,<br/>      'customerID': 36536,<br/>      'productID': [2209, 2262, 4912, 3162, 5734],<br/>      'paymentMthd': 'Cryptocurrency',<br/>      'totalAmt': 576.15,<br/>      'invoiceTime': '2024–06–10T23:53:25.329928'<br/>    }]<br/><br/>  # Call the function with the sample cases<br/>  sample_cases = add_features(sample_cases)<br/> <br/>  # Check the assertations<br/>  for txn in sample_cases: <br/>    assert 'totalAmtCat' in list(txn.keys())<br/>    assert len(txn) == 7<br/>    assert len(txn['totalAmtCat']) != 0</span></pre><p id="32ab" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">The assert statements above ensure that the new ‘totalAmtCat’ data field is added with a non-blank value, and the original data fields are not affected. By executing the command <code class="cx pq pr ps pi b">Pytest</code>, we can know that our test has passed!</p><figure class="ni nj nk nl nm nn nf ng paragraph-image"><div role="button" tabindex="0" class="no np ed nq bh nr"><div class="nf ng qa"><img src="../Images/f5d42bc912f608940f41c8519fbb3498.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HdAcJRXNoMUO7D4une7Sww.png"/></div></div><figcaption class="nt nu nv nf ng nw nx bf b bg z dx">Pytest result — Test passed (Image by author)</figcaption></figure><p id="c14a" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">For a more advanced case, let's say we have three functions with the following sequences: <code class="cx pq pr ps pi b">load_data</code>, <code class="cx pq pr ps pi b">clean_data</code>, and <code class="cx pq pr ps pi b">add_features</code>. How should we design the test file to validate the output of these functions one by one?</p><pre class="ni nj nk nl nm ph pi pj bp pk bb bk"><span id="fb3e" class="pl oi fq pi b bg pm pn l po pp">import pytest<br/>import json<br/>from feature_engineering import load_data, clean_data, add_features<br/><br/># Set up a temporary JSONL file<br/>@pytest.fixture<br/>def jsonl_file(tmp_path):<br/>  sample_cases = [{'orderID': 10000,<br/>    'customerID': 48316,<br/>    'productID': [5620],<br/>    'paymentMthd': 'Cash on delivery',<br/>    'totalAmt': 9301.2,<br/>    'invoiceTime': '2024-06-10T23:30:29.608443',<br/>    'price': -1<br/>  }]<br/><br/>  file_path = tmp_path + "/test_transactions.jsonl"<br/><br/>  with open(file_path, 'w') as f:<br/>    for txn in sample_cases:<br/>        f.write(json.dumps(txn) + "\n")<br/><br/>  return file_path<br/><br/># Test function to validate the `load_data` function<br/>def test_load_data(jsonl_file):<br/>  data = load_data(jsonl_file)<br/>  # assert statements here<br/><br/># Test function to validate the `clean_data` function<br/>def test_clean_data(jsonl_file):<br/>  data = load_data(jsonl_file)<br/>  data = clean_data(data)<br/>  # assert statements here<br/><br/># Test function to validate the `add_features` function<br/>def test_add_features(jsonl_file):<br/>  data = load_data(jsonl_file)<br/>  data = clean_data(data)<br/>  data = add_features(data)<br/>  # assert statements here</span></pre><p id="f955" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">We should define a fixed baseline for initialization, such as a JSON Lines file with sample test cases. Here we use <code class="cx pq pr ps pi b">@pytest.fixture</code>decorator, which works similarly to the <code class="cx pq pr ps pi b">time_decorator</code>we discussed earlier in the Python decorator section. This decorator helps prevent repeatedly initializing the sample files. For the remaining codes, we involve several test functions to run the pipeline functions and use assert statements to detect logical errors.</p></div></div></div><div class="ab cb nz oa ob oc" role="separator"><span class="od by bm oe of og"/><span class="od by bm oe of og"/><span class="od by bm oe of"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><h2 id="cf34" class="oh oi fq bf oj ok ol om on oo op oq or ms os ot ou mw ov ow ox na oy oz pa pb bk">Wrapping it up</h2><p id="3a9d" class="pw-post-body-paragraph mj mk fq ml b go pc mn mo gr pd mq mr ms pe mu mv mw pf my mz na pg nc nd ne fj bk">We came across several critical aspects of data engineering projects, and explored how to simplify and streamline the Python code for efficiency and readability:</p><ul class=""><li id="b8ca" class="mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne px py pz bk">Data ingestion, by using <code class="cx pq pr ps pi b">yield</code> to process large datasets with efficient memory usage.</li><li id="730f" class="mj mk fq ml b go qb mn mo gr qc mq mr ms qd mu mv mw qe my mz na qf nc nd ne px py pz bk">Data validation, by leveraging <code class="cx pq pr ps pi b">Pydantic</code> to validate data fields based on schema and customized value patterns.</li><li id="cf7a" class="mj mk fq ml b go qb mn mo gr qc mq mr ms qd mu mv mw qe my mz na qf nc nd ne px py pz bk">Data processing, by applying Python decorator and built-in libraries to enable additional functionalities without repeated codes.</li><li id="34dd" class="mj mk fq ml b go qb mn mo gr qc mq mr ms qd mu mv mw qe my mz na qf nc nd ne px py pz bk">Pipeline testing, by using <code class="cx pq pr ps pi b">Pytest</code> to ensure high-quality function outputs throughout the workflow.</li></ul></div></div></div><div class="ab cb nz oa ob oc" role="separator"><span class="od by bm oe of og"/><span class="od by bm oe of og"/><span class="od by bm oe of"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><h2 id="88cd" class="oh oi fq bf oj ok ol om on oo op oq or ms os ot ou mw ov ow ox na oy oz pa pb bk">Before you go</h2><p id="205d" class="pw-post-body-paragraph mj mk fq ml b go pc mn mo gr pd mq mr ms pe mu mv mw pf my mz na pg nc nd ne fj bk">If you enjoy this reading, I invite you to<strong class="ml fr"> </strong>follow my <a class="af ny" href="https://medium.com/@johnleungTJ" rel="noopener">Medium page</a> and <a class="af ny" href="https://www.linkedin.com/in/john-leung-639800115/" rel="noopener ugc nofollow" target="_blank">LinkedIn page</a>. By doing so, you can stay updated with exciting content related to data science side projects, Machine Learning Operations (MLOps) demonstrations, and project management methodologies.</p><div class="qg qh qi qj qk ql"><a rel="noopener follow" target="_blank" href="/performing-customer-analytics-with-langchain-and-llms-0af4ea38f7b5?source=post_page-----95f0c41dc58a--------------------------------"><div class="qm ab ig"><div class="qn ab co cb qo qp"><h2 class="bf fr hw z io qq iq ir qr it iv fp bk">Performing Customer Analytics with LangChain and LLMs</h2><div class="qs l"><h3 class="bf b hw z io qq iq ir qr it iv dx">Discover the potentials and constraints of LangChain for customer analytics, accompanied by practical implementation…</h3></div><div class="qt l"><p class="bf b dy z io qq iq ir qr it iv dx">towardsdatascience.com</p></div></div><div class="qu l"><div class="qv l qw qx qy qu qz lr ql"/></div></div></a></div><div class="qg qh qi qj qk ql"><a rel="noopener follow" target="_blank" href="/feature-engineering-for-time-series-using-pyspark-on-databricks-02b97d62a287?source=post_page-----95f0c41dc58a--------------------------------"><div class="qm ab ig"><div class="qn ab co cb qo qp"><h2 class="bf fr hw z io qq iq ir qr it iv fp bk">Feature Engineering for Time-Series Using PySpark on Databricks</h2><div class="qs l"><h3 class="bf b hw z io qq iq ir qr it iv dx">Discover the potentials of PySpark for time-series data: Ingest, extract, and visualize data, accompanied by practical…</h3></div><div class="qt l"><p class="bf b dy z io qq iq ir qr it iv dx">towardsdatascience.com</p></div></div><div class="qu l"><div class="ra l qw qx qy qu qz lr ql"/></div></div></a></div></div></div></div></div>    
</body>
</html>