# åŠ é€Ÿä½ çš„ PyTorch æ¨¡å‹è®­ç»ƒçš„ç®€å•æ–¹æ³•

> åŸæ–‡ï¼š[`towardsdatascience.com/simple-ways-to-speed-up-your-pytorch-model-training-9c9d4899313d?source=collection_archive---------3-----------------------#2024-05-28`](https://towardsdatascience.com/simple-ways-to-speed-up-your-pytorch-model-training-9c9d4899313d?source=collection_archive---------3-----------------------#2024-05-28)

## å¦‚æœæ‰€æœ‰æœºå™¨å­¦ä¹ å·¥ç¨‹å¸ˆéƒ½å¸Œæœ›å¾—åˆ°ä¸€ä¸ªä¸œè¥¿ï¼Œé‚£å°±æ˜¯ **æ›´å¿«çš„æ¨¡å‹è®­ç»ƒ** â€”â€” ä¹Ÿè®¸åœ¨è·å¾—è‰¯å¥½çš„æµ‹è¯•æŒ‡æ ‡ä¹‹åã€‚ 

[](https://alexdremov.medium.com/?source=post_page---byline--9c9d4899313d--------------------------------)![Alex Dremov](https://alexdremov.medium.com/?source=post_page---byline--9c9d4899313d--------------------------------)[](https://towardsdatascience.com/?source=post_page---byline--9c9d4899313d--------------------------------)![Towards Data Science](https://towardsdatascience.com/?source=post_page---byline--9c9d4899313d--------------------------------) [Alex Dremov](https://alexdremov.medium.com/?source=post_page---byline--9c9d4899313d--------------------------------)

Â·å‘å¸ƒäº [Towards Data Science](https://towardsdatascience.com/?source=post_page---byline--9c9d4899313d--------------------------------) Â·11 åˆ†é’Ÿé˜…è¯» Â·2024 å¹´ 5 æœˆ 28 æ—¥

--

![](img/eb75109bbcb6622409f76f7e507791cd.png)

å›¾ç‰‡æ¥æºï¼š[Julian Hochgesang](https://unsplash.com/@julianhochgesang?utm_source=ghost&utm_medium=referral&utm_campaign=api-credit) / [Unsplash](https://unsplash.com/?utm_source=ghost&utm_medium=referral&utm_campaign=api-credit)

è¿™ä¸ªè¯é¢˜ç”šè‡³éœ€è¦ä»‹ç»å—ï¼Ÿ

åŠ é€Ÿæœºå™¨å­¦ä¹ æ¨¡å‹è®­ç»ƒæ˜¯æ‰€æœ‰æœºå™¨å­¦ä¹ å·¥ç¨‹å¸ˆçš„ç›®æ ‡ã€‚æ›´å¿«çš„è®­ç»ƒæ„å‘³ç€æ›´å¿«çš„å®éªŒï¼Œä¹Ÿæ„å‘³ç€æ›´å¿«çš„äº§å“è¿­ä»£ã€‚æ­¤å¤–ï¼Œè¿™è¿˜æ„å‘³ç€ä¸€æ¬¡æ¨¡å‹è®­ç»ƒå°†éœ€è¦æ›´å°‘çš„èµ„æºã€‚æ‰€ä»¥ï¼Œç›´æ¥è¿›å…¥æ­£é¢˜

# å®¹å™¨åŒ–

æ˜¯çš„ï¼Œå•é è¿™ä¸ªä¸ä¼šåŠ é€Ÿä½ çš„è®­ç»ƒã€‚ä½†å®ƒé’ˆå¯¹çš„æ˜¯å¦ä¸€ä¸ªé‡è¦æ–¹é¢â€”â€”å¯é‡ç°æ€§ã€‚æœ‰æ—¶å€™ï¼Œä½¿ç”¨å›ºå®šåº“ç‰ˆæœ¬çš„ virtualenv å°±è¶³å¤Ÿäº†ï¼Œä½†æˆ‘é¼“åŠ±ä½ æ›´è¿›ä¸€æ­¥ï¼Œä¸ºä½ çš„æ¨¡å‹è®­ç»ƒæ„å»ºä¸€ä¸ªä¸€ä½“åŒ–çš„ Docker å®¹å™¨ã€‚

è¿™ç¡®ä¿äº†åœ¨è°ƒè¯•ã€åˆ†æå’Œæœ€ç»ˆè®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œç¯å¢ƒçš„ä¸€è‡´æ€§ã€‚ä½ æœ€ä¸å¸Œæœ›çš„äº‹æƒ…å°±æ˜¯ä¼˜åŒ–ä¸€ä¸ªéƒ¨åˆ†ä»£ç ï¼Œè€Œè¿™ä¸ªéƒ¨åˆ†ç”±äº Python12 æå‡äº†é€Ÿåº¦ï¼Œå·²ç»ä¸å†æ˜¯ç“¶é¢ˆäº†ã€‚ä¾‹å¦‚ï¼Œç”šè‡³æœ‰ä¸€ä¸ªé”™è¯¯åœ¨ä¸åŒçš„ CUDA ç‰ˆæœ¬ä¸‹æ— æ³•é‡ç°ã€‚

ä½œä¸ºèµ·ç‚¹ï¼Œä½ å¯ä»¥ä½¿ç”¨ NVIDIA æä¾›çš„é¢„æ„å»ºé•œåƒã€‚è¿™äº›é•œåƒå·²ç»å®‰è£…äº† CUDAã€PyTorch å’Œå…¶ä»–æµè¡Œçš„åº“ï¼š

[## PyTorch | NVIDIA NGC

### PyTorch æ˜¯ä¸€ä¸ª GPU åŠ é€Ÿçš„å¼ é‡è®¡ç®—æ¡†æ¶ã€‚åŠŸèƒ½å¯ä»¥é€šè¿‡å¸¸è§çš„ Python åº“è¿›è¡Œæ‰©å±•â€¦â€¦

catalog.ngc.nvidia.com](https://catalog.ngc.nvidia.com/orgs/nvidia/containers/pytorch?ref=alexdremov.me&source=post_page-----9c9d4899313d--------------------------------)

> ğŸ’¡ Docker å®¹å™¨æ˜¯è§£å†³æ­¤ç±»é—®é¢˜çš„ç»ˆææ–¹æ¡ˆ
> 
> â€œå˜¿ï¼Œå®ƒåœ¨æˆ‘çš„æœºå™¨ä¸Šå¯ä»¥å·¥ä½œï¼Œæˆ‘ä¸çŸ¥é“ä¸ºä»€ä¹ˆåœ¨ä½ çš„æœºå™¨ä¸Šä¸è¡Œã€‚â€

# ç†Ÿæ‚‰ PyTorch åˆ†æå™¨

åœ¨ä¼˜åŒ–ä»»ä½•ä¸œè¥¿ä¹‹å‰ï¼Œä½ å¿…é¡»äº†è§£ä½ çš„ä¸€äº›ä»£ç éƒ¨åˆ†è¿è¡Œäº†å¤šä¹…ã€‚PyTorch åˆ†æå™¨å‡ ä¹æ˜¯ä¸€ä¸ªåŠŸèƒ½é½å…¨çš„è®­ç»ƒåˆ†æå·¥å…·ã€‚å®ƒèƒ½å¤Ÿè®°å½•ï¼š

+   CPU æ“ä½œçš„æ—¶é—´

+   CUDA å†…æ ¸çš„æ—¶é—´

+   å†…å­˜æ¶ˆè€—å†å²

è¿™å°±æ˜¯ä½ æ‰€éœ€è¦çš„ä¸€åˆ‡ã€‚è€Œä¸”å®ƒå¾ˆå®¹æ˜“å¯ç”¨ï¼

è¦è®°å½•äº‹ä»¶ï¼Œä½ åªéœ€è¦åƒè¿™æ ·å°†è®­ç»ƒåµŒå…¥åˆ†æå™¨ä¸Šä¸‹æ–‡ä¸­ï¼š

```py
import torch.autograd.profiler as profiler

with profiler.profile(
  activities=[ProfilerActivity.CPU, ProfilerActivity.CUDA],
  on_trace_ready=torch.profiler.tensorboard_trace_handler('./logs'),
) as prof:
  train(args)
```

ä¹‹åï¼Œä½ å¯ä»¥å¯åŠ¨ tensorboard å¹¶æŸ¥çœ‹åˆ†æè½¨è¿¹ã€‚åˆ«å¿˜äº†å®‰è£… [torch-tb-profiler](https://pypi.org/project/torch-tb-profiler/?ref=alexdremov.me)ã€‚

[](https://pytorch.org/tutorials/intermediate/tensorboard_profiler_tutorial.html?ref=alexdremov.me&source=post_page-----9c9d4899313d--------------------------------) [## PyTorch Profiler ä¸ TensorBoard - PyTorch æ•™ç¨‹ 2.3.0+cu121 æ–‡æ¡£]

### å‡†å¤‡æ•°æ®å’Œæ¨¡å‹ ä½¿ç”¨åˆ†æå™¨è®°å½•æ‰§è¡Œäº‹ä»¶ è¿è¡Œåˆ†æå™¨ ä½¿ç”¨ TensorBoard æŸ¥çœ‹ç»“æœå¹¶â€¦

pytorch.org](https://pytorch.org/tutorials/intermediate/tensorboard_profiler_tutorial.html?ref=alexdremov.me&source=post_page-----9c9d4899313d--------------------------------)

åˆ†æå™¨æœ‰è®¸å¤šä¸åŒçš„é€‰é¡¹ï¼Œä½†æœ€é‡è¦çš„æ˜¯ `activities` å’Œ `profile_memory`ã€‚ä½ å¯ä»¥å°è¯•å…¶ä»–é€‰é¡¹ï¼Œä½†è¯·è®°ä½ä¸€ä¸ªç®€å•çš„è§„åˆ™ï¼š**ä½ å¯ç”¨çš„é€‰é¡¹è¶Šå°‘ï¼Œå¼€é”€å°±è¶Šå°**ã€‚

æ‰€ä»¥ï¼Œå¦‚æœä½ æƒ³åˆ†æ CUDA å†…æ ¸æ‰§è¡Œçš„æ—¶é—´ï¼Œæœ€å¥½å…³é—­ CPU åˆ†æå’Œå…¶ä»–æ‰€æœ‰åŠŸèƒ½ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œåˆ†æå°†å°½å¯èƒ½æ¥è¿‘çœŸå®æ‰§è¡Œã€‚

ä¸ºäº†è®©è½¨è¿¹æ›´å®¹æ˜“ç†è§£ï¼Œè€ƒè™‘æ·»åŠ æè¿°ä½ ä»£ç æ ¸å¿ƒéƒ¨åˆ†çš„åˆ†æä¸Šä¸‹æ–‡ã€‚å¦‚æœæ²¡æœ‰å¯ç”¨åˆ†æï¼Œè¿™äº›ä¸Šä¸‹æ–‡å°†æ— æ•ˆã€‚

```py
with profiler.record_function("forward_pass"):
  result = model(**batch)

with profiler.record_function("train_step"):
  step(**result)
```

è¿™æ ·ï¼Œä½ ä½¿ç”¨çš„æ ‡ç­¾å°†åœ¨è½¨è¿¹ä¸­å¯è§ã€‚è¿™æ ·ï¼Œè¯†åˆ«ä»£ç å—ä¼šæ›´åŠ å®¹æ˜“ã€‚ç”šè‡³åœ¨æ¨¡å¼çš„ forward ä¸­è¿›è¡Œæ›´ç»†ç²’åº¦çš„åˆ†æï¼š

```py
with profiler.record_function("transformer_layer:self_attention"):
  data = self.self_attention(**data)

...

with profiler.record_function("transformer_layer:encoder_attention"):
  data = self.encoder_attention(**data, **encoder_data)
```

# ç†è§£ PyTorch è½¨è¿¹

æ”¶é›†è½¨è¿¹åï¼Œåœ¨ tensorboard ä¸­æ‰“å¼€å®ƒä»¬ã€‚è¿™å°±æ˜¯ CPU + CUDA åˆ†æçš„æ ·å­ï¼š

![](img/b207f5f91e4560da06402145f3cfb486.png)

Â© ç‰ˆæƒ 2024ï¼ŒPyTorch | [`pytorch.org/tutorials/intermediate/tensorboard_profiler_tutorial.html`](https://pytorch.org/tutorials/intermediate/tensorboard_profiler_tutorial.html?ref=alexdremov.me)

ç«‹åˆ»æ‰¾åˆ°ä»»ä½•è®­ç»ƒçš„æ ¸å¿ƒéƒ¨åˆ†ï¼š

+   æ•°æ®åŠ è½½

+   å‰å‘ä¼ æ’­

+   åå‘ä¼ æ’­

åå‘ä¼ æ’­ç”± PyTorch åœ¨å•ç‹¬çš„çº¿ç¨‹ä¸­å¤„ç†ï¼ˆå¦‚ä¸Šå›¾ä¸­çš„çº¿ç¨‹ 16893ï¼‰ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“è¯†åˆ«ã€‚

# æ•°æ®åŠ è½½

å¯¹äºæ•°æ®åŠ è½½ï¼Œæˆ‘ä»¬å¸Œæœ›æ¥è¿‘é›¶çš„æ—¶é—´ã€‚

æ²¡æœ‰å¦¥åã€‚

è¿™æ˜¯å› ä¸ºåœ¨æ•°æ®åŠ è½½æœŸé—´ GPU ä¸åšä»»ä½•äº‹æƒ…ï¼Œè¿™ä¼šå¯¼è‡´å¯ç”¨èµ„æºçš„ä½æ•ˆåˆ©ç”¨ã€‚ç„¶è€Œï¼Œæ•°æ®å¤„ç†å¯ä»¥ä¸ GPU è®¡ç®—é‡å ï¼Œå› ä¸ºå®ƒä»¬æ˜¯ç‹¬ç«‹çš„éƒ¨åˆ†ã€‚

ä½ å¯ä»¥è½»æ¾åœ°è¯†åˆ« GPU é—²ç½®çš„åŒºåŸŸâ€”â€”åªéœ€æŸ¥çœ‹åˆ†æå™¨è·Ÿè¸ªä¸­çš„ *GPU ä¼°ç®— SM æ•ˆç‡* å’Œ *GPU åˆ©ç”¨ç‡* æ•°å€¼ã€‚æ²¡æœ‰æ´»åŠ¨çš„åŒºåŸŸå°±æ˜¯æˆ‘ä»¬çš„â€œæ‚£è€…â€ã€‚è¿™å°±æ˜¯ GPU ä»€ä¹ˆä¹Ÿä¸åšçš„åœ°æ–¹ã€‚

ä¸€ä¸ªç®€å•çš„è§£å†³æ–¹æ¡ˆæ˜¯ï¼š

+   åœ¨åå°è¿›ç¨‹ä¸­å¤„ç†æ•°æ®ï¼ˆæ²¡æœ‰ GILï¼‰

+   åœ¨å¹¶è¡Œè¿›ç¨‹ä¸­å¤„ç†æ•°æ®å¢å¼ºå’Œå˜æ¢

å¦‚æœä½ ä½¿ç”¨ PyTorch çš„ DataLoaderï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡æŒ‡å®š `num_workers` æ¥è½»æ¾å®ç°è¿™ä¸€ç‚¹ã€‚å¦‚æœä½ ä½¿ç”¨ `IterableDataset`ï¼Œæƒ…å†µä¼šæ›´å¤æ‚ï¼Œå› ä¸ºæ•°æ®å°†ä¼šé‡å¤ã€‚ä½†è¿™ä¸ªé—®é¢˜ä»ç„¶å¯ä»¥é€šè¿‡ä½¿ç”¨ [get_worker_info()](https://pytorch.org/docs/stable/data.html?ref=alexdremov.me#torch.utils.data.IterableDataset) æ¥è§£å†³â€”â€”ä½ éœ€è¦è°ƒæ•´è¿­ä»£æ–¹å¼ï¼Œä»¥ç¡®ä¿æ¯ä¸ªå·¥ä½œè¿›ç¨‹æ¥æ”¶ä¸åŒä¸”ä¸é‡å çš„è¡Œã€‚

å¯¹äºæ›´å¯é…ç½®çš„å¤„ç†ï¼Œä½ å¯ä»¥è€ƒè™‘ä½¿ç”¨ `multiprocessing` è‡ªè¡Œå®ç°å¤šè¿›ç¨‹å˜æ¢

> ğŸ’¡ å¦‚æœä½ ä»æœªæ£€æŸ¥è¿‡ä»£ç çš„æ•°æ®å¤„ç†é€Ÿåº¦ï¼Œé‚£ä¹ˆè¿™ä¸ªå°å°çš„ä¿®æ”¹å¯èƒ½ä¼šå¸¦æ¥ **å‰§çƒˆçš„åŠ é€Ÿ**ã€‚

# ä¸å†…å­˜åˆ†é…å™¨æˆä¸ºæœ‹å‹

ä½ å¸Œæœ›ä¸ PyTorch çš„ CUDA ç¼“å­˜åˆ†é…å™¨æˆä¸ºæœ‹å‹ã€‚

å½“ä½ åœ¨ CUDA è®¾å¤‡ä¸Šä½¿ç”¨ PyTorch åˆ†é…å¼ é‡æ—¶ï¼ŒPyTorch ä¼šä½¿ç”¨ä¸€ä¸ªç¼“å­˜åˆ†é…å™¨ã€‚è¿™æ˜¯å› ä¸º `cudaMalloc`/ `cudaFree` æ˜¯æ˜‚è´µçš„æ“ä½œï¼Œæˆ‘ä»¬å¸Œæœ›é¿å…è°ƒç”¨å®ƒä»¬ï¼Œå› æ­¤ PyTorch æœ‰è‡ªå·±çš„åˆ†é…å™¨ï¼Œå®ƒä¼šå°è¯•é‡ç”¨é€šè¿‡ `cudaMalloc` åˆ†é…çš„å—ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœ PyTorch çš„åˆ†é…å™¨æœ‰åˆé€‚çš„å—å¯ç”¨ï¼Œå®ƒä¼šç›´æ¥æä¾›ï¼Œè€Œä¸éœ€è¦è°ƒç”¨ `cudaMalloc`ã€‚è¿™æ ·ï¼Œ`cudaMalloc` åªä¼šåœ¨ä¸€å¼€å§‹è°ƒç”¨ã€‚

ç„¶è€Œï¼Œå¦‚æœä½ å¤„ç†çš„æ˜¯é•¿åº¦å¯å˜çš„æ•°æ®ï¼Œä¸åŒçš„å‰å‘ä¼ é€’å°†éœ€è¦ä¸åŒå¤§å°çš„ä¸­é—´å¼ é‡ã€‚å› æ­¤ï¼ŒPyTorch çš„åˆ†é…å™¨å¯èƒ½æ²¡æœ‰åˆé€‚çš„æ•°æ®å—å¯ç”¨ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåˆ†é…å™¨ä¼šå´©æºƒå¹¶é€šè¿‡è°ƒç”¨ `cudaFree` é‡Šæ”¾ä¹‹å‰åˆ†é…çš„å—ï¼Œä»¥ä¸ºæ–°çš„åˆ†é…è…¾å‡ºç©ºé—´ã€‚

ä¹‹åï¼Œåˆ†é…å™¨å¼€å§‹é‡æ–°æ„å»ºå®ƒçš„ç¼“å­˜ï¼Œè¿›è¡Œå¤§é‡çš„ `cudaMalloc`ï¼Œè¿™æ˜¯ä¸€é¡¹æ˜‚è´µçš„æ“ä½œã€‚ä½ å¯ä»¥é€šè¿‡æŸ¥çœ‹å¼ é‡æ¿åˆ†æå™¨è§†å›¾çš„å†…å­˜åˆ†æéƒ¨åˆ†æ¥å‘ç°è¿™ä¸ªé—®é¢˜ã€‚

> ğŸ’¡ ä½ ä¹Ÿå¯ä»¥åœ¨è·Ÿè¸ªè®°å½•ä¸­å‘ç°è¿™ä¸ªé—®é¢˜ã€‚å®ƒå°†ä»¥å¯¹ `cudaMalloc` å’Œ `cudaFree` çš„è°ƒç”¨å½¢å¼æ˜¾ç¤ºå‡ºæ¥

![](img/414070253ac9c94f59f8f522399d7fb4.png)

PyTorch åˆ†é…å™¨å´©æºƒ | å›¾ç‰‡æ¥è‡ªä½œè€…

å¦‚ä½ æ‰€è§ï¼Œä¸åˆ†é…å™¨ä¿ç•™çš„å†…å­˜å¯¹åº”çš„çº¢çº¿ä¸æ–­å˜åŒ–ã€‚è¿™æ„å‘³ç€ PyTorch çš„åˆ†é…å™¨æ— æ³•æœ‰æ•ˆåœ°å¤„ç†åˆ†é…è¯·æ±‚ã€‚

å½“åˆ†é…æ“ä½œä¸å†è®©åˆ†é…å™¨å´©æºƒæ—¶ï¼Œçº¢çº¿å®Œå…¨æ˜¯ç›´çš„

![](img/e8e801553645665ba7dff138173a00cd.png)

PyTorch åˆ†é…å™¨æŒ‰é¢„æœŸå·¥ä½œ | å›¾ç‰‡æ¥è‡ªä½œè€…

å¦‚æˆ‘æ‰€è¯´ï¼Œè¿™é€šå¸¸æ˜¯ç”±äºå¼ é‡çš„å½¢çŠ¶ä¸å›ºå®šã€‚å¦‚ä½•ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼Ÿ

## **å¯æ‰©å±•çš„æ®µ**

ç¬¬ä¸€ä»¶å€¼å¾—å°è¯•çš„äº‹æƒ…æ˜¯è®¾ç½® PyTorch ç›¸å¯¹è¾ƒæ–°çš„åˆ†é…å™¨æ¨¡å¼ï¼š

```py
PYTORCH_CUDA_ALLOC_CONF="expandable_segments:True"
```

> *å¦‚æœè®¾ç½®ä¸º* `*True*`*ï¼Œæ­¤è®¾ç½®æŒ‡ç¤ºåˆ†é…å™¨åˆ›å»ºå¯ä»¥åœ¨ä»¥åæ‰©å±•çš„ CUDA åˆ†é…ï¼Œä»¥æ›´å¥½åœ°å¤„ç†å·¥ä½œè´Ÿè½½é¢‘ç¹æ›´æ”¹åˆ†é…å¤§å°çš„æƒ…å†µï¼Œä¾‹å¦‚æ‰¹é‡å¤§å°å˜åŒ–çš„æƒ…å†µã€‚*

æ‰€ä»¥ï¼Œè¿™å‘Šè¯‰ PyTorch åˆ†é…å™¨åˆ†é…å°†æ¥å¯èƒ½ä¼šæ‰©å±•çš„å—ï¼Œè¿™æ­£æ˜¯æˆ‘ä»¬çš„æƒ…å†µã€‚å°½ç®¡å¦‚æ­¤ï¼Œå¦‚æœå¤§å°å˜åŒ–è¿‡å¤§ï¼Œä»ç„¶å¯èƒ½æ— æ³•è§£å†³é—®é¢˜ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè½¬åˆ°ä¸‹ä¸€ä¸ªé€‰é¡¹ã€‚

## **ä½¿åˆ†é…çš„å˜åŒ–æ›´å°‘**

å¦ä¸€ç§å¯èƒ½çš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿æ•°æ®å½¢çŠ¶ä¿æŒä¸€è‡´ã€‚è¿™æ ·ï¼Œåˆ†é…å™¨å°†æ›´å®¹æ˜“æ‰¾åˆ°ä¸€ä¸ªé€‚åˆé‡ç”¨çš„æ•°æ®å—ã€‚

ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œä½ å¯ä»¥å°†æ•°æ®å¡«å……åˆ°ç›¸åŒçš„å¤§å°ã€‚æˆ–è€…ä½ å¯ä»¥é€šè¿‡è¿è¡Œä¸€ä¸ªå…·æœ‰æœ€å¤§è¾“å…¥å¤§å°çš„æ¨¡å‹æ¥é¢„çƒ­åˆ†é…å™¨ã€‚

ä½ å¯ä»¥åœ¨ä»¥ä¸‹æ–‡ç« ä¸­äº†è§£æ›´å¤šå…³äº PyTorch åˆ†é…å™¨ä¿®æ”¹çš„ä¿¡æ¯ã€‚

[## CUDA è¯­ä¹‰ - PyTorch 2.3 æ–‡æ¡£

### torch.cuda çš„æŒ‡å—ï¼ŒPyTorch æ¨¡å—ç”¨äºæ‰§è¡Œ CUDA æ“ä½œ

pytorch.org](https://pytorch.org/docs/stable/notes/cuda.html?ref=alexdremov.me&source=post_page-----9c9d4899313d--------------------------------)

# æ•´ç†åˆ†é…å†å²

æˆ‘ä»¬å¸Œæœ›ä½¿ç”¨æ‰€æœ‰å¯ç”¨çš„ GPU å†…å­˜â€”â€”è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿè¿è¡Œæ›´å¤§çš„æ‰¹æ¬¡å¹¶æ›´å¿«åœ°å¤„ç†æ•°æ®ã€‚ç„¶è€Œï¼Œåœ¨æŸä¸ªæ—¶åˆ»ï¼Œå½“å¢åŠ æ‰¹é‡å¤§å°æ—¶ï¼Œä½ å°†é‡åˆ°*CUDA å†…å­˜ä¸è¶³*é”™è¯¯ã€‚æ˜¯ä»€ä¹ˆå¯¼è‡´äº†è¿™ä¸ªé”™è¯¯ï¼Ÿ

ä¸ºäº†è°ƒè¯•è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥çœ‹åˆ†é…å™¨çš„å†…å­˜å†å²ã€‚å®ƒå¯ä»¥é€šè¿‡ PyTorch è®°å½•ï¼Œç„¶ååœ¨[`pytorch.org/memory_viz`](https://pytorch.org/memory_viz?ref=alexdremov.me)ä¸Šè¿›è¡Œå¯è§†åŒ–ã€‚

+   **å¼€å§‹ï¼š** `torch.cuda.memory._record_memory_history(max_entries=100000)`

+   **ä¿å­˜ï¼š** `torch.cuda.memory._dump_snapshot(file_name)`

+   **åœæ­¢ï¼š** `torch.cuda.memory._record_memory_history(enabled=None)`

å¯è§†åŒ–å°†æ˜¾ç¤ºå¦‚ä¸‹å†…å®¹ï¼š

![](img/270f72428251b625a672af134cf2f454.png)

Â© ç‰ˆæƒ 2024, PyTorch | [`pytorch.org/blog/understanding-gpu-memory-1/`](https://pytorch.org/blog/understanding-gpu-memory-1/?ref=alexdremov.me)

x è½´è¡¨ç¤ºæ—¶é—´ï¼Œy è½´è¡¨ç¤ºæ€»ä½¿ç”¨å†…å­˜ï¼Œå½©è‰²å—è¡¨ç¤ºå¼ é‡ã€‚å› æ­¤ï¼Œå®ƒæ˜¾ç¤ºäº†å¼ é‡ä½•æ—¶è¢«åˆ†é…ä»¥åŠä½•æ—¶è¢«é‡Šæ”¾ã€‚

ä½ å¯èƒ½ä¼šæ³¨æ„åˆ°çª„å°–å³°â€”â€”è¿™äº›æ˜¯å ç”¨å¤§é‡ç©ºé—´çš„çŸ­æš‚å¼ é‡ã€‚é€šè¿‡ç‚¹å‡»å¼ é‡ï¼Œä½ å¯ä»¥è·å¾—è¯¥å¼ é‡åˆ†é…çš„ä½ç½®ã€‚æˆ‘ä»¬å¸Œæœ›å°½é‡å‡å°‘è¿™äº›å°–å³°ï¼Œå› ä¸ºå®ƒä»¬é™åˆ¶äº†å†…å­˜çš„é«˜æ•ˆä½¿ç”¨ã€‚æ£€æŸ¥ä¸€ä¸‹æ˜¯ä»€ä¹ˆå¯¼è‡´äº†è¿™ä¸ªå°–å³°ï¼Œå¹¶è€ƒè™‘å…¶ä»–è®¡ç®—æ–¹å¼ã€‚

é™¤äº†å°–å³°å¤–ï¼Œæ£€æµ‹å†…å­˜æ³„æ¼ä¹Ÿå¾ˆå®¹æ˜“ï¼š

![](img/d257a3b5af410d7d0bb7b3e46ecda12d.png)

Â© ç‰ˆæƒ 2024, PyTorch | [`pytorch.org/blog/understanding-gpu-memory-1/`](https://pytorch.org/blog/understanding-gpu-memory-1/?ref=alexdremov.me)

æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼Œç¬¬ä¸€æ¬¡å‰å‘ä¼ æ’­åä¸€äº›æ•°æ®å¹¶æ²¡æœ‰è¢«æ¸…é™¤ã€‚é€šè¿‡ç‚¹å‡»è¿™äº›æ¨¡å—ï¼Œä½ å¯ä»¥å¤§è‡´äº†è§£è¿™äº›å¼ é‡æ¥è‡ªä½•å¤„ã€‚å›¾ä¸­æ˜¾ç¤ºçš„æ˜¯è®­ç»ƒæ­¥éª¤åæ¢¯åº¦æœªè¢«æ¸…é™¤çš„æƒ…å†µï¼Œè¿™å¯¼è‡´å®ƒä»¬åœ¨å‰å‘ä¼ æ’­è¿‡ç¨‹ä¸­ä»ç„¶å­˜åœ¨ï¼Œé™åˆ¶äº†å¢åŠ æ‰¹é‡å¤§å°ä»¥é€‚åº”æ›´å¤šæ•°æ®çš„èƒ½åŠ›ã€‚

[](https://pytorch.org/blog/understanding-gpu-memory-1/?ref=alexdremov.me&source=post_page-----9c9d4899313d--------------------------------) [## ç†è§£ GPU å†…å­˜ 1ï¼šå¯è§†åŒ–æ‰€æœ‰åˆ†é…éšæ—¶é—´å˜åŒ–

### åœ¨ä½ ä½¿ç”¨ PyTorch è¿›è¡Œ GPU è®¡ç®—çš„è¿‡ç¨‹ä¸­ï¼Œä½ å¯èƒ½å·²ç»ç†Ÿæ‚‰è¿™ä¸ªå¸¸è§çš„é”™è¯¯ä¿¡æ¯ï¼š

[pytorch.org](https://pytorch.org/blog/understanding-gpu-memory-1/?ref=alexdremov.me&source=post_page-----9c9d4899313d--------------------------------)

# åŠ é€Ÿæ¨¡å‹å¹¶å‡å°‘å†…å­˜ä½¿ç”¨

æœ‰ä»€ä¹ˆæ¯”è¿™æ›´å¥½çš„å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥é€šè¿‡ä½¿ç”¨**FlashAttention**å†…æ ¸æ¥è®¡ç®—ç‚¹ç§¯æ³¨æ„åŠ›ï¼Œä»è€Œå®ç°è¿™ä¸€ç›®æ ‡ã€‚

[](https://github.com/Dao-AILab/flash-attention?ref=alexdremov.me&source=post_page-----9c9d4899313d--------------------------------) [## GitHub - Dao-AILab/flash-attentionï¼šå¿«é€Ÿä¸”å†…å­˜é«˜æ•ˆçš„ç²¾ç¡®æ³¨æ„åŠ›

### å¿«é€Ÿä¸”å†…å­˜é«˜æ•ˆçš„ç²¾ç¡®æ³¨æ„åŠ›ã€‚é€šè¿‡åˆ›å»ºä¸€ä¸ªè´¦æˆ·ï¼Œä¸º Dao-AILab/flash-attention çš„å¼€å‘åšå‡ºè´¡çŒ®â€¦

[github.com](https://github.com/Dao-AILab/flash-attention?ref=alexdremov.me&source=post_page-----9c9d4899313d--------------------------------)

å¦‚æœä½ è¿˜æ²¡æœ‰å¬è¯´è¿‡ï¼Œå®ƒæ˜¯ä¸€ç§è®¡ç®—ç²¾ç¡®ç‚¹ç§¯æ³¨æ„åŠ›çš„æ–¹æ³•ï¼Œæ— éœ€æ˜¾å¼æ„é€ æ³¨æ„åŠ›çŸ©é˜µã€‚å®ƒä¼˜åŒ–äº† GPU çš„è¾“å…¥è¾“å‡ºæ“ä½œï¼Œä»è€Œæé«˜äº†é€Ÿåº¦ï¼Œå¹¶ä¸”**å¤§å¹…åº¦**å‡å°‘äº†å†…å­˜æ¶ˆè€—ã€‚ç®€ç›´æ²¡æœ‰ç†ç”±ä¸ä½¿ç”¨å®ƒã€‚

> ğŸ˜¡ ä¸å¹¸çš„æ˜¯ï¼Œæœ‰ä¸€ä¸ªç†ç”±ä¸èƒ½ä½¿ç”¨å®ƒâ€”â€”ç¡¬ä»¶ã€‚
> 
> Flash attention ä»…åœ¨å…¼å®¹ç¡¬ä»¶ä¸Šä½¿ç”¨`fp16`å’Œ`bf16`ç²¾åº¦ã€‚è¿™åŒ…æ‹¬ NVIDIA Ampereã€Hooper ç­‰æ¶æ„ã€‚

å…¶ä»–åº“åœ¨åº•å±‚ä½¿ç”¨äº† flash attentionï¼Œå› æ­¤ä½ å¯ä»¥è€ƒè™‘ä½¿ç”¨å…¶ä»–æ›´é€‚åˆä½ ä»£ç åº“çš„å˜ç§ã€‚

## **XFormers**

[](https://github.com/facebookresearch/xformers?ref=alexdremov.me&source=post_page-----9c9d4899313d--------------------------------) [## GitHub - facebookresearch/xformersï¼šå¯æ“ä½œä¸”ä¼˜åŒ–è¿‡çš„ Transformer æ„å»ºæ¨¡å—ï¼Œæ”¯æŒâ€¦

### å¯æ“ä½œä¸”ä¼˜åŒ–è¿‡çš„ Transformer æ„å»ºæ¨¡å—ï¼Œæ”¯æŒå¯ç»„åˆæ„å»ºã€‚ - facebookresearch/xformers

[github.com](https://github.com/facebookresearch/xformers?ref=alexdremov.me&source=post_page-----9c9d4899313d--------------------------------)

## **Transformer Engine**

[](https://github.com/NVIDIA/TransformerEngine?ref=alexdremov.me&source=post_page-----9c9d4899313d--------------------------------) [## GitHub - NVIDIA/TransformerEngineï¼šä¸€ä¸ªåŠ é€Ÿ Transformer æ¨¡å‹åœ¨ NVIDIA GPU ä¸Šçš„è¿è¡Œçš„åº“â€¦

### ä¸€ä¸ªåŠ é€Ÿ Transformer æ¨¡å‹åœ¨ NVIDIA GPU ä¸Šè¿è¡Œçš„åº“ï¼ŒåŒ…æ‹¬ä½¿ç”¨ 8 ä½æµ®ç‚¹ï¼ˆFP8ï¼‰ç²¾åº¦â€¦

[github.com](https://github.com/NVIDIA/TransformerEngine?ref=alexdremov.me&source=post_page-----9c9d4899313d--------------------------------)

## **PyTorch æœ¬èº«ï¼**

è¿™æ˜¯äº‹å®ï¼ŒPyTorch çš„æ–°ç‰ˆæœ¬å¯èƒ½ä¼šåœ¨é€‚ç”¨çš„æƒ…å†µä¸‹ä½¿ç”¨é—ªç”µæ³¨æ„åŠ›ï¼ˆflash attentionï¼‰ã€‚è¦æ¿€æ´»æ­¤æ¨¡å¼ï¼Œä½ éœ€è¦åœ¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨ä¸­æ‰§è¡Œæ³¨æ„åŠ›å—ï¼ŒæŒ‡å®šä½¿ç”¨å“ªç§æ³¨æ„åŠ›ç­–ç•¥ï¼š

[## torch.nn.functional.scaled_dot_product_attention - PyTorch 2.3 æ–‡æ¡£](https://pytorch.org/docs/stable/generated/torch.nn.functional.scaled_dot_product_attention.html?ref=alexdremov.me&source=post_page-----9c9d4899313d--------------------------------#torch-nn-functional-scaled-dot-product-attention)

### é˜…è¯» PyTorch Domains æ–‡æ¡£ï¼Œäº†è§£æ›´å¤šå…³äºç‰¹å®šé¢†åŸŸçš„åº“

[pytorch.org](https://pytorch.org/docs/stable/generated/torch.nn.functional.scaled_dot_product_attention.html?ref=alexdremov.me&source=post_page-----9c9d4899313d--------------------------------#torch-nn-functional-scaled-dot-product-attention)

# ä¼˜åŒ–å¤š GPU æ•°æ®å†—ä½™ â€” FSDP

å¦‚æœä½ ä½¿ç”¨å¤šä¸ª GPU è¿›è¡Œè®­ç»ƒï¼ŒåŸºæœ¬çš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨ `DistributedDataParallel` ç±»ã€‚è¿™æ ·ï¼Œå¤šä¸ªç›¸åŒçš„è¿›ç¨‹å°†è¢«å¯åŠ¨ï¼Œå¹¶ä¸”åœ¨åå‘ä¼ æ’­æ­¥éª¤ä¸­ä¼šèšåˆæ¢¯åº¦ã€‚

ç„¶è€Œï¼Œè¿™å¹¶ä¸æ˜¯æœ€ä¼˜çš„ï¼

é—®é¢˜åœ¨äºï¼Œå½“æˆ‘ä»¬å¯åŠ¨ç›¸åŒçš„è¿›ç¨‹æ—¶ï¼Œæ¯ä¸ª GPU ä¸Šéƒ½æœ‰ç›¸åŒçš„æ¨¡å‹å’Œä¼˜åŒ–å™¨çŠ¶æ€ï¼Œè¿™é€ æˆäº†å†—ä½™ã€‚è§£å†³æ–¹æ¡ˆæ˜¯å°†æ•°æ®åˆ†ç‰‡ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®Œå…¨åˆ†ç‰‡æ•°æ®å¹¶è¡Œçš„ PyTorch å°è£…æ¥å®ç°è¿™ä¸€ç‚¹ã€‚

![](img/b542604a9a173f89aed4bc0375e2e515.png)

Â© ç‰ˆæƒ 2024ï¼ŒPyTorch | https://pytorch.org/tutorials/intermediate/FSDP_tutorial.html

å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ

æ­£å¦‚æˆ‘æ‰€è¯´ï¼Œå½“åœ¨å¤šä¸ª GPU ä¸Šè®­ç»ƒæ—¶ï¼Œä½¿ç”¨ DDP æ—¶æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ç›¸åŒæ•°æ®çš„å‰¯æœ¬ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å®ç°å‡ ä¸ªå¢å¼ºåŠŸèƒ½æ¥ä¼˜åŒ–è¿™ä¸€è¿‡ç¨‹ï¼š

## åˆ†ç‰‡ä¼˜åŒ–å™¨çŠ¶æ€ï¼ˆZeRO 1ï¼‰

åœ¨ä½¿ç”¨ DDP è®­ç»ƒæ—¶ï¼Œæ¯ä¸ªè¿›ç¨‹æŒæœ‰ä¼˜åŒ–å™¨çŠ¶æ€çš„å®Œæ•´å‰¯æœ¬ã€‚è€Œä½¿ç”¨ ZeRO1 æ—¶ï¼Œæˆ‘ä»¬å°†è¿™äº›ä¼˜åŒ–å™¨çŠ¶æ€åœ¨æ‰€æœ‰çš„ rank ä¹‹é—´è¿›è¡Œåˆ†ç‰‡ï¼Œä½¿å¾—æ¯ä¸ª rank åªæŒæœ‰ä¼˜åŒ–å™¨çŠ¶æ€çš„ä¸€éƒ¨åˆ†ã€‚åœ¨åå‘ä¼ æ’­è¿‡ç¨‹ä¸­ï¼Œæ¯ä¸ª rank åªéœ€è¦æ”¶é›†ä¸å…¶å‚æ•°ç›¸å…³çš„ä¼˜åŒ–å™¨çŠ¶æ€æ¥è¿›è¡Œä¼˜åŒ–æ­¥éª¤ã€‚è¿™ç§å‡å°‘å†—ä½™çš„æ–¹å¼æœ‰åŠ©äºèŠ‚çœå†…å­˜ã€‚

> ğŸ’¡ åœ¨ Adam ä¸­ï¼Œç”±äºå…¶å‚æ•°å¤§çº¦æ˜¯æ¨¡å‹å¤§å°çš„ä¸¤å€ï¼Œå°†ä¼˜åŒ–å™¨çŠ¶æ€åˆ†ç‰‡åˆ° 8 ä¸ª rank ä¸­æ„å‘³ç€æ¯ä¸ª rank **ä»…å­˜å‚¨æ€»çŠ¶æ€å¤§å°çš„å››åˆ†ä¹‹ä¸€ï¼ˆ2/8ï¼‰ã€‚**

## åˆ†ç‰‡æ¢¯åº¦ï¼ˆZeRO 2ï¼‰

æˆ‘ä»¬å¯¹ä¼˜åŒ–å™¨çŠ¶æ€è¿›è¡Œåˆ†ç‰‡ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å°†ä¿®æ”¹ä¼˜åŒ–å™¨æ­¥éª¤ï¼Œä»¥ä¾¿ä¹Ÿå¯¹æ¢¯åº¦è¿›è¡Œåˆ†ç‰‡ã€‚å¦‚æœä¸€ä¸ª rank æ‹¥æœ‰éƒ¨åˆ†å‚æ•°çš„ä¼˜åŒ–å™¨çŠ¶æ€ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†ï¼š

+   èšåˆä¸è¯¥ rank æŒæœ‰çŠ¶æ€ç›¸å…³çš„æ‰€æœ‰æ¢¯åº¦

+   è®¡ç®—ä¼˜åŒ–æ­¥éª¤

+   å°†éƒ¨åˆ†å‚æ•°çš„ä¼˜åŒ–æ­¥éª¤å‘é€åˆ°æ‰€æœ‰å…¶ä»– rank

æ­£å¦‚ä½ æ‰€æ³¨æ„åˆ°çš„ï¼Œç°åœ¨æ¯ä¸ª rank ä¸å†éœ€è¦æŒæœ‰å®Œæ•´çš„æ¢¯åº¦å‰¯æœ¬ã€‚æˆ‘ä»¬å¯ä»¥åœ¨æ¢¯åº¦å¯ç”¨æ—¶ç«‹å³å°†å…¶å‘é€åˆ°ç›¸å…³çš„ rankã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥å‡å°‘å³°å€¼å†…å­˜æ¶ˆè€—ã€‚

## åˆ†ç‰‡æ¨¡å‹å‚æ•°ï¼ˆZeRO 3ï¼‰

è¿™å°†æ˜¯å²è¯—çº§çš„ã€‚

ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦åœ¨æ¯ä¸ª rank ä¸Šå­˜å‚¨æ¨¡å‹çš„å®Œæ•´å‰¯æœ¬ï¼Ÿè®©æˆ‘ä»¬åœ¨æ‰€æœ‰ rank ä¹‹é—´åˆ†ç‰‡æ¨¡å‹å‚æ•°ã€‚ç„¶åï¼Œæˆ‘ä»¬å°†åœ¨å‰å‘å’Œåå‘ä¼ æ’­è¿‡ç¨‹ä¸­æŒ‰éœ€å³æ—¶è·å–æ‰€éœ€çš„å‚æ•°ã€‚

> ğŸ’¡ å¯¹äºå¤§æ¨¡å‹ï¼Œè¿™äº›ä¼˜åŒ–å¯ä»¥æ˜¾è‘—å‡å°‘å†…å­˜æ¶ˆè€—ã€‚

## å¦‚ä½•ä½¿ç”¨ FSDPï¼Ÿ

å…¶å®éå¸¸ç®€å•ã€‚æˆ‘ä»¬åªéœ€è¦ç”¨ FSDP åŒ…è£…æ¨¡å‹ï¼š

```py
import torch
import torch.nn as nn
import torch.optim as optim
from torch.distributed.fsdp import FullyShardedDataParallel as FSDP

model = FSDP(model)

# it's critical to get parameters from the wrapped model
# as only a portion of them returned (sharded part)
optimizer = optim.Adam(model.parameters())

# consuct training as usual
train(model, optimizer)
```

ä½ è¿˜å¯ä»¥æŒ‡å®š FSDP çš„åˆ†ç‰‡ç­–ç•¥ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©`SHARD_GRAD_OP`ç­–ç•¥ï¼Œä»¥å®ç°ç±»ä¼¼ ZeRO2 çš„è¡Œä¸ºã€‚ä½ å¯ä»¥åœ¨è¿™é‡Œäº†è§£å…¶ä»–ç­–ç•¥ï¼š

[## FullyShardedDataParallel - PyTorch 2.3 æ–‡æ¡£](https://pytorch.org/docs/stable/fsdp.html?ref=alexdremov.me&source=post_page-----9c9d4899313d--------------------------------)

### ç”¨äºåœ¨æ•°æ®å¹¶è¡Œå·¥ä½œè€…ä¹‹é—´åˆ†é…åˆ†ç‰‡æ¨¡å—å‚æ•°çš„åŒ…è£…å™¨ã€‚è¿™ä¸ªçµæ„Ÿæ¥è‡ªäº Xu ç­‰äººä»¥åŠâ€¦â€¦

[pytorch.org](https://pytorch.org/docs/stable/fsdp.html?ref=alexdremov.me&source=post_page-----9c9d4899313d--------------------------------#torch.distributed.fsdp.ShardingStrategy)

æ­¤å¤–ï¼Œä½ è¿˜å¯ä»¥ä½¿ç”¨ FSDP åŒ…è£…å­æ¨¡å—ã€‚åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œåªä½¿ç”¨äº†ä¸€ä¸ª FSDP æ¨¡å—ï¼Œè¿™æ ·ä¼šé™ä½è®¡ç®—æ•ˆç‡å’Œå†…å­˜æ•ˆç‡ã€‚å®ƒçš„å·¥ä½œåŸç†æ˜¯ï¼Œå‡è®¾ä½ çš„æ¨¡å‹åŒ…å« 100 ä¸ª Linear å±‚ã€‚å¦‚æœä½ æ‰§è¡Œ FSDP(model)ï¼Œé‚£ä¹ˆå°†åªæœ‰ä¸€ä¸ª FSDP å•å…ƒåŒ…è£…æ•´ä¸ªæ¨¡å‹ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œallgather ä¼šæ”¶é›†æ‰€æœ‰ 100 ä¸ª Linear å±‚çš„å®Œæ•´å‚æ•°ï¼Œå› æ­¤ä¸ä¼šä¸ºå‚æ•°åˆ†ç‰‡èŠ‚çœ CUDA å†…å­˜ã€‚

ä½ å¯ä»¥æ˜¾å¼åœ°åŒ…è£…å­æ¨¡å—æˆ–å®šä¹‰è‡ªåŠ¨åŒ…è£…ç­–ç•¥ã€‚è¦äº†è§£æ›´å¤šå…³äº FSDP çš„ä¿¡æ¯ï¼Œè¯·é˜…è¯» PyTorch æŒ‡å—ï¼š

[](https://pytorch.org/tutorials/intermediate/FSDP_tutorial.html?ref=alexdremov.me&source=post_page-----9c9d4899313d--------------------------------) [## å…¥é—¨ï¼šå®Œå…¨åˆ†ç‰‡æ•°æ®å¹¶è¡Œ(FSDP) - PyTorch æ•™ç¨‹ 2.3.0+cu121â€¦

### æ³¨æ„ï¼šåœ¨ GitHub ä¸ŠæŸ¥çœ‹å’Œç¼–è¾‘æœ¬æ•™ç¨‹ã€‚å¤§è§„æ¨¡è®­ç»ƒ AI æ¨¡å‹æ˜¯ä¸€é¡¹å…·æœ‰æŒ‘æˆ˜æ€§çš„ä»»åŠ¡ï¼Œè¦æ±‚â€¦â€¦

[pytorch.org](https://pytorch.org/tutorials/intermediate/FSDP_tutorial.html?ref=alexdremov.me&source=post_page-----9c9d4899313d--------------------------------)

# ä½¿ç”¨`torch.compile`çš„ç¥å¥‡åŠ é€Ÿ

ä¹Ÿå°±æ˜¯è¯´ï¼Œtorch compile åªéœ€å¯ç”¨å®ƒï¼Œå°±å¯ä»¥è®©ä½ çš„ä»£ç åŠ é€Ÿå‡ ä¸ªç™¾åˆ†ç‚¹ã€‚

Torch ä¼šè·Ÿè¸ªä½ çš„æ‰§è¡Œå›¾ï¼Œå¹¶å°è¯•å°†å…¶ç¼–è¯‘ä¸ºé«˜æ•ˆçš„æ ¼å¼ï¼Œä»¥ä¾¿æ¨¡å‹å‡ ä¹å¯ä»¥åœ¨æ²¡æœ‰ Python è°ƒç”¨çš„æƒ…å†µä¸‹æ‰§è¡Œã€‚

åŸºæœ¬ä½¿ç”¨æ–¹æ³•æ˜¯å°†æ¨¡å‹ä¸ compile ä¸€èµ·åŒ…è£…ï¼š

```py
import torch

model = torch.compile(model)
```

è¿™å‡ ä¹ä¼šç«‹å³æ‰§è¡Œã€‚å®é™…çš„è·Ÿè¸ªåªä¼šåœ¨ç¬¬ä¸€æ¬¡å‰å‘ä¼ æ’­æ—¶å‘ç”Ÿã€‚

å®ƒè¿˜å…·æœ‰è®¸å¤šå€¼å¾—å°è¯•çš„é€‰é¡¹ï¼š

[## torch.compile - PyTorch 2.3 æ–‡æ¡£](https://pytorch.org/docs/stable/generated/torch.compile.html?ref=alexdremov.me&source=post_page-----9c9d4899313d--------------------------------#torch.compile)

### ä½¿ç”¨ TorchDynamo å’ŒæŒ‡å®šçš„åç«¯ä¼˜åŒ–ç»™å®šçš„æ¨¡å‹/å‡½æ•°ã€‚å…·ä½“æ¥è¯´ï¼Œå¯¹äºåœ¨â€¦â€¦

[pytorch.org](https://pytorch.org/docs/stable/generated/torch.compile.html?ref=alexdremov.me&source=post_page-----9c9d4899313d--------------------------------#torch.compile)

> ğŸ’¡ Torch ç¼–è¯‘å™¨æ˜¯ä¸€ä¸ªé‡è¦ç‰¹æ€§ï¼Œå°†åœ¨åç»­çš„å¸–å­ä¸­è®²è§£ï¼
> 
> æ•¬è¯·æœŸå¾…

åœ¨è¿™é‡Œäº†è§£æ›´å¤šå…³äº torch compile çš„ä¿¡æ¯ï¼š

[## Introduction to torch.compile - PyTorch Tutorials 2.3.0+cu121 documentation

### `torch.compile` å·²åŒ…å«åœ¨æœ€æ–°çš„ PyTorch ç‰ˆæœ¬ä¸­ã€‚åœ¨ GPU ä¸Šè¿è¡Œ TorchInductor éœ€è¦ Tritonï¼Œè€Œ Triton å·²åŒ…å«åœ¨â€¦

pytorch.org](https://pytorch.org/tutorials/intermediate/torch_compile_tutorial.html?ref=alexdremov.me&source=post_page-----9c9d4899313d--------------------------------)

# ç»“è®º

æœ¬æ–‡å¹¶éåŒ…å«æ‰€æœ‰è§£é‡Šï¼Œè€Œæ˜¯æä¾›äº†å€¼å¾—ç«‹å³å°è¯•çš„åŠ é€Ÿæ–¹æ³•æ¸…å•ã€‚å¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ©ï¼Œæ¬¢è¿ç•™è¨€è¯„è®ºï¼

è€ƒè™‘è®¢é˜…

*åŸæ–‡å‘è¡¨äº* [*https://alexdremov.me*](https://alexdremov.me/simple-ways-to-speedup-your-pytorch-model-training/) *äº 2024 å¹´ 5 æœˆ 28 æ—¥ã€‚*

*å›¾ç‰‡æ¥æºäº PyTorch åšå®¢ï¼Œè¿™æ˜¯ Linux åŸºé‡‘ä¼šçš„ä¸€ä¸ªé¡¹ç›®ï¼Œå— Linux åŸºé‡‘ä¼šçš„* [*æ”¿ç­–*](https://www.linuxfoundation.org/legal/terms)*çº¦æŸã€‚æ‰€ä»¥ï¼Œæ‰€æœ‰å›¾ç‰‡å‡å¯æŒ‰ç…§* [*åˆ›æ„å…±äº« 3.0 è®¸å¯åè®®*](http://creativecommons.org/licenses/by/3.0/) ä½¿ç”¨ã€‚*
