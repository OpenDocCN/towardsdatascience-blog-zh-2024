<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>SQL Server’s Secret Feature — Run Python and Add-Ons Natively In SQL Server</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>SQL Server’s Secret Feature — Run Python and Add-Ons Natively In SQL Server</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/sql-servers-secret-feature-run-python-and-add-ons-natively-in-sql-server-7f3c4efe5c00?source=collection_archive---------2-----------------------#2024-05-15">https://towardsdatascience.com/sql-servers-secret-feature-run-python-and-add-ons-natively-in-sql-server-7f3c4efe5c00?source=collection_archive---------2-----------------------#2024-05-15</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="e024" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx">Import Python libraries, manipulate and output SQL tables and more, all without leaving SQL server.</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hd he hf hg hh ab"><div><div class="ab hi"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@sasha.korovkina2003?source=post_page---byline--7f3c4efe5c00--------------------------------" rel="noopener follow"><div class="l hj hk by hl hm"><div class="l ed"><img alt="Sasha Korovkina" class="l ep by dd de cx" src="../Images/14eac2bafa3c5b417b8aecdef61e6ac3.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/1*KHjtG4QQbAqXlc9btm09Hw.png"/><div class="hn by l dd de em n ho eo"/></div></div></a></div></div><div class="hp ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--7f3c4efe5c00--------------------------------" rel="noopener follow"><div class="l hq hr by hl hs"><div class="l ed"><img alt="Towards Data Science" class="l ep by br ht cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hn by l br ht em n ho eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hu ab q"><div class="ab q hv"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hw hx bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hy" data-testid="authorName" href="https://medium.com/@sasha.korovkina2003?source=post_page---byline--7f3c4efe5c00--------------------------------" rel="noopener follow">Sasha Korovkina</a></p></div></div></div><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hw hx dx"><button class="ib ic ah ai aj ak al am an ao ap aq ar id ie if" disabled="">Follow</button></p></div></div></span></div></div><div class="l ig"><span class="bf b bg z dx"><div class="ab cn ih ii ij"><div class="ik il ab"><div class="bf b bg z dx ab im"><span class="in l ig">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hy ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--7f3c4efe5c00--------------------------------" rel="noopener follow"><p class="bf b bg z io ip iq ir is it iu iv bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">8 min read</span><div class="iw ix l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">May 15, 2024</span></div></span></div></span></div></div></div><div class="ab cp iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn"><div class="h k w ea eb q"><div class="kd l"><div class="ab q ke kf"><div class="pw-multi-vote-icon ed in kg kh ki"><div class=""><div class="kj kk kl km kn ko kp am kq kr ks ki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kt ku kv kw kx ky kz"><p class="bf b dy z dx"><span class="kk">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kj lc ld ab q ee le lf" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="lb"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg><p class="bf b dy z dx"><span class="pw-responses-count la lb">4</span></p></button></div></div></div><div class="ab q jo jp jq jr js jt ju jv jw jx jy jz ka kb kc"><div class="lg k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lh an ao ap id li lj lk" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep ll cn"><div class="l ae"><div class="ab cb"><div class="lm ln lo lp lq lr ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><h1 id="4f33" class="mj mk fq bf ml mm mn gq mo mp mq gt mr ms mt mu mv mw mx my mz na nb nc nd ne bk">The Problem</h1><p id="2d16" class="pw-post-body-paragraph nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fj bk">Within this project, we confront the challenge of managing 37,000 company names sourced from two distinct origins. The complexity lies in the potential discrepancy between how identical companies are listed across these sources.</p><h1 id="fb79" class="mj mk fq bf ml mm mn gq mo mp mq gt mr ms mt mu mv mw mx my mz na nb nc nd ne bk">The goal</h1><p id="89b5" class="pw-post-body-paragraph nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fj bk">The goal of this article is to teach you to run Python natively within Microsoft SQL server. To use add-ons and external libraries, as well as perform further processing on the resulting tables with SQL.</p><figure class="oe of og oh oi oj ob oc paragraph-image"><div role="button" tabindex="0" class="ok ol ed om bh on"><div class="ob oc od"><img src="../Images/48680f2725a6dfcc1b493153fd74a2e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*_zZKk7cPes8UaiJ_"/></div></div><figcaption class="op oq or ob oc os ot bf b bg z dx">Photo by <a class="af ou" href="https://unsplash.com/@christinhumephoto?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Christin Hume</a> on <a class="af ou" href="https://unsplash.com/?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Unsplash</a></figcaption></figure><h1 id="9647" class="mj mk fq bf ml mm mn gq mo mp mq gt mr ms mt mu mv mw mx my mz na nb nc nd ne bk">Initial Algorithm Build</h1><p id="b6f9" class="pw-post-body-paragraph nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fj bk">Here is the strategy I will follow when building the algorithms:</p><ol class=""><li id="935f" class="nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa pa pb pc bk"><strong class="nh fr">Blocking </strong>— Dividing datasets into smaller blocks or groups based on common attributes to reduce computational complexity in comparing records. It narrows down the search space and enhances efficiency in similarity search tasks.</li><li id="4519" class="nf ng fq nh b go pd nj nk gr pe nm nn no pf nq nr ns pg nu nv nw ph ny nz oa pa pb pc bk"><strong class="nh fr">Pre-processing</strong> — Cleaning and standardizing raw data to prepare it for analysis by tasks like lowercase conversion, punctuation removal, and stop word elimination. This step improves data quality and reduces noise.</li><li id="5984" class="nf ng fq nh b go pd nj nk gr pe nm nn no pf nq nr ns pg nu nv nw ph ny nz oa pa pb pc bk"><strong class="nh fr">Similarity search model application</strong> — Applying models to compute similarity or distance between pairs of records based on tokenized representations. This helps identify similar pairs, using metrics like cosine similarity or edit distance, for tasks like record linkage or deduplication.</li></ol><h2 id="7d5c" class="pi mk fq bf ml pj pk pl mo pm pn po mr no pp pq pr ns ps pt pu nw pv pw px py bk">Blocking</h2><p id="c93d" class="pw-post-body-paragraph nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fj bk">My datasets are highly disproportional — I have 1,361,373 entities in one table and only 37,171 company names in the second table. If I attempt to match on the unprocessed table, the algorithm would take a very long time to do so.</p><p id="2292" class="pw-post-body-paragraph nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa fj bk">In order to block the tables, we need to see what common characteristics there are between 2 datasets. In my case, the companies are all associated with internal projects. Hence I will do the following:</p><ol class=""><li id="17ec" class="nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa pa pb pc bk">Extract the distinct company name and project code from the smaller table.</li><li id="c719" class="nf ng fq nh b go pd nj nk gr pe nm nn no pf nq nr ns pg nu nv nw ph ny nz oa pa pb pc bk">Loop through the project codes and try to find them in the larger table.</li><li id="6b61" class="nf ng fq nh b go pd nj nk gr pe nm nn no pf nq nr ns pg nu nv nw ph ny nz oa pa pb pc bk">Map all of the funds for that project and take it out of the large table.</li><li id="2d3c" class="nf ng fq nh b go pd nj nk gr pe nm nn no pf nq nr ns pg nu nv nw ph ny nz oa pa pb pc bk"><em class="pz">Repeat for the next project!</em></li></ol><p id="bf9f" class="pw-post-body-paragraph nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa fj bk">This way, I will be reducing the large dataset with each iteration, while also making sure that the mapping is rapid due to a smaller, filtered dataset on the project level.</p><figure class="oe of og oh oi oj"><div class="qa io l ed"><div class="qb qc l"/></div><figcaption class="op oq or ob oc os ot bf b bg z dx">A simple script to extract the distinct project code and fund name.</figcaption></figure><p id="7dd7" class="pw-post-body-paragraph nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa fj bk">Now, I will filter both tables by the project code, like so:</p><figure class="oe of og oh oi oj"><div class="qa io l ed"><div class="qb qc l"/></div><figcaption class="op oq or ob oc os ot bf b bg z dx">A code example of filtered tables based on the project code.</figcaption></figure><p id="95ff" class="pw-post-body-paragraph nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa fj bk">With this approach, our small table only has 406 rows for project ‘ABC’ for us to map, while the big table has 15,973 rows for us to map against. This is a big reduction from the raw table.</p><h2 id="a2e4" class="pi mk fq bf ml pj pk pl mo pm pn po mr no pp pq pr ns ps pt pu nw pv pw px py bk">Program Structure</h2><p id="01c4" class="pw-post-body-paragraph nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fj bk">This project will consist of both Python and SQL functions on SQL server; here is a quick sketch of how the program will work to have a clearer understanding of each step:</p><figure class="oe of og oh oi oj ob oc paragraph-image"><div class="ob oc qd"><img src="../Images/8c0b4c640314563a02be34915c0316ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:578/format:webp/1*kH76z2PDS3v8k9UqpTSMlw.png"/></div><figcaption class="op oq or ob oc os ot bf b bg z dx">Program structure. Image created by author.</figcaption></figure><p id="316c" class="pw-post-body-paragraph nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa fj bk">Program execution:</p><ul class=""><li id="02ef" class="nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa qe pb pc bk">Printing the project code in a loop is the simplest version of this function:</li></ul><figure class="oe of og oh oi oj"><div class="qa io l ed"><div class="qb qc l"/></div><figcaption class="op oq or ob oc os ot bf b bg z dx">Code to recursively print out the names of companies.</figcaption></figure><p id="5031" class="pw-post-body-paragraph nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa fj bk">It quickly becomes apparent that the SQL cursor uses up too many resources. In short, this happens because cursors operate at row level and go through every row to make an operation.</p><blockquote class="qf qg qh"><p id="8b4c" class="nf ng pz nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa fj bk">More information on why cursors in SQL are inefficient and it is best to avoid them can be found here: <a class="af ou" href="https://stackoverflow.com/questions/4568464/sql-server-temporary-tables-vs-cursors" rel="noopener ugc nofollow" target="_blank">https://stackoverflow.com/questions/4568464/sql-server-temporary-tables-vs-cursors</a> (answer 2)</p></blockquote><p id="4fd2" class="pw-post-body-paragraph nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa fj bk">To increase the performance, I will use temporary tables and remove the cursor. Here is the resulting function:</p><figure class="oe of og oh oi oj"><div class="qa io l ed"><div class="qb qc l"/></div><figcaption class="op oq or ob oc os ot bf b bg z dx">A function to select all values from the large mapping table based on the project code.</figcaption></figure><p id="7942" class="pw-post-body-paragraph nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa fj bk">This now takes about 3 seconds per project to select the project code and the data from the large mapping table, filtered by that project.</p><p id="170f" class="pw-post-body-paragraph nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa fj bk">For demonstration purposes, I will only focus on 2 projects, however I will return to running the function on all projects when doing so on production.</p><p id="852b" class="pw-post-body-paragraph nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa fj bk">The final function we will be working with looks like this:</p><figure class="oe of og oh oi oj"><div class="qa io l ed"><div class="qb qc l"/></div><figcaption class="op oq or ob oc os ot bf b bg z dx">I have commented out the function definition to make the code easier to debug and set a limit on the first 2 projects</figcaption></figure><h2 id="5319" class="pi mk fq bf ml pj pk pl mo pm pn po mr no pp pq pr ns ps pt pu nw pv pw px py bk">Mapping Table Preparation</h2><p id="f890" class="pw-post-body-paragraph nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fj bk">The next step is to prepare the data for the Python pre-processing and mapping functions, for this we will need 2 datasets:</p><ol class=""><li id="927a" class="nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa pa pb pc bk">The filtered data by project code from the large mapping table</li><li id="d020" class="nf ng fq nh b go pd nj nk gr pe nm nn no pf nq nr ns pg nu nv nw ph ny nz oa pa pb pc bk">The filtered data by project code from the small companies table</li></ol><p id="bdd8" class="pw-post-body-paragraph nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa fj bk">Here is what the updated function looks like with the data from 2 tables being selected:</p><figure class="oe of og oh oi oj"><div class="qa io l ed"><div class="qb qc l"/></div><figcaption class="op oq or ob oc os ot bf b bg z dx">Selecting the small companies table and the large mapping table from the database.</figcaption></figure><blockquote class="qf qg qh"><p id="1cd0" class="nf ng pz nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa fj bk">Important: pythonic functions in SQL only take in <strong class="nh fr">1 table input.</strong> Make sure to put your data into a <strong class="nh fr">single wide table </strong>before feeding it into a Python function in SQL.</p></blockquote><figure class="oe of og oh oi oj"><div class="qa io l ed"><div class="qb qc l"/></div><figcaption class="op oq or ob oc os ot bf b bg z dx">Tables with sources</figcaption></figure><p id="3fa7" class="pw-post-body-paragraph nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa fj bk">As a result of this function, we get the projects, the company names and the sources for each project.</p><p id="eaa7" class="pw-post-body-paragraph nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa fj bk"><em class="pz">Now we are ready for Python!</em></p><h1 id="b0c0" class="mj mk fq bf ml mm mn gq mo mp mq gt mr ms mt mu mv mw mx my mz na nb nc nd ne bk">Python Execution in SQL</h1><p id="b37e" class="pw-post-body-paragraph nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fj bk">Python in SQL Server, through <code class="cx qi qj qk ql b">sp_execute_external_script</code>, allows you to run Python code directly within SQL Server.</p><p id="249c" class="pw-post-body-paragraph nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa fj bk">It enables integration of Python's capabilities into SQL workflows with data exchange between SQL and Python. In the provided example, a Python script is executed, creating a pandas DataFrame from input data.</p><p id="688f" class="pw-post-body-paragraph nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa fj bk">The result is returned as a single output.</p><p id="0c3a" class="pw-post-body-paragraph nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa fj bk"><em class="pz">How cool is that!</em></p><figure class="oe of og oh oi oj"><div class="qa io l ed"><div class="qb qc l"/></div><figcaption class="op oq or ob oc os ot bf b bg z dx">A simple example from <a class="af ou" href="https://learn.microsoft.com/en-us/sql/machine-learning/tutorials/quickstart-python-create-script?view=sql-server-ver16" rel="noopener ugc nofollow" target="_blank">https://learn.microsoft.com/en-us/sql/machine-learning/tutorials/quickstart-python-create-script?view=sql-server-ver16</a></figcaption></figure><p id="6f0d" class="pw-post-body-paragraph nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa fj bk">There are a few important things to note about running Python in SQL:</p><ol class=""><li id="9ddf" class="nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa pa pb pc bk">Strings are defined by double quotes (“), not single quotes (‘). Make sure to check this especially if you are using regex expressions, to avoid spending time on error tracing</li><li id="fd75" class="nf ng fq nh b go pd nj nk gr pe nm nn no pf nq nr ns pg nu nv nw ph ny nz oa pa pb pc bk">There is only 1 output permitted — so your Python code will result in 1 table on output</li><li id="99a4" class="nf ng fq nh b go pd nj nk gr pe nm nn no pf nq nr ns pg nu nv nw ph ny nz oa pa pb pc bk">You can use print statements for debugging and see the results be printed to the ‘Messages’ tab within your SQL server. Like so:</li></ol><figure class="oe of og oh oi oj ob oc paragraph-image"><div class="ob oc qm"><img src="../Images/eabb77002323fc84ca4d5e14307e5c1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1230/format:webp/1*3wuwZpliYbGn-mOc0puw4g.png"/></div><figcaption class="op oq or ob oc os ot bf b bg z dx">Image created by author.</figcaption></figure><h2 id="dec9" class="pi mk fq bf ml pj pk pl mo pm pn po mr no pp pq pr ns ps pt pu nw pv pw px py bk">Python Libraries In SQL</h2><p id="68d6" class="pw-post-body-paragraph nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fj bk">In SQL Server, several libraries come pre-installed and are readily accessible. To view the complete list of these libraries, you can execute the following command:</p><figure class="oe of og oh oi oj"><div class="qa io l ed"><div class="qb qc l"/></div><figcaption class="op oq or ob oc os ot bf b bg z dx">Code to retrieve all Python libraries available in SQL</figcaption></figure><p id="97aa" class="pw-post-body-paragraph nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa fj bk">Here is what the output will look like:</p><figure class="oe of og oh oi oj ob oc paragraph-image"><div class="ob oc qn"><img src="../Images/a0005c7da80a325bcfebd4fd488fa4f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:446/format:webp/1*bEgcASNw4e5aZRfVTDz3zA.png"/></div><figcaption class="op oq or ob oc os ot bf b bg z dx">You can import these packages just as you would do in a normal Python script (import …). Image created by author.</figcaption></figure><h1 id="16cd" class="mj mk fq bf ml mm mn gq mo mp mq gt mr ms mt mu mv mw mx my mz na nb nc nd ne bk">Matching Text With Python</h1><p id="dac8" class="pw-post-body-paragraph nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fj bk">Coming back to our generated table, we can now match the company names from different sources using Python. Our Python procedure will take in the long table and output a table with the mapped entities. It should show the match it thinks is most likely from the large mapping table next to each record from the small company table.</p><figure class="oe of og oh oi oj ob oc paragraph-image"><div role="button" tabindex="0" class="ok ol ed om bh on"><div class="ob oc qo"><img src="../Images/3faaa5ea0e419159d1b79f2598c15a7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wuicmN_zX47dXYWvu3SC-g.png"/></div></div><figcaption class="op oq or ob oc os ot bf b bg z dx">Assuming that Company 1.1 is the closest match to Company 1, the output should look like the output above. Image created by author.</figcaption></figure><p id="2481" class="pw-post-body-paragraph nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa fj bk">To do this, let’s first add a Python function to our SQL procedure. The first step is to simply feed in the dataset into Python, I will do this with a sample dataset and then with our data, here is the code:</p><figure class="oe of og oh oi oj"><div class="qa io l ed"><div class="qb qc l"/></div><figcaption class="op oq or ob oc os ot bf b bg z dx">Code which feeds the data into the database — both tables are present in the Python function.</figcaption></figure><p id="1afc" class="pw-post-body-paragraph nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa fj bk">This system allows us to feed in both of our tables into the pythonic function as inputs, it then prints both tables as outputs.</p><h2 id="cfef" class="pi mk fq bf ml pj pk pl mo pm pn po mr no pp pq pr ns ps pt pu nw pv pw px py bk">Pre-Processing In Python</h2><p id="827d" class="pw-post-body-paragraph nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fj bk">In order to match our strings effectively, we must conduct some preprocessing in Python, this includes:</p><ol class=""><li id="2e41" class="nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa pa pb pc bk">Remove accents and other language-specific special characters</li><li id="fafe" class="nf ng fq nh b go pd nj nk gr pe nm nn no pf nq nr ns pg nu nv nw ph ny nz oa pa pb pc bk">Remove the white spaces</li><li id="6fbf" class="nf ng fq nh b go pd nj nk gr pe nm nn no pf nq nr ns pg nu nv nw ph ny nz oa pa pb pc bk">Remove punctuation</li></ol><p id="7ca4" class="pw-post-body-paragraph nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa fj bk">The first step will be done with collation in SQL, while the other 2 will be present in the preprocessing step of the Python function.</p><p id="4eb2" class="pw-post-body-paragraph nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa fj bk">Here is what our function with preprocessing looks like:</p><figure class="oe of og oh oi oj"><div class="qa io l ed"><div class="qb qc l"/></div></figure><p id="00ec" class="pw-post-body-paragraph nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa fj bk">The result of this is 3 columns, one with the name of the company in small, lower cap and no space letters, the second column is the project column and the third column is the source.</p><h2 id="b786" class="pi mk fq bf ml pj pk pl mo pm pn po mr no pp pq pr ns ps pt pu nw pv pw px py bk">Matching Strings In Python</h2><p id="df0b" class="pw-post-body-paragraph nf ng fq nh b go ni nj nk gr nl nm nn no np nq nr ns nt nu nv nw nx ny nz oa fj bk">Here we have to be creative as we are pretty limited with the number of libraries which we can use. Therefore, let’s first identify how we would want our output to look.</p><p id="50bf" class="pw-post-body-paragraph nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa fj bk">We want to match the data coming from source 2, to the data in source 1. Therefore, for each value in source 2, we should have a bunch of matching values from source 1 with scores to represent the closeness of the match.</p><figure class="oe of og oh oi oj ob oc paragraph-image"><div class="ob oc qp"><img src="../Images/4657f47f36ebc80037d84480da67c89d.png" data-original-src="https://miro.medium.com/v2/resize:fit:746/format:webp/1*qnL4HVNI3G5cWEPSy7qLJw.png"/></div><figcaption class="op oq or ob oc os ot bf b bg z dx">Output table structure. Image created by author.</figcaption></figure><p id="5d81" class="pw-post-body-paragraph nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa fj bk">We will use <strong class="nh fr">python built-in libraries </strong>first, to avoid the need for library imports and hence simplify the job.</p><p id="ea92" class="pw-post-body-paragraph nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa fj bk">The logic:</p><ol class=""><li id="8fec" class="nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa pa pb pc bk">Loop through each project</li><li id="981a" class="nf ng fq nh b go pd nj nk gr pe nm nn no pf nq nr ns pg nu nv nw ph ny nz oa pa pb pc bk">Make a table with the funds by source, where source 1 is the large table with the mapping data and 2 is the initial company dataset</li><li id="6ef1" class="nf ng fq nh b go pd nj nk gr pe nm nn no pf nq nr ns pg nu nv nw ph ny nz oa pa pb pc bk">Select the data from the small dataset into an array</li><li id="e9f7" class="nf ng fq nh b go pd nj nk gr pe nm nn no pf nq nr ns pg nu nv nw ph ny nz oa pa pb pc bk">Compare each element in the resulting array to each element in the large mapping data frame</li><li id="a0b9" class="nf ng fq nh b go pd nj nk gr pe nm nn no pf nq nr ns pg nu nv nw ph ny nz oa pa pb pc bk">Return the scores for each entity</li></ol><p id="f3a5" class="pw-post-body-paragraph nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa fj bk">The code:</p><figure class="oe of og oh oi oj"><div class="qa io l ed"><div class="qb qc l"/></div><figcaption class="op oq or ob oc os ot bf b bg z dx">Code to map data from the large dataset to a small subset of data. Keep in mind to use your own joins and data structure.</figcaption></figure><p id="7eb2" class="pw-post-body-paragraph nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa fj bk">And here is the final output:</p><figure class="oe of og oh oi oj ob oc paragraph-image"><div class="ob oc qq"><img src="../Images/8e758c53c4c91f9cf28880d0f716c184.png" data-original-src="https://miro.medium.com/v2/resize:fit:864/format:webp/1*2uDZAK0_-uq2F_8r0oUmlw.png"/></div><figcaption class="op oq or ob oc os ot bf b bg z dx">This is made-up data to demonstrate the result, however the structure should be identical for your dataset. Image generated by author.</figcaption></figure><p id="2792" class="pw-post-body-paragraph nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa fj bk">In this table, we have each company name, the project which it belongs to and the source — whether it is from the large mapping table or the small companies table. The score on the right indicates the similarity metric between the company name from source 2 and source 1. It is important to note that company4, which came from source 2, will always have a score of 1–100% match, as it is being matched against itself.</p><p id="27bf" class="pw-post-body-paragraph nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa fj bk">Executing Python scripts within SQL Server via the Machine Learning Services is a powerful feature that allows for in-database analytics and machine learning tasks. This integration enables direct data access without the need for data movement, significantly optimizing performance and security for data-intensive operations.</p><p id="0bbd" class="pw-post-body-paragraph nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa fj bk">However, there are limitations to be aware of. The environment supports a <strong class="nh fr">single input</strong>, which might restrict the complexity of tasks that can be performed directly within the SQL context. Additionally, only a <strong class="nh fr">limited set of Python libraries are available</strong>, which may require alternative solutions for certain types of data analysis or machine learning tasks not supported by the default libraries. Furthermore, users must navigate the intricacies of SQL Server’s environment, such as complex spacing in T-SQL queries that include Python code, which can be a source of errors and confusion.</p><p id="87b1" class="pw-post-body-paragraph nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa fj bk">Despite these challenges, there are numerous applications where executing Python in SQL Server is advantageous:</p><p id="7d60" class="pw-post-body-paragraph nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa fj bk">1. <strong class="nh fr">Data Cleansing and Transformation — </strong>Python can be used directly in SQL Server to perform complex data preprocessing tasks, like handling missing data or normalizing values, before further analysis or reporting.</p><p id="4ca6" class="pw-post-body-paragraph nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa fj bk">2. <strong class="nh fr">Predictive Analytics </strong>— Deploying Python machine learning models directly within SQL Server allows for real-time predictions, such as customer churn or sales forecasting, using live database data.</p><p id="f729" class="pw-post-body-paragraph nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa fj bk">3. <strong class="nh fr">Advanced Analytics </strong>— Python’s capabilities can be leveraged to perform sophisticated statistical analysis and data mining directly on the database, aiding in decision-making processes without the latency of data transfer.</p><p id="7885" class="pw-post-body-paragraph nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa fj bk">4. <strong class="nh fr">Automated Reporting and Visualization</strong> — Python scripts can generate data visualizations and reports directly from SQL Server data, enabling automated updates and dashboards.</p><p id="e00e" class="pw-post-body-paragraph nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa fj bk">5. <strong class="nh fr">Operationalizing Machine Learning Models </strong>— By integrating Python in SQL Server, models can be updated and managed directly within the database environment, simplifying the operational workflow.</p><p id="e053" class="pw-post-body-paragraph nf ng fq nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa fj bk">In conclusion, while the execution of Python in SQL Server presents some challenges, it also opens up a wealth of possibilities for enhancing and simplifying data processing, analysis, and predictive modeling directly within the database environment.</p><blockquote class="qf qg qh"><p id="b3c9" class="nf ng pz nh b go ov nj nk gr ow nm nn no ox nq nr ns oy nu nv nw oz ny nz oa fj bk">PS to see more of my articles, you can follow me on LinkedIn here: <a class="af ou" href="https://www.linkedin.com/in/sasha-korovkina-5b992019b/" rel="noopener ugc nofollow" target="_blank">https://www.linkedin.com/in/sasha-korovkina-5b992019b/</a></p></blockquote></div></div></div></div>    
</body>
</html>