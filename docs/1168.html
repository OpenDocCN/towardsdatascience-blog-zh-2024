<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Routing in RAG-Driven Applications</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Routing in RAG-Driven Applications</h1>
<blockquote>原文：<a href="https://towardsdatascience.com/routing-in-rag-driven-applications-a685460a7220?source=collection_archive---------1-----------------------#2024-05-09">https://towardsdatascience.com/routing-in-rag-driven-applications-a685460a7220?source=collection_archive---------1-----------------------#2024-05-09</a></blockquote><div><div class="em fe ff fg fh fi"/><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><div/><div><h2 id="75cb" class="pw-subtitle-paragraph gn fp fq bf b go gp gq gr gs gt gu gv gw gx gy gz ha hb hc cq dx">Directing the application flow based on query intent</h2><div><div class="speechify-ignore ab cp"><div class="speechify-ignore bh l"><div class="hd he hf hg hh ab"><div><div class="ab hi"><div><div class="bm" aria-hidden="false"><a href="https://medium.com/@ssmaameri?source=post_page---byline--a685460a7220--------------------------------" rel="noopener follow"><div class="l hj hk by hl hm"><div class="l ed"><img alt="Sami Maameri" class="l ep by dd de cx" src="../Images/9e9892fe7d3cc53ad1c4d165145878ef.png" width="44" height="44" loading="lazy" data-testid="authorPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:88:88/1*idWYMwlRbOHeOx70A-XzMQ.jpeg"/><div class="hn by l dd de em n ho eo"/></div></div></a></div></div><div class="hp ab ed"><div><div class="bm" aria-hidden="false"><a href="https://towardsdatascience.com/?source=post_page---byline--a685460a7220--------------------------------" rel="noopener follow"><div class="l hq hr by hl hs"><div class="l ed"><img alt="Towards Data Science" class="l ep by br ht cx" src="../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png" width="24" height="24" loading="lazy" data-testid="publicationPhoto" data-original-src="https://miro.medium.com/v2/resize:fill:48:48/1*CJe3891yB1A1mzMdqemkdg.jpeg"/><div class="hn by l br ht em n ho eo"/></div></div></a></div></div></div></div></div><div class="bn bh l"><div class="ab"><div style="flex:1"><span class="bf b bg z bk"><div class="hu ab q"><div class="ab q hv"><div class="ab q"><div><div class="bm" aria-hidden="false"><p class="bf b hw hx bk"><a class="af ag ah ai aj ak al am an ao ap aq ar hy" data-testid="authorName" href="https://medium.com/@ssmaameri?source=post_page---byline--a685460a7220--------------------------------" rel="noopener follow">Sami Maameri</a></p></div></div></div><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span><p class="bf b hw hx dx"><button class="ib ic ah ai aj ak al am an ao ap aq ar id ie if" disabled="">Follow</button></p></div></div></span></div></div><div class="l ig"><span class="bf b bg z dx"><div class="ab cn ih ii ij"><div class="ik il ab"><div class="bf b bg z dx ab im"><span class="in l ig">Published in</span><div><div class="l" aria-hidden="false"><a class="af ag ah ai aj ak al am an ao ap aq ar hy ab q" data-testid="publicationName" href="https://towardsdatascience.com/?source=post_page---byline--a685460a7220--------------------------------" rel="noopener follow"><p class="bf b bg z io ip iq ir is it iu iv bk">Towards Data Science</p></a></div></div></div><div class="h k"><span class="hz ia" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div></div><span class="bf b bg z dx"><div class="ab ae"><span data-testid="storyReadTime">9 min read</span><div class="iw ix l" aria-hidden="true"><span class="l" aria-hidden="true"><span class="bf b bg z dx">·</span></span></div><span data-testid="storyPublishDate">May 9, 2024</span></div></span></div></span></div></div></div><div class="ab cp iy iz ja jb jc jd je jf jg jh ji jj jk jl jm jn"><div class="h k w ea eb q"><div class="kd l"><div class="ab q ke kf"><div class="pw-multi-vote-icon ed in kg kh ki"><div class=""><div class="kj kk kl km kn ko kp am kq kr ks ki"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" aria-label="clap"><path fill-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM15.421 1.84l-1.185-.388-.338 2.5zM9.757 1.452l-1.184.389 1.523 2.112zM20.253 11.84 17.75 7.438c-.238-.353-.57-.584-.93-.643a.96.96 0 0 0-.753.183 1.13 1.13 0 0 0-.443.695c.014.019.03.033.044.053l2.352 4.138c1.614 2.95 1.1 5.771-1.525 8.395a7 7 0 0 1-.454.415c.997-.13 1.927-.61 2.773-1.457 2.705-2.704 2.517-5.585 1.438-7.377M12.066 9.01c-.129-.687.08-1.299.573-1.773l-2.062-2.063a1.123 1.123 0 0 0-1.555 0 1.1 1.1 0 0 0-.273.521z" clip-rule="evenodd"/><path fill-rule="evenodd" d="M14.741 8.309c-.18-.267-.446-.455-.728-.502a.67.67 0 0 0-.533.127c-.146.113-.59.458-.199 1.296l1.184 2.503a.448.448 0 0 1-.236.755.445.445 0 0 1-.483-.248L7.614 6.106A.816.816 0 1 0 6.459 7.26l3.643 3.644a.446.446 0 1 1-.631.63L5.83 7.896l-1.03-1.03a.82.82 0 0 0-1.395.577.81.81 0 0 0 .24.576l1.027 1.028 3.643 3.643a.444.444 0 0 1-.144.728.44.44 0 0 1-.486-.098l-3.64-3.64a.82.82 0 0 0-1.335.263.81.81 0 0 0 .178.89l1.535 1.534 2.287 2.288a.445.445 0 0 1-.63.63l-2.287-2.288a.813.813 0 0 0-1.393.578c0 .216.086.424.238.577l4.403 4.403c2.79 2.79 5.495 4.119 8.681.931 2.269-2.271 2.708-4.588 1.342-7.086z" clip-rule="evenodd"/></svg></div></div></div><div class="pw-multi-vote-count l kt ku kv kw kx ky kz"><p class="bf b dy z dx"><span class="kk">--</span></p></div></div></div><div><div class="bm" aria-hidden="false"><button class="ao kj lc ld ab q ee le lf" aria-label="responses"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewbox="0 0 24 24" class="lb"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"/></svg><p class="bf b dy z dx"><span class="pw-responses-count la lb">7</span></p></button></div></div></div><div class="ab q jo jp jq jr js jt ju jv jw jx jy jz ka kb kc"><div class="lg k j i d"/><div class="h k"><div><div class="bm" aria-hidden="false"><button aria-controls="addToCatalogBookmarkButton" aria-expanded="false" aria-label="Add to list bookmark button" data-testid="headerBookmarkButton" class="af ee ah ai aj ak al lh an ao ap id li lj lk" disabled=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24" class="av"><path fill="#000" d="M17.5 1.25a.5.5 0 0 1 1 0v2.5H21a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-2.5H15a.5.5 0 0 1 0-1h2.5zm-11 4.5a1 1 0 0 1 1-1H11a.5.5 0 0 0 0-1H7.5a2 2 0 0 0-2 2v14a.5.5 0 0 0 .8.4l5.7-4.4 5.7 4.4a.5.5 0 0 0 .8-.4v-8.5a.5.5 0 0 0-1 0v7.48l-5.2-4a.5.5 0 0 0-.6 0l-5.2 4z"/></svg></button></div></div></div><div class="ep ll cn"><div class="l ae"><div class="ab cb"><div class="lm ln lo lp lq lr ci bh"><div class="ab"><div class="bm bh" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="Listen" data-testid="audioPlayButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Listen</p></div></button></div></div></div></div></div></div></div></div><div class="bm" aria-hidden="false" aria-describedby="postFooterSocialMenu" aria-labelledby="postFooterSocialMenu"><div><div class="bm" aria-hidden="false"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" data-testid="headerSocialShareButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">Share</p></div></button></div></div></div><div class="bm" aria-hidden="false"><div><div class="bm" aria-hidden="false"><button aria-label="More options" data-testid="headerStoryOptionsButton" class="af ee ah ai aj ak al lh an ao ap id ls lt lf lu lv lw lx ly s lz ma mb mc md me mf u mg mh mi"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewbox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.385 12c0 .55.2 1.02.59 1.41.39.4.86.59 1.41.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.02.2-1.41.59-.4.39-.59.86-.59 1.41m5.62 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.42.59s1.02-.2 1.41-.59c.4-.39.59-.86.59-1.41s-.2-1.02-.59-1.41a1.93 1.93 0 0 0-1.41-.59c-.55 0-1.03.2-1.42.59s-.58.86-.58 1.41m5.6 0c0 .55.2 1.02.58 1.41.4.4.87.59 1.43.59s1.03-.2 1.42-.59.58-.86.58-1.41-.2-1.02-.58-1.41a1.93 1.93 0 0 0-1.42-.59c-.56 0-1.04.2-1.43.59s-.58.86-.58 1.41" clip-rule="evenodd"/></svg><div class="j i d"><p class="bf b bg z dx">More</p></div></button></div></div></div></div></div></div></div></div></div><p id="64d9" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Routing the control flow inside a RAG application based on the intent of the user’s query can help us create more useful and powerful Retrieval Augmented Generation (RAG) based applications.</p><p id="3bd6" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">The data we want to enable the user to interact with may well be coming from a diverse range of sources, such as from reports, documents, images, databases, and third party systems. For business-based RAG applications, we may want to enable the user to interact with information from a range of areas in the business also, such as from the sales, ordering and accounting systems.</p><p id="665c" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Because of this diverse range of data sources, the way the information is stored, and the way we want to interact with it, is likely to be diverse also. Some data may be stored in vector stores, some in SQL databases, and some we may need to access over API calls as it sits in third party systems.</p><figure class="ni nj nk nl nm nn nf ng paragraph-image"><div role="button" tabindex="0" class="no np ed nq bh nr"><div class="nf ng nh"><img src="../Images/34159eb96b878359e44851c2335541d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*icro6r2AYHUAvvln-gTTqg.png"/></div></div><figcaption class="nt nu nv nf ng nw nx bf b bg z dx">RAG system routing to different data sources based on the query intent</figcaption></figure><p id="c1fa" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">There could be different vector stores setup also for the same but of data, optimised for different query types. For example one vector store could be setup for answering summary type questions, and another for answering specific, directed type questions.</p><p id="ad2c" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">And we may want to route to <strong class="ml fr">different component types</strong> also, based on the question. For example we may want to pass the query to an Agent, VectorStore, or just directly to an LLM for processing, all based on the nature of the question</p><figure class="ni nj nk nl nm nn nf ng paragraph-image"><div role="button" tabindex="0" class="no np ed nq bh nr"><div class="nf ng ny"><img src="../Images/e171242fbcc3f09ba6c6fd62dd48e126.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JhCXEEmW_iA8hjelURITJA.png"/></div></div><figcaption class="nt nu nv nf ng nw nx bf b bg z dx">Routing to different component types based on the user’s query</figcaption></figure><p id="b7d8" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">We may even want to customise the prompt templates depending on the question being asked.</p><figure class="ni nj nk nl nm nn nf ng paragraph-image"><div role="button" tabindex="0" class="no np ed nq bh nr"><div class="nf ng nz"><img src="../Images/61f627b15df4c09e6ffcf469dcbd9b42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8_odawTgvYDNAZMLr6xhCg.png"/></div></div><figcaption class="nt nu nv nf ng nw nx bf b bg z dx">Routing via different prompt templates depending on the user query</figcaption></figure><p id="0783" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">All in all, there are numerous reasons we would want to change and direct the flow of the user’s query through the application. The more use cases our application is trying to fulfil, the more likely we are to have routing requirements throughout the application.</p><p id="1d2b" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Routers are essentially just If/Else statements we can use to direct the control flow of the query.</p><p id="9e9b" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">What is interesting about them though is it that they <strong class="ml fr">need to make their decisions based on natural language input</strong>. So we are looking for a discrete output based on a natural language description.</p><p id="86a7" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">And since a lot of the routing logic is based on using LLMs or machine learning algorithms, which are non-deterministic in nature, we cannot guarantee that a router will always 100% make the right choice. Add to that that we are unlikely to be able to predict all the different query variations that come into a router. However, using best practices and some testing we should be able to employ Routers to help create more powerful RAG applications.</p><h1 id="9370" class="oa ob fq bf oc od oe gq of og oh gt oi oj ok ol om on oo op oq or os ot ou ov bk">Natural Language Routers</h1><p id="b001" class="pw-post-body-paragraph mj mk fq ml b go ow mn mo gr ox mq mr ms oy mu mv mw oz my mz na pa nc nd ne fj bk">We will explore here a few of the natural language routers I have found that are implemented by some different RAG and LLM frameworks and libraries.</p><ul class=""><li id="8a96" class="mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne pb pc pd bk">LLM Completion Routers</li><li id="bc7c" class="mj mk fq ml b go pe mn mo gr pf mq mr ms pg mu mv mw ph my mz na pi nc nd ne pb pc pd bk">LLM Function Calling Routers</li><li id="1615" class="mj mk fq ml b go pe mn mo gr pf mq mr ms pg mu mv mw ph my mz na pi nc nd ne pb pc pd bk">Semantic Routers</li><li id="1d8f" class="mj mk fq ml b go pe mn mo gr pf mq mr ms pg mu mv mw ph my mz na pi nc nd ne pb pc pd bk">Zero Shot Classification Routers</li><li id="fbe6" class="mj mk fq ml b go pe mn mo gr pf mq mr ms pg mu mv mw ph my mz na pi nc nd ne pb pc pd bk">Language Classification Routers</li></ul><p id="bb7a" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">The diagram below gives a description of these routers, along with the frameworks/packages where they can be found.</p><p id="ed79" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">The diagram also includes Logical Routers, which I am defining as routers that work based on discrete logic such as conditions against string length, file names, integer values, e.t.c. In other words they are not based on having to understand the intent of a natural language query</p><figure class="ni nj nk nl nm nn nf ng paragraph-image"><div class="ab cn cb pj"><img src="../Images/78163855bb31bbb8345e6d141e77a57b.png" data-original-src="https://miro.medium.com/v2/format:webp/1*fJnUoOwsykBTU1MyLgHQFg.png"/></div><figcaption class="nt nu nv nf ng nw nx bf b bg z dx">The different kinds of natural language routers</figcaption></figure><p id="93e2" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Let’s explore each of these routers in a little more detail</p><h1 id="3559" class="oa ob fq bf oc od oe gq of og oh gt oi oj ok ol om on oo op oq or os ot ou ov bk">LLM Routers</h1><p id="3f99" class="pw-post-body-paragraph mj mk fq ml b go ow mn mo gr ox mq mr ms oy mu mv mw oz my mz na pa nc nd ne fj bk">These leverage the decision making abilities of LLMs to select a route based on the user’s query.</p><h2 id="f759" class="pk ob fq bf oc pl pm pn of po pp pq oi ms pr ps pt mw pu pv pw na px py pz qa bk">LLM Completion Router</h2><p id="7925" class="pw-post-body-paragraph mj mk fq ml b go ow mn mo gr ox mq mr ms oy mu mv mw oz my mz na pa nc nd ne fj bk">These use an LLM completion call, asking the LLM to return a single word that best describes the query, from a list of word options you pass in to its prompt. This word can then be used as part of an If/Else condition to control the application flow.</p><p id="a7c5" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">This is how the <a class="af qb" href="https://docs.llamaindex.ai/en/stable/module_guides/querying/router/" rel="noopener ugc nofollow" target="_blank">LLM Selector router</a> from LlamaIndex works. And is also the example given for a router inside the <a class="af qb" href="https://python.langchain.com/docs/expression_language/how_to/routing/" rel="noopener ugc nofollow" target="_blank">LangChain</a> docs.</p><p id="7ef9" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Let’s look at a code sample, based on the one provided in the LangChain docs, to make this a bit more clear. As you can see, coding up one of these on your own inside LangChain is pretty straight forward.</p><pre class="ni nj nk nl nm qc qd qe bp qf bb bk"><span id="73ee" class="qg ob fq qd b bg qh qi l qj qk">from langchain_anthropic import ChatAnthropic<br/>from langchain_core.output_parsers import StrOutputParser<br/>from langchain_core.prompts import PromptTemplate<br/><br/># Set up the LLM Chain to return a single word based on the query,<br/># and based on a list of words we provide to it in the prompt template<br/>llm_completion_select_route_chain = (<br/>        PromptTemplate.from_template("""<br/>Given the user question below, classify it as either<br/>being about `LangChain`, `Anthropic`, or `Other`.<br/><br/>Do not respond with more than one word.<br/><br/>&lt;question&gt;<br/>{question}<br/>&lt;/question&gt;<br/><br/>Classification:"""<br/>                                     )<br/>        | ChatAnthropic(model_name="claude-3-haiku")<br/>        | StrOutputParser()<br/>)<br/><br/><br/># We setup an IF/Else condition to route the query to the correct chain <br/># based on the LLM completion call above<br/>def route_to_chain(route_name):<br/>    if "anthropic" == route_name.lower():<br/>        return anthropic_chain<br/>    elif "langchain" == route_name.lower():<br/>        return langchain_chain<br/>    else:<br/>        return general_chain<br/><br/>...<br/><br/># Later on in the application, we can use the response from the LLM<br/># completion chain to control (i.e route) the flow of the application <br/># to the correct chain via the route_to_chain method we created<br/>route_name = llm_completion_select_route_chain.invoke(user_query)<br/>chain = route_to_chain(route_name)<br/>chain.invoke(user_query)</span></pre><h2 id="b010" class="pk ob fq bf oc pl pm pn of po pp pq oi ms pr ps pt mw pu pv pw na px py pz qa bk">LLM Function Calling Router</h2><p id="52cd" class="pw-post-body-paragraph mj mk fq ml b go ow mn mo gr ox mq mr ms oy mu mv mw oz my mz na pa nc nd ne fj bk">This leverages the function-calling ability of LLMs to pick a route to traverse. The different routes are set up as functions with appropriate descriptions in the LLM Function Call. Then, based on the query passed to the LLM, it is able to return the correct function (i.e route), for us to take.</p><p id="9689" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">This is how the <a class="af qb" href="https://docs.llamaindex.ai/en/stable/module_guides/querying/router/" rel="noopener ugc nofollow" target="_blank">Pydantic Router</a> works inside LlamaIndex. And this is the way most Agents work also to select the correct tool to be used. They leverage the Function Calling abilities of LLMs in order to select the correct tool for the job based on the user’s query.</p><h1 id="cf0e" class="oa ob fq bf oc od oe gq of og oh gt oi oj ok ol om on oo op oq or os ot ou ov bk">Semantic Router</h1><p id="ec10" class="pw-post-body-paragraph mj mk fq ml b go ow mn mo gr ox mq mr ms oy mu mv mw oz my mz na pa nc nd ne fj bk">This router type leverages embeddings and similarity searches to select the best route to traverse.</p><p id="d12e" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Each route has a set of example queries associated with it, that become embedded and stored as vectors. The incoming query gets embedded also, and a similarity search is done against the other sample queries from the router. The route which belongs to the query with the closest match gets selected.</p><p id="9c91" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">There is in fact a python package called <a class="af qb" href="https://github.com/aurelio-labs/semantic-router" rel="noopener ugc nofollow" target="_blank">semantic-router</a> that does just this. Let’s look at some implementation details to get a better idea of how the whole thing works. These examples come straight out of that libraries GitHub page.</p><p id="bc12" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Let’s set up two routes, one for questions about politics, and another for general chitchat type questions. To each route, we assign a list of questions that might typically be asked in order to trigger that route. These example queries are referred to as <em class="ql">utterances</em>. These utterances will be embedded, so that we can use them for similarity searches against the user’s query.</p><pre class="ni nj nk nl nm qc qd qe bp qf bb bk"><span id="78f1" class="qg ob fq qd b bg qh qi l qj qk">from semantic_router import Route<br/><br/># we could use this as a guide for our chatbot to avoid political<br/># conversations<br/>politics = Route(<br/>    name="politics",<br/>    utterances=[<br/>        "isn't politics the best thing ever",<br/>        "why don't you tell me about your political opinions",<br/>        "don't you just love the president",<br/>        "they're going to destroy this country!",<br/>        "they will save the country!",<br/>    ],<br/>)<br/><br/># this could be used as an indicator to our chatbot to switch to a more<br/># conversational prompt<br/>chitchat = Route(<br/>    name="chitchat",<br/>    utterances=[<br/>        "how's the weather today?",<br/>        "how are things going?",<br/>        "lovely weather today",<br/>        "the weather is horrendous",<br/>        "let's go to the chippy",<br/>    ],<br/>)<br/><br/># we place both of our decisions together into single list<br/>routes = [politics, chitchat]</span></pre><p id="f145" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">We assign OpenAI as the encoder, though any embedding library will work. And next we create our route layer using the routers and encoder.</p><pre class="ni nj nk nl nm qc qd qe bp qf bb bk"><span id="7585" class="qg ob fq qd b bg qh qi l qj qk">encoder = OpenAIEncoder()<br/><br/>from semantic_router.layer import RouteLayer<br/><br/>route_layer = RouteLayer(encoder=encoder, routes=routes)</span></pre><p id="8b33" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Then, when apply our query against the router layer, it returns the route that should be used for query</p><pre class="ni nj nk nl nm qc qd qe bp qf bb bk"><span id="2405" class="qg ob fq qd b bg qh qi l qj qk">route_layer("don't you love politics?").name<br/># -&gt; 'politics'</span></pre><p id="5bc7" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">So, just to summarise again, this semantic router leverages embeddings and similarity searches using the user’s query to select the optimal route to traverse. This router type should be faster than the other LLM based routers also, since it requires just a single Index query to be processed, as oppose to the other types which require calls to an LLM.</p><h1 id="a9b7" class="oa ob fq bf oc od oe gq of og oh gt oi oj ok ol om on oo op oq or os ot ou ov bk">Zero Shot Classification Router</h1><p id="b50a" class="pw-post-body-paragraph mj mk fq ml b go ow mn mo gr ox mq mr ms oy mu mv mw oz my mz na pa nc nd ne fj bk"><a class="af qb" href="https://huggingface.co/tasks/zero-shot-classification" rel="noopener ugc nofollow" target="_blank">“Zero-shot text classification</a> is a task in natural language processing where a model is trained on a set of labeled examples but is then able to classify new examples from previously unseen classes”. These routers leverage a Zero-Shot Classification model to assign a label to a piece of text, from a predefined set of labels you pass in to the router.</p><p id="e79d" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk"><strong class="ml fr">Example:</strong> The <a class="af qb" href="https://docs.haystack.deepset.ai/reference/routers-api#module-zero_shot_text_router" rel="noopener ugc nofollow" target="_blank">ZeroShotTextRouter</a> in Haystack, which leverages a Zero Shot Classification model from Hugging Face. Check out the <a class="af qb" href="https://github.com/deepset-ai/haystack/blob/main/haystack/components/routers/zero_shot_text_router.py#L130" rel="noopener ugc nofollow" target="_blank">source code here</a> to see where the magic happens.</p><h1 id="7b14" class="oa ob fq bf oc od oe gq of og oh gt oi oj ok ol om on oo op oq or os ot ou ov bk">Language Classification Router</h1><p id="2120" class="pw-post-body-paragraph mj mk fq ml b go ow mn mo gr ox mq mr ms oy mu mv mw oz my mz na pa nc nd ne fj bk">This type of router is able to identify the language that the query is in, and routes the query based on that. Useful if you require some sort of multilingual parsing abilities in your application.</p><p id="68ef" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk"><strong class="ml fr">Example:</strong> The <a class="af qb" href="https://docs.haystack.deepset.ai/reference/routers-api#module-text_language_router" rel="noopener ugc nofollow" target="_blank">TextClassificationRouter</a> from Haystack. <a class="af qb" href="https://github.com/deepset-ai/haystack/blob/main/haystack/components/routers/text_language_router.py#L90" rel="noopener ugc nofollow" target="_blank">It leverages the langdetect python library</a> to detect the language of of the text, which itself uses a <a class="af qb" href="https://www.slideshare.net/shuyo/language-detection-library-for-java" rel="noopener ugc nofollow" target="_blank">Naive Bayes</a> algorithm to detect the language.</p><h1 id="ab0b" class="oa ob fq bf oc od oe gq of og oh gt oi oj ok ol om on oo op oq or os ot ou ov bk">Keyword Router</h1><p id="b41c" class="pw-post-body-paragraph mj mk fq ml b go ow mn mo gr ox mq mr ms oy mu mv mw oz my mz na pa nc nd ne fj bk">This <a class="af qb" href="https://betterprogramming.pub/unifying-llm-powered-qa-techniques-with-routing-abstractions-438e2499a0d0" rel="noopener ugc nofollow" target="_blank">article</a> from Jerry Liu, the Co-Founder of LlamaIndex, on routing inside RAG applications, suggests, among other options, a keyword router that would try to select a route by matching keywords between the query and routes list.</p><p id="65c5" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">This Keyword router could be powered by an LLM also to identify keywords, or by some other keyword matching library. I have not been able to find any packages that implement this router type</p><h1 id="902c" class="oa ob fq bf oc od oe gq of og oh gt oi oj ok ol om on oo op oq or os ot ou ov bk">Logical Routers</h1><p id="4951" class="pw-post-body-paragraph mj mk fq ml b go ow mn mo gr ox mq mr ms oy mu mv mw oz my mz na pa nc nd ne fj bk">These use logic checks against variables, such as string lengths, file names, and value comparisons to handle how to route a query. They are very similar to typical If/Else conditions used in programming.</p><p id="0107" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">In other words, they are not based on having to understand the intent of a natural language query but can make their choice based on existing and discrete variables.</p><p id="41fe" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk"><strong class="ml fr">Example:</strong> The <a class="af qb" href="https://docs.haystack.deepset.ai/docs/conditionalrouter" rel="noopener ugc nofollow" target="_blank">ConditionalRouter</a> and <a class="af qb" href="https://docs.haystack.deepset.ai/docs/filetyperouter" rel="noopener ugc nofollow" target="_blank">FileTypeRouter</a> from HayStack.</p><h1 id="697e" class="oa ob fq bf oc od oe gq of og oh gt oi oj ok ol om on oo op oq or os ot ou ov bk">Agents v.s Routers</h1><p id="a999" class="pw-post-body-paragraph mj mk fq ml b go ow mn mo gr ox mq mr ms oy mu mv mw oz my mz na pa nc nd ne fj bk">At first sight, there is indeed a lot of similarities between routers and agents, and it might be difficult to distinguish how they are different.</p><p id="70d2" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">The similarities exist because Agents do in fact perform routing as part of their flow. They use a routing mechanism in order to select the correct tool to use for the job. They often leverage function calling in order to select the correct tool, just like the <strong class="ml fr">LLM Function Calling Routers</strong> described above.</p><p id="9039" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Routers are much more simple components than Agents though, often with the “simple” job of just routing a task to the correct place, as oppose to carrying out any of the logic or processing related to that task.</p><p id="9b12" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Agents on the other hand are often responsible for processing logic, including managing work done by the tools they have access to.</p><h1 id="3629" class="oa ob fq bf oc od oe gq of og oh gt oi oj ok ol om on oo op oq or os ot ou ov bk">Conclusion</h1><p id="64bb" class="pw-post-body-paragraph mj mk fq ml b go ow mn mo gr ox mq mr ms oy mu mv mw oz my mz na pa nc nd ne fj bk">We covered here a few of the different natural language routers currently found inside different RAG and LLM frameworks and packages.</p><p id="bd23" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">The concepts and packages and libraries around routing are sure to increase as time goes on. When building a RAG application, you will find that at some point, not too far in, routing capabilities do become necessary in order to build an application that is useful for the user.</p><p id="399e" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk">Routers are these basic building blocks that allow you to route the natural language requests to your application to the right place, so that the user’s queries can be fulfilled as best as possible.</p></div></div></div><div class="ab cb qm qn qo qp" role="separator"><span class="qq by bm qr qs qt"/><span class="qq by bm qr qs qt"/><span class="qq by bm qr qs"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="24bf" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk"><em class="ql">Hope that was useful! Do </em><a class="af qb" href="https://medium.com/@ssmaameri/subscribe" rel="noopener"><em class="ql">subscribe</em></a><em class="ql"> to get a notification whenever a new article of mine comes out</em></p></div></div></div><div class="ab cb qm qn qo qp" role="separator"><span class="qq by bm qr qs qt"/><span class="qq by bm qr qs qt"/><span class="qq by bm qr qs"/></div><div class="fj fk fl fm fn"><div class="ab cb"><div class="ci bh ev ew ex ey"><p id="5bd4" class="pw-post-body-paragraph mj mk fq ml b go mm mn mo gr mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne fj bk"><em class="ql">Unless otherwise noted, all images are by the author. Icons used in the first image by </em><a class="af qb" href="https://www.flaticon.com/free-icons/open-book" rel="noopener ugc nofollow" target="_blank"><em class="ql">SyafriStudi</em></a><em class="ql">o, </em><a class="af qb" href="https://www.flaticon.com/free-icons/png" rel="noopener ugc nofollow" target="_blank"><em class="ql">Dimitry Miroliubovand</em></a><em class="ql">, and </em><a class="af qb" href="https://www.freeiconspng.com/img/13315" rel="noopener ugc nofollow" target="_blank"><em class="ql">Free Icons PNG</em></a></p></div></div></div></div>    
</body>
</html>