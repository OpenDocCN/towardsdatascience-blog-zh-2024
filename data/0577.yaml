- en: How to Read OSM Data with DuckDB
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: å¦‚ä½•ä½¿ç”¨ DuckDB è¯»å– OSM æ•°æ®
- en: åŸæ–‡ï¼š[https://towardsdatascience.com/how-to-read-osm-data-with-duckdb-ffeb15197390?source=collection_archive---------0-----------------------#2024-03-02](https://towardsdatascience.com/how-to-read-osm-data-with-duckdb-ffeb15197390?source=collection_archive---------0-----------------------#2024-03-02)
  id: totrans-1
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: åŸæ–‡ï¼š[https://towardsdatascience.com/how-to-read-osm-data-with-duckdb-ffeb15197390?source=collection_archive---------0-----------------------#2024-03-02](https://towardsdatascience.com/how-to-read-osm-data-with-duckdb-ffeb15197390?source=collection_archive---------0-----------------------#2024-03-02)
- en: A deep dive into OpenStreetMap data structure and how to utilize it in a scalable
    way
  id: totrans-2
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: æ·±å…¥æ¢ç´¢ OpenStreetMap æ•°æ®ç»“æ„åŠå…¶å¦‚ä½•ä»¥å¯æ‰©å±•çš„æ–¹å¼ä½¿ç”¨
- en: '[](https://raczeq.medium.com/?source=post_page---byline--ffeb15197390--------------------------------)[![Kamil
    Raczycki](../Images/2c45075e217e60660ad3b4475530333d.png)](https://raczeq.medium.com/?source=post_page---byline--ffeb15197390--------------------------------)[](https://towardsdatascience.com/?source=post_page---byline--ffeb15197390--------------------------------)[![Towards
    Data Science](../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png)](https://towardsdatascience.com/?source=post_page---byline--ffeb15197390--------------------------------)
    [Kamil Raczycki](https://raczeq.medium.com/?source=post_page---byline--ffeb15197390--------------------------------)'
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: '[](https://raczeq.medium.com/?source=post_page---byline--ffeb15197390--------------------------------)[![Kamil
    Raczycki](../Images/2c45075e217e60660ad3b4475530333d.png)](https://raczeq.medium.com/?source=post_page---byline--ffeb15197390--------------------------------)[](https://towardsdatascience.com/?source=post_page---byline--ffeb15197390--------------------------------)[![Towards
    Data Science](../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png)](https://towardsdatascience.com/?source=post_page---byline--ffeb15197390--------------------------------)
    [Kamil Raczycki](https://raczeq.medium.com/?source=post_page---byline--ffeb15197390--------------------------------)'
- en: Â·Published in [Towards Data Science](https://towardsdatascience.com/?source=post_page---byline--ffeb15197390--------------------------------)
    Â·29 min readÂ·Mar 2, 2024
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: Â·å‘è¡¨äº [Towards Data Science](https://towardsdatascience.com/?source=post_page---byline--ffeb15197390--------------------------------)
    Â·29 åˆ†é’Ÿé˜…è¯»Â·2024å¹´3æœˆ2æ—¥
- en: --
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: --
- en: '![](../Images/1b9c4439391aa4851cbe3131de09a318.png)'
  id: totrans-6
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/1b9c4439391aa4851cbe3131de09a318.png)'
- en: 'Dall-E 3 image: Adorable and cute 3D render duck studying a paper map, bright
    sky, with blur background, high quality, 8k'
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: Dall-E 3 å›¾åƒï¼šä¸€åªå¯çˆ±ä¸”è¿·äººçš„ 3D æ¸²æŸ“é¸­å­æ­£åœ¨ç ”ç©¶çº¸è´¨åœ°å›¾ï¼Œæ˜äº®çš„å¤©ç©ºï¼Œæ¨¡ç³Šçš„èƒŒæ™¯ï¼Œé«˜è´¨é‡ï¼Œ8k
- en: This article will provide an in-depth look at how to read OpenStreetMap data
    using the DuckDB database.
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: æœ¬æ–‡å°†æ·±å…¥æ¢è®¨å¦‚ä½•ä½¿ç”¨ DuckDB æ•°æ®åº“è¯»å– OpenStreetMap æ•°æ®ã€‚
- en: The steps described in this guide will allow the reader to load the OSM data
    using the Monaco example divided into nodes, ways, and relations.
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: æœ¬æŒ‡å—ä¸­æè¿°çš„æ­¥éª¤å°†å…è®¸è¯»è€…ä½¿ç”¨ Monaco ç¤ºä¾‹åŠ è½½ OSM æ•°æ®ï¼Œå¹¶å°†æ•°æ®åˆ†ä¸ºèŠ‚ç‚¹ã€è·¯å¾„å’Œå…³ç³»ã€‚
- en: '![](../Images/d0ebfd971420ab909f885f939cc1ca64.png)![](../Images/0ff4cf3693bfcbf785e16967120a527e.png)![](../Images/05b73197def9157df492056b089d8d72.png)'
  id: totrans-10
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/d0ebfd971420ab909f885f939cc1ca64.png)![](../Images/0ff4cf3693bfcbf785e16967120a527e.png)![](../Images/05b73197def9157df492056b089d8d72.png)'
- en: 'The final result of OSM elements read using the DuckDB engine. From the left:
    nodes, ways and relations. Generated by the author using GeoPandas library.'
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: ä½¿ç”¨ DuckDB å¼•æ“è¯»å– OSM å…ƒç´ çš„æœ€ç»ˆç»“æœã€‚ä»å·¦è‡³å³ï¼šèŠ‚ç‚¹ã€è·¯å¾„å’Œå…³ç³»ã€‚ç”±ä½œè€…ä½¿ç”¨ GeoPandas åº“ç”Ÿæˆã€‚
- en: A basic knowledge of the SQL language is expected to fully understand the steps
    described in this tutorial. Most of the GIS-related operations and special joins
    are described further in the article.
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: ä¸ºäº†å®Œå…¨ç†è§£æœ¬æ•™ç¨‹ä¸­æè¿°çš„æ­¥éª¤ï¼Œé¢„æœŸå…·å¤‡ SQL è¯­è¨€çš„åŸºæœ¬çŸ¥è¯†ã€‚å¤§å¤šæ•°ä¸ GIS ç›¸å…³çš„æ“ä½œå’Œç‰¹æ®Šè¿æ¥å°†åœ¨æ–‡ç« ä¸­è¿›ä¸€æ­¥æè¿°ã€‚
- en: Outline of the article
  id: totrans-13
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: æ–‡ç« å¤§çº²
- en: What is OSM? â€” introduction to the OSM service.
  id: totrans-14
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: ä»€ä¹ˆæ˜¯ OSMï¼Ÿâ€”â€”OpenStreetMap æœåŠ¡ç®€ä»‹ã€‚
- en: OpenStreetMap data model â€” definition of objects used in the OSM.
  id: totrans-15
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: OpenStreetMap æ•°æ®æ¨¡å‹â€”â€”å®šä¹‰äº†åœ¨ OSM ä¸­ä½¿ç”¨çš„å¯¹è±¡ã€‚
- en: Reading OSM data â€” basic operations on the data using DuckDB.
  id: totrans-16
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: è¯»å– OSM æ•°æ®â€”â€”ä½¿ç”¨ DuckDB å¯¹æ•°æ®è¿›è¡ŒåŸºæœ¬æ“ä½œã€‚
- en: Constructing point geometries from the **nodes**
  id: totrans-17
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: ä»**èŠ‚ç‚¹**ä¸­æ„å»ºç‚¹å‡ ä½•ä½“
- en: Constructing linestring and polygon geometries from the **ways**
  id: totrans-18
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: ä»**è·¯å¾„**ä¸­æ„å»ºçº¿æ®µå’Œå¤šè¾¹å½¢å‡ ä½•ä½“
- en: Constructing polygon and multi-polygon geometries from the **relations**
  id: totrans-19
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: ä»**å…³ç³»**ä¸­æ„å»ºå¤šè¾¹å½¢å’Œå¤šé‡å¤šè¾¹å½¢å‡ ä½•ä½“
- en: Examples of badly defined relation objects
  id: totrans-20
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: å®šä¹‰ä¸è§„èŒƒçš„å…³ç³»å¯¹è±¡ç¤ºä¾‹
- en: QuackOSM â€” a hassle-free tool for reading OSM data
  id: totrans-21
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: QuackOSM â€”â€” ä¸€æ¬¾è½»æ¾è¯»å– OSM æ•°æ®çš„å·¥å…·
- en: What is OSM?
  id: totrans-22
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: ä»€ä¹ˆæ˜¯ OSMï¼Ÿ
- en: OpenStreetMap ([OSM](https://openstreetmap.org/)) is the most popular free map
    of the world and it's kept alive by a growing base of volunteers and contributors.
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: OpenStreetMapï¼ˆ[OSM](https://openstreetmap.org/)ï¼‰æ˜¯å…¨çƒæœ€å—æ¬¢è¿çš„å…è´¹åœ°å›¾ï¼Œå¹¶ç”±æ—¥ç›Šå¢é•¿çš„å¿—æ„¿è€…å’Œè´¡çŒ®è€…ç¾¤ä½“æŒç»­ç»´æŠ¤ã€‚
- en: The data collected and built by the community is available publicly for free
    and commercial purposes, so many companies, academic researchers and individual
    developers use this resource in their projects. All data is provided under the
    [Open Data Commons Open Database License](https://opendatacommons.org/licenses/odbl/1.0/)
    (ODbL).
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: ç¤¾åŒºæ”¶é›†å¹¶æ„å»ºçš„æ•°æ®å¯ä»¥å…¬å¼€å…è´¹ç”¨äºå•†ä¸šç›®çš„ï¼Œå› æ­¤è®¸å¤šå…¬å¸ã€å­¦æœ¯ç ”ç©¶äººå‘˜å’Œä¸ªäººå¼€å‘è€…éƒ½åœ¨ä»–ä»¬çš„é¡¹ç›®ä¸­ä½¿ç”¨è¿™äº›èµ„æºã€‚æ‰€æœ‰æ•°æ®éƒ½éµå¾ª[å¼€æ”¾æ•°æ®å…¬å…±å¼€æºæ•°æ®åº“è®¸å¯è¯](https://opendatacommons.org/licenses/odbl/1.0/)ï¼ˆODbLï¼‰ã€‚
- en: 'The data can be accessed in multiple ways:'
  id: totrans-25
  prefs: []
  type: TYPE_NORMAL
  zh: æ•°æ®å¯ä»¥é€šè¿‡å¤šç§æ–¹å¼è®¿é—®ï¼š
- en: Using Overpass API (with Web GUI at [Overpass Turbo](https://overpass-turbo.eu/))
  id: totrans-26
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: ä½¿ç”¨Overpass APIï¼ˆé€šè¿‡[Overpass Turbo](https://overpass-turbo.eu/)çš„Web GUIï¼‰
- en: Downloading full data as [Planet OSM](https://planet.openstreetmap.org/) (currently
    over 70 GB in 2024)
  id: totrans-27
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: ä¸‹è½½å®Œæ•´æ•°æ®ä½œä¸º[Planet OSM](https://planet.openstreetmap.org/)ï¼ˆ2024å¹´å½“å‰è¶…è¿‡70GBï¼‰
- en: 'Smaller extract downloads: [Geofabrik](https://download.geofabrik.de/), [BBBike](https://extract.bbbike.org/),
    [OpenStreetMap.fr](https://download.openstreetmap.fr/), [Protomaps](https://app.protomaps.com/)'
  id: totrans-28
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: è¾ƒå°çš„ä¸‹è½½æå–ï¼š [Geofabrik](https://download.geofabrik.de/), [BBBike](https://extract.bbbike.org/),
    [OpenStreetMap.fr](https://download.openstreetmap.fr/), [Protomaps](https://app.protomaps.com/)
- en: The most space-efficient file type in which the data is stored is Protocolbuffer
    Binary Format with an extension `*.osm.pbf` . You can read more about it [here](https://wiki.openstreetmap.org/wiki/PBF_Format).
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: æ•°æ®å­˜å‚¨çš„æœ€èŠ‚çœç©ºé—´çš„æ–‡ä»¶ç±»å‹æ˜¯ProtocolbufferäºŒè¿›åˆ¶æ ¼å¼ï¼Œæ‰©å±•åä¸º`*.osm.pbf`ã€‚ä½ å¯ä»¥[åœ¨è¿™é‡Œ](https://wiki.openstreetmap.org/wiki/PBF_Format)äº†è§£æ›´å¤šä¿¡æ¯ã€‚
- en: 'You can also read this short article about OpenStreetMap from [Eugenia Anello](https://medium.com/u/86fdc517c278?source=post_page---user_mention--ffeb15197390--------------------------------):'
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: ä½ è¿˜å¯ä»¥é˜…è¯»[Eugenia Anello](https://medium.com/u/86fdc517c278?source=post_page---user_mention--ffeb15197390--------------------------------)å…³äºOpenStreetMapçš„ç®€çŸ­æ–‡ç« ï¼š
- en: '[](/a-comprehensive-guide-for-getting-started-with-openstreetmap-e92dff95fc80?source=post_page-----ffeb15197390--------------------------------)
    [## A comprehensive guide for getting started with OpenStreetMap'
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: '[](/a-comprehensive-guide-for-getting-started-with-openstreetmap-e92dff95fc80?source=post_page-----ffeb15197390--------------------------------)
    [## OpenStreetMapå…¥é—¨æŒ‡å—'
- en: Learn the basics concepts of OpenStreetMap while practising using the website
  id: totrans-32
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: åœ¨ä½¿ç”¨ç½‘ç«™æ—¶å­¦ä¹ OpenStreetMapçš„åŸºæœ¬æ¦‚å¿µ
- en: towardsdatascience.com](/a-comprehensive-guide-for-getting-started-with-openstreetmap-e92dff95fc80?source=post_page-----ffeb15197390--------------------------------)
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: towardsdatascience.com](/a-comprehensive-guide-for-getting-started-with-openstreetmap-e92dff95fc80?source=post_page-----ffeb15197390--------------------------------)
- en: OpenStreetMap data model
  id: totrans-34
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: OpenStreetMapæ•°æ®æ¨¡å‹
- en: This section is based on [OSM Wiki page](https://wiki.openstreetmap.org/wiki/Elements)
    about Elements
  id: totrans-35
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: æœ¬èŠ‚å†…å®¹åŸºäºå…³äºå…ƒç´ çš„[OSM Wikié¡µé¢](https://wiki.openstreetmap.org/wiki/Elements)
- en: 'Conceptually the data in OpenStreetMap is split into 3 components:'
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: ä»æ¦‚å¿µä¸Šè®²ï¼ŒOpenStreetMapä¸­çš„æ•°æ®åˆ†ä¸º3ä¸ªç»„ä»¶ï¼š
- en: Nodes represent points in space. They are represented by a pair of coordinates
    in a WGS84 Coordinate Reference System â€” longitude and latitude. Nodes can be
    used to define a single feature on a map (eg. bench, lamp post, tree) or be used
    with other nodes to represent a shape of a way.
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: èŠ‚ç‚¹è¡¨ç¤ºç©ºé—´ä¸­çš„ç‚¹ã€‚å®ƒä»¬é€šè¿‡WGS84åæ ‡å‚è€ƒç³»ç»Ÿä¸­çš„ä¸€å¯¹åæ ‡è¡¨ç¤ºâ€”â€”ç»åº¦å’Œçº¬åº¦ã€‚èŠ‚ç‚¹å¯ä»¥ç”¨æ¥å®šä¹‰åœ°å›¾ä¸Šçš„å•ä¸€ç‰¹å¾ï¼ˆä¾‹å¦‚ï¼šé•¿æ¤…ã€è·¯ç¯ã€æ ‘æœ¨ï¼‰ï¼Œæˆ–è€…ä¸å…¶ä»–èŠ‚ç‚¹ä¸€èµ·ç”¨æ¥è¡¨ç¤ºè·¯å¾„çš„å½¢çŠ¶ã€‚
- en: '![](../Images/d1b8a31585dcda83fce64f09a495b165.png)'
  id: totrans-38
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/d1b8a31585dcda83fce64f09a495b165.png)'
- en: Example of a node â€” a tree in the park. Screenshot from the OpenStreetMap by
    the author.
  id: totrans-39
  prefs: []
  type: TYPE_NORMAL
  zh: ä¸€ä¸ªèŠ‚ç‚¹çš„ç¤ºä¾‹â€”â€”å…¬å›­é‡Œçš„æ ‘ã€‚æ¥è‡ªOpenStreetMapçš„æˆªå›¾ï¼Œä½œè€…æä¾›ã€‚
- en: Ways are shapes representing a polyline by using an **ordered** list of nodes.
    Those polylines can be open and represent roads, canals, and walls, or they can
    be closed to form a polygon and represent buildings, forests, lakes or other simple
    shapes.
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: è·¯å¾„æ˜¯é€šè¿‡ä½¿ç”¨**æœ‰åº**èŠ‚ç‚¹åˆ—è¡¨è¡¨ç¤ºçš„æŠ˜çº¿å½¢çŠ¶ã€‚è¿™äº›æŠ˜çº¿å¯ä»¥æ˜¯å¼€æ”¾çš„ï¼Œè¡¨ç¤ºé“è·¯ã€è¿æ²³å’Œå¢™å£ï¼Œæˆ–è€…å®ƒä»¬å¯ä»¥é—­åˆå½¢æˆå¤šè¾¹å½¢ï¼Œè¡¨ç¤ºå»ºç­‘ç‰©ã€æ£®æ—ã€æ¹–æ³Šæˆ–å…¶ä»–ç®€å•å½¢çŠ¶ã€‚
- en: '![](../Images/66e199dab95b9bcb14552b0375443a37.png)'
  id: totrans-41
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/66e199dab95b9bcb14552b0375443a37.png)'
- en: Example of a way â€” a part of a highway road. Screenshot from the OpenStreetMap
    by the author.
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: ä¸€ä¸ªè·¯å¾„çš„ç¤ºä¾‹â€”â€”ä¸€éƒ¨åˆ†é«˜é€Ÿå…¬è·¯ã€‚æ¥è‡ªOpenStreetMapçš„æˆªå›¾ï¼Œä½œè€…æä¾›ã€‚
- en: 'Relations represent relationships between multiple objects and data elements
    defined in the OSM. This could be for example a bus route with ways showing roads
    on which the bus travels and nodes showing stops of a route, or a multi polygon
    with holes represented by at least 2 ways: these can be an *outer* polygon and
    an *inner* polygon.'
  id: totrans-43
  prefs: []
  type: TYPE_NORMAL
  zh: å…³ç³»è¡¨ç¤ºOSMä¸­å¤šä¸ªå¯¹è±¡å’Œæ•°æ®å…ƒç´ ä¹‹é—´çš„å…³ç³»ã€‚ä¾‹å¦‚ï¼Œè¿™å¯ä»¥æ˜¯ä¸€ä¸ªå…¬äº¤è·¯çº¿ï¼Œå…¶ä¸­è·¯çº¿è¡¨ç¤ºå…¬äº¤è¡Œé©¶çš„é“è·¯ï¼ŒèŠ‚ç‚¹è¡¨ç¤ºè·¯çº¿çš„ç«™ç‚¹ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªç”±è‡³å°‘2ä¸ªè·¯å¾„è¡¨ç¤ºçš„å¸¦å­”çš„å¤šè¾¹å½¢ï¼šè¿™äº›å¯ä»¥æ˜¯*å¤–éƒ¨*å¤šè¾¹å½¢å’Œ*å†…éƒ¨*å¤šè¾¹å½¢ã€‚
- en: '![](../Images/638f80e316ca63427f0d70bd3f89cf98.png)'
  id: totrans-44
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/638f80e316ca63427f0d70bd3f89cf98.png)'
- en: An example of a relationâ€” a hotel building outline with holes. Screenshot from
    the OpenStreetMap by the author.
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: ä¸€ä¸ªå…³ç³»çš„ç¤ºä¾‹â€”â€”ä¸€ä¸ªå¸¦æœ‰å­”æ´çš„é…’åº—å»ºç­‘è½®å»“ã€‚æˆªå›¾æ¥è‡ªä½œè€…çš„OpenStreetMapã€‚
- en: Each element can, but doesnâ€™t have to, have **tags** attached. Tags describe
    the meaning of the element. They are composed of a key and a value. There is no
    fixed dictionary of those values, but users should stay within conventions documented
    in the OSM Wiki.
  id: totrans-46
  prefs: []
  type: TYPE_NORMAL
  zh: æ¯ä¸ªå…ƒç´ å¯ä»¥ï¼Œä¹Ÿä¸ä¸€å®šï¼Œé™„å¸¦**æ ‡ç­¾**ã€‚æ ‡ç­¾æè¿°å…ƒç´ çš„å«ä¹‰ã€‚æ ‡ç­¾ç”±é”®å’Œå€¼ç»„æˆã€‚æ²¡æœ‰å›ºå®šçš„å€¼å­—å…¸ï¼Œä½†ç”¨æˆ·åº”éµå¾ªOSM Wikiä¸­è®°å½•çš„çº¦å®šã€‚
- en: Additionally, each element has an ID that is unique in a given element type
    space (so there can be a node with ID = 100, a way with ID = 100 and a relation
    with ID = 100).
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: æ­¤å¤–ï¼Œæ¯ä¸ªå…ƒç´ éƒ½æœ‰ä¸€ä¸ªåœ¨ç‰¹å®šå…ƒç´ ç±»å‹ç©ºé—´ä¸­å”¯ä¸€çš„IDï¼ˆå› æ­¤å¯èƒ½å­˜åœ¨ä¸€ä¸ªIDä¸º100çš„èŠ‚ç‚¹ã€IDä¸º100çš„è·¯å¾„å’ŒIDä¸º100çš„å…³ç³»ï¼‰ã€‚
- en: Reading OSM data
  id: totrans-48
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: è¯»å–OSMæ•°æ®
- en: Many tools allow users to transform the OSM data model to file formats commonly
    used in the GIS domain, such as [GDAL](https://gdal.org/drivers/vector/osm.html).
    These tools are automatically reconstructing geometries from the raw data. We
    will try to read it and reconstruct geometries manually.
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: è®¸å¤šå·¥å…·å…è®¸ç”¨æˆ·å°†OSMæ•°æ®æ¨¡å‹è½¬æ¢ä¸ºåœ¨GISé¢†åŸŸå¸¸ç”¨çš„æ–‡ä»¶æ ¼å¼ï¼Œä¾‹å¦‚[GDAL](https://gdal.org/drivers/vector/osm.html)ã€‚è¿™äº›å·¥å…·ä¼šè‡ªåŠ¨ä»åŸå§‹æ•°æ®ä¸­é‡å»ºå‡ ä½•å½¢çŠ¶ã€‚æˆ‘ä»¬å°†å°è¯•æ‰‹åŠ¨è¯»å–å¹¶é‡å»ºå‡ ä½•å½¢çŠ¶ã€‚
- en: Examples below show how to access raw data and are written in SQL using [DuckDB](https://duckdb.org/)
    engine with [Spatial](https://duckdb.org/docs/extensions/spatial.html) extension.
    All queries with a full Jupyer notebook can be accessed in the GitHub repository.
  id: totrans-50
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: ä»¥ä¸‹ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•è®¿é—®åŸå§‹æ•°æ®ï¼Œå¹¶ä½¿ç”¨[DuckDB](https://duckdb.org/)å¼•æ“å’Œ[Spatial](https://duckdb.org/docs/extensions/spatial.html)æ‰©å±•ä»¥SQLç¼–å†™ã€‚å¸¦æœ‰å®Œæ•´Jupyterç¬”è®°æœ¬çš„æ‰€æœ‰æŸ¥è¯¢å¯ä»¥åœ¨GitHubä»£ç åº“ä¸­è®¿é—®ã€‚
- en: You can run the notebook in the parallel or you can [install the DuckDB engine](https://duckdb.org/#quickinstall)
    and open the CLI to execute the queries there.
  id: totrans-51
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: ä½ å¯ä»¥åœ¨å¹¶è¡Œç¯å¢ƒä¸­è¿è¡Œæ­¤ç¬”è®°æœ¬ï¼Œæˆ–è€…ä½ å¯ä»¥[å®‰è£…DuckDBå¼•æ“](https://duckdb.org/#quickinstall)ï¼Œå¹¶æ‰“å¼€CLIåœ¨å…¶ä¸­æ‰§è¡ŒæŸ¥è¯¢ã€‚
- en: '[](https://github.com/RaczeQ/medium-articles/blob/main/articles/osm-duckdb/code.ipynb?source=post_page-----ffeb15197390--------------------------------)
    [## medium-articles/articles/osm-duckdb/code.ipynb at main Â· RaczeQ/medium-articles'
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: '[](https://github.com/RaczeQ/medium-articles/blob/main/articles/osm-duckdb/code.ipynb?source=post_page-----ffeb15197390--------------------------------)
    [## medium-articles/articles/osm-duckdb/code.ipynb at main Â· RaczeQ/medium-articles'
- en: A repository for the code and data used in Medium articles - medium-articles/articles/osm-duckdb/code.ipynb
    at main Â·â€¦
  id: totrans-53
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: ç”¨äºMediumæ–‡ç« ä¸­ä»£ç å’Œæ•°æ®çš„ä»£ç åº“ - medium-articles/articles/osm-duckdb/code.ipynb at main
    Â·â€¦
- en: github.com](https://github.com/RaczeQ/medium-articles/blob/main/articles/osm-duckdb/code.ipynb?source=post_page-----ffeb15197390--------------------------------)
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: github.com](https://github.com/RaczeQ/medium-articles/blob/main/articles/osm-duckdb/code.ipynb?source=post_page-----ffeb15197390--------------------------------)
- en: Getting the data
  id: totrans-55
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: è·å–æ•°æ®
- en: 'For simplicity and easy access, examples are focused entirely on the Monaco
    region. You can download the current extract from the Geofabrik download server:
    [https://download.geofabrik.de/europe/monaco.html](https://download.geofabrik.de/europe/monaco.html)
    (and click `monaco-latest.osm.pbf` download link)'
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: ä¸ºäº†ç®€ä¾¿å¹¶ä¾¿äºè®¿é—®ï¼Œç¤ºä¾‹å®Œå…¨èšç„¦äºæ‘©çº³å“¥åœ°åŒºã€‚ä½ å¯ä»¥ä»Geofabrikä¸‹è½½æœåŠ¡å™¨ä¸‹è½½å½“å‰çš„æå–æ•°æ®ï¼š[https://download.geofabrik.de/europe/monaco.html](https://download.geofabrik.de/europe/monaco.html)ï¼ˆç‚¹å‡»`monaco-latest.osm.pbf`ä¸‹è½½é“¾æ¥ï¼‰
- en: Familiarisation with the data structure
  id: totrans-57
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: ç†Ÿæ‚‰æ•°æ®ç»“æ„
- en: 'To start, we will use the `DESCRIBE`function to get information about the columns:'
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: é¦–å…ˆï¼Œæˆ‘ä»¬å°†ä½¿ç”¨`DESCRIBE`å‡½æ•°è·å–æœ‰å…³åˆ—çš„ä¿¡æ¯ï¼š
- en: '[PRE0]'
  id: totrans-59
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'There are 8 columns returned by the `ST_READOSM`function:'
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: '`ST_READOSM`å‡½æ•°è¿”å›8ä¸ªåˆ—ï¼š'
- en: kind â€” this is the type of an element. It can also have a value of `changeset`representing
    the changes after editing the existing element in the OSM. Extracts from the Geofabrik
    download server donâ€™t contain changesets, so we donâ€™t have to think about them.
  id: totrans-61
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: kind â€”â€” è¿™æ˜¯å…ƒç´ çš„ç±»å‹ã€‚å®ƒä¹Ÿå¯ä»¥å…·æœ‰ `changeset` çš„å€¼ï¼Œè¡¨ç¤ºåœ¨ç¼–è¾‘ç°æœ‰å…ƒç´ åæ‰€åšçš„æ›´æ”¹ã€‚Geofabrikä¸‹è½½æœåŠ¡å™¨çš„æå–æ•°æ®ä¸åŒ…å«changesetï¼Œå› æ­¤æˆ‘ä»¬ä¸éœ€è¦è€ƒè™‘å®ƒä»¬ã€‚
- en: id â€” the element identifier.
  id: totrans-62
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: id â€”â€” å…ƒç´ çš„æ ‡è¯†ç¬¦ã€‚
- en: 'tags â€” map (or a dictionary) of two strings: a tag key and a tag value.'
  id: totrans-63
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: tags â€”â€” ä¸€ä¸ªç”±ä¸¤ä¸ªå­—ç¬¦ä¸²ç»„æˆçš„æ˜ å°„ï¼ˆæˆ–å­—å…¸ï¼‰ï¼šä¸€ä¸ªæ ‡ç­¾é”®å’Œä¸€ä¸ªæ ‡ç­¾å€¼ã€‚
- en: refs â€” list of member IDs related to the element. Nodes should have this list
    empty and ways and relations canâ€™t have it empty.
  id: totrans-64
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: refs â€”â€” ä¸å…ƒç´ ç›¸å…³çš„æˆå‘˜IDåˆ—è¡¨ã€‚èŠ‚ç‚¹åº”å°†æ­¤åˆ—è¡¨ç•™ç©ºï¼Œè·¯å¾„å’Œå…³ç³»ä¸èƒ½ä¸ºç©ºã€‚
- en: lat and lon â€” latitude and longitude of a node. Ways and relations should have
    these fields empty since only nodes can have coordinates in the OSM.
  id: totrans-65
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: lat å’Œ lon â€”â€” èŠ‚ç‚¹çš„çº¬åº¦å’Œç»åº¦ã€‚è·¯å¾„å’Œå…³ç³»åº”è¯¥å°†è¿™äº›å­—æ®µç•™ç©ºï¼Œå› ä¸ºåœ¨OSMä¸­åªæœ‰èŠ‚ç‚¹å¯ä»¥æ‹¥æœ‰åæ ‡ã€‚
- en: 'ref_roles and ref_types â€” a list of additional information about members: what
    role is assigned to the member and what type is it (node, way or relation).'
  id: totrans-66
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: ref_roles å’Œ ref_types â€” å…³äºæˆå‘˜çš„é™„åŠ ä¿¡æ¯åˆ—è¡¨ï¼šæˆå‘˜è¢«åˆ†é…çš„è§’è‰²æ˜¯ä»€ä¹ˆï¼Œå®ƒå±äºä»€ä¹ˆç±»å‹ï¼ˆèŠ‚ç‚¹ã€é“è·¯æˆ–å…³ç³»ï¼‰ã€‚
- en: Counting the elements
  id: totrans-67
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: è®¡æ•°å…ƒç´ æ•°é‡ã€‚
- en: Letâ€™s see how many elements there are in total and per element type.
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: è®©æˆ‘ä»¬æ¥çœ‹çœ‹æ€»å…±æœ‰å¤šå°‘å…ƒç´ ï¼Œä»¥åŠæ¯ç§å…ƒç´ ç±»å‹çš„æ•°é‡ã€‚
- en: '[PRE1]'
  id: totrans-69
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: Looking at the elements
  id: totrans-70
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: æŸ¥çœ‹å…ƒç´ ã€‚
- en: Letâ€™s check the examples of the data for each element type.
  id: totrans-71
  prefs: []
  type: TYPE_NORMAL
  zh: è®©æˆ‘ä»¬æ£€æŸ¥æ¯ç§å…ƒç´ ç±»å‹çš„æ•°æ®ç¤ºä¾‹ã€‚
- en: '[PRE2]'
  id: totrans-72
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: 'Now we can see how the elements are defined: nodes have coordinates, ways have
    *refs* lists filled with node IDs and relations have the most complicated structure
    with *refs* lists filled with IDs and *ref_types* lists showing which ID correspond
    to which element type. Additionally, *ref_roles* have information about the role
    of the member (admin_centre, label, inner, outer).'
  id: totrans-73
  prefs: []
  type: TYPE_NORMAL
  zh: ç°åœ¨æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å…ƒç´ çš„å®šä¹‰ï¼šèŠ‚ç‚¹æœ‰åæ ‡ï¼Œé“è·¯æœ‰å¡«å……äº†èŠ‚ç‚¹IDçš„*refs*åˆ—è¡¨ï¼Œå…³ç³»æœ‰æœ€å¤æ‚çš„ç»“æ„ï¼Œ*refs*åˆ—è¡¨å¡«å……äº†IDï¼Œ*ref_types*åˆ—è¡¨æ˜¾ç¤ºå“ªä¸ªIDå¯¹åº”å“ªä¸ªå…ƒç´ ç±»å‹ã€‚æ­¤å¤–ï¼Œ*ref_roles*åŒ…å«å…³äºæˆå‘˜è§’è‰²çš„ä¿¡æ¯ï¼ˆadmin_centreï¼Œlabelï¼Œinnerï¼Œouterï¼‰ã€‚
- en: Constructing point geometries from the nodes
  id: totrans-74
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: ä»èŠ‚ç‚¹ä¸­æ„å»ºç‚¹å‡ ä½•å½¢çŠ¶ã€‚
- en: Now that we know what the structure looks like, we can start building some geometries.
    Starting with nodes should be the easiest since itâ€™s just a pair of latitudes
    and longitudes in the WGS84 Coordinate Reference System.
  id: totrans-75
  prefs: []
  type: TYPE_NORMAL
  zh: ç°åœ¨æˆ‘ä»¬çŸ¥é“ç»“æ„æ˜¯ä»€ä¹ˆæ ·çš„ï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹æ„å»ºä¸€äº›å‡ ä½•å½¢çŠ¶äº†ã€‚ä»èŠ‚ç‚¹å¼€å§‹åº”è¯¥æ˜¯æœ€ç®€å•çš„ï¼Œå› ä¸ºå®ƒä»…ä»…æ˜¯WGS84åæ ‡å‚è€ƒç³»ç»Ÿä¸­çš„ä¸€å¯¹çº¬åº¦å’Œç»åº¦ã€‚
- en: We should only extract nodes with at least one tag attached since those have
    any semantical meaning for analytical purposes. Nodes without any tags could be
    used to construct ways in the later stages.
  id: totrans-76
  prefs: []
  type: TYPE_NORMAL
  zh: æˆ‘ä»¬åº”è¯¥åªæå–è‡³å°‘é™„å¸¦ä¸€ä¸ªæ ‡ç­¾çš„èŠ‚ç‚¹ï¼Œå› ä¸ºè¿™äº›èŠ‚ç‚¹åœ¨åˆ†æä¸­æœ‰è¯­ä¹‰æ„ä¹‰ã€‚æ²¡æœ‰ä»»ä½•æ ‡ç­¾çš„èŠ‚ç‚¹å¯èƒ½ä¼šåœ¨åç»­é˜¶æ®µç”¨äºæ„å»ºé“è·¯ã€‚
- en: '[PRE3]'
  id: totrans-77
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: '![](../Images/c940d87cb6db1a98fff59db98498049a.png)'
  id: totrans-78
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/c940d87cb6db1a98fff59db98498049a.png)'
- en: Nodes plotted on a map. Generated by the author using GeoPandas library.
  id: totrans-79
  prefs: []
  type: TYPE_NORMAL
  zh: èŠ‚ç‚¹åœ¨åœ°å›¾ä¸Šçš„åˆ†å¸ƒã€‚ç”±ä½œè€…ä½¿ç”¨GeoPandasåº“ç”Ÿæˆã€‚
- en: After filtering the nodes based on tags, we are left with 3167 points.
  id: totrans-80
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨æ ¹æ®æ ‡ç­¾è¿‡æ»¤èŠ‚ç‚¹åï¼Œæˆ‘ä»¬å‰©ä¸‹3167ä¸ªç‚¹ã€‚
- en: Itâ€™s around 10% of the total number of nodes in the source file.
  id: totrans-81
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™å¤§çº¦å æºæ–‡ä»¶ä¸­èŠ‚ç‚¹æ€»æ•°çš„10%ã€‚
- en: Constructing linestring and polygon geometries from the ways
  id: totrans-82
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: ä»é“è·¯ä¸­æ„å»ºçº¿å­—ç¬¦ä¸²å’Œå¤šè¾¹å½¢å‡ ä½•å½¢çŠ¶ã€‚
- en: With nodes out of the *way* ğŸ˜‰, letâ€™s focus now on ways. Ways can take the form
    of linestrings or polygons. Letâ€™s focus on linestrings first and then we will
    assign proper geometry types.
  id: totrans-83
  prefs: []
  type: TYPE_NORMAL
  zh: è®©èŠ‚ç‚¹â€œå‡ºå±€â€ ğŸ˜‰ï¼Œç°åœ¨æˆ‘ä»¬ä¸“æ³¨äºé“è·¯ã€‚é“è·¯å¯ä»¥æ˜¯çº¿å­—ç¬¦ä¸²æˆ–å¤šè¾¹å½¢ã€‚æˆ‘ä»¬é¦–å…ˆå…³æ³¨çº¿å­—ç¬¦ä¸²ï¼Œç„¶åå†åˆ†é…åˆé€‚çš„å‡ ä½•ç±»å‹ã€‚
- en: 'To construct the ways we have to do multiple operations:'
  id: totrans-84
  prefs: []
  type: TYPE_NORMAL
  zh: ä¸ºäº†æ„å»ºé“è·¯ï¼Œæˆ‘ä»¬éœ€è¦æ‰§è¡Œå¤šä¸ªæ“ä½œï¼š
- en: Select matching ways with tags.
  id: totrans-85
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: é€‰æ‹©å¸¦æœ‰æ ‡ç­¾çš„åŒ¹é…é“è·¯ã€‚
- en: Unnest all nodes refs for each way element and keep them in the proper order
    (remember - nodes refs order matter!).
  id: totrans-86
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: ä¸ºæ¯ä¸ªé“è·¯å…ƒç´ å±•å¼€æ‰€æœ‰èŠ‚ç‚¹å¼•ç”¨ï¼Œå¹¶ä¿æŒå®ƒä»¬çš„æ­£ç¡®é¡ºåºï¼ˆè®°ä½â€”â€”èŠ‚ç‚¹å¼•ç”¨çš„é¡ºåºå¾ˆé‡è¦ï¼ï¼‰ã€‚
- en: Select required nodes with geometries.
  id: totrans-87
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: é€‰æ‹©å¸¦æœ‰å‡ ä½•å½¢çŠ¶çš„æ‰€éœ€èŠ‚ç‚¹ã€‚
- en: Group nodes per way ID and construct a linestring geometry using `ST_MakeLine`function.
  id: totrans-88
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: æŒ‰é“è·¯IDåˆ†ç»„èŠ‚ç‚¹ï¼Œå¹¶ä½¿ç”¨`ST_MakeLine`å‡½æ•°æ„å»ºçº¿å­—ç¬¦ä¸²å‡ ä½•å½¢çŠ¶ã€‚
- en: Join constructed geometries with tags.
  id: totrans-89
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: ä½¿ç”¨æ ‡ç­¾æ„å»ºçš„å‡ ä½•å½¢çŠ¶è¿æ¥ã€‚
- en: Letâ€™s start with selecting ways with tags.
  id: totrans-90
  prefs: []
  type: TYPE_NORMAL
  zh: æˆ‘ä»¬ä»é€‰æ‹©å¸¦æœ‰æ ‡ç­¾çš„é“è·¯å¼€å§‹ã€‚
- en: '[PRE4]'
  id: totrans-91
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: Now we will unnest refs lists and split them into individual rows. We will also
    utilize DuckDBâ€™s indexing functions to remember the order of elements in the original
    list.
  id: totrans-92
  prefs: []
  type: TYPE_NORMAL
  zh: ç°åœ¨æˆ‘ä»¬å°†å±•å¼€å¼•ç”¨åˆ—è¡¨ï¼Œå¹¶å°†å®ƒä»¬æ‹†åˆ†æˆå•ç‹¬çš„è¡Œã€‚æˆ‘ä»¬è¿˜å°†åˆ©ç”¨DuckDBçš„ç´¢å¼•åŠŸèƒ½æ¥è®°ä½åŸå§‹åˆ—è¡¨ä¸­å…ƒç´ çš„é¡ºåºã€‚
- en: '[PRE5]'
  id: totrans-93
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: As you can see, there are now multiple rows per way element and multiple ref
    values. Ref_idx represents the original order in the *refs* list.
  id: totrans-94
  prefs: []
  type: TYPE_NORMAL
  zh: å¦‚ä½ æ‰€è§ï¼Œç°åœ¨æ¯ä¸ªé“è·¯å…ƒç´ éƒ½æœ‰å¤šè¡Œæ•°æ®ï¼Œä¸”æœ‰å¤šä¸ªå¼•ç”¨å€¼ã€‚Ref_idxè¡¨ç¤º*refs*åˆ—è¡¨ä¸­åŸå§‹é¡ºåºã€‚
- en: 'You can also see the `SEMI JOIN`clause in the query. This is a special join
    available in the DuckDB, that just filters rows without actually joining the second
    table. You can read more about it in the official documentation:'
  id: totrans-95
  prefs: []
  type: TYPE_NORMAL
  zh: ä½ è¿˜å¯ä»¥çœ‹åˆ°æŸ¥è¯¢ä¸­çš„`SEMI JOIN`å­å¥ã€‚è¿™æ˜¯DuckDBä¸­ç‰¹æœ‰çš„è¿æ¥æ–¹å¼ï¼Œå®ƒä»…é€šè¿‡è¿‡æ»¤è¡Œæ¥ä»£æ›¿å®é™…çš„ç¬¬äºŒå¼ è¡¨è¿æ¥ã€‚ä½ å¯ä»¥åœ¨å®˜æ–¹æ–‡æ¡£ä¸­é˜…è¯»æ›´å¤šä¿¡æ¯ï¼š
- en: '[](https://duckdb.org/docs/sql/query_syntax/from?source=post_page-----ffeb15197390--------------------------------#semi-and-anti-joins)
    [## FROM & JOIN Clauses'
  id: totrans-96
  prefs: []
  type: TYPE_NORMAL
  zh: '[](https://duckdb.org/docs/sql/query_syntax/from?source=post_page-----ffeb15197390--------------------------------#semi-and-anti-joins)
    [## FROM & JOIN å­å¥'
- en: The FROM clause specifies the source of the data on which the remainder of the
    query should operate. Logically, theâ€¦
  id: totrans-97
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: FROMå­å¥æŒ‡å®šæ•°æ®æºï¼ŒæŸ¥è¯¢çš„å…¶ä½™éƒ¨åˆ†å°†åœ¨è¯¥æ•°æ®æºä¸Šæ“ä½œã€‚ä»é€»è¾‘ä¸Šçœ‹ï¼Œ...
- en: duckdb.org](https://duckdb.org/docs/sql/query_syntax/from?source=post_page-----ffeb15197390--------------------------------#semi-and-anti-joins)
  id: totrans-98
  prefs: []
  type: TYPE_NORMAL
  zh: '[duckdb.org](https://duckdb.org/docs/sql/query_syntax/from?source=post_page-----ffeb15197390--------------------------------#semi-and-anti-joins)'
- en: 'Now we can select the required nodes based on the refs from the previous step:'
  id: totrans-99
  prefs: []
  type: TYPE_NORMAL
  zh: ç°åœ¨æˆ‘ä»¬å¯ä»¥æ ¹æ®ä¸Šä¸€é˜¶æ®µçš„ refs é€‰æ‹©æ‰€éœ€çš„èŠ‚ç‚¹ï¼š
- en: '[PRE6]'
  id: totrans-100
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: 'Now we can construct the full linestrings:'
  id: totrans-101
  prefs: []
  type: TYPE_NORMAL
  zh: ç°åœ¨æˆ‘ä»¬å¯ä»¥æ„å»ºå®Œæ•´çš„çº¿å­—ç¬¦ä¸²ï¼ˆlinestringï¼‰ï¼š
- en: '[PRE7]'
  id: totrans-102
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: '![](../Images/4ac75ad2615c915d36bbd5d22d94dbf3.png)'
  id: totrans-103
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/4ac75ad2615c915d36bbd5d22d94dbf3.png)'
- en: Ways linestrings plotted on a map. Generated by the author using GeoPandas library.
  id: totrans-104
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨åœ°å›¾ä¸Šç»˜åˆ¶çš„è·¯çº¿çº¿å­—ç¬¦ä¸²ï¼ˆlinestringï¼‰ã€‚ç”±ä½œè€…ä½¿ç”¨ GeoPandas åº“ç”Ÿæˆã€‚
- en: After doing all of those operations, we have ways in the linestring form. Now
    we have to select the ways that are supposed to be polygons. We can do this based
    on tag values. Unfortunately, there is no single source of truth for this operation.
    We can look at the page from the OSM wiki to see one of the definitions created
    by the community.
  id: totrans-105
  prefs: []
  type: TYPE_NORMAL
  zh: å®Œæˆæ‰€æœ‰è¿™äº›æ“ä½œåï¼Œæˆ‘ä»¬å¾—åˆ°çš„æ˜¯çº¿å­—ç¬¦ä¸²å½¢å¼çš„è·¯å¾„ã€‚ç°åœ¨æˆ‘ä»¬éœ€è¦é€‰æ‹©åº”è¯¥æ˜¯å¤šè¾¹å½¢çš„è·¯å¾„ã€‚æˆ‘ä»¬å¯ä»¥æ ¹æ®æ ‡ç­¾å€¼æ¥å®Œæˆè¿™é¡¹å·¥ä½œã€‚ä¸å¹¸çš„æ˜¯ï¼Œå¯¹äºæ­¤æ“ä½œï¼Œå¹¶æ²¡æœ‰å•ä¸€çš„æƒå¨æ¥æºã€‚æˆ‘ä»¬å¯ä»¥æŸ¥çœ‹
    OSM ç»´åŸºé¡µé¢ï¼Œäº†è§£ç¤¾åŒºåˆ›å»ºçš„å…¶ä¸­ä¸€ç§å®šä¹‰ã€‚
- en: '[](https://wiki.openstreetmap.org/wiki/Overpass_turbo/Polygon_Features?source=post_page-----ffeb15197390--------------------------------)
    [## Overpass turbo/Polygon Features'
  id: totrans-106
  prefs: []
  type: TYPE_NORMAL
  zh: '[](https://wiki.openstreetmap.org/wiki/Overpass_turbo/Polygon_Features?source=post_page-----ffeb15197390--------------------------------)
    [## Overpass turbo/Polygon Features'
- en: As OpenStreetMap doesn't have an intrinsic area data type, an heuristic has
    to be applied to determine whether a way isâ€¦
  id: totrans-107
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: ç”±äº OpenStreetMap æ²¡æœ‰å›ºæœ‰çš„åŒºåŸŸæ•°æ®ç±»å‹ï¼Œå› æ­¤å¿…é¡»åº”ç”¨å¯å‘å¼æ–¹æ³•æ¥ç¡®å®šä¸€æ¡è·¯å¾„æ˜¯å¦æ˜¯â€¦â€¦
- en: wiki.openstreetmap.org](https://wiki.openstreetmap.org/wiki/Overpass_turbo/Polygon_Features?source=post_page-----ffeb15197390--------------------------------)
    ![](../Images/78cf5e001831f9276d433c6b61d252da.png)
  id: totrans-108
  prefs: []
  type: TYPE_NORMAL
  zh: '[wiki.openstreetmap.org](https://wiki.openstreetmap.org/wiki/Overpass_turbo/Polygon_Features?source=post_page-----ffeb15197390--------------------------------)
    ![](../Images/78cf5e001831f9276d433c6b61d252da.png)'
- en: A screenshot from the Overpass turbo/Polygon Features wiki page. Taken on 2024-01-17.
  id: totrans-109
  prefs: []
  type: TYPE_NORMAL
  zh: æ¥è‡ª Overpass turbo/Polygon Features ç»´åŸºé¡µé¢çš„æˆªå›¾ã€‚æ‹æ‘„äº 2024-01-17ã€‚
- en: As you can see, this list is quite long, so for brevity we will only check if
    the linestring forms a closed loop and if the area tag value is not â€˜noâ€™.
  id: totrans-110
  prefs: []
  type: TYPE_NORMAL
  zh: å¦‚ä½ æ‰€è§ï¼Œè¿™ä¸ªåˆ—è¡¨ç›¸å½“é•¿ï¼Œå› æ­¤ä¸ºäº†ç®€æ´èµ·è§ï¼Œæˆ‘ä»¬å°†ä»…æ£€æŸ¥çº¿å­—ç¬¦ä¸²æ˜¯å¦å½¢æˆé—­åˆç¯è·¯ï¼Œä»¥åŠåŒºåŸŸæ ‡ç­¾å€¼æ˜¯å¦ä¸æ˜¯ 'no'ã€‚
- en: '[PRE8]'
  id: totrans-111
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: Now we can see the mix of linestring and polygon geometries in the final result.
    Of course, the predicate for the *is_polygon* column could (or even *should*)
    be extended by the logic mentioned above regarding the values of the tags.
  id: totrans-112
  prefs: []
  type: TYPE_NORMAL
  zh: ç°åœ¨æˆ‘ä»¬å¯ä»¥åœ¨æœ€ç»ˆç»“æœä¸­çœ‹åˆ°çº¿å­—ç¬¦ä¸²ï¼ˆlinestringï¼‰å’Œå¤šè¾¹å½¢ï¼ˆpolygonï¼‰å‡ ä½•ä½“çš„æ··åˆã€‚ å½“ç„¶ï¼Œ*is_polygon*åˆ—çš„è°“è¯å¯ä»¥ï¼ˆç”šè‡³*åº”è¯¥*ï¼‰é€šè¿‡ä¸Šè¿°æåˆ°çš„å…³äºæ ‡ç­¾å€¼çš„é€»è¾‘æ¥æ‰©å±•ã€‚
- en: Compared to the image above, many more filled polygons are now visible on the
    map.
  id: totrans-113
  prefs: []
  type: TYPE_NORMAL
  zh: ä¸ä¸Šé¢çš„å›¾ç‰‡ç›¸æ¯”ï¼Œç°åœ¨åœ°å›¾ä¸Šå¯è§æ›´å¤šå¡«å……çš„å¤šè¾¹å½¢ã€‚
- en: '![](../Images/15582954eacc19644cb8eff1f018f0cb.png)'
  id: totrans-114
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/15582954eacc19644cb8eff1f018f0cb.png)'
- en: Ways geometries plotted on a map. Generated by the author using GeoPandas library.
  id: totrans-115
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨åœ°å›¾ä¸Šç»˜åˆ¶çš„è·¯çº¿å‡ ä½•ä½“ã€‚ç”±ä½œè€…ä½¿ç”¨ GeoPandas åº“ç”Ÿæˆã€‚
- en: Constructing polygon and multi-polygon geometries from the relations
  id: totrans-116
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: ä»å…³ç³»ä¸­æ„å»ºå¤šè¾¹å½¢å’Œå¤šå¤šè¾¹å½¢å‡ ä½•ä½“
- en: 'Relations are utilized in OSM to group multiple other elements into a single
    object. Here we will focus solely on the (multi-) polygons. These specific elements
    have a `type` tag with one of two values: `boundary`, and `multipolygon`.'
  id: totrans-117
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨ OSM ä¸­ï¼Œå…³ç³»è¢«ç”¨æ¥å°†å¤šä¸ªå…¶ä»–å…ƒç´ ç»„åˆæˆä¸€ä¸ªå•ä¸€çš„å¯¹è±¡ã€‚è¿™é‡Œæˆ‘ä»¬å°†ä»…å…³æ³¨ï¼ˆå¤šï¼‰å¤šè¾¹å½¢ã€‚è¿™äº›ç‰¹å®šçš„å…ƒç´ æœ‰ä¸€ä¸ª `type` æ ‡ç­¾ï¼Œå…¶å€¼ä¸ºä¸¤è€…ä¹‹ä¸€ï¼š`boundary`
    å’Œ `multipolygon`ã€‚
- en: 'This kind of object is the most complex to reconstruct the geometry for and
    here is the list of steps we have to do:'
  id: totrans-118
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™ç§å¯¹è±¡æ˜¯æœ€å¤æ‚çš„ï¼Œéœ€è¦é‡å»ºå‡ ä½•ä½“ã€‚ä»¥ä¸‹æ˜¯æˆ‘ä»¬éœ€è¦æ‰§è¡Œçš„æ­¥éª¤åˆ—è¡¨ï¼š
- en: Select relations with proper `type` value.
  id: totrans-119
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: é€‰æ‹©å…·æœ‰é€‚å½“ `type` å€¼çš„å…³ç³»ã€‚
- en: Unnest all refs related to the relation and keep only way refs â€” we only need
    related way refs to reconstruct a polygon.
  id: totrans-120
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: å°†ä¸å…³ç³»ç›¸å…³çš„æ‰€æœ‰ refs å±•å¼€ï¼Œå¹¶ä»…ä¿ç•™è·¯å¾„ refs â€”â€” æˆ‘ä»¬åªéœ€è¦ç›¸å…³çš„è·¯å¾„ refs æ¥é‡å»ºå¤šè¾¹å½¢ã€‚
- en: Select required ways with linestring geometries â€” here we can utilize steps
    from constructing ways.
  id: totrans-121
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: é€‰æ‹©å…·æœ‰çº¿å­—ç¬¦ä¸²å‡ ä½•ä½“çš„æ‰€éœ€è·¯å¾„ â€”â€” åœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨æ„å»ºè·¯å¾„çš„æ­¥éª¤ã€‚
- en: Assign an â€˜outerâ€™ role to the way ref if itâ€™s `null` and check if any ref from
    the relation has the role â€˜outerâ€™ â€” if a relation has no â€˜outerâ€™ refs then treat
    all of them as â€˜outerâ€™.
  id: totrans-122
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: å¦‚æœè·¯å¾„çš„ ref ä¸º `null`ï¼Œåˆ™å°†å…¶åˆ†é…ä¸º â€˜outerâ€™ è§’è‰²ï¼Œå¹¶æ£€æŸ¥å…³ç³»ä¸­çš„ä»»ä½• ref æ˜¯å¦å…·æœ‰ â€˜outerâ€™ è§’è‰² â€”â€” å¦‚æœä¸€ä¸ªå…³ç³»æ²¡æœ‰
    â€˜outerâ€™ refsï¼Œåˆ™å°†å®ƒä»¬å…¨éƒ¨è§†ä¸º â€˜outerâ€™ã€‚
- en: Group all linestrings per â€˜outerâ€™ and â€˜innerâ€™ role and merge them into a single
    multilinestring â€” many relations are defined with multiple single linestrings
    that only together create a closed polygon.
  id: totrans-123
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: æŒ‰â€œå¤–éƒ¨â€å’Œâ€œå†…éƒ¨â€è§’è‰²å¯¹æ‰€æœ‰çº¿å­—ç¬¦ä¸²è¿›è¡Œåˆ†ç»„ï¼Œå¹¶å°†å®ƒä»¬åˆå¹¶ä¸ºä¸€ä¸ªå•ä¸€çš„å¤šçº¿å­—ç¬¦ä¸²â€”â€”è®¸å¤šå…³ç³»æ˜¯ç”±å¤šä¸ªå•ä¸€çº¿å­—ç¬¦ä¸²å®šä¹‰çš„ï¼Œåªæœ‰å°†å®ƒä»¬ç»„åˆèµ·æ¥æ‰èƒ½å½¢æˆä¸€ä¸ªé—­åˆçš„å¤šè¾¹å½¢ã€‚
- en: Split multilinestrings into single closed-loop linestrings and save them as
    polygons.
  id: totrans-124
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: å°†å¤šçº¿å­—ç¬¦ä¸²æ‹†åˆ†ä¸ºå•ä¸€é—­ç¯çº¿å­—ç¬¦ä¸²ï¼Œå¹¶å°†å…¶ä¿å­˜ä¸ºå¤šè¾¹å½¢ã€‚
- en: Split geometries into â€˜outerâ€™ and â€˜innerâ€™ polygons. These can be extracted from
    the `ref_role` column of the relation object.
  id: totrans-125
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: å°†å‡ ä½•ä½“æ‹†åˆ†ä¸ºâ€œå¤–éƒ¨â€å’Œâ€œå†…éƒ¨â€å¤šè¾¹å½¢ã€‚è¿™äº›å¯ä»¥ä»å…³ç³»å¯¹è±¡çš„`ref_role`åˆ—ä¸­æå–ã€‚
- en: For each â€˜outerâ€™ polygon, select all â€˜innerâ€™ polygons that are fully within
    it and make holes in this polygon.
  id: totrans-126
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: å¯¹äºæ¯ä¸ªâ€œå¤–éƒ¨â€å¤šè¾¹å½¢ï¼Œé€‰æ‹©æ‰€æœ‰å®Œå…¨åŒ…å«åœ¨å…¶ä¸­çš„â€œå†…éƒ¨â€å¤šè¾¹å½¢ï¼Œå¹¶åœ¨è¯¥å¤šè¾¹å½¢ä¸­åˆ›å»ºå­”ã€‚
- en: Make a union of all â€˜outerâ€™ polygons with holes.
  id: totrans-127
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: å¯¹æ‰€æœ‰å¸¦å­”çš„â€œå¤–éƒ¨â€å¤šè¾¹å½¢è¿›è¡Œè”åˆã€‚
- en: Letâ€™s start with selecting relations with matching tag values.
  id: totrans-128
  prefs: []
  type: TYPE_NORMAL
  zh: è®©æˆ‘ä»¬ä»é€‰æ‹©å…·æœ‰åŒ¹é…æ ‡ç­¾å€¼çš„å…³ç³»å¼€å§‹ã€‚
- en: '[PRE9]'
  id: totrans-129
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: Now we will unnest refs lists and split them into individual rows. Like with
    ways, here we will also utilize DuckDBâ€™s indexing functions to remember the order
    of elements in the original list. Additionally, we will only keep the `way` refs.
  id: totrans-130
  prefs: []
  type: TYPE_NORMAL
  zh: ç°åœ¨æˆ‘ä»¬å°†å±•å¼€å¼•ç”¨åˆ—è¡¨ï¼Œå¹¶å°†å…¶æ‹†åˆ†ä¸ºå•ç‹¬çš„è¡Œã€‚ä¸è·¯å¾„ç›¸ä¼¼ï¼Œæˆ‘ä»¬ä¹Ÿå°†åˆ©ç”¨DuckDBçš„ç´¢å¼•åŠŸèƒ½æ¥è®°ä½åŸå§‹åˆ—è¡¨ä¸­å…ƒç´ çš„é¡ºåºã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬åªä¼šä¿ç•™`way`å¼•ç”¨ã€‚
- en: '[PRE10]'
  id: totrans-131
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: 'In the next step, we will construct linestrings for the ways required by the
    relations. The query below compresses almost full logic of reading ways in one
    go (getting required nodes, constructing points and grouping them into linestrings):'
  id: totrans-132
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨ä¸‹ä¸€æ­¥ä¸­ï¼Œæˆ‘ä»¬å°†ä¸ºå…³ç³»æ‰€éœ€çš„è·¯å¾„æ„å»ºçº¿å­—ç¬¦ä¸²ã€‚ä¸‹é¢çš„æŸ¥è¯¢å‡ ä¹å®Œæ•´åœ°å‹ç¼©äº†è¯»å–è·¯å¾„çš„é€»è¾‘ï¼ˆè·å–æ‰€éœ€çš„èŠ‚ç‚¹ï¼Œæ„å»ºç‚¹å¹¶å°†å…¶åˆ†ç»„ä¸ºçº¿å­—ç¬¦ä¸²ï¼‰ï¼š
- en: '[PRE11]'
  id: totrans-133
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: After creating the required linestrings, now we can join them with relations
    data. We will also make sure that the required `ref_role` is properly parsed â€”
    fill in the empty values or replace them if the relation has incorrectly defined
    `ref_roles` in the OSM database.
  id: totrans-134
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨åˆ›å»ºæ‰€éœ€çš„çº¿å­—ç¬¦ä¸²åï¼Œæˆ‘ä»¬ç°åœ¨å¯ä»¥å°†å®ƒä»¬ä¸å…³ç³»æ•°æ®è¿æ¥èµ·æ¥ã€‚æˆ‘ä»¬è¿˜ä¼šç¡®ä¿æ­£ç¡®è§£ææ‰€éœ€çš„`ref_role` â€” å¡«å……ç©ºå€¼æˆ–æ›¿æ¢å®ƒä»¬ï¼Œå¦‚æœå…³ç³»åœ¨OSMæ•°æ®åº“ä¸­é”™è¯¯åœ°å®šä¹‰äº†`ref_roles`ã€‚
- en: '[PRE12]'
  id: totrans-135
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: 'As you can see, there are multiple ways with linestrings assigned to each relation.
    Letâ€™s look at an example to see how they look on the map:'
  id: totrans-136
  prefs: []
  type: TYPE_NORMAL
  zh: å¦‚æ‚¨æ‰€è§ï¼Œæ¯ä¸ªå…³ç³»éƒ½åˆ†é…äº†å¤šä¸ªè·¯å¾„å’Œçº¿å­—ç¬¦ä¸²ã€‚è®©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç¤ºä¾‹æ¥çœ‹å®ƒä»¬åœ¨åœ°å›¾ä¸Šçš„è¡¨ç°ï¼š
- en: '![](../Images/a34fe385da26c62cce2dd5d832df57a9.png)'
  id: totrans-137
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/a34fe385da26c62cce2dd5d832df57a9.png)'
- en: A single relation ([5986437](https://www.openstreetmap.org/relation/5986437))
    with colour-coded ways that are part of it. Generated by the author using GeoPandas
    library.
  id: totrans-138
  prefs: []
  type: TYPE_NORMAL
  zh: ä¸€ä¸ªå•ä¸€çš„å…³ç³»ï¼ˆ[5986437](https://www.openstreetmap.org/relation/5986437)ï¼‰ï¼Œå…¶ä¸­åŒ…å«æŒ‰é¢œè‰²ç¼–ç çš„è·¯å¾„ã€‚ç”±ä½œè€…ä½¿ç”¨GeoPandasåº“ç”Ÿæˆã€‚
- en: 'To create full polygons, we have to utilize a `ST_LineMerge` function, that
    will combine a list of linestrings (you can compare it to tying pieces of string
    together). You can read more about this operation here:'
  id: totrans-139
  prefs: []
  type: TYPE_NORMAL
  zh: è¦åˆ›å»ºå®Œæ•´çš„å¤šè¾¹å½¢ï¼Œæˆ‘ä»¬å¿…é¡»åˆ©ç”¨`ST_LineMerge`å‡½æ•°ï¼Œå®ƒå°†ç»„åˆä¸€ç³»åˆ—çº¿å­—ç¬¦ä¸²ï¼ˆä½ å¯ä»¥å°†å…¶æ¯”ä½œå°†ä¸€æ®µæ®µç»³å­ç»‘åœ¨ä¸€èµ·ï¼‰ã€‚ä½ å¯ä»¥åœ¨è¿™é‡Œé˜…è¯»æ›´å¤šå…³äºæ­¤æ“ä½œçš„ä¿¡æ¯ï¼š
- en: '[](https://postgis.net/docs/ST_LineMerge.html?source=post_page-----ffeb15197390--------------------------------)
    [## ST_LineMerge'
  id: totrans-140
  prefs: []
  type: TYPE_NORMAL
  zh: '[](https://postgis.net/docs/ST_LineMerge.html?source=post_page-----ffeb15197390--------------------------------)
    [## ST_LineMerge'
- en: ST_LineMerge - Return the lines formed by sewing together a MultiLineString.
  id: totrans-141
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: ST_LineMerge - è¿”å›é€šè¿‡ç¼åˆå¤šä¸ªçº¿å­—ç¬¦ä¸²å½¢æˆçš„çº¿ã€‚
- en: postgis.net](https://postgis.net/docs/ST_LineMerge.html?source=post_page-----ffeb15197390--------------------------------)
  id: totrans-142
  prefs: []
  type: TYPE_NORMAL
  zh: '[postgis.net](https://postgis.net/docs/ST_LineMerge.html?source=post_page-----ffeb15197390--------------------------------)'
- en: 'As an additional validation step, we will check if the produced linestrings
    have at least 4 points and if the first point equals the last point, before converting
    them into polygons:'
  id: totrans-143
  prefs: []
  type: TYPE_NORMAL
  zh: ä½œä¸ºé¢å¤–çš„éªŒè¯æ­¥éª¤ï¼Œæˆ‘ä»¬å°†æ£€æŸ¥ç”Ÿæˆçš„çº¿å­—ç¬¦ä¸²æ˜¯å¦è‡³å°‘åŒ…å«4ä¸ªç‚¹ï¼Œå¹¶ä¸”ç¬¬ä¸€ä¸ªç‚¹æ˜¯å¦ç­‰äºæœ€åä¸€ä¸ªç‚¹ï¼Œç„¶åå†å°†å®ƒä»¬è½¬æ¢ä¸ºå¤šè¾¹å½¢ï¼š
- en: '[PRE13]'
  id: totrans-144
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: 'Letâ€™s see the previous example after this operation. We should expect two separate
    polygons to be present:'
  id: totrans-145
  prefs: []
  type: TYPE_NORMAL
  zh: è®©æˆ‘ä»¬çœ‹çœ‹æ‰§è¡Œæ­¤æ“ä½œåçš„å‰ä¸€ä¸ªç¤ºä¾‹ã€‚æˆ‘ä»¬åº”è¯¥å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªç‹¬ç«‹çš„å¤šè¾¹å½¢ï¼š
- en: '![](../Images/d72c2b5c71b7e6a1349da547f29bb068.png)'
  id: totrans-146
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/d72c2b5c71b7e6a1349da547f29bb068.png)'
- en: A single relation ([5986437](https://www.openstreetmap.org/relation/5986437))
    with merged ways as two separate polygons. Generated by the author using GeoPandas
    library.
  id: totrans-147
  prefs: []
  type: TYPE_NORMAL
  zh: ä¸€ä¸ªå•ä¸€çš„å…³ç³»ï¼ˆ[5986437](https://www.openstreetmap.org/relation/5986437)ï¼‰ï¼Œå…¶ä¸­åˆå¹¶çš„è·¯å¾„ä½œä¸ºä¸¤ä¸ªç‹¬ç«‹çš„å¤šè¾¹å½¢ã€‚ç”±ä½œè€…ä½¿ç”¨GeoPandasåº“ç”Ÿæˆã€‚
- en: 'Iâ€™ve mentioned previously the `outer` and `inner` â€˜ref_typesâ€™ of ways that
    create a relation. Here you can see what it looks like:'
  id: totrans-148
  prefs: []
  type: TYPE_NORMAL
  zh: æˆ‘ä¹‹å‰æåˆ°è¿‡ï¼Œåˆ›å»ºå…³ç³»çš„è·¯å¾„å…·æœ‰`outer`å’Œ`inner`çš„`ref_types`ã€‚è¿™é‡Œä½ å¯ä»¥çœ‹åˆ°å®ƒä»¬çš„æ ·å­ï¼š
- en: '![](../Images/4bf65f217dccd5aedeea10bf2b511cde.png)'
  id: totrans-149
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/4bf65f217dccd5aedeea10bf2b511cde.png)'
- en: A single relation ([8280869](https://www.openstreetmap.org/relation/828086))
    with merged ways grouped into outer and inner polygons. Generated by the author
    using GeoPandas library.
  id: totrans-150
  prefs: []
  type: TYPE_NORMAL
  zh: ä¸€ä¸ªå•ä¸€å…³ç³»ï¼ˆ[8280869](https://www.openstreetmap.org/relation/828086)ï¼‰ä¸åˆå¹¶çš„è·¯å¾„åˆ†ç»„ä¸ºå¤–éƒ¨å’Œå†…éƒ¨å¤šè¾¹å½¢ã€‚ç”±ä½œè€…ä½¿ç”¨
    GeoPandas åº“ç”Ÿæˆã€‚
- en: The roles mean that the `inner` ways are the â€˜holesâ€™ within `outer` polygons
    and we have to reproduce this step to make proper geometries.
  id: totrans-151
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™äº›è§’è‰²æ„å‘³ç€ `inner` è·¯å¾„æ˜¯ `outer` å¤šè¾¹å½¢ä¸­çš„â€œå­”æ´â€ï¼Œæˆ‘ä»¬å¿…é¡»é‡ç°è¿™ä¸€æ­¥éª¤ä»¥ç¡®ä¿å‡ ä½•ä½“çš„æ­£ç¡®æ€§ã€‚
- en: Letâ€™s focus now on splitting the polygons into groups with and without holes,
    using the `ST_Within` predicate, which checks if a geometry is fully within another.
  id: totrans-152
  prefs: []
  type: TYPE_NORMAL
  zh: ç°åœ¨è®©æˆ‘ä»¬ä¸“æ³¨äºå°†å¤šè¾¹å½¢åˆ†ä¸ºæœ‰å­”å’Œæ²¡æœ‰å­”çš„ä¸¤ç»„ï¼Œä½¿ç”¨ `ST_Within` è°“è¯ï¼Œå®ƒæ£€æŸ¥ä¸€ä¸ªå‡ ä½•ä½“æ˜¯å¦å®Œå…¨ä½äºå¦ä¸€ä¸ªå‡ ä½•ä½“å†…ã€‚
- en: '[PRE14]'
  id: totrans-153
  prefs: []
  type: TYPE_PRE
  zh: '[PRE14]'
- en: In this query, there is utilized another special join â€” `ANTI JOIN`. This one
    filters out all the rows on the left-side table that are joined by the right-side
    table.
  id: totrans-154
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨è¿™ä¸ªæŸ¥è¯¢ä¸­ï¼Œä½¿ç”¨äº†å¦ä¸€ç§ç‰¹æ®Šçš„è¿æ¥â€”â€”`ANTI JOIN`ã€‚è¿™ä¸ªè¿æ¥ä¼šè¿‡æ»¤æ‰æ‰€æœ‰å·¦ä¾§è¡¨ä¸­ä¸å³ä¾§è¡¨è¿æ¥çš„è¡Œã€‚
- en: The last step that is needed is to merge all the polygons for a single relation
    using the `ST_Union_Agg` operation. It will combine all polygons into multipolygons
    (if there is more than one) and produce a single geometry.
  id: totrans-155
  prefs: []
  type: TYPE_NORMAL
  zh: æœ€åä¸€æ­¥æ˜¯ä½¿ç”¨ `ST_Union_Agg` æ“ä½œå°†ä¸€ä¸ªå…³ç³»çš„æ‰€æœ‰å¤šè¾¹å½¢åˆå¹¶ã€‚å®ƒå°†æŠŠæ‰€æœ‰å¤šè¾¹å½¢åˆå¹¶ä¸ºå¤šå¤šè¾¹å½¢ï¼ˆå¦‚æœæœ‰å¤šä¸ªï¼‰ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªå•ä¸€çš„å‡ ä½•ä½“ã€‚
- en: '[PRE15]'
  id: totrans-156
  prefs: []
  type: TYPE_PRE
  zh: '[PRE15]'
- en: 'Here is the previous relation example, now with holes:'
  id: totrans-157
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™æ˜¯ä¹‹å‰çš„å…³ç³»ç¤ºä¾‹ï¼Œç°åœ¨å¸¦æœ‰å­”æ´ï¼š
- en: '![](../Images/217a6f093c325a233d93a5d152a284d4.png)'
  id: totrans-158
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/217a6f093c325a233d93a5d152a284d4.png)'
- en: A single relation ([8280869](https://www.openstreetmap.org/relation/828086))
    â€” a polygon with holes. Generated by the author using GeoPandas library.
  id: totrans-159
  prefs: []
  type: TYPE_NORMAL
  zh: ä¸€ä¸ªå•ä¸€å…³ç³»ï¼ˆ[8280869](https://www.openstreetmap.org/relation/828086)ï¼‰â€”â€”ä¸€ä¸ªå¸¦å­”çš„å¤šè¾¹å½¢ã€‚ç”±ä½œè€…ä½¿ç”¨
    GeoPandas åº“ç”Ÿæˆã€‚
- en: '![](../Images/206d0d2c26863920fd791636813f0d85.png)'
  id: totrans-160
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/206d0d2c26863920fd791636813f0d85.png)'
- en: Relations geometries plotted on a map. Generated by the author using GeoPandas
    library.
  id: totrans-161
  prefs: []
  type: TYPE_NORMAL
  zh: ç»˜åˆ¶åœ¨åœ°å›¾ä¸Šçš„å…³ç³»å‡ ä½•ä½“ã€‚ç”±ä½œè€…ä½¿ç”¨ GeoPandas åº“ç”Ÿæˆã€‚
- en: Examples of badly defined relation objects
  id: totrans-162
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: é”™è¯¯å®šä¹‰çš„å…³ç³»å¯¹è±¡ç¤ºä¾‹
- en: As OpenStreetMap data is mainly added by the community, there are examples where
    geometries are not properly defined. The OSM wiki describes rules for map makers
    on how to add geometries to a map.
  id: totrans-163
  prefs: []
  type: TYPE_NORMAL
  zh: ç”±äº OpenStreetMap æ•°æ®ä¸»è¦ç”±ç¤¾åŒºæ·»åŠ ï¼Œå› æ­¤æœ‰äº›å‡ ä½•ä½“æ²¡æœ‰æ­£ç¡®å®šä¹‰ã€‚OSM ç»´åŸºæè¿°äº†åœ°å›¾åˆ¶ä½œäººå‘˜å¦‚ä½•å°†å‡ ä½•ä½“æ·»åŠ åˆ°åœ°å›¾ä¸­çš„è§„åˆ™ã€‚
- en: '[](https://wiki.openstreetmap.org/wiki/Relation:multipolygon/validity?source=post_page-----ffeb15197390--------------------------------)
    [## Relation:multipolygon/validity'
  id: totrans-164
  prefs: []
  type: TYPE_NORMAL
  zh: '[](https://wiki.openstreetmap.org/wiki/Relation:multipolygon/validity?source=post_page-----ffeb15197390--------------------------------)
    [## Relation:multipolygon/validity'
- en: This page is only a proposition, it doesn't represent a consenus of what is
    or isn't valid, but only what could andâ€¦
  id: totrans-165
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: æœ¬é¡µé¢ä»…ä¸ºæè®®ï¼Œæœªä»£è¡¨å…³äºä»€ä¹ˆæœ‰æ•ˆæˆ–æ— æ•ˆçš„å…±è¯†ï¼Œåªæ˜¯æå‡ºäº†å¯èƒ½çš„â€¦
- en: wiki.openstreetmap.org](https://wiki.openstreetmap.org/wiki/Relation:multipolygon/validity?source=post_page-----ffeb15197390--------------------------------)
  id: totrans-166
  prefs: []
  type: TYPE_NORMAL
  zh: wiki.openstreetmap.org](https://wiki.openstreetmap.org/wiki/Relation:multipolygon/validity?source=post_page-----ffeb15197390--------------------------------)
- en: This section will outline some common mistakes with examples.
  id: totrans-167
  prefs: []
  type: TYPE_NORMAL
  zh: æœ¬èŠ‚å°†æ¦‚è¿°ä¸€äº›å¸¸è§çš„é”™è¯¯ï¼Œå¹¶é™„å¸¦ç¤ºä¾‹ã€‚
- en: Two overlapping â€˜outerâ€™ ways in the relation
  id: totrans-168
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: å…³ç³»ä¸­æœ‰ä¸¤ä¸ªé‡å çš„â€œouterâ€è·¯å¾„
- en: 'This building is defined by two shapes: a rectangle and almost a circle. Since
    these two overlap, you can see how the rendering engine created a gap where there
    probably shouldnâ€™t be any.'
  id: totrans-169
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™åº§å»ºç­‘ç”±ä¸¤ä¸ªå½¢çŠ¶å®šä¹‰ï¼šä¸€ä¸ªçŸ©å½¢å’Œä¸€ä¸ªå‡ ä¹æ˜¯åœ†å½¢çš„å½¢çŠ¶ã€‚ç”±äºè¿™ä¸¤è€…é‡å ï¼Œå¯ä»¥çœ‹åˆ°æ¸²æŸ“å¼•æ“åœ¨æœ¬ä¸åº”è¯¥æœ‰ç©ºéš™çš„åœ°æ–¹äº§ç”Ÿäº†ä¸€ä¸ªé—´éš™ã€‚
- en: '![](../Images/671b8dd3fbcd20c09c06f10a11affd08.png)'
  id: totrans-170
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/671b8dd3fbcd20c09c06f10a11affd08.png)'
- en: Screenshot from the OpenStreetMap by the author.
  id: totrans-171
  prefs: []
  type: TYPE_NORMAL
  zh: ä½œè€…æä¾›çš„ OpenStreetMap æˆªå›¾ã€‚
- en: No â€˜outerâ€™ way in the relation
  id: totrans-172
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: å…³ç³»ä¸­æ²¡æœ‰â€œouterâ€è·¯å¾„
- en: Here you can see a paintball field with `way` members defined as â€˜Main Buildingâ€™
    and 4 â€˜Arenasâ€™. These should be all defined as `outer` ways.
  id: totrans-173
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™é‡Œä½ å¯ä»¥çœ‹åˆ°ä¸€ä¸ªå¸¦æœ‰ `way` æˆå‘˜çš„å½©å¼¹åœºï¼Œæˆå‘˜è¢«å®šä¹‰ä¸ºâ€œä¸»å»ºç­‘â€å’Œ 4 ä¸ªâ€œç«æŠ€åœºâ€ã€‚è¿™äº›éƒ½åº”è¯¥å®šä¹‰ä¸º `outer` è·¯å¾„ã€‚
- en: '![](../Images/927a31510d513e7214b9c5a477933ade.png)'
  id: totrans-174
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/927a31510d513e7214b9c5a477933ade.png)'
- en: Screenshot from the OpenStreetMap by the author.
  id: totrans-175
  prefs: []
  type: TYPE_NORMAL
  zh: ä½œè€…æä¾›çš„ OpenStreetMap æˆªå›¾ã€‚
- en: Two overlapping or touching â€˜innerâ€™ ways
  id: totrans-176
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: ä¸¤ä¸ªé‡å æˆ–æ¥è§¦çš„â€œinnerâ€è·¯å¾„
- en: '![](../Images/2dd6cb3b3ac6ea1ed1b73d63d44823ed.png)'
  id: totrans-177
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/2dd6cb3b3ac6ea1ed1b73d63d44823ed.png)'
- en: Screenshot from the OpenStreetMap by the author.
  id: totrans-178
  prefs: []
  type: TYPE_NORMAL
  zh: ä½œè€…æä¾›çš„ OpenStreetMap æˆªå›¾ã€‚
- en: 'If you are interested in reading more about how these can be fixed, look into
    this repository:'
  id: totrans-179
  prefs: []
  type: TYPE_NORMAL
  zh: å¦‚æœä½ æœ‰å…´è¶£äº†è§£æ›´å¤šå…³äºå¦‚ä½•ä¿®å¤è¿™äº›é—®é¢˜çš„ä¿¡æ¯ï¼Œå¯ä»¥æŸ¥é˜…è¿™ä¸ªä»£ç åº“ï¼š
- en: '[](https://github.com/osmlab/fixing-polygons-in-osm/blob/master/doc/background.md?source=post_page-----ffeb15197390--------------------------------)
    [## fixing-polygons-in-osm/doc/background.md at master Â· osmlab/fixing-polygons-in-osm'
  id: totrans-180
  prefs: []
  type: TYPE_NORMAL
  zh: '[](https://github.com/osmlab/fixing-polygons-in-osm/blob/master/doc/background.md?source=post_page-----ffeb15197390--------------------------------)
    [## fixing-polygons-in-osm/doc/background.md at master Â· osmlab/fixing-polygons-in-osm'
- en: Fixing (multi)polygons in OpenStreetMap. Contribute to osmlab/fixing-polygons-in-osm
    development by creating an accountâ€¦
  id: totrans-181
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: ä¿®å¤ OpenStreetMap ä¸­çš„ï¼ˆå¤šé‡ï¼‰å¤šè¾¹å½¢ã€‚é€šè¿‡åˆ›å»ºè´¦æˆ·ï¼Œè´¡çŒ®äº osmlab/fixing-polygons-in-osm çš„å¼€å‘â€¦
- en: github.com](https://github.com/osmlab/fixing-polygons-in-osm/blob/master/doc/background.md?source=post_page-----ffeb15197390--------------------------------)
  id: totrans-182
  prefs: []
  type: TYPE_NORMAL
  zh: github.com](https://github.com/osmlab/fixing-polygons-in-osm/blob/master/doc/background.md?source=post_page-----ffeb15197390--------------------------------)
- en: QuackOSM â€” a hassle-free tool for reading OSM data
  id: totrans-183
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: QuackOSM â€” ä¸€ä¸ªä¾¿æ·çš„å·¥å…·ï¼Œç”¨äºè¯»å– OSM æ•°æ®
- en: To end this article I want to highlight a library that can automatically download
    the OSM data, filter it by the geometry or using OSM tags and save it as a GeoParquet
    file that can be easily integrated into more scalable solutions. The library is
    written in Python and is open-source.
  id: totrans-184
  prefs: []
  type: TYPE_NORMAL
  zh: ä¸ºäº†ç»“æŸè¿™ç¯‡æ–‡ç« ï¼Œæˆ‘æƒ³å¼ºè°ƒä¸€ä¸ªå¯ä»¥è‡ªåŠ¨ä¸‹è½½ OSM æ•°æ®çš„åº“ï¼Œå®ƒå¯ä»¥é€šè¿‡å‡ ä½•æˆ–ä½¿ç”¨ OSM æ ‡ç­¾è¿‡æ»¤æ•°æ®ï¼Œå¹¶å°†å…¶ä¿å­˜ä¸º GeoParquet æ–‡ä»¶ï¼Œä¾¿äºé›†æˆåˆ°æ›´å¯æ‰©å±•çš„è§£å†³æ–¹æ¡ˆä¸­ã€‚è¿™ä¸ªåº“æ˜¯ç”¨
    Python ç¼–å†™çš„ï¼Œå¹¶ä¸”æ˜¯å¼€æºçš„ã€‚
- en: 'You can install it with a single command: `pip install quackosm[cli]`.'
  id: totrans-185
  prefs: []
  type: TYPE_NORMAL
  zh: ä½ å¯ä»¥é€šè¿‡ä¸€æ¡å‘½ä»¤å®‰è£…å®ƒï¼š`pip install quackosm[cli]`ã€‚
- en: This tutorial contains a simplified version of the queries used in the QuackOSM
    ğŸ¦†, but these wonâ€™t scale very well for the bigger regions. The library can easily
    parse whole countries such as France on a consumer-grade PC if you need to. You
    can of course utilize the DuckDB engine later on the prepared GeoParquet file
    using `SPATIAL` extension.
  id: totrans-186
  prefs: []
  type: TYPE_NORMAL
  zh: æœ¬æ•™ç¨‹åŒ…å«äº† QuackOSM ğŸ¦† ä½¿ç”¨çš„æŸ¥è¯¢çš„ç®€åŒ–ç‰ˆæœ¬ï¼Œä½†è¿™äº›æŸ¥è¯¢åœ¨æ›´å¤§åŒºåŸŸä¸­å¹¶ä¸é€‚ç”¨ã€‚è¯¥åº“å¯ä»¥è½»æ¾è§£æåƒæ³•å›½è¿™æ ·çš„æ•´ä¸ªå›½å®¶æ•°æ®ï¼Œå³ä¾¿åœ¨æ¶ˆè´¹è€…çº§çš„ PC
    ä¸Šä¹Ÿèƒ½è¿è¡Œã€‚å¦‚æœéœ€è¦ï¼Œä½ å½“ç„¶å¯ä»¥ä½¿ç”¨ `SPATIAL` æ‰©å±•åœ¨å¤„ç†åçš„ GeoParquet æ–‡ä»¶ä¸Šåˆ©ç”¨ DuckDB å¼•æ“ã€‚
- en: 'All of the steps defined here can be replaced with a single line of code:'
  id: totrans-187
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™é‡Œå®šä¹‰çš„æ‰€æœ‰æ­¥éª¤éƒ½å¯ä»¥é€šè¿‡ä¸€è¡Œä»£ç æ¥æ›¿ä»£ï¼š
- en: '[PRE16]'
  id: totrans-188
  prefs: []
  type: TYPE_PRE
  zh: '[PRE16]'
- en: '[](https://github.com/kraina-ai/quackosm?source=post_page-----ffeb15197390--------------------------------)
    [## GitHub - kraina-ai/quackosm: QuackOSM: an open-source Python and CLI tool
    for reading OpenStreetMapâ€¦'
  id: totrans-189
  prefs: []
  type: TYPE_NORMAL
  zh: '[](https://github.com/kraina-ai/quackosm?source=post_page-----ffeb15197390--------------------------------)
    [## GitHub - kraina-ai/quackosm: QuackOSM: an open-source Python and CLI tool
    for reading OpenStreetMapâ€¦'
- en: 'QuackOSM: an open-source Python and CLI tool for reading OpenStreetMap PBF
    files using DuckDB - kraina-ai/quackosm'
  id: totrans-190
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: QuackOSMï¼šä¸€ä¸ªä½¿ç”¨ DuckDB è¯»å– OpenStreetMap PBF æ–‡ä»¶çš„å¼€æº Python å’Œ CLI å·¥å…· - kraina-ai/quackosm
- en: github.com](https://github.com/kraina-ai/quackosm?source=post_page-----ffeb15197390--------------------------------)
  id: totrans-191
  prefs: []
  type: TYPE_NORMAL
  zh: github.com](https://github.com/kraina-ai/quackosm?source=post_page-----ffeb15197390--------------------------------)
- en: Disclaimer
  id: totrans-192
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: å…è´£å£°æ˜
- en: Iâ€™m the author of the `QuackOSM` library.
  id: totrans-193
  prefs: []
  type: TYPE_NORMAL
  zh: æˆ‘æ˜¯`QuackOSM`åº“çš„ä½œè€…ã€‚
- en: 'You can reach me here:'
  id: totrans-194
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: ä½ å¯ä»¥é€šè¿‡è¿™é‡Œè”ç³»æˆ‘ï¼š
- en: '[https://www.linkedin.com/in/raczyckikamil/](https://www.linkedin.com/in/raczyckikamil/)'
  id: totrans-195
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: '[https://www.linkedin.com/in/raczyckikamil/](https://www.linkedin.com/in/raczyckikamil/)'
- en: '[https://github.com/raczeq](https://github.com/raczeq)'
  id: totrans-196
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: '[https://github.com/raczeq](https://github.com/raczeq)'
