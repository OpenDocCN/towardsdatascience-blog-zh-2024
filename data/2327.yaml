- en: Building an Interactive UI for Llamaindex Workflows
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: ä¸ºLlamaindexå·¥ä½œæµæ„å»ºäº¤äº’å¼UI
- en: åŸæ–‡ï¼š[https://towardsdatascience.com/building-an-interactive-ui-for-llamaindex-workflows-842dd7abedde?source=collection_archive---------3-----------------------#2024-09-24](https://towardsdatascience.com/building-an-interactive-ui-for-llamaindex-workflows-842dd7abedde?source=collection_archive---------3-----------------------#2024-09-24)
  id: totrans-1
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: åŸæ–‡ï¼š[https://towardsdatascience.com/building-an-interactive-ui-for-llamaindex-workflows-842dd7abedde?source=collection_archive---------3-----------------------#2024-09-24](https://towardsdatascience.com/building-an-interactive-ui-for-llamaindex-workflows-842dd7abedde?source=collection_archive---------3-----------------------#2024-09-24)
- en: A guide to integrating human-in-the-loop interactions using Llamaindex, FastAPI,
    and Streamlit
  id: totrans-2
  prefs:
  - PREF_H2
  type: TYPE_NORMAL
  zh: ä½¿ç”¨Llamaindexã€FastAPIå’ŒStreamlité›†æˆäººæœºäº’åŠ¨çš„æŒ‡å—
- en: '[](https://medium.com/@lzchen.cs?source=post_page---byline--842dd7abedde--------------------------------)[![Lingzhen
    Chen](../Images/9014cbac032238d8a5c9f4708ba6ffcb.png)](https://medium.com/@lzchen.cs?source=post_page---byline--842dd7abedde--------------------------------)[](https://towardsdatascience.com/?source=post_page---byline--842dd7abedde--------------------------------)[![Towards
    Data Science](../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png)](https://towardsdatascience.com/?source=post_page---byline--842dd7abedde--------------------------------)
    [Lingzhen Chen](https://medium.com/@lzchen.cs?source=post_page---byline--842dd7abedde--------------------------------)'
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: '[](https://medium.com/@lzchen.cs?source=post_page---byline--842dd7abedde--------------------------------)[![Lingzhen
    Chen](../Images/9014cbac032238d8a5c9f4708ba6ffcb.png)](https://medium.com/@lzchen.cs?source=post_page---byline--842dd7abedde--------------------------------)[](https://towardsdatascience.com/?source=post_page---byline--842dd7abedde--------------------------------)[![Towards
    Data Science](../Images/a6ff2676ffcc0c7aad8aaf1d79379785.png)](https://towardsdatascience.com/?source=post_page---byline--842dd7abedde--------------------------------)
    [Lingzhen Chen](https://medium.com/@lzchen.cs?source=post_page---byline--842dd7abedde--------------------------------)'
- en: Â·Published in [Towards Data Science](https://towardsdatascience.com/?source=post_page---byline--842dd7abedde--------------------------------)
    Â·10 min readÂ·Sep 24, 2024
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: Â·å‘è¡¨äº[Towards Data Science](https://towardsdatascience.com/?source=post_page---byline--842dd7abedde--------------------------------)
    Â·é˜…è¯»æ—¶é—´ï¼š10åˆ†é’ŸÂ·2024å¹´9æœˆ24æ—¥
- en: --
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: --
- en: 'In my last article, I demonstrated how I use LlamaIndex workflows to streamline
    my research and presentation process. I built a workflow that takes a research
    topic, finds related articles on arxiv.org, creates summaries for the papers,
    and generates a PowerPoint slide deck to present the papers. You can read the
    full walk-through here:'
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨LlamaIndexå·¥ä½œæµæ¥ç®€åŒ–æˆ‘çš„ç ”ç©¶å’Œå±•ç¤ºè¿‡ç¨‹ã€‚æˆ‘æ„å»ºäº†ä¸€ä¸ªå·¥ä½œæµï¼Œè¯¥å·¥ä½œæµè·å–ç ”ç©¶ä¸»é¢˜ï¼Œåœ¨arxiv.orgä¸ŠæŸ¥æ‰¾ç›¸å…³æ–‡ç« ï¼Œåˆ›å»ºè®ºæ–‡æ‘˜è¦ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªPowerPointå¹»ç¯ç‰‡å±•ç¤ºè¿™äº›è®ºæ–‡ã€‚ä½ å¯ä»¥åœ¨è¿™é‡Œé˜…è¯»å®Œæ•´çš„æ“ä½œæ­¥éª¤ï¼š
- en: '[](/how-i-streamline-my-research-and-presentation-with-llamaindex-workflows-3d75a9a10564?source=post_page-----842dd7abedde--------------------------------)
    [## How I Streamline My Research and Presentation with LlamaIndex Workflows'
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: '[](/how-i-streamline-my-research-and-presentation-with-llamaindex-workflows-3d75a9a10564?source=post_page-----842dd7abedde--------------------------------)
    [## æˆ‘å¦‚ä½•é€šè¿‡LlamaIndexå·¥ä½œæµç®€åŒ–æˆ‘çš„ç ”ç©¶å’Œå±•ç¤º'
- en: An example of orchestrating AI workflow with robustness, flexibility and controllability
  id: totrans-8
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: ä¸€ä¸ªåè°ƒAIå·¥ä½œæµçš„ç¤ºä¾‹ï¼Œå…·æœ‰é²æ£’æ€§ã€çµæ´»æ€§å’Œå¯æ§æ€§
- en: towardsdatascience.com](/how-i-streamline-my-research-and-presentation-with-llamaindex-workflows-3d75a9a10564?source=post_page-----842dd7abedde--------------------------------)
  id: totrans-9
  prefs: []
  type: TYPE_NORMAL
  zh: towardsdatascience.com](/how-i-streamline-my-research-and-presentation-with-llamaindex-workflows-3d75a9a10564?source=post_page-----842dd7abedde--------------------------------)
- en: To continue building on the workflow and make it more user-friendly, I implemented
    a UI with Streamlit to enhance the user experience. The UI displays progress updates
    of the workflow execution, integrates user input, enables real-time user feedback,
    and renders the final generated slide deck.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: ä¸ºäº†ç»§ç»­æ„å»ºå·¥ä½œæµå¹¶ä½¿å…¶æ›´å…·ç”¨æˆ·å‹å¥½æ€§ï¼Œæˆ‘ä½¿ç”¨Streamlitå®ç°äº†ä¸€ä¸ªUIï¼Œä»¥å¢å¼ºç”¨æˆ·ä½“éªŒã€‚è¯¥UIæ˜¾ç¤ºå·¥ä½œæµæ‰§è¡Œçš„è¿›åº¦æ›´æ–°ï¼Œé›†æˆç”¨æˆ·è¾“å…¥ï¼Œæ”¯æŒå®æ—¶ç”¨æˆ·åé¦ˆï¼Œå¹¶å‘ˆç°æœ€ç»ˆç”Ÿæˆçš„å¹»ç¯ç‰‡ã€‚
- en: '![](../Images/943a490d724acbf5ce0f3ce0d5b7e379.png)'
  id: totrans-11
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/943a490d724acbf5ce0f3ce0d5b7e379.png)'
- en: The Streamlit UI (Screen recording by author)
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: Streamlit UIï¼ˆä½œè€…å½•å±ï¼‰
- en: 'You can check out the full code on my [Github](https://github.com/lz-chen/research-agent).
    In this article, I will walk through some key points on the UI implementation
    and the integration between the frontend and the backend:'
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: ä½ å¯ä»¥åœ¨æˆ‘çš„[Github](https://github.com/lz-chen/research-agent)ä¸ŠæŸ¥çœ‹å®Œæ•´ä»£ç ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†ä»‹ç»UIå®ç°çš„ä¸€äº›å…³é”®ç‚¹ï¼Œä»¥åŠå‰ç«¯å’Œåç«¯ä¹‹é—´çš„é›†æˆï¼š
- en: '**Backend enhancements:**'
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: '**åç«¯å¢å¼ºï¼š**'
- en: Update the workflow to support sending streaming event
  id: totrans-15
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: æ›´æ–°å·¥ä½œæµä»¥æ”¯æŒå‘é€æµå¼äº‹ä»¶
- en: Update the workflow to pause execution and wait for user inputs
  id: totrans-16
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: æ›´æ–°å·¥ä½œæµä»¥æš‚åœæ‰§è¡Œå¹¶ç­‰å¾…ç”¨æˆ·è¾“å…¥
- en: Host several endpoints using FastAPI for running workflow, accepting user inputs,
    and downloading files, enabling async processes and streaming messages
  id: totrans-17
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: ä½¿ç”¨FastAPIæ‰˜ç®¡å¤šä¸ªç«¯ç‚¹ä»¥è¿è¡Œå·¥ä½œæµï¼Œæ¥å—ç”¨æˆ·è¾“å…¥å’Œä¸‹è½½æ–‡ä»¶ï¼Œæ”¯æŒå¼‚æ­¥å¤„ç†å’Œæµå¼æ¶ˆæ¯
- en: '**Frontend UI features:**'
  id: totrans-18
  prefs: []
  type: TYPE_NORMAL
  zh: '**å‰ç«¯UIåŠŸèƒ½ï¼š**'
- en: Send requests to the backend and display event data streamed from the backend
    in an expander
  id: totrans-19
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: å‘åå°å‘é€è¯·æ±‚å¹¶åœ¨æ‰©å±•æ¡†ä¸­æ˜¾ç¤ºä»åå°æµå¼ä¼ è¾“çš„äº‹ä»¶æ•°æ®
- en: Display related information in a container and collect user input, if user input
    is required
  id: totrans-20
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: åœ¨å®¹å™¨ä¸­æ˜¾ç¤ºç›¸å…³ä¿¡æ¯å¹¶æ”¶é›†ç”¨æˆ·è¾“å…¥ï¼ˆå¦‚æœéœ€è¦ç”¨æˆ·è¾“å…¥ï¼‰
- en: Render the final generated slide deck
  id: totrans-21
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: æ¸²æŸ“æœ€ç»ˆç”Ÿæˆçš„å¹»ç¯ç‰‡
- en: Provide a button for the user to download the final file
  id: totrans-22
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: æä¾›ä¸€ä¸ªæŒ‰é’®ä¾›ç”¨æˆ·ä¸‹è½½æœ€ç»ˆæ–‡ä»¶
- en: '**Putting it all together:**'
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: '**å°†æ‰€æœ‰å†…å®¹æ•´åˆåœ¨ä¸€èµ·ï¼š**'
- en: Separate frontend and backend dependencies and build by using distinct `pyproject.toml`
    and `Dockerfile`
  id: totrans-24
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: å°†å‰ç«¯å’Œåç«¯ä¾èµ–é¡¹åˆ†å¼€ï¼Œå¹¶é€šè¿‡ä½¿ç”¨ä¸åŒçš„`pyproject.toml`å’Œ`Dockerfile`è¿›è¡Œæ„å»º
- en: Use `docker-compose` to build launch all services
  id: totrans-25
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: ä½¿ç”¨`docker-compose`æ„å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡
- en: When starting the workflow from the terminal, it is straightforward to see which
    step it is executing and the logging we put in those steps.
  id: totrans-26
  prefs: []
  type: TYPE_NORMAL
  zh: ä»ç»ˆç«¯å¯åŠ¨å·¥ä½œæµæ—¶ï¼Œå¯ä»¥å¾ˆç›´è§‚åœ°çœ‹åˆ°å½“å‰æ­£åœ¨æ‰§è¡Œçš„æ­¥éª¤ä»¥åŠæˆ‘ä»¬åœ¨è¿™äº›æ­¥éª¤ä¸­æ·»åŠ çš„æ—¥å¿—ä¿¡æ¯ã€‚
- en: '![](../Images/20ff5b34a307eada9bf3fc5771f5eab0.png)'
  id: totrans-27
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/20ff5b34a307eada9bf3fc5771f5eab0.png)'
- en: Terminal log for the workflow execution (Screenshot by author)
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: å·¥ä½œæµæ‰§è¡Œçš„ç»ˆç«¯æ—¥å¿—ï¼ˆæˆªå›¾æ¥è‡ªä½œè€…ï¼‰
- en: We can also enable the human-in-the-loop interaction by simply using `user_feedback
    = input()`in the workflow. This will pause the workflow and wait for the user
    input (See the human-in-the-loop example in this official Llamaindex [notebook](https://docs.llamaindex.ai/en/stable/examples/workflow/human_in_the_loop_story_crafting/)).
    However, to be able to achieve the same functionality in a user-friendly interface,
    we need additional modifications to the original workflow.
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ç®€å•åœ°åœ¨å·¥ä½œæµä¸­ä½¿ç”¨`user_feedback = input()`æ¥å¯ç”¨äººæœºäº’åŠ¨ã€‚è¿™å°†æš‚åœå·¥ä½œæµå¹¶ç­‰å¾…ç”¨æˆ·è¾“å…¥ï¼ˆè¯·å‚è§æ­¤å®˜æ–¹Llamaindex[ç¬”è®°æœ¬](https://docs.llamaindex.ai/en/stable/examples/workflow/human_in_the_loop_story_crafting/)ä¸­çš„äººæœºäº’åŠ¨ç¤ºä¾‹ï¼‰ã€‚ç„¶è€Œï¼Œä¸ºäº†åœ¨ç”¨æˆ·å‹å¥½çš„ç•Œé¢ä¸­å®ç°ç›¸åŒçš„åŠŸèƒ½ï¼Œæˆ‘ä»¬éœ€è¦å¯¹åŸå§‹å·¥ä½œæµåšå‡ºé¢å¤–çš„ä¿®æ”¹ã€‚
- en: Sending streaming events from the workflow
  id: totrans-30
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: ä»å·¥ä½œæµå‘é€æµå¼äº‹ä»¶
- en: 'Workflow can take a long time to execute, so for a better user experience,
    Llamaindex provided a way to send streaming events to indicate the progress of
    the workflow, as shown in the notebook [here](https://docs.llamaindex.ai/en/stable/understanding/workflows/stream/).
    In my workflow, I define a `WorkflowStreamingEvent` class to include useful information
    about the event message, such as the type of the event, and from which step it
    is sent:'
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: å·¥ä½œæµæ‰§è¡Œå¯èƒ½éœ€è¦å¾ˆé•¿æ—¶é—´ï¼Œå› æ­¤ä¸ºäº†æä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒï¼ŒLlamaindexæä¾›äº†ä¸€ç§æ–¹æ³•ï¼Œé€šè¿‡å‘é€æµå¼äº‹ä»¶æ¥æŒ‡ç¤ºå·¥ä½œæµçš„è¿›åº¦ï¼Œå¦‚ç¬”è®°æœ¬[è¿™é‡Œ](https://docs.llamaindex.ai/en/stable/understanding/workflows/stream/)æ‰€ç¤ºã€‚åœ¨æˆ‘çš„å·¥ä½œæµä¸­ï¼Œæˆ‘å®šä¹‰äº†ä¸€ä¸ª`WorkflowStreamingEvent`ç±»ï¼ŒåŒ…å«æœ‰å…³äº‹ä»¶æ¶ˆæ¯çš„æœ‰ç”¨ä¿¡æ¯ï¼Œå¦‚äº‹ä»¶ç±»å‹ï¼Œä»¥åŠå®ƒæ˜¯ä»å“ªä¸ªæ­¥éª¤å‘é€çš„ï¼š
- en: '[PRE0]'
  id: totrans-32
  prefs: []
  type: TYPE_PRE
  zh: '[PRE0]'
- en: 'To enable sending streaming events, the workflow step needs to have access
    to the shared context, which is done by adding `@step(pass_context=True)` decorator
    to the step definition. Then in the step definition, we can send event messages
    about the progress through the context. For example, in the `tavily_query()` step:'
  id: totrans-33
  prefs: []
  type: TYPE_NORMAL
  zh: ä¸ºäº†å¯ç”¨å‘é€æµå¼äº‹ä»¶ï¼Œå·¥ä½œæµæ­¥éª¤éœ€è¦è®¿é—®å…±äº«ä¸Šä¸‹æ–‡ï¼Œè¿™é€šè¿‡åœ¨æ­¥éª¤å®šä¹‰ä¸­æ·»åŠ `@step(pass_context=True)`è£…é¥°å™¨æ¥å®ç°ã€‚ç„¶åï¼Œåœ¨æ­¥éª¤å®šä¹‰ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸Šä¸‹æ–‡å‘é€å…³äºè¿›åº¦çš„äº‹ä»¶æ¶ˆæ¯ã€‚ä¾‹å¦‚ï¼Œåœ¨`tavily_query()`æ­¥éª¤ä¸­ï¼š
- en: '[PRE1]'
  id: totrans-34
  prefs: []
  type: TYPE_PRE
  zh: '[PRE1]'
- en: 'In this example, we set the `event_type` to be `â€œserver_messageâ€` . It means
    that it is an update message and no user action is required. We have another type
    of event `"request_user_input"` that indicates a user input is needed. For example,
    in the `gather_feedback_outline()` step in the workflow, after generating the
    slide text outlines from the original paper summary, a message is sent to prompt
    the user to provide approval and feedback on the outline text:'
  id: totrans-35
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†`event_type`è®¾ç½®ä¸º`â€œserver_messageâ€`ï¼Œæ„å‘³ç€è¿™æ˜¯ä¸€ä¸ªæ›´æ–°æ¶ˆæ¯ï¼Œä¸éœ€è¦ç”¨æˆ·æ“ä½œã€‚æˆ‘ä»¬è¿˜æœ‰å¦ä¸€ç§äº‹ä»¶ç±»å‹`"request_user_input"`ï¼Œè¡¨ç¤ºéœ€è¦ç”¨æˆ·è¾“å…¥ã€‚ä¾‹å¦‚ï¼Œåœ¨å·¥ä½œæµä¸­çš„`gather_feedback_outline()`æ­¥éª¤ä¸­ï¼Œåœ¨ä»åŸå§‹è®ºæ–‡æ‘˜è¦ç”Ÿæˆå¹»ç¯ç‰‡æ–‡æœ¬å¤§çº²åï¼Œä¼šå‘é€ä¸€æ¡æ¶ˆæ¯ï¼Œæç¤ºç”¨æˆ·æä¾›å¯¹å¤§çº²æ–‡æœ¬çš„æ‰¹å‡†å’Œåé¦ˆï¼š
- en: '[PRE2]'
  id: totrans-36
  prefs: []
  type: TYPE_PRE
  zh: '[PRE2]'
- en: These events are handled differently in the backend API and the frontend logic,
    which I will describe in detail in the later sections of this article.
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™äº›äº‹ä»¶åœ¨åå°APIå’Œå‰ç«¯é€»è¾‘ä¸­æœ‰ä¸åŒçš„å¤„ç†æ–¹å¼ï¼Œæˆ‘å°†åœ¨æœ¬æ–‡åç»­éƒ¨åˆ†è¯¦ç»†æè¿°ã€‚
- en: Pausing the workflow to wait for user input
  id: totrans-38
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: æš‚åœå·¥ä½œæµä»¥ç­‰å¾…ç”¨æˆ·è¾“å…¥
- en: '![](../Images/e95ddc55fad1afe523da3672c85e3168.png)'
  id: totrans-39
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/e95ddc55fad1afe523da3672c85e3168.png)'
- en: Workflow steps that requires user feedback (Image by author)
  id: totrans-40
  prefs: []
  type: TYPE_NORMAL
  zh: éœ€è¦ç”¨æˆ·åé¦ˆçš„å·¥ä½œæµæ­¥éª¤ï¼ˆå›¾åƒæ¥è‡ªä½œè€…ï¼‰
- en: When sending a `"request_user_input"` event to the user, we only want to proceed
    to the next step **after** we have received the user input. As shown in the workflow
    diagram above, it either proceeds to the `outlines_with_layout()`step if the user
    approves the outline, or to the `summary2outline()` step again if the user does
    not approve.
  id: totrans-41
  prefs: []
  type: TYPE_NORMAL
  zh: å½“å‘ç”¨æˆ·å‘é€ `"request_user_input"` äº‹ä»¶æ—¶ï¼Œæˆ‘ä»¬åªå¸Œæœ›åœ¨**æ”¶åˆ°**ç”¨æˆ·è¾“å…¥åæ‰ç»§ç»­æ‰§è¡Œä¸‹ä¸€æ­¥ã€‚å¦‚ä¸Šé¢çš„å·¥ä½œæµå›¾æ‰€ç¤ºï¼Œå¦‚æœç”¨æˆ·æ‰¹å‡†äº†å¤§çº²ï¼Œå®ƒä¼šè¿›å…¥
    `outlines_with_layout()` æ­¥éª¤ï¼›å¦‚æœç”¨æˆ·æ²¡æœ‰æ‰¹å‡†ï¼Œåˆ™ä¼šå†æ¬¡è¿›å…¥ `summary2outline()` æ­¥éª¤ã€‚
- en: 'This is achieved using the `Future()` object from Pythonâ€™s `asyncio` library.
    In the `SlideGenerationWorkflow` class, we set an attribute `self.user_input_future
    = asyncio.Future()` that can be waited on in the `gather_feedback_outline()` step.
    The subsequent execution of the workflow is conditioned on the content of the
    user feedback:'
  id: totrans-42
  prefs: []
  type: TYPE_NORMAL
  zh: è¿™æ˜¯é€šè¿‡ä½¿ç”¨ Python çš„ `asyncio` åº“ä¸­çš„ `Future()` å¯¹è±¡æ¥å®ç°çš„ã€‚åœ¨ `SlideGenerationWorkflow`
    ç±»ä¸­ï¼Œæˆ‘ä»¬è®¾ç½®äº†ä¸€ä¸ªå±æ€§ `self.user_input_future = asyncio.Future()`ï¼Œè¿™ä¸ªå±æ€§å¯ä»¥åœ¨ `gather_feedback_outline()`
    æ­¥éª¤ä¸­ç­‰å¾…ã€‚å·¥ä½œæµçš„åç»­æ‰§è¡Œå–å†³äºç”¨æˆ·åé¦ˆçš„å†…å®¹ï¼š
- en: '[PRE3]'
  id: totrans-43
  prefs: []
  type: TYPE_PRE
  zh: '[PRE3]'
- en: The FastAPI backend
  id: totrans-44
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: FastAPI åç«¯
- en: We set up the backend using fastAPI, expose a POST endpoint to handle requests,
    and initiate the workflow run. The asynchronous function `run_workflow_endpoint()`
    takes `ResearchTopic` as input. In the function, an asynchronous generator `event_generator()`
    is defined, which creates a task to run the workflow and streams the events to
    the client as the workflow progresses. When the workflow finishes, it will also
    stream the final file results to the client.
  id: totrans-45
  prefs: []
  type: TYPE_NORMAL
  zh: æˆ‘ä»¬ä½¿ç”¨ FastAPI è®¾ç½®åç«¯ï¼Œæš´éœ²ä¸€ä¸ª POST ç«¯ç‚¹æ¥å¤„ç†è¯·æ±‚ï¼Œå¹¶å¯åŠ¨å·¥ä½œæµè¿è¡Œã€‚å¼‚æ­¥å‡½æ•° `run_workflow_endpoint()`
    æ¥å— `ResearchTopic` ä½œä¸ºè¾“å…¥ã€‚åœ¨è¯¥å‡½æ•°ä¸­ï¼Œå®šä¹‰äº†ä¸€ä¸ªå¼‚æ­¥ç”Ÿæˆå™¨ `event_generator()`ï¼Œå®ƒåˆ›å»ºä¸€ä¸ªä»»åŠ¡æ¥è¿è¡Œå·¥ä½œæµï¼Œå¹¶åœ¨å·¥ä½œæµè¿›å±•æ—¶å°†äº‹ä»¶æµä¼ è¾“ç»™å®¢æˆ·ç«¯ã€‚å½“å·¥ä½œæµå®Œæˆæ—¶ï¼Œå®ƒè¿˜ä¼šå°†æœ€ç»ˆçš„æ–‡ä»¶ç»“æœæµä¼ è¾“ç»™å®¢æˆ·ç«¯ã€‚
- en: '[PRE4]'
  id: totrans-46
  prefs: []
  type: TYPE_PRE
  zh: '[PRE4]'
- en: In addition to this endpoint, there are endpoints for receiving user input from
    the client and handling file download requests. Since each workflow is assigned
    a unique workflow ID, we can map the user input received from the client to the
    correct workflow. By call the `set_result()` on the awaiting `Future`, the pending
    workflow can resume execution.
  id: totrans-47
  prefs: []
  type: TYPE_NORMAL
  zh: é™¤äº†è¿™ä¸ªç«¯ç‚¹å¤–ï¼Œè¿˜æœ‰æ¥æ”¶æ¥è‡ªå®¢æˆ·ç«¯çš„ç”¨æˆ·è¾“å…¥å’Œå¤„ç†æ–‡ä»¶ä¸‹è½½è¯·æ±‚çš„ç«¯ç‚¹ã€‚ç”±äºæ¯ä¸ªå·¥ä½œæµéƒ½åˆ†é…äº†ä¸€ä¸ªå”¯ä¸€çš„å·¥ä½œæµ IDï¼Œæˆ‘ä»¬å¯ä»¥å°†ä»å®¢æˆ·ç«¯æ¥æ”¶åˆ°çš„ç”¨æˆ·è¾“å…¥æ˜ å°„åˆ°æ­£ç¡®çš„å·¥ä½œæµã€‚é€šè¿‡è°ƒç”¨ç­‰å¾…ä¸­çš„
    `Future` å¯¹è±¡çš„ `set_result()`ï¼ŒæŒ‚èµ·çš„å·¥ä½œæµå¯ä»¥æ¢å¤æ‰§è¡Œã€‚
- en: '[PRE5]'
  id: totrans-48
  prefs: []
  type: TYPE_PRE
  zh: '[PRE5]'
- en: The download endpoint also identifies where the final file is located based
    on the workflow ID.
  id: totrans-49
  prefs: []
  type: TYPE_NORMAL
  zh: ä¸‹è½½ç«¯ç‚¹è¿˜ä¼šæ ¹æ®å·¥ä½œæµ ID ç¡®å®šæœ€ç»ˆæ–‡ä»¶çš„ä½ç½®ã€‚
- en: '[PRE6]'
  id: totrans-50
  prefs: []
  type: TYPE_PRE
  zh: '[PRE6]'
- en: The Streamlit frontend
  id: totrans-51
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: Streamlit å‰ç«¯
- en: 'In the frontend page, after the user submits the research topic through `st.text_input()`,
    a long-running process is started in a background thread in a new event loop for
    receiving the streamed events from the backend, without interfering with the rest
    of the page:'
  id: totrans-52
  prefs: []
  type: TYPE_NORMAL
  zh: åœ¨å‰ç«¯é¡µé¢ä¸­ï¼Œåœ¨ç”¨æˆ·é€šè¿‡ `st.text_input()` æäº¤ç ”ç©¶ä¸»é¢˜åï¼Œä¸€ä¸ªé•¿æ—¶é—´è¿è¡Œçš„è¿›ç¨‹å°†åœ¨åå°çº¿ç¨‹ä¸­å¯åŠ¨ï¼Œå¹¶åœ¨ä¸€ä¸ªæ–°çš„äº‹ä»¶å¾ªç¯ä¸­æ¥æ”¶æ¥è‡ªåç«¯çš„æµå¼äº‹ä»¶ï¼Œè€Œä¸ä¼šå¹²æ‰°é¡µé¢çš„å…¶ä»–éƒ¨åˆ†ï¼š
- en: '[PRE7]'
  id: totrans-53
  prefs: []
  type: TYPE_PRE
  zh: '[PRE7]'
- en: The event data streamed from the backend is fetched by `httpx.AsyncClient` and
    put into a message queue for further processing. Different information is extracted
    depending on the event types. For event type `â€œrequest_user_inputâ€`, the thread
    is also paused until the user input is provided.
  id: totrans-54
  prefs: []
  type: TYPE_NORMAL
  zh: ä»åç«¯æµå¼ä¼ è¾“çš„äº‹ä»¶æ•°æ®ç”± `httpx.AsyncClient` è·å–ï¼Œå¹¶æ”¾å…¥æ¶ˆæ¯é˜Ÿåˆ—ä»¥ä¾›è¿›ä¸€æ­¥å¤„ç†ã€‚æ ¹æ®äº‹ä»¶ç±»å‹æå–ä¸åŒçš„ä¿¡æ¯ã€‚å¯¹äºäº‹ä»¶ç±»å‹ `"request_user_input"`ï¼Œçº¿ç¨‹ä¹Ÿä¼šæš‚åœï¼Œç›´åˆ°æä¾›ç”¨æˆ·è¾“å…¥ã€‚
- en: '[PRE8]'
  id: totrans-55
  prefs: []
  type: TYPE_PRE
  zh: '[PRE8]'
- en: We store the messages in the `st.session_state` and use a `st.expander()` to
    display and update these streamed data.
  id: totrans-56
  prefs: []
  type: TYPE_NORMAL
  zh: æˆ‘ä»¬å°†æ¶ˆæ¯å­˜å‚¨åœ¨ `st.session_state` ä¸­ï¼Œå¹¶ä½¿ç”¨ `st.expander()` æ¥æ˜¾ç¤ºå’Œæ›´æ–°è¿™äº›æµå¼æ•°æ®ã€‚
- en: '[PRE9]'
  id: totrans-57
  prefs: []
  type: TYPE_PRE
  zh: '[PRE9]'
- en: 'To ensure the UI remains responsive and displays the event messages when they
    are being processed in a background thread, we use a customed [autorefresh](https://github.com/kmcgrady/streamlit-autorefresh)
    component to refresh the page at a set interval:'
  id: totrans-58
  prefs: []
  type: TYPE_NORMAL
  zh: ä¸ºäº†ç¡®ä¿ UI ä¿æŒå“åº”ï¼Œå¹¶åœ¨åå°çº¿ç¨‹å¤„ç†äº‹ä»¶æ¶ˆæ¯æ—¶æ˜¾ç¤ºè¿™äº›æ¶ˆæ¯ï¼Œæˆ‘ä»¬ä½¿ç”¨è‡ªå®šä¹‰çš„ [autorefresh](https://github.com/kmcgrady/streamlit-autorefresh)
    ç»„ä»¶ï¼Œåœ¨è®¾å®šçš„æ—¶é—´é—´éš”å†…åˆ·æ–°é¡µé¢ï¼š
- en: '[PRE10]'
  id: totrans-59
  prefs: []
  type: TYPE_PRE
  zh: '[PRE10]'
- en: 'When the streamed event is of type `â€œrequest_user_inputâ€`, we will display
    related information in a separate container and gather user feedback. As there
    can be multiple events that require user input from one workflow run, we put them
    in a message queue and make sure to assign a unique key to the `st.feedback()`,
    `st.text_area()` and `st.button()` that are linked to each event to ensure the
    widgets donâ€™t interfere with each other:'
  id: totrans-60
  prefs: []
  type: TYPE_NORMAL
  zh: å½“æµå¼äº‹ä»¶çš„ç±»å‹ä¸º `"request_user_input"` æ—¶ï¼Œæˆ‘ä»¬å°†åœ¨ä¸€ä¸ªå•ç‹¬çš„å®¹å™¨ä¸­æ˜¾ç¤ºç›¸å…³ä¿¡æ¯å¹¶æ”¶é›†ç”¨æˆ·åé¦ˆã€‚ç”±äºä¸€ä¸ªå·¥ä½œæµè¿è¡Œè¿‡ç¨‹ä¸­å¯èƒ½ä¼šæœ‰å¤šä¸ªéœ€è¦ç”¨æˆ·è¾“å…¥çš„äº‹ä»¶ï¼Œæˆ‘ä»¬å°†å®ƒä»¬æ”¾å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¹¶ç¡®ä¿ä¸ºä¸æ¯ä¸ªäº‹ä»¶å…³è”çš„
    `st.feedback()`ã€`st.text_area()` å’Œ `st.button()` åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„é”®ï¼Œä»¥ç¡®ä¿è¿™äº›å°éƒ¨ä»¶äº’ä¸å¹²æ‰°ï¼š
- en: '[PRE11]'
  id: totrans-61
  prefs: []
  type: TYPE_PRE
  zh: '[PRE11]'
- en: 'In the end, when the workflow run finally finishes, the frontend client will
    get a response that contains the path to the final generated files (same slide
    deck in pdf format for rendering in the UI and pptx format for downloading as
    the final result). We display the pdf file and create a button for downloading
    the pptx file:'
  id: totrans-62
  prefs: []
  type: TYPE_NORMAL
  zh: æœ€åï¼Œå½“å·¥ä½œæµè¿è¡Œç»“æŸæ—¶ï¼Œå‰ç«¯å®¢æˆ·ç«¯å°†æ”¶åˆ°ä¸€ä¸ªå“åº”ï¼Œå…¶ä¸­åŒ…å«æœ€ç»ˆç”Ÿæˆæ–‡ä»¶çš„è·¯å¾„ï¼ˆç›¸åŒçš„å¹»ç¯ç‰‡æ–‡ä»¶ï¼Œpdfæ ¼å¼ç”¨äºUIæ¸²æŸ“ï¼Œpptxæ ¼å¼ç”¨äºä¸‹è½½ä½œä¸ºæœ€ç»ˆç»“æœï¼‰ã€‚æˆ‘ä»¬å±•ç¤ºpdfæ–‡ä»¶ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªæŒ‰é’®ä¾›ç”¨æˆ·ä¸‹è½½pptxæ–‡ä»¶ï¼š
- en: '[PRE12]'
  id: totrans-63
  prefs: []
  type: TYPE_PRE
  zh: '[PRE12]'
- en: Putting everything together with `docker-compose`
  id: totrans-64
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: ä½¿ç”¨`docker-compose`å°†ä¸€åˆ‡ç»„åˆèµ·æ¥
- en: We will create a multi-service Docker application with `docker-compose` to run
    the frontend and backend apps.
  id: totrans-65
  prefs: []
  type: TYPE_NORMAL
  zh: æˆ‘ä»¬å°†ä½¿ç”¨`docker-compose`åˆ›å»ºä¸€ä¸ªå¤šæœåŠ¡çš„Dockeråº”ç”¨ç¨‹åºï¼Œæ¥è¿è¡Œå‰ç«¯å’Œåç«¯åº”ç”¨ç¨‹åºã€‚
- en: '[PRE13]'
  id: totrans-66
  prefs: []
  type: TYPE_PRE
  zh: '[PRE13]'
- en: Thatâ€™s it! Just run `docker-compose up`, and we now have an app that can run
    a research workflow based on the userâ€™s input query, prompt the user for feedback
    during the execution, and display the final result to the user.
  id: totrans-67
  prefs: []
  type: TYPE_NORMAL
  zh: å°±è¿™æ ·ï¼åªéœ€è¿è¡Œ`docker-compose up`ï¼Œæˆ‘ä»¬ç°åœ¨æœ‰ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œå¯ä»¥æ ¹æ®ç”¨æˆ·è¾“å…¥çš„æŸ¥è¯¢è¿è¡Œç ”ç©¶å·¥ä½œæµï¼Œåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æç¤ºç”¨æˆ·æä¾›åé¦ˆï¼Œå¹¶å‘ç”¨æˆ·æ˜¾ç¤ºæœ€ç»ˆç»“æœã€‚
- en: Thank you for reading! Check out my [GitHub](https://github.com/lz-chen/research-agent)
    for the complete implementation. I look forward to hearing your thoughts, input,
    and feedbacks. I work as a Data Science Consultant at [Inmeta](https://inmeta.no/),
    part of [Crayon Group](https://www.crayon.com/no/). Feel free to connect with
    me on [LinkedIn](https://www.linkedin.com/in/lingzhen-chen-76720680/).ğŸ˜Š
  id: totrans-68
  prefs: []
  type: TYPE_NORMAL
  zh: æ„Ÿè°¢é˜…è¯»ï¼æŸ¥çœ‹æˆ‘çš„[GitHub](https://github.com/lz-chen/research-agent)è·å–å®Œæ•´å®ç°ã€‚æˆ‘æœŸå¾…å¬åˆ°æ‚¨çš„æƒ³æ³•ã€å»ºè®®å’Œåé¦ˆã€‚æˆ‘ç›®å‰åœ¨[Inmeta](https://inmeta.no/)æ‹…ä»»æ•°æ®ç§‘å­¦é¡¾é—®ï¼ŒInmetaæ˜¯[Crayon
    Group](https://www.crayon.com/no/)çš„ä¸€éƒ¨åˆ†ã€‚æ¬¢è¿åœ¨[LinkedIn](https://www.linkedin.com/in/lingzhen-chen-76720680/)ä¸æˆ‘è”ç³»ã€‚ğŸ˜Š
